/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Session",["mendix/lang","mendix/logger","dojo/_base/array","dojo/_base/json","dojo/_base/lang","dojo/_base/window","dojo/io-query","dojo/_base/config","dojo"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){function _a(_b){_b=_5.mixin({tokenStore:{get:function(_c){if(_c){_c();}},set:function(_d,_e){if(_e){_e();}},remove:function(_f){if(_f){_f();}}}},_b);var _10=this,_11="mendix.sys.Session",_12=null,_13=[],_14=null,_15=0,_16=false,_17={},_18=null;var _19=function(){window.mx.server.request({request:{action:"keepalive",params:{preventCache:+new Date()}},options:{failOk:true}});};var _1a=function(){_14=window.mx.data.jsonToMxObject(_12.user);_13=_3.map(_12.roles,function(_1b){return window.mx.data.jsonToMxObject(_1b);});};this.toString=function(){return _11;};this.startup=function(){if(_15){setInterval(_19,_15);}_1a();};this.getConfig=function(_1c){if(!_1c){return _12;}else{return _5.getObject(_1c,false,_12);}};this.inDevMode=function(){return _16;};this.toggleDevMode=function(){_16=!_16;};this.isGuest=function(){if(!_14||!_14.has("IsAnonymous")){return true;}else{return _14.get2("IsAnonymous");}};this.getUserId=function(){return _14&&_14.getGuid();};this.getUserClass=function(){return _14&&_14.getEntity();};this.getUserName=function(){return _14&&_14.get2("Name");};this.getUserAttribute=function(_1d){if(_14&&_14.has(_1d)){return _14.get2(_1d);}return null;};this.getUserRoles=function(_1e){if(_1e==null){return _13;}else{return _1.map(_13,function(o){return o.get2(_1e);});}};this.getCSRFToken=function(){return this.getConfig("csrftoken");};this.getLicenseInfo=function(){return _17;};this.login=function(_1f){_9.xhrPost({url:window.mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_4.toJson({action:"login",params:{username:_1f.username,password:_1f.password,shouldgeneratetoken:_b.shouldGenerateToken||false}}),load:function(_20){if(_20.authtoken){_b.tokenStore.set(_20.authtoken,_1f.success);}else{_1f.success();}},error:function(e){_1f.error(e.response.status);}});};this.destroySession=function(_21){_b.tokenStore.get(function(_22){var _23={log:window.mx.server.flushLog()};if(_22){_23.authtoken=_22;}window.mx.server.request({request:{action:"logout",params:_23},options:{callback:_21}});});};this.logout=function(_24){this.destroySession(function(){_b.tokenStore.remove(_24);});};this.authorized=function(_25){var _26=_6.doc.location.search,_27=_7.queryToObject(_26.substr((_26[0]==="?"?1:0)));var _28={profile:_27.profile||"",timezoneoffset:new Date().getTimezoneOffset()};if(typeof navigator!=="undefined"&&navigator.standalone){_28.longLiveTheCookie=true;}_b.tokenStore.get(function(_29){if(_29){_28.authtoken=_29;}_9.xhrPost({url:window.mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_4.toJson({action:"get_session_data",params:_5.mixin({},_28,_25&&_25.params)}),load:_2a(true),timeout:_8.timeout||0,error:function(e,_2b){if(_2b.xhr.status==401){_12=_4.fromJson(_2b.xhr.responseText);_b.tokenStore.remove(_2c);}else{if(window.localStorage.session){var _2d=_2a(false);_2d(JSON.parse(window.localStorage.session));}else{_2c();}}function _2c(){if(_25.no){_25.no({http_code:_2b.xhr.status});}};}});});function _2a(_2e){return function onLoad(_2f){_12=_2f;if(_2e){window.localStorage.session=JSON.stringify(_12);}var _30=_10.getConfig("uiconfig.direction")=="rtl"?_8.rtlRedirect:_8.ltrRedirect;if(_30){window.mx.redirect(_30);return;}if(_18&&_18!=_12.cachebust){window.mx.reload();return;}window.mx.server.setCacheBust(_12.cachebust);_18=_12.cachebust;_15=_12.keepalive;if(_25.yes){try{_25.yes(_2e);}catch(e){throw e;}}};};};this.hasSomeRole=function(_31){if(_31===null){return true;}else{if(!_31){return false;}else{if(!(_31 instanceof Array)){_31=_31.split(",");}}}var _32=this.getUserRoles("Name");for(var i=0;i<_31.length;i++){var _33=_31[i];for(var j=0;j<_32.length;j++){var _34=_32[j];if(_33==_34){return true;}}}return false;};};return _a;});