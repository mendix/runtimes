/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Session",["mendix/lang","mendix/logger","dojo/_base/array","dojo/_base/json","dojo/_base/lang","dojo/_base/window","dojo/io-query","dojo/_base/config","dojo"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){function _a(_b){_b=_5.mixin({tokenStore:{get:function(_c){if(_c){_c();}},set:function(_d,_e){if(_e){_e();}},remove:function(_f){if(_f){_f();}}}},_b);var _10=this,_11="mendix.sys.Session",_12=null,_13=[],_14=null,_15=0,_16=false,_17={},_18=null;var _19=function(){window.mx.server.request({request:{action:"keepalive",params:{preventCache:+new Date()}},options:{failOk:true,standalone:true}});};var _1a=function(){_14=window.mx.data.jsonToMxObject(_12.user);_13=_3.map(_12.roles,function(_1b){return window.mx.data.jsonToMxObject(_1b);});};this.toString=function(){return _11;};this.startup=function(){if(_15){setInterval(_19,_15);}_1a();};this.getConfig=function(_1c){if(!_1c){return _12;}else{return _5.getObject(_1c,false,_12);}};this.inDevMode=function(){return _16;};this.toggleDevMode=function(){_16=!_16;};this.isGuest=function(){if(!_14||!_14.has("IsAnonymous")){return true;}else{return _14.get2("IsAnonymous");}};this.getUserId=function(){return _14&&_14.getGuid();};this.getUserClass=function(){return _14&&_14.getEntity();};this.getUserName=function(){return _14&&_14.get2("Name");};this.getUserAttribute=function(_1d){if(_14&&_14.has(_1d)){return _14.get2(_1d);}return null;};this.getUserRoles=function(_1e){if(_1e==null){return _13;}else{return _1.map(_13,function(o){return o.get2(_1e);});}};this.getCSRFToken=function(){return this.getConfig("csrftoken");};this.getLicenseInfo=function(){return _17;};this.login=function(_1f){_9.xhrPost({url:window.mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_4.toJson({action:"login",params:{username:_1f.username,password:_1f.password}}),load:function(_20){if(_20.authtoken){_b.tokenStore.set(_20.authtoken,_1f.success);}else{_1f.success();}},error:function(e){_1f.error(e.response.status);}});};this.destroySession=function(_21){window.mx.server.request({request:{action:"logout",params:{log:window.mx.server.flushLog()}},options:{sync:true,callback:_21}});};this.logout=function(_22){this.destroySession(function(){_b.tokenStore.remove(_22);});};this.authorized=function(_23){var _24=_6.doc.location.search,_25=_7.queryToObject(_24.substr((_24[0]==="?"?1:0)));var _26={profile:_25.profile||"",timezoneoffset:new Date().getTimezoneOffset()};if(typeof navigator!=="undefined"&&navigator.standalone){_26.longLiveTheCookie=true;}_b.tokenStore.get(function(_27){if(_27){_26.authtoken=_27;}_9.xhrPost({url:window.mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_4.toJson({action:"get_session_data",params:_5.mixin({},_26,_23&&_23.params)}),load:_28(true),timeout:_8.timeout||0,error:function(e,_29){if(_29.xhr.status==401){_12=_4.fromJson(_29.xhr.responseText);_b.tokenStore.remove(_2a);}else{if(window.localStorage.session){var _2b=_28(false);_2b(JSON.parse(window.localStorage.session));}else{_2a();}}function _2a(){if(_23.no){_23.no({http_code:_29.xhr.status});}};}});});function _28(_2c){return function onLoad(_2d){_12=_2d;if(_2c){window.localStorage.session=JSON.stringify(_12);}var _2e=_10.getConfig("uiconfig.direction")=="rtl"?_8.rtlRedirect:_8.ltrRedirect;if(_2e){window.mx.redirect(_2e);return;}if(_18&&_18!=_12.cachebust){window.mx.reload();return;}window.mx.server.setCacheBust(_12.cachebust);_18=_12.cachebust;_15=_12.keepalive;if(_23.yes){try{_23.yes(_2c);}catch(e){throw e;}}};};};this.hasSomeRole=function(_2f){if(_2f===null){return true;}else{if(!_2f){return false;}else{if(!(_2f instanceof Array)){_2f=_2f.split(",");}}}var _30=this.getUserRoles("Name");for(var i=0;i<_2f.length;i++){var _31=_2f[i];for(var j=0;j<_30.length;j++){var _32=_30[j];if(_31==_32){return true;}}}return false;};};return _a;});