
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Session",["mendix/lang","mendix/logger","dojo/_base/array","dojo/_base/json","dojo/_base/lang","dojo/_base/window","dojo/io-query","dojo/_base/config","dojo/_base/kernel","dojo"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){function _b(){var _c=this,_d="mendix.sys.Session",_e=false,_f=null,_10=[],_11=null,_12=0,_13=null,_14=false,_15={},_16=null;var _17=function(){window.mx.server.request({request:{action:"keepalive",params:{preventCache:+new Date()}},options:{failOk:true,standalone:true}});};var _18=function(){clearInterval(_13);if(_12){_13=setInterval(_17,_12);}};var _19=function(_1a){_11=window.mx.data.jsonToMxObject(_f.user);_10=_3.map(_f.roles,function(_1b){return window.mx.data.jsonToMxObject(_1b);});_1a();};this.toString=function(){return _d;};this.startup=function(_1c){if(!window.mx.offline){_18();_19(function(){_e=true;_1c();});}else{_1c();}};this.shutdown=function(){clearInterval(_13);_e=false;_10=[];_11=null;};this.isLoaded=function(){return _e;};this.getConfig=function(_1d){if(!_1d){return _f;}else{return _5.getObject(_1d,false,_f);}};this.inDevMode=function(){return _14;};this.toggleDevMode=function(){_14=!_14;};this.isGuest=function(){if(!_11||!_11.has("IsAnonymous")){return true;}else{return _11.get("IsAnonymous");}};this.getUserId=function(){return _11&&_11.getGuid();};this.getUserClass=function(){return _11&&_11.getEntity();};this.getUserName=function(){return _11&&_11.get("Name");};this.getUserAttribute=function(_1e){if(_11&&_11.has(_1e)){return _11.get(_1e);}return null;};this.getUserRoles=function(_1f){return _1f!=null?_1.map(_10,function(o){return o.get(_1f);}):_10;};this.getCSRFToken=function(){return this.getConfig("csrftoken");};this.getLicenseInfo=function(){return _15;};this.logout=function(){window.mx.server.request({request:{action:"logout",params:{log:window.mx.server.flushLog()}},options:{sync:true,callback:function(){window.mx.logout({no_alert:true});}}});};this.authorized=function(_20){var _21=_6.doc.location.search,_22=_7.queryToObject(_21.substr((_21[0]==="?"?1:0)));var _23={profile:_22.profile||"",timezoneoffset:new Date().getTimezoneOffset()};if(typeof navigator!="undefined"&&navigator.standalone){_23.longLiveTheCookie=true;}_a.xhrPost({url:window.mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_4.toJson({action:"get_session_data",params:_23}),load:function(_24,_25){_f=_24;var _26=_c.getConfig("uiconfig.direction")=="rtl"?_8.rtlRedirect:_8.ltrRedirect;if(_26){_c.onRedirect(_26);return;}if(_16&&_16!=_f.cachebust){_c.onRedeploy();return;}var v=_9.version;_8.cacheBust=[v.major,v.minor,v.patch,v.flag].join("");window.mx.server.setCacheBust(_24.cachebust);_12=_f.keepalive;if(_20.yes){try{_20.yes();}catch(e){throw e;}}},error:function(e,_27){if(_27.xhr.status==401){_f=_4.fromJson(_27.xhr.responseText);}if(_20.no){_20.no({http_code:_27.xhr.status});}}});};this.hasSomeRole=function(_28){if(_28===null){return true;}else{if(!_28){return false;}else{if(!(_28 instanceof Array)){_28=_28.split(",");}}}var _29=this.getUserRoles("Name");for(var i=0;i<_28.length;i++){var _2a=_28[i];for(var j=0;j<_29.length;j++){var _2b=_29[j];if(_2a==_2b){return true;}}}return false;};this.onRedeploy=function(){};this.onRedirect=function(_2c){};};return _b;});