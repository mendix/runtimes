
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Session",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mendix.sys.Session");mendix.sys.Session=function(_4){_4=_4||{};var _5=this,_6="mendix.sys.Session",_7=false,_8=null,_9=[],_a=null,_b=0,_c=null,_d=false,_e={},_f=null,_10=null,_11={obj:null,guid:null,roles:null,lang:null,sessionid:null};var _12=function(){mx.server.request({request:{action:"keepalive",params:{preventCache:+new Date()}},options:{failOk:true,standalone:true}});};var _13=function(){clearInterval(_c);if(_b){_c=setInterval(_12,_b);}};var _14=function(_15){_a=mx.data.jsonToMxObject(_8.user);_9=_1.map(_8.roles,function(_16){return mx.data.jsonToMxObject(_16);});_15();};this.toString=function(){return _6;};this.startup=function(_17){if(!mx.offline){_13();_14(function(){_7=true;_17();});}else{_17();}};this.shutdown=function(){clearInterval(_c);_7=false;_9=[];_a=null;};this.isLoaded=function(){return _7;};this.getConfig=function(_18){if(!_18){return _8;}else{return _1.getObject(_18,false,_8);}};this.inDevMode=function(){return _d;};this.toggleDevMode=function(){_d=!_d;};this.isGuest=function(){if(!_a||!_a.has("IsAnonymous")){return true;}else{return _a.get("IsAnonymous");}};this.getUserId=function(){return _a&&_a.getGuid();};this.getUserClass=function(){return _a&&_a.getEntity();};this.getUserName=function(){return _a&&_a.get("Name");};this.getUserAttribute=function(_19){if(_a&&_a.has(_19)){return _a.get(_19);}return null;};this.getUserRoles=function(_1a){return _1a!=null?mendix.lang.map(_9,function(o){return o.get(_1a);}):_9;};this.getCSRFToken=function(){return this.getConfig("csrftoken");};this.getLicenseInfo=function(){return _e;};this.logout=function(){mx.server.request({request:{action:"logout",params:{log:mx.server.flushLog()}},options:{sync:true,callback:function(){mx.logout({no_alert:true});}}});};this.authorized=function(_1b){var _1c=_1.doc.location.search,_1d=_1.queryToObject(_1c.substr((_1c[0]==="?"?1:0)));var _1e={profile:_1d.profile||"",timezoneoffset:new Date().getTimezoneOffset()};if(typeof navigator!="undefined"&&navigator.standalone){_1e.longLiveTheCookie=true;}_1.xhrPost({url:mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_1.toJson({action:"get_session_data",params:_1e}),load:function(_1f,_20){_8=_1f;var _21=_5.getConfig("uiconfig.direction")=="rtl"?_1.config.rtlRedirect:_1.config.ltrRedirect;if(_21){_5.onRedirect(_21);return;}if(_f&&_f!=_8.cachebust){_5.onRedeploy();return;}var v=_1.version;_1.config.cacheBust=[v.major,v.minor,v.patch].join("");mx.server.setCacheBust(_1f.cachebust);_b=_8.keepalive;if(_1b.yes){try{_1b.yes();}catch(e){throw e;}}},error:function(e,_22){if(_22.xhr.status==401){_8=_1.fromJson(_22.xhr.responseText);}if(_1b.no){_1b.no({http_code:_22.xhr.status});}}});};this.hasSomeRole=function(_23){if(_23===null){return true;}else{if(!_23){return false;}else{if(!(_23 instanceof Array)){_23=_23.split(",");}}}var _24=this.getUserRoles("Name");for(var i=0;i<_23.length;i++){var _25=_23[i];for(var j=0;j<_24.length;j++){var _26=_24[j];if(_25==_26){return true;}}}return false;};this.onRedeploy=function(){};this.onRedirect=function(_27){};};});