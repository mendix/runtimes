
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Session",["mendix/lang","mendix/logger","dojo/_base/array","dojo/_base/json","dojo/_base/lang","dojo/_base/window","dojo/io-query","dojo/_base/config","dojo/_base/kernel","dojo"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){function _b(){var _c=this,_d="mendix.sys.Session",_e=null,_f=[],_10=null,_11=0,_12=false,_13={},_14=null;var _15=function(){window.mx.server.request({request:{action:"keepalive",params:{preventCache:+new Date()}},options:{failOk:true,standalone:true}});};var _16=function(){_10=window.mx.data.jsonToMxObject(_e.user);_f=_3.map(_e.roles,function(_17){return window.mx.data.jsonToMxObject(_17);});};this.toString=function(){return _d;};this.startup=function(){if(_11){setInterval(_15,_11);}_16();};this.getConfig=function(_18){if(!_18){return _e;}else{return _5.getObject(_18,false,_e);}};this.inDevMode=function(){return _12;};this.toggleDevMode=function(){_12=!_12;};this.isGuest=function(){if(!_10||!_10.has("IsAnonymous")){return true;}else{return _10.get("IsAnonymous");}};this.getUserId=function(){return _10&&_10.getGuid();};this.getUserClass=function(){return _10&&_10.getEntity();};this.getUserName=function(){return _10&&_10.get("Name");};this.getUserAttribute=function(_19){if(_10&&_10.has(_19)){return _10.get(_19);}return null;};this.getUserRoles=function(_1a){if(_1a==null){return _f;}else{return _1.map(_f,function(o){return o.get(_1a);});}};this.getCSRFToken=function(){return this.getConfig("csrftoken");};this.getLicenseInfo=function(){return _13;};this.login=function(_1b){_a.xhrPost({url:window.mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_4.toJson({action:"login",params:{username:_1b.username,password:_1b.password}}),load:function(){_1b.success();},error:function(e){_1b.error(e.response.status);}});};this.logout=function(_1c){window.mx.server.request({request:{action:"logout",params:{log:window.mx.server.flushLog()}},options:{sync:true,callback:_1c}});};this.authorized=function(_1d){var _1e=_6.doc.location.search,_1f=_7.queryToObject(_1e.substr((_1e[0]==="?"?1:0)));var _20={profile:_1f.profile||"",timezoneoffset:new Date().getTimezoneOffset()};if(typeof navigator!="undefined"&&navigator.standalone){_20.longLiveTheCookie=true;}_a.xhrPost({url:window.mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_4.toJson({action:"get_session_data",params:_20}),load:function(_21,_22){_e=_21;var _23=_c.getConfig("uiconfig.direction")=="rtl"?_8.rtlRedirect:_8.ltrRedirect;if(_23){window.mx.redirect(_23);return;}if(_14&&_14!=_e.cachebust){window.mx.reload();return;}var v=_9.version;_8.cacheBust=[v.major,v.minor,v.patch,v.flag].join("");window.mx.server.setCacheBust(_21.cachebust);_11=_e.keepalive;if(_1d.yes){try{_1d.yes();}catch(e){throw e;}}},error:function(e,_24){if(_24.xhr.status==401){_e=_4.fromJson(_24.xhr.responseText);}if(_1d.no){_1d.no({http_code:_24.xhr.status});}}});};this.hasSomeRole=function(_25){if(_25===null){return true;}else{if(!_25){return false;}else{if(!(_25 instanceof Array)){_25=_25.split(",");}}}var _26=this.getUserRoles("Name");for(var i=0;i<_25.length;i++){var _27=_25[i];for(var j=0;j<_26.length;j++){var _28=_26[j];if(_27==_28){return true;}}}return false;};};return _b;});