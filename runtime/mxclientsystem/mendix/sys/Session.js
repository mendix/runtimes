/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Session",["mendix/lang","mendix/logger","dojo/_base/array","dojo/_base/json","dojo/_base/lang","dojo/_base/window","dojo/io-query","dojo/_base/config","dojo"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){function _a(){var _b=this,_c="mendix.sys.Session",_d=null,_e=[],_f=null,_10=0,_11=false,_12={},_13=null;var _14=function(){window.mx.server.request({request:{action:"keepalive",params:{preventCache:+new Date()}},options:{failOk:true,standalone:true}});};var _15=function(){_f=window.mx.data.jsonToMxObject(_d.user);_e=_3.map(_d.roles,function(_16){return window.mx.data.jsonToMxObject(_16);});};this.toString=function(){return _c;};this.startup=function(){if(_10){setInterval(_14,_10);}_15();};this.getConfig=function(_17){if(!_17){return _d;}else{return _5.getObject(_17,false,_d);}};this.inDevMode=function(){return _11;};this.toggleDevMode=function(){_11=!_11;};this.isGuest=function(){if(!_f||!_f.has("IsAnonymous")){return true;}else{return _f.get2("IsAnonymous");}};this.getUserId=function(){return _f&&_f.getGuid();};this.getUserClass=function(){return _f&&_f.getEntity();};this.getUserName=function(){return _f&&_f.get2("Name");};this.getUserAttribute=function(_18){if(_f&&_f.has(_18)){return _f.get2(_18);}return null;};this.getUserRoles=function(_19){if(_19==null){return _e;}else{return _1.map(_e,function(o){return o.get2(_19);});}};this.getCSRFToken=function(){return this.getConfig("csrftoken");};this.getLicenseInfo=function(){return _12;};this.login=function(_1a){_9.xhrPost({url:window.mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_4.toJson({action:"login",params:{username:_1a.username,password:_1a.password}}),load:function(){_1a.success();},error:function(e){_1a.error(e.response.status);}});};this.logout=function(_1b){window.mx.server.request({request:{action:"logout",params:{log:window.mx.server.flushLog()}},options:{sync:true,callback:_1b}});};this.authorized=function(_1c){var _1d=_6.doc.location.search,_1e=_7.queryToObject(_1d.substr((_1d[0]==="?"?1:0)));var _1f={profile:_1e.profile||"",timezoneoffset:new Date().getTimezoneOffset()};if(typeof navigator!="undefined"&&navigator.standalone){_1f.longLiveTheCookie=true;}_9.xhrPost({url:window.mx.baseUrl,handleAs:"json",contentType:"application/json",postData:_4.toJson({action:"get_session_data",params:_5.mixin({},_1f,_1c&&_1c.params)}),load:_20(true),timeout:_8.timeout||0,error:function(e,_21){if(_21.xhr.status==401){_d=_4.fromJson(_21.xhr.responseText);}else{if(window.localStorage.session){var _22=_20(false);_22(JSON.parse(window.localStorage.session));return;}}if(_1c.no){_1c.no({http_code:_21.xhr.status});}}});function _20(_23){return function onLoad(_24){_d=_24;if(_23){window.localStorage.session=JSON.stringify(_d);}var _25=_b.getConfig("uiconfig.direction")=="rtl"?_8.rtlRedirect:_8.ltrRedirect;if(_25){window.mx.redirect(_25);return;}if(_13&&_13!=_d.cachebust){window.mx.reload();return;}window.mx.server.setCacheBust(_d.cachebust);_13=_d.cachebust;_10=_d.keepalive;if(_1c.yes){try{_1c.yes(_23);}catch(e){throw e;}}};};};this.hasSomeRole=function(_26){if(_26===null){return true;}else{if(!_26){return false;}else{if(!(_26 instanceof Array)){_26=_26.split(",");}}}var _27=this.getUserRoles("Name");for(var i=0;i<_26.length;i++){var _28=_26[i];for(var j=0;j<_27.length;j++){var _29=_27[j];if(_28==_29){return true;}}}return false;};};return _a;});