
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Data",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mendix.sys.Data");mendix.sys.Data=function(_4){_4=_4||{};var _5=this,_6="mendix.sys.Data",_7=false,_8={},_9={},_a={},_b={},_c={},_d=null,_e=null,_f={entities:{},guids:{},attrs:{},vals:{}};var _10=function(_11,_12,map){if(!_12){return _11;}for(var i in map){if((i in _12)&&(_12[i]!=null)){_11[i]=_12[i];}}return _11;};var _13=function(_14,_15,_16,_17){try{_14&&_14.apply(_15,_16||[]);}catch(e){logger.error(_6+_17+" : "+e.message+" "+(_15?"("+_15+")":""));}};var _18=function(_19,_1a,e,_1b){try{if(_19){_19.call(_1a,e);}else{logger.error("unhandled error: "+e.message);mx.onError(e);}}catch(err){logger.error("error in "+_6+"."+_1b+" while calling error handler: "+err.message);}};var _1c=function(ids){var _1d=[];for(var i=0,id;id=ids[i++];){if(_9[id]!==undefined){_1d.push(_9[id]);}}return _1d;};var _1e=function(_1f){var _20=mendix.lang.itemCount;return (_20(_f.guids[_1f])||_20(_f.attrs[_1f]));};var _21=function(_22){var _23=0;for(var i=0,_24;_24=_22[i];i++){if(_9[_24]&&!_1e(_24)){delete _9[_24];delete _c[_24];delete _a[_24];mx.server.release(_24);_23++;}}};var _25=function(_26,_27,_28,_29){var _2a=mendix.lib.MxObject,_2b=[],_2c=[],_2d=false;if(!(_29 instanceof Array)){_2d=!!_29;_29=[];}for(var i=0,_2e;_2e=_26[i];++i){var _2f=_2e.guid,_30=_9[_2f],inc=(_2d||_1.indexOf(_29,_2f)>=0)?1:0;if(!_27){delete _c[_2f];}if(_28&&_30){if(!_27||!_30.hasChanges()){_30.resetFromJSON(_2e);}_a[_2f]+=inc;_2b.push(_30);}else{var obj=new _2a({json:_2e,meta:mx.meta.getEntity(_2e.objectType)});if(_28){_9[_2f]=obj;_a[_2f]=inc;}if(_30){_2c.push(_30.getGuid());}_2b.push(obj);}}if(!_28){_21(_2c);}return _2b;};var _31=function(_32,_33,_34){var _35=function(_36,_37,evt){var _38;if(_37.mxobject){_38=[_37.mxobject];}else{if(_37.mxobjects&&_37.mxobjects.mxobjects){_38=_37.mxobjects.mxobjects;if(!_38.length){_38=[_38];}}else{_38=_37.mxobjects;}}var _39=(_38&&_38.length)?_25(_38,true,_33,_34):[];_32(_39,{count:_37.count,aggregates:_37.aggregates});};return _35;};var _3a=function(_3b,_3c){var obj=_3c,_3d=_3b.getGuid(),_3e=_9[_3d];if(obj){if(_3e){_3e.resetFromJSON(obj.jsonData);}else{_3e=_9[_3d]=obj;_a[_3d]=0;}if(_3b!=_3e){_3b.resetFromJSON(obj.jsonData);}_5.objectUpdateNotification(obj);}else{_9[_3d]=null;if(_3e){_3e.resetFromJSON(null);}}};var _3f=function(_40){var _41=_8[_40].refs;var _42=_8[_40].subClasses;for(var i=0,l=_42.length;i<l;i++){_41.push(_42[i]);}var _43=_8[_40].superClasses;for(i=0,l=_43.length;i<l;i++){_41.push(_43[i]);}return _41;};var _44=function(obj){var _45=obj.getEntity(),_46=obj.getAttributes();_8[_45]={obj:obj,refs:[],entityClasses:{},typeEntities:{},subClasses:{},superClasses:{},referenceSubClasses:{},referenceSuperClasses:{}};for(var i=0;i<_46.length;i++){if(obj.isReference(_46[i])){_8[_45].entityClasses[_46[i]]=obj.getSelectorEntity(_46[i]);_8[_45].typeEntities[obj.getSelectorEntity(_46[i])]=_46[i];_8[_45].refs.push(obj.getSelectorEntity(_46[i]));if(obj.hasSubEntities()){_8[_45].subClasses=obj.getSubEntities();}else{_8[_45].subClasses=[];}if(obj.hasSuperEntities()){var _47=obj.getSuperEntities();_8[_45].ancestor=_47[_47.length-1];}else{_8[_45].ancestor=null;}}}};var _48=function(_49){var obj=mx.meta.getEntity(_49);if(obj){_44(obj);var _4a=_3f(_49);while(_4a.length){_49=_4a.shift();if(_8[_49]==null){_48(_49);}}}};var _4b=function(_4c,_4d){var _4e=_4c.obj.getAttributes(),_4f={},_50="";try{for(var e=0;e<_4e.length;e++){if(!(_4c.obj.isReference(_4e[e]))){continue;}_50=_4c.obj.getSelectorEntity(_4e[e]);var _51=_4d.getContext(_50);if(_51){_4f[_4e[e]]=_51;}if(_8[_50]!=null){if(_8[_50].obj.hasSubEntities()){var _52=_8[_50].obj.getSubEntities();for(var i=0;i<_52.length;i++){_51=_4d.getContext(_52[i]);if(_51){_4f[_4e[e]]=_51;continue;}}}else{}if(_8[_50].obj.hasSuperEntities()){var _53=_8[_50].obj.getSuperEntities();for(var i=0;i<_53.length;i++){if(_4d.hasContext(_53[i])){_4f[_4e[e]]=_4d.getContext(_53[i]);continue;}}}else{}}else{}}}catch(err){}return (_4f);};var _54=function(_55,_56,_57,_58){var _59=_56.split("/");var _5a=function(_5b){var _5c=_59.shift(),ref=_59.shift(),_5d="";if(_5b==null||_5b.length==null||_5b.length===0){_57(null);return;}var _5e=[];for(var i=0;i<_5b.length;i++){if(_5b[i]==null){continue;}_5e.push("id='"+_5b[i].getGuid()+"'");}if(!_5e.length){_57(null);return;}var ids=_5e.join(" or ");_5d="["+ref+"/"+_5c+"["+ids+"]]";if(_59.length==1){_57(_5d);}else{var _5f=_59[0];_5c=_59.shift();ref=_59.shift();_57("["+ref+"/"+_5c+""+_5d+"]");}};var _60=function(){var _61=_59.shift(),ref=_59.shift(),_62;if(_59.length==1){var _63="["+ref+"='"+_55.getGuid()+"']";_57(_63);return;}if(mx.meta.getEntity(_61)==null){_18(_58,null,new mendix.lib.Error(_6+".runMapPath: entity"+_61+" does not exist"),"runMapPath");return;}if(!_55.isA(_61)){_18(_58,null,new mendix.lib.Error(_6+".runMapPath: entity "+_55.getEntity()+" is not a "+_61+" or one of its subclasses"),"runMapPath");return;}if(!_55.has(ref)){_18(_58,null,new mendix.lib.Error(_6+".runMapPath: reference "+ref+" not found in entity "+_61),"runMapPath");return;}if(_55.get(ref)!==""){_5.get({guids:_55.getReferences(ref),callback:_5a,error:_58});}else{_57(null);}};_60();};var _64=this.getBacktrackConstraints=function(_65,_66,_67,_68,_69){if(!_1.isFunction(_68)){_69=_68;_68=null;}_5.getBacktrack(_66.getTrackId(),_66.getConstraints(),_67,_68,_69);};this.getBacktrack=function(_6a,_6b,_6c,_6d,_6e){if(!_1.isFunction(_6d)){_6e=_6d;_6d=null;}if(!_6b||_6b.length===0){_6c.call(_6e,"",true);return;}var _6f=null,_70=[],_71=0,_72=true;var _73=function(){var _74=_6b[_71++];if(_74){_54(_6f,_74,function(_75){if(_75){_70.push(_75);}else{_72=false;}_73();},function(e){_18(_6d,_6e,e,"getBacktrack");});}else{_6c.call(_6e,_70.join(""),_72);}};if(!_6a){_6c.call(_6e,"",false);}else{_5.get({guid:_6a,callback:function(obj){_6f=obj;_73();},error:function(e){_18(_6d,_6e,e,"getBacktrack");}});}};var _76=function(_77){var _78=_77.entity||_77.className,_79=_8[_78],_7a=_77.context,_7b=_77.callback,_7c="//"+_79.obj.getEntity(),_7d=_4b(_79,_7a);for(var m in _7d){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_79.obj.has(m)){var _7e=_79.obj.getAttributeType(m);switch(_7e){case "ObjectReference":_7c+="["+m+"='"+_7d[m]+"']";break;case "ObjectReferenceSet":_7c+="["+m+"='"+_7d[m]+"']";break;default:}}}var _7f=function(_80,_81){_7b&&_7b(_7c+_80,_81);};if(_7a.getConstraints().length!==0){_64(_79.obj,_7a,_7f,_77.error);}else{_7f("",true);}};var _82=function(_83){mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_83.type+"("+_83.xpath+")",resulttype:_83.resulttype||"integer"}},options:{callback:function(_84,_85,evt){var _86;if(_85){if(_83.resulttype=="float"){_86=parseFloat(_85.value).toFixed(2)||"0.00";}else{_86=_85.value||0;}}else{_86=0;}_83.callback&&_83.callback(_86);},error:function(e){_18(_83.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _87=function(_88){var _89=[];if(_88===""){return;}else{if(_88.match(/^\[[^=\[]+=.[0-9]+./)){var _8a=_88.match(/\[.+?\]/g);for(var i=0;i<_8a.length;i++){var _8b=_8a[i];_8b=_8b.substr(1,_8b.length-2);_89.push({ref:_8b.match(/[^=]+/)[0],ref_ids:_8b.match(/\d+/)[0]});}}else{var _8a=_88.match(/\[.+?\]]/g);for(var i=0;i<_8a.length;i++){var _8b=_8a[i];_8b=_8b.substr(1,_8b.length-3);var _8c=_8b.split("[");_89.push({ref:_8c[0].split("/")[0],ref_ids:_8c[1]});}}}return _89;};var _8d=function(){var _8e=0;for(var _8f in _9){if(_a[_8f]===0&&!_1e(_8f)){delete _9[_8f];delete _a[_8f];delete _c[_8f];mx.server.release(_8f);}else{++_8e;}}};this.toString=function(){return _6;};this.startup=function(_90){_7=true;_d=mx.server.registerCaller(_1.hitch(this,"xastrigger"));_e=window.setInterval(function(){_8d();},10000);_90();};this.shutdown=function(){_7=false;_9={};_c={};_a={};clearInterval(_e);mx.server.unregisterCaller(_d);};this.isLoaded=function(){return _7;};this.subscribe=function(_91,_92){var id=mendix.lang.getUniqueId(),_93=_91.entity,_94=_91.guid,val=_91.val,_95=_91.attr,_96=_92?function(){_91.callback.apply(_92,arguments);}:_91.callback;if(_95){if(!_f.attrs[_94]){_f.attrs[_94]={};}if(!_f.attrs[_94][_95]){_f.attrs[_94][_95]={};}_f.attrs[_94][_95][id]=_96;}else{if(val){if(!_f.vals[_94]){_f.vals[_94]={};}_f.vals[_94][id]=_96;}else{if(_94){if(!_f.guids[_94]){_f.guids[_94]={};}_f.guids[_94][id]=_96;}else{if(_93){if(!_f.entities[_93]){_f.entities[_93]={};}_f.entities[_93][id]=_96;}else{logger.error(_6+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_93,guid:_94,val:val,attr:_95,id:id};};this.unsubscribe=function(_97){if(_97==null){return;}var id=_97.id,_98=_97.entity,_99=_97.guid,val=_97.val,_9a=_97.attr,_9b=mendix.lang.itemCount;if(_9a){var _9c=_f.attrs[_99];if(!_9c){}else{if(!_9c[_9a]){}else{delete _9c[_9a][id];if(_9b(_9c[_9a])===0){delete _9c[_9a];}if(_9b(_9c)===0){delete _f.attrs[_99];}}}}else{if(val){if(!_f.vals[_99]){}else{delete _f.vals[_99][id];if(_9b(_f.vals[_99])===0){delete _f.vals[_99];}}}else{if(_99){var _9d=_f.guids[_99];if(!_9d){}else{delete _9d[id];if(_9b(_9d)===0){delete _f.guids[_99];}}}else{if(_98){var _9e=_f.entities[_98];if(!_9e){}else{delete _9e[id];if(_9b(_9e)===0){delete _f.entities[_98];}}}}}}};this.update=function(_9f){var _a0=_9f.guid,_a1=_9f.entity,_a2=_9f.attr,val=_9f.val,_a3=_9f.value,_a4=_9f.callback;var _a5=function(_a6,_a7){var map=_a6?_1.clone(_a6):{};for(var key in map){map[key].apply(null,_a7);}};if(_a2){_a5(_f.attrs[_a0]&&_f.attrs[_a0][_a2],[_a0,_a2,_a3]);}else{if(_a0){_a5(_f.guids[_a0],[_a0]);}else{if(val){_a5(_f.vals[_a0],[_a0]);}else{if(_a1){_a5(_f.entities[_a1],[_a1]);}else{logger.error(_6+".update: no 'entity' or 'guid' parameter found");}}}}_a4&&_a4();};this.objectUpdateNotification=function(_a8){this.update({entity:_a8.getEntity()});if(_a8 instanceof mendix.lib.MxObject){this.update({guid:_a8.getGuid()});}};this.objectPing=function(_a9,_aa){var _ab=_a9.getGuid(),_ac=_1.clone(_f.guids[_ab]),_ad=[];if(_ac){for(var sub in _ac){_ad.push((function(_ae,sub){return function(cb){try{var _af=_ae[sub];if(_af.length==2){_af(_ab,cb);}else{_af(_ab);cb();}}catch(e){if(_ae){delete _ae[sub];}cb();}};})(_ac,sub));}mendix.lang.collect(_ad,_aa);}else{_aa&&_aa();}};this.addValidation=function(_b0,_b1,_b2){if(!_c[_b0]){_c[_b0]=new mendix.lib.ObjectValidation({msg:{guid:_b0}});}_c[_b0].addField(_b1,_b2);};this.sendValidationUpdates=function(_b3){var _b4,_b5,_b6=[];for(var i=0,_b7;_b7=_b3[i];i++){_b5=_f.vals[_b7.getGuid()];var cp=_b7.clone(),_b8=cp.getAttributes();if(_b5){for(var x in _b5){var _b9=_b7.clone();try{_b5[x]([_b9]);}catch(e){logger.error(_6+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _b5[x];}var _ba=_b9.getAttributes();_1.forEach(_b8,function(_bb){var _bc=_bb.name,_bd=_1.some(_ba,function(_be){return _be.name==_bc;});if(!_bd){cp.removeAttribute(_bb.name);}},this);}}else{}if(cp.getAttributes().length){_b6.push(cp);}}mx.ui.validations(_b6);};this.action=function(_bf){var _c0=_bf.context,_c1=_bf.callback,_c2=_bf.error,_c3=_bf.onValidation,_c4=!!_bf.async,_c5=_bf.params,_c6=_bf.store;var _c7=function(e){_18(_c2,null,e,"action");};mx.server.request({request:{action:"executeaction",params:_c5,context:_c0},options:{callback:function(_c8,_c9,_ca){var _cb=_c9.actionResult,_cc;if(_cb instanceof Array){_cc=_25(_cb,false,true,true);}else{if(typeof _cb=="object"&&_cb.guid){_cc=_25([_cb],false,true,true);}else{_cc=_c9.actionResult;}}_c1&&_c1(_cc,_ca);},error:_c7,store:_c6,async:_c4,onValidation:_c3}});};this.setOrRetrieveMxObject=function(_cd){return _25([_cd],false,true)[0];};this.get=function(_ce,_cf){var _d0=_ce.xpath,_d1=_ce.path,id=_ce.guid,ids=(!("guids" in _ce)&&id)?[id]:_ce.guids,_d2=_ce.callback,_d3=_ce.error,_d4=!!_ce.noCache,_d5=!!_ce.count,_d6=_ce.filter,_d7=!!_ce.aggregates,_d8=_ce.context,_d9=_ce.microflow,err;if(("guid" in _ce)&&id==null){_13(_d2,_cf,[null],"");return;}if(!_d0&&!ids&&!_d9){err=_6+".get: xpath, guid|guids and microflow arguments are undefined";logger.error(err);throw new Error(err);}if(_d1&&ids.length!=1){throw new Error(_6+".get : path can only be used with a single guid");}if(typeof _d2!="function"){err=_6+".get: callback is not a function";logger.error(err);throw new Error(err);}else{if(_d3&&typeof _d3!="function"){err=_6+".get: error is not a function";logger.error(err);throw new Error(err);}}if(_d6){if(_d6.limit){_d6.amount=_d6.limit;delete _d6.limit;}if(_d6.references){for(var r in _d6.references){var ref=_d6.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_da=_10({},_d6,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_db=function(e){_18(_d3,_cf,e,"get");};if(_da.id&&ids&&!id){delete _da.id;}if(_da.id){delete _da.attributes;delete _da.distinct;}if(_d9){var _dc=ids?"selection":(_d0?"set":"none"),_dd={actionname:_d9,applyto:_dc};if(_dc=="selection"){_dd.guids=ids;}else{if(_dc=="set"){_dd.xpath=_d0;if(_da.sort){_dd.sort=_da.sort;}}}this.action({params:_dd,context:_d8,callback:function(_de,_df){_d2&&_d2.call(_cf,_de,_df);},error:_db});}else{if(_d1&&ids){mx.server.request({request:{action:"retrieve_by_path",params:{id:ids[0],path:_d1},context:null},options:{callback:_31(function(_e0,_e1){_13(_d2,_cf,[_e0,_e1],".get: error in handler for ["+ids+"]");},true,true),error:_db}});}else{if(ids){if(ids.length===0){_13(_d2,_cf,[id?null:[],{count:0}],".get: error in handler");return;}if(!_d4){var _e2=_1c(ids),_e3=_e2.length==ids.length;if(_e3){var _e4=_e2;if(_da.sort){_1.forEach(_da.sort,function(_e5){var _e6=_e5[0],dir=_e5[1];_e4=_e4.sort(dir=="asc"?function(a,b){a=a.get(_e6);b=b.get(_e6);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get(_e6);b=b.get(_e6);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _e7=_da.offset;if(_e7){var _e8=_da.amount;if(_e8){_e4=_e4.slice(_e7,_e7+_e8);}else{_e4=_e4.slice(_e7);}}for(var i=0,_e9;_e9=_e4[i];++i){++_a[_e9];}_13(_d2,_cf,[id?_e4[0]:_e4,{count:_e2.length}],".get: error in handler for ["+ids+"]");return true;}}var _ea=_da.attributes==null;mx.server.request({request:{action:"retrieve_by_ids",params:{ids:ids,schema:_da}},options:{callback:_31(function(_eb,_ec){var _ed=_eb[0];if(id&&_da.id){for(var i=0,obj;obj=_eb[i];++i){if(obj.getGuid()==id){_ed=obj;break;}}}_13(_d2,_cf,[id?_ed:_eb,_ec],".get: error in handler for ["+ids+"]");},_ea,ids),error:_db}});return true;}else{mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_d0,schema:_da,count:_d5,aggregates:_d7}},options:{callback:_31(function(_ee,_ef){_13(_d2,_cf,[_ee,_ef],".get: error in error handler for xpath "+_d0);},false),error:_db}});return true;}}}};this.getBySchema=function(_f0,_f1){var _f2=_f0.id,_f3=_f0.callback;mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_f0},options:{callback:function(_f4,_f5){var _f6=[],_f7;_1.forEach(_f5.mxobjects,function(_f8){var _f9=new mendix.lib.MxObject({json:_f8,meta:mx.meta.getEntity(_f8.objectType)});if(_f8.guid==_f2){_f7=_f9;}_f6.push(_f9);});_f7.attachReferences(_f6);_f3&&_f3(_f7,false);},error:function(e){_18(_f0.error,_f1,e,"getBySchema");}}});};this.fetch=function(obj,_fa,_fb,_fc,_fd){var _fe=obj,_ff=false,_100,_101,attr;if(_1.isFunction(_fb)){_fd=_fc;_fc=_fb;}if(!_fa){_100=[];}else{if(_fa instanceof Array){_100=_fa.slice();}else{_100=_fa.split("/");}}if(obj&&obj.isA(_100[0])){_100.shift();}if(_100.length%2==1){attr=_100.pop();}else{attr="";}if(_fb.schema){_101=_100.splice(-2);}else{_101=[];}var _102=function(_103,ref){if(_103.isObjectReference(ref)){return _103.getReference(ref);}else{if(_103.isObjectReferenceSet(ref)){return _103.getReferences(ref);}else{return _103.get(ref);}}};var _104=function(){if(_fe==null){_fc(null,false);}else{if(!attr){_fc(_fe,_ff);}else{if(attr){_fc(_102(_fe,attr),false);}}}};var _105=function(ref){if(_fe.getReferences(ref).length===0){_fc([],false);}else{if(_fe.hasChildren(ref)){_fc(_fe.getChildren(ref),false);}else{mx.data.get({guids:_fe.getReferences(ref),filter:{id:_fb.schema},callback:function(objs){_fc(objs,true);},error:_fd});}}};var _106=function(ref,_107){var guid=_fe.getReference(ref);if(guid){mx.data.get({guid:guid,filter:{id:_107},callback:function(obj){if(obj){_fe=obj;_ff=true;_108();}else{_fc(null,false);}},error:_fd});}else{_fc(null,false);}};var _109=function(path){var _10a,_10b;if(path.length<3){return false;}_10a=mx.meta.getEntity(path.slice(-3)[0]),_10b=_100.slice(-2)[0];return _10a.isObjectReferenceSet(_10b);};var _10c=function(_10d,type){var _10e=["//"+type+"[id="+_10d+"]"],_10f=_109([type].concat(_100));Array.prototype.push.apply(_10e,_100);_100=[];mx.data.get({xpath:_10e.join("/"),callback:function(objs){if(objs.length===0){_fc(null,false);}else{if(attr&&objs.length==1){_fe=objs[0];_104();}else{if(!attr){if(_10f){_fc(objs,false);}else{_fe=objs[0];_108();}}else{_18(_fd,null,new mendix.lib.Error(_6+".fetch"+attr+" is not a reference type"),"fetch");}}}},error:_fd});};var _108=function(){var ref,type,_110,_111;if(_100.length+_101.length===0){_104();}else{if(_100.length===0&&_101.length>0){ref=_101.shift();type=_101.shift();if(_fe.isObjectReferenceSet(ref)){_105(ref);}else{_106(ref,_fb.schema);}}else{if(_ff){mx.data.release(_fe);_ff=false;}ref=_100.shift();type=_100.shift();if(_fe.isObjectReferenceSet(ref)){if(_100.length>0||_101>0){_18(_fd,null,new mendix.lib.Error(_6+".fetch: reference set should be at end of path"),"fetch");}else{_105(ref);}}else{if(_fe.isObjectReference(ref)){_110=_fe.getChild(ref);if(_110){_fe=_110;_108();}else{_111=_fe.getReference(ref);if(!_111){_fc(null,false);}else{if(_9[_111]!==undefined){_fe=_9[_111];++_a[_111];_ff=true;_108();}else{if(_fb.usexpath&&_100.length>0){_10c(_111,type);}else{_106(ref);}}}}}else{_18(_fd,null,new mendix.lib.Error(_6+".fetch: attribute "+ref+" is not a reference type"),"fetch");}}}}};_108();};this.release=function(objs){if(!objs){return;}objs=objs instanceof Array?objs:[objs];var _112=[];for(var i=0,len=objs.length;i<len;++i){var obj=objs[i];if(obj){var guid=obj.getGuid();if(_a[guid]){if(--_a[guid]===0&&!_1e(guid)){_112.push(guid);}}else{}}}_21(_112);};this.create=function(_113,_114){var _115=_113.error,_116=_113.context,_117=_113.entity,_118=_113.persistent,err;if(typeof _113.callback!="function"){err=_6+".create: callback is not a function";logger.error(err);throw new Error(err);}else{if(_115&&typeof _115!="function"){err=_6+".create: error is not a function";logger.error(err);throw new Error(err);}else{if(typeof _117!="string"){err=_6+".create: entity is not a string";logger.error(err);throw new Error(err);}}}var _119=function(objs){var obj=objs&&objs[0];if(_116){_5.setObjectToContext(obj,_116);}_113.callback.call(_114,obj);};var _11a=function(e){_18(_115,_114,e,"create");};mx.server.request({request:{action:_118?"create":"instantiate",params:{objecttype:_113.entity,preventCache:(new Date()).getTime()}},options:{callback:_31(_119,true,true),error:_11a}});};this.jsonToMxObject=function(json){return new mendix.lib.MxObject({json:json,meta:mx.meta.getEntity(json.objectType)});};this.remove=function(_11b,_11c){var _11d=_11b.error,_11e=_11b.callback,_11f=("guid" in _11b)?[_11b.guid]:_11b.guids;if(("guids" in _11b)&&!(_11b.guids instanceof Array)){throw new Error(_6+".remove: parameter guids set but not of type Array");}else{if(_11d&&typeof _11d!="function"){throw new Error(_6+".remove: parameter error set but not of type Function");}else{if(_11e&&typeof _11e!="function"){throw new Error(_6+".remove: parameter callback set but not of type Function");}}}mx.server.request({request:{action:"delete",params:{guids:_11f}},options:{callback:function(){_21(_11f);mendix.lang.nullExec(_11e);},error:function(e){_18(_11d,null,e,"remove");}}});};this.save=function(_120,_121){var _122,_123,_124,_125,guid,msg,emsg=".save: error calling handler",e,_126,_127,_128,_129,obj;if(_120){_124=_120.mxobj;_122=_120.callback;_123=_120.error;_125=_120.standalone;}if(typeof _122!="function"){e=_6+".save: callback is not a function";logger.error(e);throw new Error(e);}else{if(_124!=null&&!(_124 instanceof mendix.lib.MxObject)){e=_6+".save: mxobj is not a MxObject";logger.error(e);throw new Error(e);}}if(_124){guid=_124.getGuid();emsg=".save: error calling handler for ["+guid+"]";msg=_c[guid];if(msg){var data=null;if(msg instanceof Error){data=msg;}else{if(msg){data=new mendix.lib.ValidationError();this.sendValidationUpdates([msg.clone()]);}}_18(_123,_121,data,"save");return;}else{if(!_124.hasChanges()){_13(_122,_121,null,emsg);return;}}}_127={};if(!_125){_126=_b;_b={};_128=0;_129=0;for(var id in _126){_129++;obj=_126[id];if(obj.hasChanges()){_128++;_127[id]=obj._collectChanges();}delete _c[id];}if(!_128){if(_129){}_13(_122,_121,null,emsg);return;}}if(_124&&!_126[guid]){_127[guid]=_124._collectChanges();_126={guid:_124};delete _b[guid];delete _c[guid];}mx.server.request({request:{action:"change",params:_127},options:{onValidation:_120.onValidation,sync:true,unique:true,callback:function(){for(var guid in _126){_126[guid]._applyChangeSet();}_126=null;_13(_122,_121,null,emsg);},error:function(e){data=e.original||{};var _12a=false,_12b=guid,ov=mendix.ov;if(ov.hasValidations(data)){_1.forEach(ov.getValidations(data),function(v){var id=v.getGuid();if(_126[id]){_c[id]=v;delete _126[id];}if(_124&&id==_12b){_12a=true;}});for(var id in _126){_126[id]._applyChangeSet();}}else{_1.mixin(_b,_126);_12a=true;}_126=null;if(_124){if(_12a){_18(_123,null,e,"save");}else{_13(_122,_121,null,emsg);}}else{_13(_122,_121,null,emsg);}}}});};this.commit=function(_12c,_12d){var obj,_12e,_12f,_130,_131,guid,e,msg;if(_12c){obj=_12c.mxobj;_12e=_12c.callback;_12f=_12c.error;_130=_12c.onValidation;_131=_12c.context;}if(typeof _12e!="function"){e=_6+".commit: callback is not a function";logger.error(e);throw new Error(e);}else{if(obj!=null&&!(obj instanceof mendix.lib.MxObject)){e=_6+".commit: mxobj is not a MxObject";logger.error(e);throw new Error(e);}}if(obj==null){_13(_12e,_12d,null,".commit: error when executing handler");}else{guid=obj.getGuid();msg=".commit: error when executing handler for ["+guid+"]";mx.server.request({request:{action:"commit",params:{guid:guid},context:_131},options:{callback:function(){obj._commitChangeSet();delete _c[guid];delete _b[guid];_5.objectUpdateNotification(obj);_13(_12e,_12d,null,msg);},error:function(e){_18(_12f,null,e,"commit");},onValidation:_130,store:_12c.store}});}};this.rollback=function(_132,_133){var _134,obj,_135;if(_132){_134=_132.callback;obj=_132.mxobj;_135=_132.error;}var emsg=".rollback: error in handler ",e;if(typeof _134!="function"){e=_6+".rollback: callback is not a function";logger.error(e);throw new Error(e);}else{if(obj!=null&&!(obj instanceof mendix.lib.MxObject)){e=_6+".rollback: mxobj is not a MxObject";logger.error(e);throw new Error(e);}}if(!obj){_13(_134,_133,null,emsg);}else{var guid=obj.getGuid(),claz=obj.getEntity();emsg=_6+".rollback: error in handler for ["+guid+"]";delete _c[guid];delete _b[guid];mx.server.request({request:{action:"rollback",params:{guid:guid}},options:{unique:true,standalone:true,callback:_31(function(objs){obj._commitChangeSet();obj.reset();_3a(obj,objs[0]);_5.sendClassUpdate(claz);_13(_134,_133,null,emsg);},false),error:function(e){_18(_135,null,e,"rollback");}}});}return true;};this.mxObjectsCallback=function(_136){return _31(_136,false);};this.matchObjectsToContext=function(_137){var _138=_137.entity,_139=_137.context,_13a=_137.mxobjs,_13b=_137.callback,_13c=[];_64(mx.meta.getEntity(_138),_139,function(_13d){var _13e=_87(_13d);for(var i=0,obj;obj=_13a[i];i++){var _13f=0;for(var x=0,_140;_140=_13e[x];x++){var ref=_140.ref,_141=_140.ref_ids,ids=obj.getReferences(ref),_142=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_141.match(ids[j])){_142=true;break;}}}_142&&_13f++;}if(_13f==_13e.length){_13c.push(obj);}}_13b(_13c);});};this.createXPathString=function(_143){var _144=_143.callback,_145=_143.entity||_143.className,_146=_143.context;var _147=_146&&_146.getContexts();if(!_147||_147.length===0){_144("//"+_145);return;}if(_8[_145]==null){_48(_145);}_76(_143);};this.generateExport=function(_148){mx.server.request({request:{action:"export",params:_148.params},options:{callback:_148.callback,error:function(e){_18(_148.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_149,_14a){if(typeof _149!="object"){throw new Error(_6+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _14a!="object"){throw new Error(_6+".setObjectToContext: parameter context is not of type Object");}}try{var _14b=_149.getAttributes();for(var e=0;e<_14b.length;e++){if(_149.isReference(_14b[e])){var _14c=_149.getSelectorEntity(_14b[e]);if((_14b[e]=="System.owner")||(_14b[e]=="System.changedBy")){continue;}if(_14a.hasContext(_14c)){_149.addReference(_14b[e],_14a.getContext(_14c));}if(_8[_14c]!=null){if(_8[_14c].obj.hasSubEntities()){var _14d=_8[_14c].obj.getSubEntities();for(var i=0;i<_14d.length;i++){if(_14a.hasContext(_14d[i])){_149.addReference(_14b[e],_14a.getContext(_14d[i]));continue;}}}else{}}else{}}}}catch(err){}};this.sumOfXPathSet=function(_14e){_14e.type="sum";_82(_14e);};this.countOfXPathSet=function(_14f){_14f.type="count";_82(_14f);};this.sizeOfXPathSet=function(_150){_150.type="count";_82(_150);};this.avgOfXPathSet=function(_151){_151.type="avg";_82(_151);};this.maxOfXPathSet=function(_152){_152.type="max";_82(_152);};this.minOfXPathSet=function(_153){_153.type="min";_82(_153);};this.makeChange=function(_154,attr,_155){var guid=_154.getGuid();_b[guid]=_154;delete _c[guid];var _156=_9,_157=_156[guid];if(_157&&_154!=_157){_157._makeChange(attr,_155);}else{this.update({guid:guid,attr:attr,value:_155});}};this.xastrigger=function(_158){if(mendix.lang.itemCount(_b)===0){_158&&_158();}else{this.save({mxobj:null,callback:_158});}};this.sendClassUpdate=function(_159){var obj=mx.meta.getEntity(_159);obj&&this.objectUpdateNotification(obj);};};});