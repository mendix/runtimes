
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Data",["mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/ObjectValidation","mendix/ov","mendix/lib/MxObject","mendix/lang","mendix/logger","dojo/_base/array","dojo/_base/lang"],function(_1,_2,_3,ov,_4,_5,_6,_7,_8){function _9(){var _a=this,_b="mendix.sys.Data",_c={},_d={},_e={},_f={},_10={entities:{},guids:{},attrs:{},vals:{}};var _11=function(_12,_13,map){if(!_13){return _12;}for(var i in map){if((i in _13)&&(_13[i]!=null)){_12[i]=_13[i];}}return _12;};var _14=function(_15,_16,_17,_18){try{_15&&_15.apply(_16,_17||[]);}catch(e){_6.error(_b+_18+" : "+e.message+" "+(_16?"("+_16+")":""));}};var _19=function(_1a,_1b,e,_1c){try{if(_1a){_1a.call(_1b,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_b+"."+_1c+" while calling error handler: "+err.message);}};var _1d=function(ids){var _1e=[];for(var i=0,id;id=ids[i++];){if(_c[id]!==undefined){_1e.push(_c[id]);}}return _1e;};var _1f=function(_20){var _21=_5.itemCount;return (_21(_10.guids[_20])||_21(_10.attrs[_20]));};var _22=function(_23){var _24=0;for(var i=0,_25;_25=_23[i];i++){if(_c[_25]&&!_1f(_25)){delete _c[_25];delete _f[_25];delete _d[_25];window.mx.server.release(_25);_24++;}}};var _26=function(_27,_28,_29,_2a){var _2b=[],_2c=[],_2d=false;if(!(_2a instanceof Array)){_2d=!!_2a;_2a=[];}for(var i=0,_2e;_2e=_27[i];++i){var _2f=_2e.guid,_30=_c[_2f],inc=(_2d||_7.indexOf(_2a,_2f)>=0)?1:0;if(!_28){delete _f[_2f];}if(_29&&_30){if(!_28||!_30.hasChanges()){_30.resetFromJSON(_2e);}_d[_2f]+=inc;_2b.push(_30);}else{var obj=new _4({json:_2e,meta:window.mx.meta.getEntity(_2e.objectType)});if(_29){_c[_2f]=obj;_d[_2f]=inc;}if(_30){_2c.push(_30.getGuid());}_2b.push(obj);}}if(!_29){_22(_2c);}return _2b;};var _31=function(_32,_33,_34){var _35=function(_36,_37){var _38;if(_37.mxobject){_38=[_37.mxobject];}else{if(_37.mxobjects&&_37.mxobjects.mxobjects){_38=_37.mxobjects.mxobjects;if(!_38.length){_38=[_38];}}else{_38=_37.mxobjects;}}var _39=(_38&&_38.length)?_26(_38,true,_33,_34):[];_32(_39,{count:_37.count,aggregates:_37.aggregates});};return _35;};var _3a=function(_3b,_3c){var obj=_3c,_3d=_3b.getGuid(),_3e=_c[_3d];if(obj){if(_3e){_3e.resetFromJSON(obj.jsonData);}else{_3e=_c[_3d]=obj;_d[_3d]=0;}if(_3b!=_3e){_3b.resetFromJSON(obj.jsonData);}_a.objectUpdateNotification(obj);}else{_c[_3d]=null;if(_3e){_3e.resetFromJSON(null);}}};var _3f=function(_40,_41){var _42={};_7.forEach(_40.getAttributes(),function(ref){if(!_40.isReference(ref)){return;}var _43=_41.getContext(_40.getSelectorEntity(ref));if(_43){_42[ref]=_43;}});return _42;};var _44=function(_45,_46,_47,_48){var _49=_46.split("/");var _4a=function(_4b){var _4c=_49.shift(),ref=_49.shift(),_4d;if(_4b==null||_4b.length==null||_4b.length===0){_47(null);return;}var _4e=[];for(var i=0;i<_4b.length;i++){if(_4b[i]==null){continue;}_4e.push("id='"+_4b[i].getGuid()+"'");}if(!_4e.length){_47(null);return;}var ids=_4e.join(" or ");_4d="["+ref+"/"+_4c+"["+ids+"]]";if(_49.length==1){_47(_4d);}else{var _4f=_49[0];_4c=_49.shift();ref=_49.shift();_47("["+ref+"/"+_4c+""+_4d+"]");}};var _50=function(){var _51=_49.shift(),ref=_49.shift();if(_49.length==1){var _52="["+ref+"='"+_45.getGuid()+"']";_47(_52);return;}if(window.mx.meta.getEntity(_51)==null){_19(_48,null,new _1(_b+".runMapPath: entity"+_51+" does not exist"),"runMapPath");return;}if(!_45.isA(_51)){_19(_48,null,new _1(_b+".runMapPath: entity "+_45.getEntity()+" is not a "+_51+" or one of its subclasses"),"runMapPath");return;}if(!_45.has(ref)){_19(_48,null,new _1(_b+".runMapPath: reference "+ref+" not found in entity "+_51),"runMapPath");return;}if(_45.get(ref)!==""){_a.get({guids:_45.getReferences(ref),callback:_4a,error:_48});}else{_47(null);}};_50();};var _53=this.getBacktrackConstraints=function(_54,_55,_56,_57,_58){if(!_8.isFunction(_57)){_58=_57;_57=null;}_a.getBacktrack(_55.getTrackId(),_55.getConstraints(),_56,_57,_58);};this.getBacktrack=function(_59,_5a,_5b,_5c,_5d){if(!_8.isFunction(_5c)){_5d=_5c;_5c=null;}if(!_5a||_5a.length===0){_5b.call(_5d,"",true);return;}var _5e=null,_5f=[],_60=0,_61=true;var _62=function(){var _63=_5a[_60++];if(_63){_44(_5e,_63,function(_64){if(_64){_5f.push(_64);}else{_61=false;}_62();},function(e){_19(_5c,_5d,e,"getBacktrack");});}else{_5b.call(_5d,_5f.join(""),_61);}};if(!_59){_5b.call(_5d,"",false);}else{_a.get({guid:_59,callback:function(obj){_5e=obj;_62();},error:function(e){_19(_5c,_5d,e,"getBacktrack");}});}};var _65=function(_66,_67){var _68=[],_69=_3f(_66,_67);for(var m in _69){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_66.has(m)){var _6a=_66.getAttributeType(m);switch(_6a){case "ObjectReference":_68.push("["+m+"='"+_69[m]+"']");break;case "ObjectReferenceSet":_68.push("["+m+"='"+_69[m]+"']");break;default:}}}return _68.join("");};var _6b=function(_6c){var _6d=_6c.entity||_6c.className,_6e=window.mx.meta.getEntity(_6d),_6f=_6c.context,_70="//"+_6d,_71=_65(_6e,_6f);var _72=function(_73,_74){if(_6c.callback){_6c.callback(_70+_71+_73,_74);}};if(_6f.getConstraints().length!==0){_53(_6e,_6f,_72,_6c.error);}else{_72("",true);}};var _75=function(_76){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_76.type+"("+_76.xpath+")",resulttype:_76.resulttype||"integer"}},options:{callback:function(_77,_78){var _79;if(_78){if(_76.resulttype=="float"){_79=parseFloat(_78.value).toFixed(2)||"0.00";}else{_79=_78.value||0;}}else{_79=0;}_76.callback&&_76.callback(_79);},error:function(e){_19(_76.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _7a=function(_7b){var _7c;if(_7b===""){return;}else{if(_7b.match(/^\[[^=\[]+=.[0-9]+./)){_7c=_7.map(_7b.match(/\[.+?\]/g),function(_7d){_7d=_7d.substr(1,_7d.length-2);return {ref:_7d.match(/[^=]+/)[0],ref_ids:_7d.match(/\d+/)[0]};});}else{_7c=_7.map(_7b.match(/\[.+?\]]/g),function(_7e){_7e=_7e.substr(1,_7e.length-3);var _7f=_7e.split("[");return {ref:_7f[0].split("/")[0],ref_ids:_7f[1]};});}}return _7c;};var _80=function(){var _81=0;for(var _82 in _c){if(_d[_82]===0&&!_1f(_82)){delete _c[_82];delete _d[_82];delete _f[_82];window.mx.server.release(_82);}else{++_81;}}};this.toString=function(){return _b;};this.startup=function(){window.mx.server.registerCaller(_8.hitch(this,"xastrigger"));window.setInterval(_80,10000);};this.subscribe=function(_83,_84){var id=_5.getUniqueId(),_85=_83.entity,_86=_83.guid,val=_83.val,_87=_83.attr,_88=_84?function(){_83.callback.apply(_84,arguments);}:_83.callback;if(_87){if(!_10.attrs[_86]){_10.attrs[_86]={};}if(!_10.attrs[_86][_87]){_10.attrs[_86][_87]={};}_10.attrs[_86][_87][id]=_88;}else{if(val){if(!_10.vals[_86]){_10.vals[_86]={};}_10.vals[_86][id]=_88;}else{if(_86){if(!_10.guids[_86]){_10.guids[_86]={};}_10.guids[_86][id]=_88;}else{if(_85){if(!_10.entities[_85]){_10.entities[_85]={};}_10.entities[_85][id]=_88;}else{_6.error(_b+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_85,guid:_86,val:val,attr:_87,id:id};};this.unsubscribe=function(_89){if(_89==null){return;}var id=_89.id,_8a=_89.entity,_8b=_89.guid,val=_89.val,_8c=_89.attr,_8d=_5.itemCount;if(_8c){var _8e=_10.attrs[_8b];if(!_8e){}else{if(!_8e[_8c]){}else{delete _8e[_8c][id];if(_8d(_8e[_8c])===0){delete _8e[_8c];}if(_8d(_8e)===0){delete _10.attrs[_8b];}}}}else{if(val){if(!_10.vals[_8b]){}else{delete _10.vals[_8b][id];if(_8d(_10.vals[_8b])===0){delete _10.vals[_8b];}}}else{if(_8b){var _8f=_10.guids[_8b];if(!_8f){}else{delete _8f[id];if(_8d(_8f)===0){delete _10.guids[_8b];}}}else{if(_8a){var _90=_10.entities[_8a];if(!_90){}else{delete _90[id];if(_8d(_90)===0){delete _10.entities[_8a];}}}}}}};this.update=function(_91){var _92=_91.guid,_93=_91.entity,_94=_91.attr,val=_91.val,_95=_91.value,_96=_91.callback;var _97=function(_98,_99){var map=_98?_8.clone(_98):{};for(var key in map){map[key].apply(null,_99);}};if(_94){_97(_10.attrs[_92]&&_10.attrs[_92][_94],[_92,_94,_95]);}else{if(_92){_97(_10.guids[_92],[_92]);}else{if(val){_97(_10.vals[_92],[_92]);}else{if(_93){_97(_10.entities[_93],[_93]);}else{_6.error(_b+".update: no 'entity' or 'guid' parameter found");}}}}_96&&_96();};this.objectUpdateNotification=function(_9a){_a.sendClassUpdate(_9a.getEntity());_a.update({guid:_9a.getGuid()});};this.sendClassUpdate=function(_9b){var _9c=window.mx.meta.getEntity(_9b);if(!_9c){throw new _1("No permission to read or write entity "+_9b+", check security!");}_7.forEach([_9b].concat(_9c.getSuperEntities()),function(ent){_a.update({entity:ent});});};this.objectPing=function(_9d,_9e){var _9f=_9d.getGuid(),_a0=_8.clone(_10.guids[_9f]),_a1=[];if(_a0){for(var sub in _a0){_a1.push((function(_a2,sub){return function(cb){try{var _a3=_a2[sub];if(_a3.length==2){_a3(_9f,cb);}else{_a3(_9f);cb();}}catch(e){if(_a2){delete _a2[sub];}cb();}};})(_a0,sub));}_5.collect(_a1,_9e);}else{_9e&&_9e();}};this.addValidation=function(_a4,_a5,_a6){if(!_f[_a4]){_f[_a4]=new _3({msg:{guid:_a4}});}_f[_a4].addField(_a5,_a6);};this.sendValidationUpdates=function(_a7){var _a8,_a9=[];for(var i=0,_aa;_aa=_a7[i];i++){_a8=_10.vals[_aa.getGuid()];var cp=_aa.clone(),_ab=cp.getAttributes();if(_a8){for(var x in _a8){var _ac=_aa.clone();try{_a8[x]([_ac]);}catch(e){_6.error(_b+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _a8[x];}var _ad=_ac.getAttributes();_7.forEach(_ab,function(_ae){var _af=_ae.name,_b0=_7.some(_ad,function(_b1){return _b1.name==_af;});if(!_b0){cp.removeAttribute(_ae.name);}},this);}}else{}if(cp.getAttributes().length){_a9.push(cp);}}window.mx.ui.validations(_a9);};this.action=function(_b2){var _b3=_b2.context,_b4=_b2.callback,_b5=_b2.error,_b6=_b2.onValidation,_b7=!!_b2.async,_b8=_b2.params,_b9=_b2.store;var _ba=function(e){_19(_b5,null,e,"action");};window.mx.server.request({request:{action:"executeaction",params:_b8,context:_b3},options:{callback:function(_bb,_bc,_bd){var _be=_bc.actionResult,_bf;if(_be instanceof Array){_bf=_26(_be,false,true,true);}else{if(typeof _be=="object"&&_be.guid){_bf=_26([_be],false,true,true);}else{_bf=_bc.actionResult;}}_b4&&_b4(_bf,_bd);},error:_ba,store:_b9,async:_b7,onValidation:_b6}});};this.setOrRetrieveMxObject=function(_c0){return _26([_c0],false,true)[0];};this.get=function(_c1,_c2){var _c3=_c1.xpath,_c4=_c1.path,id=_c1.guid,ids=(!("guids" in _c1)&&id)?[id]:_c1.guids,_c5=_c1.callback,_c6=_c1.error,_c7=!!_c1.noCache,_c8=!!_c1.count,_c9=_c1.filter,_ca=!!_c1.aggregates,_cb=_c1.context,_cc=_c1.microflow,err;if(("guid" in _c1)&&id==null){_14(_c5,_c2,[null],"");return;}if(!_c3&&!ids&&!_cc){err=_b+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _1(err);}if(_c4&&ids.length!=1){throw new _1(_b+".get : path can only be used with a single guid");}if(typeof _c5!="function"){err=_b+".get: callback is not a function";_6.error(err);throw new _1(err);}else{if(_c6&&typeof _c6!="function"){err=_b+".get: error is not a function";_6.error(err);throw new _1(err);}}if(_c9){if(_c9.limit){_c9.amount=_c9.limit;delete _c9.limit;}if(_c9.references){for(var r in _c9.references){var ref=_c9.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_cd=_11({},_c9,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_ce=function(e){_19(_c6,_c2,e,"get");};if(_cd.id&&ids&&!id){delete _cd.id;}if(_cd.id){delete _cd.attributes;delete _cd.distinct;}if(_cc){var _cf=ids?"selection":(_c3?"set":"none"),_d0={actionname:_cc,applyto:_cf};if(_cf=="selection"){_d0.guids=ids;}else{if(_cf=="set"){_d0.xpath=_c3;if(_cd.sort){_d0.sort=_cd.sort;}}}this.action({params:_d0,context:_cb,callback:function(_d1,_d2){_c5&&_c5.call(_c2,_d1,_d2);},error:_ce});}else{if(_c4&&ids){window.mx.server.request({request:{action:"retrieve_by_path",params:{id:ids[0],path:_c4},context:null},options:{callback:_31(function(_d3,_d4){_14(_c5,_c2,[_d3,_d4],".get: error in handler for ["+ids+"]");},true,true),error:_ce}});}else{if(ids){if(ids.length===0){_14(_c5,_c2,[id?null:[],{count:0}],".get: error in handler");return;}if(!_c7){var _d5=_1d(ids),_d6=_d5.length==ids.length;if(_d6){var _d7=_d5;if(_cd.sort){_7.forEach(_cd.sort,function(_d8){var _d9=_d8[0],dir=_d8[1];_d7=_d7.sort(dir=="asc"?function(a,b){a=a.get(_d9);b=b.get(_d9);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get(_d9);b=b.get(_d9);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _da=_cd.offset;if(_da){var _db=_cd.amount;if(_db){_d7=_d7.slice(_da,_da+_db);}else{_d7=_d7.slice(_da);}}for(var i=0,_dc;_dc=_d7[i];++i){++_d[_dc];}_14(_c5,_c2,[id?_d7[0]:_d7,{count:_d5.length}],".get: error in handler for ["+ids+"]");return true;}}var _dd=_cd.attributes==null;window.mx.server.request({request:{action:"retrieve_by_ids",params:{ids:ids,schema:_cd}},options:{callback:_31(function(_de,_df){var _e0=_de[0];if(id&&_cd.id){for(var i=0,obj;obj=_de[i];++i){if(obj.getGuid()==id){_e0=obj;break;}}}_14(_c5,_c2,[id?_e0:_de,_df],".get: error in handler for ["+ids+"]");},_dd,ids),error:_ce}});return true;}else{window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_c3,schema:_cd,count:_c8,aggregates:_ca}},options:{callback:_31(function(_e1,_e2){_14(_c5,_c2,[_e1,_e2],".get: error in error handler for xpath "+_c3);},false),error:_ce}});return true;}}}};this.getBySchema=function(_e3,_e4){var _e5=_e3.id,_e6=_e3.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_e3},options:{callback:function(_e7,_e8){var _e9=[],_ea;_7.forEach(_e8.mxobjects,function(_eb){var _ec=new _4({json:_eb,meta:window.mx.meta.getEntity(_eb.objectType)});if(_eb.guid==_e5){_ea=_ec;}_e9.push(_ec);});_ea.attachReferences(_e9);_e6&&_e6(_ea,false);},error:function(e){_19(_e3.error,_e4,e,"getBySchema");}}});};this.fetch=function(obj,_ed,_ee,_ef,_f0){var _f1=obj,_f2=false,_f3,_f4,_f5;if(_8.isFunction(_ee)){_f0=_ef;_ef=_ee;}if(!_ed){_f3=[];}else{if(_ed instanceof Array){_f3=_ed.slice();}else{_f3=_ed.split("/");}}if(obj&&obj.isA(_f3[0])){_f3.shift();}if(_f3.length%2==1){_f5=_f3.pop();}else{_f5="";}if(_ee.schema){_f4=_f3.splice(-2,_f3.length);}else{_f4=[];}var _f6=function(_f7,ref){if(_f7.isObjectReference(ref)){return _f7.getReference(ref);}else{if(_f7.isObjectReferenceSet(ref)){return _f7.getReferences(ref);}else{return _f7.get(ref);}}};var _f8=function(){if(_f1==null){_ef(null,false);}else{if(!_f5){_ef(_f1,_f2);}else{if(_f5){_ef(_f6(_f1,_f5),false);}}}};var _f9=function(ref){if(_f1.getReferences(ref).length===0){_ef([],false);}else{if(_f1.hasChildren(ref)){_ef(_f1.getChildren(ref),false);}else{window.mx.data.get({guids:_f1.getReferences(ref),filter:{id:_ee.schema},callback:function(_fa){_ef(_fa,true);},error:_f0});}}};var _fb=function(ref,_fc){var _fd=_f1.getReference(ref);if(_fd){window.mx.data.get({guid:_fd,filter:{id:_fc},callback:function(obj){if(obj){_f1=obj;_f2=true;_fe();}else{_ef(null,false);}},error:_f0});}else{_ef(null,false);}};var _ff=function(path){var _100,_101;if(path.length<3){return false;}_100=window.mx.meta.getEntity(path.slice(-3)[0]),_101=_f3.slice(-2)[0];return _100.isObjectReferenceSet(_101);};var _102=function(_103,type){var _104=["//"+type+"[id="+_103+"]"],_105=_ff([type].concat(_f3));Array.prototype.push.apply(_104,_f3);_f3=[];window.mx.data.get({xpath:_104.join("/"),callback:function(objs){if(objs.length===0){_ef(null,false);}else{if(_f5&&objs.length==1){_f1=objs[0];_f8();}else{if(!_f5){if(_105){_ef(objs,false);}else{_f1=objs[0];_fe();}}else{_19(_f0,null,new _1(_b+".fetch"+_f5+" is not a reference type"),"fetch");}}}},error:_f0});};var _fe=function(){var ref,type,_106,_107;if(_f3.length+_f4.length===0){_f8();}else{if(_f3.length===0&&_f4.length>0){ref=_f4.shift();type=_f4.shift();if(_f1.isObjectReferenceSet(ref)){_f9(ref);}else{_fb(ref,_ee.schema);}}else{if(_f2){window.mx.data.release(_f1);_f2=false;}ref=_f3.shift();type=_f3.shift();if(_f1.isObjectReferenceSet(ref)){if(_f3.length>0||_f4>0){_19(_f0,null,new _1(_b+".fetch: reference set should be at end of path"),"fetch");}else{_f9(ref);}}else{if(_f1.isObjectReference(ref)){_106=_f1.getChild(ref);if(_106){_f1=_106;_fe();}else{_107=_f1.getReference(ref);if(!_107){_ef(null,false);}else{if(_c[_107]!==undefined){_f1=_c[_107];++_d[_107];_f2=true;_fe();}else{if(_ee.usexpath&&_f3.length>0){_102(_107,type);}else{_fb(ref);}}}}}else{_19(_f0,null,new _1(_b+".fetch: attribute "+ref+" is not a reference type"),"fetch");}}}}};_fe();};this.release=function(objs){if(!objs){return;}objs=objs instanceof Array?objs:[objs];var _108=[];for(var i=0,len=objs.length;i<len;++i){var obj=objs[i];if(obj){var guid=obj.getGuid();if(_d[guid]){if(--_d[guid]===0&&!_1f(guid)){_108.push(guid);}}else{}}}_22(_108);};this.create=function(_109,_10a){var _10b=_109.error,_10c=_109.context,_10d=_109.entity,_10e=_109.persistent,err;if(typeof _109.callback!="function"){err=_b+".create: callback is not a function";_6.error(err);throw new _1(err);}else{if(_10b&&typeof _10b!="function"){err=_b+".create: error is not a function";_6.error(err);throw new _1(err);}else{if(typeof _10d!="string"){err=_b+".create: entity is not a string";_6.error(err);throw new _1(err);}}}var _10f=function(objs){var obj=objs&&objs[0];if(_10c){_a.setObjectToContext(obj,_10c);}_109.callback.call(_10a,obj);};var _110=function(e){_19(_10b,_10a,e,"create");};window.mx.server.request({request:{action:_10e?"create":"instantiate",params:{objecttype:_109.entity,preventCache:(new Date()).getTime()}},options:{callback:_31(_10f,true,true),error:_110}});};this.jsonToMxObject=function(json){return new _4({json:json,meta:window.mx.meta.getEntity(json.objectType)});};this.remove=function(_111){var _112=_111.error,_113=_111.callback,_114=("guid" in _111)?[_111.guid]:_111.guids;if(("guids" in _111)&&!(_111.guids instanceof Array)){throw new _1(_b+".remove: parameter guids set but not of type Array");}else{if(_112&&typeof _112!="function"){throw new _1(_b+".remove: parameter error set but not of type Function");}else{if(_113&&typeof _113!="function"){throw new _1(_b+".remove: parameter callback set but not of type Function");}}}window.mx.server.request({request:{action:"delete",params:{guids:_114}},options:{callback:function(){_22(_114);_5.nullExec(_113);},error:function(e){_19(_112,null,e,"remove");}}});};this.save=function(_115,_116){var _117,_118,_119,_11a,guid,msg,emsg=".save: error calling handler",e,_11b,_11c,_11d,_11e,obj;if(_115){_119=_115.mxobj;_117=_115.callback;_118=_115.error;_11a=_115.standalone;}if(typeof _117!="function"){e=_b+".save: callback is not a function";_6.error(e);throw new _1(e);}else{if(_119!=null&&!(_119 instanceof _4)){e=_b+".save: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(_119){guid=_119.getGuid();emsg=".save: error calling handler for ["+guid+"]";msg=_f[guid];if(msg){var data=null;if(msg instanceof _1){data=msg;}else{if(msg){data=new _2();this.sendValidationUpdates([msg.clone()]);}}_19(_118,_116,data,"save");return;}else{if(!_119.hasChanges()){_14(_117,_116,null,emsg);return;}}}_11c={};if(!_11a){_11b=_e;_e={};_11d=0;_11e=0;for(var id in _11b){_11e++;obj=_11b[id];if(obj.hasChanges()){_11d++;_11c[id]=obj._collectChanges();}delete _f[id];}if(!_11d){if(_11e){}_14(_117,_116,null,emsg);return;}}if(_119&&!_11b[guid]){_11c[guid]=_119._collectChanges();_11b={guid:_119};delete _e[guid];delete _f[guid];}window.mx.server.request({request:{action:"change",params:_11c},options:{onValidation:_115.onValidation,sync:true,unique:true,callback:function(){for(var guid in _11b){_11b[guid]._applyChangeSet();}_11b=null;_14(_117,_116,null,emsg);},error:function(e){data=e.original||{};var _11f=false,_120=guid;if(ov.hasValidations(data)){_7.forEach(ov.getValidations(data),function(v){var id=v.getGuid();if(_11b[id]){_f[id]=v;delete _11b[id];}if(_119&&id==_120){_11f=true;}});for(var id in _11b){_11b[id]._applyChangeSet();}}else{_8.mixin(_e,_11b);_11f=true;}_11b=null;if(_119){if(_11f){_19(_118,null,e,"save");}else{_14(_117,_116,null,emsg);}}else{_14(_117,_116,null,emsg);}}}});};this.commit=function(_121,_122){var obj,_123,_124,_125,_126,guid,e,msg;if(_121){obj=_121.mxobj;_123=_121.callback;_124=_121.error;_125=_121.onValidation;_126=_121.context;}if(typeof _123!="function"){e=_b+".commit: callback is not a function";_6.error(e);throw new _1(e);}else{if(obj!=null&&!(obj instanceof _4)){e=_b+".commit: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(obj==null){_14(_123,_122,null,".commit: error when executing handler");}else{guid=obj.getGuid();msg=".commit: error when executing handler for ["+guid+"]";window.mx.server.request({request:{action:"commit",params:{guid:guid},context:_126},options:{callback:function(){obj._commitChangeSet();delete _f[guid];delete _e[guid];_a.objectUpdateNotification(obj);_14(_123,_122,null,msg);},error:function(e){_19(_124,null,e,"commit");},onValidation:_125,store:_121.store}});}};this.rollback=function(_127,_128){var _129,obj,_12a;if(_127){_129=_127.callback;obj=_127.mxobj;_12a=_127.error;}var emsg=".rollback: error in handler ",e;if(typeof _129!="function"){e=_b+".rollback: callback is not a function";_6.error(e);throw new _1(e);}else{if(obj!=null&&!(obj instanceof _4)){e=_b+".rollback: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(!obj){_14(_129,_128,null,emsg);}else{var guid=obj.getGuid(),claz=obj.getEntity();emsg=_b+".rollback: error in handler for ["+guid+"]";delete _f[guid];delete _e[guid];window.mx.server.request({request:{action:"rollback",params:{guid:guid}},options:{unique:true,standalone:true,callback:_31(function(objs){obj._commitChangeSet();obj.reset();_3a(obj,objs[0]);_a.sendClassUpdate(claz);_14(_129,_128,null,emsg);},false),error:function(e){_19(_12a,null,e,"rollback");}}});}return true;};this.mxObjectsCallback=function(_12b){return _31(_12b,false);};this.matchObjectsToContext=function(_12c){var _12d=_12c.entity,_12e=_12c.context,_12f=_12c.mxobjs,_130=_12c.callback,_131=[];_53(window.mx.meta.getEntity(_12d),_12e,function(_132){var _133=_7a(_132);for(var i=0,obj;obj=_12f[i];i++){var _134=0;for(var x=0,_135;_135=_133[x];x++){var ref=_135.ref,_136=_135.ref_ids,ids=obj.getReferences(ref),_137=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_136.match(ids[j])){_137=true;break;}}}_137&&_134++;}if(_134==_133.length){_131.push(obj);}}_130(_131);});};this.createXPathString=function(_138){var _139=_138.callback,_13a=_138.entity||_138.className,_13b=_138.context;var _13c=_13b&&_13b.getContexts();if(!_13c||_13c.length===0){_139("//"+_13a);return;}_6b(_138);};this.generateExport=function(_13d){window.mx.server.request({request:{action:"export",params:_13d.params},options:{callback:_13d.callback,error:function(e){_19(_13d.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_13e,_13f){if(typeof _13e!="object"){throw new _1(_b+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _13f!="object"){throw new _1(_b+".setObjectToContext: parameter context is not of type Object");}}try{var _140=_13e.getAttributes();for(var e=0;e<_140.length;e++){if(_13e.isReference(_140[e])){var _141=_13e.getSelectorEntity(_140[e]);if((_140[e]=="System.owner")||(_140[e]=="System.changedBy")){continue;}if(_13f.hasContext(_141)){_13e.addReference(_140[e],_13f.getContext(_141));}var meta=window.mx.meta.getEntity(_141);if(meta){if(meta.hasSubEntities()){var _142=meta.getSubEntities();for(var i=0;i<_142.length;i++){if(_13f.hasContext(_142[i])){_13e.addReference(_140[e],_13f.getContext(_142[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_143){_143.type="sum";_75(_143);};this.countOfXPathSet=function(_144){_144.type="count";_75(_144);};this.sizeOfXPathSet=function(_145){_145.type="count";_75(_145);};this.avgOfXPathSet=function(_146){_146.type="avg";_75(_146);};this.maxOfXPathSet=function(_147){_147.type="max";_75(_147);};this.minOfXPathSet=function(_148){_148.type="min";_75(_148);};this.makeChange=function(_149,attr,_14a){var guid=_149.getGuid();_e[guid]=_149;delete _f[guid];var _14b=_c,_14c=_14b[guid];if(_14c&&_149!=_14c){_14c._makeChange(attr,_14a);}else{this.update({guid:guid,attr:attr,value:_14a});}};this.xastrigger=function(_14d){if(_5.itemCount(_e)===0){_14d&&_14d();}else{this.save({mxobj:null,callback:_14d});}};};return _9;});