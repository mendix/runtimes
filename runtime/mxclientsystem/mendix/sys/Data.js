/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Data",["mendix/lib/ConnectionError","mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/MxObject","mendix/lang","mendix/logger","webcore/data-backend/OnlineDataBackend","webcore/data-backend/OfflineDataBackend","webcore/MxObjectCache","webcore/MxObjectBackend","dojo/_base/array","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){function _d(_e){_e=_e||{};var _f=this,_10="mendix.sys.Data",_11={entities:{},guids:{},attrs:{},vals:{}};var _12=new _7();var _13=new _a(_12,new _9(),function(_14){return !_15(_14);});var _16=_12;var _17=function(_18,_19,map){if(!_19){return _18;}for(var i in map){if((i in _19)&&(_19[i]!=null)){_18[i]=_19[i];}}return _18;};var _1a=function(_1b,_1c,_1d,_1e){try{_1b&&_1b.apply(_1c,_1d||[]);}catch(e){_6.error(_10+_1e+" : "+e.message+" "+(_1c?"("+_1c+")":""));}};var _1f=function(_20,_21,e,_22){try{if(_20){_20.call(_21,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_10+"."+_22+" while calling error handler: "+err.message);}};var _15=function(_23){var _24=_5.itemCount;return (_24(_11.guids[_23])||_24(_11.attrs[_23]));};var _25=function(_26,_27){var _28={};_b.forEach(_26.getAttributes(),function(ref){if(!_26.isReference(ref)){return;}var _29=_27.getContext(_26.getSelectorEntity(ref));if(_29){_28[ref]=_29;}});return _28;};var _2a=function(_2b,_2c,_2d,_2e){var _2f=_2c.split("/");var _30=function(_31){var _32=_2f.shift(),ref=_2f.shift(),_33;if(_31==null||_31.length==null||_31.length===0){_2d(null);return;}var _34=[];for(var i=0;i<_31.length;i++){if(_31[i]==null){continue;}_34.push("id='"+_31[i].getGuid()+"'");}if(!_34.length){_2d(null);return;}var ids=_34.join(" or ");_33="["+ref+"/"+_32+"["+ids+"]]";if(_2f.length==1){_2d(_33);}else{var _35=_2f[0];_32=_2f.shift();ref=_2f.shift();_2d("["+ref+"/"+_32+""+_33+"]");}};var _36=function(){var _37=_2f.shift(),ref=_2f.shift();if(_2f.length==1){var _38="["+ref+"='"+_2b.getGuid()+"']";_2d(_38);return;}if(window.mx.meta.getEntity(_37)==null){_1f(_2e,null,new _2(_10+".runMapPath: entity"+_37+" does not exist"),"runMapPath");return;}if(!_2b.isA(_37)){_1f(_2e,null,new _2(_10+".runMapPath: entity "+_2b.getEntity()+" is not a "+_37+" or one of its subclasses"),"runMapPath");return;}if(!_2b.has(ref)){_1f(_2e,null,new _2(_10+".runMapPath: reference "+ref+" not found in entity "+_37),"runMapPath");return;}if(_2b.get2(ref)!==""){_f.get({guids:_2b.getReferences(ref),callback:_30,error:_2e});}else{_2d(null);}};_36();};this.getBacktrackConstraints=function(_39,_3a,_3b,_3c,_3d){if(!_c.isFunction(_3c)){_3d=_3c;_3c=null;}_f.getBacktrack(_3a.getTrackId(),_3a.getConstraints(),_3b,_3c,_3d);};var _3e=this.getBacktrackConstraints;this.getBacktrack=function(_3f,_40,_41,_42,_43){if(!_c.isFunction(_42)){_43=_42;_42=null;}if(!_40||_40.length===0){_41.call(_43,"",true);return;}var _44=null,_45=[],_46=0,_47=true;var _48=function(){var _49=_40[_46++];if(_49){_2a(_44,_49,function(_4a){if(_4a){_45.push(_4a);}else{_47=false;}_48();},function(e){_1f(_42,_43,e,"getBacktrack");});}else{_41.call(_43,_45.join(""),_47);}};if(!_3f){_41.call(_43,"",false);}else{_f.get({guid:_3f,callback:function(obj){_44=obj;_48();},error:function(e){_1f(_42,_43,e,"getBacktrack");}});}};var _4b=function(_4c,_4d){var _4e=[],_4f=_25(_4c,_4d);for(var m in _4f){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_4c.has(m)){var _50=_4c.getAttributeType(m);switch(_50){case "ObjectReference":_4e.push("["+m+"='"+_4f[m]+"']");break;case "ObjectReferenceSet":_4e.push("["+m+"='"+_4f[m]+"']");break;default:}}}return _4e.join("");};var _51=function(_52){var _53=_52.entity||_52.className,_54=window.mx.meta.getEntity(_53),_55=_52.context,_56="//"+_53,_57=_4b(_54,_55);var _58=function(_59,_5a){if(_52.callback){_52.callback(_56+_57+_59,_5a);}};if(_55.getConstraints().length!==0){_3e(_54,_55,_58,_52.error);}else{_58("",true);}};var _5b=function(_5c){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_5c.type+"("+_5c.xpath+")",resulttype:_5c.resulttype||"integer"}},options:{callback:function(_5d,_5e){var _5f;if(_5e){if(_5c.resulttype=="float"){_5f=parseFloat(_5e.value).toFixed(2)||"0.00";}else{_5f=_5e.value||0;}}else{_5f=0;}_5c.callback&&_5c.callback(_5f);},error:function(e){_1f(_5c.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _60=function(_61){var _62;if(_61===""){return;}else{if(_61.match(/^\[[^=\[]+=.[0-9]+./)){_62=_b.map(_61.match(/\[.+?\]/g),function(_63){_63=_63.substr(1,_63.length-2);return {ref:_63.match(/[^=]+/)[0],ref_ids:_63.match(/\d+/)[0]};});}else{_62=_b.map(_61.match(/\[.+?\]]/g),function(_64){_64=_64.substr(1,_64.length-3);var _65=_64.split("[");return {ref:_65[0].split("/")[0],ref_ids:_65[1]};});}}return _62;};this.toString=function(){return _10;};this.setOfflineStore=function(_66,_67){_16=new _8(_66,_67,_e.offlineBackend);_13=new _a(_16,new _9(),function(_68){return !_15(_68);});};this.startup=function(){window.mx.server.registerCaller(_c.hitch(_13,"flush"));window.setInterval(_c.hitch(_13,"cleanup"),10000);};this.subscribe=function(_69,_6a){var id=_5.getUniqueId(),_6b=_69.entity,_6c=_69.guid,val=_69.val,_6d=_69.attr,_6e=_69.async,_6f=_6a?function(){_69.callback.apply(_6a,arguments);}:_69.callback;var _70={handler:_6f,async:_6e};if(_6d){if(!_11.attrs[_6c]){_11.attrs[_6c]={};}if(!_11.attrs[_6c][_6d]){_11.attrs[_6c][_6d]={};}_11.attrs[_6c][_6d][id]=_70;}else{if(val){if(!_11.vals[_6c]){_11.vals[_6c]={};}_11.vals[_6c][id]=_70;}else{if(_6c){if(!_11.guids[_6c]){_11.guids[_6c]={};}_11.guids[_6c][id]=_70;}else{if(_6b){if(!_11.entities[_6b]){_11.entities[_6b]={};}_11.entities[_6b][id]=_70;}else{_6.error(_10+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_6b,guid:_6c,val:val,attr:_6d,id:id};};this.unsubscribe=function(_71){if(_71==null){return;}var id=_71.id,_72=_71.entity,_73=_71.guid,val=_71.val,_74=_71.attr,_75=_5.itemCount;if(_74){var _76=_11.attrs[_73];if(!_76){}else{if(!_76[_74]){}else{delete _76[_74][id];if(_75(_76[_74])===0){delete _76[_74];}if(_75(_76)===0){delete _11.attrs[_73];}}}}else{if(val){if(!_11.vals[_73]){}else{delete _11.vals[_73][id];if(_75(_11.vals[_73])===0){delete _11.vals[_73];}}}else{if(_73){var _77=_11.guids[_73];if(!_77){}else{delete _77[id];if(_75(_77)===0){delete _11.guids[_73];}}}else{if(_72){var _78=_11.entities[_72];if(!_78){}else{delete _78[id];if(_75(_78)===0){delete _11.entities[_72];}}}}}}};this.update=function(_79){var _7a=_79.guid,_7b=_79.entity,_7c=_79.attr,val=_79.val,_7d=_79.value,_7e=_79.callback;var _7f=function(_80,_81,_82){var map=_80?_c.clone(_80):{};_5.collect(Object.keys(map).map(function(key){if(map[key].async){return function(cb){map[key].handler.apply(null,_81.concat([cb]));};}else{return function(cb){map[key].handler.apply(null,_81);cb();};}}),_82);};if(_7c){_7f(_11.attrs[_7a]&&_11.attrs[_7a][_7c],[_7a,_7c,_7d],_7e);}else{if(_7a){_7f(_11.guids[_7a],[_7a],_7e);}else{if(val){_7f(_11.vals[_7a],[_7a],_7e);}else{if(_7b){_7f(_11.entities[_7b],[_7b],_7e);}else{_6.error(_10+".update: no 'entity' or 'guid' parameter found");}}}}};this.objectUpdateNotification=function(_83){_f.sendClassUpdate(_83.getEntity());_f.update({guid:_83.getGuid()});};this.sendClassUpdate=function(_84,_85){var _86=window.mx.meta.getEntity(_84);if(!_86){throw new _2("No permission to read or write entity "+_84+", check security!");}var _87=[_84].concat(_86.getSuperEntities()).map(function(ent){return function(cb){_f.update({entity:ent,callback:cb});};});_5.collect(_87,_85);};this.sendValidationUpdates=function(_88){var _89,_8a=[];for(var i=0,_8b;_8b=_88[i];i++){_89=_11.vals[_8b.getGuid()];var cp=_8b.clone(),_8c=cp.getAttributes();if(_89){for(var x in _89){var _8d=_8b.clone();try{_89[x].handler([_8d]);}catch(e){_6.error(_10+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _89[x];}var _8e=_8d.getAttributes();_b.forEach(_8c,function(_8f){var _90=_8f.name,_91=_b.some(_8e,function(_92){return _92.name==_90;});if(!_91){cp.removeAttribute(_8f.name);}},this);}}else{}if(cp.getAttributes().length){_8a.push(cp);}}window.mx.ui.validations(_8a);};this.action=function(_93){_13.action(_93.params,_93.context,_93.store,!!_93.async,_93.onValidation,function(_94,_95){if(_93.callback){_93.callback(_94,_95);}},function(e){_1f(_93.error,null,e,"action");});};this.setOrRetrieveMxObject=function(_96){return _13.setOrRetrieveMxObject(_96);};this.get=function(_97,_98){var _99=_97.xpath,_9a=_97.path,id=_97.guid,ids=(!("guids" in _97)&&id)?[id]:_97.guids,_9b=_97.callback,_9c=_97.error,_9d=!!_97.noCache,_9e=!!_97.count,_9f=_97.filter,_a0=!!_97.aggregates,_a1=_97.context,_a2=_97.microflow,err;if(("guid" in _97)&&id==null){_1a(_9b,_98,[null],"");return;}if(!_99&&!ids&&!_a2){err=_10+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _2(err);}if(_9a&&ids.length!=1){throw new _2(_10+".get : path can only be used with a single guid");}if(typeof _9b!="function"){err=_10+".get: callback is not a function";_6.error(err);throw new _2(err);}else{if(_9c&&typeof _9c!="function"){err=_10+".get: error is not a function";_6.error(err);throw new _2(err);}}if(_9f){if(_9f.limit){_9f.amount=_9f.limit;delete _9f.limit;}if(_9f.references){for(var r in _9f.references){var ref=_9f.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_a3=_17({},_9f,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_a4=function(e){_1f(_9c,_98,e,"get");};if(_a3.id&&ids&&!id){delete _a3.id;}if(_a3.id){delete _a3.attributes;delete _a3.distinct;}if(_a2){var _a5=ids?"selection":(_99?"set":"none"),_a6={actionname:_a2,applyto:_a5};if(_a5=="selection"){_a6.guids=ids;}else{if(_a5=="set"){_a6.xpath=_99;if(_a3.sort){_a6.sort=_a3.sort;}}}this.action({params:_a6,context:_a1,callback:function(_a7,_a8){_9b&&_9b.call(_98,_a7,_a8);},error:_a4});}else{if(_9a&&ids){_13.getByPath(ids[0],_9a,_97.entity,function(_a9,_aa){try{if(_9b){_9b.call(_98,_a9,{count:_aa});}}catch(e){_6.error(_10+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_98?"("+_98+")":""));}},function(e){_1f(_9c,_98,e,"get");});}else{if(ids){if(ids.length===0){_1a(_9b,_98,[id?null:[],{count:0}],".get: error in handler");return;}_13.getByGuid(ids,_a3,!_9d,function(_ab,_ac){var _ad;if(id){if(_a3.id){_ad=_b.filter(_ab,function(_ae){return _ae.getGuid()===id;})[0];if(_ad===undefined){_1f(_9c,_98,new _2("Returned objects do not contain requested one"),"get");return;}}else{_ad=_ab[0]||null;}}else{_ad=_ab;}try{if(_9b){_9b.call(_98,_ad,{count:_ac});}}catch(e){_6.error(_10+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_98?"("+_98+")":""));}},function(e){_1f(_9c,_98,e,"get");});return true;}else{_13.getByXPath(_99,_a3,_9e,_a0,function(_af,_b0,_b1){_1a(_9b,_98,[_af,{count:_b0,aggregates:_b1}],".get: error in error handler for xpath "+_99);},_a4);return true;}}}};this.getBySchema=function(_b2,_b3){var _b4=_b2.id,_b5=_b2.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_b2},options:{callback:function(_b6,_b7){var _b8=[],_b9;_b.forEach(_b7.mxobjects,function(_ba){var _bb=new _4({json:_ba,meta:window.mx.meta.getEntity(_ba.objectType)});if(_ba.guid==_b4){_b9=_bb;}_b8.push(_bb);});_b9.attachReferences(_b8);_b5&&_b5(_b9,false);},error:function(e){_1f(_b2.error,_b3,e,"getBySchema");}}});};this.getSlice=function(_bc,_bd,_be,_bf,_c0){_13.getSlice(_bc,_bd,_be).spread(function(_c1,_c2){if(_bf){_bf(_c1,_c2);}}).caught(function(e){if(_c0){_c0(e);}else{mx.onError(e);}});};this.fetch=function(obj,_c3,_c4,_c5,_c6){if(_c.isFunction(_c4)){_c6=_c5;_c5=_c4;}var _c7;if(!_c3){_c7=[];}else{if(_c3 instanceof Array){_c7=_c3.slice();}else{_c7=_c3.split("/");}}if(obj&&obj.isA(_c7[0])){_c7.shift();}var _c8;if(_c7.length%2==1){_c8=_c7.pop();}else{_c8="";}_13.fetch(obj,_c7,_c8,_c4,_c5,_c9);function _c9(e){_1f(_c6,null,e,"fetch");};};this.release=function(_ca){if(!_ca){return;}_ca=_ca instanceof Array?_ca:[_ca];for(var i=0,len=_ca.length;i<len;++i){if(_ca[i]){_13.release(_ca[i].getGuid());}}};this.create=function(_cb,_cc){if(typeof _cb.callback!="function"){throw new _2(_10+".create: callback is not a function");}else{if(_cb.error&&typeof _cb.error!="function"){throw new _2(_10+".create: error is not a function");}else{if(typeof _cb.entity!="string"){throw new _2(_10+".create: entity is not a string");}}}_13.create(_cb.entity,_cb.persistent,function(obj){if(_cb.context){_f.setObjectToContext(obj,_cb.context);}_cb.callback.call(_cc,obj);},function(e){_1f(_cb.error,_cc,e,"create");});};this.jsonToMxObject=function(_cd){return new _4({json:_cd,meta:window.mx.meta.getEntity(_cd.objectType)});};this.remove=function(_ce){var _cf=("guid" in _ce)?[_ce.guid]:_ce.guids;if(("guids" in _ce)&&!(_ce.guids instanceof Array)){throw new _2(_10+".remove: parameter guids set but not of type Array");}else{if(_ce.error&&typeof _ce.error!="function"){throw new _2(_10+".remove: parameter error set but not of type Function");}else{if(_ce.callback&&typeof _ce.callback!="function"){throw new _2(_10+".remove: parameter callback set but not of type Function");}}}_13.remove(_cf,_ce.callback,_d0);function _d0(e){_1f(_ce.error,null,e,"remove");};};this.save=function(_d1,_d2){if(typeof _d1.callback!="function"){throw new _2(_10+".save: callback is not a function");}else{if(_d1.mxobj!=null&&!(_d1.mxobj instanceof _4)){throw new _2(_10+".save: mxobj is not an MxObject");}}_13.save(_d1.mxobj,_d1.standalone,_d1.onValidation,_d3,_d4);function _d3(){var msg=".save: error calling handler";if(_d1.mxobj){msg+=" for ["+_d1.mxobj.getGuid()+"]";}_1a(_d1.callback,_d2,null,msg);};function _d4(_d5){var err;if(_d5 instanceof Error){err=_d5;}else{if(_d5){err=new _3();_f.sendValidationUpdates([_d5.clone()]);}}_1f(_d1.error,_d2,err,"save");};};this.commit=function(_d6,_d7){if(typeof _d6!="object"){throw new _2(_10+".commit: args is not an object");}else{if(typeof _d6.callback!="function"){throw new _2(_10+".commit: callback is not a function");}else{if(_d6.mxobj!=null&&!(_d6.mxobj instanceof _4)){throw new _2(_10+".commit: mxobj is not a MxObject");}}}if(!_d6.mxobj&&_d6.callback){_1a(_d6.callback,_d7,null,".commit: error when executing handler without object");return;}_13.commit(_d6.mxobj.getGuid(),_d6.context,_d6.store,_d6.onValidation,_d8,_d9);function _d8(){_f.objectUpdateNotification(_d6.mxobj);_1a(_d6.callback,_d7,null,".commit: error when executing handler for ["+_d6.mxobj.getGuid()+"]");};function _d9(e){_1f(_d6.error,null,e,"commit");};};this.rollback=function(_da,_db){if(typeof _da!="object"){throw new _2(_10+".rollback: args is not an object");}else{if(typeof _da.callback!="function"){throw new _2(_10+".rollback: callback is not a function");}else{if(_da.mxobj!=null&&!(_da.mxobj instanceof _4)){throw new _2(_10+".rollback: mxobj is not a MxObject");}}}if(!_da.mxobj){_1a(_da.callback,_db,null,".rollback: error in handler");return;}var _dc=_da.mxobj;var _dd=_dc.getEntity();var _de=_dc.getGuid();_13.rollback(_dc,_df,_e0);function _df(_e1){if(_e1){_dc.resetFromJSON(_e1.jsonData);_f.objectUpdateNotification(_e1);}_dc.reset();_f.sendClassUpdate(_dd);_1a(_da.callback,_db,null,_10+".rollback: error in handler for ["+_de+"]");};function _e0(e){_1f(_da.error,null,e,"rollback");};};this.synchronize=function(_e2,_e3){return _16.upload(_12).caught(function(e){if(!(e instanceof _1)){return _16.cleanupDirtyObjects().then(function(){return null;});}else{throw e;}}).then(function(_e4){return _16.download().then(function(){if(_e2){_e2(_e4);}});}).caught(function(e){if(_e3){_e3(e);}});};this.invalidateCaches=function(_e5){_13.invalidateCaches(_e5);};this.saveDocument=function(_e6,_e7,_e8,_e9,_ea,_eb){_13.saveDocument(_e6,_e7,_e8,_e9,_ea,_eb);};this.matchObjectsToContext=function(_ec){var _ed=_ec.entity,_ee=_ec.context,_ef=_ec.mxobjs,_f0=_ec.callback,_f1=[];_3e(window.mx.meta.getEntity(_ed),_ee,function(_f2){var _f3=_60(_f2);for(var i=0,obj;obj=_ef[i];i++){var _f4=0;for(var x=0,_f5;_f5=_f3[x];x++){var ref=_f5.ref,_f6=_f5.ref_ids,ids=obj.getReferences(ref),_f7=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_f6.match(ids[j])){_f7=true;break;}}}_f7&&_f4++;}if(_f4==_f3.length){_f1.push(obj);}}_f0(_f1);});};this.createXPathString=function(_f8){var _f9=_f8.callback,_fa=_f8.entity||_f8.className,_fb=_f8.context;var _fc=_fb&&_fb.getContexts();if(!_fc||_fc.length===0){_f9("//"+_fa);return;}_51(_f8);};this.generateExport=function(_fd){window.mx.server.request({request:{action:"export",params:_fd.params},options:{callback:_fd.callback,error:function(e){_1f(_fd.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_fe,_ff){if(typeof _fe!="object"){throw new _2(_10+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _ff!="object"){throw new _2(_10+".setObjectToContext: parameter context is not of type Object");}}try{var _100=_fe.getAttributes();for(var e=0;e<_100.length;e++){if(_fe.isReference(_100[e])){var _101=_fe.getSelectorEntity(_100[e]);if((_100[e]=="System.owner")||(_100[e]=="System.changedBy")){continue;}if(_ff.hasContext(_101)){_fe.addReference(_100[e],_ff.getContext(_101));}var meta=window.mx.meta.getEntity(_101);if(meta){if(meta.hasSubEntities()){var _102=meta.getSubEntities();for(var i=0;i<_102.length;i++){if(_ff.hasContext(_102[i])){_fe.addReference(_100[e],_ff.getContext(_102[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_103){_103.type="sum";_5b(_103);};this.countOfXPathSet=function(_104){_104.type="count";_5b(_104);};this.sizeOfXPathSet=function(_105){_105.type="count";_5b(_105);};this.avgOfXPathSet=function(_106){_106.type="avg";_5b(_106);};this.maxOfXPathSet=function(_107){_107.type="max";_5b(_107);};this.minOfXPathSet=function(_108){_108.type="min";_5b(_108);};this.makeChange=function(_109,attr,_10a){_13.makeChange(_109,attr,_10a);this.update({guid:_109.getGuid(),attr:attr,value:_109.get(attr)});};this.flush=function(_10b){_13.flush(_10b);};this.getDocumentUrl=function(guid,_10c,_10d){return _16.getDocumentUrl(guid,_10c,_10d);};};return _d;});