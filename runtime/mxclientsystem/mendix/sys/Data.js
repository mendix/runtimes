/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Data",["mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/ObjectValidation","mendix/ov","mendix/lib/MxObject","mendix/lang","mendix/logger","webcore/MxObjectCache","webcore/offline","bluebird/bluebird","dojo/_base/array","dojo/_base/lang","big/big"],function(_1,_2,_3,ov,_4,_5,_6,_7,_8,_9,_a,_b,_c){function _d(_e){_e=_e||{};var _f=this,_10="mendix.sys.Data",_11=new _7(),_12={},_13={},_14={entities:{},guids:{},attrs:{},vals:{}};var _15={getByGuid:function(_16,_17,_18,_19,_1a){if(_18){var _1b=_a.filter(_a.map(_16,_11.getObject,_11),function(_1c){return _1c!=null;});var _1d=_a.every(_16,function(_1e){return _11.has(_1e)||_11.isBlacklisted(_1e);});if(_1d){var _1f=_1b;if(_17.sort){_a.forEach(_17.sort,function(_20){var _21=_20[0],dir=_20[1];_1f=_1f.sort(dir=="asc"?function(a,b){a=a.get2(_21);b=b.get2(_21);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get2(_21);b=b.get2(_21);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _22=_17.offset;if(_22){var _23=_17.amount;if(_23){_1f=_1f.slice(_22,_22+_23);}else{_1f=_1f.slice(_22);}}_a.forEach(_1f,_11.reference,_11);if(_19){_19(_1f,_1b.length);}return;}}var _24=_17.attributes==null;window.mx.server.request({request:{action:"retrieve_by_ids",params:{ids:_16,schema:_17}},options:{callback:function(_25,_26){var _27=_26.mxobjects||[];var _28=_a.map(_27,function(obj){return _29(true,_24,true,obj);});if(_19){_19(_28,_28.length);}},error:_1a}});},retrieveByPath:function(_2a,_2b,_2c,_2d){window.mx.server.request({request:{action:"retrieve_by_path",params:{id:_2a,path:_2b},context:null},options:{callback:function(_2e,_2f){var _30=_2f.mxobjects||[];var _31=_a.map(_30,function(obj){return _29(true,true,true,obj);});if(_2c){_2c(_31,_31.length);}},error:_2d}});},fetch:function(obj,_32,_33,_34,_35,_36){var _37=obj;var _38=false;var _39;if(_34.schema){_39=_32.splice(-2,_32.length);}else{_39=[];}var _3a=function(_3b,ref){if(_3b.isObjectReference(ref)){return _3b.getReference(ref);}else{if(_3b.isObjectReferenceSet(ref)){return _3b.getReferences(ref);}else{return _3b.get2(ref);}}};var _3c=function(){if(_37==null){_35(null,false);}else{if(!_33){_35(_37,_38);}else{if(_33){_35(_3a(_37,_33),false);}}}};var _3d=function(ref){if(_37.getReferences(ref).length===0){_35([],false);}else{if(_37.hasChildren(ref)){_35(_37.getChildren(ref),false);}else{window.mx.data.get({guids:_37.getReferences(ref),filter:{id:_34.schema},callback:function(_3e){_35(_3e,true);},error:_36});}}};var _3f=function(ref,_40){var _41=_37.getReference(ref);if(_41){window.mx.data.get({guid:_41,filter:{id:_40},callback:function(obj){if(obj){_37=obj;_38=true;_42();}else{_35(null,false);}},error:_36});}else{_35(null,false);}};var _43=function(_44){var _45,_46;if(_44.length<3){return false;}_45=window.mx.meta.getEntity(_44.slice(-3)[0]),_46=_32.slice(-2)[0];return _45.isObjectReferenceSet(_46);};var _47=function(_48,_49){var _4a=["//"+_49+"[id="+_48+"]"],_4b=_43([_49].concat(_32));Array.prototype.push.apply(_4a,_32);_32=[];window.mx.data.get({xpath:_4a.join("/"),callback:function(_4c){if(_4c.length===0){_35(null,false);}else{if(_33&&_4c.length==1){_37=_4c[0];_3c();}else{if(!_33){if(_4b){_35(_4c,false);}else{_37=_4c[0];_42();}}else{_50(_36,null,new _1(_10+".fetch"+_33+" is not a reference type"),"fetch");}}}},error:_36});};var _42=function(){var ref,_4d,_4e,_4f;if(_32.length+_39.length===0){_3c();}else{if(_32.length===0&&_39.length>0){ref=_39.shift();_4d=_39.shift();if(_37.isObjectReferenceSet(ref)){_3d(ref);}else{_3f(ref,_34.schema);}}else{if(_38){window.mx.data.release(_37);_38=false;}ref=_32.shift();_4d=_32.shift();if(_37.isObjectReferenceSet(ref)){if(_32.length>0||_39>0){_50(_36,null,new _1(_10+".fetch: reference set should be at end of path"),"fetch");}else{_3d(ref);}}else{if(_37.isObjectReference(ref)){_4e=_37.getChild(ref);if(_4e){_37=_4e;_42();}else{_4f=_37.getReference(ref);if(!_4f){_35(null,false);}else{if(_11.has(_4f)){_37=_11.getObject(_4f);_11.reference(_4f);_38=true;_42();}else{if(_34.usexpath&&_32.length>0){_47(_4f,_4d);}else{_3f(ref);}}}}}else{_50(_36,null,new _1(_10+".fetch: attribute "+ref+" is not a reference type"),"fetch");}}}}};_42();},release:function(_51){if(_11.has(_51)&&_11.isReferenced(_51)){_11.unreference(_51);if(!_11.isReferenced(_51)&&!_52(_51)){_53(_51);}}else{}},action:function(_54,_55,_56,_57,_58,_59,_5a){window.mx.server.request({request:{action:"executeaction",params:_54,context:_55},options:{callback:function(_5b,_5c,_5d){var _5e=_5c.actionResult,_5f;if(_5e instanceof Array){_5f=_a.map(_5e,function(obj){return _29(false,true,true,obj);});}else{if(typeof _5e=="object"&&_5e.guid){_5f=[_29(false,true,true,_5e)];}else{_5f=_5c.actionResult;}}if(_59){_59(_5f,_5d);}},error:_5a,store:_56,async:_57,onValidation:_58}});}};var _60={getByGuid:function(_61,_62,_63,_64,_65){_9.all(_61.map(_8.getByGuid)).then(function(_66){if(_64){var _67=(_62&&_62.offset)||0;var end=(_62&&_62.amount)||_66.length;_64(_66.slice(_67,end),_66.length);}}).caught(_65);},retrieveByPath:function(_68,_69,_6a,_6b){_6b(new _1("Not implemented yet"));},fetch:function(obj,_6c,_6d,_6e,_6f,_70){var p=_8.getByGuid(obj.getGuid());for(var i=0;i<_6c.length-1;i+=2){p=p.then(this._fetchForPathElement(_6c[i]));}return p.then(function(_71){if(_6f){_6f(_71,false);}}).caught(_70);},release:function(_72){},action:function(_73,_74,_75,_76,_77,_78,_79){_79(new _1("Not implemented yet"));},_fetchForPathElement:function(_7a){return function(_7b){var _7c=null;if(_7b){var _7d=_7b.getAttribute(_7a);if(_7d){_7c=_8.getByGuid(_7d);}}return _7c;};}};var _7e=_e.useBrowserBackend?_60:_15;var _7f=function(_80,_81,map){if(!_81){return _80;}for(var i in map){if((i in _81)&&(_81[i]!=null)){_80[i]=_81[i];}}return _80;};var _82=function(_83,_84,_85,_86){try{_83&&_83.apply(_84,_85||[]);}catch(e){_6.error(_10+_86+" : "+e.message+" "+(_84?"("+_84+")":""));}};var _50=function(_87,_88,e,_89){try{if(_87){_87.call(_88,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_10+"."+_89+" while calling error handler: "+err.message);}};var _52=function(_8a){var _8b=_5.itemCount;return (_8b(_14.guids[_8a])||_8b(_14.attrs[_8a]));};function _53(_8c){if(!_52(_8c)){_11.removeObject(_8c);delete _13[_8c];window.mx.server.release(_8c);}};function _29(_8d,_8e,_8f,_90){var _91=_11.getObject(_90.guid);if(_8e&&_91){if(!_8d||!_91.hasChanges()){_11.reset(_90);}if(_8f){_11.reference(_90.guid);}return _91;}else{var obj=new _4({json:_90,meta:window.mx.meta.getEntity(_90.objectType)});if(_8e&&!_91){_11.add(obj);if(_8f){_11.reference(_90.guid);}}else{if(!_8e&&_91){_53(_90.guid);}}return obj;}};var _92=function(_93,_94,_95){var _96=function(_97,_98){var _99;if(_98.mxobject){_99=[_98.mxobject];}else{if(_98.mxobjects&&_98.mxobjects.mxobjects){_99=_98.mxobjects.mxobjects;if(!_99.length){_99=[_99];}}else{_99=_98.mxobjects;}}var _9a=(_99&&_99.length)?_a.map(_99,function(obj){return _29(true,_94,_95,obj);}):[];_93(_9a,{count:_98.count,aggregates:_a.map(_98.aggregates,function(agg){return agg===""?agg:new _c(agg);})});};return _96;};function _9b(_9c,_9d){var _9e=_9c.getGuid();var _9f=_11.getObject(_9e);if(_9d){if(_9f){_11.reset(_9d.jsonData);}else{_11.add(_9d);}if(_9c!==_9f){_9c.resetFromJSON(_9d.jsonData);}_f.objectUpdateNotification(_9d);}else{_11.blacklist(_9e);}};var _a0=function(_a1,_a2){var _a3={};_a.forEach(_a1.getAttributes(),function(ref){if(!_a1.isReference(ref)){return;}var _a4=_a2.getContext(_a1.getSelectorEntity(ref));if(_a4){_a3[ref]=_a4;}});return _a3;};var _a5=function(_a6,_a7,_a8,_a9){var _aa=_a7.split("/");var _ab=function(_ac){var _ad=_aa.shift(),ref=_aa.shift(),_ae;if(_ac==null||_ac.length==null||_ac.length===0){_a8(null);return;}var _af=[];for(var i=0;i<_ac.length;i++){if(_ac[i]==null){continue;}_af.push("id='"+_ac[i].getGuid()+"'");}if(!_af.length){_a8(null);return;}var ids=_af.join(" or ");_ae="["+ref+"/"+_ad+"["+ids+"]]";if(_aa.length==1){_a8(_ae);}else{var _b0=_aa[0];_ad=_aa.shift();ref=_aa.shift();_a8("["+ref+"/"+_ad+""+_ae+"]");}};var _b1=function(){var _b2=_aa.shift(),ref=_aa.shift();if(_aa.length==1){var _b3="["+ref+"='"+_a6.getGuid()+"']";_a8(_b3);return;}if(window.mx.meta.getEntity(_b2)==null){_50(_a9,null,new _1(_10+".runMapPath: entity"+_b2+" does not exist"),"runMapPath");return;}if(!_a6.isA(_b2)){_50(_a9,null,new _1(_10+".runMapPath: entity "+_a6.getEntity()+" is not a "+_b2+" or one of its subclasses"),"runMapPath");return;}if(!_a6.has(ref)){_50(_a9,null,new _1(_10+".runMapPath: reference "+ref+" not found in entity "+_b2),"runMapPath");return;}if(_a6.get2(ref)!==""){_f.get({guids:_a6.getReferences(ref),callback:_ab,error:_a9});}else{_a8(null);}};_b1();};this.getBacktrackConstraints=function(_b4,_b5,_b6,_b7,_b8){if(!_b.isFunction(_b7)){_b8=_b7;_b7=null;}_f.getBacktrack(_b5.getTrackId(),_b5.getConstraints(),_b6,_b7,_b8);};var _b9=this.getBacktrackConstraints;this.getBacktrack=function(_ba,_bb,_bc,_bd,_be){if(!_b.isFunction(_bd)){_be=_bd;_bd=null;}if(!_bb||_bb.length===0){_bc.call(_be,"",true);return;}var _bf=null,_c0=[],_c1=0,_c2=true;var _c3=function(){var _c4=_bb[_c1++];if(_c4){_a5(_bf,_c4,function(_c5){if(_c5){_c0.push(_c5);}else{_c2=false;}_c3();},function(e){_50(_bd,_be,e,"getBacktrack");});}else{_bc.call(_be,_c0.join(""),_c2);}};if(!_ba){_bc.call(_be,"",false);}else{_f.get({guid:_ba,callback:function(obj){_bf=obj;_c3();},error:function(e){_50(_bd,_be,e,"getBacktrack");}});}};var _c6=function(_c7,_c8){var _c9=[],_ca=_a0(_c7,_c8);for(var m in _ca){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_c7.has(m)){var _cb=_c7.getAttributeType(m);switch(_cb){case "ObjectReference":_c9.push("["+m+"='"+_ca[m]+"']");break;case "ObjectReferenceSet":_c9.push("["+m+"='"+_ca[m]+"']");break;default:}}}return _c9.join("");};var _cc=function(_cd){var _ce=_cd.entity||_cd.className,_cf=window.mx.meta.getEntity(_ce),_d0=_cd.context,_d1="//"+_ce,_d2=_c6(_cf,_d0);var _d3=function(_d4,_d5){if(_cd.callback){_cd.callback(_d1+_d2+_d4,_d5);}};if(_d0.getConstraints().length!==0){_b9(_cf,_d0,_d3,_cd.error);}else{_d3("",true);}};var _d6=function(_d7){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_d7.type+"("+_d7.xpath+")",resulttype:_d7.resulttype||"integer"}},options:{callback:function(_d8,_d9){var _da;if(_d9){if(_d7.resulttype=="float"){_da=parseFloat(_d9.value).toFixed(2)||"0.00";}else{_da=_d9.value||0;}}else{_da=0;}_d7.callback&&_d7.callback(_da);},error:function(e){_50(_d7.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _db=function(_dc){var _dd;if(_dc===""){return;}else{if(_dc.match(/^\[[^=\[]+=.[0-9]+./)){_dd=_a.map(_dc.match(/\[.+?\]/g),function(_de){_de=_de.substr(1,_de.length-2);return {ref:_de.match(/[^=]+/)[0],ref_ids:_de.match(/\d+/)[0]};});}else{_dd=_a.map(_dc.match(/\[.+?\]]/g),function(_df){_df=_df.substr(1,_df.length-3);var _e0=_df.split("[");return {ref:_e0[0].split("/")[0],ref_ids:_e0[1]};});}}return _dd;};function _e1(){var _e2=_11.filter(function(_e3){return !_11.isBlacklisted(_e3)&&!_11.isReferenced(_e3)&&!_52(_e3);});_a.forEach(_e2,function(_e4){_11.removeObject(_e4);delete _13[_e4];window.mx.server.release(_e4);});};this.toString=function(){return _10;};this.startup=function(){window.mx.server.registerCaller(_b.hitch(this,"flush"));window.setInterval(_e1,10000);};this.subscribe=function(_e5,_e6){var id=_5.getUniqueId(),_e7=_e5.entity,_e8=_e5.guid,val=_e5.val,_e9=_e5.attr,_ea=_e6?function(){_e5.callback.apply(_e6,arguments);}:_e5.callback;if(_e9){if(!_14.attrs[_e8]){_14.attrs[_e8]={};}if(!_14.attrs[_e8][_e9]){_14.attrs[_e8][_e9]={};}_14.attrs[_e8][_e9][id]=_ea;}else{if(val){if(!_14.vals[_e8]){_14.vals[_e8]={};}_14.vals[_e8][id]=_ea;}else{if(_e8){if(!_14.guids[_e8]){_14.guids[_e8]={};}_14.guids[_e8][id]=_ea;}else{if(_e7){if(!_14.entities[_e7]){_14.entities[_e7]={};}_14.entities[_e7][id]=_ea;}else{_6.error(_10+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_e7,guid:_e8,val:val,attr:_e9,id:id};};this.unsubscribe=function(_eb){if(_eb==null){return;}var id=_eb.id,_ec=_eb.entity,_ed=_eb.guid,val=_eb.val,_ee=_eb.attr,_ef=_5.itemCount;if(_ee){var _f0=_14.attrs[_ed];if(!_f0){}else{if(!_f0[_ee]){}else{delete _f0[_ee][id];if(_ef(_f0[_ee])===0){delete _f0[_ee];}if(_ef(_f0)===0){delete _14.attrs[_ed];}}}}else{if(val){if(!_14.vals[_ed]){}else{delete _14.vals[_ed][id];if(_ef(_14.vals[_ed])===0){delete _14.vals[_ed];}}}else{if(_ed){var _f1=_14.guids[_ed];if(!_f1){}else{delete _f1[id];if(_ef(_f1)===0){delete _14.guids[_ed];}}}else{if(_ec){var _f2=_14.entities[_ec];if(!_f2){}else{delete _f2[id];if(_ef(_f2)===0){delete _14.entities[_ec];}}}}}}};this.update=function(_f3){var _f4=_f3.guid,_f5=_f3.entity,_f6=_f3.attr,val=_f3.val,_f7=_f3.value,_f8=_f3.callback;var _f9=function(_fa,_fb){var map=_fa?_b.clone(_fa):{};for(var key in map){map[key].apply(null,_fb);}};if(_f6){_f9(_14.attrs[_f4]&&_14.attrs[_f4][_f6],[_f4,_f6,_f7]);}else{if(_f4){_f9(_14.guids[_f4],[_f4]);}else{if(val){_f9(_14.vals[_f4],[_f4]);}else{if(_f5){_f9(_14.entities[_f5],[_f5]);}else{_6.error(_10+".update: no 'entity' or 'guid' parameter found");}}}}_f8&&_f8();};this.objectUpdateNotification=function(_fc){_f.sendClassUpdate(_fc.getEntity());_f.update({guid:_fc.getGuid()});};this.sendClassUpdate=function(_fd){var _fe=window.mx.meta.getEntity(_fd);if(!_fe){throw new _1("No permission to read or write entity "+_fd+", check security!");}_a.forEach([_fd].concat(_fe.getSuperEntities()),function(ent){_f.update({entity:ent});});};this.objectPing=function(_ff,_100){var guid=_ff.getGuid(),list=_b.clone(_14.guids[guid]),_101=[];if(list){for(var sub in list){_101.push((function(list,sub){return function(cb){try{var _102=list[sub];if(_102.length==2){_102(guid,cb);}else{_102(guid);cb();}}catch(e){if(list){delete list[sub];}cb();}};})(list,sub));}_5.collect(_101,_100);}else{_100&&_100();}};this.addValidation=function(guid,attr,_103){if(!_13[guid]){_13[guid]=new _3({msg:{guid:guid}});}_13[guid].addField(attr,_103);};this.sendValidationUpdates=function(_104){var list,_105=[];for(var i=0,_106;_106=_104[i];i++){list=_14.vals[_106.getGuid()];var cp=_106.clone(),_107=cp.getAttributes();if(list){for(var x in list){var _108=_106.clone();try{list[x]([_108]);}catch(e){_6.error(_10+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete list[x];}var _109=_108.getAttributes();_a.forEach(_107,function(attr){var name=attr.name,_10a=_a.some(_109,function(item){return item.name==name;});if(!_10a){cp.removeAttribute(attr.name);}},this);}}else{}if(cp.getAttributes().length){_105.push(cp);}}window.mx.ui.validations(_105);};this.action=function(_10b){_7e.action(_10b.params,_10b.context,_10b.store,!!_10b.async,_10b.onValidation,function(_10c,_10d){if(_10c instanceof Array){_a.forEach(_10c,function(_10e){delete _13[_10e.getGuid()];});}if(_10b.callback){_10b.callback(_10c,_10d);}},function(e){_50(_10b.error,null,e,"action");});};this.setOrRetrieveMxObject=function(json){delete _13[json.guid];return _29(false,true,false,json);};this.get=function(_10f,_110){var _111=_10f.xpath,path=_10f.path,id=_10f.guid,ids=(!("guids" in _10f)&&id)?[id]:_10f.guids,_112=_10f.callback,_113=_10f.error,_114=!!_10f.noCache,_115=!!_10f.count,_116=_10f.filter,_117=!!_10f.aggregates,_118=_10f.context,_119=_10f.microflow,err;if(("guid" in _10f)&&id==null){_82(_112,_110,[null],"");return;}if(!_111&&!ids&&!_119){err=_10+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _1(err);}if(path&&ids.length!=1){throw new _1(_10+".get : path can only be used with a single guid");}if(typeof _112!="function"){err=_10+".get: callback is not a function";_6.error(err);throw new _1(err);}else{if(_113&&typeof _113!="function"){err=_10+".get: error is not a function";_6.error(err);throw new _1(err);}}if(_116){if(_116.limit){_116.amount=_116.limit;delete _116.limit;}if(_116.references){for(var r in _116.references){var ref=_116.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_11a=_7f({},_116,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_11b=function(e){_50(_113,_110,e,"get");};if(_11a.id&&ids&&!id){delete _11a.id;}if(_11a.id){delete _11a.attributes;delete _11a.distinct;}if(_119){var _11c=ids?"selection":(_111?"set":"none"),_11d={actionname:_119,applyto:_11c};if(_11c=="selection"){_11d.guids=ids;}else{if(_11c=="set"){_11d.xpath=_111;if(_11a.sort){_11d.sort=_11a.sort;}}}this.action({params:_11d,context:_118,callback:function(_11e,_11f){_112&&_112.call(_110,_11e,_11f);},error:_11b});}else{if(path&&ids){_7e.retrieveByPath(ids[0],path,function(_120,_121){try{if(_112){_112.call(_110,_120,{count:_121});}}catch(e){_6.error(_10+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_110?"("+_110+")":""));}},function(e){_50(_113,_110,e,"get");});}else{if(ids){if(ids.length===0){_82(_112,_110,[id?null:[],{count:0}],".get: error in handler");return;}_7e.getByGuid(ids,_11a,!_114,function(_122,_123){var _124;if(id){if(_11a.id){_124=_a.filter(_122,function(_125){return _125.getGuid()===id;})[0];if(_124===undefined){_50(_113,_110,new _1("Returned objects do not contain requested one"),"get");return;}}else{_124=_122[0]||null;}}else{_124=_122;}try{if(_112){_112.call(_110,_124,{count:_123});}}catch(e){_6.error(_10+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_110?"("+_110+")":""));}},function(e){_50(_113,_110,e,"get");});return true;}else{window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_111,schema:_11a,count:_115,aggregates:_117}},options:{callback:_92(function(objs,_126){_82(_112,_110,[objs,_126],".get: error in error handler for xpath "+_111);},false),error:_11b}});return true;}}}};this.getBySchema=function(_127,_128){var guid=_127.id,_129=_127.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_127},options:{callback:function(code,json){var _12a=[],_12b;_a.forEach(json.mxobjects,function(_12c){var _12d=new _4({json:_12c,meta:window.mx.meta.getEntity(_12c.objectType)});if(_12c.guid==guid){_12b=_12d;}_12a.push(_12d);});_12b.attachReferences(_12a);_129&&_129(_12b,false);},error:function(e){_50(_127.error,_128,e,"getBySchema");}}});};this.fetch=function(obj,path,_12e,_12f,_130){var _131=obj,_132=false,_133,_134,attr;if(_b.isFunction(_12e)){_130=_12f;_12f=_12e;}if(!path){_133=[];}else{if(path instanceof Array){_133=path.slice();}else{_133=path.split("/");}}if(obj&&obj.isA(_133[0])){_133.shift();}if(_133.length%2==1){attr=_133.pop();}else{attr="";}_7e.fetch(obj,_133,attr,_12e,_12f,_130);};this.release=function(objs){if(!objs){return;}objs=objs instanceof Array?objs:[objs];for(var i=0,len=objs.length;i<len;++i){if(objs[i]){_7e.release(objs[i].getGuid());}}};this.create=function(_135,_136){var _137=_135.error,_138=_135.context,_139=_135.entity,_13a=_135.persistent,err;if(typeof _135.callback!="function"){err=_10+".create: callback is not a function";_6.error(err);throw new _1(err);}else{if(_137&&typeof _137!="function"){err=_10+".create: error is not a function";_6.error(err);throw new _1(err);}else{if(typeof _139!="string"){err=_10+".create: entity is not a string";_6.error(err);throw new _1(err);}}}var _13b=function(objs){var obj=objs&&objs[0];if(_138){_f.setObjectToContext(obj,_138);}_135.callback.call(_136,obj);};var _13c=function(e){_50(_137,_136,e,"create");};window.mx.server.request({request:{action:_13a?"create":"instantiate",params:{objecttype:_135.entity,preventCache:(new Date()).getTime()}},options:{callback:_92(_13b,true,true),error:_13c}});};this.jsonToMxObject=function(json){return new _4({json:json,meta:window.mx.meta.getEntity(json.objectType)});};this.remove=function(_13d){var _13e=_13d.error,_13f=_13d.callback,_140=("guid" in _13d)?[_13d.guid]:_13d.guids;if(("guids" in _13d)&&!(_13d.guids instanceof Array)){throw new _1(_10+".remove: parameter guids set but not of type Array");}else{if(_13e&&typeof _13e!="function"){throw new _1(_10+".remove: parameter error set but not of type Function");}else{if(_13f&&typeof _13f!="function"){throw new _1(_10+".remove: parameter callback set but not of type Function");}}}window.mx.server.request({request:{action:"delete",params:{guids:_140}},options:{callback:function(){_a.forEach(_140,_53);_5.nullExec(_13f);},error:function(e){_50(_13e,null,e,"remove");}}});};this.save=function(_141,_142){var _143,_144,_145,_146,guid,msg,emsg=".save: error calling handler",e,_147,_148,_149,_14a,obj;if(_141){_145=_141.mxobj;_143=_141.callback;_144=_141.error;_146=_141.standalone;}if(typeof _143!="function"){e=_10+".save: callback is not a function";_6.error(e);throw new _1(e);}else{if(_145!=null&&!(_145 instanceof _4)){e=_10+".save: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(_145){guid=_145.getGuid();emsg=".save: error calling handler for ["+guid+"]";msg=_13[guid];if(msg){var data=null;if(msg instanceof _1){data=msg;}else{if(msg){data=new _2();this.sendValidationUpdates([msg.clone()]);}}_50(_144,_142,data,"save");return;}else{if(!_145.hasChanges()){_82(_143,_142,null,emsg);return;}}}_148={};if(!_146){_147=_12;_12={};_149=0;_14a=0;for(var id in _147){_14a++;obj=_147[id];if(obj.hasChanges()){_149++;_148[id]=obj._collectChanges();}delete _13[id];}if(!_149){if(_14a){}_82(_143,_142,null,emsg);return;}}if(_145&&!_147[guid]){_148[guid]=_145._collectChanges();_147={guid:_145};delete _12[guid];delete _13[guid];}window.mx.server.request({request:{action:"change",params:_148},options:{onValidation:_141.onValidation,sync:true,unique:true,callback:function(){for(var guid in _147){_147[guid]._applyChangeSet();}_147=null;_82(_143,_142,null,emsg);},error:function(e){data=e.original||{};var _14b=false,_14c=guid;if(ov.hasValidations(data)){_a.forEach(ov.getValidations(data),function(v){var id=v.getGuid();if(_147[id]){_13[id]=v;delete _147[id];}if(_145&&id==_14c){_14b=true;}});for(var id in _147){_147[id]._applyChangeSet();}}else{_b.mixin(_12,_147);_14b=true;}_147=null;if(_145){if(_14b){_50(_144,null,e,"save");}else{_82(_143,_142,null,emsg);}}else{_82(_143,_142,null,emsg);}}}});};this.commit=function(_14d,_14e){var obj,_14f,_150,_151,_152,guid,e,msg;if(_14d){obj=_14d.mxobj;_14f=_14d.callback;_150=_14d.error;_151=_14d.onValidation;_152=_14d.context;}if(typeof _14f!="function"){e=_10+".commit: callback is not a function";_6.error(e);throw new _1(e);}else{if(obj!=null&&!(obj instanceof _4)){e=_10+".commit: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(obj==null){_82(_14f,_14e,null,".commit: error when executing handler");}else{guid=obj.getGuid();msg=".commit: error when executing handler for ["+guid+"]";window.mx.server.request({request:{action:"commit",params:{guid:guid},context:_152},options:{callback:function(){delete _13[guid];delete _12[guid];_f.objectUpdateNotification(obj);_82(_14f,_14e,null,msg);},error:function(e){_50(_150,null,e,"commit");},onValidation:_151,store:_14d.store}});}};this.rollback=function(_153,_154){var _155,obj,_156;if(_153){_155=_153.callback;obj=_153.mxobj;_156=_153.error;}var emsg=".rollback: error in handler ",e;if(typeof _155!="function"){e=_10+".rollback: callback is not a function";_6.error(e);throw new _1(e);}else{if(obj!=null&&!(obj instanceof _4)){e=_10+".rollback: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(!obj){_82(_155,_154,null,emsg);}else{var guid=obj.getGuid(),claz=obj.getEntity();emsg=_10+".rollback: error in handler for ["+guid+"]";delete _13[guid];delete _12[guid];window.mx.server.request({request:{action:"rollback",params:{guid:guid}},options:{unique:true,standalone:true,callback:_92(function(objs){obj.reset();_9b(obj,objs[0]);_f.sendClassUpdate(claz);_82(_155,_154,null,emsg);},false),error:function(e){_50(_156,null,e,"rollback");}}});}return true;};this.mxObjectsCallback=function(_157){return _92(_157,false);};this.matchObjectsToContext=function(_158){var _159=_158.entity,_15a=_158.context,_15b=_158.mxobjs,_15c=_158.callback,_15d=[];_b9(window.mx.meta.getEntity(_159),_15a,function(_15e){var _15f=_db(_15e);for(var i=0,obj;obj=_15b[i];i++){var _160=0;for(var x=0,_161;_161=_15f[x];x++){var ref=_161.ref,_162=_161.ref_ids,ids=obj.getReferences(ref),_163=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_162.match(ids[j])){_163=true;break;}}}_163&&_160++;}if(_160==_15f.length){_15d.push(obj);}}_15c(_15d);});};this.createXPathString=function(_164){var _165=_164.callback,_166=_164.entity||_164.className,_167=_164.context;var _168=_167&&_167.getContexts();if(!_168||_168.length===0){_165("//"+_166);return;}_cc(_164);};this.generateExport=function(_169){window.mx.server.request({request:{action:"export",params:_169.params},options:{callback:_169.callback,error:function(e){_50(_169.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_16a,_16b){if(typeof _16a!="object"){throw new _1(_10+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _16b!="object"){throw new _1(_10+".setObjectToContext: parameter context is not of type Object");}}try{var _16c=_16a.getAttributes();for(var e=0;e<_16c.length;e++){if(_16a.isReference(_16c[e])){var _16d=_16a.getSelectorEntity(_16c[e]);if((_16c[e]=="System.owner")||(_16c[e]=="System.changedBy")){continue;}if(_16b.hasContext(_16d)){_16a.addReference(_16c[e],_16b.getContext(_16d));}var meta=window.mx.meta.getEntity(_16d);if(meta){if(meta.hasSubEntities()){var _16e=meta.getSubEntities();for(var i=0;i<_16e.length;i++){if(_16b.hasContext(_16e[i])){_16a.addReference(_16c[e],_16b.getContext(_16e[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_16f){_16f.type="sum";_d6(_16f);};this.countOfXPathSet=function(_170){_170.type="count";_d6(_170);};this.sizeOfXPathSet=function(_171){_171.type="count";_d6(_171);};this.avgOfXPathSet=function(_172){_172.type="avg";_d6(_172);};this.maxOfXPathSet=function(_173){_173.type="max";_d6(_173);};this.minOfXPathSet=function(_174){_174.type="min";_d6(_174);};this.makeChange=function(_175,attr,_176){var guid=_175.getGuid();_12[guid]=_175;delete _13[guid];var _177=_11.getObject(guid);if(_177&&_175!=_177){_177._makeChange(attr,_176);}else{this.update({guid:guid,attr:attr,value:_175.get(attr)});}};this.flush=function(_178){if(_5.itemCount(_12)===0){_178&&_178();}else{this.save({mxobj:null,callback:_178});}};};return _d;});