/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Data",["mendix/lib/ConnectionError","mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/MxObject","mendix/lang","mendix/logger","webcore/data-backend/OnlineDataBackend","webcore/data-backend/OfflineDataBackend","webcore/MxObjectCache","webcore/MxObjectBackend","dojo/_base/array","dojo/_base/lang","bluebird/bluebird"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){function _e(_f){_f=_f||{};var _10=this,_11="mendix.sys.Data",_12={entities:{},guids:{},attrs:{},vals:{}};var _13=new _7();var _14=new _a(_13,new _9(),function(_15){return !_16(_15);});var _17=function(_18,_19,map){if(!_19){return _18;}for(var i in map){if((i in _19)&&(_19[i]!=null)){_18[i]=_19[i];}}return _18;};var _1a=function(_1b,_1c,_1d,_1e){try{_1b&&_1b.apply(_1c,_1d||[]);}catch(e){_6.error(_11+_1e+" : "+e.message+" "+(_1c?"("+_1c+")":""));}};var _1f=function(_20,_21,e,_22){try{if(_20){_20.call(_21,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_11+"."+_22+" while calling error handler: "+err.message);}};var _16=function(_23){var _24=_5.itemCount;return (_24(_12.guids[_23])||_24(_12.attrs[_23]));};var _25=function(_26,_27){var _28={};_b.forEach(_26.getAttributes(),function(ref){if(!_26.isReference(ref)){return;}var _29=_27.getContext(_26.getSelectorEntity(ref));if(_29){_28[ref]=_29;}});return _28;};var _2a=function(_2b,_2c,_2d,_2e){var _2f=_2c.split("/");var _30=function(_31){var _32=_2f.shift(),ref=_2f.shift(),_33;if(_31==null||_31.length==null||_31.length===0){_2d(null);return;}var _34=[];for(var i=0;i<_31.length;i++){if(_31[i]==null){continue;}_34.push("id='"+_31[i].getGuid()+"'");}if(!_34.length){_2d(null);return;}var ids=_34.join(" or ");_33="["+ref+"/"+_32+"["+ids+"]]";if(_2f.length==1){_2d(_33);}else{var _35=_2f[0];_32=_2f.shift();ref=_2f.shift();_2d("["+ref+"/"+_32+""+_33+"]");}};var _36=function(){var _37=_2f.shift(),ref=_2f.shift();if(_2f.length==1){var _38="["+ref+"='"+_2b.getGuid()+"']";_2d(_38);return;}if(window.mx.meta.getEntity(_37)==null){_1f(_2e,null,new _2(_11+".runMapPath: entity"+_37+" does not exist"),"runMapPath");return;}if(!_2b.isA(_37)){_1f(_2e,null,new _2(_11+".runMapPath: entity "+_2b.getEntity()+" is not a "+_37+" or one of its subclasses"),"runMapPath");return;}if(!_2b.has(ref)){_1f(_2e,null,new _2(_11+".runMapPath: reference "+ref+" not found in entity "+_37),"runMapPath");return;}if(_2b.get2(ref)!==""){_10.get({guids:_2b.getReferences(ref),callback:_30,error:_2e});}else{_2d(null);}};_36();};this.getBacktrackConstraints=function(_39,_3a,_3b,_3c,_3d){if(!_c.isFunction(_3c)){_3d=_3c;_3c=null;}_10.getBacktrack(_3a.getTrackId(),_3a.getConstraints(),_3b,_3c,_3d);};var _3e=this.getBacktrackConstraints;this.getBacktrack=function(_3f,_40,_41,_42,_43){if(!_c.isFunction(_42)){_43=_42;_42=null;}if(!_40||_40.length===0){_41.call(_43,"",true);return;}var _44=null,_45=[],_46=0,_47=true;var _48=function(){var _49=_40[_46++];if(_49){_2a(_44,_49,function(_4a){if(_4a){_45.push(_4a);}else{_47=false;}_48();},function(e){_1f(_42,_43,e,"getBacktrack");});}else{_41.call(_43,_45.join(""),_47);}};if(!_3f){_41.call(_43,"",false);}else{_10.get({guid:_3f,callback:function(obj){_44=obj;_48();},error:function(e){_1f(_42,_43,e,"getBacktrack");}});}};var _4b=function(_4c,_4d){var _4e=[],_4f=_25(_4c,_4d);for(var m in _4f){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_4c.has(m)){var _50=_4c.getAttributeType(m);switch(_50){case "ObjectReference":_4e.push("["+m+"='"+_4f[m]+"']");break;case "ObjectReferenceSet":_4e.push("["+m+"='"+_4f[m]+"']");break;default:}}}return _4e.join("");};var _51=function(_52){var _53=_52.entity||_52.className,_54=window.mx.meta.getEntity(_53),_55=_52.context,_56="//"+_53,_57=_4b(_54,_55);var _58=function(_59,_5a){if(_52.callback){_52.callback(_56+_57+_59,_5a);}};if(_55.getConstraints().length!==0){_3e(_54,_55,_58,_52.error);}else{_58("",true);}};var _5b=function(_5c){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_5c.type+"("+_5c.xpath+")",resulttype:_5c.resulttype||"integer"}},options:{callback:function(_5d,_5e){var _5f;if(_5e){if(_5c.resulttype=="float"){_5f=parseFloat(_5e.value).toFixed(2)||"0.00";}else{_5f=_5e.value||0;}}else{_5f=0;}_5c.callback&&_5c.callback(_5f);},error:function(e){_1f(_5c.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _60=function(_61){var _62;if(_61===""){return;}else{if(_61.match(/^\[[^=\[]+=.[0-9]+./)){_62=_b.map(_61.match(/\[.+?\]/g),function(_63){_63=_63.substr(1,_63.length-2);return {ref:_63.match(/[^=]+/)[0],ref_ids:_63.match(/\d+/)[0]};});}else{_62=_b.map(_61.match(/\[.+?\]]/g),function(_64){_64=_64.substr(1,_64.length-3);var _65=_64.split("[");return {ref:_65[0].split("/")[0],ref_ids:_65[1]};});}}return _62;};this.toString=function(){return _11;};this.setOfflineStore=function(_66){_14=new _a(new _8(_66),new _9(),function(_67){return !_16(_67);});};this.startup=function(){window.mx.server.registerCaller(_c.hitch(_14,"flush"));window.setInterval(_c.hitch(_14,"cleanup"),10000);};this.subscribe=function(_68,_69){var id=_5.getUniqueId(),_6a=_68.entity,_6b=_68.guid,val=_68.val,_6c=_68.attr,_6d=_69?function(){_68.callback.apply(_69,arguments);}:_68.callback;if(_6c){if(!_12.attrs[_6b]){_12.attrs[_6b]={};}if(!_12.attrs[_6b][_6c]){_12.attrs[_6b][_6c]={};}_12.attrs[_6b][_6c][id]=_6d;}else{if(val){if(!_12.vals[_6b]){_12.vals[_6b]={};}_12.vals[_6b][id]=_6d;}else{if(_6b){if(!_12.guids[_6b]){_12.guids[_6b]={};}_12.guids[_6b][id]=_6d;}else{if(_6a){if(!_12.entities[_6a]){_12.entities[_6a]={};}_12.entities[_6a][id]=_6d;}else{_6.error(_11+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_6a,guid:_6b,val:val,attr:_6c,id:id};};this.unsubscribe=function(_6e){if(_6e==null){return;}var id=_6e.id,_6f=_6e.entity,_70=_6e.guid,val=_6e.val,_71=_6e.attr,_72=_5.itemCount;if(_71){var _73=_12.attrs[_70];if(!_73){}else{if(!_73[_71]){}else{delete _73[_71][id];if(_72(_73[_71])===0){delete _73[_71];}if(_72(_73)===0){delete _12.attrs[_70];}}}}else{if(val){if(!_12.vals[_70]){}else{delete _12.vals[_70][id];if(_72(_12.vals[_70])===0){delete _12.vals[_70];}}}else{if(_70){var _74=_12.guids[_70];if(!_74){}else{delete _74[id];if(_72(_74)===0){delete _12.guids[_70];}}}else{if(_6f){var _75=_12.entities[_6f];if(!_75){}else{delete _75[id];if(_72(_75)===0){delete _12.entities[_6f];}}}}}}};this.update=function(_76){var _77=_76.guid,_78=_76.entity,_79=_76.attr,val=_76.val,_7a=_76.value,_7b=_76.callback;var _7c=function(_7d,_7e){var map=_7d?_c.clone(_7d):{};for(var key in map){map[key].apply(null,_7e);}};if(_79){_7c(_12.attrs[_77]&&_12.attrs[_77][_79],[_77,_79,_7a]);}else{if(_77){_7c(_12.guids[_77],[_77]);}else{if(val){_7c(_12.vals[_77],[_77]);}else{if(_78){_7c(_12.entities[_78],[_78]);}else{_6.error(_11+".update: no 'entity' or 'guid' parameter found");}}}}_7b&&_7b();};this.objectUpdateNotification=function(_7f){_10.sendClassUpdate(_7f.getEntity());_10.update({guid:_7f.getGuid()});};this.sendClassUpdate=function(_80){var _81=window.mx.meta.getEntity(_80);if(!_81){throw new _2("No permission to read or write entity "+_80+", check security!");}_b.forEach([_80].concat(_81.getSuperEntities()),function(ent){_10.update({entity:ent});});};this.objectPing=function(_82,_83){var _84=_82.getGuid(),_85=_c.clone(_12.guids[_84]),_86=[];if(_85){for(var sub in _85){_86.push((function(_87,sub){return function(cb){try{var _88=_87[sub];if(_88.length==2){_88(_84,cb);}else{_88(_84);cb();}}catch(e){if(_87){delete _87[sub];}cb();}};})(_85,sub));}_5.collect(_86,_83);}else{_83&&_83();}};this.sendValidationUpdates=function(_89){var _8a,_8b=[];for(var i=0,_8c;_8c=_89[i];i++){_8a=_12.vals[_8c.getGuid()];var cp=_8c.clone(),_8d=cp.getAttributes();if(_8a){for(var x in _8a){var _8e=_8c.clone();try{_8a[x]([_8e]);}catch(e){_6.error(_11+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _8a[x];}var _8f=_8e.getAttributes();_b.forEach(_8d,function(_90){var _91=_90.name,_92=_b.some(_8f,function(_93){return _93.name==_91;});if(!_92){cp.removeAttribute(_90.name);}},this);}}else{}if(cp.getAttributes().length){_8b.push(cp);}}window.mx.ui.validations(_8b);};this.action=function(_94){_14.action(_94.params,_94.context,_94.store,!!_94.async,_94.onValidation,function(_95,_96){if(_94.callback){_94.callback(_95,_96);}},function(e){_1f(_94.error,null,e,"action");});};this.setOrRetrieveMxObject=function(_97){return _14.setOrRetrieveMxObject(_97);};this.get=function(_98,_99){var _9a=_98.xpath,_9b=_98.path,id=_98.guid,ids=(!("guids" in _98)&&id)?[id]:_98.guids,_9c=_98.callback,_9d=_98.error,_9e=!!_98.noCache,_9f=!!_98.count,_a0=_98.filter,_a1=!!_98.aggregates,_a2=_98.context,_a3=_98.microflow,err;if(("guid" in _98)&&id==null){_1a(_9c,_99,[null],"");return;}if(!_9a&&!ids&&!_a3){err=_11+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _2(err);}if(_9b&&ids.length!=1){throw new _2(_11+".get : path can only be used with a single guid");}if(typeof _9c!="function"){err=_11+".get: callback is not a function";_6.error(err);throw new _2(err);}else{if(_9d&&typeof _9d!="function"){err=_11+".get: error is not a function";_6.error(err);throw new _2(err);}}if(_a0){if(_a0.limit){_a0.amount=_a0.limit;delete _a0.limit;}if(_a0.references){for(var r in _a0.references){var ref=_a0.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_a4=_17({},_a0,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_a5=function(e){_1f(_9d,_99,e,"get");};if(_a4.id&&ids&&!id){delete _a4.id;}if(_a4.id){delete _a4.attributes;delete _a4.distinct;}if(_a3){var _a6=ids?"selection":(_9a?"set":"none"),_a7={actionname:_a3,applyto:_a6};if(_a6=="selection"){_a7.guids=ids;}else{if(_a6=="set"){_a7.xpath=_9a;if(_a4.sort){_a7.sort=_a4.sort;}}}this.action({params:_a7,context:_a2,callback:function(_a8,_a9){_9c&&_9c.call(_99,_a8,_a9);},error:_a5});}else{if(_9b&&ids){_14.getByPath(ids[0],_9b,function(_aa,_ab){try{if(_9c){_9c.call(_99,_aa,{count:_ab});}}catch(e){_6.error(_11+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_99?"("+_99+")":""));}},function(e){_1f(_9d,_99,e,"get");});}else{if(ids){if(ids.length===0){_1a(_9c,_99,[id?null:[],{count:0}],".get: error in handler");return;}_14.getByGuid(ids,_a4,!_9e,function(_ac,_ad){var _ae;if(id){if(_a4.id){_ae=_b.filter(_ac,function(_af){return _af.getGuid()===id;})[0];if(_ae===undefined){_1f(_9d,_99,new _2("Returned objects do not contain requested one"),"get");return;}}else{_ae=_ac[0]||null;}}else{_ae=_ac;}try{if(_9c){_9c.call(_99,_ae,{count:_ad});}}catch(e){_6.error(_11+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_99?"("+_99+")":""));}},function(e){_1f(_9d,_99,e,"get");});return true;}else{_14.getByXPath(_9a,_a4,_9f,_a1,function(_b0,_b1,_b2){_1a(_9c,_99,[_b0,{count:_b1,aggregates:_b2}],".get: error in error handler for xpath "+_9a);},_a5);return true;}}}};this.getBySchema=function(_b3,_b4){var _b5=_b3.id,_b6=_b3.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_b3},options:{callback:function(_b7,_b8){var _b9=[],_ba;_b.forEach(_b8.mxobjects,function(_bb){var _bc=new _4({json:_bb,meta:window.mx.meta.getEntity(_bb.objectType)});if(_bb.guid==_b5){_ba=_bc;}_b9.push(_bc);});_ba.attachReferences(_b9);_b6&&_b6(_ba,false);},error:function(e){_1f(_b3.error,_b4,e,"getBySchema");}}});};this.getSlice=function(_bd,_be,_bf,_c0,_c1){_14.getSlice(_bd,_be,_bf).spread(function(_c2,_c3){if(_c0){_c0(_c2,_c3);}}).caught(function(e){if(_c1){_c1(e);}else{mx.onError(e);}});};this.fetch=function(obj,_c4,_c5,_c6,_c7){if(_c.isFunction(_c5)){_c7=_c6;_c6=_c5;}var _c8;if(!_c4){_c8=[];}else{if(_c4 instanceof Array){_c8=_c4.slice();}else{_c8=_c4.split("/");}}if(obj&&obj.isA(_c8[0])){_c8.shift();}var _c9;if(_c8.length%2==1){_c9=_c8.pop();}else{_c9="";}_14.fetch(obj,_c8,_c9,_c5,_c6,_ca);function _ca(e){_1f(_c7,null,e,"fetch");};};this.release=function(_cb){if(!_cb){return;}_cb=_cb instanceof Array?_cb:[_cb];for(var i=0,len=_cb.length;i<len;++i){if(_cb[i]){_14.release(_cb[i].getGuid());}}};this.create=function(_cc,_cd){if(typeof _cc.callback!="function"){throw new _2(_11+".create: callback is not a function");}else{if(_cc.error&&typeof _cc.error!="function"){throw new _2(_11+".create: error is not a function");}else{if(typeof _cc.entity!="string"){throw new _2(_11+".create: entity is not a string");}}}_14.create(_cc.entity,_cc.persistent,function(obj){if(_cc.context){_10.setObjectToContext(obj,_cc.context);}_cc.callback.call(_cd,obj);},function(e){_1f(_cc.error,_cd,e,"create");});};this.jsonToMxObject=function(_ce){return new _4({json:_ce,meta:window.mx.meta.getEntity(_ce.objectType)});};this.remove=function(_cf){var _d0=("guid" in _cf)?[_cf.guid]:_cf.guids;if(("guids" in _cf)&&!(_cf.guids instanceof Array)){throw new _2(_11+".remove: parameter guids set but not of type Array");}else{if(_cf.error&&typeof _cf.error!="function"){throw new _2(_11+".remove: parameter error set but not of type Function");}else{if(_cf.callback&&typeof _cf.callback!="function"){throw new _2(_11+".remove: parameter callback set but not of type Function");}}}_14.remove(_d0,_cf.callback,_d1);function _d1(e){_1f(_cf.error,null,e,"remove");};};this.save=function(_d2,_d3){if(typeof _d2.callback!="function"){throw new _2(_11+".save: callback is not a function");}else{if(_d2.mxobj!=null&&!(_d2.mxobj instanceof _4)){throw new _2(_11+".save: mxobj is not an MxObject");}}_14.save(_d2.mxobj,_d2.standalone,_d2.onValidation,_d4,_d5);function _d4(){var msg=".save: error calling handler";if(_d2.mxobj){msg+=" for ["+_d2.mxobj.getGuid()+"]";}_1a(_d2.callback,_d3,null,msg);};function _d5(_d6){var err;if(_d6 instanceof Error){err=_d6;}else{if(_d6){err=new _3();_10.sendValidationUpdates([_d6.clone()]);}}_1f(_d2.error,_d3,err,"save");};};this.commit=function(_d7,_d8){if(typeof _d7!="object"){throw new _2(_11+".commit: args is not an object");}else{if(typeof _d7.callback!="function"){throw new _2(_11+".commit: callback is not a function");}else{if(_d7.mxobj!=null&&!(_d7.mxobj instanceof _4)){throw new _2(_11+".commit: mxobj is not a MxObject");}}}if(!_d7.mxobj&&_d7.callback){_1a(_d7.callback,_d8,null,".commit: error when executing handler without object");return;}_14.commit(_d7.mxobj.getGuid(),_d7.context,_d7.store,_d7.onValidation,_d9,_da);function _d9(){_10.objectUpdateNotification(_d7.mxobj);_1a(_d7.callback,_d8,null,".commit: error when executing handler for ["+_d7.mxobj.getGuid()+"]");};function _da(e){_1f(_d7.error,null,e,"commit");};};this.rollback=function(_db,_dc){if(typeof _db!="object"){throw new _2(_11+".rollback: args is not an object");}else{if(typeof _db.callback!="function"){throw new _2(_11+".rollback: callback is not a function");}else{if(_db.mxobj!=null&&!(_db.mxobj instanceof _4)){throw new _2(_11+".rollback: mxobj is not a MxObject");}}}if(!_db.mxobj){_1a(_db.callback,_dc,null,".rollback: error in handler");return;}var _dd=_db.mxobj;var _de=_dd.getEntity();var _df=_dd.getGuid();_14.rollback(_dd,_e0,_e1);function _e0(_e2){if(_e2){_dd.resetFromJSON(_e2.jsonData);_10.objectUpdateNotification(_e2);}_dd.reset();_10.sendClassUpdate(_de);_1a(_db.callback,_dc,null,_11+".rollback: error in handler for ["+_df+"]");};function _e1(e){_1f(_db.error,null,e,"rollback");};};this.synchronize=function(_e3,_e4){return _14.upload(_13).caught(function(e){if(!(e instanceof _1)){return _14.cleanupDirtyObjects().then(function(){return null;});}else{throw e;}}).then(function(_e5){return _14.download().then(function(_e6){if(_e3){_e3(_e5,_e6);}});}).caught(function(e){if(_e4){_e4(e);}});};this.invalidateCaches=function(_e7){_14.invalidateCaches(_e7);};this.matchObjectsToContext=function(_e8){var _e9=_e8.entity,_ea=_e8.context,_eb=_e8.mxobjs,_ec=_e8.callback,_ed=[];_3e(window.mx.meta.getEntity(_e9),_ea,function(_ee){var _ef=_60(_ee);for(var i=0,obj;obj=_eb[i];i++){var _f0=0;for(var x=0,_f1;_f1=_ef[x];x++){var ref=_f1.ref,_f2=_f1.ref_ids,ids=obj.getReferences(ref),_f3=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_f2.match(ids[j])){_f3=true;break;}}}_f3&&_f0++;}if(_f0==_ef.length){_ed.push(obj);}}_ec(_ed);});};this.createXPathString=function(_f4){var _f5=_f4.callback,_f6=_f4.entity||_f4.className,_f7=_f4.context;var _f8=_f7&&_f7.getContexts();if(!_f8||_f8.length===0){_f5("//"+_f6);return;}_51(_f4);};this.generateExport=function(_f9){window.mx.server.request({request:{action:"export",params:_f9.params},options:{callback:_f9.callback,error:function(e){_1f(_f9.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_fa,_fb){if(typeof _fa!="object"){throw new _2(_11+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _fb!="object"){throw new _2(_11+".setObjectToContext: parameter context is not of type Object");}}try{var _fc=_fa.getAttributes();for(var e=0;e<_fc.length;e++){if(_fa.isReference(_fc[e])){var _fd=_fa.getSelectorEntity(_fc[e]);if((_fc[e]=="System.owner")||(_fc[e]=="System.changedBy")){continue;}if(_fb.hasContext(_fd)){_fa.addReference(_fc[e],_fb.getContext(_fd));}var _fe=window.mx.meta.getEntity(_fd);if(_fe){if(_fe.hasSubEntities()){var _ff=_fe.getSubEntities();for(var i=0;i<_ff.length;i++){if(_fb.hasContext(_ff[i])){_fa.addReference(_fc[e],_fb.getContext(_ff[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_100){_100.type="sum";_5b(_100);};this.countOfXPathSet=function(_101){_101.type="count";_5b(_101);};this.sizeOfXPathSet=function(_102){_102.type="count";_5b(_102);};this.avgOfXPathSet=function(_103){_103.type="avg";_5b(_103);};this.maxOfXPathSet=function(_104){_104.type="max";_5b(_104);};this.minOfXPathSet=function(_105){_105.type="min";_5b(_105);};this.makeChange=function(_106,attr,_107){_14.makeChange(_106,attr,_107);this.update({guid:_106.getGuid(),attr:attr,value:_107});};this.flush=function(_108){_14.flush(_108);};};return _e;});