/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Data",["mendix/lib/ConnectionError","mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/MxObject","mendix/lang","mendix/logger","webcore/data-backend/OnlineDataBackend","webcore/data-backend/OfflineDataBackend","webcore/MxObjectCache","webcore/MxObjectBackend","webcore/DanglingError","webcore/Task","webcore/applicative","dojo/_base/array","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){function _10(_11){_11=_11||{};var _12=this,_13="mendix.sys.Data",_14={entities:{},guids:{},attrs:{},vals:{}};var _15=new _7();var _16=new _a(_15,new _9(),function(_17){return !_18(_17);});var _19=_15;var _1a=function(_1b,_1c,map){if(!_1c){return _1b;}for(var i in map){if((i in _1c)&&(_1c[i]!=null)){_1b[i]=_1c[i];}}return _1b;};var _1d=function(_1e,_1f,_20,_21){try{_1e&&_1e.apply(_1f,_20||[]);}catch(e){_6.error(_13+_21+" : "+e.message+" "+(_1f?"("+_1f+")":""));}};var _22=function(_23,_24,e,_25){try{if(_23){_23.call(_24,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_13+"."+_25+" while calling error handler: "+err.message);}};var _18=function(_26){var _27=_5.itemCount;return (_27(_14.guids[_26])||_27(_14.attrs[_26]));};var _28=function(_29,_2a){var _2b={};_e.forEach(_29.getAttributes(),function(ref){if(!_29.isReference(ref)){return;}var _2c=_2a.getContext(_29.getSelectorEntity(ref));if(_2c){_2b[ref]=_2c;}});return _2b;};var _2d=function(_2e,_2f,_30,_31){var _32=_2f.split("/");var _33=function(_34){var _35=_32.shift(),ref=_32.shift(),_36;if(_34==null||_34.length==null||_34.length===0){_30(null);return;}var _37=[];for(var i=0;i<_34.length;i++){if(_34[i]==null){continue;}_37.push("id='"+_34[i].getGuid()+"'");}if(!_37.length){_30(null);return;}var ids=_37.join(" or ");_36="["+ref+"/"+_35+"["+ids+"]]";if(_32.length==1){_30(_36);}else{var _38=_32[0];_35=_32.shift();ref=_32.shift();_30("["+ref+"/"+_35+""+_36+"]");}};var _39=function(){var _3a=_32.shift(),ref=_32.shift();if(_32.length==1){var _3b="["+ref+"='"+_2e.getGuid()+"']";_30(_3b);return;}if(window.mx.meta.getEntity(_3a)==null){_22(_31,null,new _2(_13+".runMapPath: entity"+_3a+" does not exist"),"runMapPath");return;}if(!_2e.isA(_3a)){_22(_31,null,new _2(_13+".runMapPath: entity "+_2e.getEntity()+" is not a "+_3a+" or one of its subclasses"),"runMapPath");return;}if(!_2e.has(ref)){_22(_31,null,new _2(_13+".runMapPath: reference "+ref+" not found in entity "+_3a),"runMapPath");return;}if(_2e.get2(ref)!==""){_12.get({guids:_2e.getReferences(ref),callback:_33,error:_31});}else{_30(null);}};_39();};this.getBacktrackConstraints=function(_3c,_3d,_3e,_3f,_40){if(!_f.isFunction(_3f)){_40=_3f;_3f=null;}_12.getBacktrack(_3d.getTrackId(),_3d.getConstraints(),_3e,_3f,_40);};var _41=this.getBacktrackConstraints;this.getBacktrack=function(_42,_43,_44,_45,_46){if(!_f.isFunction(_45)){_46=_45;_45=null;}if(!_43||_43.length===0){_44.call(_46,"",true);return;}var _47=null,_48=[],_49=0,_4a=true;var _4b=function(){var _4c=_43[_49++];if(_4c){_2d(_47,_4c,function(_4d){if(_4d){_48.push(_4d);}else{_4a=false;}_4b();},function(e){_22(_45,_46,e,"getBacktrack");});}else{_44.call(_46,_48.join(""),_4a);}};if(!_42){_44.call(_46,"",false);}else{_12.get({guid:_42,callback:function(obj){_47=obj;_4b();},error:function(e){_22(_45,_46,e,"getBacktrack");}});}};var _4e=function(_4f,_50){var _51=[],_52=_28(_4f,_50);for(var m in _52){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_4f.has(m)){var _53=_4f.getAttributeType(m);switch(_53){case "ObjectReference":_51.push("["+m+"='"+_52[m]+"']");break;case "ObjectReferenceSet":_51.push("["+m+"='"+_52[m]+"']");break;default:}}}return _51.join("");};var _54=function(_55){var _56=_55.entity||_55.className,_57=window.mx.meta.getEntity(_56),_58=_55.context,_59="//"+_56,_5a=_4e(_57,_58);var _5b=function(_5c,_5d){if(_55.callback){_55.callback(_59+_5a+_5c,_5d);}};if(_58.getConstraints().length!==0){_41(_57,_58,_5b,_55.error);}else{_5b("",true);}};var _5e=function(_5f){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_5f.type+"("+_5f.xpath+")",resulttype:_5f.resulttype||"integer"}},options:{callback:function(_60,_61){var _62;if(_61){if(_5f.resulttype=="float"){_62=parseFloat(_61.value).toFixed(2)||"0.00";}else{_62=_61.value||0;}}else{_62=0;}_5f.callback&&_5f.callback(_62);},error:function(e){_22(_5f.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _63=function(_64){var _65;if(_64===""){return;}else{if(_64.match(/^\[[^=\[]+=.[0-9]+./)){_65=_e.map(_64.match(/\[.+?\]/g),function(_66){_66=_66.substr(1,_66.length-2);return {ref:_66.match(/[^=]+/)[0],ref_ids:_66.match(/\d+/)[0]};});}else{_65=_e.map(_64.match(/\[.+?\]]/g),function(_67){_67=_67.substr(1,_67.length-3);var _68=_67.split("[");return {ref:_68[0].split("/")[0],ref_ids:_68[1]};});}}return _65;};this.toString=function(){return _13;};this.setOfflineStore=function(_69,_6a){_19=new _8(_69,_6a,_11.offlineBackend);_16=new _a(_19,new _9(),function(_6b){return !_18(_6b);});};this.startup=function(){window.mx.server.registerCaller(_f.hitch(_16,"flush"));window.setInterval(_f.hitch(_16,"cleanup"),10000);};this.subscribe=function(_6c,_6d){var id=_5.getUniqueId(),_6e=_6c.entity,_6f=_6c.guid,val=_6c.val,_70=_6c.attr,_71=_6c.async,_72=_6d?function(){_6c.callback.apply(_6d,arguments);}:_6c.callback;var _73={handler:_72,async:_71};if(_70){if(!_14.attrs[_6f]){_14.attrs[_6f]={};}if(!_14.attrs[_6f][_70]){_14.attrs[_6f][_70]={};}_14.attrs[_6f][_70][id]=_73;}else{if(val){if(!_14.vals[_6f]){_14.vals[_6f]={};}_14.vals[_6f][id]=_73;}else{if(_6f){if(!_14.guids[_6f]){_14.guids[_6f]={};}_14.guids[_6f][id]=_73;}else{if(_6e){if(!_14.entities[_6e]){_14.entities[_6e]={};}_14.entities[_6e][id]=_73;}else{_6.error(_13+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_6e,guid:_6f,val:val,attr:_70,id:id};};this.unsubscribe=function(_74){if(_74==null){return;}var id=_74.id,_75=_74.entity,_76=_74.guid,val=_74.val,_77=_74.attr,_78=_5.itemCount;if(_77){var _79=_14.attrs[_76];if(!_79){}else{if(!_79[_77]){}else{delete _79[_77][id];if(_78(_79[_77])===0){delete _79[_77];}if(_78(_79)===0){delete _14.attrs[_76];}}}}else{if(val){if(!_14.vals[_76]){}else{delete _14.vals[_76][id];if(_78(_14.vals[_76])===0){delete _14.vals[_76];}}}else{if(_76){var _7a=_14.guids[_76];if(!_7a){}else{delete _7a[id];if(_78(_7a)===0){delete _14.guids[_76];}}}else{if(_75){var _7b=_14.entities[_75];if(!_7b){}else{delete _7b[id];if(_78(_7b)===0){delete _14.entities[_75];}}}}}}};this.update=function(_7c){var _7d=_7c.guid,_7e=_7c.entity,_7f=_7c.attr,val=_7c.val,_80=_7c.value,_81=_7c.callback;var _82=function(_83,_84,_85){var map=_83?_f.clone(_83):{};_5.collect(Object.keys(map).map(function(key){if(map[key].async){return function(cb){map[key].handler.apply(null,_84.concat([cb]));};}else{return function(cb){map[key].handler.apply(null,_84);cb();};}}),_85);};if(_7f){_82(_14.attrs[_7d]&&_14.attrs[_7d][_7f],[_7d,_7f,_80],_81);}else{if(_7d){_82(_14.guids[_7d],[_7d],_81);}else{if(val){_82(_14.vals[_7d],[_7d],_81);}else{if(_7e){_82(_14.entities[_7e],[_7e],_81);}else{_6.error(_13+".update: no 'entity' or 'guid' parameter found");}}}}};this.objectUpdateNotification=function(_86){_12.sendClassUpdate(_86.getEntity());_12.update({guid:_86.getGuid()});};this.sendClassUpdate=function(_87,_88){var _89=window.mx.meta.getEntity(_87);if(!_89){throw new _2("No permission to read or write entity "+_87+", check security!");}var _8a=[_87].concat(_89.getSuperEntities()).map(function(ent){return function(cb){_12.update({entity:ent,callback:cb});};});_5.collect(_8a,_88);};this.sendValidationUpdates=function(_8b){var _8c,_8d=[];for(var i=0,_8e;_8e=_8b[i];i++){_8c=_14.vals[_8e.getGuid()];var cp=_8e.clone(),_8f=cp.getAttributes();if(_8c){for(var x in _8c){var _90=_8e.clone();try{_8c[x].handler([_90]);}catch(e){_6.error(_13+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _8c[x];}var _91=_90.getAttributes();_e.forEach(_8f,function(_92){var _93=_92.name,_94=_e.some(_91,function(_95){return _95.name==_93;});if(!_94){cp.removeAttribute(_92.name);}},this);}}else{}if(cp.getAttributes().length){_8d.push(cp);}}window.mx.ui.validations(_8d);};this.action=function(_96){_16.action(_96.params,_96.context,_96.store,!!_96.async,_96.onValidation,function(_97,_98){if(_96.callback){_96.callback(_97,_98);}},function(e){_22(_96.error,null,e,"action");});};this.setOrRetrieveMxObject=function(_99){return _16.setOrRetrieveMxObject(_99);};this.get=function(_9a,_9b){var _9c=_9a.xpath,_9d=_9a.path,id=_9a.guid,ids=(!("guids" in _9a)&&id)?[id]:_9a.guids,_9e=_9a.callback,_9f=_9a.error,_a0=!!_9a.noCache,_a1=!!_9a.count,_a2=_9a.filter,_a3=!!_9a.aggregates,_a4=_9a.context,_a5=_9a.microflow,err;if(("guid" in _9a)&&id==null){_1d(_9e,_9b,[null],"");return;}if(!_9c&&!ids&&!_a5){err=_13+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _2(err);}if(_9d&&ids.length!=1){throw new _2(_13+".get : path can only be used with a single guid");}if(typeof _9e!="function"){err=_13+".get: callback is not a function";_6.error(err);throw new _2(err);}else{if(_9f&&typeof _9f!="function"){err=_13+".get: error is not a function";_6.error(err);throw new _2(err);}}if(_a2){if(_a2.limit){_a2.amount=_a2.limit;delete _a2.limit;}if(_a2.references){for(var r in _a2.references){var ref=_a2.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_a6=_1a({},_a2,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_a7=function(e){_22(_9f,_9b,e,"get");};if(_a6.id&&ids&&!id){delete _a6.id;}if(_a6.id){delete _a6.attributes;delete _a6.distinct;}if(_a5){var _a8=ids?"selection":(_9c?"set":"none"),_a9={actionname:_a5,applyto:_a8};if(_a8=="selection"){_a9.guids=ids;}else{if(_a8=="set"){_a9.xpath=_9c;if(_a6.sort){_a9.sort=_a6.sort;}}}this.action({params:_a9,context:_a4,callback:function(_aa,_ab){_9e&&_9e.call(_9b,_aa,_ab);},error:_a7});}else{if(_9d&&ids){_16.getByPath(ids[0],_9d,_9a.entity,function(_ac,_ad){try{if(_9e){_9e.call(_9b,_ac,{count:_ad});}}catch(e){_6.error(_13+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_9b?"("+_9b+")":""));}},function(e){_22(_9f,_9b,e,"get");});}else{if(ids){if(ids.length===0){_1d(_9e,_9b,[id?null:[],{count:0}],".get: error in handler");return;}_16.getByGuid(ids,_a6,!_a0,function(_ae,_af){var _b0;if(id){if(_a6.id){_b0=_e.filter(_ae,function(_b1){return _b1.getGuid()===id;})[0];if(_b0===undefined){_22(_9f,_9b,new _2("Returned objects do not contain requested one"),"get");return;}}else{_b0=_ae[0]||null;}}else{_b0=_ae;}try{if(_9e){_9e.call(_9b,_b0,{count:_af});}}catch(e){_6.error(_13+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_9b?"("+_9b+")":""));}},function(e){_22(_9f,_9b,e,"get");});return true;}else{_16.getByXPath(_9c,_a6,_a1,_a3,function(_b2,_b3,_b4){_1d(_9e,_9b,[_b2,{count:_b3,aggregates:_b4}],".get: error in error handler for xpath "+_9c);},_a7);return true;}}}};this.getBySchema=function(_b5,_b6){var _b7=_b5.id,_b8=_b5.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_b5},options:{callback:function(_b9,_ba){var _bb=[],_bc;_e.forEach(_ba.mxobjects,function(_bd){var _be=new _4({json:_bd,meta:window.mx.meta.getEntity(_bd.objectType)});if(_bd.guid==_b7){_bc=_be;}_bb.push(_be);});_bc.attachReferences(_bb);_b8&&_b8(_bc,false);},error:function(e){_22(_b5.error,_b6,e,"getBySchema");}}});};this.getSlice=function(_bf,_c0,_c1,_c2,_c3){_16.getSlice(_bf,_c0,_c1).spread(function(_c4,_c5){if(_c2){_c2(_c4,_c5);}}).caught(function(e){if(_c3){_c3(e);}else{mx.onError(e);}});};this.fetch=function(obj,_c6,_c7,_c8,_c9){if(_f.isFunction(_c7)){_c9=_c8;_c8=_c7;}var _ca;if(!_c6){_ca=[];}else{if(_c6 instanceof Array){_ca=_c6.slice();}else{_ca=_c6.split("/");}}if(obj&&obj.isA(_ca[0])){_ca.shift();}var _cb;if(_ca.length%2==1){_cb=_ca.pop();}else{_cb="";}_16.fetch(obj,_ca,_cb,_c7,_c8,_cc);function _cc(e){_22(_c9,null,e,"fetch");};};this.release=function(_cd){if(!_cd){return;}_cd=_cd instanceof Array?_cd:[_cd];for(var i=0,len=_cd.length;i<len;++i){if(_cd[i]){_16.release(_cd[i].getGuid());}}};this.create=function(_ce,_cf){if(typeof _ce.callback!="function"){throw new _2(_13+".create: callback is not a function");}else{if(_ce.error&&typeof _ce.error!="function"){throw new _2(_13+".create: error is not a function");}else{if(typeof _ce.entity!="string"){throw new _2(_13+".create: entity is not a string");}}}_16.create(_ce.entity,_ce.persistent,function(obj){if(_ce.context){_12.setObjectToContext(obj,_ce.context);}_ce.callback.call(_cf,obj);},function(e){_22(_ce.error,_cf,e,"create");});};this.jsonToMxObject=function(_d0){return new _4({json:_d0,meta:window.mx.meta.getEntity(_d0.objectType)});};this.remove=function(_d1){var _d2=("guid" in _d1)?[_d1.guid]:_d1.guids;if(("guids" in _d1)&&!(_d1.guids instanceof Array)){throw new _2(_13+".remove: parameter guids set but not of type Array");}else{if(_d1.error&&typeof _d1.error!="function"){throw new _2(_13+".remove: parameter error set but not of type Function");}else{if(_d1.callback&&typeof _d1.callback!="function"){throw new _2(_13+".remove: parameter callback set but not of type Function");}}}_16.remove(_d2,_d1.callback,_d3);function _d3(e){_22(_d1.error,null,e,"remove");};};this.save=function(_d4,_d5){if(typeof _d4.callback!="function"){throw new _2(_13+".save: callback is not a function");}else{if(_d4.mxobj!=null&&!(_d4.mxobj instanceof _4)){throw new _2(_13+".save: mxobj is not an MxObject");}}_16.save(_d4.mxobj,_d4.standalone,_d4.onValidation,_d6,_d7);function _d6(){var msg=".save: error calling handler";if(_d4.mxobj){msg+=" for ["+_d4.mxobj.getGuid()+"]";}_1d(_d4.callback,_d5,null,msg);};function _d7(_d8){var err;if(_d8 instanceof Error){err=_d8;}else{if(_d8){err=new _3();_12.sendValidationUpdates([_d8.clone()]);}}_22(_d4.error,_d5,err,"save");};};this.commit=function(_d9,_da){if(typeof _d9!="object"){throw new _2(_13+".commit: args is not an object");}else{if(typeof _d9.callback!="function"){throw new _2(_13+".commit: callback is not a function");}else{if(_d9.mxobj!=null&&!(_d9.mxobj instanceof _4)){throw new _2(_13+".commit: mxobj is not a MxObject");}}}if(!_d9.mxobj&&_d9.callback){_1d(_d9.callback,_da,null,".commit: error when executing handler without object");return;}_16.commit(_d9.mxobj.getGuid(),_d9.context,_d9.store,_d9.onValidation,_db,_dc);function _db(){_12.objectUpdateNotification(_d9.mxobj);_1d(_d9.callback,_da,null,".commit: error when executing handler for ["+_d9.mxobj.getGuid()+"]");};function _dc(e){_22(_d9.error,null,e,"commit");};};this.rollback=function(_dd,_de){if(typeof _dd!="object"){throw new _2(_13+".rollback: args is not an object");}else{if(typeof _dd.callback!="function"){throw new _2(_13+".rollback: callback is not a function");}else{if(_dd.mxobj!=null&&!(_dd.mxobj instanceof _4)){throw new _2(_13+".rollback: mxobj is not a MxObject");}}}if(!_dd.mxobj){_1d(_dd.callback,_de,null,".rollback: error in handler");return;}var _df=_dd.mxobj;var _e0=_df.getEntity();var _e1=_df.getGuid();_16.rollback(_df,_e2,_e3);function _e2(_e4){if(_e4){_df.resetFromJSON(_e4.jsonData);_12.objectUpdateNotification(_e4);}_df.reset();_12.sendClassUpdate(_e0);_1d(_dd.callback,_de,null,_13+".rollback: error in handler for ["+_e1+"]");};function _e3(e){_22(_dd.error,null,e,"rollback");};};this.synchronizeDataWithFiles=function(_e5,_e6){this._createSynchronizeTask().chain(function(_e7){var _e8=Object.keys(_e7).map(function(_e9){return _e7[_e9];});return _d.sequence_(_e8,_c);}).fork(function(e){if(_e6){_e6(e);}},function(){if(_e5){_e5();}});};this.synchronizeData=function(_ea,_eb){this._createSynchronizeTask().fork(function(e){if(_eb){_eb(e);}},function(){if(_ea){_ea();}});};this._createSynchronizeTask=function(){return _19.upload(_15).chain(function(_ec){var _ed=Object.keys(_ec).map(function(_ee){return _ec[_ee];});return _d.sequence_(_ed,_c);}).chain(function(){_16.clearCache();return _c.of();}).orElse(function(e){if(!(e instanceof _1)&&!(e instanceof _b)){return _19.cleanupDirtyObjects();}else{return _c.rejected(e);}}).chain(function(){return _19.download();});};this.invalidateCaches=function(_ef){_16.invalidateCaches(_ef);};this.saveDocument=function(_f0,_f1,_f2,_f3,_f4,_f5){_16.saveDocument(_f0,_f1,_f2,_f3,_f4,_f5);};this.matchObjectsToContext=function(_f6){var _f7=_f6.entity,_f8=_f6.context,_f9=_f6.mxobjs,_fa=_f6.callback,_fb=[];_41(window.mx.meta.getEntity(_f7),_f8,function(_fc){var _fd=_63(_fc);for(var i=0,obj;obj=_f9[i];i++){var _fe=0;for(var x=0,_ff;_ff=_fd[x];x++){var ref=_ff.ref,_100=_ff.ref_ids,ids=obj.getReferences(ref),_101=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_100.match(ids[j])){_101=true;break;}}}_101&&_fe++;}if(_fe==_fd.length){_fb.push(obj);}}_fa(_fb);});};this.createXPathString=function(_102){var _103=_102.callback,_104=_102.entity||_102.className,_105=_102.context;var _106=_105&&_105.getContexts();if(!_106||_106.length===0){_103("//"+_104);return;}_54(_102);};this.generateExport=function(_107){window.mx.server.request({request:{action:"export",params:_107.params},options:{callback:_107.callback,error:function(e){_22(_107.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_108,_109){if(typeof _108!="object"){throw new _2(_13+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _109!="object"){throw new _2(_13+".setObjectToContext: parameter context is not of type Object");}}try{var _10a=_108.getAttributes();for(var e=0;e<_10a.length;e++){if(_108.isReference(_10a[e])){var _10b=_108.getSelectorEntity(_10a[e]);if((_10a[e]=="System.owner")||(_10a[e]=="System.changedBy")){continue;}if(_109.hasContext(_10b)){_108.addReference(_10a[e],_109.getContext(_10b));}var meta=window.mx.meta.getEntity(_10b);if(meta){if(meta.hasSubEntities()){var _10c=meta.getSubEntities();for(var i=0;i<_10c.length;i++){if(_109.hasContext(_10c[i])){_108.addReference(_10a[e],_109.getContext(_10c[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_10d){_10d.type="sum";_5e(_10d);};this.countOfXPathSet=function(_10e){_10e.type="count";_5e(_10e);};this.sizeOfXPathSet=function(_10f){_10f.type="count";_5e(_10f);};this.avgOfXPathSet=function(_110){_110.type="avg";_5e(_110);};this.maxOfXPathSet=function(_111){_111.type="max";_5e(_111);};this.minOfXPathSet=function(_112){_112.type="min";_5e(_112);};this.makeChange=function(_113,attr,_114){_16.makeChange(_113,attr,_114);this.update({guid:_113.getGuid(),attr:attr,value:_113.get(attr)});};this.flush=function(_115){_16.flush(_115);};this.getDocumentUrl=function(guid,_116,_117){return _19.getDocumentUrl(guid,_116,_117);};};return _10;});