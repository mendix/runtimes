
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Data",["mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/ObjectValidation","mendix/ov","mendix/lib/MxObject","mendix/lang","mendix/logger","dojo/_base/array","dojo/_base/lang"],function(_1,_2,_3,ov,_4,_5,_6,_7,_8){function _9(_a){_a=_a||{};var _b=this,_c="mendix.sys.Data",_d=false,_e={},_f={},_10={},_11={},_12=null,_13=null,_14={entities:{},guids:{},attrs:{},vals:{}};var _15=function(_16,_17,map){if(!_17){return _16;}for(var i in map){if((i in _17)&&(_17[i]!=null)){_16[i]=_17[i];}}return _16;};var _18=function(_19,_1a,_1b,_1c){try{_19&&_19.apply(_1a,_1b||[]);}catch(e){_6.error(_c+_1c+" : "+e.message+" "+(_1a?"("+_1a+")":""));}};var _1d=function(_1e,_1f,e,_20){try{if(_1e){_1e.call(_1f,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_c+"."+_20+" while calling error handler: "+err.message);}};var _21=function(ids){var _22=[];for(var i=0,id;id=ids[i++];){if(_e[id]!==undefined){_22.push(_e[id]);}}return _22;};var _23=function(_24){var _25=_5.itemCount;return (_25(_14.guids[_24])||_25(_14.attrs[_24]));};var _26=function(_27){var _28=0;for(var i=0,_29;_29=_27[i];i++){if(_e[_29]&&!_23(_29)){delete _e[_29];delete _11[_29];delete _f[_29];window.mx.server.release(_29);_28++;}}};var _2a=function(_2b,_2c,_2d,_2e){var _2f=[],_30=[],_31=false;if(!(_2e instanceof Array)){_31=!!_2e;_2e=[];}for(var i=0,_32;_32=_2b[i];++i){var _33=_32.guid,_34=_e[_33],inc=(_31||_7.indexOf(_2e,_33)>=0)?1:0;if(!_2c){delete _11[_33];}if(_2d&&_34){if(!_2c||!_34.hasChanges()){_34.resetFromJSON(_32);}_f[_33]+=inc;_2f.push(_34);}else{var obj=new _4({json:_32,meta:window.mx.meta.getEntity(_32.objectType)});if(_2d){_e[_33]=obj;_f[_33]=inc;}if(_34){_30.push(_34.getGuid());}_2f.push(obj);}}if(!_2d){_26(_30);}return _2f;};var _35=function(_36,_37,_38){var _39=function(_3a,_3b){var _3c;if(_3b.mxobject){_3c=[_3b.mxobject];}else{if(_3b.mxobjects&&_3b.mxobjects.mxobjects){_3c=_3b.mxobjects.mxobjects;if(!_3c.length){_3c=[_3c];}}else{_3c=_3b.mxobjects;}}var _3d=(_3c&&_3c.length)?_2a(_3c,true,_37,_38):[];_36(_3d,{count:_3b.count,aggregates:_3b.aggregates});};return _39;};var _3e=function(_3f,_40){var obj=_40,_41=_3f.getGuid(),_42=_e[_41];if(obj){if(_42){_42.resetFromJSON(obj.jsonData);}else{_42=_e[_41]=obj;_f[_41]=0;}if(_3f!=_42){_3f.resetFromJSON(obj.jsonData);}_b.objectUpdateNotification(obj);}else{_e[_41]=null;if(_42){_42.resetFromJSON(null);}}};var _43=function(_44,_45){var _46={};_7.forEach(_44.getAttributes(),function(ref){if(!_44.isReference(ref)){return;}var _47=_45.getContext(_44.getSelectorEntity(ref));if(_47){_46[ref]=_47;}});return _46;};var _48=function(_49,_4a,_4b,_4c){var _4d=_4a.split("/");var _4e=function(_4f){var _50=_4d.shift(),ref=_4d.shift(),_51;if(_4f==null||_4f.length==null||_4f.length===0){_4b(null);return;}var _52=[];for(var i=0;i<_4f.length;i++){if(_4f[i]==null){continue;}_52.push("id='"+_4f[i].getGuid()+"'");}if(!_52.length){_4b(null);return;}var ids=_52.join(" or ");_51="["+ref+"/"+_50+"["+ids+"]]";if(_4d.length==1){_4b(_51);}else{var _53=_4d[0];_50=_4d.shift();ref=_4d.shift();_4b("["+ref+"/"+_50+""+_51+"]");}};var _54=function(){var _55=_4d.shift(),ref=_4d.shift();if(_4d.length==1){var _56="["+ref+"='"+_49.getGuid()+"']";_4b(_56);return;}if(window.mx.meta.getEntity(_55)==null){_1d(_4c,null,new _1(_c+".runMapPath: entity"+_55+" does not exist"),"runMapPath");return;}if(!_49.isA(_55)){_1d(_4c,null,new _1(_c+".runMapPath: entity "+_49.getEntity()+" is not a "+_55+" or one of its subclasses"),"runMapPath");return;}if(!_49.has(ref)){_1d(_4c,null,new _1(_c+".runMapPath: reference "+ref+" not found in entity "+_55),"runMapPath");return;}if(_49.get(ref)!==""){_b.get({guids:_49.getReferences(ref),callback:_4e,error:_4c});}else{_4b(null);}};_54();};var _57=this.getBacktrackConstraints=function(_58,_59,_5a,_5b,_5c){if(!_8.isFunction(_5b)){_5c=_5b;_5b=null;}_b.getBacktrack(_59.getTrackId(),_59.getConstraints(),_5a,_5b,_5c);};this.getBacktrack=function(_5d,_5e,_5f,_60,_61){if(!_8.isFunction(_60)){_61=_60;_60=null;}if(!_5e||_5e.length===0){_5f.call(_61,"",true);return;}var _62=null,_63=[],_64=0,_65=true;var _66=function(){var _67=_5e[_64++];if(_67){_48(_62,_67,function(_68){if(_68){_63.push(_68);}else{_65=false;}_66();},function(e){_1d(_60,_61,e,"getBacktrack");});}else{_5f.call(_61,_63.join(""),_65);}};if(!_5d){_5f.call(_61,"",false);}else{_b.get({guid:_5d,callback:function(obj){_62=obj;_66();},error:function(e){_1d(_60,_61,e,"getBacktrack");}});}};var _69=function(_6a,_6b){var _6c=[],_6d=_43(_6a,_6b);for(var m in _6d){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_6a.has(m)){var _6e=_6a.getAttributeType(m);switch(_6e){case "ObjectReference":_6c.push("["+m+"='"+_6d[m]+"']");break;case "ObjectReferenceSet":_6c.push("["+m+"='"+_6d[m]+"']");break;default:}}}return _6c.join("");};var _6f=function(_70){var _71=_70.entity||_70.className,_72=window.mx.meta.getEntity(_71),_73=_70.context,_74="//"+_71,_75=_69(_72,_73);var _76=function(_77,_78){if(_70.callback){_70.callback(_74+_75+_77,_78);}};if(_73.getConstraints().length!==0){_57(_72,_73,_76,_70.error);}else{_76("",true);}};var _79=function(_7a){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_7a.type+"("+_7a.xpath+")",resulttype:_7a.resulttype||"integer"}},options:{callback:function(_7b,_7c){var _7d;if(_7c){if(_7a.resulttype=="float"){_7d=parseFloat(_7c.value).toFixed(2)||"0.00";}else{_7d=_7c.value||0;}}else{_7d=0;}_7a.callback&&_7a.callback(_7d);},error:function(e){_1d(_7a.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _7e=function(_7f){var _80;if(_7f===""){return;}else{if(_7f.match(/^\[[^=\[]+=.[0-9]+./)){_80=_7.map(_7f.match(/\[.+?\]/g),function(_81){_81=_81.substr(1,_81.length-2);return {ref:_81.match(/[^=]+/)[0],ref_ids:_81.match(/\d+/)[0]};});}else{_80=_7.map(_7f.match(/\[.+?\]]/g),function(_82){_82=_82.substr(1,_82.length-3);var _83=_82.split("[");return {ref:_83[0].split("/")[0],ref_ids:_83[1]};});}}return _80;};var _84=function(){var _85=0;for(var _86 in _e){if(_f[_86]===0&&!_23(_86)){delete _e[_86];delete _f[_86];delete _11[_86];window.mx.server.release(_86);}else{++_85;}}};this.toString=function(){return _c;};this.startup=function(_87){_d=true;_12=window.mx.server.registerCaller(_8.hitch(this,"xastrigger"));_13=window.setInterval(function(){_84();},10000);_87();};this.shutdown=function(){_d=false;_e={};_11={};_f={};clearInterval(_13);window.mx.server.unregisterCaller(_12);};this.isLoaded=function(){return _d;};this.subscribe=function(_88,_89){var id=_5.getUniqueId(),_8a=_88.entity,_8b=_88.guid,val=_88.val,_8c=_88.attr,_8d=_89?function(){_88.callback.apply(_89,arguments);}:_88.callback;if(_8c){if(!_14.attrs[_8b]){_14.attrs[_8b]={};}if(!_14.attrs[_8b][_8c]){_14.attrs[_8b][_8c]={};}_14.attrs[_8b][_8c][id]=_8d;}else{if(val){if(!_14.vals[_8b]){_14.vals[_8b]={};}_14.vals[_8b][id]=_8d;}else{if(_8b){if(!_14.guids[_8b]){_14.guids[_8b]={};}_14.guids[_8b][id]=_8d;}else{if(_8a){if(!_14.entities[_8a]){_14.entities[_8a]={};}_14.entities[_8a][id]=_8d;}else{_6.error(_c+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_8a,guid:_8b,val:val,attr:_8c,id:id};};this.unsubscribe=function(_8e){if(_8e==null){return;}var id=_8e.id,_8f=_8e.entity,_90=_8e.guid,val=_8e.val,_91=_8e.attr,_92=_5.itemCount;if(_91){var _93=_14.attrs[_90];if(!_93){}else{if(!_93[_91]){}else{delete _93[_91][id];if(_92(_93[_91])===0){delete _93[_91];}if(_92(_93)===0){delete _14.attrs[_90];}}}}else{if(val){if(!_14.vals[_90]){}else{delete _14.vals[_90][id];if(_92(_14.vals[_90])===0){delete _14.vals[_90];}}}else{if(_90){var _94=_14.guids[_90];if(!_94){}else{delete _94[id];if(_92(_94)===0){delete _14.guids[_90];}}}else{if(_8f){var _95=_14.entities[_8f];if(!_95){}else{delete _95[id];if(_92(_95)===0){delete _14.entities[_8f];}}}}}}};this.update=function(_96){var _97=_96.guid,_98=_96.entity,_99=_96.attr,val=_96.val,_9a=_96.value,_9b=_96.callback;var _9c=function(_9d,_9e){var map=_9d?_8.clone(_9d):{};for(var key in map){map[key].apply(null,_9e);}};if(_99){_9c(_14.attrs[_97]&&_14.attrs[_97][_99],[_97,_99,_9a]);}else{if(_97){_9c(_14.guids[_97],[_97]);}else{if(val){_9c(_14.vals[_97],[_97]);}else{if(_98){_9c(_14.entities[_98],[_98]);}else{_6.error(_c+".update: no 'entity' or 'guid' parameter found");}}}}_9b&&_9b();};this.objectUpdateNotification=function(_9f){_b.sendClassUpdate(_9f.getEntity());_b.update({guid:_9f.getGuid()});};this.sendClassUpdate=function(_a0){var _a1=window.mx.meta.getEntity(_a0);if(!_a1){throw new _1("No permission to read or write entity "+_a0+", check security!");}_7.forEach([_a0].concat(_a1.getSuperEntities()),function(ent){_b.update({entity:ent});});};this.objectPing=function(_a2,_a3){var _a4=_a2.getGuid(),_a5=_8.clone(_14.guids[_a4]),_a6=[];if(_a5){for(var sub in _a5){_a6.push((function(_a7,sub){return function(cb){try{var _a8=_a7[sub];if(_a8.length==2){_a8(_a4,cb);}else{_a8(_a4);cb();}}catch(e){if(_a7){delete _a7[sub];}cb();}};})(_a5,sub));}_5.collect(_a6,_a3);}else{_a3&&_a3();}};this.addValidation=function(_a9,_aa,_ab){if(!_11[_a9]){_11[_a9]=new _3({msg:{guid:_a9}});}_11[_a9].addField(_aa,_ab);};this.sendValidationUpdates=function(_ac){var _ad,_ae=[];for(var i=0,_af;_af=_ac[i];i++){_ad=_14.vals[_af.getGuid()];var cp=_af.clone(),_b0=cp.getAttributes();if(_ad){for(var x in _ad){var _b1=_af.clone();try{_ad[x]([_b1]);}catch(e){_6.error(_c+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _ad[x];}var _b2=_b1.getAttributes();_7.forEach(_b0,function(_b3){var _b4=_b3.name,_b5=_7.some(_b2,function(_b6){return _b6.name==_b4;});if(!_b5){cp.removeAttribute(_b3.name);}},this);}}else{}if(cp.getAttributes().length){_ae.push(cp);}}window.mx.ui.validations(_ae);};this.action=function(_b7){var _b8=_b7.context,_b9=_b7.callback,_ba=_b7.error,_bb=_b7.onValidation,_bc=!!_b7.async,_bd=_b7.params,_be=_b7.store;var _bf=function(e){_1d(_ba,null,e,"action");};window.mx.server.request({request:{action:"executeaction",params:_bd,context:_b8},options:{callback:function(_c0,_c1,_c2){var _c3=_c1.actionResult,_c4;if(_c3 instanceof Array){_c4=_2a(_c3,false,true,true);}else{if(typeof _c3=="object"&&_c3.guid){_c4=_2a([_c3],false,true,true);}else{_c4=_c1.actionResult;}}_b9&&_b9(_c4,_c2);},error:_bf,store:_be,async:_bc,onValidation:_bb}});};this.setOrRetrieveMxObject=function(_c5){return _2a([_c5],false,true)[0];};this.get=function(_c6,_c7){var _c8=_c6.xpath,_c9=_c6.path,id=_c6.guid,ids=(!("guids" in _c6)&&id)?[id]:_c6.guids,_ca=_c6.callback,_cb=_c6.error,_cc=!!_c6.noCache,_cd=!!_c6.count,_ce=_c6.filter,_cf=!!_c6.aggregates,_d0=_c6.context,_d1=_c6.microflow,err;if(("guid" in _c6)&&id==null){_18(_ca,_c7,[null],"");return;}if(!_c8&&!ids&&!_d1){err=_c+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _1(err);}if(_c9&&ids.length!=1){throw new _1(_c+".get : path can only be used with a single guid");}if(typeof _ca!="function"){err=_c+".get: callback is not a function";_6.error(err);throw new _1(err);}else{if(_cb&&typeof _cb!="function"){err=_c+".get: error is not a function";_6.error(err);throw new _1(err);}}if(_ce){if(_ce.limit){_ce.amount=_ce.limit;delete _ce.limit;}if(_ce.references){for(var r in _ce.references){var ref=_ce.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_d2=_15({},_ce,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_d3=function(e){_1d(_cb,_c7,e,"get");};if(_d2.id&&ids&&!id){delete _d2.id;}if(_d2.id){delete _d2.attributes;delete _d2.distinct;}if(_d1){var _d4=ids?"selection":(_c8?"set":"none"),_d5={actionname:_d1,applyto:_d4};if(_d4=="selection"){_d5.guids=ids;}else{if(_d4=="set"){_d5.xpath=_c8;if(_d2.sort){_d5.sort=_d2.sort;}}}this.action({params:_d5,context:_d0,callback:function(_d6,_d7){_ca&&_ca.call(_c7,_d6,_d7);},error:_d3});}else{if(_c9&&ids){window.mx.server.request({request:{action:"retrieve_by_path",params:{id:ids[0],path:_c9},context:null},options:{callback:_35(function(_d8,_d9){_18(_ca,_c7,[_d8,_d9],".get: error in handler for ["+ids+"]");},true,true),error:_d3}});}else{if(ids){if(ids.length===0){_18(_ca,_c7,[id?null:[],{count:0}],".get: error in handler");return;}if(!_cc){var _da=_21(ids),_db=_da.length==ids.length;if(_db){var _dc=_da;if(_d2.sort){_7.forEach(_d2.sort,function(_dd){var _de=_dd[0],dir=_dd[1];_dc=_dc.sort(dir=="asc"?function(a,b){a=a.get(_de);b=b.get(_de);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get(_de);b=b.get(_de);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _df=_d2.offset;if(_df){var _e0=_d2.amount;if(_e0){_dc=_dc.slice(_df,_df+_e0);}else{_dc=_dc.slice(_df);}}for(var i=0,_e1;_e1=_dc[i];++i){++_f[_e1];}_18(_ca,_c7,[id?_dc[0]:_dc,{count:_da.length}],".get: error in handler for ["+ids+"]");return true;}}var _e2=_d2.attributes==null;window.mx.server.request({request:{action:"retrieve_by_ids",params:{ids:ids,schema:_d2}},options:{callback:_35(function(_e3,_e4){var _e5=_e3[0];if(id&&_d2.id){for(var i=0,obj;obj=_e3[i];++i){if(obj.getGuid()==id){_e5=obj;break;}}}_18(_ca,_c7,[id?_e5:_e3,_e4],".get: error in handler for ["+ids+"]");},_e2,ids),error:_d3}});return true;}else{window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_c8,schema:_d2,count:_cd,aggregates:_cf}},options:{callback:_35(function(_e6,_e7){_18(_ca,_c7,[_e6,_e7],".get: error in error handler for xpath "+_c8);},false),error:_d3}});return true;}}}};this.getBySchema=function(_e8,_e9){var _ea=_e8.id,_eb=_e8.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_e8},options:{callback:function(_ec,_ed){var _ee=[],_ef;_7.forEach(_ed.mxobjects,function(_f0){var _f1=new _4({json:_f0,meta:window.mx.meta.getEntity(_f0.objectType)});if(_f0.guid==_ea){_ef=_f1;}_ee.push(_f1);});_ef.attachReferences(_ee);_eb&&_eb(_ef,false);},error:function(e){_1d(_e8.error,_e9,e,"getBySchema");}}});};this.fetch=function(obj,_f2,_f3,_f4,_f5){var _f6=obj,_f7=false,_f8,_f9,_fa;if(_8.isFunction(_f3)){_f5=_f4;_f4=_f3;}if(!_f2){_f8=[];}else{if(_f2 instanceof Array){_f8=_f2.slice();}else{_f8=_f2.split("/");}}if(obj&&obj.isA(_f8[0])){_f8.shift();}if(_f8.length%2==1){_fa=_f8.pop();}else{_fa="";}if(_f3.schema){_f9=_f8.splice(-2);}else{_f9=[];}var _fb=function(_fc,ref){if(_fc.isObjectReference(ref)){return _fc.getReference(ref);}else{if(_fc.isObjectReferenceSet(ref)){return _fc.getReferences(ref);}else{return _fc.get(ref);}}};var _fd=function(){if(_f6==null){_f4(null,false);}else{if(!_fa){_f4(_f6,_f7);}else{if(_fa){_f4(_fb(_f6,_fa),false);}}}};var _fe=function(ref){if(_f6.getReferences(ref).length===0){_f4([],false);}else{if(_f6.hasChildren(ref)){_f4(_f6.getChildren(ref),false);}else{window.mx.data.get({guids:_f6.getReferences(ref),filter:{id:_f3.schema},callback:function(_ff){_f4(_ff,true);},error:_f5});}}};var _100=function(ref,_101){var guid=_f6.getReference(ref);if(guid){window.mx.data.get({guid:guid,filter:{id:_101},callback:function(obj){if(obj){_f6=obj;_f7=true;_102();}else{_f4(null,false);}},error:_f5});}else{_f4(null,false);}};var _103=function(path){var _104,_105;if(path.length<3){return false;}_104=window.mx.meta.getEntity(path.slice(-3)[0]),_105=_f8.slice(-2)[0];return _104.isObjectReferenceSet(_105);};var _106=function(_107,type){var _108=["//"+type+"[id="+_107+"]"],_109=_103([type].concat(_f8));Array.prototype.push.apply(_108,_f8);_f8=[];window.mx.data.get({xpath:_108.join("/"),callback:function(objs){if(objs.length===0){_f4(null,false);}else{if(_fa&&objs.length==1){_f6=objs[0];_fd();}else{if(!_fa){if(_109){_f4(objs,false);}else{_f6=objs[0];_102();}}else{_1d(_f5,null,new _1(_c+".fetch"+_fa+" is not a reference type"),"fetch");}}}},error:_f5});};var _102=function(){var ref,type,_10a,_10b;if(_f8.length+_f9.length===0){_fd();}else{if(_f8.length===0&&_f9.length>0){ref=_f9.shift();type=_f9.shift();if(_f6.isObjectReferenceSet(ref)){_fe(ref);}else{_100(ref,_f3.schema);}}else{if(_f7){window.mx.data.release(_f6);_f7=false;}ref=_f8.shift();type=_f8.shift();if(_f6.isObjectReferenceSet(ref)){if(_f8.length>0||_f9>0){_1d(_f5,null,new _1(_c+".fetch: reference set should be at end of path"),"fetch");}else{_fe(ref);}}else{if(_f6.isObjectReference(ref)){_10a=_f6.getChild(ref);if(_10a){_f6=_10a;_102();}else{_10b=_f6.getReference(ref);if(!_10b){_f4(null,false);}else{if(_e[_10b]!==undefined){_f6=_e[_10b];++_f[_10b];_f7=true;_102();}else{if(_f3.usexpath&&_f8.length>0){_106(_10b,type);}else{_100(ref);}}}}}else{_1d(_f5,null,new _1(_c+".fetch: attribute "+ref+" is not a reference type"),"fetch");}}}}};_102();};this.release=function(objs){if(!objs){return;}objs=objs instanceof Array?objs:[objs];var _10c=[];for(var i=0,len=objs.length;i<len;++i){var obj=objs[i];if(obj){var guid=obj.getGuid();if(_f[guid]){if(--_f[guid]===0&&!_23(guid)){_10c.push(guid);}}else{}}}_26(_10c);};this.create=function(_10d,_10e){var _10f=_10d.error,_110=_10d.context,_111=_10d.entity,_112=_10d.persistent,err;if(typeof _10d.callback!="function"){err=_c+".create: callback is not a function";_6.error(err);throw new _1(err);}else{if(_10f&&typeof _10f!="function"){err=_c+".create: error is not a function";_6.error(err);throw new _1(err);}else{if(typeof _111!="string"){err=_c+".create: entity is not a string";_6.error(err);throw new _1(err);}}}var _113=function(objs){var obj=objs&&objs[0];if(_110){_b.setObjectToContext(obj,_110);}_10d.callback.call(_10e,obj);};var _114=function(e){_1d(_10f,_10e,e,"create");};window.mx.server.request({request:{action:_112?"create":"instantiate",params:{objecttype:_10d.entity,preventCache:(new Date()).getTime()}},options:{callback:_35(_113,true,true),error:_114}});};this.jsonToMxObject=function(json){return new _4({json:json,meta:window.mx.meta.getEntity(json.objectType)});};this.remove=function(_115){var _116=_115.error,_117=_115.callback,_118=("guid" in _115)?[_115.guid]:_115.guids;if(("guids" in _115)&&!(_115.guids instanceof Array)){throw new _1(_c+".remove: parameter guids set but not of type Array");}else{if(_116&&typeof _116!="function"){throw new _1(_c+".remove: parameter error set but not of type Function");}else{if(_117&&typeof _117!="function"){throw new _1(_c+".remove: parameter callback set but not of type Function");}}}window.mx.server.request({request:{action:"delete",params:{guids:_118}},options:{callback:function(){_26(_118);_5.nullExec(_117);},error:function(e){_1d(_116,null,e,"remove");}}});};this.save=function(_119,_11a){var _11b,_11c,_11d,_11e,guid,msg,emsg=".save: error calling handler",e,_11f,_120,_121,_122,obj;if(_119){_11d=_119.mxobj;_11b=_119.callback;_11c=_119.error;_11e=_119.standalone;}if(typeof _11b!="function"){e=_c+".save: callback is not a function";_6.error(e);throw new _1(e);}else{if(_11d!=null&&!(_11d instanceof _4)){e=_c+".save: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(_11d){guid=_11d.getGuid();emsg=".save: error calling handler for ["+guid+"]";msg=_11[guid];if(msg){var data=null;if(msg instanceof _1){data=msg;}else{if(msg){data=new _2();this.sendValidationUpdates([msg.clone()]);}}_1d(_11c,_11a,data,"save");return;}else{if(!_11d.hasChanges()){_18(_11b,_11a,null,emsg);return;}}}_120={};if(!_11e){_11f=_10;_10={};_121=0;_122=0;for(var id in _11f){_122++;obj=_11f[id];if(obj.hasChanges()){_121++;_120[id]=obj._collectChanges();}delete _11[id];}if(!_121){if(_122){}_18(_11b,_11a,null,emsg);return;}}if(_11d&&!_11f[guid]){_120[guid]=_11d._collectChanges();_11f={guid:_11d};delete _10[guid];delete _11[guid];}window.mx.server.request({request:{action:"change",params:_120},options:{onValidation:_119.onValidation,sync:true,unique:true,callback:function(){for(var guid in _11f){_11f[guid]._applyChangeSet();}_11f=null;_18(_11b,_11a,null,emsg);},error:function(e){data=e.original||{};var _123=false,_124=guid;if(ov.hasValidations(data)){_7.forEach(ov.getValidations(data),function(v){var id=v.getGuid();if(_11f[id]){_11[id]=v;delete _11f[id];}if(_11d&&id==_124){_123=true;}});for(var id in _11f){_11f[id]._applyChangeSet();}}else{_8.mixin(_10,_11f);_123=true;}_11f=null;if(_11d){if(_123){_1d(_11c,null,e,"save");}else{_18(_11b,_11a,null,emsg);}}else{_18(_11b,_11a,null,emsg);}}}});};this.commit=function(_125,_126){var obj,_127,_128,_129,_12a,guid,e,msg;if(_125){obj=_125.mxobj;_127=_125.callback;_128=_125.error;_129=_125.onValidation;_12a=_125.context;}if(typeof _127!="function"){e=_c+".commit: callback is not a function";_6.error(e);throw new _1(e);}else{if(obj!=null&&!(obj instanceof _4)){e=_c+".commit: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(obj==null){_18(_127,_126,null,".commit: error when executing handler");}else{guid=obj.getGuid();msg=".commit: error when executing handler for ["+guid+"]";window.mx.server.request({request:{action:"commit",params:{guid:guid},context:_12a},options:{callback:function(){obj._commitChangeSet();delete _11[guid];delete _10[guid];_b.objectUpdateNotification(obj);_18(_127,_126,null,msg);},error:function(e){_1d(_128,null,e,"commit");},onValidation:_129,store:_125.store}});}};this.rollback=function(_12b,_12c){var _12d,obj,_12e;if(_12b){_12d=_12b.callback;obj=_12b.mxobj;_12e=_12b.error;}var emsg=".rollback: error in handler ",e;if(typeof _12d!="function"){e=_c+".rollback: callback is not a function";_6.error(e);throw new _1(e);}else{if(obj!=null&&!(obj instanceof _4)){e=_c+".rollback: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(!obj){_18(_12d,_12c,null,emsg);}else{var guid=obj.getGuid(),claz=obj.getEntity();emsg=_c+".rollback: error in handler for ["+guid+"]";delete _11[guid];delete _10[guid];window.mx.server.request({request:{action:"rollback",params:{guid:guid}},options:{unique:true,standalone:true,callback:_35(function(objs){obj._commitChangeSet();obj.reset();_3e(obj,objs[0]);_b.sendClassUpdate(claz);_18(_12d,_12c,null,emsg);},false),error:function(e){_1d(_12e,null,e,"rollback");}}});}return true;};this.mxObjectsCallback=function(_12f){return _35(_12f,false);};this.matchObjectsToContext=function(_130){var _131=_130.entity,_132=_130.context,_133=_130.mxobjs,_134=_130.callback,_135=[];_57(window.mx.meta.getEntity(_131),_132,function(_136){var _137=_7e(_136);for(var i=0,obj;obj=_133[i];i++){var _138=0;for(var x=0,_139;_139=_137[x];x++){var ref=_139.ref,_13a=_139.ref_ids,ids=obj.getReferences(ref),_13b=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_13a.match(ids[j])){_13b=true;break;}}}_13b&&_138++;}if(_138==_137.length){_135.push(obj);}}_134(_135);});};this.createXPathString=function(_13c){var _13d=_13c.callback,_13e=_13c.entity||_13c.className,_13f=_13c.context;var _140=_13f&&_13f.getContexts();if(!_140||_140.length===0){_13d("//"+_13e);return;}_6f(_13c);};this.generateExport=function(_141){window.mx.server.request({request:{action:"export",params:_141.params},options:{callback:_141.callback,error:function(e){_1d(_141.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_142,_143){if(typeof _142!="object"){throw new _1(_c+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _143!="object"){throw new _1(_c+".setObjectToContext: parameter context is not of type Object");}}try{var _144=_142.getAttributes();for(var e=0;e<_144.length;e++){if(_142.isReference(_144[e])){var _145=_142.getSelectorEntity(_144[e]);if((_144[e]=="System.owner")||(_144[e]=="System.changedBy")){continue;}if(_143.hasContext(_145)){_142.addReference(_144[e],_143.getContext(_145));}var meta=window.mx.meta.getEntity(_145);if(meta){if(meta.hasSubEntities()){var _146=meta.getSubEntities();for(var i=0;i<_146.length;i++){if(_143.hasContext(_146[i])){_142.addReference(_144[e],_143.getContext(_146[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_147){_147.type="sum";_79(_147);};this.countOfXPathSet=function(_148){_148.type="count";_79(_148);};this.sizeOfXPathSet=function(_149){_149.type="count";_79(_149);};this.avgOfXPathSet=function(_14a){_14a.type="avg";_79(_14a);};this.maxOfXPathSet=function(_14b){_14b.type="max";_79(_14b);};this.minOfXPathSet=function(_14c){_14c.type="min";_79(_14c);};this.makeChange=function(_14d,attr,_14e){var guid=_14d.getGuid();_10[guid]=_14d;delete _11[guid];var _14f=_e,_150=_14f[guid];if(_150&&_14d!=_150){_150._makeChange(attr,_14e);}else{this.update({guid:guid,attr:attr,value:_14e});}};this.xastrigger=function(_151){if(_5.itemCount(_10)===0){_151&&_151();}else{this.save({mxobj:null,callback:_151});}};};return _9;});