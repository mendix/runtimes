/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Data",["mendix/lib/ConnectionError","mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/MxObject","mendix/lang","mendix/logger","webcore/data-backend/OnlineDataBackend","webcore/data-backend/OfflineDataBackend","webcore/MxObjectCache","webcore/MxObjectBackend","dojo/_base/array","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){function _d(_e){_e=_e||{};var _f=this,_10="mendix.sys.Data",_11={entities:{},guids:{},attrs:{},vals:{}};var _12=new _7();var _13=new _a(_12,new _9(),function(_14){return !_15(_14);});var _16=_12;var _17=function(_18,_19,map){if(!_19){return _18;}for(var i in map){if((i in _19)&&(_19[i]!=null)){_18[i]=_19[i];}}return _18;};var _1a=function(_1b,_1c,_1d,_1e){try{_1b&&_1b.apply(_1c,_1d||[]);}catch(e){_6.error(_10+_1e+" : "+e.message+" "+(_1c?"("+_1c+")":""));}};var _1f=function(_20,_21,e,_22){try{if(_20){_20.call(_21,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_10+"."+_22+" while calling error handler: "+err.message);}};var _15=function(_23){var _24=_5.itemCount;return (_24(_11.guids[_23])||_24(_11.attrs[_23]));};var _25=function(_26,_27){var _28={};_b.forEach(_26.getAttributes(),function(ref){if(!_26.isReference(ref)){return;}var _29=_27.getContext(_26.getSelectorEntity(ref));if(_29){_28[ref]=_29;}});return _28;};var _2a=function(_2b,_2c,_2d,_2e){var _2f=_2c.split("/");var _30=function(_31){var _32=_2f.shift(),ref=_2f.shift(),_33;if(_31==null||_31.length==null||_31.length===0){_2d(null);return;}var _34=[];for(var i=0;i<_31.length;i++){if(_31[i]==null){continue;}_34.push("id='"+_31[i].getGuid()+"'");}if(!_34.length){_2d(null);return;}var ids=_34.join(" or ");_33="["+ref+"/"+_32+"["+ids+"]]";if(_2f.length==1){_2d(_33);}else{var _35=_2f[0];_32=_2f.shift();ref=_2f.shift();_2d("["+ref+"/"+_32+""+_33+"]");}};var _36=function(){var _37=_2f.shift(),ref=_2f.shift();if(_2f.length==1){var _38="["+ref+"='"+_2b.getGuid()+"']";_2d(_38);return;}if(window.mx.meta.getEntity(_37)==null){_1f(_2e,null,new _2(_10+".runMapPath: entity"+_37+" does not exist"),"runMapPath");return;}if(!_2b.isA(_37)){_1f(_2e,null,new _2(_10+".runMapPath: entity "+_2b.getEntity()+" is not a "+_37+" or one of its subclasses"),"runMapPath");return;}if(!_2b.has(ref)){_1f(_2e,null,new _2(_10+".runMapPath: reference "+ref+" not found in entity "+_37),"runMapPath");return;}if(_2b.get2(ref)!==""){_f.get({guids:_2b.getReferences(ref),callback:_30,error:_2e});}else{_2d(null);}};_36();};this.getBacktrackConstraints=function(_39,_3a,_3b,_3c,_3d){if(!_c.isFunction(_3c)){_3d=_3c;_3c=null;}_f.getBacktrack(_3a.getTrackId(),_3a.getConstraints(),_3b,_3c,_3d);};var _3e=this.getBacktrackConstraints;this.getBacktrack=function(_3f,_40,_41,_42,_43){if(!_c.isFunction(_42)){_43=_42;_42=null;}if(!_40||_40.length===0){_41.call(_43,"",true);return;}var _44=null,_45=[],_46=0,_47=true;var _48=function(){var _49=_40[_46++];if(_49){_2a(_44,_49,function(_4a){if(_4a){_45.push(_4a);}else{_47=false;}_48();},function(e){_1f(_42,_43,e,"getBacktrack");});}else{_41.call(_43,_45.join(""),_47);}};if(!_3f){_41.call(_43,"",false);}else{_f.get({guid:_3f,callback:function(obj){_44=obj;_48();},error:function(e){_1f(_42,_43,e,"getBacktrack");}});}};var _4b=function(_4c,_4d){var _4e=[],_4f=_25(_4c,_4d);for(var m in _4f){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_4c.has(m)){var _50=_4c.getAttributeType(m);switch(_50){case "ObjectReference":_4e.push("["+m+"='"+_4f[m]+"']");break;case "ObjectReferenceSet":_4e.push("["+m+"='"+_4f[m]+"']");break;default:}}}return _4e.join("");};var _51=function(_52){var _53=_52.entity||_52.className,_54=window.mx.meta.getEntity(_53),_55=_52.context,_56="//"+_53,_57=_4b(_54,_55);var _58=function(_59,_5a){if(_52.callback){_52.callback(_56+_57+_59,_5a);}};if(_55.getConstraints().length!==0){_3e(_54,_55,_58,_52.error);}else{_58("",true);}};var _5b=function(_5c){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_5c.type+"("+_5c.xpath+")",resulttype:_5c.resulttype||"integer"}},options:{callback:function(_5d,_5e){var _5f;if(_5e){if(_5c.resulttype=="float"){_5f=parseFloat(_5e.value).toFixed(2)||"0.00";}else{_5f=_5e.value||0;}}else{_5f=0;}_5c.callback&&_5c.callback(_5f);},error:function(e){_1f(_5c.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _60=function(_61){var _62;if(_61===""){return;}else{if(_61.match(/^\[[^=\[]+=.[0-9]+./)){_62=_b.map(_61.match(/\[.+?\]/g),function(_63){_63=_63.substr(1,_63.length-2);return {ref:_63.match(/[^=]+/)[0],ref_ids:_63.match(/\d+/)[0]};});}else{_62=_b.map(_61.match(/\[.+?\]]/g),function(_64){_64=_64.substr(1,_64.length-3);var _65=_64.split("[");return {ref:_65[0].split("/")[0],ref_ids:_65[1]};});}}return _62;};this.toString=function(){return _10;};this.setOfflineStore=function(_66,_67){_16=new _8(_66,_67,_e.offlineBackend);_13=new _a(_16,new _9(),function(_68){return !_15(_68);});};this.startup=function(){window.mx.server.registerCaller(_c.hitch(_13,"flush"));window.setInterval(_c.hitch(_13,"cleanup"),10000);};this.subscribe=function(_69,_6a){var id=_5.getUniqueId(),_6b=_69.entity,_6c=_69.guid,val=_69.val,_6d=_69.attr,_6e=_6a?function(){_69.callback.apply(_6a,arguments);}:_69.callback;if(_6d){if(!_11.attrs[_6c]){_11.attrs[_6c]={};}if(!_11.attrs[_6c][_6d]){_11.attrs[_6c][_6d]={};}_11.attrs[_6c][_6d][id]=_6e;}else{if(val){if(!_11.vals[_6c]){_11.vals[_6c]={};}_11.vals[_6c][id]=_6e;}else{if(_6c){if(!_11.guids[_6c]){_11.guids[_6c]={};}_11.guids[_6c][id]=_6e;}else{if(_6b){if(!_11.entities[_6b]){_11.entities[_6b]={};}_11.entities[_6b][id]=_6e;}else{_6.error(_10+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_6b,guid:_6c,val:val,attr:_6d,id:id};};this.unsubscribe=function(_6f){if(_6f==null){return;}var id=_6f.id,_70=_6f.entity,_71=_6f.guid,val=_6f.val,_72=_6f.attr,_73=_5.itemCount;if(_72){var _74=_11.attrs[_71];if(!_74){}else{if(!_74[_72]){}else{delete _74[_72][id];if(_73(_74[_72])===0){delete _74[_72];}if(_73(_74)===0){delete _11.attrs[_71];}}}}else{if(val){if(!_11.vals[_71]){}else{delete _11.vals[_71][id];if(_73(_11.vals[_71])===0){delete _11.vals[_71];}}}else{if(_71){var _75=_11.guids[_71];if(!_75){}else{delete _75[id];if(_73(_75)===0){delete _11.guids[_71];}}}else{if(_70){var _76=_11.entities[_70];if(!_76){}else{delete _76[id];if(_73(_76)===0){delete _11.entities[_70];}}}}}}};this.update=function(_77){var _78=_77.guid,_79=_77.entity,_7a=_77.attr,val=_77.val,_7b=_77.value,_7c=_77.callback;var _7d=function(_7e,_7f){var map=_7e?_c.clone(_7e):{};for(var key in map){map[key].apply(null,_7f);}};if(_7a){_7d(_11.attrs[_78]&&_11.attrs[_78][_7a],[_78,_7a,_7b]);}else{if(_78){_7d(_11.guids[_78],[_78]);}else{if(val){_7d(_11.vals[_78],[_78]);}else{if(_79){_7d(_11.entities[_79],[_79]);}else{_6.error(_10+".update: no 'entity' or 'guid' parameter found");}}}}_7c&&_7c();};this.objectUpdateNotification=function(_80){_f.sendClassUpdate(_80.getEntity());_f.update({guid:_80.getGuid()});};this.sendClassUpdate=function(_81){var _82=window.mx.meta.getEntity(_81);if(!_82){throw new _2("No permission to read or write entity "+_81+", check security!");}_b.forEach([_81].concat(_82.getSuperEntities()),function(ent){_f.update({entity:ent});});};this.objectPing=function(_83,_84){var _85=_83.getGuid(),_86=_c.clone(_11.guids[_85]),_87=[];if(_86){for(var sub in _86){_87.push((function(_88,sub){return function(cb){try{var _89=_88[sub];if(_89.length==2){_89(_85,cb);}else{_89(_85);cb();}}catch(e){if(_88){delete _88[sub];}cb();}};})(_86,sub));}_5.collect(_87,_84);}else{_84&&_84();}};this.sendValidationUpdates=function(_8a){var _8b,_8c=[];for(var i=0,_8d;_8d=_8a[i];i++){_8b=_11.vals[_8d.getGuid()];var cp=_8d.clone(),_8e=cp.getAttributes();if(_8b){for(var x in _8b){var _8f=_8d.clone();try{_8b[x]([_8f]);}catch(e){_6.error(_10+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _8b[x];}var _90=_8f.getAttributes();_b.forEach(_8e,function(_91){var _92=_91.name,_93=_b.some(_90,function(_94){return _94.name==_92;});if(!_93){cp.removeAttribute(_91.name);}},this);}}else{}if(cp.getAttributes().length){_8c.push(cp);}}window.mx.ui.validations(_8c);};this.action=function(_95){_13.action(_95.params,_95.context,_95.store,!!_95.async,_95.onValidation,function(_96,_97){if(_95.callback){_95.callback(_96,_97);}},function(e){_1f(_95.error,null,e,"action");});};this.setOrRetrieveMxObject=function(_98){return _13.setOrRetrieveMxObject(_98);};this.get=function(_99,_9a){var _9b=_99.xpath,_9c=_99.path,id=_99.guid,ids=(!("guids" in _99)&&id)?[id]:_99.guids,_9d=_99.callback,_9e=_99.error,_9f=!!_99.noCache,_a0=!!_99.count,_a1=_99.filter,_a2=!!_99.aggregates,_a3=_99.context,_a4=_99.microflow,err;if(("guid" in _99)&&id==null){_1a(_9d,_9a,[null],"");return;}if(!_9b&&!ids&&!_a4){err=_10+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _2(err);}if(_9c&&ids.length!=1){throw new _2(_10+".get : path can only be used with a single guid");}if(typeof _9d!="function"){err=_10+".get: callback is not a function";_6.error(err);throw new _2(err);}else{if(_9e&&typeof _9e!="function"){err=_10+".get: error is not a function";_6.error(err);throw new _2(err);}}if(_a1){if(_a1.limit){_a1.amount=_a1.limit;delete _a1.limit;}if(_a1.references){for(var r in _a1.references){var ref=_a1.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_a5=_17({},_a1,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_a6=function(e){_1f(_9e,_9a,e,"get");};if(_a5.id&&ids&&!id){delete _a5.id;}if(_a5.id){delete _a5.attributes;delete _a5.distinct;}if(_a4){var _a7=ids?"selection":(_9b?"set":"none"),_a8={actionname:_a4,applyto:_a7};if(_a7=="selection"){_a8.guids=ids;}else{if(_a7=="set"){_a8.xpath=_9b;if(_a5.sort){_a8.sort=_a5.sort;}}}this.action({params:_a8,context:_a3,callback:function(_a9,_aa){_9d&&_9d.call(_9a,_a9,_aa);},error:_a6});}else{if(_9c&&ids){_13.getByPath(ids[0],_9c,function(_ab,_ac){try{if(_9d){_9d.call(_9a,_ab,{count:_ac});}}catch(e){_6.error(_10+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_9a?"("+_9a+")":""));}},function(e){_1f(_9e,_9a,e,"get");});}else{if(ids){if(ids.length===0){_1a(_9d,_9a,[id?null:[],{count:0}],".get: error in handler");return;}_13.getByGuid(ids,_a5,!_9f,function(_ad,_ae){var _af;if(id){if(_a5.id){_af=_b.filter(_ad,function(_b0){return _b0.getGuid()===id;})[0];if(_af===undefined){_1f(_9e,_9a,new _2("Returned objects do not contain requested one"),"get");return;}}else{_af=_ad[0]||null;}}else{_af=_ad;}try{if(_9d){_9d.call(_9a,_af,{count:_ae});}}catch(e){_6.error(_10+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_9a?"("+_9a+")":""));}},function(e){_1f(_9e,_9a,e,"get");});return true;}else{_13.getByXPath(_9b,_a5,_a0,_a2,function(_b1,_b2,_b3){_1a(_9d,_9a,[_b1,{count:_b2,aggregates:_b3}],".get: error in error handler for xpath "+_9b);},_a6);return true;}}}};this.getBySchema=function(_b4,_b5){var _b6=_b4.id,_b7=_b4.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_b4},options:{callback:function(_b8,_b9){var _ba=[],_bb;_b.forEach(_b9.mxobjects,function(_bc){var _bd=new _4({json:_bc,meta:window.mx.meta.getEntity(_bc.objectType)});if(_bc.guid==_b6){_bb=_bd;}_ba.push(_bd);});_bb.attachReferences(_ba);_b7&&_b7(_bb,false);},error:function(e){_1f(_b4.error,_b5,e,"getBySchema");}}});};this.getSlice=function(_be,_bf,_c0,_c1,_c2){_13.getSlice(_be,_bf,_c0).spread(function(_c3,_c4){if(_c1){_c1(_c3,_c4);}}).caught(function(e){if(_c2){_c2(e);}else{mx.onError(e);}});};this.fetch=function(obj,_c5,_c6,_c7,_c8){if(_c.isFunction(_c6)){_c8=_c7;_c7=_c6;}var _c9;if(!_c5){_c9=[];}else{if(_c5 instanceof Array){_c9=_c5.slice();}else{_c9=_c5.split("/");}}if(obj&&obj.isA(_c9[0])){_c9.shift();}var _ca;if(_c9.length%2==1){_ca=_c9.pop();}else{_ca="";}_13.fetch(obj,_c9,_ca,_c6,_c7,_cb);function _cb(e){_1f(_c8,null,e,"fetch");};};this.release=function(_cc){if(!_cc){return;}_cc=_cc instanceof Array?_cc:[_cc];for(var i=0,len=_cc.length;i<len;++i){if(_cc[i]){_13.release(_cc[i].getGuid());}}};this.create=function(_cd,_ce){if(typeof _cd.callback!="function"){throw new _2(_10+".create: callback is not a function");}else{if(_cd.error&&typeof _cd.error!="function"){throw new _2(_10+".create: error is not a function");}else{if(typeof _cd.entity!="string"){throw new _2(_10+".create: entity is not a string");}}}_13.create(_cd.entity,_cd.persistent,function(obj){if(_cd.context){_f.setObjectToContext(obj,_cd.context);}_cd.callback.call(_ce,obj);},function(e){_1f(_cd.error,_ce,e,"create");});};this.jsonToMxObject=function(_cf){return new _4({json:_cf,meta:window.mx.meta.getEntity(_cf.objectType)});};this.remove=function(_d0){var _d1=("guid" in _d0)?[_d0.guid]:_d0.guids;if(("guids" in _d0)&&!(_d0.guids instanceof Array)){throw new _2(_10+".remove: parameter guids set but not of type Array");}else{if(_d0.error&&typeof _d0.error!="function"){throw new _2(_10+".remove: parameter error set but not of type Function");}else{if(_d0.callback&&typeof _d0.callback!="function"){throw new _2(_10+".remove: parameter callback set but not of type Function");}}}_13.remove(_d1,_d0.callback,_d2);function _d2(e){_1f(_d0.error,null,e,"remove");};};this.save=function(_d3,_d4){if(typeof _d3.callback!="function"){throw new _2(_10+".save: callback is not a function");}else{if(_d3.mxobj!=null&&!(_d3.mxobj instanceof _4)){throw new _2(_10+".save: mxobj is not an MxObject");}}_13.save(_d3.mxobj,_d3.standalone,_d3.onValidation,_d5,_d6);function _d5(){var msg=".save: error calling handler";if(_d3.mxobj){msg+=" for ["+_d3.mxobj.getGuid()+"]";}_1a(_d3.callback,_d4,null,msg);};function _d6(_d7){var err;if(_d7 instanceof Error){err=_d7;}else{if(_d7){err=new _3();_f.sendValidationUpdates([_d7.clone()]);}}_1f(_d3.error,_d4,err,"save");};};this.commit=function(_d8,_d9){if(typeof _d8!="object"){throw new _2(_10+".commit: args is not an object");}else{if(typeof _d8.callback!="function"){throw new _2(_10+".commit: callback is not a function");}else{if(_d8.mxobj!=null&&!(_d8.mxobj instanceof _4)){throw new _2(_10+".commit: mxobj is not a MxObject");}}}if(!_d8.mxobj&&_d8.callback){_1a(_d8.callback,_d9,null,".commit: error when executing handler without object");return;}_13.commit(_d8.mxobj.getGuid(),_d8.context,_d8.store,_d8.onValidation,_da,_db);function _da(){_f.objectUpdateNotification(_d8.mxobj);_1a(_d8.callback,_d9,null,".commit: error when executing handler for ["+_d8.mxobj.getGuid()+"]");};function _db(e){_1f(_d8.error,null,e,"commit");};};this.rollback=function(_dc,_dd){if(typeof _dc!="object"){throw new _2(_10+".rollback: args is not an object");}else{if(typeof _dc.callback!="function"){throw new _2(_10+".rollback: callback is not a function");}else{if(_dc.mxobj!=null&&!(_dc.mxobj instanceof _4)){throw new _2(_10+".rollback: mxobj is not a MxObject");}}}if(!_dc.mxobj){_1a(_dc.callback,_dd,null,".rollback: error in handler");return;}var _de=_dc.mxobj;var _df=_de.getEntity();var _e0=_de.getGuid();_13.rollback(_de,_e1,_e2);function _e1(_e3){if(_e3){_de.resetFromJSON(_e3.jsonData);_f.objectUpdateNotification(_e3);}_de.reset();_f.sendClassUpdate(_df);_1a(_dc.callback,_dd,null,_10+".rollback: error in handler for ["+_e0+"]");};function _e2(e){_1f(_dc.error,null,e,"rollback");};};this.synchronize=function(_e4,_e5){return _16.upload(_12).caught(function(e){if(!(e instanceof _1)){return _16.cleanupDirtyObjects().then(function(){return null;});}else{throw e;}}).then(function(_e6){return _16.download().then(function(){if(_e4){_e4(_e6);}});}).caught(function(e){if(_e5){_e5(e);}});};this.invalidateCaches=function(_e7){_13.invalidateCaches(_e7);};this.saveDocument=function(_e8,_e9,_ea,_eb,_ec){_16.saveDocument(_e8,_e9,_ea,_eb,_ec);};this.matchObjectsToContext=function(_ed){var _ee=_ed.entity,_ef=_ed.context,_f0=_ed.mxobjs,_f1=_ed.callback,_f2=[];_3e(window.mx.meta.getEntity(_ee),_ef,function(_f3){var _f4=_60(_f3);for(var i=0,obj;obj=_f0[i];i++){var _f5=0;for(var x=0,_f6;_f6=_f4[x];x++){var ref=_f6.ref,_f7=_f6.ref_ids,ids=obj.getReferences(ref),_f8=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_f7.match(ids[j])){_f8=true;break;}}}_f8&&_f5++;}if(_f5==_f4.length){_f2.push(obj);}}_f1(_f2);});};this.createXPathString=function(_f9){var _fa=_f9.callback,_fb=_f9.entity||_f9.className,_fc=_f9.context;var _fd=_fc&&_fc.getContexts();if(!_fd||_fd.length===0){_fa("//"+_fb);return;}_51(_f9);};this.generateExport=function(_fe){window.mx.server.request({request:{action:"export",params:_fe.params},options:{callback:_fe.callback,error:function(e){_1f(_fe.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_ff,_100){if(typeof _ff!="object"){throw new _2(_10+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _100!="object"){throw new _2(_10+".setObjectToContext: parameter context is not of type Object");}}try{var _101=_ff.getAttributes();for(var e=0;e<_101.length;e++){if(_ff.isReference(_101[e])){var _102=_ff.getSelectorEntity(_101[e]);if((_101[e]=="System.owner")||(_101[e]=="System.changedBy")){continue;}if(_100.hasContext(_102)){_ff.addReference(_101[e],_100.getContext(_102));}var meta=window.mx.meta.getEntity(_102);if(meta){if(meta.hasSubEntities()){var _103=meta.getSubEntities();for(var i=0;i<_103.length;i++){if(_100.hasContext(_103[i])){_ff.addReference(_101[e],_100.getContext(_103[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_104){_104.type="sum";_5b(_104);};this.countOfXPathSet=function(_105){_105.type="count";_5b(_105);};this.sizeOfXPathSet=function(_106){_106.type="count";_5b(_106);};this.avgOfXPathSet=function(_107){_107.type="avg";_5b(_107);};this.maxOfXPathSet=function(_108){_108.type="max";_5b(_108);};this.minOfXPathSet=function(_109){_109.type="min";_5b(_109);};this.makeChange=function(_10a,attr,_10b){_13.makeChange(_10a,attr,_10b);this.update({guid:_10a.getGuid(),attr:attr,value:_10a.get(attr)});};this.flush=function(_10c){_13.flush(_10c);};this.getDocumentUrl=function(guid,_10d,_10e){return _16.getDocumentUrl(guid,_10d,_10e);};};return _d;});