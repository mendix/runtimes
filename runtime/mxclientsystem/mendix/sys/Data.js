/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Data",["mendix/lib/ConnectionError","mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/MxObject","mendix/lang","mendix/logger","webcore/data-backend/OnlineDataBackend","webcore/data-backend/OfflineDataBackend","webcore/MxObjectCache","webcore/MxObjectBackend","webcore/DanglingError","webcore/Task","webcore/applicative","webcore/task-helpers","dojo/_base/array","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){function _11(_12){_12=_12||{};var _13=this,_14="mendix.sys.Data",_15={entities:{},guids:{},attrs:{},vals:{}};var _16=new _7();var _17=new _a(_16,new _9(),function(_18){return !_19(_18);});var _1a=_16;var _1b=function(_1c,_1d,map){if(!_1d){return _1c;}for(var i in map){if((i in _1d)&&(_1d[i]!=null)){_1c[i]=_1d[i];}}return _1c;};var _1e=function(_1f,_20,_21,_22){try{_1f&&_1f.apply(_20,_21||[]);}catch(e){_6.error(_14+_22+" : "+e.message+" "+(_20?"("+_20+")":""));}};var _23=function(_24,_25,e,_26){try{if(_24){_24.call(_25,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_14+"."+_26+" while calling error handler: "+err.message);}};var _19=function(_27){var _28=_5.itemCount;return (_28(_15.guids[_27])||_28(_15.attrs[_27]));};var _29=function(_2a,_2b){var _2c={};_f.forEach(_2a.getAttributes(),function(ref){if(!_2a.isReference(ref)){return;}var _2d=_2b.getContext(_2a.getSelectorEntity(ref));if(_2d){_2c[ref]=_2d;}});return _2c;};var _2e=function(_2f,_30,_31,_32){var _33=_30.split("/");var _34=function(_35){var _36=_33.shift(),ref=_33.shift(),_37;if(_35==null||_35.length==null||_35.length===0){_31(null);return;}var _38=[];for(var i=0;i<_35.length;i++){if(_35[i]==null){continue;}_38.push("id='"+_35[i].getGuid()+"'");}if(!_38.length){_31(null);return;}var ids=_38.join(" or ");_37="["+ref+"/"+_36+"["+ids+"]]";if(_33.length==1){_31(_37);}else{var _39=_33[0];_36=_33.shift();ref=_33.shift();_31("["+ref+"/"+_36+""+_37+"]");}};var _3a=function(){var _3b=_33.shift(),ref=_33.shift();if(_33.length==1){var _3c="["+ref+"='"+_2f.getGuid()+"']";_31(_3c);return;}if(window.mx.meta.getEntity(_3b)==null){_23(_32,null,new _2(_14+".runMapPath: entity"+_3b+" does not exist"),"runMapPath");return;}if(!_2f.isA(_3b)){_23(_32,null,new _2(_14+".runMapPath: entity "+_2f.getEntity()+" is not a "+_3b+" or one of its subclasses"),"runMapPath");return;}if(!_2f.has(ref)){_23(_32,null,new _2(_14+".runMapPath: reference "+ref+" not found in entity "+_3b),"runMapPath");return;}if(_2f.get2(ref)!==""){_13.get({guids:_2f.getReferences(ref),callback:_34,error:_32});}else{_31(null);}};_3a();};this.getBacktrackConstraints=function(_3d,_3e,_3f,_40,_41){if(!_10.isFunction(_40)){_41=_40;_40=null;}_13.getBacktrack(_3e.getTrackId(),_3e.getConstraints(),_3f,_40,_41);};var _42=this.getBacktrackConstraints;this.getBacktrack=function(_43,_44,_45,_46,_47){if(!_10.isFunction(_46)){_47=_46;_46=null;}if(!_44||_44.length===0){_45.call(_47,"",true);return;}var _48=null,_49=[],_4a=0,_4b=true;var _4c=function(){var _4d=_44[_4a++];if(_4d){_2e(_48,_4d,function(_4e){if(_4e){_49.push(_4e);}else{_4b=false;}_4c();},function(e){_23(_46,_47,e,"getBacktrack");});}else{_45.call(_47,_49.join(""),_4b);}};if(!_43){_45.call(_47,"",false);}else{_13.get({guid:_43,callback:function(obj){_48=obj;_4c();},error:function(e){_23(_46,_47,e,"getBacktrack");}});}};var _4f=function(_50,_51){var _52=[],_53=_29(_50,_51);for(var m in _53){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_50.has(m)){var _54=_50.getAttributeType(m);switch(_54){case "ObjectReference":_52.push("["+m+"='"+_53[m]+"']");break;case "ObjectReferenceSet":_52.push("["+m+"='"+_53[m]+"']");break;default:}}}return _52.join("");};var _55=function(_56){var _57=_56.entity||_56.className,_58=window.mx.meta.getEntity(_57),_59=_56.context,_5a="//"+_57,_5b=_4f(_58,_59);var _5c=function(_5d,_5e){if(_56.callback){_56.callback(_5a+_5b+_5d,_5e);}};if(_59.getConstraints().length!==0){_42(_58,_59,_5c,_56.error);}else{_5c("",true);}};var _5f=function(_60){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_60.type+"("+_60.xpath+")",resulttype:_60.resulttype||"integer"}},options:{callback:function(_61,_62){var _63;if(_62){if(_60.resulttype=="float"){_63=parseFloat(_62.value).toFixed(2)||"0.00";}else{_63=_62.value||0;}}else{_63=0;}_60.callback&&_60.callback(_63);},error:function(e){_23(_60.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _64=function(_65){var _66;if(_65===""){return;}else{if(_65.match(/^\[[^=\[]+=.[0-9]+./)){_66=_f.map(_65.match(/\[.+?\]/g),function(_67){_67=_67.substr(1,_67.length-2);return {ref:_67.match(/[^=]+/)[0],ref_ids:_67.match(/\d+/)[0]};});}else{_66=_f.map(_65.match(/\[.+?\]]/g),function(_68){_68=_68.substr(1,_68.length-3);var _69=_68.split("[");return {ref:_69[0].split("/")[0],ref_ids:_69[1]};});}}return _66;};this.toString=function(){return _14;};this.setOfflineStore=function(_6a,_6b){_1a=new _8(_6a,_6b,_12.offlineBackend);_17=new _a(_1a,new _9(),function(_6c){return !_19(_6c);});};this.startup=function(){window.mx.server.registerCaller(_10.hitch(_17,"flush"));window.setInterval(_10.hitch(_17,"cleanup"),10000);};this.subscribe=function(_6d,_6e){var id=_5.getUniqueId(),_6f=_6d.entity,_70=_6d.guid,val=_6d.val,_71=_6d.attr,_72=_6d.async,_73=_6e?function(){_6d.callback.apply(_6e,arguments);}:_6d.callback;var _74={handler:_73,async:_72};if(_71){if(!_15.attrs[_70]){_15.attrs[_70]={};}if(!_15.attrs[_70][_71]){_15.attrs[_70][_71]={};}_15.attrs[_70][_71][id]=_74;}else{if(val){if(!_15.vals[_70]){_15.vals[_70]={};}_15.vals[_70][id]=_74;}else{if(_70){if(!_15.guids[_70]){_15.guids[_70]={};}_15.guids[_70][id]=_74;}else{if(_6f){if(!_15.entities[_6f]){_15.entities[_6f]={};}_15.entities[_6f][id]=_74;}else{_6.error(_14+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_6f,guid:_70,val:val,attr:_71,id:id};};this.unsubscribe=function(_75){if(_75==null){return;}var id=_75.id,_76=_75.entity,_77=_75.guid,val=_75.val,_78=_75.attr,_79=_5.itemCount;if(_78){var _7a=_15.attrs[_77];if(!_7a){}else{if(!_7a[_78]){}else{delete _7a[_78][id];if(_79(_7a[_78])===0){delete _7a[_78];}if(_79(_7a)===0){delete _15.attrs[_77];}}}}else{if(val){if(!_15.vals[_77]){}else{delete _15.vals[_77][id];if(_79(_15.vals[_77])===0){delete _15.vals[_77];}}}else{if(_77){var _7b=_15.guids[_77];if(!_7b){}else{delete _7b[id];if(_79(_7b)===0){delete _15.guids[_77];}}}else{if(_76){var _7c=_15.entities[_76];if(!_7c){}else{delete _7c[id];if(_79(_7c)===0){delete _15.entities[_76];}}}}}}};this.update=function(_7d){var _7e=_7d.guid,_7f=_7d.entity,_80=_7d.attr,val=_7d.val,_81=_7d.value,_82=_7d.callback;var _83=function(_84,_85,_86){var map=_84?_10.clone(_84):{};_5.collect(Object.keys(map).map(function(key){if(map[key].async){return function(cb){map[key].handler.apply(null,_85.concat([cb]));};}else{return function(cb){map[key].handler.apply(null,_85);cb();};}}),_86);};if(_80){_83(_15.attrs[_7e]&&_15.attrs[_7e][_80],[_7e,_80,_81],_82);}else{if(_7e){_83(_15.guids[_7e],[_7e],_82);}else{if(val){_83(_15.vals[_7e],[_7e],_82);}else{if(_7f){_83(_15.entities[_7f],[_7f],_82);}else{_6.error(_14+".update: no 'entity' or 'guid' parameter found");}}}}};this.objectUpdateNotification=function(_87){_13.sendClassUpdate(_87.getEntity());_13.update({guid:_87.getGuid()});};this.sendClassUpdate=function(_88,_89){var _8a=window.mx.meta.getEntity(_88);if(!_8a){throw new _2("No permission to read or write entity "+_88+", check security!");}var _8b=[_88].concat(_8a.getSuperEntities()).map(function(ent){return function(cb){_13.update({entity:ent,callback:cb});};});_5.collect(_8b,_89);};this.sendValidationUpdates=function(_8c){var _8d,_8e=[];for(var i=0,_8f;_8f=_8c[i];i++){_8d=_15.vals[_8f.getGuid()];var cp=_8f.clone(),_90=cp.getAttributes();if(_8d){for(var x in _8d){var _91=_8f.clone();try{_8d[x].handler([_91]);}catch(e){_6.error(_14+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _8d[x];}var _92=_91.getAttributes();_f.forEach(_90,function(_93){var _94=_93.name,_95=_f.some(_92,function(_96){return _96.name==_94;});if(!_95){cp.removeAttribute(_93.name);}},this);}}else{}if(cp.getAttributes().length){_8e.push(cp);}}window.mx.ui.validations(_8e);};this.action=function(_97){_17.action(_97.params,_97.context,_97.store,!!_97.async,_97.onValidation,function(_98,_99){if(_97.callback){_97.callback(_98,_99);}},function(e){_23(_97.error,null,e,"action");});};this.setOrRetrieveMxObject=function(_9a){return _17.setOrRetrieveMxObject(_9a);};this.get=function(_9b,_9c){var _9d=_9b.xpath,_9e=_9b.path,id=_9b.guid,ids=(!("guids" in _9b)&&id)?[id]:_9b.guids,_9f=_9b.callback,_a0=_9b.error,_a1=!!_9b.noCache,_a2=!!_9b.count,_a3=_9b.filter,_a4=!!_9b.aggregates,_a5=_9b.context,_a6=_9b.microflow,err;if(("guid" in _9b)&&id==null){_1e(_9f,_9c,[null],"");return;}if(!_9d&&!ids&&!_a6){err=_14+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _2(err);}if(_9e&&ids.length!=1){throw new _2(_14+".get : path can only be used with a single guid");}if(typeof _9f!="function"){err=_14+".get: callback is not a function";_6.error(err);throw new _2(err);}else{if(_a0&&typeof _a0!="function"){err=_14+".get: error is not a function";_6.error(err);throw new _2(err);}}if(_a3){if(_a3.limit){_a3.amount=_a3.limit;delete _a3.limit;}if(_a3.references){for(var r in _a3.references){var ref=_a3.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_a7=_1b({},_a3,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_a8=function(e){_23(_a0,_9c,e,"get");};if(_a7.id&&ids&&!id){delete _a7.id;}if(_a7.id){delete _a7.attributes;delete _a7.distinct;}if(_a6){var _a9=ids?"selection":(_9d?"set":"none"),_aa={actionname:_a6,applyto:_a9};if(_a9=="selection"){_aa.guids=ids;}else{if(_a9=="set"){_aa.xpath=_9d;if(_a7.sort){_aa.sort=_a7.sort;}}}this.action({params:_aa,context:_a5,callback:function(_ab,_ac){_9f&&_9f.call(_9c,_ab,_ac);},error:_a8});}else{if(_9e&&ids){_17.getByPath(ids[0],_9e,_9b.entity,function(_ad,_ae){try{if(_9f){_9f.call(_9c,_ad,{count:_ae});}}catch(e){_6.error(_14+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_9c?"("+_9c+")":""));}},function(e){_23(_a0,_9c,e,"get");});}else{if(ids){if(ids.length===0){_1e(_9f,_9c,[id?null:[],{count:0}],".get: error in handler");return;}_17.getByGuid(ids,_a7,!_a1,function(_af,_b0){var _b1;if(id){if(_a7.id){_b1=_f.filter(_af,function(_b2){return _b2.getGuid()===id;})[0];if(_b1===undefined){_23(_a0,_9c,new _2("Returned objects do not contain requested one"),"get");return;}}else{_b1=_af[0]||null;}}else{_b1=_af;}try{if(_9f){_9f.call(_9c,_b1,{count:_b0});}}catch(e){_6.error(_14+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_9c?"("+_9c+")":""));}},function(e){_23(_a0,_9c,e,"get");});return true;}else{_17.getByXPath(_9d,_a7,_a2,_a4,function(_b3,_b4,_b5){_1e(_9f,_9c,[_b3,{count:_b4,aggregates:_b5}],".get: error in error handler for xpath "+_9d);},_a8);return true;}}}};this.getBySchema=function(_b6,_b7){var _b8=_b6.id,_b9=_b6.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_b6},options:{callback:function(_ba,_bb){var _bc=[],_bd;_f.forEach(_bb.mxobjects,function(_be){var _bf=new _4({json:_be,meta:window.mx.meta.getEntity(_be.objectType)});if(_be.guid==_b8){_bd=_bf;}_bc.push(_bf);});_bd.attachReferences(_bc);_b9&&_b9(_bd,false);},error:function(e){_23(_b6.error,_b7,e,"getBySchema");}}});};this.getSlice=function(_c0,_c1,_c2,_c3,_c4){_17.getSlice(_c0,_c1,_c2).spread(function(_c5,_c6){if(_c3){_c3(_c5,_c6);}}).caught(function(e){if(_c4){_c4(e);}else{mx.onError(e);}});};this.fetch=function(obj,_c7,_c8,_c9,_ca){if(_10.isFunction(_c8)){_ca=_c9;_c9=_c8;}var _cb;if(!_c7){_cb=[];}else{if(_c7 instanceof Array){_cb=_c7.slice();}else{_cb=_c7.split("/");}}if(obj&&obj.isA(_cb[0])){_cb.shift();}var _cc;if(_cb.length%2==1){_cc=_cb.pop();}else{_cc="";}_17.fetch(obj,_cb,_cc,_c8,_c9,_cd);function _cd(e){_23(_ca,null,e,"fetch");};};this.release=function(_ce){if(!_ce){return;}_ce=_ce instanceof Array?_ce:[_ce];for(var i=0,len=_ce.length;i<len;++i){if(_ce[i]){_17.release(_ce[i].getGuid());}}};this.create=function(_cf,_d0){if(typeof _cf.callback!="function"){throw new _2(_14+".create: callback is not a function");}else{if(_cf.error&&typeof _cf.error!="function"){throw new _2(_14+".create: error is not a function");}else{if(typeof _cf.entity!="string"){throw new _2(_14+".create: entity is not a string");}}}_17.create(_cf.entity,_cf.persistent,function(obj){if(_cf.context){_13.setObjectToContext(obj,_cf.context);}_cf.callback.call(_d0,obj);},function(e){_23(_cf.error,_d0,e,"create");});};this.jsonToMxObject=function(_d1){return new _4({json:_d1,meta:window.mx.meta.getEntity(_d1.objectType)});};this.remove=function(_d2){var _d3=("guid" in _d2)?[_d2.guid]:_d2.guids;if(("guids" in _d2)&&!(_d2.guids instanceof Array)){throw new _2(_14+".remove: parameter guids set but not of type Array");}else{if(_d2.error&&typeof _d2.error!="function"){throw new _2(_14+".remove: parameter error set but not of type Function");}else{if(_d2.callback&&typeof _d2.callback!="function"){throw new _2(_14+".remove: parameter callback set but not of type Function");}}}_17.remove(_d3,_d2.callback,_d4);function _d4(e){_23(_d2.error,null,e,"remove");};};this.save=function(_d5,_d6){if(typeof _d5.callback!="function"){throw new _2(_14+".save: callback is not a function");}else{if(_d5.mxobj!=null&&!(_d5.mxobj instanceof _4)){throw new _2(_14+".save: mxobj is not an MxObject");}}_17.save(_d5.mxobj,_d5.standalone,_d5.onValidation,_d7,_d8);function _d7(){var msg=".save: error calling handler";if(_d5.mxobj){msg+=" for ["+_d5.mxobj.getGuid()+"]";}_1e(_d5.callback,_d6,null,msg);};function _d8(_d9){var err;if(_d9 instanceof Error){err=_d9;}else{if(_d9){err=new _3();_13.sendValidationUpdates([_d9.clone()]);}}_23(_d5.error,_d6,err,"save");};};this.commit=function(_da,_db){if(typeof _da!="object"){throw new _2(_14+".commit: args is not an object");}else{if(typeof _da.callback!="function"){throw new _2(_14+".commit: callback is not a function");}else{if(_da.mxobj!=null&&!(_da.mxobj instanceof _4)){throw new _2(_14+".commit: mxobj is not a MxObject");}}}if(!_da.mxobj&&_da.callback){_1e(_da.callback,_db,null,".commit: error when executing handler without object");return;}_17.commit(_da.mxobj.getGuid(),_da.context,_da.store,_da.onValidation,_dc,_dd);function _dc(){_13.objectUpdateNotification(_da.mxobj);_1e(_da.callback,_db,null,".commit: error when executing handler for ["+_da.mxobj.getGuid()+"]");};function _dd(e){_23(_da.error,null,e,"commit");};};this.rollback=function(_de,_df){if(typeof _de!="object"){throw new _2(_14+".rollback: args is not an object");}else{if(typeof _de.callback!="function"){throw new _2(_14+".rollback: callback is not a function");}else{if(_de.mxobj!=null&&!(_de.mxobj instanceof _4)){throw new _2(_14+".rollback: mxobj is not a MxObject");}}}if(!_de.mxobj){_1e(_de.callback,_df,null,".rollback: error in handler");return;}var _e0=_de.mxobj;var _e1=_e0.getEntity();var _e2=_e0.getGuid();_17.rollback(_e0,_e3,_e4);function _e3(_e5){if(_e5){_e0.resetFromJSON(_e5.jsonData);_13.objectUpdateNotification(_e5);}_e0.reset();_13.sendClassUpdate(_e1);_1e(_de.callback,_df,null,_14+".rollback: error in handler for ["+_e2+"]");};function _e4(e){_23(_de.error,null,e,"rollback");};};this.synchronizeDataWithFiles=function(_e6,_e7){var _e8=this._createSynchronizeTask().chain(function(_e9){var _ea=Object.keys(_e9).map(function(_eb){return _e9[_eb];});return _d.sequence_(_ea,_c);});_e.callbackFromTask(_e8,_e6,_e7);};this.synchronizeData=function(_ec,_ed){_e.callbackFromTask(this._createSynchronizeTask(),_ec,_ed);};this.uploadDataWithReset=function(_ee,_ef){var _f0=this._createUploadTask().chain(function(){return _1a.reset();});_e.callbackFromTask(_f0,_ee,_ef);};this._createSynchronizeTask=function(){return this._createUploadTask().chain(function(){return _1a.download();});};this._createUploadTask=function(){return _1a.upload(_16).chain(function(_f1){var _f2=Object.keys(_f1).map(function(_f3){return _f1[_f3];});return _d.sequence_(_f2,_c);}).chain(function(){_17.clearCache();return _c.of();}).orElse(function(e){if(!(e instanceof _1)&&!(e instanceof _b)){return _1a.cleanupDirtyObjects();}else{return _c.rejected(e);}});};this.invalidateCaches=function(_f4){_17.invalidateCaches(_f4);};this.saveDocument=function(_f5,_f6,_f7,_f8,_f9,_fa){_17.saveDocument(_f5,_f6,_f7,_f8,_f9,_fa);};this.matchObjectsToContext=function(_fb){var _fc=_fb.entity,_fd=_fb.context,_fe=_fb.mxobjs,_ff=_fb.callback,_100=[];_42(window.mx.meta.getEntity(_fc),_fd,function(_101){var _102=_64(_101);for(var i=0,obj;obj=_fe[i];i++){var _103=0;for(var x=0,_104;_104=_102[x];x++){var ref=_104.ref,_105=_104.ref_ids,ids=obj.getReferences(ref),_106=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_105.match(ids[j])){_106=true;break;}}}_106&&_103++;}if(_103==_102.length){_100.push(obj);}}_ff(_100);});};this.createXPathString=function(_107){var _108=_107.callback,_109=_107.entity||_107.className,_10a=_107.context;var _10b=_10a&&_10a.getContexts();if(!_10b||_10b.length===0){_108("//"+_109);return;}_55(_107);};this.generateExport=function(_10c){window.mx.server.request({request:{action:"export",params:_10c.params},options:{callback:_10c.callback,error:function(e){_23(_10c.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_10d,_10e){if(typeof _10d!="object"){throw new _2(_14+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _10e!="object"){throw new _2(_14+".setObjectToContext: parameter context is not of type Object");}}try{var _10f=_10d.getAttributes();for(var e=0;e<_10f.length;e++){if(_10d.isReference(_10f[e])){var _110=_10d.getSelectorEntity(_10f[e]);if((_10f[e]=="System.owner")||(_10f[e]=="System.changedBy")){continue;}if(_10e.hasContext(_110)){_10d.addReference(_10f[e],_10e.getContext(_110));}var meta=window.mx.meta.getEntity(_110);if(meta){if(meta.hasSubEntities()){var _111=meta.getSubEntities();for(var i=0;i<_111.length;i++){if(_10e.hasContext(_111[i])){_10d.addReference(_10f[e],_10e.getContext(_111[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_112){_112.type="sum";_5f(_112);};this.countOfXPathSet=function(_113){_113.type="count";_5f(_113);};this.sizeOfXPathSet=function(_114){_114.type="count";_5f(_114);};this.avgOfXPathSet=function(_115){_115.type="avg";_5f(_115);};this.maxOfXPathSet=function(_116){_116.type="max";_5f(_116);};this.minOfXPathSet=function(_117){_117.type="min";_5f(_117);};this.makeChange=function(_118,attr,_119){_17.makeChange(_118,attr,_119);this.update({guid:_118.getGuid(),attr:attr,value:_118.get(attr)});};this.flush=function(_11a){_17.flush(_11a);};this.getDocumentUrl=function(guid,_11b,_11c){return _1a.getDocumentUrl(guid,_11b,_11c);};};return _11;});