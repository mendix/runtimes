
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Data",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mendix.sys.Data");mendix.sys.Data=function(_4){_4=_4||{};var _5=this,_6="mendix.sys.Data",_7=false,_8={},_9={},_a={},_b={},_c=null,_d=null,_e={entities:{},guids:{},attrs:{},vals:{}};var _f=function(_10,_11,map){if(!_11){return _10;}for(var i in map){if((i in _11)&&(_11[i]!=null)){_10[i]=_11[i];}}return _10;};var _12=function(_13,_14,_15,_16){try{_13&&_13.apply(_14,_15||[]);}catch(e){logger.error(_6+_16+" : "+e.message+" "+(_14?"("+_14+")":""));}};var _17=function(_18,_19,e,_1a){try{if(_18){_18.call(_19,e);}else{logger.error("unhandled error: "+e.message);mx.onError(e);}}catch(err){logger.error("error in "+_6+"."+_1a+" while calling error handler: "+err.message);}};var _1b=function(ids){var _1c=[];for(var i=0,id;id=ids[i++];){if(_8[id]!==undefined){_1c.push(_8[id]);}}return _1c;};var _1d=function(_1e){var _1f=mendix.lang.itemCount;return (_1f(_e.guids[_1e])||_1f(_e.attrs[_1e]));};var _20=function(_21){var _22=0;for(var i=0,_23;_23=_21[i];i++){if(_8[_23]&&!_1d(_23)){delete _8[_23];delete _b[_23];delete _9[_23];mx.server.release(_23);_22++;}}};var _24=function(_25,_26,_27,_28){var _29=mendix.lib.MxObject,_2a=[],_2b=[],_2c=false;if(!(_28 instanceof Array)){_2c=!!_28;_28=[];}for(var i=0,_2d;_2d=_25[i];++i){var _2e=_2d.guid,_2f=_8[_2e],inc=(_2c||_1.indexOf(_28,_2e)>=0)?1:0;if(!_26){delete _b[_2e];}if(_27&&_2f){if(!_26||!_2f.hasChanges()){_2f.resetFromJSON(_2d);}_9[_2e]+=inc;_2a.push(_2f);}else{var obj=new _29({json:_2d,meta:mx.meta.getEntity(_2d.objectType)});if(_27){_8[_2e]=obj;_9[_2e]=inc;}if(_2f){_2b.push(_2f.getGuid());}_2a.push(obj);}}if(!_27){_20(_2b);}return _2a;};var _30=function(_31,_32,_33){var _34=function(_35,_36,evt){var _37;if(_36.mxobject){_37=[_36.mxobject];}else{if(_36.mxobjects&&_36.mxobjects.mxobjects){_37=_36.mxobjects.mxobjects;if(!_37.length){_37=[_37];}}else{_37=_36.mxobjects;}}var _38=(_37&&_37.length)?_24(_37,true,_32,_33):[];_31(_38,{count:_36.count,aggregates:_36.aggregates});};return _34;};var _39=function(_3a,_3b){var obj=_3b,_3c=_3a.getGuid(),_3d=_8[_3c];if(obj){if(_3d){_3d.resetFromJSON(obj.jsonData);}else{_3d=_8[_3c]=obj;_9[_3c]=0;}if(_3a!=_3d){_3a.resetFromJSON(obj.jsonData);}_5.objectUpdateNotification(obj);}else{_8[_3c]=null;if(_3d){_3d.resetFromJSON(null);}}};var _3e=function(_3f,_40){var _41={};_1.forEach(_3f.getAttributes(),function(ref){if(!_3f.isReference(ref)){return;}var _42=_40.getContext(_3f.getSelectorEntity(ref));if(_42){_41[ref]=_42;}});return _41;};var _43=function(_44,_45,_46,_47){var _48=_45.split("/");var _49=function(_4a){var _4b=_48.shift(),ref=_48.shift(),_4c="";if(_4a==null||_4a.length==null||_4a.length===0){_46(null);return;}var _4d=[];for(var i=0;i<_4a.length;i++){if(_4a[i]==null){continue;}_4d.push("id='"+_4a[i].getGuid()+"'");}if(!_4d.length){_46(null);return;}var ids=_4d.join(" or ");_4c="["+ref+"/"+_4b+"["+ids+"]]";if(_48.length==1){_46(_4c);}else{var _4e=_48[0];_4b=_48.shift();ref=_48.shift();_46("["+ref+"/"+_4b+""+_4c+"]");}};var _4f=function(){var _50=_48.shift(),ref=_48.shift(),_51;if(_48.length==1){var _52="["+ref+"='"+_44.getGuid()+"']";_46(_52);return;}if(mx.meta.getEntity(_50)==null){_17(_47,null,new mendix.lib.Error(_6+".runMapPath: entity"+_50+" does not exist"),"runMapPath");return;}if(!_44.isA(_50)){_17(_47,null,new mendix.lib.Error(_6+".runMapPath: entity "+_44.getEntity()+" is not a "+_50+" or one of its subclasses"),"runMapPath");return;}if(!_44.has(ref)){_17(_47,null,new mendix.lib.Error(_6+".runMapPath: reference "+ref+" not found in entity "+_50),"runMapPath");return;}if(_44.get(ref)!==""){_5.get({guids:_44.getReferences(ref),callback:_49,error:_47});}else{_46(null);}};_4f();};var _53=this.getBacktrackConstraints=function(_54,_55,_56,_57,_58){if(!_1.isFunction(_57)){_58=_57;_57=null;}_5.getBacktrack(_55.getTrackId(),_55.getConstraints(),_56,_57,_58);};this.getBacktrack=function(_59,_5a,_5b,_5c,_5d){if(!_1.isFunction(_5c)){_5d=_5c;_5c=null;}if(!_5a||_5a.length===0){_5b.call(_5d,"",true);return;}var _5e=null,_5f=[],_60=0,_61=true;var _62=function(){var _63=_5a[_60++];if(_63){_43(_5e,_63,function(_64){if(_64){_5f.push(_64);}else{_61=false;}_62();},function(e){_17(_5c,_5d,e,"getBacktrack");});}else{_5b.call(_5d,_5f.join(""),_61);}};if(!_59){_5b.call(_5d,"",false);}else{_5.get({guid:_59,callback:function(obj){_5e=obj;_62();},error:function(e){_17(_5c,_5d,e,"getBacktrack");}});}};var _65=function(_66,_67){var _68=[],_69=_3e(_66,_67);for(var m in _69){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_66.has(m)){var _6a=_66.getAttributeType(m);switch(_6a){case "ObjectReference":_68.push("["+m+"='"+_69[m]+"']");break;case "ObjectReferenceSet":_68.push("["+m+"='"+_69[m]+"']");break;default:}}}return _68.join("");};var _6b=function(_6c){var _6d=_6c.entity||_6c.className,_6e=mx.meta.getEntity(_6d),_6f=_6c.context,_70="//"+_6d,_71=_65(_6e,_6f);var _72=function(_73,_74){if(_6c.callback){_6c.callback(_70+_71+_73,_74);}};if(_6f.getConstraints().length!==0){_53(_6e,_6f,_72,_6c.error);}else{_72("",true);}};var _75=function(_76){mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_76.type+"("+_76.xpath+")",resulttype:_76.resulttype||"integer"}},options:{callback:function(_77,_78,evt){var _79;if(_78){if(_76.resulttype=="float"){_79=parseFloat(_78.value).toFixed(2)||"0.00";}else{_79=_78.value||0;}}else{_79=0;}_76.callback&&_76.callback(_79);},error:function(e){_17(_76.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _7a=function(_7b){var _7c;if(_7b===""){return;}else{if(_7b.match(/^\[[^=\[]+=.[0-9]+./)){_7c=_1.map(_7b.match(/\[.+?\]/g),function(_7d){_7d=_7d.substr(1,_7d.length-2);return {ref:_7d.match(/[^=]+/)[0],ref_ids:_7d.match(/\d+/)[0]};});}else{_7c=_1.map(_7b.match(/\[.+?\]]/g),function(_7e){_7e=_7e.substr(1,_7e.length-3);var _7f=_7e.split("[");return {ref:_7f[0].split("/")[0],ref_ids:_7f[1]};});}}return _7c;};var _80=function(){var _81=0;for(var _82 in _8){if(_9[_82]===0&&!_1d(_82)){delete _8[_82];delete _9[_82];delete _b[_82];mx.server.release(_82);}else{++_81;}}};this.toString=function(){return _6;};this.startup=function(_83){_7=true;_c=mx.server.registerCaller(_1.hitch(this,"xastrigger"));_d=window.setInterval(function(){_80();},10000);_83();};this.shutdown=function(){_7=false;_8={};_b={};_9={};clearInterval(_d);mx.server.unregisterCaller(_c);};this.isLoaded=function(){return _7;};this.subscribe=function(_84,_85){var id=mendix.lang.getUniqueId(),_86=_84.entity,_87=_84.guid,val=_84.val,_88=_84.attr,_89=_85?function(){_84.callback.apply(_85,arguments);}:_84.callback;if(_88){if(!_e.attrs[_87]){_e.attrs[_87]={};}if(!_e.attrs[_87][_88]){_e.attrs[_87][_88]={};}_e.attrs[_87][_88][id]=_89;}else{if(val){if(!_e.vals[_87]){_e.vals[_87]={};}_e.vals[_87][id]=_89;}else{if(_87){if(!_e.guids[_87]){_e.guids[_87]={};}_e.guids[_87][id]=_89;}else{if(_86){if(!_e.entities[_86]){_e.entities[_86]={};}_e.entities[_86][id]=_89;}else{logger.error(_6+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_86,guid:_87,val:val,attr:_88,id:id};};this.unsubscribe=function(_8a){if(_8a==null){return;}var id=_8a.id,_8b=_8a.entity,_8c=_8a.guid,val=_8a.val,_8d=_8a.attr,_8e=mendix.lang.itemCount;if(_8d){var _8f=_e.attrs[_8c];if(!_8f){}else{if(!_8f[_8d]){}else{delete _8f[_8d][id];if(_8e(_8f[_8d])===0){delete _8f[_8d];}if(_8e(_8f)===0){delete _e.attrs[_8c];}}}}else{if(val){if(!_e.vals[_8c]){}else{delete _e.vals[_8c][id];if(_8e(_e.vals[_8c])===0){delete _e.vals[_8c];}}}else{if(_8c){var _90=_e.guids[_8c];if(!_90){}else{delete _90[id];if(_8e(_90)===0){delete _e.guids[_8c];}}}else{if(_8b){var _91=_e.entities[_8b];if(!_91){}else{delete _91[id];if(_8e(_91)===0){delete _e.entities[_8b];}}}}}}};this.update=function(_92){var _93=_92.guid,_94=_92.entity,_95=_92.attr,val=_92.val,_96=_92.value,_97=_92.callback;var _98=function(_99,_9a){var map=_99?_1.clone(_99):{};for(var key in map){map[key].apply(null,_9a);}};if(_95){_98(_e.attrs[_93]&&_e.attrs[_93][_95],[_93,_95,_96]);}else{if(_93){_98(_e.guids[_93],[_93]);}else{if(val){_98(_e.vals[_93],[_93]);}else{if(_94){_98(_e.entities[_94],[_94]);}else{logger.error(_6+".update: no 'entity' or 'guid' parameter found");}}}}_97&&_97();};this.objectUpdateNotification=function(_9b){_5.sendClassUpdate(_9b.getEntity());_5.update({guid:_9b.getGuid()});};this.sendClassUpdate=function(_9c){var _9d=mx.meta.getEntity(_9c);if(!_9d){throw new mendix.lib.Error("No permission to read or write entity "+_9c+", check security!");}_1.forEach([_9c].concat(_9d.getSuperEntities()),function(ent){_5.update({entity:ent});});};this.objectPing=function(_9e,_9f){var _a0=_9e.getGuid(),_a1=_1.clone(_e.guids[_a0]),_a2=[];if(_a1){for(var sub in _a1){_a2.push((function(_a3,sub){return function(cb){try{var _a4=_a3[sub];if(_a4.length==2){_a4(_a0,cb);}else{_a4(_a0);cb();}}catch(e){if(_a3){delete _a3[sub];}cb();}};})(_a1,sub));}mendix.lang.collect(_a2,_9f);}else{_9f&&_9f();}};this.addValidation=function(_a5,_a6,_a7){if(!_b[_a5]){_b[_a5]=new mendix.lib.ObjectValidation({msg:{guid:_a5}});}_b[_a5].addField(_a6,_a7);};this.sendValidationUpdates=function(_a8){var _a9,_aa,_ab=[];for(var i=0,_ac;_ac=_a8[i];i++){_aa=_e.vals[_ac.getGuid()];var cp=_ac.clone(),_ad=cp.getAttributes();if(_aa){for(var x in _aa){var _ae=_ac.clone();try{_aa[x]([_ae]);}catch(e){logger.error(_6+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _aa[x];}var _af=_ae.getAttributes();_1.forEach(_ad,function(_b0){var _b1=_b0.name,_b2=_1.some(_af,function(_b3){return _b3.name==_b1;});if(!_b2){cp.removeAttribute(_b0.name);}},this);}}else{}if(cp.getAttributes().length){_ab.push(cp);}}mx.ui.validations(_ab);};this.action=function(_b4){var _b5=_b4.context,_b6=_b4.callback,_b7=_b4.error,_b8=_b4.onValidation,_b9=!!_b4.async,_ba=_b4.params,_bb=_b4.store;var _bc=function(e){_17(_b7,null,e,"action");};mx.server.request({request:{action:"executeaction",params:_ba,context:_b5},options:{callback:function(_bd,_be,_bf){var _c0=_be.actionResult,_c1;if(_c0 instanceof Array){_c1=_24(_c0,false,true,true);}else{if(typeof _c0=="object"&&_c0.guid){_c1=_24([_c0],false,true,true);}else{_c1=_be.actionResult;}}_b6&&_b6(_c1,_bf);},error:_bc,store:_bb,async:_b9,onValidation:_b8}});};this.setOrRetrieveMxObject=function(_c2){return _24([_c2],false,true)[0];};this.get=function(_c3,_c4){var _c5=_c3.xpath,_c6=_c3.path,id=_c3.guid,ids=(!("guids" in _c3)&&id)?[id]:_c3.guids,_c7=_c3.callback,_c8=_c3.error,_c9=!!_c3.noCache,_ca=!!_c3.count,_cb=_c3.filter,_cc=!!_c3.aggregates,_cd=_c3.context,_ce=_c3.microflow,err;if(("guid" in _c3)&&id==null){_12(_c7,_c4,[null],"");return;}if(!_c5&&!ids&&!_ce){err=_6+".get: xpath, guid|guids and microflow arguments are undefined";logger.error(err);throw new Error(err);}if(_c6&&ids.length!=1){throw new Error(_6+".get : path can only be used with a single guid");}if(typeof _c7!="function"){err=_6+".get: callback is not a function";logger.error(err);throw new Error(err);}else{if(_c8&&typeof _c8!="function"){err=_6+".get: error is not a function";logger.error(err);throw new Error(err);}}if(_cb){if(_cb.limit){_cb.amount=_cb.limit;delete _cb.limit;}if(_cb.references){for(var r in _cb.references){var ref=_cb.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_cf=_f({},_cb,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_d0=function(e){_17(_c8,_c4,e,"get");};if(_cf.id&&ids&&!id){delete _cf.id;}if(_cf.id){delete _cf.attributes;delete _cf.distinct;}if(_ce){var _d1=ids?"selection":(_c5?"set":"none"),_d2={actionname:_ce,applyto:_d1};if(_d1=="selection"){_d2.guids=ids;}else{if(_d1=="set"){_d2.xpath=_c5;if(_cf.sort){_d2.sort=_cf.sort;}}}this.action({params:_d2,context:_cd,callback:function(_d3,_d4){_c7&&_c7.call(_c4,_d3,_d4);},error:_d0});}else{if(_c6&&ids){mx.server.request({request:{action:"retrieve_by_path",params:{id:ids[0],path:_c6},context:null},options:{callback:_30(function(_d5,_d6){_12(_c7,_c4,[_d5,_d6],".get: error in handler for ["+ids+"]");},true,true),error:_d0}});}else{if(ids){if(ids.length===0){_12(_c7,_c4,[id?null:[],{count:0}],".get: error in handler");return;}if(!_c9){var _d7=_1b(ids),_d8=_d7.length==ids.length;if(_d8){var _d9=_d7;if(_cf.sort){_1.forEach(_cf.sort,function(_da){var _db=_da[0],dir=_da[1];_d9=_d9.sort(dir=="asc"?function(a,b){a=a.get(_db);b=b.get(_db);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get(_db);b=b.get(_db);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _dc=_cf.offset;if(_dc){var _dd=_cf.amount;if(_dd){_d9=_d9.slice(_dc,_dc+_dd);}else{_d9=_d9.slice(_dc);}}for(var i=0,_de;_de=_d9[i];++i){++_9[_de];}_12(_c7,_c4,[id?_d9[0]:_d9,{count:_d7.length}],".get: error in handler for ["+ids+"]");return true;}}var _df=_cf.attributes==null;mx.server.request({request:{action:"retrieve_by_ids",params:{ids:ids,schema:_cf}},options:{callback:_30(function(_e0,_e1){var _e2=_e0[0];if(id&&_cf.id){for(var i=0,obj;obj=_e0[i];++i){if(obj.getGuid()==id){_e2=obj;break;}}}_12(_c7,_c4,[id?_e2:_e0,_e1],".get: error in handler for ["+ids+"]");},_df,ids),error:_d0}});return true;}else{mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_c5,schema:_cf,count:_ca,aggregates:_cc}},options:{callback:_30(function(_e3,_e4){_12(_c7,_c4,[_e3,_e4],".get: error in error handler for xpath "+_c5);},false),error:_d0}});return true;}}}};this.getBySchema=function(_e5,_e6){var _e7=_e5.id,_e8=_e5.callback;mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_e5},options:{callback:function(_e9,_ea){var _eb=[],_ec;_1.forEach(_ea.mxobjects,function(_ed){var _ee=new mendix.lib.MxObject({json:_ed,meta:mx.meta.getEntity(_ed.objectType)});if(_ed.guid==_e7){_ec=_ee;}_eb.push(_ee);});_ec.attachReferences(_eb);_e8&&_e8(_ec,false);},error:function(e){_17(_e5.error,_e6,e,"getBySchema");}}});};this.fetch=function(obj,_ef,_f0,_f1,_f2){var _f3=obj,_f4=false,_f5,_f6,_f7;if(_1.isFunction(_f0)){_f2=_f1;_f1=_f0;}if(!_ef){_f5=[];}else{if(_ef instanceof Array){_f5=_ef.slice();}else{_f5=_ef.split("/");}}if(obj&&obj.isA(_f5[0])){_f5.shift();}if(_f5.length%2==1){_f7=_f5.pop();}else{_f7="";}if(_f0.schema){_f6=_f5.splice(-2);}else{_f6=[];}var _f8=function(_f9,ref){if(_f9.isObjectReference(ref)){return _f9.getReference(ref);}else{if(_f9.isObjectReferenceSet(ref)){return _f9.getReferences(ref);}else{return _f9.get(ref);}}};var _fa=function(){if(_f3==null){_f1(null,false);}else{if(!_f7){_f1(_f3,_f4);}else{if(_f7){_f1(_f8(_f3,_f7),false);}}}};var _fb=function(ref){if(_f3.getReferences(ref).length===0){_f1([],false);}else{if(_f3.hasChildren(ref)){_f1(_f3.getChildren(ref),false);}else{mx.data.get({guids:_f3.getReferences(ref),filter:{id:_f0.schema},callback:function(_fc){_f1(_fc,true);},error:_f2});}}};var _fd=function(ref,_fe){var _ff=_f3.getReference(ref);if(_ff){mx.data.get({guid:_ff,filter:{id:_fe},callback:function(obj){if(obj){_f3=obj;_f4=true;_100();}else{_f1(null,false);}},error:_f2});}else{_f1(null,false);}};var _101=function(path){var _102,_103;if(path.length<3){return false;}_102=mx.meta.getEntity(path.slice(-3)[0]),_103=_f5.slice(-2)[0];return _102.isObjectReferenceSet(_103);};var _104=function(_105,type){var _106=["//"+type+"[id="+_105+"]"],_107=_101([type].concat(_f5));Array.prototype.push.apply(_106,_f5);_f5=[];mx.data.get({xpath:_106.join("/"),callback:function(objs){if(objs.length===0){_f1(null,false);}else{if(_f7&&objs.length==1){_f3=objs[0];_fa();}else{if(!_f7){if(_107){_f1(objs,false);}else{_f3=objs[0];_100();}}else{_17(_f2,null,new mendix.lib.Error(_6+".fetch"+_f7+" is not a reference type"),"fetch");}}}},error:_f2});};var _100=function(){var ref,type,_108,_109;if(_f5.length+_f6.length===0){_fa();}else{if(_f5.length===0&&_f6.length>0){ref=_f6.shift();type=_f6.shift();if(_f3.isObjectReferenceSet(ref)){_fb(ref);}else{_fd(ref,_f0.schema);}}else{if(_f4){mx.data.release(_f3);_f4=false;}ref=_f5.shift();type=_f5.shift();if(_f3.isObjectReferenceSet(ref)){if(_f5.length>0||_f6>0){_17(_f2,null,new mendix.lib.Error(_6+".fetch: reference set should be at end of path"),"fetch");}else{_fb(ref);}}else{if(_f3.isObjectReference(ref)){_108=_f3.getChild(ref);if(_108){_f3=_108;_100();}else{_109=_f3.getReference(ref);if(!_109){_f1(null,false);}else{if(_8[_109]!==undefined){_f3=_8[_109];++_9[_109];_f4=true;_100();}else{if(_f0.usexpath&&_f5.length>0){_104(_109,type);}else{_fd(ref);}}}}}else{_17(_f2,null,new mendix.lib.Error(_6+".fetch: attribute "+ref+" is not a reference type"),"fetch");}}}}};_100();};this.release=function(objs){if(!objs){return;}objs=objs instanceof Array?objs:[objs];var _10a=[];for(var i=0,len=objs.length;i<len;++i){var obj=objs[i];if(obj){var guid=obj.getGuid();if(_9[guid]){if(--_9[guid]===0&&!_1d(guid)){_10a.push(guid);}}else{}}}_20(_10a);};this.create=function(_10b,_10c){var _10d=_10b.error,_10e=_10b.context,_10f=_10b.entity,_110=_10b.persistent,err;if(typeof _10b.callback!="function"){err=_6+".create: callback is not a function";logger.error(err);throw new Error(err);}else{if(_10d&&typeof _10d!="function"){err=_6+".create: error is not a function";logger.error(err);throw new Error(err);}else{if(typeof _10f!="string"){err=_6+".create: entity is not a string";logger.error(err);throw new Error(err);}}}var _111=function(objs){var obj=objs&&objs[0];if(_10e){_5.setObjectToContext(obj,_10e);}_10b.callback.call(_10c,obj);};var _112=function(e){_17(_10d,_10c,e,"create");};mx.server.request({request:{action:_110?"create":"instantiate",params:{objecttype:_10b.entity,preventCache:(new Date()).getTime()}},options:{callback:_30(_111,true,true),error:_112}});};this.jsonToMxObject=function(json){return new mendix.lib.MxObject({json:json,meta:mx.meta.getEntity(json.objectType)});};this.remove=function(_113,_114){var _115=_113.error,_116=_113.callback,_117=("guid" in _113)?[_113.guid]:_113.guids;if(("guids" in _113)&&!(_113.guids instanceof Array)){throw new Error(_6+".remove: parameter guids set but not of type Array");}else{if(_115&&typeof _115!="function"){throw new Error(_6+".remove: parameter error set but not of type Function");}else{if(_116&&typeof _116!="function"){throw new Error(_6+".remove: parameter callback set but not of type Function");}}}mx.server.request({request:{action:"delete",params:{guids:_117}},options:{callback:function(){_20(_117);mendix.lang.nullExec(_116);},error:function(e){_17(_115,null,e,"remove");}}});};this.save=function(_118,_119){var _11a,_11b,_11c,_11d,guid,msg,emsg=".save: error calling handler",e,_11e,_11f,_120,_121,obj;if(_118){_11c=_118.mxobj;_11a=_118.callback;_11b=_118.error;_11d=_118.standalone;}if(typeof _11a!="function"){e=_6+".save: callback is not a function";logger.error(e);throw new Error(e);}else{if(_11c!=null&&!(_11c instanceof mendix.lib.MxObject)){e=_6+".save: mxobj is not a MxObject";logger.error(e);throw new Error(e);}}if(_11c){guid=_11c.getGuid();emsg=".save: error calling handler for ["+guid+"]";msg=_b[guid];if(msg){var data=null;if(msg instanceof Error){data=msg;}else{if(msg){data=new mendix.lib.ValidationError();this.sendValidationUpdates([msg.clone()]);}}_17(_11b,_119,data,"save");return;}else{if(!_11c.hasChanges()){_12(_11a,_119,null,emsg);return;}}}_11f={};if(!_11d){_11e=_a;_a={};_120=0;_121=0;for(var id in _11e){_121++;obj=_11e[id];if(obj.hasChanges()){_120++;_11f[id]=obj._collectChanges();}delete _b[id];}if(!_120){if(_121){}_12(_11a,_119,null,emsg);return;}}if(_11c&&!_11e[guid]){_11f[guid]=_11c._collectChanges();_11e={guid:_11c};delete _a[guid];delete _b[guid];}mx.server.request({request:{action:"change",params:_11f},options:{onValidation:_118.onValidation,sync:true,unique:true,callback:function(){for(var guid in _11e){_11e[guid]._applyChangeSet();}_11e=null;_12(_11a,_119,null,emsg);},error:function(e){data=e.original||{};var _122=false,_123=guid,ov=mendix.ov;if(ov.hasValidations(data)){_1.forEach(ov.getValidations(data),function(v){var id=v.getGuid();if(_11e[id]){_b[id]=v;delete _11e[id];}if(_11c&&id==_123){_122=true;}});for(var id in _11e){_11e[id]._applyChangeSet();}}else{_1.mixin(_a,_11e);_122=true;}_11e=null;if(_11c){if(_122){_17(_11b,null,e,"save");}else{_12(_11a,_119,null,emsg);}}else{_12(_11a,_119,null,emsg);}}}});};this.commit=function(_124,_125){var obj,_126,_127,_128,_129,guid,e,msg;if(_124){obj=_124.mxobj;_126=_124.callback;_127=_124.error;_128=_124.onValidation;_129=_124.context;}if(typeof _126!="function"){e=_6+".commit: callback is not a function";logger.error(e);throw new Error(e);}else{if(obj!=null&&!(obj instanceof mendix.lib.MxObject)){e=_6+".commit: mxobj is not a MxObject";logger.error(e);throw new Error(e);}}if(obj==null){_12(_126,_125,null,".commit: error when executing handler");}else{guid=obj.getGuid();msg=".commit: error when executing handler for ["+guid+"]";mx.server.request({request:{action:"commit",params:{guid:guid},context:_129},options:{callback:function(){obj._commitChangeSet();delete _b[guid];delete _a[guid];_5.objectUpdateNotification(obj);_12(_126,_125,null,msg);},error:function(e){_17(_127,null,e,"commit");},onValidation:_128,store:_124.store}});}};this.rollback=function(_12a,_12b){var _12c,obj,_12d;if(_12a){_12c=_12a.callback;obj=_12a.mxobj;_12d=_12a.error;}var emsg=".rollback: error in handler ",e;if(typeof _12c!="function"){e=_6+".rollback: callback is not a function";logger.error(e);throw new Error(e);}else{if(obj!=null&&!(obj instanceof mendix.lib.MxObject)){e=_6+".rollback: mxobj is not a MxObject";logger.error(e);throw new Error(e);}}if(!obj){_12(_12c,_12b,null,emsg);}else{var guid=obj.getGuid(),claz=obj.getEntity();emsg=_6+".rollback: error in handler for ["+guid+"]";delete _b[guid];delete _a[guid];mx.server.request({request:{action:"rollback",params:{guid:guid}},options:{unique:true,standalone:true,callback:_30(function(objs){obj._commitChangeSet();obj.reset();_39(obj,objs[0]);_5.sendClassUpdate(claz);_12(_12c,_12b,null,emsg);},false),error:function(e){_17(_12d,null,e,"rollback");}}});}return true;};this.mxObjectsCallback=function(_12e){return _30(_12e,false);};this.matchObjectsToContext=function(_12f){var _130=_12f.entity,_131=_12f.context,_132=_12f.mxobjs,_133=_12f.callback,_134=[];_53(mx.meta.getEntity(_130),_131,function(_135){var _136=_7a(_135);for(var i=0,obj;obj=_132[i];i++){var _137=0;for(var x=0,_138;_138=_136[x];x++){var ref=_138.ref,_139=_138.ref_ids,ids=obj.getReferences(ref),_13a=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_139.match(ids[j])){_13a=true;break;}}}_13a&&_137++;}if(_137==_136.length){_134.push(obj);}}_133(_134);});};this.createXPathString=function(_13b){var _13c=_13b.callback,_13d=_13b.entity||_13b.className,_13e=_13b.context;var _13f=_13e&&_13e.getContexts();if(!_13f||_13f.length===0){_13c("//"+_13d);return;}_6b(_13b);};this.generateExport=function(_140){mx.server.request({request:{action:"export",params:_140.params},options:{callback:_140.callback,error:function(e){_17(_140.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_141,_142){if(typeof _141!="object"){throw new Error(_6+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _142!="object"){throw new Error(_6+".setObjectToContext: parameter context is not of type Object");}}try{var _143=_141.getAttributes();for(var e=0;e<_143.length;e++){if(_141.isReference(_143[e])){var _144=_141.getSelectorEntity(_143[e]);if((_143[e]=="System.owner")||(_143[e]=="System.changedBy")){continue;}if(_142.hasContext(_144)){_141.addReference(_143[e],_142.getContext(_144));}var meta=mx.meta.getEntity(_144);if(meta){if(meta.hasSubEntities()){var _145=meta.getSubEntities();for(var i=0;i<_145.length;i++){if(_142.hasContext(_145[i])){_141.addReference(_143[e],_142.getContext(_145[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_146){_146.type="sum";_75(_146);};this.countOfXPathSet=function(_147){_147.type="count";_75(_147);};this.sizeOfXPathSet=function(_148){_148.type="count";_75(_148);};this.avgOfXPathSet=function(_149){_149.type="avg";_75(_149);};this.maxOfXPathSet=function(_14a){_14a.type="max";_75(_14a);};this.minOfXPathSet=function(_14b){_14b.type="min";_75(_14b);};this.makeChange=function(_14c,attr,_14d){var guid=_14c.getGuid();_a[guid]=_14c;delete _b[guid];var _14e=_8,_14f=_14e[guid];if(_14f&&_14c!=_14f){_14f._makeChange(attr,_14d);}else{this.update({guid:guid,attr:attr,value:_14d});}};this.xastrigger=function(_150){if(mendix.lang.itemCount(_a)===0){_150&&_150();}else{this.save({mxobj:null,callback:_150});}};};});