
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Data",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mendix.sys.Data");mendix.sys.Data=function(_4){_4=_4||{};var _5=this,_6="mendix.sys.Data",_7=false,_8={},_9={},_a={},_b={},_c={},_d=null,_e=null,_f={entities:{},guids:{},attrs:{},vals:{}};var _10=function(_11,_12,map){if(!_12){return _11;}for(var i in map){if((i in _12)&&(_12[i]!=null)){_11[i]=_12[i];}}return _11;};var _13=function(_14,_15,_16,_17){try{_14&&_14.apply(_15,_16||[]);}catch(e){logger.error(_6+_17+" : "+e.message+" "+(_15?"("+_15+")":""));}};var _18=function(_19,_1a,e,_1b){try{if(_19){_19.call(_1a,e);}else{logger.error("unhandled error: "+e.message);mx.onError(e);}}catch(err){logger.error("error in "+_6+"."+_1b+" while calling error handler: "+err.message);}};var _1c=function(ids){var _1d=[];for(var i=0,id;id=ids[i++];){if(_9[id]!==undefined){_1d.push(_9[id]);}}return _1d;};var _1e=function(_1f){var _20=mendix.lang.itemCount;return (_20(_f.guids[_1f])||_20(_f.attrs[_1f]));};var _21=function(_22){var _23=0;for(var i=0,_24;_24=_22[i];i++){if(_9[_24]&&!_1e(_24)){delete _9[_24];delete _c[_24];delete _a[_24];mx.server.release(_24);_23++;}}};var _25=function(_26,_27,_28,_29){var _2a=mendix.lib.MxObject,_2b=[],_2c=[],_2d=false;if(!(_29 instanceof Array)){_2d=!!_29;_29=[];}for(var i=0,_2e;_2e=_26[i];++i){var _2f=_2e.guid,_30=_9[_2f],inc=(_2d||_1.indexOf(_29,_2f)>=0)?1:0;if(!_27){delete _c[_2f];}if(_28&&_30){if(!_27||!_30.hasChanges()){_30.resetFromJSON(_2e);}_a[_2f]+=inc;_2b.push(_30);}else{var obj=new _2a({json:_2e,meta:mx.meta.getEntity(_2e.objectType)});if(_28){_9[_2f]=obj;_a[_2f]=inc;}if(_30){_2c.push(_30.getGuid());}_2b.push(obj);}}if(!_28){_21(_2c);}return _2b;};var _31=function(_32,_33,_34){var _35=function(_36,_37,evt){var _38;if(_37.mxobject){_38=[_37.mxobject];}else{if(_37.mxobjects&&_37.mxobjects.mxobjects){_38=_37.mxobjects.mxobjects;if(!_38.length){_38=[_38];}}else{_38=_37.mxobjects;}}var _39=(_38&&_38.length)?_25(_38,true,_33,_34):[];_32(_39,{count:_37.count,aggregates:_37.aggregates});};return _35;};var _3a=function(_3b,_3c){var obj=_3c,_3d=_3b.getGuid(),_3e=_9[_3d];if(obj){if(_3e){_3e.resetFromJSON(obj.jsonData);}else{_3e=_9[_3d]=obj;_a[_3d]=0;}if(_3b!=_3e){_3b.resetFromJSON(obj.jsonData);}_5.objectUpdateNotification(obj);}else{_9[_3d]=null;if(_3e){_3e.resetFromJSON(null);}}};var _3f=function(_40){var _41=_8[_40].refs;var _42=_8[_40].subClasses;for(var i=0,l=_42.length;i<l;i++){_41.push(_42[i]);}var _43=_8[_40].superClasses;for(i=0,l=_43.length;i<l;i++){_41.push(_43[i]);}return _41;};var _44=function(obj){var _45=obj.getEntity(),_46=obj.getAttributes();_8[_45]={obj:obj,refs:[],entityClasses:{},typeEntities:{},subClasses:{},superClasses:{},referenceSubClasses:{},referenceSuperClasses:{}};for(var i=0;i<_46.length;i++){if(obj.isReference(_46[i])){_8[_45].entityClasses[_46[i]]=obj.getSelectorEntity(_46[i]);_8[_45].typeEntities[obj.getSelectorEntity(_46[i])]=_46[i];_8[_45].refs.push(obj.getSelectorEntity(_46[i]));if(obj.hasSubEntities()){_8[_45].subClasses=obj.getSubEntities();}else{_8[_45].subClasses=[];}if(obj.hasSuperEntities()){var _47=obj.getSuperEntities();_8[_45].ancestor=_47[_47.length-1];}else{_8[_45].ancestor=null;}}}};var _48=function(_49){var obj=mx.meta.getEntity(_49);if(obj){_44(obj);var _4a=_3f(_49);while(_4a.length){_49=_4a.shift();if(_8[_49]==null){_48(_49);}}}};var _4b=function(_4c,_4d){var _4e=_4c.obj.getAttributes(),_4f={},_50="";try{for(var e=0;e<_4e.length;e++){if(!(_4c.obj.isReference(_4e[e]))){continue;}_50=_4c.obj.getSelectorEntity(_4e[e]);var _51=_4d.getContext(_50);if(_51){_4f[_4e[e]]=_51;}if(_8[_50]!=null){if(_8[_50].obj.hasSubEntities()){var _52=_8[_50].obj.getSubEntities();for(var i=0;i<_52.length;i++){_51=_4d.getContext(_52[i]);if(_51){_4f[_4e[e]]=_51;continue;}}}else{}if(_8[_50].obj.hasSuperEntities()){var _53=_8[_50].obj.getSuperEntities();for(var i=0;i<_53.length;i++){if(_4d.hasContext(_53[i])){_4f[_4e[e]]=_4d.getContext(_53[i]);continue;}}}else{}}else{}}}catch(err){}return (_4f);};var _54=function(_55,_56,_57,_58){var _59=_56.split("/");var _5a=function(_5b){var _5c=_59.shift(),ref=_59.shift(),_5d="";if(_5b==null||_5b.length==null||_5b.length===0){_57(null);return;}var _5e=[];for(var i=0;i<_5b.length;i++){if(_5b[i]==null){continue;}_5e.push("id='"+_5b[i].getGuid()+"'");}if(!_5e.length){_57(null);return;}var ids=_5e.join(" or ");_5d="["+ref+"/"+_5c+"["+ids+"]]";if(_59.length==1){_57(_5d);}else{var _5f=_59[0];_5c=_59.shift();ref=_59.shift();_57("["+ref+"/"+_5c+""+_5d+"]");}};var _60=function(){var _61=_59.shift(),ref=_59.shift(),_62;if(_59.length==1){var _63="["+ref+"='"+_55.getGuid()+"']";_57(_63);return;}if(mx.meta.getEntity(_61)==null){_18(_58,null,new mendix.lib.Error(_6+".runMapPath: entity"+_61+" does not exist"),"runMapPath");return;}if(!_55.isA(_61)){_18(_58,null,new mendix.lib.Error(_6+".runMapPath: entity "+_55.getEntity()+" is not a "+_61+" or one of its subclasses"),"runMapPath");return;}if(!_55.has(ref)){_18(_58,null,new mendix.lib.Error(_6+".runMapPath: reference "+ref+" not found in entity "+_61),"runMapPath");return;}if(_55.get(ref)!==""){_5.get({guids:_55.getReferences(ref),callback:_5a,error:_58});}else{_57(null);}};_60();};var _64=this.getBacktrackConstraints=function(_65,_66,_67,_68,_69){if(!_1.isFunction(_68)){_69=_68;_68=null;}_5.getBacktrack(_66.getTrackId(),_66.getConstraints(),_67,_68,_69);};this.getBacktrack=function(_6a,_6b,_6c,_6d,_6e){if(!_1.isFunction(_6d)){_6e=_6d;_6d=null;}if(!_6b||_6b.length===0){_6c.call(_6e,"",true);return;}var _6f=null,_70=[],_71=0,_72=true;var _73=function(){var _74=_6b[_71++];if(_74){_54(_6f,_74,function(_75){if(_75){_70.push(_75);}else{_72=false;}_73();},function(e){_18(_6d,_6e,e,"getBacktrack");});}else{_6c.call(_6e,_70.join(""),_72);}};if(!_6a){_6c.call(_6e,"",false);}else{_5.get({guid:_6a,callback:function(obj){_6f=obj;_73();},error:function(e){_18(_6d,_6e,e,"getBacktrack");}});}};var _76=function(_77){var _78=_77.entity||_77.className,_79=_8[_78],_7a=_77.context,_7b=_77.callback,_7c="//"+_79.obj.getEntity(),_7d=_4b(_79,_7a);for(var m in _7d){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_79.obj.has(m)){var _7e=_79.obj.getAttributeType(m);switch(_7e){case "ObjectReference":_7c+="["+m+"='"+_7d[m]+"']";break;case "ObjectReferenceSet":_7c+="["+m+"='"+_7d[m]+"']";break;default:}}}var _7f=function(_80,_81){_7b&&_7b(_7c+_80,_81);};if(_7a.getConstraints().length!==0){_64(_79.obj,_7a,_7f,_77.error);}else{_7f("",true);}};var _82=function(_83){mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_83.type+"("+_83.xpath+")",resulttype:_83.resulttype||"integer"}},options:{callback:function(_84,_85,evt){var _86;if(_85){if(_83.resulttype=="float"){_86=parseFloat(_85.value).toFixed(2)||"0.00";}else{_86=_85.value||0;}}else{_86=0;}_83.callback&&_83.callback(_86);},error:function(e){_18(_83.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _87=function(_88){var _89=[];if(_88===""){return;}else{if(_88.match(/^\[[^=\[]+=.[0-9]+./)){var _8a=_88.match(/\[.+?\]/g);for(var i=0;i<_8a.length;i++){var _8b=_8a[i];_8b=_8b.substr(1,_8b.length-2);_89.push({ref:_8b.match(/[^=]+/)[0],ref_ids:_8b.match(/\d+/)[0]});}}else{var _8a=_88.match(/\[.+?\]]/g);for(var i=0;i<_8a.length;i++){var _8b=_8a[i];_8b=_8b.substr(1,_8b.length-3);var _8c=_8b.split("[");_89.push({ref:_8c[0].split("/")[0],ref_ids:_8c[1]});}}}return _89;};var _8d=function(){var _8e=0;for(var _8f in _9){if(_a[_8f]===0&&!_1e(_8f)){delete _9[_8f];delete _a[_8f];delete _c[_8f];mx.server.release(_8f);}else{++_8e;}}};this.toString=function(){return _6;};this.startup=function(_90){_7=true;_d=mx.server.registerCaller(_1.hitch(this,"xastrigger"));_e=window.setInterval(function(){_8d();},10000);_90();};this.shutdown=function(){_7=false;_9={};_c={};_a={};clearInterval(_e);mx.server.unregisterCaller(_d);};this.isLoaded=function(){return _7;};this.subscribe=function(_91,_92){var id=mendix.lang.getUniqueId(),_93=_91.entity,_94=_91.guid,val=_91.val,_95=_91.attr,_96=_92?function(){_91.callback.apply(_92,arguments);}:_91.callback;if(_95){if(!_f.attrs[_94]){_f.attrs[_94]={};}if(!_f.attrs[_94][_95]){_f.attrs[_94][_95]={};}_f.attrs[_94][_95][id]=_96;}else{if(val){if(!_f.vals[_94]){_f.vals[_94]={};}_f.vals[_94][id]=_96;}else{if(_94){if(!_f.guids[_94]){_f.guids[_94]={};}_f.guids[_94][id]=_96;}else{if(_93){if(!_f.entities[_93]){_f.entities[_93]={};}_f.entities[_93][id]=_96;}else{logger.error(_6+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_93,guid:_94,val:val,attr:_95,id:id};};this.unsubscribe=function(_97){if(_97==null){return;}var id=_97.id,_98=_97.entity,_99=_97.guid,val=_97.val,_9a=_97.attr,_9b=mendix.lang.itemCount;if(_9a){var _9c=_f.attrs[_99];if(!_9c){}else{if(!_9c[_9a]){}else{delete _9c[_9a][id];if(_9b(_9c[_9a])===0){delete _9c[_9a];}if(_9b(_9c)===0){delete _f.attrs[_99];}}}}else{if(val){if(!_f.vals[_99]){}else{delete _f.vals[_99][id];if(_9b(_f.vals[_99])===0){delete _f.vals[_99];}}}else{if(_99){var _9d=_f.guids[_99];if(!_9d){}else{delete _9d[id];if(_9b(_9d)===0){delete _f.guids[_99];}}}else{if(_98){var _9e=_f.entities[_98];if(!_9e){}else{delete _9e[id];if(_9b(_9e)===0){delete _f.entities[_98];}}}}}}};this.update=function(_9f){var _a0=_9f.guid,_a1=_9f.entity,_a2=_9f.attr,val=_9f.val,_a3=_9f.value,_a4=_9f.callback;var _a5=function(_a6,_a7){var map=_a6?_1.clone(_a6):{};for(var key in map){map[key].apply(null,_a7);}};if(_a2){_a5(_f.attrs[_a0]&&_f.attrs[_a0][_a2],[_a0,_a2,_a3]);}else{if(_a0){_a5(_f.guids[_a0],[_a0]);}else{if(val){_a5(_f.vals[_a0],[_a0]);}else{if(_a1){_a5(_f.entities[_a1],[_a1]);}else{logger.error(_6+".update: no 'entity' or 'guid' parameter found");}}}}_a4&&_a4();};this.objectUpdateNotification=function(_a8){_5.sendClassUpdate(_a8.getEntity());_5.update({guid:_a8.getGuid()});};this.sendClassUpdate=function(_a9){var _aa=mx.meta.getEntity(_a9);if(!_aa){throw new mendix.lib.Error("No permission to read or write entity "+_a9+", check security!");}_1.forEach([_a9].concat(_aa.getSuperEntities()),function(ent){_5.update({entity:ent});});};this.objectPing=function(_ab,_ac){var _ad=_ab.getGuid(),_ae=_1.clone(_f.guids[_ad]),_af=[];if(_ae){for(var sub in _ae){_af.push((function(_b0,sub){return function(cb){try{var _b1=_b0[sub];if(_b1.length==2){_b1(_ad,cb);}else{_b1(_ad);cb();}}catch(e){if(_b0){delete _b0[sub];}cb();}};})(_ae,sub));}mendix.lang.collect(_af,_ac);}else{_ac&&_ac();}};this.addValidation=function(_b2,_b3,_b4){if(!_c[_b2]){_c[_b2]=new mendix.lib.ObjectValidation({msg:{guid:_b2}});}_c[_b2].addField(_b3,_b4);};this.sendValidationUpdates=function(_b5){var _b6,_b7,_b8=[];for(var i=0,_b9;_b9=_b5[i];i++){_b7=_f.vals[_b9.getGuid()];var cp=_b9.clone(),_ba=cp.getAttributes();if(_b7){for(var x in _b7){var _bb=_b9.clone();try{_b7[x]([_bb]);}catch(e){logger.error(_6+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _b7[x];}var _bc=_bb.getAttributes();_1.forEach(_ba,function(_bd){var _be=_bd.name,_bf=_1.some(_bc,function(_c0){return _c0.name==_be;});if(!_bf){cp.removeAttribute(_bd.name);}},this);}}else{}if(cp.getAttributes().length){_b8.push(cp);}}mx.ui.validations(_b8);};this.action=function(_c1){var _c2=_c1.context,_c3=_c1.callback,_c4=_c1.error,_c5=_c1.onValidation,_c6=!!_c1.async,_c7=_c1.params,_c8=_c1.store;var _c9=function(e){_18(_c4,null,e,"action");};mx.server.request({request:{action:"executeaction",params:_c7,context:_c2},options:{callback:function(_ca,_cb,_cc){var _cd=_cb.actionResult,_ce;if(_cd instanceof Array){_ce=_25(_cd,false,true,true);}else{if(typeof _cd=="object"&&_cd.guid){_ce=_25([_cd],false,true,true);}else{_ce=_cb.actionResult;}}_c3&&_c3(_ce,_cc);},error:_c9,store:_c8,async:_c6,onValidation:_c5}});};this.setOrRetrieveMxObject=function(_cf){return _25([_cf],false,true)[0];};this.get=function(_d0,_d1){var _d2=_d0.xpath,_d3=_d0.path,id=_d0.guid,ids=(!("guids" in _d0)&&id)?[id]:_d0.guids,_d4=_d0.callback,_d5=_d0.error,_d6=!!_d0.noCache,_d7=!!_d0.count,_d8=_d0.filter,_d9=!!_d0.aggregates,_da=_d0.context,_db=_d0.microflow,err;if(("guid" in _d0)&&id==null){_13(_d4,_d1,[null],"");return;}if(!_d2&&!ids&&!_db){err=_6+".get: xpath, guid|guids and microflow arguments are undefined";logger.error(err);throw new Error(err);}if(_d3&&ids.length!=1){throw new Error(_6+".get : path can only be used with a single guid");}if(typeof _d4!="function"){err=_6+".get: callback is not a function";logger.error(err);throw new Error(err);}else{if(_d5&&typeof _d5!="function"){err=_6+".get: error is not a function";logger.error(err);throw new Error(err);}}if(_d8){if(_d8.limit){_d8.amount=_d8.limit;delete _d8.limit;}if(_d8.references){for(var r in _d8.references){var ref=_d8.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_dc=_10({},_d8,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_dd=function(e){_18(_d5,_d1,e,"get");};if(_dc.id&&ids&&!id){delete _dc.id;}if(_dc.id){delete _dc.attributes;delete _dc.distinct;}if(_db){var _de=ids?"selection":(_d2?"set":"none"),_df={actionname:_db,applyto:_de};if(_de=="selection"){_df.guids=ids;}else{if(_de=="set"){_df.xpath=_d2;if(_dc.sort){_df.sort=_dc.sort;}}}this.action({params:_df,context:_da,callback:function(_e0,_e1){_d4&&_d4.call(_d1,_e0,_e1);},error:_dd});}else{if(_d3&&ids){mx.server.request({request:{action:"retrieve_by_path",params:{id:ids[0],path:_d3},context:null},options:{callback:_31(function(_e2,_e3){_13(_d4,_d1,[_e2,_e3],".get: error in handler for ["+ids+"]");},true,true),error:_dd}});}else{if(ids){if(ids.length===0){_13(_d4,_d1,[id?null:[],{count:0}],".get: error in handler");return;}if(!_d6){var _e4=_1c(ids),_e5=_e4.length==ids.length;if(_e5){var _e6=_e4;if(_dc.sort){_1.forEach(_dc.sort,function(_e7){var _e8=_e7[0],dir=_e7[1];_e6=_e6.sort(dir=="asc"?function(a,b){a=a.get(_e8);b=b.get(_e8);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get(_e8);b=b.get(_e8);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _e9=_dc.offset;if(_e9){var _ea=_dc.amount;if(_ea){_e6=_e6.slice(_e9,_e9+_ea);}else{_e6=_e6.slice(_e9);}}for(var i=0,_eb;_eb=_e6[i];++i){++_a[_eb];}_13(_d4,_d1,[id?_e6[0]:_e6,{count:_e4.length}],".get: error in handler for ["+ids+"]");return true;}}var _ec=_dc.attributes==null;mx.server.request({request:{action:"retrieve_by_ids",params:{ids:ids,schema:_dc}},options:{callback:_31(function(_ed,_ee){var _ef=_ed[0];if(id&&_dc.id){for(var i=0,obj;obj=_ed[i];++i){if(obj.getGuid()==id){_ef=obj;break;}}}_13(_d4,_d1,[id?_ef:_ed,_ee],".get: error in handler for ["+ids+"]");},_ec,ids),error:_dd}});return true;}else{mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_d2,schema:_dc,count:_d7,aggregates:_d9}},options:{callback:_31(function(_f0,_f1){_13(_d4,_d1,[_f0,_f1],".get: error in error handler for xpath "+_d2);},false),error:_dd}});return true;}}}};this.getBySchema=function(_f2,_f3){var _f4=_f2.id,_f5=_f2.callback;mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_f2},options:{callback:function(_f6,_f7){var _f8=[],_f9;_1.forEach(_f7.mxobjects,function(_fa){var _fb=new mendix.lib.MxObject({json:_fa,meta:mx.meta.getEntity(_fa.objectType)});if(_fa.guid==_f4){_f9=_fb;}_f8.push(_fb);});_f9.attachReferences(_f8);_f5&&_f5(_f9,false);},error:function(e){_18(_f2.error,_f3,e,"getBySchema");}}});};this.fetch=function(obj,_fc,_fd,_fe,_ff){var _100=obj,_101=false,_102,_103,attr;if(_1.isFunction(_fd)){_ff=_fe;_fe=_fd;}if(!_fc){_102=[];}else{if(_fc instanceof Array){_102=_fc.slice();}else{_102=_fc.split("/");}}if(obj&&obj.isA(_102[0])){_102.shift();}if(_102.length%2==1){attr=_102.pop();}else{attr="";}if(_fd.schema){_103=_102.splice(-2);}else{_103=[];}var _104=function(_105,ref){if(_105.isObjectReference(ref)){return _105.getReference(ref);}else{if(_105.isObjectReferenceSet(ref)){return _105.getReferences(ref);}else{return _105.get(ref);}}};var _106=function(){if(_100==null){_fe(null,false);}else{if(!attr){_fe(_100,_101);}else{if(attr){_fe(_104(_100,attr),false);}}}};var _107=function(ref){if(_100.getReferences(ref).length===0){_fe([],false);}else{if(_100.hasChildren(ref)){_fe(_100.getChildren(ref),false);}else{mx.data.get({guids:_100.getReferences(ref),filter:{id:_fd.schema},callback:function(objs){_fe(objs,true);},error:_ff});}}};var _108=function(ref,_109){var guid=_100.getReference(ref);if(guid){mx.data.get({guid:guid,filter:{id:_109},callback:function(obj){if(obj){_100=obj;_101=true;_10a();}else{_fe(null,false);}},error:_ff});}else{_fe(null,false);}};var _10b=function(path){var _10c,_10d;if(path.length<3){return false;}_10c=mx.meta.getEntity(path.slice(-3)[0]),_10d=_102.slice(-2)[0];return _10c.isObjectReferenceSet(_10d);};var _10e=function(_10f,type){var _110=["//"+type+"[id="+_10f+"]"],_111=_10b([type].concat(_102));Array.prototype.push.apply(_110,_102);_102=[];mx.data.get({xpath:_110.join("/"),callback:function(objs){if(objs.length===0){_fe(null,false);}else{if(attr&&objs.length==1){_100=objs[0];_106();}else{if(!attr){if(_111){_fe(objs,false);}else{_100=objs[0];_10a();}}else{_18(_ff,null,new mendix.lib.Error(_6+".fetch"+attr+" is not a reference type"),"fetch");}}}},error:_ff});};var _10a=function(){var ref,type,_112,_113;if(_102.length+_103.length===0){_106();}else{if(_102.length===0&&_103.length>0){ref=_103.shift();type=_103.shift();if(_100.isObjectReferenceSet(ref)){_107(ref);}else{_108(ref,_fd.schema);}}else{if(_101){mx.data.release(_100);_101=false;}ref=_102.shift();type=_102.shift();if(_100.isObjectReferenceSet(ref)){if(_102.length>0||_103>0){_18(_ff,null,new mendix.lib.Error(_6+".fetch: reference set should be at end of path"),"fetch");}else{_107(ref);}}else{if(_100.isObjectReference(ref)){_112=_100.getChild(ref);if(_112){_100=_112;_10a();}else{_113=_100.getReference(ref);if(!_113){_fe(null,false);}else{if(_9[_113]!==undefined){_100=_9[_113];++_a[_113];_101=true;_10a();}else{if(_fd.usexpath&&_102.length>0){_10e(_113,type);}else{_108(ref);}}}}}else{_18(_ff,null,new mendix.lib.Error(_6+".fetch: attribute "+ref+" is not a reference type"),"fetch");}}}}};_10a();};this.release=function(objs){if(!objs){return;}objs=objs instanceof Array?objs:[objs];var _114=[];for(var i=0,len=objs.length;i<len;++i){var obj=objs[i];if(obj){var guid=obj.getGuid();if(_a[guid]){if(--_a[guid]===0&&!_1e(guid)){_114.push(guid);}}else{}}}_21(_114);};this.create=function(_115,_116){var _117=_115.error,_118=_115.context,_119=_115.entity,_11a=_115.persistent,err;if(typeof _115.callback!="function"){err=_6+".create: callback is not a function";logger.error(err);throw new Error(err);}else{if(_117&&typeof _117!="function"){err=_6+".create: error is not a function";logger.error(err);throw new Error(err);}else{if(typeof _119!="string"){err=_6+".create: entity is not a string";logger.error(err);throw new Error(err);}}}var _11b=function(objs){var obj=objs&&objs[0];if(_118){_5.setObjectToContext(obj,_118);}_115.callback.call(_116,obj);};var _11c=function(e){_18(_117,_116,e,"create");};mx.server.request({request:{action:_11a?"create":"instantiate",params:{objecttype:_115.entity,preventCache:(new Date()).getTime()}},options:{callback:_31(_11b,true,true),error:_11c}});};this.jsonToMxObject=function(json){return new mendix.lib.MxObject({json:json,meta:mx.meta.getEntity(json.objectType)});};this.remove=function(_11d,_11e){var _11f=_11d.error,_120=_11d.callback,_121=("guid" in _11d)?[_11d.guid]:_11d.guids;if(("guids" in _11d)&&!(_11d.guids instanceof Array)){throw new Error(_6+".remove: parameter guids set but not of type Array");}else{if(_11f&&typeof _11f!="function"){throw new Error(_6+".remove: parameter error set but not of type Function");}else{if(_120&&typeof _120!="function"){throw new Error(_6+".remove: parameter callback set but not of type Function");}}}mx.server.request({request:{action:"delete",params:{guids:_121}},options:{callback:function(){_21(_121);mendix.lang.nullExec(_120);},error:function(e){_18(_11f,null,e,"remove");}}});};this.save=function(_122,_123){var _124,_125,_126,_127,guid,msg,emsg=".save: error calling handler",e,_128,_129,_12a,_12b,obj;if(_122){_126=_122.mxobj;_124=_122.callback;_125=_122.error;_127=_122.standalone;}if(typeof _124!="function"){e=_6+".save: callback is not a function";logger.error(e);throw new Error(e);}else{if(_126!=null&&!(_126 instanceof mendix.lib.MxObject)){e=_6+".save: mxobj is not a MxObject";logger.error(e);throw new Error(e);}}if(_126){guid=_126.getGuid();emsg=".save: error calling handler for ["+guid+"]";msg=_c[guid];if(msg){var data=null;if(msg instanceof Error){data=msg;}else{if(msg){data=new mendix.lib.ValidationError();this.sendValidationUpdates([msg.clone()]);}}_18(_125,_123,data,"save");return;}else{if(!_126.hasChanges()){_13(_124,_123,null,emsg);return;}}}_129={};if(!_127){_128=_b;_b={};_12a=0;_12b=0;for(var id in _128){_12b++;obj=_128[id];if(obj.hasChanges()){_12a++;_129[id]=obj._collectChanges();}delete _c[id];}if(!_12a){if(_12b){}_13(_124,_123,null,emsg);return;}}if(_126&&!_128[guid]){_129[guid]=_126._collectChanges();_128={guid:_126};delete _b[guid];delete _c[guid];}mx.server.request({request:{action:"change",params:_129},options:{onValidation:_122.onValidation,sync:true,unique:true,callback:function(){for(var guid in _128){_128[guid]._applyChangeSet();}_128=null;_13(_124,_123,null,emsg);},error:function(e){data=e.original||{};var _12c=false,_12d=guid,ov=mendix.ov;if(ov.hasValidations(data)){_1.forEach(ov.getValidations(data),function(v){var id=v.getGuid();if(_128[id]){_c[id]=v;delete _128[id];}if(_126&&id==_12d){_12c=true;}});for(var id in _128){_128[id]._applyChangeSet();}}else{_1.mixin(_b,_128);_12c=true;}_128=null;if(_126){if(_12c){_18(_125,null,e,"save");}else{_13(_124,_123,null,emsg);}}else{_13(_124,_123,null,emsg);}}}});};this.commit=function(_12e,_12f){var obj,_130,_131,_132,_133,guid,e,msg;if(_12e){obj=_12e.mxobj;_130=_12e.callback;_131=_12e.error;_132=_12e.onValidation;_133=_12e.context;}if(typeof _130!="function"){e=_6+".commit: callback is not a function";logger.error(e);throw new Error(e);}else{if(obj!=null&&!(obj instanceof mendix.lib.MxObject)){e=_6+".commit: mxobj is not a MxObject";logger.error(e);throw new Error(e);}}if(obj==null){_13(_130,_12f,null,".commit: error when executing handler");}else{guid=obj.getGuid();msg=".commit: error when executing handler for ["+guid+"]";mx.server.request({request:{action:"commit",params:{guid:guid},context:_133},options:{callback:function(){obj._commitChangeSet();delete _c[guid];delete _b[guid];_5.objectUpdateNotification(obj);_13(_130,_12f,null,msg);},error:function(e){_18(_131,null,e,"commit");},onValidation:_132,store:_12e.store}});}};this.rollback=function(_134,_135){var _136,obj,_137;if(_134){_136=_134.callback;obj=_134.mxobj;_137=_134.error;}var emsg=".rollback: error in handler ",e;if(typeof _136!="function"){e=_6+".rollback: callback is not a function";logger.error(e);throw new Error(e);}else{if(obj!=null&&!(obj instanceof mendix.lib.MxObject)){e=_6+".rollback: mxobj is not a MxObject";logger.error(e);throw new Error(e);}}if(!obj){_13(_136,_135,null,emsg);}else{var guid=obj.getGuid(),claz=obj.getEntity();emsg=_6+".rollback: error in handler for ["+guid+"]";delete _c[guid];delete _b[guid];mx.server.request({request:{action:"rollback",params:{guid:guid}},options:{unique:true,standalone:true,callback:_31(function(objs){obj._commitChangeSet();obj.reset();_3a(obj,objs[0]);_5.sendClassUpdate(claz);_13(_136,_135,null,emsg);},false),error:function(e){_18(_137,null,e,"rollback");}}});}return true;};this.mxObjectsCallback=function(_138){return _31(_138,false);};this.matchObjectsToContext=function(_139){var _13a=_139.entity,_13b=_139.context,_13c=_139.mxobjs,_13d=_139.callback,_13e=[];_64(mx.meta.getEntity(_13a),_13b,function(_13f){var _140=_87(_13f);for(var i=0,obj;obj=_13c[i];i++){var _141=0;for(var x=0,_142;_142=_140[x];x++){var ref=_142.ref,_143=_142.ref_ids,ids=obj.getReferences(ref),_144=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_143.match(ids[j])){_144=true;break;}}}_144&&_141++;}if(_141==_140.length){_13e.push(obj);}}_13d(_13e);});};this.createXPathString=function(_145){var _146=_145.callback,_147=_145.entity||_145.className,_148=_145.context;var _149=_148&&_148.getContexts();if(!_149||_149.length===0){_146("//"+_147);return;}if(_8[_147]==null){_48(_147);}_76(_145);};this.generateExport=function(_14a){mx.server.request({request:{action:"export",params:_14a.params},options:{callback:_14a.callback,error:function(e){_18(_14a.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_14b,_14c){if(typeof _14b!="object"){throw new Error(_6+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _14c!="object"){throw new Error(_6+".setObjectToContext: parameter context is not of type Object");}}try{var _14d=_14b.getAttributes();for(var e=0;e<_14d.length;e++){if(_14b.isReference(_14d[e])){var _14e=_14b.getSelectorEntity(_14d[e]);if((_14d[e]=="System.owner")||(_14d[e]=="System.changedBy")){continue;}if(_14c.hasContext(_14e)){_14b.addReference(_14d[e],_14c.getContext(_14e));}if(_8[_14e]!=null){if(_8[_14e].obj.hasSubEntities()){var _14f=_8[_14e].obj.getSubEntities();for(var i=0;i<_14f.length;i++){if(_14c.hasContext(_14f[i])){_14b.addReference(_14d[e],_14c.getContext(_14f[i]));continue;}}}else{}}else{}}}}catch(err){}};this.sumOfXPathSet=function(_150){_150.type="sum";_82(_150);};this.countOfXPathSet=function(_151){_151.type="count";_82(_151);};this.sizeOfXPathSet=function(_152){_152.type="count";_82(_152);};this.avgOfXPathSet=function(_153){_153.type="avg";_82(_153);};this.maxOfXPathSet=function(_154){_154.type="max";_82(_154);};this.minOfXPathSet=function(_155){_155.type="min";_82(_155);};this.makeChange=function(_156,attr,_157){var guid=_156.getGuid();_b[guid]=_156;delete _c[guid];var _158=_9,_159=_158[guid];if(_159&&_156!=_159){_159._makeChange(attr,_157);}else{this.update({guid:guid,attr:attr,value:_157});}};this.xastrigger=function(_15a){if(mendix.lang.itemCount(_b)===0){_15a&&_15a();}else{this.save({mxobj:null,callback:_15a});}};};});