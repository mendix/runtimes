/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Data",["mendix/lib/ConnectionError","mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/MxObject","mendix/lang","mendix/logger","webcore/data-backend/OnlineDataBackend","webcore/data-backend/OfflineDataBackend","webcore/MxObjectCache","webcore/MxObjectBackend","webcore/url-helpers","dojo/_base/array","dojo/_base/lang","bluebird/bluebird"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){function _f(_10){_10=_10||{};var _11=this,_12="mendix.sys.Data",_13={entities:{},guids:{},attrs:{},vals:{}};var _14=new _7();var _15=new _a(_14,new _9(),function(_16){return !_17(_16);});var _18=_b.getDynamicResourceUrl;var _19=function(_1a,_1b,map){if(!_1b){return _1a;}for(var i in map){if((i in _1b)&&(_1b[i]!=null)){_1a[i]=_1b[i];}}return _1a;};var _1c=function(_1d,_1e,_1f,_20){try{_1d&&_1d.apply(_1e,_1f||[]);}catch(e){_6.error(_12+_20+" : "+e.message+" "+(_1e?"("+_1e+")":""));}};var _21=function(_22,_23,e,_24){try{if(_22){_22.call(_23,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_12+"."+_24+" while calling error handler: "+err.message);}};var _17=function(_25){var _26=_5.itemCount;return (_26(_13.guids[_25])||_26(_13.attrs[_25]));};var _27=function(_28,_29){var _2a={};_c.forEach(_28.getAttributes(),function(ref){if(!_28.isReference(ref)){return;}var _2b=_29.getContext(_28.getSelectorEntity(ref));if(_2b){_2a[ref]=_2b;}});return _2a;};var _2c=function(_2d,_2e,_2f,_30){var _31=_2e.split("/");var _32=function(_33){var _34=_31.shift(),ref=_31.shift(),_35;if(_33==null||_33.length==null||_33.length===0){_2f(null);return;}var _36=[];for(var i=0;i<_33.length;i++){if(_33[i]==null){continue;}_36.push("id='"+_33[i].getGuid()+"'");}if(!_36.length){_2f(null);return;}var ids=_36.join(" or ");_35="["+ref+"/"+_34+"["+ids+"]]";if(_31.length==1){_2f(_35);}else{var _37=_31[0];_34=_31.shift();ref=_31.shift();_2f("["+ref+"/"+_34+""+_35+"]");}};var _38=function(){var _39=_31.shift(),ref=_31.shift();if(_31.length==1){var _3a="["+ref+"='"+_2d.getGuid()+"']";_2f(_3a);return;}if(window.mx.meta.getEntity(_39)==null){_21(_30,null,new _2(_12+".runMapPath: entity"+_39+" does not exist"),"runMapPath");return;}if(!_2d.isA(_39)){_21(_30,null,new _2(_12+".runMapPath: entity "+_2d.getEntity()+" is not a "+_39+" or one of its subclasses"),"runMapPath");return;}if(!_2d.has(ref)){_21(_30,null,new _2(_12+".runMapPath: reference "+ref+" not found in entity "+_39),"runMapPath");return;}if(_2d.get2(ref)!==""){_11.get({guids:_2d.getReferences(ref),callback:_32,error:_30});}else{_2f(null);}};_38();};this.getBacktrackConstraints=function(_3b,_3c,_3d,_3e,_3f){if(!_d.isFunction(_3e)){_3f=_3e;_3e=null;}_11.getBacktrack(_3c.getTrackId(),_3c.getConstraints(),_3d,_3e,_3f);};var _40=this.getBacktrackConstraints;this.getBacktrack=function(_41,_42,_43,_44,_45){if(!_d.isFunction(_44)){_45=_44;_44=null;}if(!_42||_42.length===0){_43.call(_45,"",true);return;}var _46=null,_47=[],_48=0,_49=true;var _4a=function(){var _4b=_42[_48++];if(_4b){_2c(_46,_4b,function(_4c){if(_4c){_47.push(_4c);}else{_49=false;}_4a();},function(e){_21(_44,_45,e,"getBacktrack");});}else{_43.call(_45,_47.join(""),_49);}};if(!_41){_43.call(_45,"",false);}else{_11.get({guid:_41,callback:function(obj){_46=obj;_4a();},error:function(e){_21(_44,_45,e,"getBacktrack");}});}};var _4d=function(_4e,_4f){var _50=[],_51=_27(_4e,_4f);for(var m in _51){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_4e.has(m)){var _52=_4e.getAttributeType(m);switch(_52){case "ObjectReference":_50.push("["+m+"='"+_51[m]+"']");break;case "ObjectReferenceSet":_50.push("["+m+"='"+_51[m]+"']");break;default:}}}return _50.join("");};var _53=function(_54){var _55=_54.entity||_54.className,_56=window.mx.meta.getEntity(_55),_57=_54.context,_58="//"+_55,_59=_4d(_56,_57);var _5a=function(_5b,_5c){if(_54.callback){_54.callback(_58+_59+_5b,_5c);}};if(_57.getConstraints().length!==0){_40(_56,_57,_5a,_54.error);}else{_5a("",true);}};var _5d=function(_5e){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_5e.type+"("+_5e.xpath+")",resulttype:_5e.resulttype||"integer"}},options:{callback:function(_5f,_60){var _61;if(_60){if(_5e.resulttype=="float"){_61=parseFloat(_60.value).toFixed(2)||"0.00";}else{_61=_60.value||0;}}else{_61=0;}_5e.callback&&_5e.callback(_61);},error:function(e){_21(_5e.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _62=function(_63){var _64;if(_63===""){return;}else{if(_63.match(/^\[[^=\[]+=.[0-9]+./)){_64=_c.map(_63.match(/\[.+?\]/g),function(_65){_65=_65.substr(1,_65.length-2);return {ref:_65.match(/[^=]+/)[0],ref_ids:_65.match(/\d+/)[0]};});}else{_64=_c.map(_63.match(/\[.+?\]]/g),function(_66){_66=_66.substr(1,_66.length-3);var _67=_66.split("[");return {ref:_67[0].split("/")[0],ref_ids:_67[1]};});}}return _64;};this.toString=function(){return _12;};this.setOfflineStore=function(_68){_15=new _a(new _8(_68),new _9(),function(_69){return !_17(_69);});_18=_10.getOfflineDocumentUrlFn||function(_6a,_6b,_6c){var dir=_6c?"thumbnails":"documents";return "filesystem:"+mx.appUrl+"temporary/files/"+dir+"/"+_6a;};};this.startup=function(){window.mx.server.registerCaller(_d.hitch(_15,"flush"));window.setInterval(_d.hitch(_15,"cleanup"),10000);};this.subscribe=function(_6d,_6e){var id=_5.getUniqueId(),_6f=_6d.entity,_70=_6d.guid,val=_6d.val,_71=_6d.attr,_72=_6e?function(){_6d.callback.apply(_6e,arguments);}:_6d.callback;if(_71){if(!_13.attrs[_70]){_13.attrs[_70]={};}if(!_13.attrs[_70][_71]){_13.attrs[_70][_71]={};}_13.attrs[_70][_71][id]=_72;}else{if(val){if(!_13.vals[_70]){_13.vals[_70]={};}_13.vals[_70][id]=_72;}else{if(_70){if(!_13.guids[_70]){_13.guids[_70]={};}_13.guids[_70][id]=_72;}else{if(_6f){if(!_13.entities[_6f]){_13.entities[_6f]={};}_13.entities[_6f][id]=_72;}else{_6.error(_12+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_6f,guid:_70,val:val,attr:_71,id:id};};this.unsubscribe=function(_73){if(_73==null){return;}var id=_73.id,_74=_73.entity,_75=_73.guid,val=_73.val,_76=_73.attr,_77=_5.itemCount;if(_76){var _78=_13.attrs[_75];if(!_78){}else{if(!_78[_76]){}else{delete _78[_76][id];if(_77(_78[_76])===0){delete _78[_76];}if(_77(_78)===0){delete _13.attrs[_75];}}}}else{if(val){if(!_13.vals[_75]){}else{delete _13.vals[_75][id];if(_77(_13.vals[_75])===0){delete _13.vals[_75];}}}else{if(_75){var _79=_13.guids[_75];if(!_79){}else{delete _79[id];if(_77(_79)===0){delete _13.guids[_75];}}}else{if(_74){var _7a=_13.entities[_74];if(!_7a){}else{delete _7a[id];if(_77(_7a)===0){delete _13.entities[_74];}}}}}}};this.update=function(_7b){var _7c=_7b.guid,_7d=_7b.entity,_7e=_7b.attr,val=_7b.val,_7f=_7b.value,_80=_7b.callback;var _81=function(_82,_83){var map=_82?_d.clone(_82):{};for(var key in map){map[key].apply(null,_83);}};if(_7e){_81(_13.attrs[_7c]&&_13.attrs[_7c][_7e],[_7c,_7e,_7f]);}else{if(_7c){_81(_13.guids[_7c],[_7c]);}else{if(val){_81(_13.vals[_7c],[_7c]);}else{if(_7d){_81(_13.entities[_7d],[_7d]);}else{_6.error(_12+".update: no 'entity' or 'guid' parameter found");}}}}_80&&_80();};this.objectUpdateNotification=function(_84){_11.sendClassUpdate(_84.getEntity());_11.update({guid:_84.getGuid()});};this.sendClassUpdate=function(_85){var _86=window.mx.meta.getEntity(_85);if(!_86){throw new _2("No permission to read or write entity "+_85+", check security!");}_c.forEach([_85].concat(_86.getSuperEntities()),function(ent){_11.update({entity:ent});});};this.objectPing=function(_87,_88){var _89=_87.getGuid(),_8a=_d.clone(_13.guids[_89]),_8b=[];if(_8a){for(var sub in _8a){_8b.push((function(_8c,sub){return function(cb){try{var _8d=_8c[sub];if(_8d.length==2){_8d(_89,cb);}else{_8d(_89);cb();}}catch(e){if(_8c){delete _8c[sub];}cb();}};})(_8a,sub));}_5.collect(_8b,_88);}else{_88&&_88();}};this.sendValidationUpdates=function(_8e){var _8f,_90=[];for(var i=0,_91;_91=_8e[i];i++){_8f=_13.vals[_91.getGuid()];var cp=_91.clone(),_92=cp.getAttributes();if(_8f){for(var x in _8f){var _93=_91.clone();try{_8f[x]([_93]);}catch(e){_6.error(_12+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _8f[x];}var _94=_93.getAttributes();_c.forEach(_92,function(_95){var _96=_95.name,_97=_c.some(_94,function(_98){return _98.name==_96;});if(!_97){cp.removeAttribute(_95.name);}},this);}}else{}if(cp.getAttributes().length){_90.push(cp);}}window.mx.ui.validations(_90);};this.action=function(_99){_15.action(_99.params,_99.context,_99.store,!!_99.async,_99.onValidation,function(_9a,_9b){if(_99.callback){_99.callback(_9a,_9b);}},function(e){_21(_99.error,null,e,"action");});};this.setOrRetrieveMxObject=function(_9c){return _15.setOrRetrieveMxObject(_9c);};this.get=function(_9d,_9e){var _9f=_9d.xpath,_a0=_9d.path,id=_9d.guid,ids=(!("guids" in _9d)&&id)?[id]:_9d.guids,_a1=_9d.callback,_a2=_9d.error,_a3=!!_9d.noCache,_a4=!!_9d.count,_a5=_9d.filter,_a6=!!_9d.aggregates,_a7=_9d.context,_a8=_9d.microflow,err;if(("guid" in _9d)&&id==null){_1c(_a1,_9e,[null],"");return;}if(!_9f&&!ids&&!_a8){err=_12+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _2(err);}if(_a0&&ids.length!=1){throw new _2(_12+".get : path can only be used with a single guid");}if(typeof _a1!="function"){err=_12+".get: callback is not a function";_6.error(err);throw new _2(err);}else{if(_a2&&typeof _a2!="function"){err=_12+".get: error is not a function";_6.error(err);throw new _2(err);}}if(_a5){if(_a5.limit){_a5.amount=_a5.limit;delete _a5.limit;}if(_a5.references){for(var r in _a5.references){var ref=_a5.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_a9=_19({},_a5,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_aa=function(e){_21(_a2,_9e,e,"get");};if(_a9.id&&ids&&!id){delete _a9.id;}if(_a9.id){delete _a9.attributes;delete _a9.distinct;}if(_a8){var _ab=ids?"selection":(_9f?"set":"none"),_ac={actionname:_a8,applyto:_ab};if(_ab=="selection"){_ac.guids=ids;}else{if(_ab=="set"){_ac.xpath=_9f;if(_a9.sort){_ac.sort=_a9.sort;}}}this.action({params:_ac,context:_a7,callback:function(_ad,_ae){_a1&&_a1.call(_9e,_ad,_ae);},error:_aa});}else{if(_a0&&ids){_15.getByPath(ids[0],_a0,function(_af,_b0){try{if(_a1){_a1.call(_9e,_af,{count:_b0});}}catch(e){_6.error(_12+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_9e?"("+_9e+")":""));}},function(e){_21(_a2,_9e,e,"get");});}else{if(ids){if(ids.length===0){_1c(_a1,_9e,[id?null:[],{count:0}],".get: error in handler");return;}_15.getByGuid(ids,_a9,!_a3,function(_b1,_b2){var _b3;if(id){if(_a9.id){_b3=_c.filter(_b1,function(_b4){return _b4.getGuid()===id;})[0];if(_b3===undefined){_21(_a2,_9e,new _2("Returned objects do not contain requested one"),"get");return;}}else{_b3=_b1[0]||null;}}else{_b3=_b1;}try{if(_a1){_a1.call(_9e,_b3,{count:_b2});}}catch(e){_6.error(_12+".get: error in handler for "+(id?id:"["+ids+"]")+": "+e.message+" "+(_9e?"("+_9e+")":""));}},function(e){_21(_a2,_9e,e,"get");});return true;}else{_15.getByXPath(_9f,_a9,_a4,_a6,function(_b5,_b6,_b7){_1c(_a1,_9e,[_b5,{count:_b6,aggregates:_b7}],".get: error in error handler for xpath "+_9f);},_aa);return true;}}}};this.getBySchema=function(_b8,_b9){var _ba=_b8.id,_bb=_b8.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_b8},options:{callback:function(_bc,_bd){var _be=[],_bf;_c.forEach(_bd.mxobjects,function(_c0){var _c1=new _4({json:_c0,meta:window.mx.meta.getEntity(_c0.objectType)});if(_c0.guid==_ba){_bf=_c1;}_be.push(_c1);});_bf.attachReferences(_be);_bb&&_bb(_bf,false);},error:function(e){_21(_b8.error,_b9,e,"getBySchema");}}});};this.getSlice=function(_c2,_c3,_c4,_c5,_c6){_15.getSlice(_c2,_c3,_c4).spread(function(_c7,_c8){if(_c5){_c5(_c7,_c8);}}).caught(function(e){if(_c6){_c6(e);}else{mx.onError(e);}});};this.fetch=function(obj,_c9,_ca,_cb,_cc){if(_d.isFunction(_ca)){_cc=_cb;_cb=_ca;}var _cd;if(!_c9){_cd=[];}else{if(_c9 instanceof Array){_cd=_c9.slice();}else{_cd=_c9.split("/");}}if(obj&&obj.isA(_cd[0])){_cd.shift();}var _ce;if(_cd.length%2==1){_ce=_cd.pop();}else{_ce="";}_15.fetch(obj,_cd,_ce,_ca,_cb,_cf);function _cf(e){_21(_cc,null,e,"fetch");};};this.release=function(_d0){if(!_d0){return;}_d0=_d0 instanceof Array?_d0:[_d0];for(var i=0,len=_d0.length;i<len;++i){if(_d0[i]){_15.release(_d0[i].getGuid());}}};this.create=function(_d1,_d2){if(typeof _d1.callback!="function"){throw new _2(_12+".create: callback is not a function");}else{if(_d1.error&&typeof _d1.error!="function"){throw new _2(_12+".create: error is not a function");}else{if(typeof _d1.entity!="string"){throw new _2(_12+".create: entity is not a string");}}}_15.create(_d1.entity,_d1.persistent,function(obj){if(_d1.context){_11.setObjectToContext(obj,_d1.context);}_d1.callback.call(_d2,obj);},function(e){_21(_d1.error,_d2,e,"create");});};this.jsonToMxObject=function(_d3){return new _4({json:_d3,meta:window.mx.meta.getEntity(_d3.objectType)});};this.remove=function(_d4){var _d5=("guid" in _d4)?[_d4.guid]:_d4.guids;if(("guids" in _d4)&&!(_d4.guids instanceof Array)){throw new _2(_12+".remove: parameter guids set but not of type Array");}else{if(_d4.error&&typeof _d4.error!="function"){throw new _2(_12+".remove: parameter error set but not of type Function");}else{if(_d4.callback&&typeof _d4.callback!="function"){throw new _2(_12+".remove: parameter callback set but not of type Function");}}}_15.remove(_d5,_d4.callback,_d6);function _d6(e){_21(_d4.error,null,e,"remove");};};this.save=function(_d7,_d8){if(typeof _d7.callback!="function"){throw new _2(_12+".save: callback is not a function");}else{if(_d7.mxobj!=null&&!(_d7.mxobj instanceof _4)){throw new _2(_12+".save: mxobj is not an MxObject");}}_15.save(_d7.mxobj,_d7.standalone,_d7.onValidation,_d9,_da);function _d9(){var msg=".save: error calling handler";if(_d7.mxobj){msg+=" for ["+_d7.mxobj.getGuid()+"]";}_1c(_d7.callback,_d8,null,msg);};function _da(_db){var err;if(_db instanceof Error){err=_db;}else{if(_db){err=new _3();_11.sendValidationUpdates([_db.clone()]);}}_21(_d7.error,_d8,err,"save");};};this.commit=function(_dc,_dd){if(typeof _dc!="object"){throw new _2(_12+".commit: args is not an object");}else{if(typeof _dc.callback!="function"){throw new _2(_12+".commit: callback is not a function");}else{if(_dc.mxobj!=null&&!(_dc.mxobj instanceof _4)){throw new _2(_12+".commit: mxobj is not a MxObject");}}}if(!_dc.mxobj&&_dc.callback){_1c(_dc.callback,_dd,null,".commit: error when executing handler without object");return;}_15.commit(_dc.mxobj.getGuid(),_dc.context,_dc.store,_dc.onValidation,_de,_df);function _de(){_11.objectUpdateNotification(_dc.mxobj);_1c(_dc.callback,_dd,null,".commit: error when executing handler for ["+_dc.mxobj.getGuid()+"]");};function _df(e){_21(_dc.error,null,e,"commit");};};this.rollback=function(_e0,_e1){if(typeof _e0!="object"){throw new _2(_12+".rollback: args is not an object");}else{if(typeof _e0.callback!="function"){throw new _2(_12+".rollback: callback is not a function");}else{if(_e0.mxobj!=null&&!(_e0.mxobj instanceof _4)){throw new _2(_12+".rollback: mxobj is not a MxObject");}}}if(!_e0.mxobj){_1c(_e0.callback,_e1,null,".rollback: error in handler");return;}var _e2=_e0.mxobj;var _e3=_e2.getEntity();var _e4=_e2.getGuid();_15.rollback(_e2,_e5,_e6);function _e5(_e7){if(_e7){_e2.resetFromJSON(_e7.jsonData);_11.objectUpdateNotification(_e7);}_e2.reset();_11.sendClassUpdate(_e3);_1c(_e0.callback,_e1,null,_12+".rollback: error in handler for ["+_e4+"]");};function _e6(e){_21(_e0.error,null,e,"rollback");};};this.synchronize=function(_e8,_e9){return _15.upload(_14).caught(function(e){if(!(e instanceof _1)){return _15.cleanupDirtyObjects().then(function(){return null;});}else{throw e;}}).then(function(_ea){return _15.download().then(function(){if(_e8){_e8(_ea);}});}).caught(function(e){if(_e9){_e9(e);}});};this.invalidateCaches=function(_eb){_15.invalidateCaches(_eb);};this.matchObjectsToContext=function(_ec){var _ed=_ec.entity,_ee=_ec.context,_ef=_ec.mxobjs,_f0=_ec.callback,_f1=[];_40(window.mx.meta.getEntity(_ed),_ee,function(_f2){var _f3=_62(_f2);for(var i=0,obj;obj=_ef[i];i++){var _f4=0;for(var x=0,_f5;_f5=_f3[x];x++){var ref=_f5.ref,_f6=_f5.ref_ids,ids=obj.getReferences(ref),_f7=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_f6.match(ids[j])){_f7=true;break;}}}_f7&&_f4++;}if(_f4==_f3.length){_f1.push(obj);}}_f0(_f1);});};this.createXPathString=function(_f8){var _f9=_f8.callback,_fa=_f8.entity||_f8.className,_fb=_f8.context;var _fc=_fb&&_fb.getContexts();if(!_fc||_fc.length===0){_f9("//"+_fa);return;}_53(_f8);};this.generateExport=function(_fd){window.mx.server.request({request:{action:"export",params:_fd.params},options:{callback:_fd.callback,error:function(e){_21(_fd.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_fe,_ff){if(typeof _fe!="object"){throw new _2(_12+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _ff!="object"){throw new _2(_12+".setObjectToContext: parameter context is not of type Object");}}try{var _100=_fe.getAttributes();for(var e=0;e<_100.length;e++){if(_fe.isReference(_100[e])){var _101=_fe.getSelectorEntity(_100[e]);if((_100[e]=="System.owner")||(_100[e]=="System.changedBy")){continue;}if(_ff.hasContext(_101)){_fe.addReference(_100[e],_ff.getContext(_101));}var meta=window.mx.meta.getEntity(_101);if(meta){if(meta.hasSubEntities()){var _102=meta.getSubEntities();for(var i=0;i<_102.length;i++){if(_ff.hasContext(_102[i])){_fe.addReference(_100[e],_ff.getContext(_102[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_103){_103.type="sum";_5d(_103);};this.countOfXPathSet=function(_104){_104.type="count";_5d(_104);};this.sizeOfXPathSet=function(_105){_105.type="count";_5d(_105);};this.avgOfXPathSet=function(_106){_106.type="avg";_5d(_106);};this.maxOfXPathSet=function(_107){_107.type="max";_5d(_107);};this.minOfXPathSet=function(_108){_108.type="min";_5d(_108);};this.makeChange=function(_109,attr,_10a){_15.makeChange(_109,attr,_10a);this.update({guid:_109.getGuid(),attr:attr,value:_109.get(attr)});};this.flush=function(_10b){_15.flush(_10b);};this.getDocumentUrl=function(guid,_10c,_10d){return _18(guid,_10c,_10d);};};return _f;});