/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Data",["mendix/lib/Error","mendix/lib/ValidationError","mendix/lib/ObjectValidation","mendix/ov","mendix/lib/MxObject","mendix/lang","mendix/logger","dojo/_base/array","dojo/_base/lang","big/big"],function(_1,_2,_3,ov,_4,_5,_6,_7,_8,_9){function _a(){var _b=this,_c="mendix.sys.Data",_d={},_e={},_f={},_10={},_11={entities:{},guids:{},attrs:{},vals:{}};var _12=function(_13,_14,map){if(!_14){return _13;}for(var i in map){if((i in _14)&&(_14[i]!=null)){_13[i]=_14[i];}}return _13;};var _15=function(_16,_17,_18,_19){try{_16&&_16.apply(_17,_18||[]);}catch(e){_6.error(_c+_19+" : "+e.message+" "+(_17?"("+_17+")":""));}};var _1a=function(_1b,_1c,e,_1d){try{if(_1b){_1b.call(_1c,e);}else{_6.error("unhandled error: "+e.message);window.mx.onError(e);}}catch(err){_6.error("error in "+_c+"."+_1d+" while calling error handler: "+err.message);}};var _1e=function(ids){var _1f=[];for(var i=0,id;id=ids[i++];){if(_d[id]!==undefined){_1f.push(_d[id]);}}return _1f;};var _20=function(_21){var _22=_5.itemCount;return (_22(_11.guids[_21])||_22(_11.attrs[_21]));};var _23=function(_24){var _25=0;for(var i=0,_26;_26=_24[i];i++){if(_d[_26]&&!_20(_26)){delete _d[_26];delete _10[_26];delete _e[_26];window.mx.server.release(_26);_25++;}}};var _27=function(_28,_29,_2a,_2b){var _2c=[],_2d=[],_2e=false;if(!(_2b instanceof Array)){_2e=!!_2b;_2b=[];}for(var i=0,_2f;_2f=_28[i];++i){var _30=_2f.guid,_31=_d[_30],inc=(_2e||_7.indexOf(_2b,_30)>=0)?1:0;if(!_29){delete _10[_30];}if(_2a&&_31){if(!_29||!_31.hasChanges()){_31.resetFromJSON(_2f);}_e[_30]+=inc;_2c.push(_31);}else{var obj=new _4({json:_2f,meta:window.mx.meta.getEntity(_2f.objectType)});if(_2a){_d[_30]=obj;_e[_30]=inc;}if(_31){_2d.push(_31.getGuid());}_2c.push(obj);}}if(!_2a){_23(_2d);}return _2c;};var _32=function(_33,_34,_35){var _36=function(_37,_38){var _39;if(_38.mxobject){_39=[_38.mxobject];}else{if(_38.mxobjects&&_38.mxobjects.mxobjects){_39=_38.mxobjects.mxobjects;if(!_39.length){_39=[_39];}}else{_39=_38.mxobjects;}}var _3a=(_39&&_39.length)?_27(_39,true,_34,_35):[];_33(_3a,{count:_38.count,aggregates:_7.map(_38.aggregates,function(agg){return agg===""?agg:new _9(agg);})});};return _36;};var _3b=function(_3c,_3d){var obj=_3d,_3e=_3c.getGuid(),_3f=_d[_3e];if(obj){if(_3f){_3f.resetFromJSON(obj.jsonData);}else{_3f=_d[_3e]=obj;_e[_3e]=0;}if(_3c!=_3f){_3c.resetFromJSON(obj.jsonData);}_b.objectUpdateNotification(obj);}else{_d[_3e]=null;if(_3f){_3f.resetFromJSON(null);}}};var _40=function(_41,_42){var _43={};_7.forEach(_41.getAttributes(),function(ref){if(!_41.isReference(ref)){return;}var _44=_42.getContext(_41.getSelectorEntity(ref));if(_44){_43[ref]=_44;}});return _43;};var _45=function(_46,_47,_48,_49){var _4a=_47.split("/");var _4b=function(_4c){var _4d=_4a.shift(),ref=_4a.shift(),_4e;if(_4c==null||_4c.length==null||_4c.length===0){_48(null);return;}var _4f=[];for(var i=0;i<_4c.length;i++){if(_4c[i]==null){continue;}_4f.push("id='"+_4c[i].getGuid()+"'");}if(!_4f.length){_48(null);return;}var ids=_4f.join(" or ");_4e="["+ref+"/"+_4d+"["+ids+"]]";if(_4a.length==1){_48(_4e);}else{var _50=_4a[0];_4d=_4a.shift();ref=_4a.shift();_48("["+ref+"/"+_4d+""+_4e+"]");}};var _51=function(){var _52=_4a.shift(),ref=_4a.shift();if(_4a.length==1){var _53="["+ref+"='"+_46.getGuid()+"']";_48(_53);return;}if(window.mx.meta.getEntity(_52)==null){_1a(_49,null,new _1(_c+".runMapPath: entity"+_52+" does not exist"),"runMapPath");return;}if(!_46.isA(_52)){_1a(_49,null,new _1(_c+".runMapPath: entity "+_46.getEntity()+" is not a "+_52+" or one of its subclasses"),"runMapPath");return;}if(!_46.has(ref)){_1a(_49,null,new _1(_c+".runMapPath: reference "+ref+" not found in entity "+_52),"runMapPath");return;}if(_46.get2(ref)!==""){_b.get({guids:_46.getReferences(ref),callback:_4b,error:_49});}else{_48(null);}};_51();};this.getBacktrackConstraints=function(_54,_55,_56,_57,_58){if(!_8.isFunction(_57)){_58=_57;_57=null;}_b.getBacktrack(_55.getTrackId(),_55.getConstraints(),_56,_57,_58);};var _59=this.getBacktrackConstraints;this.getBacktrack=function(_5a,_5b,_5c,_5d,_5e){if(!_8.isFunction(_5d)){_5e=_5d;_5d=null;}if(!_5b||_5b.length===0){_5c.call(_5e,"",true);return;}var _5f=null,_60=[],_61=0,_62=true;var _63=function(){var _64=_5b[_61++];if(_64){_45(_5f,_64,function(_65){if(_65){_60.push(_65);}else{_62=false;}_63();},function(e){_1a(_5d,_5e,e,"getBacktrack");});}else{_5c.call(_5e,_60.join(""),_62);}};if(!_5a){_5c.call(_5e,"",false);}else{_b.get({guid:_5a,callback:function(obj){_5f=obj;_63();},error:function(e){_1a(_5d,_5e,e,"getBacktrack");}});}};var _66=function(_67,_68){var _69=[],_6a=_40(_67,_68);for(var m in _6a){if(m=="System.changedBy"||m=="System.owner"){continue;}if(_67.has(m)){var _6b=_67.getAttributeType(m);switch(_6b){case "ObjectReference":_69.push("["+m+"='"+_6a[m]+"']");break;case "ObjectReferenceSet":_69.push("["+m+"='"+_6a[m]+"']");break;default:}}}return _69.join("");};var _6c=function(_6d){var _6e=_6d.entity||_6d.className,_6f=window.mx.meta.getEntity(_6e),_70=_6d.context,_71="//"+_6e,_72=_66(_6f,_70);var _73=function(_74,_75){if(_6d.callback){_6d.callback(_71+_72+_74,_75);}};if(_70.getConstraints().length!==0){_59(_6f,_70,_73,_6d.error);}else{_73("",true);}};var _76=function(_77){window.mx.server.request({request:{action:"retrieve_xpath_aggregate",params:{xpath:_77.type+"("+_77.xpath+")",resulttype:_77.resulttype||"integer"}},options:{callback:function(_78,_79){var _7a;if(_79){if(_77.resulttype=="float"){_7a=parseFloat(_79.value).toFixed(2)||"0.00";}else{_7a=_79.value||0;}}else{_7a=0;}_77.callback&&_77.callback(_7a);},error:function(e){_1a(_77.error,null,e,"numericXPathResult");},useCache:false,preventCache:true}});};var _7b=function(_7c){var _7d;if(_7c===""){return;}else{if(_7c.match(/^\[[^=\[]+=.[0-9]+./)){_7d=_7.map(_7c.match(/\[.+?\]/g),function(_7e){_7e=_7e.substr(1,_7e.length-2);return {ref:_7e.match(/[^=]+/)[0],ref_ids:_7e.match(/\d+/)[0]};});}else{_7d=_7.map(_7c.match(/\[.+?\]]/g),function(_7f){_7f=_7f.substr(1,_7f.length-3);var _80=_7f.split("[");return {ref:_80[0].split("/")[0],ref_ids:_80[1]};});}}return _7d;};var _81=function(){var _82=0;for(var _83 in _d){if(_e[_83]===0&&!_20(_83)){delete _d[_83];delete _e[_83];delete _10[_83];window.mx.server.release(_83);}else{++_82;}}};this.toString=function(){return _c;};this.startup=function(){window.mx.server.registerCaller(_8.hitch(this,"flush"));window.setInterval(_81,10000);};this.subscribe=function(_84,_85){var id=_5.getUniqueId(),_86=_84.entity,_87=_84.guid,val=_84.val,_88=_84.attr,_89=_85?function(){_84.callback.apply(_85,arguments);}:_84.callback;if(_88){if(!_11.attrs[_87]){_11.attrs[_87]={};}if(!_11.attrs[_87][_88]){_11.attrs[_87][_88]={};}_11.attrs[_87][_88][id]=_89;}else{if(val){if(!_11.vals[_87]){_11.vals[_87]={};}_11.vals[_87][id]=_89;}else{if(_87){if(!_11.guids[_87]){_11.guids[_87]={};}_11.guids[_87][id]=_89;}else{if(_86){if(!_11.entities[_86]){_11.entities[_86]={};}_11.entities[_86][id]=_89;}else{_6.error(_c+".subscribe: no 'entity' or 'guid' parameter found");}}}}return {entity:_86,guid:_87,val:val,attr:_88,id:id};};this.unsubscribe=function(_8a){if(_8a==null){return;}var id=_8a.id,_8b=_8a.entity,_8c=_8a.guid,val=_8a.val,_8d=_8a.attr,_8e=_5.itemCount;if(_8d){var _8f=_11.attrs[_8c];if(!_8f){}else{if(!_8f[_8d]){}else{delete _8f[_8d][id];if(_8e(_8f[_8d])===0){delete _8f[_8d];}if(_8e(_8f)===0){delete _11.attrs[_8c];}}}}else{if(val){if(!_11.vals[_8c]){}else{delete _11.vals[_8c][id];if(_8e(_11.vals[_8c])===0){delete _11.vals[_8c];}}}else{if(_8c){var _90=_11.guids[_8c];if(!_90){}else{delete _90[id];if(_8e(_90)===0){delete _11.guids[_8c];}}}else{if(_8b){var _91=_11.entities[_8b];if(!_91){}else{delete _91[id];if(_8e(_91)===0){delete _11.entities[_8b];}}}}}}};this.update=function(_92){var _93=_92.guid,_94=_92.entity,_95=_92.attr,val=_92.val,_96=_92.value,_97=_92.callback;var _98=function(_99,_9a){var map=_99?_8.clone(_99):{};for(var key in map){map[key].apply(null,_9a);}};if(_95){_98(_11.attrs[_93]&&_11.attrs[_93][_95],[_93,_95,_96]);}else{if(_93){_98(_11.guids[_93],[_93]);}else{if(val){_98(_11.vals[_93],[_93]);}else{if(_94){_98(_11.entities[_94],[_94]);}else{_6.error(_c+".update: no 'entity' or 'guid' parameter found");}}}}_97&&_97();};this.objectUpdateNotification=function(_9b){_b.sendClassUpdate(_9b.getEntity());_b.update({guid:_9b.getGuid()});};this.sendClassUpdate=function(_9c){var _9d=window.mx.meta.getEntity(_9c);if(!_9d){throw new _1("No permission to read or write entity "+_9c+", check security!");}_7.forEach([_9c].concat(_9d.getSuperEntities()),function(ent){_b.update({entity:ent});});};this.objectPing=function(_9e,_9f){var _a0=_9e.getGuid(),_a1=_8.clone(_11.guids[_a0]),_a2=[];if(_a1){for(var sub in _a1){_a2.push((function(_a3,sub){return function(cb){try{var _a4=_a3[sub];if(_a4.length==2){_a4(_a0,cb);}else{_a4(_a0);cb();}}catch(e){if(_a3){delete _a3[sub];}cb();}};})(_a1,sub));}_5.collect(_a2,_9f);}else{_9f&&_9f();}};this.addValidation=function(_a5,_a6,_a7){if(!_10[_a5]){_10[_a5]=new _3({msg:{guid:_a5}});}_10[_a5].addField(_a6,_a7);};this.sendValidationUpdates=function(_a8){var _a9,_aa=[];for(var i=0,_ab;_ab=_a8[i];i++){_a9=_11.vals[_ab.getGuid()];var cp=_ab.clone(),_ac=cp.getAttributes();if(_a9){for(var x in _a9){var _ad=_ab.clone();try{_a9[x]([_ad]);}catch(e){_6.error(_c+".sendValidationUpdates: trouble triggering validation update: "+e.message);delete _a9[x];}var _ae=_ad.getAttributes();_7.forEach(_ac,function(_af){var _b0=_af.name,_b1=_7.some(_ae,function(_b2){return _b2.name==_b0;});if(!_b1){cp.removeAttribute(_af.name);}},this);}}else{}if(cp.getAttributes().length){_aa.push(cp);}}window.mx.ui.validations(_aa);};this.action=function(_b3){var _b4=_b3.context,_b5=_b3.callback,_b6=_b3.error,_b7=_b3.complete,_b8=_b3.onValidation,_b9=!!_b3.async,_ba=_b3.params,_bb=_b3.store;window.mx.server.request({request:{action:"executeaction",params:_ba,context:_b4},options:{callback:function(_bc,_bd,_be){var _bf=_bd.actionResult,_c0;if(_bf instanceof Array){_c0=_27(_bf,false,true,true);}else{if(typeof _bf=="object"&&_bf.guid){_c0=_27([_bf],false,true,true);}else{_c0=_bd.actionResult;}}if(_b5){_b5(_c0,_be);}if(_b7){_b7();}},error:function(e){_1a(_b6,null,e,"action");if(_b7){_b7();}},store:_bb,async:_b9,onValidation:_b8}});};this.setOrRetrieveMxObject=function(_c1){return _27([_c1],false,true)[0];};this.get=function(_c2,_c3){var _c4=_c2.xpath,_c5=_c2.path,id=_c2.guid,ids=(!("guids" in _c2)&&id)?[id]:_c2.guids,_c6=_c2.callback,_c7=_c2.error,_c8=!!_c2.noCache,_c9=!!_c2.count,_ca=_c2.filter,_cb=!!_c2.aggregates,_cc=_c2.context,_cd=_c2.microflow,err;if(("guid" in _c2)&&id==null){_15(_c6,_c3,[null],"");return;}if(!_c4&&!ids&&!_cd){err=_c+".get: xpath, guid|guids and microflow arguments are undefined";_6.error(err);throw new _1(err);}if(_c5&&ids.length!=1){throw new _1(_c+".get : path can only be used with a single guid");}if(typeof _c6!="function"){err=_c+".get: callback is not a function";_6.error(err);throw new _1(err);}else{if(_c7&&typeof _c7!="function"){err=_c+".get: error is not a function";_6.error(err);throw new _1(err);}}if(_ca){if(_ca.limit){_ca.amount=_ca.limit;delete _ca.limit;}if(_ca.references){for(var r in _ca.references){var ref=_ca.references[r];if(ref.limit){ref.amount=ref.limit;delete ref.limit;}}}}var val=null,_ce=_12({},_ca,!id?{"id":val,"attributes":val,"offset":val,"sort":val,"amount":val,"distinct":val,"references":val,"depth":val}:{"id":val}),_cf=function(e){_1a(_c7,_c3,e,"get");};if(_ce.id&&ids&&!id){delete _ce.id;}if(_ce.id){delete _ce.attributes;delete _ce.distinct;}if(_cd){var _d0=ids?"selection":(_c4?"set":"none"),_d1={actionname:_cd,applyto:_d0};if(_d0=="selection"){_d1.guids=ids;}else{if(_d0=="set"){_d1.xpath=_c4;if(_ce.sort){_d1.sort=_ce.sort;}}}this.action({params:_d1,context:_cc,callback:function(_d2,_d3){_c6&&_c6.call(_c3,_d2,_d3);},error:_cf});}else{if(_c5&&ids){window.mx.server.request({request:{action:"retrieve_by_path",params:{id:ids[0],path:_c5},context:null},options:{callback:_32(function(_d4,_d5){_15(_c6,_c3,[_d4,_d5],".get: error in handler for ["+ids+"]");},true,true),error:_cf}});}else{if(ids){if(ids.length===0){_15(_c6,_c3,[id?null:[],{count:0}],".get: error in handler");return;}if(!_c8){var _d6=_1e(ids),_d7=_d6.length==ids.length;if(_d7){var _d8=_d6;if(_ce.sort){_7.forEach(_ce.sort,function(_d9){var _da=_d9[0],dir=_d9[1];_d8=_d8.sort(dir=="asc"?function(a,b){a=a.get2(_da);b=b.get2(_da);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get2(_da);b=b.get2(_da);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _db=_ce.offset;if(_db){var _dc=_ce.amount;if(_dc){_d8=_d8.slice(_db,_db+_dc);}else{_d8=_d8.slice(_db);}}for(var i=0,_dd;_dd=_d8[i];++i){++_e[_dd];}_15(_c6,_c3,[id?_d8[0]:_d8,{count:_d6.length}],".get: error in handler for ["+ids+"]");return true;}}var _de=_ce.attributes==null;window.mx.server.request({request:{action:"retrieve_by_ids",params:{ids:ids,schema:_ce}},options:{callback:_32(function(_df,_e0){var _e1=_df[0];if(id&&_ce.id){for(var i=0,obj;obj=_df[i];++i){if(obj.getGuid()==id){_e1=obj;break;}}}_15(_c6,_c3,[id?_e1:_df,_e0],".get: error in handler for ["+ids+"]");},_de,ids),error:_cf}});return true;}else{window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_c4,schema:_ce,count:_c9,aggregates:_cb}},options:{callback:_32(function(_e2,_e3){_15(_c6,_c3,[_e2,_e3],".get: error in error handler for xpath "+_c4);},false),error:_cf}});return true;}}}};this.getBySchema=function(_e4,_e5){var _e6=_e4.id,_e7=_e4.callback;window.mx.server.request({request:{action:"retrieve_by_id_with_schema",params:_e4},options:{callback:function(_e8,_e9){var _ea=[],_eb;_7.forEach(_e9.mxobjects,function(_ec){var _ed=new _4({json:_ec,meta:window.mx.meta.getEntity(_ec.objectType)});if(_ec.guid==_e6){_eb=_ed;}_ea.push(_ed);});_eb.attachReferences(_ea);_e7&&_e7(_eb,false);},error:function(e){_1a(_e4.error,_e5,e,"getBySchema");}}});};this.fetch=function(obj,_ee,_ef,_f0,_f1){var _f2=obj,_f3=false,_f4,_f5,_f6;if(_8.isFunction(_ef)){_f1=_f0;_f0=_ef;}if(!_ee){_f4=[];}else{if(_ee instanceof Array){_f4=_ee.slice();}else{_f4=_ee.split("/");}}if(obj&&obj.isA(_f4[0])){_f4.shift();}if(_f4.length%2==1){_f6=_f4.pop();}else{_f6="";}if(_ef.schema){_f5=_f4.splice(-2,_f4.length);}else{_f5=[];}var _f7=function(_f8,ref){if(_f8.isObjectReference(ref)){return _f8.getReference(ref);}else{if(_f8.isObjectReferenceSet(ref)){return _f8.getReferences(ref);}else{return _f8.get2(ref);}}};var _f9=function(){if(_f2==null){_f0(null,false);}else{if(!_f6){_f0(_f2,_f3);}else{if(_f6){_f0(_f7(_f2,_f6),false);}}}};var _fa=function(ref){if(_f2.getReferences(ref).length===0){_f0([],false);}else{if(_f2.hasChildren(ref)){_f0(_f2.getChildren(ref),false);}else{window.mx.data.get({guids:_f2.getReferences(ref),filter:{id:_ef.schema},callback:function(_fb){_f0(_fb,true);},error:_f1});}}};var _fc=function(ref,_fd){var _fe=_f2.getReference(ref);if(_fe){window.mx.data.get({guid:_fe,filter:{id:_fd},callback:function(obj){if(obj){_f2=obj;_f3=true;_ff();}else{_f0(null,false);}},error:_f1});}else{_f0(null,false);}};var _100=function(path){var _101,_102;if(path.length<3){return false;}_101=window.mx.meta.getEntity(path.slice(-3)[0]),_102=_f4.slice(-2)[0];return _101.isObjectReferenceSet(_102);};var _103=function(_104,type){var _105=["//"+type+"[id="+_104+"]"],_106=_100([type].concat(_f4));Array.prototype.push.apply(_105,_f4);_f4=[];window.mx.data.get({xpath:_105.join("/"),callback:function(objs){if(objs.length===0){_f0(null,false);}else{if(_f6&&objs.length==1){_f2=objs[0];_f9();}else{if(!_f6){if(_106){_f0(objs,false);}else{_f2=objs[0];_ff();}}else{_1a(_f1,null,new _1(_c+".fetch"+_f6+" is not a reference type"),"fetch");}}}},error:_f1});};var _ff=function(){var ref,type,_107,_108;if(_f4.length+_f5.length===0){_f9();}else{if(_f4.length===0&&_f5.length>0){ref=_f5.shift();type=_f5.shift();if(_f2.isObjectReferenceSet(ref)){_fa(ref);}else{_fc(ref,_ef.schema);}}else{if(_f3){window.mx.data.release(_f2);_f3=false;}ref=_f4.shift();type=_f4.shift();if(_f2.isObjectReferenceSet(ref)){if(_f4.length>0||_f5>0){_1a(_f1,null,new _1(_c+".fetch: reference set should be at end of path"),"fetch");}else{_fa(ref);}}else{if(_f2.isObjectReference(ref)){_107=_f2.getChild(ref);if(_107){_f2=_107;_ff();}else{_108=_f2.getReference(ref);if(!_108){_f0(null,false);}else{if(_d[_108]!==undefined){_f2=_d[_108];++_e[_108];_f3=true;_ff();}else{if(_ef.usexpath&&_f4.length>0){_103(_108,type);}else{_fc(ref);}}}}}else{_1a(_f1,null,new _1(_c+".fetch: attribute "+ref+" is not a reference type"),"fetch");}}}}};_ff();};this.release=function(objs){if(!objs){return;}objs=objs instanceof Array?objs:[objs];var _109=[];for(var i=0,len=objs.length;i<len;++i){var obj=objs[i];if(obj){var guid=obj.getGuid();if(_e[guid]){if(--_e[guid]===0&&!_20(guid)){_109.push(guid);}}else{}}}_23(_109);};this.create=function(_10a,_10b){var _10c=_10a.error,_10d=_10a.context,_10e=_10a.entity,_10f=_10a.persistent,err;if(typeof _10a.callback!="function"){err=_c+".create: callback is not a function";_6.error(err);throw new _1(err);}else{if(_10c&&typeof _10c!="function"){err=_c+".create: error is not a function";_6.error(err);throw new _1(err);}else{if(typeof _10e!="string"){err=_c+".create: entity is not a string";_6.error(err);throw new _1(err);}}}var _110=function(objs){var obj=objs&&objs[0];if(_10d){_b.setObjectToContext(obj,_10d);}_10a.callback.call(_10b,obj);};var _111=function(e){_1a(_10c,_10b,e,"create");};window.mx.server.request({request:{action:_10f?"create":"instantiate",params:{objecttype:_10a.entity,preventCache:(new Date()).getTime()}},options:{callback:_32(_110,true,true),error:_111}});};this.jsonToMxObject=function(json){return new _4({json:json,meta:window.mx.meta.getEntity(json.objectType)});};this.remove=function(_112){var _113=_112.error,_114=_112.callback,_115=("guid" in _112)?[_112.guid]:_112.guids;if(("guids" in _112)&&!(_112.guids instanceof Array)){throw new _1(_c+".remove: parameter guids set but not of type Array");}else{if(_113&&typeof _113!="function"){throw new _1(_c+".remove: parameter error set but not of type Function");}else{if(_114&&typeof _114!="function"){throw new _1(_c+".remove: parameter callback set but not of type Function");}}}window.mx.server.request({request:{action:"delete",params:{guids:_115}},options:{callback:function(){_23(_115);_5.nullExec(_114);},error:function(e){_1a(_113,null,e,"remove");}}});};this.save=function(_116,_117){var _118,_119,_11a,_11b,guid,msg,emsg=".save: error calling handler",e,_11c,_11d,_11e,_11f,obj;if(_116){_11a=_116.mxobj;_118=_116.callback;_119=_116.error;_11b=_116.standalone;}if(typeof _118!="function"){e=_c+".save: callback is not a function";_6.error(e);throw new _1(e);}else{if(_11a!=null&&!(_11a instanceof _4)){e=_c+".save: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(_11a){guid=_11a.getGuid();emsg=".save: error calling handler for ["+guid+"]";msg=_10[guid];if(msg){var data=null;if(msg instanceof _1){data=msg;}else{if(msg){data=new _2();this.sendValidationUpdates([msg.clone()]);}}_1a(_119,_117,data,"save");return;}else{if(!_11a.hasChanges()){_15(_118,_117,null,emsg);return;}}}_11d={};if(!_11b){_11c=_f;_f={};_11e=0;_11f=0;for(var id in _11c){_11f++;obj=_11c[id];if(obj.hasChanges()){_11e++;_11d[id]=obj._collectChanges();}delete _10[id];}if(!_11e){if(_11f){}_15(_118,_117,null,emsg);return;}}if(_11a&&!_11c[guid]){_11d[guid]=_11a._collectChanges();_11c={guid:_11a};delete _f[guid];delete _10[guid];}window.mx.server.request({request:{action:"change",params:_11d},options:{onValidation:_116.onValidation,sync:true,unique:true,callback:function(){for(var guid in _11c){_11c[guid]._applyChangeSet();}_11c=null;_15(_118,_117,null,emsg);},error:function(e){data=e.original||{};var _120=false,_121=guid;if(ov.hasValidations(data)){_7.forEach(ov.getValidations(data),function(v){var id=v.getGuid();if(_11c[id]){_10[id]=v;delete _11c[id];}if(_11a&&id==_121){_120=true;}});for(var id in _11c){_11c[id]._applyChangeSet();}}else{_8.mixin(_f,_11c);_120=true;}_11c=null;if(_11a){if(_120){_1a(_119,null,e,"save");}else{_15(_118,_117,null,emsg);}}else{_15(_118,_117,null,emsg);}}}});};this.commit=function(_122,_123){var obj,_124,_125,_126,_127,guid,e,msg;if(_122){obj=_122.mxobj;_124=_122.callback;_125=_122.error;_126=_122.onValidation;_127=_122.context;}if(typeof _124!="function"){e=_c+".commit: callback is not a function";_6.error(e);throw new _1(e);}else{if(obj!=null&&!(obj instanceof _4)){e=_c+".commit: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(obj==null){_15(_124,_123,null,".commit: error when executing handler");}else{guid=obj.getGuid();msg=".commit: error when executing handler for ["+guid+"]";window.mx.server.request({request:{action:"commit",params:{guid:guid},context:_127},options:{callback:function(){delete _10[guid];delete _f[guid];_b.objectUpdateNotification(obj);_15(_124,_123,null,msg);},error:function(e){_1a(_125,null,e,"commit");},onValidation:_126,store:_122.store}});}};this.rollback=function(_128,_129){var _12a,obj,_12b;if(_128){_12a=_128.callback;obj=_128.mxobj;_12b=_128.error;}var emsg=".rollback: error in handler ",e;if(typeof _12a!="function"){e=_c+".rollback: callback is not a function";_6.error(e);throw new _1(e);}else{if(obj!=null&&!(obj instanceof _4)){e=_c+".rollback: mxobj is not a MxObject";_6.error(e);throw new _1(e);}}if(!obj){_15(_12a,_129,null,emsg);}else{var guid=obj.getGuid(),claz=obj.getEntity();emsg=_c+".rollback: error in handler for ["+guid+"]";delete _10[guid];delete _f[guid];window.mx.server.request({request:{action:"rollback",params:{guid:guid}},options:{unique:true,standalone:true,callback:_32(function(objs){obj.reset();_3b(obj,objs[0]);_b.sendClassUpdate(claz);_15(_12a,_129,null,emsg);},false),error:function(e){_1a(_12b,null,e,"rollback");}}});}return true;};this.mxObjectsCallback=function(_12c){return _32(_12c,false);};this.matchObjectsToContext=function(_12d){var _12e=_12d.entity,_12f=_12d.context,_130=_12d.mxobjs,_131=_12d.callback,_132=[];_59(window.mx.meta.getEntity(_12e),_12f,function(_133){var _134=_7b(_133);for(var i=0,obj;obj=_130[i];i++){var _135=0;for(var x=0,_136;_136=_134[x];x++){var ref=_136.ref,_137=_136.ref_ids,ids=obj.getReferences(ref),_138=false;if(ids!==false){for(var j=0;j<ids.length;j++){if(_137.match(ids[j])){_138=true;break;}}}_138&&_135++;}if(_135==_134.length){_132.push(obj);}}_131(_132);});};this.createXPathString=function(_139){var _13a=_139.callback,_13b=_139.entity||_139.className,_13c=_139.context;var _13d=_13c&&_13c.getContexts();if(!_13d||_13d.length===0){_13a("//"+_13b);return;}_6c(_139);};this.generateExport=function(_13e){window.mx.server.request({request:{action:"export",params:_13e.params},options:{callback:_13e.callback,error:function(e){_1a(_13e.error,null,e,"generateExport");},useCache:false,async:true}});};this.setObjectToContext=function(_13f,_140){if(typeof _13f!="object"){throw new _1(_c+".setObjectToContext: parameter mxObj is not of type Object");}else{if(typeof _140!="object"){throw new _1(_c+".setObjectToContext: parameter context is not of type Object");}}try{var _141=_13f.getAttributes();for(var e=0;e<_141.length;e++){if(_13f.isReference(_141[e])){var _142=_13f.getSelectorEntity(_141[e]);if((_141[e]=="System.owner")||(_141[e]=="System.changedBy")){continue;}if(_140.hasContext(_142)){_13f.addReference(_141[e],_140.getContext(_142));}var meta=window.mx.meta.getEntity(_142);if(meta){if(meta.hasSubEntities()){var _143=meta.getSubEntities();for(var i=0;i<_143.length;i++){if(_140.hasContext(_143[i])){_13f.addReference(_141[e],_140.getContext(_143[i]));}}}}}}}catch(err){}};this.sumOfXPathSet=function(_144){_144.type="sum";_76(_144);};this.countOfXPathSet=function(_145){_145.type="count";_76(_145);};this.sizeOfXPathSet=function(_146){_146.type="count";_76(_146);};this.avgOfXPathSet=function(_147){_147.type="avg";_76(_147);};this.maxOfXPathSet=function(_148){_148.type="max";_76(_148);};this.minOfXPathSet=function(_149){_149.type="min";_76(_149);};this.makeChange=function(_14a,attr,_14b){var guid=_14a.getGuid();_f[guid]=_14a;delete _10[guid];var _14c=_d,_14d=_14c[guid];if(_14d&&_14a!=_14d){_14d._makeChange(attr,_14b);}else{this.update({guid:guid,attr:attr,value:_14b});}};this.flush=function(_14e){if(_5.itemCount(_f)===0){_14e&&_14e();}else{this.save({mxobj:null,callback:_14e});}};};return _a;});