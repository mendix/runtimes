
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Server",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mendix.sys.Server");mendix.sys.Server=function(_4){_4=_4||{};var _5=this,_6="mendix.sys.Server",_7=false,_8=0,_9=[],_a=[],_b={},_c={},_d=[],_e={},_f={},_10="",_11=0,_12=_4.timeout||0,_13=true,_14=0;var _15=function(){return Number(+new Date()+""+(_8++%10));};var _16=function(_17){var _18=_17.asyncid;if(_e[_18]){logger.error(_6+".executeBackgroundJob: job "+_18+" already exists, aborting");_17.callback&&_17.callback();return;}if(!_17.callback){}var _19=500,_1a=500,_1b=8000,job=_e[_18]={callback:_17.callback,error:_17.error},_1c=function(){mx.server.request({request:{action:"poll_background_job",params:{asyncid:_18}},options:{store:_17.store,callback:function(_1d,_1e,_1f){if(_1e.response&&_1e.response.finished){delete _e[_18];job.callback&&job.callback(_1d,_1e,_1f);}else{setTimeout(_1c,(_19<_1b)?Math.min(_19+=_1a,_1b):_1b);}},error:function(e){logger.error(_6+".executeBackgroundJob: "+e.message);_20(job.error,e);delete _e[_18];}}});};job.timer=setTimeout(_1c,_19);};var _21=function(_22){if(!_22){_5.connectionDown(_13);_13=false;}else{if(_13===false){_13=true;_5.connectionUp();}}};var _23=function(req,_24,_25){var _26,err,_27,_28;try{_26=_25.xhr.status;if(_26==12029){_26=0;}}catch(e){_26=0;}_27=_25.xhr.responseText;switch(_26){case 401:case 500:case 550:case 551:case 560:try{if(_27!==""){_28=_1.fromJson(_27);}else{_28=null;}}catch(e){_20(req.error,new mendix.lib.ServerError(_6+".handleQueued: JSON is incorrect",e),req.failOk);}logger.error(_6+": loadHandler: server error: "+_1.toJson(_25.xhr.responseText));}switch(_26){case 0:case 502:_21(false);err=new mendix.lib.ConnectionError(_6+".handleQueued: "+(_27||"connection error"),_24);_20(req.error,err,req.failOk);return;default:_21(true);}switch(_26){case 200:if(mx.remote.hasInstructions(_24)){mx.remote.execute(_24,req.store);}req.callback&&req.callback("load",_24,_25);break;case 400:case 401:case 402:case 403:case 460:err=new mendix.lib.ServerError(_6+".handleQueued: "+_28.result,_24);_20(req.error,err);mx.logout({http_code:_26});break;case 500:case 550:err=new mendix.lib.ServerError(_6+".handleQueued: "+_28.description,_24);_20(req.error,err,req.failOk);break;case 504:err=new mendix.lib.ServerError(_6+".handleQueued: gateway timeout",_24);_20(req.error,err,req.failOk);break;case 551:mx.remote.execute(_28,req.store,true,function(){if(mx.remote.hasValidation(_28)){var _29=mx.remote.getValidations(_28);mx.data.sendValidationUpdates(_29);req.onValidation&&req.onValidation(_29);}});delete _28.instructions;if(mx.remote.hasValidation(_28)){err=new mendix.lib.ValidationError(_6+".handleQueued: validation error",_28);_20(req.error,err,true);}else{err=new mendix.lib.ServerError(_6+".handleQueued: "+_28.description,_24);_20(req.error,err,req.failOk);}break;case 560:if(mx.remote.hasInstructions(_28)){mx.remote.execute(_28,req.store);delete _28.instructions;}err=new mendix.lib.DescribedServerError(_28.description,_24);logger.error(_6+".handleQueued: "+err.message);_20(req.error,err,req.failOk);break;default:err=new mendix.lib.ServerError(_6+".handleQueued: "+_28.description,_24);_20(req.error,err,req.failOk);}};var _2a=function(){var ms=function(n){return "MSXML"+n+".DOMDocument";},res=["Microsoft.XMLDOM",ms(6),ms(4),ms(3),ms(2)],dom=null;_1.some(res,function(_2b){try{dom=new ActiveXObject(_2b);}catch(e){return false;}_2a=function(){return new ActiveXObject(_2b);};return true;});return dom;};var _2c=function(_2d){var _2e=+new Date();_2d.headers={"X-Mx-ReqToken":Number(_2e+""+~~(Math.random()*100000)).toString(16),"X-Csrf-Token":mx.session.getCSRFToken()};_2d.timeout=_12;_2d.start=_2e;var _2f=_1.rawXhrPost(_2d),xhr=_2f.ioArgs.xhr;if(!_1.isIE){var _30=xhr.onerror;xhr.onerror=function(e){_2f.cancel();_30&&_30();};}return _2f;};var _31=function(_32){var _33=_32.postData,_34=_1.toJson(_33),cbq;_32.seqno=_14++;if(_32.unique){cbq=[_32];}else{if(_b[_34]){cbq=_b[_34];cbq.push(_32);return;}else{_b[_34]=cbq=[_32];}}for(var _35 in _f){_33.releaseids=mendix.lang.objectToArray(_f);_f={};break;}if(!mendix.lang.objectIsEmpty(_c)){_33.profiledata=_5.flushLog();}_32.postData=_1.toJson(_32.postData);var _36={};for(var i in _32){if(i!="load"&&i!="error"){_36[i]=_32[i];}}_36.handle=function(_37,_38){_37=_37||{};if(_b[_34]){delete _b[_34];}if(this.start){var _39=this.headers["X-Mx-ReqToken"];_c[_39]=+new Date()-this.start;}while(cbq.length>0){_23(cbq.shift(),_37,_38);}};if(_11){setTimeout(function(){cbq.xhr=_2c(_36);},_11);}else{cbq.xhr=_2c(_36);}};var _3a=function(_3b){var _3c=[];for(var i=0,_3d;_3d=_9[i];i++){_3c.unshift(_3d);}mendix.lang.sequence(_3c,_3b);};var _3e=function(_3f){if(_3f.async){delete _3f.async;var _40=_1.getObject("postData.params",true,_3f),_41=_40.asyncid=_15(_40);_3f.callback=_1.hitch(this,_16,{asyncid:_41,callback:_3f.callback,error:_3f.error,store:_3f.store});}var _42=_3f.postData,_43=_42.context;if(_43){if(_43 instanceof mendix.lib.MxContext){_42.context=_43.getGuidS();}else{if(_1.isNumber(_43)){_42.context=[_43];}}}else{_42.context=[];}if(_3f.standalone){_31(_3f);}else{_3a(_1.hitch(null,_31,_3f));}};var _20=function(_44,e,_45){if(_44){_44(e);}else{if(!_45){mx.onError(e);}}};this.toString=function(){return _6;};this.startup=function(_46){_7=true;_46();};this.shutdown=function(){var err=new mendix.lib.ServerError(_6+".shutdown: client shutdown");_7=false;for(var i in _b){var cbq=_b[i];while(cbq.length){var qr=cbq.shift();try{qr.error&&qr.error(err);}catch(e){}}cbq.xhr&&cbq.xhr.cancel();}for(var job in _e){clearInterval(_e[job].timer);_e[job].error(err);delete _e[job];}_9=[];_a=[];_b={};};this.isLoaded=function(){return _7;};this.setDelay=function(ms){_11=ms;};this.getDelay=function(){return _11;};this.setCacheBust=function(_47){_10=_47;};this.getCacheBust=function(){return _10;};this.flushLog=function(){var log=_c;_c={};return log;};this.connectionUp=function(){};this.connectionDown=function(_48,_49){};this.isConnectionUp=function(){return _13;};this.registerCaller=function(_4a){if(_4a&&typeof _4a=="function"){_9.push(_4a);var id=mendix.lang.getUniqueId();_a.push([id,_4a]);return id;}return null;};this.unregisterCaller=function(id){for(var i=0,_4b;_4b=_a[i];i++){if(_4b[0]==id){var fnc=_4b[1];_a.splice(i,1);for(var j=0;j<_9.length;j++){if(_9[j]==fnc){_9.splice(j,1);return true;}}}}return false;};this.request=function(_4c){var _4d="",_4e=_4c.options;if(_4c.request&&_4c.request.action){_4d=_4c.request.action;}_3e({url:_1.isIE?mx.baseUrl:mx.baseUrl+"#"+_4d,mimetype:"application/json",contentType:"application/json",handleAs:"json",postData:_4c.request,unique:_4e.unique,useCache:_4e.useCache,preventCache:_4e.preventCache,store:_4e.store,handle:_4e.handle,error:_4e.error,callback:_4e.callback,sync:_4e.sync,async:_4e.async,onValidation:_4e.onValidation,standalone:_4e.standalone,failOk:_4e.failOk});};this.release=function(_4f){_f[_4f]=true;};this.xhr=function(_50,_51,_52){var url=mx.appUrl+_51.url,_53=_51.failOk,_54=_51.handleAs,_55=_51.load,_56=_51.error;_1.xhr(_50,_1.mixin(_51,{url:url,failOk:true,timeout:_12,headers:{"X-Csrf-Token":mx.session.getCSRFToken()},error:function(e){var _57;if(e.status===0){_57=new mendix.lib.ConnectionError(_6+".xhr: "+"connection error",e);}else{_57=new mendix.lib.ServerError(_6+".xhr: "+e.message,e);}_20(_56,_57,_53);},load:function(_58,_59){if(_54=="xml"&&_58==null){var _5a=_59.xhr.responseText;if(typeof DOMParser=="undefined"){_58=_2a();_58.async=false;_58.loadXML(_5a);}else{var _5b=new DOMParser();_58=_5b.parseFromString(_5a,"text/xml");}}_55&&_55(_58);}}),_52);};this.get=function(_5c){_5c.url+="?"+_10;this.xhr("GET",_5c);};this.post=function(_5d){this.xhr("POST",_5d,true);};};});