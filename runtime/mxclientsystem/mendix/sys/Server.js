/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Server",["mendix/lib/ServerError","mendix/lib/ConnectionError","mendix/lib/ValidationError","mendix/lib/DescribedServerError","mendix/lib/MxContext","mendix/lang","mendix/logger","dojo/sniff","dojo/_base/array","dojo/_base/json","dojo/_base/lang","dojo"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){function _d(_e){var _f=this,_10="mendix.sys.Server",_11=0,_12=[],_13=[],_14={},_15={},_16={},_17={},_18="",_19=0,_1a=_e&&_e.timeout||0,_1b=true,_1c=0;var _1d=function(){return Number(+new Date()+""+(_11++%10));};var _1e=function(_1f){var _20=_1f.asyncid;if(_16[_20]){_7.error(_10+".executeBackgroundJob: job "+_20+" already exists, aborting");_1f.callback&&_1f.callback();return;}if(!_1f.callback){}var _21=500,_22=500,_23=8000,job=_16[_20]={callback:_1f.callback,error:_1f.error},_24=function(){window.mx.server.request({request:{action:"poll_background_job",params:{asyncid:_20}},options:{store:_1f.store,callback:function(_25,_26,_27){if(_26.response&&_26.response.finished){delete _16[_20];job.callback&&job.callback(_25,_26,_27);}else{setTimeout(_24,(_21<_23)?Math.min(_21+=_22,_23):_23);}},error:function(e){_7.error(_10+".executeBackgroundJob: "+e.message);_28(job.error,e);delete _16[_20];}}});};job.timer=setTimeout(_24,_21);};var _29=function(_2a){if(!_2a){_f.connectionDown(_1b);_1b=false;}else{if(_1b===false){_1b=true;_f.connectionUp();}}};var _2b=function(req,_2c,_2d){var _2e,err,_2f,_30;try{_2e=_2d.xhr.status;if(_2e==12029){_2e=0;}}catch(e){_2e=0;}_2f=_2d.xhr.responseText;switch(_2e){case 401:case 500:case 550:case 551:case 560:try{if(_2f!==""){_30=_a.fromJson(_2f);}else{_30=null;}}catch(e){_28(req.error,new _1(_10+".handleQueued: JSON is incorrect",e),req.failOk);}_7.error(_10+": loadHandler: server error: "+_a.toJson(_2d.xhr.responseText));}switch(_2e){case 0:case 502:_29(false);err=new _2(_10+".handleQueued: "+(_2f||"connection error"),_2c);_28(req.error,err,req.failOk);return;default:_29(true);}switch(_2e){case 200:if(window.mx.remote.hasInstructions(_2c)){window.mx.remote.execute(_2c,req.store,null,function(){req.callback&&req.callback("load",_2c,_2d);});}else{req.callback&&req.callback("load",_2c,_2d);}break;case 400:case 401:case 402:case 403:case 460:_f.onUnauthorized(_2e);break;case 500:case 550:err=new _1(_10+".handleQueued: "+_30.description,_2c);_28(req.error,err,req.failOk);break;case 504:err=new _1(_10+".handleQueued: gateway timeout",_2c);_28(req.error,err,req.failOk);break;case 551:window.mx.remote.execute(_30,req.store,true,function(){if(window.mx.remote.hasValidation(_30)){var _31=window.mx.remote.getValidations(_30);window.mx.data.sendValidationUpdates(_31);req.onValidation&&req.onValidation(_31);}});delete _30.instructions;if(window.mx.remote.hasValidation(_30)){err=new _3(_10+".handleQueued: validation error",_30);_28(req.error,err,true);}else{err=new _1(_10+".handleQueued: "+_30.description,_2c);_28(req.error,err,req.failOk);}break;case 560:if(window.mx.remote.hasInstructions(_30)){window.mx.remote.execute(_30,req.store);delete _30.instructions;}err=new _4(_30.description,_2c);_7.error(_10+".handleQueued: "+err.message);_28(req.error,err,req.failOk);break;default:err=new _1(_10+".handleQueued: "+_30.description,_2c);_28(req.error,err,req.failOk);}};var _32=function(){var ms=function(n){return "MSXML"+n+".DOMDocument";},res=["Microsoft.XMLDOM",ms(6),ms(4),ms(3),ms(2)],dom=null;_9.some(res,function(_33){try{dom=new ActiveXObject(_33);}catch(e){return false;}_32=function(){return new ActiveXObject(_33);};return true;});return dom;};var _34=function(_35){var _36=+new Date();_35.headers={"X-Mx-ReqToken":Number(_36+""+~~(Math.random()*100000)).toString(16),"X-Csrf-Token":window.mx.session.getCSRFToken()};_35.timeout=_1a;_35.start=_36;var _37=_c.rawXhrPost(_35),xhr=_37.ioArgs.xhr;if(!_8("ie")){var _38=xhr.onerror;xhr.onerror=function(e){_37.cancel();_38&&_38();};}return _37;};var _39=function(_3a){var _3b=_3a.postData,_3c=_a.toJson(_3b),cbq;_3a.seqno=_1c++;if(_3a.unique){cbq=[_3a];}else{if(_14[_3c]){cbq=_14[_3c];cbq.push(_3a);return;}else{_14[_3c]=cbq=[_3a];}}for(var _3d in _17){_3b.releaseids=_6.objectToArray(_17);_17={};break;}if(!_6.objectIsEmpty(_15)){_3b.profiledata=_f.flushLog();}_3a.postData=_a.toJson(_3a.postData);var _3e={};for(var i in _3a){if(i!="load"&&i!="error"){_3e[i]=_3a[i];}}_3e.handle=function(_3f,_40){_3f=_3f||{};if(_14[_3c]){delete _14[_3c];}if(this.start){var _41=this.headers["X-Mx-ReqToken"];_15[_41]=+new Date()-this.start;}while(cbq.length>0){try{_2b(cbq.shift(),_3f,_40);}catch(e){_7.error("An error occurred while handling queued requests:",e.message);}}};if(_19){setTimeout(function(){cbq.xhr=_34(_3e);},_19);}else{cbq.xhr=_34(_3e);}};var _42=function(_43){var _44=[];for(var i=0,_45;_45=_12[i];i++){_44.unshift(_45);}_6.sequence(_44,_43);};var _46=function(_47){if(_47.async){delete _47.async;var _48=_b.getObject("postData.params",true,_47),_49=_48.asyncid=_1d(_48);_47.callback=_b.hitch(this,_1e,{asyncid:_49,callback:_47.callback,error:_47.error,store:_47.store});}var _4a=_47.postData,_4b=_4a.context;if(_4b){if(_4b instanceof _5){_4a.context=_4b.getGuidS();}else{if(!isNaN(parseFloat(_4b))){_4a.context=[parseFloat(_4b)];}}}else{_4a.context=[];}if(_47.standalone){_39(_47);}else{_42(_b.hitch(null,_39,_47));}};var _28=function(_4c,e,_4d){if(_4c){_4c(e);}else{if(!_4d){window.mx.onError(e);}}};this.toString=function(){return _10;};this.setDelay=function(ms){_19=ms;};this.getDelay=function(){return _19;};this.setCacheBust=function(_4e){_18=_4e;};this.getCacheBust=function(){return _18;};this.flushLog=function(){var log=_15;_15={};return log;};this.connectionUp=function(){};this.connectionDown=function(_4f,_50){};this.isConnectionUp=function(){return _1b;};this.onUnauthorized=function(_51){};this.registerCaller=function(_52){if(_52&&typeof _52=="function"){_12.push(_52);var id=_6.getUniqueId();_13.push([id,_52]);return id;}return null;};this.request=function(_53){var _54="",_55=_53.options;if(_53.request&&_53.request.action){_54=_53.request.action;}_46({url:_8("ie")?window.mx.baseUrl:window.mx.baseUrl+"#"+_54,mimetype:"application/json",contentType:"application/json",handleAs:"json",postData:_53.request,unique:_55.unique,useCache:_55.useCache,preventCache:_55.preventCache,store:_55.store,handle:_55.handle,error:_55.error,callback:_55.callback,sync:_55.sync,async:_55.async,onValidation:_55.onValidation,standalone:_55.standalone,failOk:_55.failOk});};this.release=function(_56){_17[_56]=true;};this.xhr=function(_57,_58,_59){var url=window.mx.appUrl+_58.url,_5a=_58.failOk,_5b=_58.handleAs,_5c=_58.load,_5d=_58.error;_c.xhr(_57,_b.mixin(_58,{url:url,failOk:true,timeout:_1a,headers:{"X-Csrf-Token":window.mx.session.getCSRFToken()},error:function(e){var _5e;if(e.status===0){_5e=new _2(_10+".xhr: "+"connection error",e);}else{_5e=new _1(_10+".xhr: "+e.message,e);}_28(_5d,_5e,_5a);},load:function(_5f,_60){if(_5b=="xml"&&_5f==null){var _61=_60.xhr.responseText;if(_8("dom-parser")){var _62=new DOMParser();_5f=_62.parseFromString(_61,"text/xml");if(!_5f.documentElement||_5f.querySelector("parsererror")){_28(_5d,new _1(_10+".xhr: invalid XML received"));return;}}else{_5f=_32();_5f.async=false;if(!_5f.loadXML(_61)){_28(_5d,new _1(_10+".xhr: invalid XML received"));return;}}}_5c&&_5c(_5f);}}),_59);};this.get=function(_63){_63.url+="?"+_18;this.xhr("GET",_63);};this.post=function(_64){this.xhr("POST",_64,true);};};return _d;});