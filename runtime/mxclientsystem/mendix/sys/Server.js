
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/sys/Server",["mendix/lib/ServerError","mendix/lib/ConnectionError","mendix/lib/ValidationError","mendix/lib/DescribedServerError","mendix/lib/MxContext","mendix/lang","mendix/logger","dojo/sniff","dojo/_base/array","dojo/_base/json","dojo/_base/lang","dojo"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){function _d(_e){_e=_e||{};var _f=this,_10="mendix.sys.Server",_11=false,_12=0,_13=[],_14=[],_15={},_16={},_17={},_18={},_19="",_1a=0,_1b=_e.timeout||0,_1c=true,_1d=0;var _1e=function(){return Number(+new Date()+""+(_12++%10));};var _1f=function(_20){var _21=_20.asyncid;if(_17[_21]){_7.error(_10+".executeBackgroundJob: job "+_21+" already exists, aborting");_20.callback&&_20.callback();return;}if(!_20.callback){}var _22=500,_23=500,_24=8000,job=_17[_21]={callback:_20.callback,error:_20.error},_25=function(){window.mx.server.request({request:{action:"poll_background_job",params:{asyncid:_21}},options:{store:_20.store,callback:function(_26,_27,_28){if(_27.response&&_27.response.finished){delete _17[_21];job.callback&&job.callback(_26,_27,_28);}else{setTimeout(_25,(_22<_24)?Math.min(_22+=_23,_24):_24);}},error:function(e){_7.error(_10+".executeBackgroundJob: "+e.message);_29(job.error,e);delete _17[_21];}}});};job.timer=setTimeout(_25,_22);};var _2a=function(_2b){if(!_2b){_f.connectionDown(_1c);_1c=false;}else{if(_1c===false){_1c=true;_f.connectionUp();}}};var _2c=function(req,_2d,_2e){var _2f,err,_30,_31;try{_2f=_2e.xhr.status;if(_2f==12029){_2f=0;}}catch(e){_2f=0;}_30=_2e.xhr.responseText;switch(_2f){case 401:case 500:case 550:case 551:case 560:try{if(_30!==""){_31=_a.fromJson(_30);}else{_31=null;}}catch(e){_29(req.error,new _1(_10+".handleQueued: JSON is incorrect",e),req.failOk);}_7.error(_10+": loadHandler: server error: "+_a.toJson(_2e.xhr.responseText));}switch(_2f){case 0:case 502:_2a(false);err=new _2(_10+".handleQueued: "+(_30||"connection error"),_2d);_29(req.error,err,req.failOk);return;default:_2a(true);}switch(_2f){case 200:if(window.mx.remote.hasInstructions(_2d)){window.mx.remote.execute(_2d,req.store);}req.callback&&req.callback("load",_2d,_2e);break;case 400:case 401:case 402:case 403:case 460:err=new _1(_10+".handleQueued: "+_31.result,_2d);_29(req.error,err);window.mx.logout({http_code:_2f});break;case 500:case 550:err=new _1(_10+".handleQueued: "+_31.description,_2d);_29(req.error,err,req.failOk);break;case 504:err=new _1(_10+".handleQueued: gateway timeout",_2d);_29(req.error,err,req.failOk);break;case 551:window.mx.remote.execute(_31,req.store,true,function(){if(window.mx.remote.hasValidation(_31)){var _32=window.mx.remote.getValidations(_31);window.mx.data.sendValidationUpdates(_32);req.onValidation&&req.onValidation(_32);}});delete _31.instructions;if(window.mx.remote.hasValidation(_31)){err=new _3(_10+".handleQueued: validation error",_31);_29(req.error,err,true);}else{err=new _1(_10+".handleQueued: "+_31.description,_2d);_29(req.error,err,req.failOk);}break;case 560:if(window.mx.remote.hasInstructions(_31)){window.mx.remote.execute(_31,req.store);delete _31.instructions;}err=new _4(_31.description,_2d);_7.error(_10+".handleQueued: "+err.message);_29(req.error,err,req.failOk);break;default:err=new _1(_10+".handleQueued: "+_31.description,_2d);_29(req.error,err,req.failOk);}};var _33=function(){var ms=function(n){return "MSXML"+n+".DOMDocument";},res=["Microsoft.XMLDOM",ms(6),ms(4),ms(3),ms(2)],dom=null;_9.some(res,function(_34){try{dom=new ActiveXObject(_34);}catch(e){return false;}_33=function(){return new ActiveXObject(_34);};return true;});return dom;};var _35=function(_36){var _37=+new Date();_36.headers={"X-Mx-ReqToken":Number(_37+""+~~(Math.random()*100000)).toString(16),"X-Csrf-Token":window.mx.session.getCSRFToken()};_36.timeout=_1b;_36.start=_37;var _38=_c.rawXhrPost(_36),xhr=_38.ioArgs.xhr;if(!_8("ie")){var _39=xhr.onerror;xhr.onerror=function(e){_38.cancel();_39&&_39();};}return _38;};var _3a=function(_3b){var _3c=_3b.postData,_3d=_a.toJson(_3c),cbq;_3b.seqno=_1d++;if(_3b.unique){cbq=[_3b];}else{if(_15[_3d]){cbq=_15[_3d];cbq.push(_3b);return;}else{_15[_3d]=cbq=[_3b];}}for(var _3e in _18){_3c.releaseids=_6.objectToArray(_18);_18={};break;}if(!_6.objectIsEmpty(_16)){_3c.profiledata=_f.flushLog();}_3b.postData=_a.toJson(_3b.postData);var _3f={};for(var i in _3b){if(i!="load"&&i!="error"){_3f[i]=_3b[i];}}_3f.handle=function(_40,_41){_40=_40||{};if(_15[_3d]){delete _15[_3d];}if(this.start){var _42=this.headers["X-Mx-ReqToken"];_16[_42]=+new Date()-this.start;}while(cbq.length>0){_2c(cbq.shift(),_40,_41);}};if(_1a){setTimeout(function(){cbq.xhr=_35(_3f);},_1a);}else{cbq.xhr=_35(_3f);}};var _43=function(_44){var _45=[];for(var i=0,_46;_46=_13[i];i++){_45.unshift(_46);}_6.sequence(_45,_44);};var _47=function(_48){if(_48.async){delete _48.async;var _49=_b.getObject("postData.params",true,_48),_4a=_49.asyncid=_1e(_49);_48.callback=_b.hitch(this,_1f,{asyncid:_4a,callback:_48.callback,error:_48.error,store:_48.store});}var _4b=_48.postData,_4c=_4b.context;if(_4c){if(_4c instanceof _5){_4b.context=_4c.getGuidS();}else{if(!isNaN(parseFloat(_4c))){_4b.context=[parseFloat(_4c)];}}}else{_4b.context=[];}if(_48.standalone){_3a(_48);}else{_43(_b.hitch(null,_3a,_48));}};var _29=function(_4d,e,_4e){if(_4d){_4d(e);}else{if(!_4e){window.mx.onError(e);}}};this.toString=function(){return _10;};this.startup=function(_4f){_11=true;_4f();};this.shutdown=function(){var err=new _1(_10+".shutdown: client shutdown");_11=false;for(var i in _15){var cbq=_15[i];while(cbq.length){var qr=cbq.shift();try{qr.error&&qr.error(err);}catch(e){}}cbq.xhr&&cbq.xhr.cancel();}for(var job in _17){clearInterval(_17[job].timer);_17[job].error(err);delete _17[job];}_13=[];_14=[];_15={};};this.isLoaded=function(){return _11;};this.setDelay=function(ms){_1a=ms;};this.getDelay=function(){return _1a;};this.setCacheBust=function(_50){_19=_50;};this.getCacheBust=function(){return _19;};this.flushLog=function(){var log=_16;_16={};return log;};this.connectionUp=function(){};this.connectionDown=function(_51,_52){};this.isConnectionUp=function(){return _1c;};this.registerCaller=function(_53){if(_53&&typeof _53=="function"){_13.push(_53);var id=_6.getUniqueId();_14.push([id,_53]);return id;}return null;};this.unregisterCaller=function(id){for(var i=0,_54;_54=_14[i];i++){if(_54[0]==id){var fnc=_54[1];_14.splice(i,1);for(var j=0;j<_13.length;j++){if(_13[j]==fnc){_13.splice(j,1);return true;}}}}return false;};this.request=function(_55){var _56="",_57=_55.options;if(_55.request&&_55.request.action){_56=_55.request.action;}_47({url:_8("ie")?window.mx.baseUrl:window.mx.baseUrl+"#"+_56,mimetype:"application/json",contentType:"application/json",handleAs:"json",postData:_55.request,unique:_57.unique,useCache:_57.useCache,preventCache:_57.preventCache,store:_57.store,handle:_57.handle,error:_57.error,callback:_57.callback,sync:_57.sync,async:_57.async,onValidation:_57.onValidation,standalone:_57.standalone,failOk:_57.failOk});};this.release=function(_58){_18[_58]=true;};this.xhr=function(_59,_5a,_5b){var url=window.mx.appUrl+_5a.url,_5c=_5a.failOk,_5d=_5a.handleAs,_5e=_5a.load,_5f=_5a.error;_c.xhr(_59,_b.mixin(_5a,{url:url,failOk:true,timeout:_1b,headers:{"X-Csrf-Token":window.mx.session.getCSRFToken()},error:function(e){var _60;if(e.status===0){_60=new _2(_10+".xhr: "+"connection error",e);}else{_60=new _1(_10+".xhr: "+e.message,e);}_29(_5f,_60,_5c);},load:function(_61,_62){if(_5d=="xml"&&_61==null){var _63=_62.xhr.responseText;if(typeof DOMParser=="undefined"){_61=_33();_61.async=false;_61.loadXML(_63);}else{var _64=new DOMParser();_61=_64.parseFromString(_63,"text/xml");}}_5e&&_5e(_61);}}),_5b);};this.get=function(_65){_65.url+="?"+_19;this.xhr("GET",_65);};this.post=function(_66){this.xhr("POST",_66,true);};};return _d;});