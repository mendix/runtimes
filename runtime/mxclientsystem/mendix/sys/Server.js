/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Server",["mendix/lib/ServerError","mendix/lib/ConnectionError","mendix/lib/ValidationError","mendix/lib/DescribedServerError","mendix/lib/MxContext","mendix/lang","mendix/logger","webcore/url-helpers","dojo/sniff","dojo/_base/array","dojo/_base/json","dojo/_base/lang","dojo"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){function _e(_f){var _10=this,_11="mendix.sys.Server",_12=0,_13=[],_14=[],_15={},_16={},_17={},_18={},_19="",_1a=_f&&_f.timeout||0,_1b=true,_1c=0;var _1d=function(){return Number(+new Date()+""+(_12++%10));};var _1e=function(_1f){var _20=_1f.asyncid;if(_17[_20]){_7.error(_11+".executeBackgroundJob: job "+_20+" already exists, aborting");_1f.callback&&_1f.callback();return;}if(!_1f.callback){}var _21=500,_22=500,_23=8000,job=_17[_20]={callback:_1f.callback,error:_1f.error},_24=function(){window.mx.server.request({request:{action:"poll_background_job",params:{asyncid:_20}},options:{store:_1f.store,callback:function(_25,_26,_27){if(_26.response&&_26.response.finished){delete _17[_20];job.callback&&job.callback(_25,_26,_27);}else{setTimeout(_24,(_21<_23)?Math.min(_21+=_22,_23):_23);}},error:function(e){_7.error(_11+".executeBackgroundJob: "+e.message);_28(job.error,e);delete _17[_20];}}});};job.timer=setTimeout(_24,_21);};var _29=function(_2a){if(!_2a){_10.connectionDown(_1b);_1b=false;}else{if(_1b===false){_1b=true;_10.connectionUp();}}};var _2b=function(req,_2c,_2d){var _2e,err,_2f,_30;try{_2e=_2d.xhr.status;if(_2e==12029){_2e=0;}}catch(e){_2e=0;}_2f=_2d.xhr.responseText;switch(_2e){case 401:case 500:case 550:case 551:case 560:try{if(_2f!==""){_30=_b.fromJson(_2f);}else{_30=null;}}catch(e){if(req.error){req.error(new _1(_11+".handleQueued: JSON is incorrect",e));}}_7.error(_11+": loadHandler: server error: "+_b.toJson(_2d.xhr.responseText));}switch(_2e){case 0:case 502:_29(false);if(req.error){req.error(new _2(_11+".handleQueued: "+(_2f||"connection error"),_2c));}return;default:_29(true);}switch(_2e){case 200:if(window.mx.remote.hasInstructions(_2c)){window.mx.remote.execute(_2c,req.store,null,function(){if(req.callback){req.callback(_2c,_2d);}});}else{if(req.callback){req.callback(_2c,_2d);}}break;case 400:case 401:case 402:case 403:case 460:_10.onUnauthorized(_2e);break;case 500:case 550:if(req.error){req.error(new _1(_11+".handleQueued: "+_30.description,_2c));}break;case 504:if(req.error){req.error(new _1(_11+".handleQueued: gateway timeout",_2c));}break;case 551:window.mx.remote.execute(_30,req.store,true,function(){if(window.mx.remote.hasValidation(_30)){var _31=window.mx.remote.getValidations(_30);window.mx.data.sendValidationUpdates(_31);req.onValidation&&req.onValidation(_31);}});delete _30.instructions;if(window.mx.remote.hasValidation(_30)){if(req.error){req.error(new _3(_11+".handleQueued: validation error",_30));}}else{if(req.error){req.error(new _1(_11+".handleQueued: "+_30.description,_2c));}}break;case 560:if(window.mx.remote.hasInstructions(_30)){window.mx.remote.execute(_30,req.store);delete _30.instructions;}if(req.error){req.error(new _4(_30.description,_2c));}break;default:if(req.error){req.error(new _1(_11+".handleQueued: "+_30.description,_2c));}}};var _32=function(){var ms=function(n){return "MSXML"+n+".DOMDocument";},res=["Microsoft.XMLDOM",ms(6),ms(4),ms(3),ms(2)],dom=null;_a.some(res,function(_33){try{dom=new ActiveXObject(_33);}catch(e){return false;}_32=function(){return new ActiveXObject(_33);};return true;});return dom;};function _34(_35,_36){var _37=_35.retryOnDisconnect?2:1;function _38(){var _39=_d.xhr("POST",_c.mixin({},_35.options,{postData:JSON.stringify(_35.data),timeout:_1a,handle:function(_3a,_3b){var _3c=_3b.xhr.status===0||_3b.xhr.status===12029;if(_3c&&--_37>0){_38();return;}if(_36){_36(_3a,_3b);}}}),true);var xhr=_39.ioArgs.xhr;if(!_9("ie")){var _3d=xhr.onerror;xhr.onerror=function(e){_39.cancel();_3d&&_3d();};}};_38();};var _3e=function(_3f){var _40=_3f.data,_41=_b.toJson(_40),cbq;_3f.seqno=_1c++;if(_3f.unique){cbq=[_3f];}else{if(_15[_41]){cbq=_15[_41];cbq.push(_3f);return;}else{_15[_41]=cbq=[_3f];}}for(var _42 in _18){_40.releaseids=_6.objectToArray(_18);_18={};break;}_34(_3f,function(_43,_44){_43=_43||{};if(_15[_41]){delete _15[_41];}while(cbq.length>0){try{_2b(cbq.shift(),_43,_44);}catch(e){_7.error("An error occurred while handling queued requests:",e.message);}}});};var _45=function(_46){var _47=[];for(var i=0,_48;_48=_13[i];i++){_47.unshift(_48);}_6.sequence(_47,_46);};var _49=function(_4a){if(_4a.async){delete _4a.async;var _4b=_c.getObject("data.params",true,_4a),_4c=_4b.asyncid=_1d();_4a.callback=_c.hitch(this,_1e,{asyncid:_4c,callback:_4a.callback,error:_4a.error,store:_4a.store});}var _4d=_4a.data,_4e=_4d.context;if(_4e){if(_4e instanceof _5){_4d.context=_4e.getGuidS();}else{if(!isNaN(parseFloat(_4e))){_4d.context=[parseFloat(_4e)];}}}else{_4d.context=[];}if(_4a.standalone){_3e(_4a);}else{_45(_c.hitch(null,_3e,_4a));}};var _28=function(_4f,e,_50){if(_4f){_4f(e);}else{if(!_50){window.mx.onError(e);}}};this.toString=function(){return _11;};this.setCacheBust=function(_51){_19=_51;};this.getCacheBust=function(){return _19;};this.flushLog=function(){var log=_16;_16={};return log;};this.connectionUp=function(){};this.connectionDown=function(_52,_53){};this.isConnectionUp=function(){return _1b;};this.onUnauthorized=function(_54){};this.registerCaller=function(_55){if(_55&&typeof _55=="function"){_13.push(_55);var id=_6.getUniqueId();_14.push([id,_55]);return id;}return null;};this.request=function(_56){var _57="",_58=_56.options;if(_56.request&&_56.request.action){_57=_56.request.action;}var _59=_5a();var _5b=+new Date();var log=_10.flushLog();_49({options:{url:_9("ie")?window.mx.baseUrl:window.mx.baseUrl+"#"+_57,headers:{"Content-Type":"application/json","X-Mx-ReqToken":_59,"X-Csrf-Token":window.mx.session.getCSRFToken()},handleAs:"json",sync:_58.sync,failOk:_58.failOk},data:_c.mixin({},_56.request,Object.keys(log).length>0?{profiledata:log}:{}),unique:_58.unique,store:_58.store,async:_58.async,standalone:_58.standalone,retryOnDisconnect:!!_9("trident"),onValidation:_58.onValidation,callback:function(_5c,_5d){_16[_59]=+new Date()-_5b;if(_58.callback){_58.callback("load",_5c,_5d);}},error:function(e){_16[_59]=+new Date()-_5b;_28(_58.error,e,_58.failOk||e instanceof _3);}});function _5a(){return Number((+new Date())+""+~~(Math.random()*100000)).toString(16);};};this.release=function(_5e){_18[_5e]=true;};this.xhr=function(_5f,_60,_61){var url=_8.getAbsoluteUrl(_60.url),_62=_60.failOk,_63=_60.handleAs,_64=_60.load,_65=_60.error;_d.xhr(_5f,_c.mixin(_60,{url:url,failOk:true,timeout:_1a,headers:{"X-Csrf-Token":window.mx.session.getCSRFToken()},error:function(e){var _66;if(e.status===0){_66=new _2(_11+".xhr: "+"connection error",e);}else{_66=new _1(_11+".xhr: "+e.message,e);}_28(_65,_66,_62);},load:function(_67,_68){if(_63=="xml"&&_67==null){var _69=_68.xhr.responseText;if(_9("dom-parser")){var _6a=new DOMParser();_67=_6a.parseFromString(_69,"text/xml");if(!_67.documentElement||_67.querySelector("parsererror")){_28(_65,new _1(_11+".xhr: invalid XML received"));return;}}else{_67=_32();_67.async=false;if(!_67.loadXML(_69)){_28(_65,new _1(_11+".xhr: invalid XML received"));return;}}}_64&&_64(_67);}}),_61);};this.get=function(_6b){_6b.url+="?"+_19;this.xhr("GET",_6b);};this.post=function(_6c){this.xhr("POST",_6c,true);};};return _e;});