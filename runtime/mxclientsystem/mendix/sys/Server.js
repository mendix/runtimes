/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/sys/Server",["mendix/lib/ServerError","mendix/lib/ConnectionError","mendix/lib/ValidationError","mendix/lib/DescribedServerError","mendix/lib/MxContext","mendix/lang","mendix/logger","webcore/url-helpers","dojo/sniff","dojo/_base/array","dojo/_base/json","dojo/_base/lang","dojo"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){function _e(_f){var _10=this,_11="mendix.sys.Server",_12=0,_13={},_14={},_15={},_16={},_17="",_18=_f&&_f.timeout||0,_19=true,_1a=0;var _1b=function(){return Number(+new Date()+""+(_12++%10));};var _1c=function(_1d){var _1e=_1d.asyncid;if(_15[_1e]){_7.error(_11+".executeBackgroundJob: job "+_1e+" already exists, aborting");_1d.callback&&_1d.callback();return;}if(!_1d.callback){}var _1f=500,_20=500,_21=8000,job=_15[_1e]={callback:_1d.callback,error:_1d.error},_22=function(){window.mx.server.request({request:{action:"poll_background_job",params:{asyncid:_1e}},options:{store:_1d.store,callback:function(_23,_24,_25){if(_24.response&&_24.response.finished){delete _15[_1e];job.callback&&job.callback(_23,_24,_25);}else{setTimeout(_22,(_1f<_21)?Math.min(_1f+=_20,_21):_21);}},error:function(e){_7.error(_11+".executeBackgroundJob: "+e.message);_26(job.error,e);delete _15[_1e];}}});};job.timer=setTimeout(_22,_1f);};var _27=function(_28){if(!_28){_10.connectionDown(_19);_19=false;}else{if(_19===false){_19=true;_10.connectionUp();}}};var _29=function(req,_2a,_2b){var _2c,err,_2d,_2e;try{_2c=_2b.xhr.status;if(_2c==12029){_2c=0;}}catch(e){_2c=0;}_2d=_2b.xhr.responseText;switch(_2c){case 401:case 500:case 550:case 551:case 560:try{if(_2d!==""){_2e=_b.fromJson(_2d);}else{_2e=null;}}catch(e){if(req.error){req.error(new _1(_11+".handleQueued: JSON is incorrect",e));}}_7.error(_11+": loadHandler: server error: "+_b.toJson(_2b.xhr.responseText));}switch(_2c){case 0:case 502:_27(false);if(req.error){req.error(new _2(_11+".handleQueued: "+(_2d||"connection error"),_2a));}return;default:_27(true);}switch(_2c){case 200:window.mx.remote.execute(_2a,req.store,null,function(){if(window.mx.remote.hasValidation(_2a)){var _2f=window.mx.remote.getValidations(_2a);window.mx.data.sendValidationUpdates(_2f);if(req.onValidation){req.onValidation(_2f);}}if(req.callback){req.callback(_2a,_2b);}});break;case 400:case 401:case 402:case 403:case 460:_10.onUnauthorized(_2c);break;case 500:case 550:if(req.error){req.error(new _1(_11+".handleQueued: "+_2e.description,_2a));}break;case 504:if(req.error){req.error(new _1(_11+".handleQueued: gateway timeout",_2a));}break;case 551:window.mx.remote.execute(_2e,req.store,true,function(){if(window.mx.remote.hasValidation(_2e)){var _30=window.mx.remote.getValidations(_2e);window.mx.data.sendValidationUpdates(_30);if(req.onValidation){req.onValidation(_30);}}delete _2e.instructions;if(window.mx.remote.hasValidation(_2e)){if(req.error){req.error(new _3(_11+".handleQueued: validation error",_2e));}}else{if(req.error){req.error(new _1(_11+".handleQueued: "+_2e.description,_2a));}}});break;case 560:window.mx.remote.execute(_2e,req.store,false,function(){delete _2e.instructions;if(req.error){req.error(new _4(_2e.description,_2a));}});break;default:if(req.error){req.error(new _1(_11+".handleQueued: "+_2e.description,_2a));}}};var _31=function(){var ms=function(n){return "MSXML"+n+".DOMDocument";},res=["Microsoft.XMLDOM",ms(6),ms(4),ms(3),ms(2)],dom=null;_a.some(res,function(_32){try{dom=new ActiveXObject(_32);}catch(e){return false;}_31=function(){return new ActiveXObject(_32);};return true;});return dom;};function _33(_34,_35){var _36=_34.retryOnDisconnect?2:1;function _37(){var _38=_d.xhr("POST",_c.mixin({},_34.options,{postData:_34.data,timeout:_18,handle:function(_39,_3a){var _3b=_3a.xhr.status===0||_3a.xhr.status===12029;if(_3b&&--_36>0){_37();return;}if(_35){_35(_39,_3a);}}}),true);var xhr=_38.ioArgs.xhr;if(!_9("ie")){var _3c=xhr.onerror;xhr.onerror=function(e){_38.cancel();_3c&&_3c();};}};_37();};var _3d=function(_3e,_3f){var cbq;_3e.seqno=_1a++;if(_3f){if(_13[_3f]){cbq=_13[_3f];cbq.push(_3e);return;}else{_13[_3f]=cbq=[_3e];}}else{cbq=[_3e];}_33(_3e,function(_40,_41){_40=_40||{};if(_13[_3f]){delete _13[_3f];}while(cbq.length>0){try{_29(cbq.shift(),_40,_41);}catch(e){_7.error("An error occurred while handling queued requests:",e.message);}}});};var _26=function(_42,e,_43){if(_42){_42(e);}else{if(!_43){window.mx.onError(e);}}};this.toString=function(){return _11;};this.setCacheBust=function(_44){_17=_44;};this.getCacheBust=function(){return _17;};this.flushLog=function(){var log=_14;_14={};return log;};this.connectionUp=function(){};this.connectionDown=function(_45,_46){};this.isConnectionUp=function(){return _19;};this.onUnauthorized=function(_47){};this.request=function(_48){var _49="",_4a=_48.options;if(_48.request&&_48.request.action){_49=_48.request.action;}var _4b=_4c();var _4d=+new Date();var log=_10.flushLog();var _4e=_4f();var _50=_51(_48.request.context);var _52=_48.request;var _53;if(_4a.async){var _54=_1b();_52=_6.clone(_52);_52.params=_52.params||{};_52.params.asyncid=_54;_53=_c.hitch(this,_1c,{asyncid:_54,callback:_4a.callback,error:_4a.error,store:_4a.store});}else{_53=_4a.callback;}var _55=JSON.stringify(Object.assign({},_52,_4e.length>0?{releaseids:_4e}:null,{context:_50},Object.keys(log).length>0?{profiledata:log}:null));var _56=null;if(!_4a.unique){_56=_55;}_3d({options:{url:_9("ie")?window.mx.baseUrl:window.mx.baseUrl+"#"+_49,headers:{"Content-Type":"application/json","X-Mx-ReqToken":_4b,"X-Csrf-Token":window.mx.session.getCSRFToken()},handleAs:"json",sync:_4a.sync,failOk:_4a.failOk},data:_55,store:_4a.store,retryOnDisconnect:!!_9("trident"),onValidation:_4a.onValidation,callback:function(_57,_58){_14[_4b]=+new Date()-_4d;if(_53){_53("load",_57,_58);}},error:function(e){_14[_4b]=+new Date()-_4d;_26(_4a.error,e,_4a.failOk||e instanceof _3);}},_56);function _4f(){var _59=Object.keys(_16);if(_59.length>0){_16={};}return _59;};function _51(_5a){if(_5a){if(_5a instanceof _5){return _5a.getGuidS();}else{if(!isNaN(parseFloat(_5a))){return [parseFloat(_5a)];}}}else{return [];}};};function _4c(){return Number((+new Date())+""+~~(Math.random()*100000)).toString(16);};this.release=function(_5b){_16[_5b]=true;};this.xhr=function(_5c,_5d,_5e){var url=_8.getAbsoluteUrl(_5d.url),_5f=_5d.failOk,_60=_5d.handleAs,_61=_5d.load,_62=_5d.error;_d.xhr(_5c,_c.mixin(_5d,{url:url,failOk:true,timeout:_18,headers:{"X-Csrf-Token":window.mx.session.getCSRFToken()},error:function(e){var _63;if(e.status===0){_63=new _2(_11+".xhr: "+"connection error",e);}else{_63=new _1(_11+".xhr: "+e.message,e);}_26(_62,_63,_5f);},load:function(_64,_65){if(_60=="xml"&&_64==null){var _66=_65.xhr.responseText;if(_9("dom-parser")){var _67=new DOMParser();_64=_67.parseFromString(_66,"text/xml");if(!_64.documentElement||_64.querySelector("parsererror")){_26(_62,new _1(_11+".xhr: invalid XML received"));return;}}else{_64=_31();_64.async=false;if(!_64.loadXML(_66)){_26(_62,new _1(_11+".xhr: invalid XML received"));return;}}}_61&&_61(_64);}}),_5e);};this.get=function(_68){_68.url+="?"+_17;this.xhr("GET",_68);};this.post=function(_69){this.xhr("POST",_69,true);};this.upload=function(_6a){var _6b=_6a.options,_6c=_6a.request;var _6d=_4c();var _6e=+new Date();var log=_10.flushLog();_3d({options:{url:_6f(),headers:{"Accept":"application/json","X-Mx-ReqToken":_6d,"X-Csrf-Token":window.mx.session.getCSRFToken()},handleAs:"json"},data:_70(),retryOnDisconnect:!!_9("trident"),callback:function(_71,_72){_14[_6d]=+new Date()-_6e;if(_6b.callback){_6b.callback("load",_71,_72);}},error:function(e){_14[_6d]=+new Date()-_6e;_26(_6b.error,e,e instanceof _3);}});function _6f(){var _73=_c.mixin({},_6c.params.params,{guid:_6c.params.guid});return window.mx.remoteUrl+"file?"+Object.keys(_73).map(function(_74){return _74+"="+_73[_74];}).join("&");};function _70(){var _75=new FormData();_75.append("changes",_b.toJson(_6c.changes));if(_6c.params.name!=null){_75.append("mxdocument",_6c.params.mxdocument,_6c.params.name);}else{_75.append("mxdocument",_6c.params.mxdocument);}return _75;};};};return _e;});