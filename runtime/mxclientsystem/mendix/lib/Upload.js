
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/lib/Upload",["mxui/io/iframe","mendix/lib/Error","mendix/lang","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5){var _6=_5(null,{constructor:function(_7){_4.mixin(this,_7);},upload:function(){if(window.FormData&&window.XMLHttpRequestUpload&&window.FileReader){this._uploadViaFormData();}else{this._uploadViaIFrame();}},_uploadViaFormData:function(){var _8=this._determineUrl(),_9=new FormData(),_a=this.form.mxdocument.files[0],_b=this;_9.append("mxdocument",_a);var _c=new XMLHttpRequest(),_d=function(e){var _e=e.loaded*100/e.total;if(_e===_e){_b.showProgress(_e);}};_c.upload.addEventListener("load",_d,false);_c.upload.addEventListener("progress",_d,false);_c.onreadystatechange=function(){if(_c.readyState==4){_b.finishUpload(true);if(_c.status==200){_b.callback&&_b.callback();return;}var _f=_b._getError(_c.responseText);_b.error&&_b.error(_f||undefined);}};this.startUpload(true);_c.open("post",_8,true);_c.send(_9);},_getError:function(_10){var _11=new DOMParser(),doc,err;if(_10){doc=_11.parseFromString(_10,"text/html");err=_3.getFileError(doc,"mendix.lib.Upload._getError");}else{err=_2("mendix.lib.Upload._getError: connection error");}return err;},_determineUrl:function(){var _12=[window.mx.appUrl+"file?"];_12.push("guid="+this.objectGuid);if(this.maxFileSize){_12.push("maxFileSize="+this.maxFileSize);}_12.push("csrfToken="+window.mx.session.getCSRFToken());if(typeof this.width!=="undefined"&&typeof this.height!=="undefined"){_12.push("width="+this.width);_12.push("height="+this.height);}return _12.join("&");},_uploadViaIFrame:function(){var _13=this.form,_14=this;_13.action=this._determineUrl();this.startUpload(false);_1.send({form:_13,handleAs:"json",handle:function(_15){try{if(_15 instanceof _2){_14.error&&_14.error(_15);}else{_14.callback&&_14.callback();}}finally{_14.finishUpload(false);}}});}});return _6;});