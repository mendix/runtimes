/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mendix/lib/Upload",["mxui/io/iframe","mendix/lib/Error","mendix/lang","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5){var _6=_5(null,{constructor:function(_7){_4.mixin(this,_7);},upload:function(){if(window.FormData){this._uploadViaFormData();}else{this._uploadViaIFrame();}},_uploadViaFormData:function(){var _8=this._determineUrl(),_9=new FormData(),_a=this.form.mxdocument.files[0],_b=this;_9.append("mxdocument",_a);var _c=new XMLHttpRequest();_c.onreadystatechange=function(){if(_c.readyState==4){_b.finishUpload(true);if(_c.status==200){_b.callback&&_b.callback();return;}var _d=_b._getError(_c.responseText);_b.error&&_b.error(_d||undefined);}};this.startUpload(true);_c.open("post",_8,true);_c.send(_9);},_getError:function(_e){var _f=new DOMParser(),doc,err;if(_e){doc=_f.parseFromString(_e,"text/html");err=_3.getFileError(doc,"mendix/lib/Upload._getError");}else{err=_2("mendix/lib/Upload._getError: connection error");}return err;},_determineUrl:function(){var _10=[window.mx.appUrl+"file?"];_10.push("guid="+this.objectGuid);if(this.maxFileSize){_10.push("maxFileSize="+this.maxFileSize);}_10.push("csrfToken="+window.mx.session.getCSRFToken());if(typeof this.width!=="undefined"&&typeof this.height!=="undefined"){_10.push("width="+this.width);_10.push("height="+this.height);}return _10.join("&");},_uploadViaIFrame:function(){var _11=this.form,_12=this;_11.action=this._determineUrl();this.startUpload(false);_1.send({form:_11,handleAs:"json",handle:function(_13){try{if(_13 instanceof _2){_12.error&&_12.error(_13);}else{_12.callback&&_12.callback();}}finally{_12.finishUpload(false);}}});}});return _6;});