
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/lib/Upload",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mendix.lib.Upload");_1.declare("mendix.lib.Upload",null,{constructor:function(_4){_1.mixin(this,_4);},upload:function(){if(window.FormData&&window.XMLHttpRequestUpload&&window.FileReader){this._uploadViaFormData();}else{this._uploadViaIFrame();}},_uploadViaFormData:function(){var _5=this._determineUrl(),_6=new FormData(),_7=this.form.mxdocument.files[0],_8=this;_6.append("mxdocument",_7);var _9=new XMLHttpRequest(),_a=function(e){var _b=e.loaded*100/e.total;if(_b===_b){_8.showProgress(_b);}};_9.upload.addEventListener("load",_a,false);_9.upload.addEventListener("progress",_a,false);_9.onreadystatechange=function(){if(_9.readyState==4){_8.finishUpload(true);if(_9.status==200){_8.callback&&_8.callback();return;}var _c=_8._getError(_9.responseText);_8.error&&_8.error(_c||undefined);}};this.startUpload(true);_9.open("post",_5,true);_9.send(_6);},_getError:function(_d){var _e=new DOMParser(),_f,err;if(_d){_f=_e.parseFromString(_d,"text/html");err=mendix.lang.getFileError(_f,this.declaredClass+"._getError");}else{err=mendix.lib.Error(this.declaredClass+"._getError: connection error");}return err;},_determineUrl:function(){var _10=window.location.href.match("[^#]*/"),_11=[_10+"file?"];_11.push("guid="+this.objectGuid);if(this.maxFileSize){_11.push("maxFileSize="+this.maxFileSize);}_11.push("csrfToken="+mx.session.getCSRFToken());if(typeof this.width!=="undefined"&&typeof this.height!=="undefined"){_11.push("width="+this.width);_11.push("height="+this.height);}return _11.join("&");},_uploadViaIFrame:function(){var _12=this.form,_13=this;_12.action=this._determineUrl();this.startUpload(false);mxui.io.iframe.send({form:_12,handleAs:"json",handle:function(_14){try{if(_14 instanceof Error){_13.error&&_13.error(_14);}else{_13.callback&&_13.callback();}}finally{_13.finishUpload(false);}}});}});});