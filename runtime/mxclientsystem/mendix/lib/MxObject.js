
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/lib/MxObject",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mendix.lib.MxObject");_1.declare("mendix.lib.MxObject",null,{constructor:function(_4){this.id=this.declaredClass;this.jsonData=_4?_4.json:false;this.metaData=_4?_4.meta:false;this._changeData={};this._backup=null;this._references=null;if(this.jsonData&&this.metaData){this._guid=this.jsonData.guid;this._classname=this.jsonData.objectType;this.id+="("+this._classname+":"+this._guid+")";}if(!this._classname){var _5=this.jsonData&&this.jsonData.objectType;logger.error(this.id+".create: Invalid Mendix object. Check entity access"+(_5?" for entity "+_5:"")+".");this._guid=0;this._classname="";this.jsonData=null;}if(!this._guid){this._guid="0";this.save=this.commit=this.rollback=function(){};}},attachReferences:function(_6){if(_6&&_6.length>0){this._references={};_1.forEach(_6,function(_7){this._references[_7.getGuid()]=_7;},this);}},resetFromJSON:function(_8){this.jsonData=_8;this._changeData={};this._guid=this.jsonData?this.jsonData["guid"]:0;this._backup=null;},getGuid:function(){return (this._guid);},hasChanges:function(){return !mendix.lang.objectIsEmpty(this._changeData);},_collectChanges:function(){return _1.mixin({},this._changeData);},set:function(_9,_a){return this._setContent(_9,_a);},_setContent:function(_b,_c){if(!(typeof (_b)=="string")){var _d=this.id+"._setContent : parameter attr ("+_b+") is not of type String.";logger.error(_d);throw new Error(_d);}try{if(this.metaData.has(_b)){var _e=this.get(_b);if(_e==null&&_c==""){return false;}if(this.isNumber(_b)||this.isCurrency(_b)){if(mendix.lang.numberTooBig(_c)){var _f;if(mx.ui&&mx.ui.translate){_f=mx.ui.translate("mendix.lib.Validations","number_too_big");}else{_f="Invalid number: number too big";}mx.data.addValidation(this._guid,_b,_f);return;}}else{if(this.isEnum(_b)){}else{if(this.isDate(_b)){var _10=this.isLocalizedDate(_b);if(_c!==""){if(_10){_c=Number(_c);}else{_c=mx.parser.delocalizeEpoch(_c);}}}else{if(this.isPassword(_b)){_c=_c.replace(/[\s\t]+$/,"").replace(/^[\s\t]+/,"");}else{if(this.isBoolean(_b)){_c=!!_c;}else{if(_1.isArray(_c)&&this.isObjectReference(_b)){throw new Error("mendix.lib.MxObject._setContent : trying to set single object reference to multiple values");}else{if(!_1.isArray(_c)&&this.isObjectReferenceSet(_b)){throw new Error("mendix.lib.MxObject._setContent : trying to set object reference set to single value");}}}}}}}if(_c!==_e){return (this._makeChange(_b,_c));}}else{return (false);}}catch(e){throw new Error("mendix.lib.MxObject._setContent caught : "+e);}},isReadonlyAttr:function(_11){if(this.has(_11)){var _12=this._getAttributeNode(_11);return !!_12.readonly;}else{if(this.metaData.has(_11)){return false;}else{return true;}}},fetch:function(_13,_14){var _15=this,obj=this,_16=null,_17;if(!_13){_17=[];}else{if(_13 instanceof Array){_17=_13.slice();}else{_17=_13.split("/");}}if(this.isA(_17[0])){_17.shift();}if(typeof _14!="function"){throw new Error(_15.id+".fetch : callback is not a function");}var _18=function(){if(_17.length===0){_14(obj);}else{if(_17.length==1){if(_16){mx.data.release(_16);}_14(obj.get(_17[0]));}else{if(_16){mx.data.release(_16);}var ref=_17.shift(),_19=false,_1a,_1b;if(obj.isObjectReference(ref)){var _1c=obj.get(ref);if(_1c===""){_14(null);return;}if(typeof _1c=="object"){_1a=[_1c.guid];}else{_1a=[_1c];}}else{if(obj.isObjectReferenceSet(ref)){if(_17.length==1){_19=true;var _1d=obj.get(ref);if(_1d.length===0){_14(null);return;}if(typeof _1a[0]=="object"){_1a=[];while(_1d.length>0){_1a.push(_1d.shift().guid);}}else{_1a=_1d;}}else{throw new Error(_15.id+".fetch : "+obj+" reference set should be last reference in path");}}else{return _14(null);}}_1b=_17.shift();if(!_1b){throw new Error(_15.id+".fetch : no type specified");}if(_1a){mx.data.get({guids:_1a,callback:function(_1e){if(_19){if(_1e.length===0||_1e[0].isA(_1b)){_14(_1e);}else{_14(null);}}else{_16=obj=_1e[0];if(_1e.length>1){mx.data.release(_1e.slice(1));}if(obj){if(obj.isA(_1b)){_18();}else{_14(null);}}else{_14(null);}}},error:function(e){throw new Error(_15.id+".fetch : could not get objects with GUIDs "+_1a);}});}else{throw new Error(_15.id+".fetch : "+obj+"'s '"+ref+"' attribute is empty");}}}};_18();},get:function(_1f){if(!(typeof (_1f)=="string")){var e=this.id+".get : parameter attr "+_1f+" is not of type String";logger.error(e);throw new Error(e);}if(this.has(_1f)||this.metaData.has(_1f)){var _20=(this._changeData[_1f]!=null)?this._changeData[_1f]:this._getAttributeValue(_1f);if(this.isDate(_1f)){var _21=this.isLocalizedDate(_1f);if(_20===""||_20==null){_20="";}else{_20=_21?Number(_20):mx.parser.localizeEpoch(_20);}}else{if(this.isBoolean(_1f)){if(typeof _20=="string"&&_20!=""){_20=_20.match(/true/)!=null;}}}return (typeof _20=="object")?_1.clone(_20):_20;}else{return null;}},has:function(_22){if(!(typeof (_22)=="string")){var e=this.id+".has : parameter attr "+_22+" is not of type String.";logger.error(e);throw new Error(e);}return (this.jsonData!=null&&(_22 in this.jsonData.attributes));},getReferences:function(_23){if(!(typeof (_23)=="string")){var e=this.id+".getReferences : parameter attr "+_23+" is not of type String.";logger.error(e);throw new Error(e);}var _24=[];if(this.has(_23)){if(this.isReference(_23)){if(this._hasChildren(_23)&&this._changeData[_23]==null){var _25=this.getChildren(_23);var _26=[];for(var i=0;i<_25.length;i++){_26.push(_25[i].getGuid());}_24=_26;}else{_24=this.get(_23);}if(_24==""){_24=[];}else{if(typeof (_24)=="string"||typeof (_24)=="number"){_24=[_24];}else{if((typeof (_24)=="object")&&(_24.length==null)){_24=mendix.lang.objectToArray(_24);}}}}else{var e=this.id+".getReferences: attribute "+_23+" is not an ObjectReference(Set).";logger.error(e);throw new Error(e);}}else{}return _24;},getReference:function(_27){if(!(typeof (_27)=="string")){var e=this.id+".getReference : parameter attr is not of type String.";logger.error(e);throw new Error(e);}if(this.has(_27)){if(!this.metaData.isObjectReference(_27)){var e=this.id+".getReference: attribute "+_27+" is not an ObjectReference.";logger.exception(e);throw new Error(e);}}else{return null;}if(this._hasChildren(_27)){return (this.getChild(_27)).getGuid();}else{return (this.get(_27));}},isEnum:function(_28){return this.metaData.isEnum(_28);},isNumber:function(_29){return this.metaData.isNumber(_29);},isCurrency:function(_2a){return this.metaData.isCurrency(_2a);},isPassword:function(_2b){return this.metaData.isPassword(_2b);},isDate:function(_2c){return this.metaData.isDate(_2c);},isLocalizedDate:function(_2d){return this.metaData.isLocalizedDate(_2d);},isBoolean:function(_2e){return this.metaData.isBoolean(_2e);},isReference:function(_2f){return this.metaData.isReference(_2f);},isObjectReference:function(_30){return this.metaData.isObjectReference(_30);},isObjectReferenceSet:function(_31){return this.metaData.isObjectReferenceSet(_31);},getOptions:function(_32){return this.metaData.getOptions(_32);},getEnumKeys:function(_33,_34){return this.metaData.getEnumKeys(_33,_34);},getEnumMap:function(_35){return this.metaData.getEnumMap(_35);},getEnumKVPairs:function(_36){return this.metaData.getEnumKVPairs(_36);},getEnumValue:function(_37){return this.metaData.getEnumValue(_37,this._getAttributeValue(_37));},getEnumCaption:function(_38){return this.metaData.getEnumCaption(_38,this._getAttributeValue(_38));},hasChildren:function(_39){if(!(typeof (_39)=="string")){var _3a=this.id+".hasChildren : parameter attr ("+_39+") is not of type String.";logger.error(_3a);throw new Error(_3a);}return (this.isReference(_39)&&this._hasChildren(_39));},getChildren:function(_3b){if(!(typeof (_3b)=="string")){var _3c=this.id+".getChildren : parameter attr ("+_3b+") is not of type String.";logger.error(_3c);throw new Error(_3c);}var _3d=[];var _3e=null;if(this.has(_3b)){if(this.isReference(_3b)){if(this._hasChildren(_3b)){_3e=this.get(_3b);if(this.isObjectReference(_3b)){if(this._references&&this._references[_3e]){var _3f=this._references[_3e];_3f._references=this._references;_3d.push(_3f);}else{_3d.push(mx.data.jsonToMxObject(_3e));}}else{for(var i in _3e){if(this._references&&this._references[_3e]){var _3f=this._references[i];_3f._references=this._references;_3d.push(_3f);}else{_3d.push(mx.data.jsonToMxObject(_3e[i]));}}}}else{}}else{var e=this.id+".getChildren: attribute "+_3b+" is not an ObjectReference(Set).";logger.exception(e);throw new Error(e);}}else{}return _3d;},getChild:function(_40){if(!(typeof (_40)=="string")){var e=this.id+".getChild : parameter attr("+_40+") is not of type String.";logger.error(e);throw new Error(e);}if(this.has(_40)&&this.isObjectReference(_40)){var _41=this.get(_40);if(this._references&&this._references[_41]){var _42=this._references[_41];_42._references=this._references;return _42;}else{if(typeof _41=="object"){return new mendix.lib.MxObject({json:_41,meta:mx.meta.getEntity(_41.objectType)});}else{return null;}}}},removeReferences:function(_43,_44){if(!(typeof (_43)=="string")){var e=this.id+".removeReference : parameter attr is not of type String.";logger.error(e);throw new Error(e);}else{if(this.has(_43)){if(!this.isReference(_43)){var e=this.id+".removeReference : attempt to remove Reference from non-Reference attribute : "+_43;logger.exception(e);throw new Error(e);}}else{return false;}}if(!(_1.isArray(_44))){_44=[_44];}try{if(!this._hasChildren(_43)){if(this.isObjectReference(_43)){this._setContent(_43,"");}else{this._setContent(_43,mendix.lang.arraySubtract(this.getReferences(_43),_44));}}else{if(this.isObjectReference(_43)){this._setContent(_43,"");}else{for(var i=0;i<_44.length;i++){delete this.jsonData.attributes[_43].value[_44[i]];}var val=mendix.lang.arraySubtract(this.getReferences(_43),_44);return this._makeChange(_43,val);}}}catch(e){logger.error(this.id+".removeReference caught : "+e);return false;}},addReference:function(_45,_46){if(!(typeof (_45)=="string")){var e=this.id+".addReference : parameter attr is not of type String.";logger.error(e);throw new Error(e);}else{if(!_46){var e=this.id+".addReference : parameter guid is not set.";logger.error(e);throw new Error(e);}else{if(this.has(_45)){if(!this.isReference(_45)){var e=this.id+".addReference : attempt to add Reference to non-Reference attribute : "+_45;logger.exception(e);throw new Error(e);}}else{logger.warn(this.id+".addReference : No such attribute in object - "+_45);return false;}}}try{if(this.isObjectReference(_45)){this._setContent(_45,_46);}else{var _47=this.getReferences(_45);var _48=_47.join(";");if(!(_48.match(_46))){_47.push(_46);this._setContent(_45,_47);}}}catch(e){return false;}},addReferences:function(_49,_4a){for(var i=0;i<_4a.length;i++){var _4b=_4a[i];if(_4b!=0&&!isNaN(_4b)){this.addReference(_49,_4b);}}},getReferenceAttributes:function(){return this.metaData.getReferenceAttributes();},getAttributes:function(){return this.metaData.getAttributes();},getPrimitives:function(){return this.metaData.getAttributesWithoutReferences();},getAttributeType:function(_4c){return this.metaData.getAttributeType(_4c);},getSelectorEntity:function(_4d){return this.metaData.getSelectorEntity(_4d);},getEntity:function(){return (this.jsonData&&this.jsonData["objectType"]);},isA:function(_4e){return this.metaData.isA(_4e);},hasSuperEntities:function(){return this.metaData.hasSuperEntities();},getSuperEntities:function(){return this.metaData.getSuperEntities();},hasSubEntities:function(){return this.metaData.hasSubEntities();},getSubEntities:function(){return this.metaData.getSubEntities();},reset:function(){this._changeData=this._backup!=null?this._backup:{};},inheritsFrom:function(_4f){return this.metaData.inheritsFrom(_4f);},compare:function(_50){if(_50.getEntity()!=this.getEntity()){return false;}var _51=this.getAttributesWithoutReferences();for(var i=0,_52;_52=_51[i];i++){if(this.get(_52)!=_50.get(_52)){return false;}}var _53=this.getReferenceAttributes();for(var i=0,ref;ref=_53[i];i++){if((ref=="System.changedBy")||(ref=="System.owner")){continue;}var _54=_50.getReferences(ref);var _55=this.getReferences(ref);var _56=_55.join(",");for(var j=0,id;id=_54[j];j++){if(!_56.match(id)){return false;}}}return true;},toString:function(){return this.getGuid();},dump:function(){return _1.toJson(this.jsonData).replace(/}/g,"}\n");},dumpAttribute:function(_57){return String(this._getAttributeValue(_57));},clean:function(){},_hasChildren:function(_58){if(this._changeData[_58]){return false;}var _59=this._getAttributeValue(_58);if(this._references&&this._references[_59]){return true;}return (_59&&(typeof _59=="object")&&(_59.length==null));},_getAttributeValue:function(_5a){var val=this.jsonData.attributes[_5a];if(val===undefined){val=null;}return (val&&(typeof val=="object")&&("value" in val))?val.value:val;},_setAttributeValue:function(_5b,_5c){var val=this.jsonData.attributes[_5b];if(_5c===undefined){_5c=null;}if(val&&(typeof (val)=="object")&&"value" in val){val.value=_5c;}else{this.jsonData.attributes[_5b]=_5c;}},_getAttributeNode:function(_5d){return (this.jsonData.attributes[_5d]);},_testArgs:function(_5e,_5f){for(var i=0;i<_5e.length;i++){}},_makeChange:function(_60,_61){this._changeData[_60]=_61;mx.data.makeChange(this,_60,_61);return true;},_applyChangeSet:function(){for(var _62 in this._changeData){this._setAttributeValue(_62,this._changeData[_62]);}this._backup=this._changeData;this._changeData={};},_commitChangeSet:function(){this._backup=null;}});});