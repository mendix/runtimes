
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mendix/lib/XPathSource",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mendix.lib.XPathSource");_1.declare("mendix.lib.XPathSource",[mendix.lib.XPathSourceBase],{name:"mendix.lib.XPathSource",_entity:"",_xpath:"",_pathConstraint:"",_useContext:false,constructor:function(_4){var _5=_4.path;this._useContext=_4.useContext;this._entity=_4.entity;if(_5){this._pathConstraint="["+_5.reverse().join("/")+"=\"[%CurrentObject%]\"]";}},reload:function(_6){this._xpath="";this._runSafeQuery(_6);},refresh:function(_7){this._runSafeQuery(_7);},update:function(_8){var _9=this._xpath;this._actGetXPath(_1.hitch(this,function(){if(_9==this._xpath){mendix.lang.nullExec(_8);}else{if(_8){this._runQuery(_8);}}}));},entityUpdate:function(_a){this._runSafeQuery(_a);},generateExport:function(_b){_b.params=_1.mixin({},_b.params,{xpath:this.getCurrentXPath(),sort:this.getSortSettings(),gridid:this._schemaId});mx.data.generateExport(_b);},getCurrentXPath:function(){return this._xpathString();},isValid:function(_c){if(this.context.hasBacktrack()){mx.data.getBacktrackConstraints(null,this.context,_1.hitch(this,function(_d,_e){_c&&_c(_e);}),function(e){mx.onError(e);_c&&_c(false);});}else{_c&&_c(true);}},_actGetXPath:function(_f){var _10=mendix.lang.nullExec;if(this._useContext){mx.data.createXPathString({entity:this._entity,context:this.context,callback:_1.hitch(this,function(_11){this._xpath=_11;_10(_f);}),error:function(e){mx.onError(e);_f&&_f();}});}else{if(this.context&&this.context.hasBacktrack()){mx.data.getBacktrackConstraints(null,this.context,_1.hitch(this,function(_12,_13){if(_13){this._xpath="//"+this._entity+_12;}else{this._xpath="";}_10(_f);}),function(e){mx.onError(e);_f&&_f();});}else{this._xpath="//"+this._entity;_10(_f);}}},_runSafeQuery:function(_14){var _15=["_runQuery"];if(!this._xpath){_15.unshift("_actGetXPath");}mendix.lang.sequence(_15,_14,this);},_runQuery:function(_16){var _17=mendix.lang.nullExec,_18=this._xpathString();if(_18){mx.data.get({xpath:this.getCurrentXPath(),filter:this.getFilterOptions(),count:true,aggregates:this._aggregates,callback:function(_19,_1a){this._handleObjects(_19,_1a.count,_1a.aggregates,_16);},error:function(e){mx.onError(e);_16&&_16();}},this);}else{this._handleObjects([],0,null,_16);}},_handleObjects:function(_1b,_1c,_1d,_1e){this._setObjects(_1b);this._setSetSize(_1c);this._setAggregates(_1d);_1e&&_1e();},_xpathString:function(){var _1f=[this._pathConstraint,this.getStaticConstraint(),this.getConstraints()].join(""),_20="";if(this._xpath){var _21=this._xpath+_1f;if(/\[%CurrentObject%\]/.test(_21)){var _22=this.context.getTrackId();if(_22){_20=mx.parser.replaceXPathTokens(_21,this.context);}}else{_20=_21;}}return _20;}});});