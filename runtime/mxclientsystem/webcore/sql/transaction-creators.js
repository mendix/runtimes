/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/sql/transaction-creators",["./constants","./SelectBuilder","./CreateBuilder","./Column","./InsertBuilder","../applicative","../DanglingError","../monad","../TaskReader","../Task","big/big"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c=_9;var _d={"String":"text","Integer":"text","Long":"text","Decimal":"text","Float":"text","Currency":"text","Enum":"text","HashString":"text","ObjectReference":"text","DateTime":"integer","Boolean":"integer","AutoNumber":"integer","Binary":"blob"};var _e={"String":false,"Integer":false,"Long":false,"Decimal":false,"Float":false,"Currency":false,"Enum":false,"HashString":false,"ObjectReference":false,"DateTime":true,"Boolean":true,"AutoNumber":true,"Binary":false};var _f={"String":String,"Integer":_10,"Long":_10,"Decimal":_10,"Float":_10,"Currency":_10,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_11,"Boolean":Number,"AutoNumber":String,"Binary":String};var _12={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_13,"Boolean":Boolean,"AutoNumber":String,"Binary":String};var _14={"String":_13,"Integer":_13,"Long":_13,"Decimal":_13,"Float":_13,"Currency":_13,"Enum":_13,"HashString":_13,"ObjectReference":_13,"DateTime":Number,"Boolean":_15,"AutoNumber":_13,"Binary":_13};var _16={"String":"UPPER","Enum":"UPPER"};var _17={createCreateTransaction:function(_18){var _19=[_1a()].concat(_18.map(_1b));return _6.sequence(_19,_c);function _1b(_1c){var _1d=_1e(_1c).reduce(function(_1f,_20){return _1f.column(_27(_20.attr),_20.type);},_3().table(_27(_1c)).primaryKeyColumn("guid","text"));return _2a(_1d.createIfNotExists(),[]);};function _1e(_21){var _22=mx.meta.getEntity(_21);return _22.getAttributes().map(function(_23){var _24=_22.getAttributeType(_23);return {attr:_23,type:_d[_24]};});};},createResetTransaction:function(_25){var _26=["_guidToTable"].concat(_25).map(_27).map(function(_28){return "DROP TABLE IF EXISTS '"+_28+"'";}).map(function(_29){return _2a(_29,[]);});return _8.sequence([_6.sequence(_26,_c),this.createCreateTransaction(_25)],_c);},createFetchByGuidTransaction:function(_2b){var _2c=_2().from("_guidToTable").where("guid","equals").select("*");return _2a(_2c,[_2b]).chain(function(res){if(res.rows.length===0){return _c.rejected(new Error("guid not found"));}if(res.rows.length!==1){return _c.rejected(new Error("db consistency error"));}return _c.of(res.rows.item(0));}).chain(function(row){var _2d=row.tableName;var _2e=!row.dirty;var _2f=row.autocommitted;var _30=_2().from(_27(_2d)).where("guid","equals").select("*");return _2a(_30,[_2b]).map(function(res){if(res.rows.length===0){return _a.rejected(new Error("entity not found"));}if(res.rows.length!==1){return _a.rejected(new Error("db consistency error"));}return _31(window.mx.meta.getEntity(_2d),_2f,_2e,res.rows.item(0));});});},createFetchSliceTransaction:function(_32,_33,_34,_35,_36){_33=_33||[];_36=_36||[];var _37=mx.meta.getEntity(_32);var _38=_39(_37,_33);var _3a=_38.builder.from(_27(_32));var _3b=_38.args;var _3c=_36.reduce(function(acc,_3d){var _3e=_37.getAttributeType(_3d[0]);var _3f=_4(_3d[0]);var _40=_16[_3e];if(_40){_3f=_3f.apply1(_40);}return acc.order(_3f,_3d[1]);},_3a.offset(_34).limit(_35));var _41=_2a(_3c.select("*"),_3b).map(function(res){var _42=[];for(var i=0;i<res.rows.length;++i){var _43=!/^GUID:/.test(res.rows.item(i).guid);var _44=0;_42.push(_31(_37,_44,_43,res.rows.item(i)));}return _42;});var _45=_2a(_3a.select("COUNT(*)","cnt"),_3b).map(function(res){return res.rows.item(0).cnt;});return _6.lift2(function(x,y){return [x,y];},_41,_45);},createInsertOrReplaceTransaction:function(_46,_47){var _48=_49(_46,false);var _4a=_47.map(function(obj){return _61(obj.guid).map(function(res){return res.rows.length>0;}).chain(function(_4b){if(!_4b){return _49(obj,true);}else{return _c.of();}});});return _6.sequence_([_48].concat(_4a),_c);},createFillBulkTransaction:function(_4c,_4d){var _4e=_4d.reduce(function(acc,obj){var _4f=_50();var _51=_52(_4c,obj);return acc.concat([_2a(_4f.insert(),[obj.guid,_4c,0,0]),_2a(_51.builder.insert(),_51.values)]);},[]);return _6.sequence(_4e,_c);},createUpdateTransaction:function(_53,obj){var _54=_52(_53,obj);return _2a(_54.builder.insertOrReplace(),_54.values);},createFetchDirtyObjectsTransaction:function(){return _55().chain(function(res){var _56=_84(res.rows).map(function(row){return _17.createFetchByGuidTransaction(row.guid);});return _6.sequence(_56,_c);});},createUploadTransaction:function(){var _57=this;return _58().chain(function(res){if(res.rows.length>0){var msg="There are autocommitted objects remaining. Sync has failed.";return _c.rejected(new _7(msg));}return _57.createFetchDirtyObjectsTransaction();});},createDeleteTransaction:function(_59,_5a){return _6.sequence([_2a("DELETE FROM "+_27(_59)+" WHERE guid = ?",[_5a]),_2a("DELETE FROM _guidToTable WHERE guid = ?",[_5a])],_c);},createDirtyCleanupTransaction:function(){return _2a("SELECT DISTINCT tableName FROM _guidToTable WHERE dirty = 1").chain(function(res){var _5b=_84(res.rows).map(function(row){var _5c=row.tableName;return _2a("DELETE FROM "+_27(_5c)+" WHERE guid IN ("+"SELECT guid FROM _guidToTable WHERE tableName = ? AND dirty = 1)",[_5c]);});return _8.sequence_([_6.sequence(_5b,_c),_2a("DELETE FROM _guidToTable WHERE dirty = 1")],_c);});}};return _17;function _49(obj,_5d){_5d=_5d+0;var _5e=obj.$objectType;var _5f=_50();var _60=_52(_5e,obj);return _6.sequence_([_2a(_5f.insertOrReplace(),[obj.guid,_5e,1,_5d]),_2a(_60.builder.insertOrReplace(),_60.values)],_c);};function _1a(){var sql=_3().table("_guidToTable").primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("autocommitted","boolean").createIfNotExists();return _2a(sql,[]);};function _55(){var sql=_2().from("_guidToTable").where("dirty","equals").select("*");return _2a(sql,[1]);};function _58(){var sql=_2().from("_guidToTable").where("autocommitted","equals").select("guid");return _2a(sql,[1]);};function _61(_62){var sql=_2().from("_guidToTable").where("guid","equals").select("guid");return _2a(sql,[_62]);};function _63(_64,_65){if(_65==="guid"){return "String";}else{return _64.getAttributeType(_65);}};function _50(){return _5().into("_guidToTable").column("guid").column("tableName").column("dirty").column("autocommitted");};function _39(_66,_67){return _67.reduce(function(acc,_68){var _69=_66.getAttributeType(_68.attribute);var _6a=_e[_69];var _6b=_68.value===""||_68.value==null;var _6c=_14[_69];var _6d=_f[_69];if(_6a==null||!_6d){return acc;}var _6e=_6d(_6c(_68.value));if(_6b&&_6a&&_68.operator==="equals"){var _6f=_68.negate?acc.builder.whereNotNull:acc.builder.whereNull;return {constraintString:_6f.call(acc.builder,_27(_68.attribute)),args:acc.args};}else{if(_6b&&_6a&&_68.operator==="contains"){return acc;}else{var _70=_68.negate?acc.builder.whereNot:acc.builder.where;var _71=_68.operator==="contains"?_72(_6e):_6e;return {builder:_70.call(acc.builder,_27(_68.attribute),_68.operator),args:acc.args.concat([_71])};}}},{builder:_2(),args:[]});};function _52(_73,obj){var _74=mx.meta.getEntity(_73);var _75=_74.getAttributes();var _76=_75.reduce(function(acc,_77){var _78=_74.getAttributeType(_77);var _79=_f[_78];if(!_79){return acc;}var _7a=_79(obj[_77]);return {attrs:acc.attrs.concat([_77]),values:acc.values.concat([_7a])};},{attrs:["guid"],values:[obj.guid]});var _7b=_76.attrs.reduce(function(_7c,_7d){return _7c.column(_27(_7d));},_5().into(_27(_73)));return {builder:_7b,values:_76.values};};function _10(x){if(x===""){return "";}var _7e=20;var _7f=new _b(x);var _80=_7e-Math.max(0,_7f.e)-1;var _81=_7f.s<0?"-":"";var _82=new Array(_80+1).join("0");var _83=_7f.abs().toFixed();return _81+_82+_83;};function _11(x){if(x==null){return null;}else{return Number(x);}};function _15(s){return s!=="false";};function _13(x){return x;};function _84(_85){var arr=[];for(var i=0;i<_85.length;++i){arr.push(_85.item(i));}return arr;};function _72(s){var _86=_1.LIKE_ESCAPE_CHAR;return s.replace(new RegExp(_86,"g"),_86+_86).replace(/%/g,_86+"%").replace(/_/g,_86+"_");};function _27(key){return key.replace(".","$");};function _87(_88){return _88.replace("$",".");};function _31(_89,_8a,_8b,row){var _8c={guid:row.guid,$objectType:_89.getEntity(),$autocommitted:_8a,$readonlyAttrs:[]};for(var _8d in row){var _8e=_87(_8d);if(_8e==="guid"){continue;}var _8f=_89.getAttributeType(_8e);var _90=_12[_8f];if(!_90){continue;}_8c[_8e]=_90(row[_8d]);if(_8b){_8c.$readonlyAttrs.push(_8e);}}return _8c;};function _2a(sql,_91){_91=_91||[];return new _c(function(tx){return new _a(function(_92,_93){tx.executeSql(sql,_91,function(tx,res){_93(res);},function(tx,e){_92(e);});});});};});