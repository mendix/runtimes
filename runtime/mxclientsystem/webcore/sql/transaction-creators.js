/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/sql/transaction-creators",["./constants","./SelectBuilder","./CreateBuilder","./Column","./InsertBuilder","../applicative","../DanglingError","../monad","../TaskReader","../Task","big/big"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c=_9;var _d={"String":"text","Integer":"text","Long":"text","Decimal":"text","Float":"text","Currency":"text","Enum":"text","HashString":"text","ObjectReference":"text","DateTime":"integer","Boolean":"integer","AutoNumber":"integer","Binary":"blob"};var _e={"String":false,"Integer":false,"Long":false,"Decimal":false,"Float":false,"Currency":false,"Enum":false,"HashString":false,"ObjectReference":false,"DateTime":true,"Boolean":true,"AutoNumber":true,"Binary":false};var _f={"String":String,"Integer":_10,"Long":_10,"Decimal":_10,"Float":_10,"Currency":_10,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_11,"Boolean":Number,"AutoNumber":String,"Binary":String};var _12={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_13,"Boolean":Boolean,"AutoNumber":String,"Binary":String};var _14={"String":_13,"Integer":_13,"Long":_13,"Decimal":_13,"Float":_13,"Currency":_13,"Enum":_13,"HashString":_13,"ObjectReference":_13,"DateTime":Number,"Boolean":_15,"AutoNumber":_13,"Binary":_13};var _16={"String":"UPPER","Enum":"UPPER"};var _17={createCreateTransaction:_18,createResetTransaction:_19,createFetchByGuidTransaction:function(_1a){var _1b=_2().from("_guidToTable").where("guid","equals").select("*");return _1c(_1b,[_1a]).chain(function(res){if(res.rows.length===0){return _c.rejected(new Error("guid not found"));}if(res.rows.length!==1){return _c.rejected(new Error("db consistency error"));}return _c.of(res.rows.item(0));}).chain(function(row){var _1d=row.tableName;var _1e=!row.dirty;var _1f=row.autocommitted;var _20=_2().from(_2b(_1d)).where("guid","equals").select("*");return _1c(_20,[_1a]).map(function(res){if(res.rows.length===0){return _a.rejected(new Error("entity not found"));}if(res.rows.length!==1){return _a.rejected(new Error("db consistency error"));}return _21(window.mx.meta.getEntity(_1d),_1f,_1e,res.rows.item(0));});});},createFetchSliceTransaction:function(_22,_23,_24,_25,_26){_23=_23||[];_26=_26||[];var _27=mx.meta.getEntity(_22);var _28=_29(_27,_23);var _2a=_28.builder.from(_2b(_22));var _2c=_28.args;var _2d=_26.reduce(function(acc,_2e){var _2f=_27.getAttributeType(_2e[0]);var _30=_4(_2e[0]);var _31=_16[_2f];if(_31){_30=_30.apply1(_31);}return acc.order(_30,_2e[1]);},_2a.offset(_24).limit(_25));var _32=_1c(_2d.select("*"),_2c).map(function(res){var _33=[];for(var i=0;i<res.rows.length;++i){var _34=!/^GUID:/.test(res.rows.item(i).guid);var _35=0;_33.push(_21(_27,_35,_34,res.rows.item(i)));}return _33;});var _36=_1c(_2a.select("COUNT(*)","cnt"),_2c).map(function(res){return res.rows.item(0).cnt;});return _6.lift2(function(x,y){return [x,y];},_32,_36);},createInsertOrReplaceTransaction:function(_37,_38){var _39=_37.map(function(_3a){return _3d(_3a,false);});var _3b=_38.map(function(obj){return _6a(obj.guid).map(function(res){return res.rows.length>0;}).chain(function(_3c){if(!_3c){return _3d(obj,true);}else{return _c.of();}});});return _6.sequence_(_39.concat(_3b),_c);},createFillBulkTransaction:_3e,createUpdateTransaction:function(_3f,obj){var _40=_41(_3f,obj);return _1c(_40.builder.insertOrReplace(),_40.values);},createFetchDirtyObjectsTransaction:function(){return _42().chain(function(res){var _43=_8d(res.rows).map(function(row){return _17.createFetchByGuidTransaction(row.guid);});return _6.sequence(_43,_c);});},createUploadTransaction:function(){var _44=this;return _45().chain(function(res){if(res.rows.length>0){var msg="There are autocommitted objects remaining. Sync has failed.";return _c.rejected(new _7(msg));}return _44.createFetchDirtyObjectsTransaction();});},createDeleteTransaction:function(_46,_47){return _6.sequence([_1c("DELETE FROM "+_2b(_46)+" WHERE guid = ?",[_47]),_1c("DELETE FROM _guidToTable WHERE guid = ?",[_47])],_c);},createDirtyCleanupTransaction:function(){return _1c("SELECT DISTINCT tableName FROM _guidToTable WHERE dirty = 1").chain(function(res){var _48=_8d(res.rows).map(function(row){var _49=row.tableName;return _1c("DELETE FROM "+_2b(_49)+" WHERE guid IN ("+"SELECT guid FROM _guidToTable WHERE tableName = ? AND dirty = 1)",[_49]);});return _8.sequence_([_6.sequence(_48,_c),_1c("DELETE FROM _guidToTable WHERE dirty = 1")],_c);});},createRebuildTransaction:function(_4a,_4b){var _4c=_19(_4a);var _4d=_4b.map(function(_4e){return _3e(_4e[0],_4e[1]);});return _8.sequence([_4c,_6.sequence(_4d,_c)],_c);}};return _17;function _19(_4f){var _50=["_guidToTable"].concat(_4f).map(_2b).map(function(_51){return "DROP TABLE IF EXISTS '"+_51+"'";}).map(function(_52){return _1c(_52,[]);});return _8.sequence([_6.sequence(_50,_c),_18(_4f)],_c);};function _18(_53){var _54=[_55()].concat(_53.map(_56));return _6.sequence(_54,_c);function _56(_57){var _58=_59(_57).reduce(function(_5a,_5b){return _5a.column(_2b(_5b.attr),_5b.type);},_3().table(_2b(_57)).primaryKeyColumn("guid","text"));return _1c(_58.createIfNotExists(),[]);};function _59(_5c){var _5d=mx.meta.getEntity(_5c);return _5d.getAttributes().map(function(_5e){var _5f=_5d.getAttributeType(_5e);return {attr:_5e,type:_d[_5f]};});};};function _3e(_60,_61){var _62=_61.reduce(function(acc,obj){var _63=_64();var _65=_41(_60,obj);return acc.concat([_1c(_63.insert(),[obj.guid,_60,0,0]),_1c(_65.builder.insert(),_65.values)]);},[]);return _6.sequence(_62,_c);};function _3d(obj,_66){_66=_66+0;var _67=obj.$objectType;var _68=_64();var _69=_41(_67,obj);return _6.sequence_([_1c(_68.insertOrReplace(),[obj.guid,_67,1,_66]),_1c(_69.builder.insertOrReplace(),_69.values)],_c);};function _55(){var sql=_3().table("_guidToTable").primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("autocommitted","boolean").createIfNotExists();return _1c(sql,[]);};function _42(){var sql=_2().from("_guidToTable").where("dirty","equals").select("*");return _1c(sql,[1]);};function _45(){var sql=_2().from("_guidToTable").where("autocommitted","equals").select("guid");return _1c(sql,[1]);};function _6a(_6b){var sql=_2().from("_guidToTable").where("guid","equals").select("guid");return _1c(sql,[_6b]);};function _6c(_6d,_6e){if(_6e==="guid"){return "String";}else{return _6d.getAttributeType(_6e);}};function _64(){return _5().into("_guidToTable").column("guid").column("tableName").column("dirty").column("autocommitted");};function _29(_6f,_70){return _70.reduce(function(acc,_71){var _72=_6f.getAttributeType(_71.attribute);var _73=_e[_72];var _74=_71.value===""||_71.value==null;var _75=_14[_72];var _76=_f[_72];if(_73==null||!_76){return acc;}var _77=_76(_75(_71.value));if(_74&&_73&&_71.operator==="equals"){var _78=_71.negate?acc.builder.whereNotNull:acc.builder.whereNull;return {constraintString:_78.call(acc.builder,_2b(_71.attribute)),args:acc.args};}else{if(_74&&_73&&_71.operator==="contains"){return acc;}else{var _79=_71.negate?acc.builder.whereNot:acc.builder.where;var _7a=_71.operator==="contains"?_7b(_77):_77;return {builder:_79.call(acc.builder,_2b(_71.attribute),_71.operator),args:acc.args.concat([_7a])};}}},{builder:_2(),args:[]});};function _41(_7c,obj){var _7d=mx.meta.getEntity(_7c);var _7e=_7d.getAttributes();var _7f=_7e.reduce(function(acc,_80){var _81=_7d.getAttributeType(_80);var _82=_f[_81];if(!_82){return acc;}var _83=_82(obj[_80]);return {attrs:acc.attrs.concat([_80]),values:acc.values.concat([_83])};},{attrs:["guid"],values:[obj.guid]});var _84=_7f.attrs.reduce(function(_85,_86){return _85.column(_2b(_86));},_5().into(_2b(_7c)));return {builder:_84,values:_7f.values};};function _10(x){if(x===""){return "";}var _87=20;var _88=new _b(x);var _89=_87-Math.max(0,_88.e)-1;var _8a=_88.s<0?"-":"";var _8b=new Array(_89+1).join("0");var _8c=_88.abs().toFixed();return _8a+_8b+_8c;};function _11(x){if(x==null){return null;}else{return Number(x);}};function _15(s){return s!=="false";};function _13(x){return x;};function _8d(_8e){var arr=[];for(var i=0;i<_8e.length;++i){arr.push(_8e.item(i));}return arr;};function _7b(s){var _8f=_1.LIKE_ESCAPE_CHAR;return s.replace(new RegExp(_8f,"g"),_8f+_8f).replace(/%/g,_8f+"%").replace(/_/g,_8f+"_");};function _2b(key){return key.replace(".","$");};function _90(_91){return _91.replace("$",".");};function _21(_92,_93,_94,row){var _95={guid:row.guid,$objectType:_92.getEntity(),$autocommitted:_93,$readonlyAttrs:[]};for(var _96 in row){var _97=_90(_96);if(_97==="guid"){continue;}var _98=_92.getAttributeType(_97);var _99=_12[_98];if(!_99){continue;}_95[_97]=_99(row[_96]);if(_94){_95.$readonlyAttrs.push(_97);}}return _95;};function _1c(sql,_9a){_9a=_9a||[];return new _c(function(tx){return new _a(function(_9b,_9c){tx.executeSql(sql,_9a,function(tx,res){_9c(res);},function(tx,e){_9b(e);});});});};});