/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/sql/transaction-creators",["./constants","./SelectBuilder","./CreateBuilder","./Column","./InsertBuilder","../applicative","../DanglingError","../monad","../TaskReader","../Task","big/big"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c=_9;var _d={"String":"text","Integer":"text","Long":"text","Decimal":"text","Float":"text","Currency":"text","Enum":"text","HashString":"text","ObjectReference":"text","DateTime":"integer","Boolean":"integer","AutoNumber":"integer","Binary":"blob"};var _e={"String":false,"Integer":false,"Long":false,"Decimal":false,"Float":false,"Currency":false,"Enum":false,"HashString":false,"ObjectReference":false,"DateTime":true,"Boolean":true,"AutoNumber":true,"Binary":false};var _f={"String":String,"Integer":_10,"Long":_10,"Decimal":_10,"Float":_10,"Currency":_10,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_11,"Boolean":Number,"AutoNumber":String,"Binary":String};var _12={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_13,"Boolean":Boolean,"AutoNumber":String,"Binary":String};var _14={"String":_13,"Integer":_13,"Long":_13,"Decimal":_13,"Float":_13,"Currency":_13,"Enum":_13,"HashString":_13,"ObjectReference":_13,"DateTime":Number,"Boolean":_15,"AutoNumber":_13,"Binary":_13};var _16={"String":"UPPER","Enum":"UPPER"};var _17={createCreateTransaction:_18,createResetTransaction:_19,createFetchByGuidTransaction:function(_1a){var _1b=_2().from("_guidToTable").where("guid","equals").select("*");return _1c(_1b,[_1a]).chain(function(res){if(res.rows.length===0){return _c.rejected(new Error("guid not found"));}if(res.rows.length!==1){return _c.rejected(new Error("db consistency error"));}return _c.of(res.rows.item(0));}).chain(function(row){var _1d=row.tableName;var _1e=!row.dirty;var _1f=row.autocommitted;var _20=_2().from(_2b(_1d)).where("guid","equals").select("*");return _1c(_20,[_1a]).map(function(res){if(res.rows.length===0){return _a.rejected(new Error("entity not found"));}if(res.rows.length!==1){return _a.rejected(new Error("db consistency error"));}return _21(window.mx.meta.getEntity(_1d),_1f,_1e,res.rows.item(0));});});},createFetchSliceTransaction:function(_22,_23,_24,_25,_26){_23=_23||[];_26=_26||[];var _27=mx.meta.getEntity(_22);var _28=_29(_27,_23);var _2a=_28.builder.from(_2b(_22));var _2c=_28.args;var _2d=_26.reduce(function(acc,_2e){var _2f=_27.getAttributeType(_2e[0]);var _30=_4(_2e[0]);var _31=_16[_2f];if(_31){_30=_30.apply1(_31);}return acc.order(_30,_2e[1]);},_2a.offset(_24).limit(_25));var _32=_1c(_2d.select("*"),_2c).map(function(res){var _33=[];for(var i=0;i<res.rows.length;++i){var _34=!/^GUID:/.test(res.rows.item(i).guid);var _35=0;_33.push(_21(_27,_35,_34,res.rows.item(i)));}return _33;});var _36=_1c(_2a.select("COUNT(*)","cnt"),_2c).map(function(res){return res.rows.item(0).cnt;});return _6.lift2(function(x,y){return [x,y];},_32,_36);},createInsertOrReplaceTransaction:function(_37,_38){var _39=_3a(_37,false);var _3b=_38.map(function(obj){return _69(obj.guid).map(function(res){return res.rows.length>0;}).chain(function(_3c){if(!_3c){return _3a(obj,true);}else{return _c.of();}});});return _6.sequence_([_39].concat(_3b),_c);},createFillBulkTransaction:_3d,createUpdateTransaction:function(_3e,obj){var _3f=_40(_3e,obj);return _1c(_3f.builder.insertOrReplace(),_3f.values);},createFetchDirtyObjectsTransaction:function(){return _41().chain(function(res){var _42=_8c(res.rows).map(function(row){return _17.createFetchByGuidTransaction(row.guid);});return _6.sequence(_42,_c);});},createUploadTransaction:function(){var _43=this;return _44().chain(function(res){if(res.rows.length>0){var msg="There are autocommitted objects remaining. Sync has failed.";return _c.rejected(new _7(msg));}return _43.createFetchDirtyObjectsTransaction();});},createDeleteTransaction:function(_45,_46){return _6.sequence([_1c("DELETE FROM "+_2b(_45)+" WHERE guid = ?",[_46]),_1c("DELETE FROM _guidToTable WHERE guid = ?",[_46])],_c);},createDirtyCleanupTransaction:function(){return _1c("SELECT DISTINCT tableName FROM _guidToTable WHERE dirty = 1").chain(function(res){var _47=_8c(res.rows).map(function(row){var _48=row.tableName;return _1c("DELETE FROM "+_2b(_48)+" WHERE guid IN ("+"SELECT guid FROM _guidToTable WHERE tableName = ? AND dirty = 1)",[_48]);});return _8.sequence_([_6.sequence(_47,_c),_1c("DELETE FROM _guidToTable WHERE dirty = 1")],_c);});},createRebuildTransaction:function(_49,_4a){var _4b=_19(_49);var _4c=_4a.map(function(_4d){return _3d(_4d[0],_4d[1]);});return _8.sequence([_4b,_6.sequence(_4c,_c)],_c);}};return _17;function _19(_4e){var _4f=["_guidToTable"].concat(_4e).map(_2b).map(function(_50){return "DROP TABLE IF EXISTS '"+_50+"'";}).map(function(_51){return _1c(_51,[]);});return _8.sequence([_6.sequence(_4f,_c),_18(_4e)],_c);};function _18(_52){var _53=[_54()].concat(_52.map(_55));return _6.sequence(_53,_c);function _55(_56){var _57=_58(_56).reduce(function(_59,_5a){return _59.column(_2b(_5a.attr),_5a.type);},_3().table(_2b(_56)).primaryKeyColumn("guid","text"));return _1c(_57.createIfNotExists(),[]);};function _58(_5b){var _5c=mx.meta.getEntity(_5b);return _5c.getAttributes().map(function(_5d){var _5e=_5c.getAttributeType(_5d);return {attr:_5d,type:_d[_5e]};});};};function _3d(_5f,_60){var _61=_60.reduce(function(acc,obj){var _62=_63();var _64=_40(_5f,obj);return acc.concat([_1c(_62.insert(),[obj.guid,_5f,0,0]),_1c(_64.builder.insert(),_64.values)]);},[]);return _6.sequence(_61,_c);};function _3a(obj,_65){_65=_65+0;var _66=obj.$objectType;var _67=_63();var _68=_40(_66,obj);return _6.sequence_([_1c(_67.insertOrReplace(),[obj.guid,_66,1,_65]),_1c(_68.builder.insertOrReplace(),_68.values)],_c);};function _54(){var sql=_3().table("_guidToTable").primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("autocommitted","boolean").createIfNotExists();return _1c(sql,[]);};function _41(){var sql=_2().from("_guidToTable").where("dirty","equals").select("*");return _1c(sql,[1]);};function _44(){var sql=_2().from("_guidToTable").where("autocommitted","equals").select("guid");return _1c(sql,[1]);};function _69(_6a){var sql=_2().from("_guidToTable").where("guid","equals").select("guid");return _1c(sql,[_6a]);};function _6b(_6c,_6d){if(_6d==="guid"){return "String";}else{return _6c.getAttributeType(_6d);}};function _63(){return _5().into("_guidToTable").column("guid").column("tableName").column("dirty").column("autocommitted");};function _29(_6e,_6f){return _6f.reduce(function(acc,_70){var _71=_6e.getAttributeType(_70.attribute);var _72=_e[_71];var _73=_70.value===""||_70.value==null;var _74=_14[_71];var _75=_f[_71];if(_72==null||!_75){return acc;}var _76=_75(_74(_70.value));if(_73&&_72&&_70.operator==="equals"){var _77=_70.negate?acc.builder.whereNotNull:acc.builder.whereNull;return {constraintString:_77.call(acc.builder,_2b(_70.attribute)),args:acc.args};}else{if(_73&&_72&&_70.operator==="contains"){return acc;}else{var _78=_70.negate?acc.builder.whereNot:acc.builder.where;var _79=_70.operator==="contains"?_7a(_76):_76;return {builder:_78.call(acc.builder,_2b(_70.attribute),_70.operator),args:acc.args.concat([_79])};}}},{builder:_2(),args:[]});};function _40(_7b,obj){var _7c=mx.meta.getEntity(_7b);var _7d=_7c.getAttributes();var _7e=_7d.reduce(function(acc,_7f){var _80=_7c.getAttributeType(_7f);var _81=_f[_80];if(!_81){return acc;}var _82=_81(obj[_7f]);return {attrs:acc.attrs.concat([_7f]),values:acc.values.concat([_82])};},{attrs:["guid"],values:[obj.guid]});var _83=_7e.attrs.reduce(function(_84,_85){return _84.column(_2b(_85));},_5().into(_2b(_7b)));return {builder:_83,values:_7e.values};};function _10(x){if(x===""){return "";}var _86=20;var _87=new _b(x);var _88=_86-Math.max(0,_87.e)-1;var _89=_87.s<0?"-":"";var _8a=new Array(_88+1).join("0");var _8b=_87.abs().toFixed();return _89+_8a+_8b;};function _11(x){if(x==null){return null;}else{return Number(x);}};function _15(s){return s!=="false";};function _13(x){return x;};function _8c(_8d){var arr=[];for(var i=0;i<_8d.length;++i){arr.push(_8d.item(i));}return arr;};function _7a(s){var _8e=_1.LIKE_ESCAPE_CHAR;return s.replace(new RegExp(_8e,"g"),_8e+_8e).replace(/%/g,_8e+"%").replace(/_/g,_8e+"_");};function _2b(key){return key.replace(".","$");};function _8f(_90){return _90.replace("$",".");};function _21(_91,_92,_93,row){var _94={guid:row.guid,$objectType:_91.getEntity(),$autocommitted:_92,$readonlyAttrs:[]};for(var _95 in row){var _96=_8f(_95);if(_96==="guid"){continue;}var _97=_91.getAttributeType(_96);var _98=_12[_97];if(!_98){continue;}_94[_96]=_98(row[_95]);if(_93){_94.$readonlyAttrs.push(_96);}}return _94;};function _1c(sql,_99){_99=_99||[];return new _c(function(tx){return new _a(function(_9a,_9b){tx.executeSql(sql,_99,function(tx,res){_9b(res);},function(tx,e){_9a(e);});});});};});