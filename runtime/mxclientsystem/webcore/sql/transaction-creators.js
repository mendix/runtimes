/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/sql/transaction-creators",["./constants","./SelectBuilder","./Column","./InsertBuilder","../applicative","../monad","../TaskReader","../Task","big/big"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var _a=_7;var _b={"String":"text","Integer":"text","Long":"text","Decimal":"text","Float":"text","Currency":"text","Enum":"text","HashString":"text","ObjectReference":"text","DateTime":"integer","Boolean":"integer","AutoNumber":"integer","Binary":"blob"};var _c={"String":false,"Integer":false,"Long":false,"Decimal":false,"Float":false,"Currency":false,"Enum":false,"HashString":false,"ObjectReference":false,"DateTime":true,"Boolean":true,"AutoNumber":true,"Binary":false};var _d={"String":String,"Integer":_e,"Long":_e,"Decimal":_e,"Float":_e,"Currency":_e,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_f,"Boolean":Number,"AutoNumber":String,"Binary":String};var _10={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_11,"Boolean":_12,"AutoNumber":null,"Binary":String};var _13={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_14,"Boolean":Boolean,"AutoNumber":String,"Binary":String};var _15={"String":_14,"Integer":_14,"Long":_14,"Decimal":_14,"Float":_14,"Currency":_14,"Enum":_14,"HashString":_14,"ObjectReference":_14,"DateTime":Number,"Boolean":_16,"AutoNumber":_14,"Binary":_14};var _17={"String":"UPPER","Enum":"UPPER"};var _18={createCreateTransaction:function(_19){var _1a=["CREATE TABLE IF NOT EXISTS _guidToTable (guid text primary key, tableName text, dirty boolean)"].concat(_19.map(_1b)).map(function(_1c){return _2a(_1c,[]);});return _5.sequence(_1a,_a);function _1b(_1d){var _1e=[{attr:"guid",type:"text",isPrimaryKey:true}].concat(_1f(_1d)).map(function(_20){return [_27(_20.attr),_20.type,_20.isPrimaryKey?"PRIMARY KEY":""].join(" ");}).join(", ");return "CREATE TABLE IF NOT EXISTS "+_27(_1d)+" ("+_1e+")";};function _1f(_21){var _22=mx.meta.getEntity(_21);return _22.getAttributes().map(function(_23){var _24=_22.getAttributeType(_23);return {attr:_23,type:_b[_24]};});};},createDropAllTablesTransaction:function(_25){var _26=["_guidToTable"].concat(_25).map(_27).map(function(_28){return "DROP TABLE IF EXISTS '"+_28+"'";}).map(function(_29){return _2a(_29,[]);});return _5.sequence(_26,_a);},createFetchByGuidTransaction:function(_2b){var _2c=_2().from("_guidToTable").where("guid","equals").select("*");return _2a(_2c,[_2b]).chain(function(res){if(res.rows.length===0){return _a.rejected(new Error("guid not found"));}if(res.rows.length!==1){return _a.rejected(new Error("db consistency error"));}return _a.of(res.rows.item(0));}).chain(function(row){var _2d=row.tableName;var _2e=!row.dirty;var _2f=_2().from(_27(_2d)).where("guid","equals").select("*");return _2a(_2f,[_2b]).map(function(res){if(res.rows.length===0){return _8.rejected(new Error("entity not found"));}if(res.rows.length!==1){return _8.rejected(new Error("db consistency error"));}return _30(window.mx.meta.getEntity(_2d),_2e,res.rows.item(0));});});},createFetchSliceTransaction:function(_31,_32,_33,_34,_35){_32=_32||[];_35=_35||[];var _36=mx.meta.getEntity(_31);var _37=_38(_36,_32);var _39=_37.builder.from(_27(_31));var _3a=_37.args;var _3b=_35.reduce(function(acc,_3c){var _3d=_36.getAttributeType(_3c[0]);var _3e=_3(_3c[0]);var _3f=_17[_3d];if(_3f){_3e=_3e.apply1(_3f);}return acc.order(_3e,_3c[1]);},_39.offset(_33).limit(_34));var _40=_2a(_3b.select("*"),_3a).map(function(res){var _41=[];for(var i=0;i<res.rows.length;++i){var _42=!/^GUID:/.test(res.rows.item(i).guid);_41.push(_30(_36,_42,res.rows.item(i)));}return _41;});var _43=_2a(_39.select("COUNT(*)","cnt"),_3a).map(function(res){return res.rows.item(0).cnt;});return _5.lift2(function(x,y){return [x,y];},_40,_43);},createInsertOrReplaceTransaction:function(_44,obj){var _45=_46();var _47=_48(_44,obj);return _5.sequence([_2a(_45.insertOrReplace(),[obj.guid,_44,1]),_2a(_47.builder.insertOrReplace(),_47.values)],_a);},createFillBulkTransaction:function(_49,_4a){var _4b=_4a.reduce(function(acc,obj){var _4c=_46();var _4d=_48(_49,obj);return acc.concat([_2a(_4c.insert(),[obj.guid,_49,0]),_2a(_4d.builder.insert(),_4d.values)]);},[]);return _5.sequence(_4b,_a);},createUploadTransaction:function(_4e){var _4f=_2().from("_guidToTable").where("dirty","equals");var sql=_4f.select("*");return _2a(sql,[1]).chain(function(res){var _50=_8a(res.rows).map(function(row){return _18.createFetchByGuidTransaction(row.guid);});return _5.sequence(_50,_a);}).chain(function(_51){var _52=_51.map(function(_53){var _54=new _8(function(_55,_56){return _4e.create(_53.$objectType,false,_56,_55);});return _54.map(function(_57){return [_53.guid,_57.guid];});});var _58=_8.parallel(_52).map(_87).chain(function(_59){var _5a=new _8(function(_5b,_5c){var _5d=_8c(_59,_51);_4e.save(_5d,null,_5c,_5b);});var _5e=_51.map(function(_5f){return new _8(function(_60,_61){_4e.commit(_59[_5f.guid],null,null,null,_61,_60);});});var _62=_8.parallel(_5e);return _8.sequence([_5a,_62]).chain(function(_63){return _8.of(_59);});});return new _a(function(tx){return _58;});});},createDirtyCleanupTransaction:function(){return _2a("SELECT DISTINCT tableName FROM _guidToTable WHERE dirty = 1").chain(function(res){var _64=_8a(res.rows).map(function(row){var _65=row.tableName;return _2a("DELETE FROM "+_27(_65)+" WHERE guid IN ("+"SELECT guid FROM _guidToTable WHERE tableName = ? AND dirty = 1)",[_65]);});return _6.sequence([_5.sequence(_64,_a),_2a("DELETE FROM _guidToTable WHERE dirty = 1")],_a);});}};return _18;function _66(_67,_68){if(_68==="guid"){return "String";}else{return _67.getAttributeType(_68);}};function _46(){return _4().into("_guidToTable").column("guid").column("tableName").column("dirty");};function _38(_69,_6a){return _6a.reduce(function(acc,_6b){var _6c=_69.getAttributeType(_6b.attribute);var _6d=_c[_6c];var _6e=_6b.value===""||_6b.value==null;var _6f=_15[_6c];var _70=_d[_6c];if(_6d==null||!_70){return acc;}var _71=_70(_6f(_6b.value));if(_6e&&_6d&&_6b.operator==="equals"){var _72=_6b.negate?acc.builder.whereNotNull:acc.builder.whereNull;return {constraintString:_72.call(acc.builder,_27(_6b.attribute)),args:acc.args};}else{if(_6e&&_6d&&_6b.operator==="contains"){return acc;}else{var _73=_6b.negate?acc.builder.whereNot:acc.builder.where;var _74=_6b.operator==="contains"?_75(_71):_71;return {builder:_73.call(acc.builder,_27(_6b.attribute),_6b.operator),args:acc.args.concat([_74])};}}},{builder:_2(),args:[]});};function _48(_76,obj){var _77=mx.meta.getEntity(_76);var _78=_77.getAttributes();var _79=_78.reduce(function(acc,_7a){var _7b=_77.getAttributeType(_7a);var _7c=_d[_7b];if(!_7c){return acc;}var _7d=_7c(obj[_7a]);return {attrs:acc.attrs.concat([_7a]),values:acc.values.concat([_7d])};},{attrs:["guid"],values:[obj.guid]});var _7e=_79.attrs.reduce(function(_7f,_80){return _7f.column(_27(_80));},_4().into(_27(_76)));return {builder:_7e,values:_79.values};};function _e(x){if(x===""){return "";}var _81=20;var _82=new _9(x);var _83=_81-Math.max(0,_82.e)-1;var _84=_82.s<0?"-":"";var _85=new Array(_83+1).join("0");var _86=_82.abs().toFixed();return _84+_85+_86;};function _f(x){if(x==null){return null;}else{return Number(x);}};function _11(d){if(d==null){return "";}else{return String(d);}};function _12(b){return String(!!b);};function _16(s){return s!=="false";};function _14(x){return x;};function _87(arr){var _88=arr.reduce(function(acc,_89){acc[_89[0]]=_89[1];return acc;},{});return _88;};function _8a(_8b){var arr=[];for(var i=0;i<_8b.length;++i){arr.push(_8b.item(i));}return arr;};function _8c(_8d,_8e){return _8e.reduce(function(_8f,_90){var _91=mx.meta.getEntity(_90.$objectType);var _92=_91.getAttributes();var _93=_8d[_90.guid];_8f[_93]=_92.reduce(function(_94,_95){var _96=_91.getAttributeType(_95);var _97=_10[_96];if(!_97){return _94;}if(_91.isReference(_95)){var _98=_90[_95];var _99=_8d[_98];if(_99){_94[_95]=_97(_99);}else{_94[_95]=_97(_98);}}else{_94[_95]=_97(_90[_95]);}return _94;},{});return _8f;},{});};function _75(s){var _9a=_1.LIKE_ESCAPE_CHAR;return s.replace(new RegExp(_9a,"g"),_9a+_9a).replace(/%/g,_9a+"%").replace(/_/g,_9a+"_");};function _27(key){return key.replace(".","$");};function _9b(_9c){return _9c.replace("$",".");};function _30(_9d,_9e,row){var _9f={guid:row.guid,$objectType:_9d.getEntity(),$readonlyAttrs:[]};for(var _a0 in row){var _a1=_9b(_a0);if(_a1==="guid"){continue;}var _a2=_9d.getAttributeType(_a1);var _a3=_13[_a2];if(!_a3){continue;}_9f[_a1]=_a3(row[_a0]);if(_9e){_9f.$readonlyAttrs.push(_a1);}}return _9f;};function _2a(sql,_a4){_a4=_a4||[];return new _a(function(tx){return new _8(function(_a5,_a6){tx.executeSql(sql,_a4,function(tx,res){_a6(res);},function(tx,e){_a5(e);});});});};});