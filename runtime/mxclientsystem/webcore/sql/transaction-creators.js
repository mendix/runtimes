/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/sql/transaction-creators",["./constants","./SelectBuilder","./Column","./InsertBuilder","./Transaction","../Task","big/big"],function(_1,_2,_3,_4,_5,_6,_7){var _8={"String":"text","Integer":"text","Long":"text","Decimal":"text","Float":"text","Currency":"text","Enum":"text","HashString":"text","ObjectReference":"text","DateTime":"integer","Boolean":"integer","AutoNumber":"integer","Binary":"blob"};var _9={"String":false,"Integer":false,"Long":false,"Decimal":false,"Float":false,"Currency":false,"Enum":false,"HashString":false,"ObjectReference":false,"DateTime":true,"Boolean":true,"AutoNumber":true,"Binary":false};var _a={"String":String,"Integer":_b,"Long":_b,"Decimal":_b,"Float":_b,"Currency":_b,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_c,"Boolean":Number,"AutoNumber":String,"Binary":String};var _d={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_e,"Boolean":_f,"AutoNumber":null,"Binary":String};var _10={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_11,"Boolean":Boolean,"AutoNumber":String,"Binary":String};var _12={"String":_11,"Integer":_11,"Long":_11,"Decimal":_11,"Float":_11,"Currency":_11,"Enum":_11,"HashString":_11,"ObjectReference":_11,"DateTime":Number,"Boolean":_13,"AutoNumber":_11,"Binary":_11};var _14={"String":"UPPER","Enum":"UPPER"};var _15={createCreateTransaction:function(_16){var _17=["CREATE TABLE IF NOT EXISTS _guidToTable (guid text primary key, tableName text, dirty boolean)"].concat(_16.map(_18)).map(function(_19){return _27(_19,[]);});return _28(_17,_5);function _18(_1a){var _1b=[{attr:"guid",type:"text",isPrimaryKey:true}].concat(_1c(_1a)).map(function(_1d){return [_24(_1d.attr),_1d.type,_1d.isPrimaryKey?"PRIMARY KEY":""].join(" ");}).join(", ");return "CREATE TABLE IF NOT EXISTS "+_24(_1a)+" ("+_1b+")";};function _1c(_1e){var _1f=mx.meta.getEntity(_1e);return _1f.getAttributes().map(function(_20){var _21=_1f.getAttributeType(_20);return {attr:_20,type:_8[_21]};});};},createDropAllTablesTransaction:function(_22){var _23=["_guidToTable"].concat(_22).map(_24).map(function(_25){return "DROP TABLE IF EXISTS '"+_25+"'";}).map(function(_26){return _27(_26,[]);});return _28(_23,_5);},createFetchByGuidTransaction:function(_29){var _2a=_2().from("_guidToTable").where("guid","equals").select("*");return _27(_2a,[_29]).chain(function(res){if(res.rows.length===0){return _5.rejected(new Error("guid not found"));}if(res.rows.length!==1){return _5.rejected(new Error("db consistency error"));}return _5.of(res.rows.item(0));}).chain(function(row){var _2b=row.tableName;var _2c=!row.dirty;var _2d=_2().from(_24(_2b)).where("guid","equals").select("*");return _27(_2d,[_29]).map(function(res){if(res.rows.length===0){return _6.rejected(new Error("entity not found"));}if(res.rows.length!==1){return _6.rejected(new Error("db consistency error"));}return _2e(window.mx.meta.getEntity(_2b),_2c,res.rows.item(0));});});},createFetchSliceTransaction:function(_2f,_30,_31,_32,_33){_30=_30||[];_33=_33||[];var _34=mx.meta.getEntity(_2f);var _35=_36(_34,_30);var _37=_35.builder.from(_24(_2f));var _38=_35.args;var _39=_33.reduce(function(acc,_3a){var _3b=_34.getAttributeType(_3a[0]);var _3c=_3(_3a[0]);var _3d=_14[_3b];if(_3d){_3c=_3c.apply1(_3d);}return acc.order(_3c,_3a[1]);},_37.offset(_31).limit(_32));var _3e=_27(_39.select("*"),_38).map(function(res){var _3f=[];for(var i=0;i<res.rows.length;++i){var _40=!/^GUID:/.test(res.rows.item(i).guid);_3f.push(_2e(_34,_40,res.rows.item(i)));}return _3f;});var _41=_27(_37.select("COUNT(*)","cnt"),_38).map(function(res){return res.rows.item(0).cnt;});return _a3(function(x,y){return [x,y];},_3e,_41);},createInsertOrReplaceTransaction:function(_42,obj){var _43=_44();var _45=_46(_42,obj);return _28([_27(_43.insertOrReplace(),[obj.guid,_42,1]),_27(_45.builder.insertOrReplace(),_45.values)],_5);},createFillBulkTransaction:function(_47,_48){var _49=_48.reduce(function(acc,obj){var _4a=_44();var _4b=_46(_47,obj);return acc.concat([_27(_4a.insert(),[obj.guid,_47,0]),_27(_4b.builder.insert(),_4b.values)]);},[]);return _28(_49,_5);},createUploadTransaction:function(_4c){var _4d=_2().from("_guidToTable").where("dirty","equals");var sql=_4d.select("*");return _27(sql,[1]).chain(function(res){var _4e=_89(res.rows).map(function(row){return _15.createFetchByGuidTransaction(row.guid);});return _28(_4e,_5);}).chain(function(_4f){var _50=_4f.map(function(_51){var _52=new _6(function(_53,_54){return _4c.create(_51.$objectType,false,_54,_53);});return _52.map(function(_55){return [_51.guid,_55.guid];});});var _56=_6.parallel(_50).map(_86).chain(function(_57){var _58=new _6(function(_59,_5a){var _5b=_8b(_57,_4f);_4c.save(_5b,null,_5a,_59);});var _5c=_4f.map(function(_5d){return new _6(function(_5e,_5f){_4c.commit(_57[_5d.guid],null,null,null,_5f,_5e);});});var _60=_6.parallel(_5c);return _6.sequence([_58,_60]).chain(function(_61){return _6.of(_57);});});return new _5(function(tx){return _56;});});},createDirtyCleanupTransaction:function(){return _27("SELECT DISTINCT tableName FROM _guidToTable WHERE dirty = 1").chain(function(res){var _62=_89(res.rows).map(function(row){var _63=row.tableName;return _27("DELETE FROM "+_24(_63)+" WHERE guid IN ("+"SELECT guid FROM _guidToTable WHERE tableName = ? AND dirty = 1)",[_63]);});return _64([_28(_62,_5),_27("DELETE FROM _guidToTable WHERE dirty = 1")],_5);});}};return _15;function _65(_66,_67){if(_67==="guid"){return "String";}else{return _66.getAttributeType(_67);}};function _44(){return _4().into("_guidToTable").column("guid").column("tableName").column("dirty");};function _36(_68,_69){return _69.reduce(function(acc,_6a){var _6b=_68.getAttributeType(_6a.attribute);var _6c=_9[_6b];var _6d=_6a.value===""||_6a.value==null;var _6e=_12[_6b];var _6f=_a[_6b];if(_6c==null||!_6f){return acc;}var _70=_6f(_6e(_6a.value));if(_6d&&_6c&&_6a.operator==="equals"){var _71=_6a.negate?acc.builder.whereNotNull:acc.builder.whereNull;return {constraintString:_71.call(acc.builder,_24(_6a.attribute)),args:acc.args};}else{if(_6d&&_6c&&_6a.operator==="contains"){return acc;}else{var _72=_6a.negate?acc.builder.whereNot:acc.builder.where;var _73=_6a.operator==="contains"?_74(_70):_70;return {builder:_72.call(acc.builder,_24(_6a.attribute),_6a.operator),args:acc.args.concat([_73])};}}},{builder:_2(),args:[]});};function _46(_75,obj){var _76=mx.meta.getEntity(_75);var _77=_76.getAttributes();var _78=_77.reduce(function(acc,_79){var _7a=_76.getAttributeType(_79);var _7b=_a[_7a];if(!_7b){return acc;}var _7c=_7b(obj[_79]);return {attrs:acc.attrs.concat([_79]),values:acc.values.concat([_7c])};},{attrs:["guid"],values:[obj.guid]});var _7d=_78.attrs.reduce(function(_7e,_7f){return _7e.column(_24(_7f));},_4().into(_24(_75)));return {builder:_7d,values:_78.values};};function _b(x){if(x===""){return "";}var _80=20;var _81=new _7(x);var _82=_80-Math.max(0,_81.e)-1;var _83=_81.s<0?"-":"";var _84=new Array(_82+1).join("0");var _85=_81.abs().toFixed();return _83+_84+_85;};function _c(x){if(x==null){return null;}else{return Number(x);}};function _e(d){if(d==null){return "";}else{return String(d);}};function _f(b){return String(!!b);};function _13(s){return s!=="false";};function _11(x){return x;};function _86(arr){var _87=arr.reduce(function(acc,_88){acc[_88[0]]=_88[1];return acc;},{});return _87;};function _89(_8a){var arr=[];for(var i=0;i<_8a.length;++i){arr.push(_8a.item(i));}return arr;};function _8b(_8c,_8d){return _8d.reduce(function(_8e,_8f){var _90=mx.meta.getEntity(_8f.$objectType);var _91=_90.getAttributes();var _92=_8c[_8f.guid];_8e[_92]=_91.reduce(function(_93,_94){var _95=_90.getAttributeType(_94);var _96=_d[_95];if(!_96){return _93;}if(_90.isReference(_94)){var _97=_8f[_94];var _98=_8c[_97];if(_98){_93[_94]=_96(_98);}else{_93[_94]=_96(_97);}}else{_93[_94]=_96(_8f[_94]);}return _93;},{});return _8e;},{});};function _74(s){var _99=_1.LIKE_ESCAPE_CHAR;return s.replace(new RegExp(_99,"g"),_99+_99).replace(/%/g,_99+"%").replace(/_/g,_99+"_");};function _24(key){return key.replace(".","$");};function _9a(_9b){return _9b.replace("$",".");};function _2e(_9c,_9d,row){var _9e={guid:row.guid,$objectType:_9c.getEntity(),$readonlyAttrs:[]};for(var _9f in row){var _a0=_9a(_9f);if(_a0==="guid"){continue;}var _a1=_9c.getAttributeType(_a0);var _a2=_10[_a1];if(!_a2){continue;}_9e[_a0]=_a2(row[_9f]);if(_9d){_9e.$readonlyAttrs.push(_a0);}}return _9e;};function _a3(f,Ax,Ay){return Ax.map(function(x){return function(y){return f(x,y);};}).ap(Ay);};function _a4(f,Mx,My){return Mx.chain(function(x){return My.map(function(y){return f(x,y);});});};function _28(ms,M){return ms.reduce(function(acc,mx){return _a3(_a5,acc,mx);},M.of([]));};function _64(ms,M){return ms.reduce(function(acc,mx){return _a4(_a5,acc,mx);},M.of([]));};function _a5(xs,x){return xs.concat([x]);};function _27(sql,_a6){_a6=_a6||[];return new _5(function(tx){return new _6(function(_a7,_a8){tx.executeSql(sql,_a6,function(tx,res){_a8(res);},function(tx,e){_a7(e);});});});};});