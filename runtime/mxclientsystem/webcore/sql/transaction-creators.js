/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/sql/transaction-creators",["./constants","./SelectBuilder","./Column","./InsertBuilder","../applicative","../monad","../TaskReader","../Task","big/big"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var _a=_7;var _b={"String":"text","Integer":"text","Long":"text","Decimal":"text","Float":"text","Currency":"text","Enum":"text","HashString":"text","ObjectReference":"text","DateTime":"integer","Boolean":"integer","AutoNumber":"integer","Binary":"blob"};var _c={"String":false,"Integer":false,"Long":false,"Decimal":false,"Float":false,"Currency":false,"Enum":false,"HashString":false,"ObjectReference":false,"DateTime":true,"Boolean":true,"AutoNumber":true,"Binary":false};var _d={"String":String,"Integer":_e,"Long":_e,"Decimal":_e,"Float":_e,"Currency":_e,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_f,"Boolean":Number,"AutoNumber":String,"Binary":String};var _10={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_11,"Boolean":Boolean,"AutoNumber":String,"Binary":String};var _12={"String":_11,"Integer":_11,"Long":_11,"Decimal":_11,"Float":_11,"Currency":_11,"Enum":_11,"HashString":_11,"ObjectReference":_11,"DateTime":Number,"Boolean":_13,"AutoNumber":_11,"Binary":_11};var _14={"String":"UPPER","Enum":"UPPER"};var _15={createCreateTransaction:function(_16){var _17=["CREATE TABLE IF NOT EXISTS _guidToTable (guid text primary key, tableName text, dirty boolean)"].concat(_16.map(_18)).map(function(_19){return _27(_19,[]);});return _5.sequence(_17,_a);function _18(_1a){var _1b=[{attr:"guid",type:"text",isPrimaryKey:true}].concat(_1c(_1a)).map(function(_1d){return [_24(_1d.attr),_1d.type,_1d.isPrimaryKey?"PRIMARY KEY":""].join(" ");}).join(", ");return "CREATE TABLE IF NOT EXISTS "+_24(_1a)+" ("+_1b+")";};function _1c(_1e){var _1f=mx.meta.getEntity(_1e);return _1f.getAttributes().map(function(_20){var _21=_1f.getAttributeType(_20);return {attr:_20,type:_b[_21]};});};},createDropAllTablesTransaction:function(_22){var _23=["_guidToTable"].concat(_22).map(_24).map(function(_25){return "DROP TABLE IF EXISTS '"+_25+"'";}).map(function(_26){return _27(_26,[]);});return _5.sequence(_23,_a);},createFetchByGuidTransaction:function(_28){var _29=_2().from("_guidToTable").where("guid","equals").select("*");return _27(_29,[_28]).chain(function(res){if(res.rows.length===0){return _a.rejected(new Error("guid not found"));}if(res.rows.length!==1){return _a.rejected(new Error("db consistency error"));}return _a.of(res.rows.item(0));}).chain(function(row){var _2a=row.tableName;var _2b=!row.dirty;var _2c=_2().from(_24(_2a)).where("guid","equals").select("*");return _27(_2c,[_28]).map(function(res){if(res.rows.length===0){return _8.rejected(new Error("entity not found"));}if(res.rows.length!==1){return _8.rejected(new Error("db consistency error"));}return _2d(window.mx.meta.getEntity(_2a),_2b,res.rows.item(0));});});},createFetchSliceTransaction:function(_2e,_2f,_30,_31,_32){_2f=_2f||[];_32=_32||[];var _33=mx.meta.getEntity(_2e);var _34=_35(_33,_2f);var _36=_34.builder.from(_24(_2e));var _37=_34.args;var _38=_32.reduce(function(acc,_39){var _3a=_33.getAttributeType(_39[0]);var _3b=_3(_39[0]);var _3c=_14[_3a];if(_3c){_3b=_3b.apply1(_3c);}return acc.order(_3b,_39[1]);},_36.offset(_30).limit(_31));var _3d=_27(_38.select("*"),_37).map(function(res){var _3e=[];for(var i=0;i<res.rows.length;++i){var _3f=!/^GUID:/.test(res.rows.item(i).guid);_3e.push(_2d(_33,_3f,res.rows.item(i)));}return _3e;});var _40=_27(_36.select("COUNT(*)","cnt"),_37).map(function(res){return res.rows.item(0).cnt;});return _5.lift2(function(x,y){return [x,y];},_3d,_40);},createInsertOrReplaceTransaction:function(_41,obj){var _42=_43();var _44=_45(_41,obj);return _5.sequence([_27(_42.insertOrReplace(),[obj.guid,_41,1]),_27(_44.builder.insertOrReplace(),_44.values)],_a);},createFillBulkTransaction:function(_46,_47){var _48=_47.reduce(function(acc,obj){var _49=_43();var _4a=_45(_46,obj);return acc.concat([_27(_49.insert(),[obj.guid,_46,0]),_27(_4a.builder.insert(),_4a.values)]);},[]);return _5.sequence(_48,_a);},createUploadTransaction:function(_4b){var _4c=_2().from("_guidToTable").where("dirty","equals");var sql=_4c.select("*");return _27(sql,[1]).chain(function(res){var _4d=_71(res.rows).map(function(row){return _15.createFetchByGuidTransaction(row.guid);});return _5.sequence(_4d,_a);});},createDirtyCleanupTransaction:function(){return _27("SELECT DISTINCT tableName FROM _guidToTable WHERE dirty = 1").chain(function(res){var _4e=_71(res.rows).map(function(row){var _4f=row.tableName;return _27("DELETE FROM "+_24(_4f)+" WHERE guid IN ("+"SELECT guid FROM _guidToTable WHERE tableName = ? AND dirty = 1)",[_4f]);});return _6.sequence([_5.sequence(_4e,_a),_27("DELETE FROM _guidToTable WHERE dirty = 1")],_a);});}};return _15;function _50(_51,_52){if(_52==="guid"){return "String";}else{return _51.getAttributeType(_52);}};function _43(){return _4().into("_guidToTable").column("guid").column("tableName").column("dirty");};function _35(_53,_54){return _54.reduce(function(acc,_55){var _56=_53.getAttributeType(_55.attribute);var _57=_c[_56];var _58=_55.value===""||_55.value==null;var _59=_12[_56];var _5a=_d[_56];if(_57==null||!_5a){return acc;}var _5b=_5a(_59(_55.value));if(_58&&_57&&_55.operator==="equals"){var _5c=_55.negate?acc.builder.whereNotNull:acc.builder.whereNull;return {constraintString:_5c.call(acc.builder,_24(_55.attribute)),args:acc.args};}else{if(_58&&_57&&_55.operator==="contains"){return acc;}else{var _5d=_55.negate?acc.builder.whereNot:acc.builder.where;var _5e=_55.operator==="contains"?_5f(_5b):_5b;return {builder:_5d.call(acc.builder,_24(_55.attribute),_55.operator),args:acc.args.concat([_5e])};}}},{builder:_2(),args:[]});};function _45(_60,obj){var _61=mx.meta.getEntity(_60);var _62=_61.getAttributes();var _63=_62.reduce(function(acc,_64){var _65=_61.getAttributeType(_64);var _66=_d[_65];if(!_66){return acc;}var _67=_66(obj[_64]);return {attrs:acc.attrs.concat([_64]),values:acc.values.concat([_67])};},{attrs:["guid"],values:[obj.guid]});var _68=_63.attrs.reduce(function(_69,_6a){return _69.column(_24(_6a));},_4().into(_24(_60)));return {builder:_68,values:_63.values};};function _e(x){if(x===""){return "";}var _6b=20;var _6c=new _9(x);var _6d=_6b-Math.max(0,_6c.e)-1;var _6e=_6c.s<0?"-":"";var _6f=new Array(_6d+1).join("0");var _70=_6c.abs().toFixed();return _6e+_6f+_70;};function _f(x){if(x==null){return null;}else{return Number(x);}};function _13(s){return s!=="false";};function _11(x){return x;};function _71(_72){var arr=[];for(var i=0;i<_72.length;++i){arr.push(_72.item(i));}return arr;};function _5f(s){var _73=_1.LIKE_ESCAPE_CHAR;return s.replace(new RegExp(_73,"g"),_73+_73).replace(/%/g,_73+"%").replace(/_/g,_73+"_");};function _24(key){return key.replace(".","$");};function _74(_75){return _75.replace("$",".");};function _2d(_76,_77,row){var _78={guid:row.guid,$objectType:_76.getEntity(),$readonlyAttrs:[]};for(var _79 in row){var _7a=_74(_79);if(_7a==="guid"){continue;}var _7b=_76.getAttributeType(_7a);var _7c=_10[_7b];if(!_7c){continue;}_78[_7a]=_7c(row[_79]);if(_77){_78.$readonlyAttrs.push(_7a);}}return _78;};function _27(sql,_7d){_7d=_7d||[];return new _a(function(tx){return new _8(function(_7e,_7f){tx.executeSql(sql,_7d,function(tx,res){_7f(res);},function(tx,e){_7e(e);});});});};});