/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/file-transfer",["bluebird/bluebird","./applicative","./monad","./Task"],function(_1,_2,_3,_4){var _5={};var _6=[];_5.downloadFile=function(_7,_8,_9,_a){var _b=_8.path.split("/");var _c=_b.pop();var _d=_e(_7,{"X-Csrf-Token":window.mx.session.getCSRFToken()},{responseType:"blob"});_f(_8.location).then(function(fs){var _10=_1a(fs.root,_b);_2.sequence([_d,_10],_4).chain(function(res){var _11=res[0];var de=res[1];return _12(de,_c,_11);}).fork(_a,_9);});};return _5;function _f(_13){if(!_6[_13]){_6[_13]=new _1(function(_14,_15){window.webkitRequestFileSystem(_13,1024*1024,_14,_15);});}return _6[_13];};function _e(url,_16,_17){return new _4(function(_18,_19){var xhr=new XMLHttpRequest();xhr.open("GET",url);Object.keys(_17).forEach(function(key){xhr[key]=_17[key];});Object.keys(_16).forEach(function(key){xhr.setRequestHeader(key,_16[key]);});xhr.onreadystatechange=function(e){var xhr=e.target;if(xhr.readyState===4){if(xhr.status>=200&&xhr.status<300){_19(xhr.response);}else{_18(xhr.response);}}};xhr.onerror=_18;xhr.send();});};function _1a(re,_1b){var _1c=_1b.map(function(pc){return function(de){return new _4(function(_1d,_1e){de.getDirectory(pc,{create:true},function(nde){_1e(nde);},_1d);});};});return _1c.reduce(function(acc,fmx){return acc.chain(function(de){return fmx(de);});},_4.of(re));};function _12(de,_1f,_20){return new _4(function(_21,_22){de.getFile(_1f,{create:true},function(fe){fe.createWriter(function(fw){fw.onwriteend=function(e){_22(e.target);};fw.onerror=_21;fw.write(_20);});});});};});