/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/offline",["mendix/lib/MxObject","./IndexedDatabase","./IndexedDbOffline","./SynchronousPromise","bluebird/bluebird"],function(_1,_2,_3,_4,_5){var _6={getSlice:function(_7,_8){return _9(_a().then(_3.fetchSlice(_7,_8)).spread(function(_b,_c){var _d=_b.map(function(_e){return _f(_7,_e);});return [_d,_c];}));},getSliceReference:function(_10,_11,_12,_13){return _9(_a().then(_3.fetchSliceReference(_10,_11,_12,_13)).spread(function(_14,_15){var _16=_14.map(function(obj){return _f(_10,obj);});return [_16,_15];}));},getByGuid:function(_17){return _9(_a().then(_3.fetch(_17)).spread(function(obj,_18){return _f(_18,obj);}));},updateLocalDatabase:function(_19){function _1a(){return _19.map(function(fd){return _2a(fd.xpath).then(function(_1b){return _1e(fd.store,_1b).then(function(){return _1b.map(function(obj){return new _1({json:obj,meta:window.mx.meta.getEntity(obj.objectType)});});});});});};return _9(_1d().then(function(){return _5.all(_1a());}).then(_1c));}};return _6;function _a(){return _3.getDatabase(window.mx.session.getConfig("sync_config.schema"));};function _1d(){return _3.deleteDatabase();};function _1e(_1f,_20){return new _5(function(_21,_22){_a().then(_3.fillBulk(_1f,_20.map(_23))).then(_21,_22);});};function _23(_24){var _25={guid:_24.guid};var _26=_3.serialize(_24.attributes);for(var key in _26){_25[key]=_26[key].value;}return _25;};function _f(_27,obj){var _28={guid:obj.guid,objectType:_27,attributes:{}};var _29=_3.deserialize(obj);for(var key in _29){if(key!="guid"){_28.attributes[key]={value:_29[key]};}}return new _1({json:_28,meta:window.mx.meta.getEntity(_27)});};function _2a(_2b){return new _5(function(_2c,_2d){window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_2b,schema:{}}},options:{callback:function(_2e,_2f){_2c(_2f.mxobjects||[]);},error:_2d}});});};function _9(_30){return new _5(function(_31,_32){return _30.then(_31,_32);});};function _1c(a){return [].concat.apply([],a);};});