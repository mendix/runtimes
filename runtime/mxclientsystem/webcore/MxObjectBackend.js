/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/MxObjectBackend",["mendix/ov","mendix/lang","mendix/lib/MxObject","mendix/lib/Error","dojo/_base/array","dojo/_base/lang","big/big"],function(ov,_1,_2,_3,_4,_5,_6){function _7(_8,_9,_a){this._backend=_8;this._objectCache=_9;this._shouldRemoveObjectImmediately=_a;this._objErrorQueue={};this._objSaveQueue={};};_7.prototype.getByGuid=function(_b,_c,_d,_e,_f){var _10=this;if(_d){var _11=_4.filter(_4.map(_b,this._objectCache.getObject,this._objectCache),function(_12){return _12!=null;});var _13=_4.every(_b,function(_14){return _10._objectCache.has(_14)||_10._objectCache.isBlacklisted(_14);});if(_13){var _15=_11;if(_c.sort){_4.forEach(_c.sort,function(_16){var _17=_16[0],dir=_16[1];_15=_15.sort(dir=="asc"?function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _18=_c.offset;if(_18){var _19=_c.amount;if(_19){_15=_15.slice(_18,_18+_19);}else{_15=_15.slice(_18);}}_4.forEach(_15,this._objectCache.reference,this._objectCache);if(_e){_e(_15,_11.length);}return;}}var _1a=_c.attributes==null;this._backend.getByGuid(_b,_c,function(_1b){var _1c=_4.map(_1b,function(obj){return _10._setMxObject(true,_1a,true,obj);});if(_e){_e(_1c,_1c.length);}},_f);};_7.prototype.getByXPath=function(_1d,_1e,_1f,_20,_21,_22){var _23=this;this._backend.getByXPath(_1d,_1e,_1f,_20,function(_24,_25,_26){var _27=_4.map(_24,function(obj){return _23._setMxObject(true,false,false,obj);});var _28=_4.map(_26,function(agg){return agg===""?agg:new _6(agg);});if(_21){_21(_27,_25,_28);}},_22);};_7.prototype.getByPath=function(_29,_2a,_2b,_2c){var _2d=this;this._backend.getByPath(_29,_2a,_2e,_2c);function _2e(_2f){var _30=_4.map(_2f,function(obj){return _2d._setMxObject(true,true,true,obj);});if(_2b){_2b(_30,_30.length);}};};_7.prototype.getSlice=function(_31,_32,_33){var _34=window.mx.meta.getEntity(_31);return this._backend.getSlice(_31,_32,_33).spread(function(_35,_36){var _37=_35.map(function(_38){return new _2({json:_38,meta:_34});});return [_37,_36];});};_7.prototype.fetch=function(obj,_39,_3a,_3b,_3c,_3d){var _3e=this;var _3f=obj;var _40=false;var _41;if(_3b.schema){_41=_39.splice(-2,_39.length);}else{_41=[];}var _42=function(_43,ref){if(_43.isObjectReference(ref)){return _43.getReference(ref);}else{if(_43.isObjectReferenceSet(ref)){return _43.getReferences(ref);}else{return _43.get2(ref);}}};var _44=function(){if(_3f==null){_3c(null,false);}else{if(!_3a){_3c(_3f,_40);}else{if(_3a){_3c(_42(_3f,_3a),false);}}}};var _45=function(ref){if(_3f.getReferences(ref).length===0){_3c([],false);}else{if(_3f.hasChildren(ref)){_3c(_3f.getChildren(ref),false);}else{window.mx.data.get({guids:_3f.getReferences(ref),filter:{id:_3b.schema},callback:function(_46){_3c(_46,true);},error:_3d});}}};var _47=function(ref,_48){var _49=_3f.getReference(ref);if(_49){window.mx.data.get({guid:_49,filter:{id:_48},callback:function(obj){if(obj){_3f=obj;_40=true;_4a();}else{_3c(null,false);}},error:_3d});}else{_3c(null,false);}};var _4b=function(_4c){var _4d,_4e;if(_4c.length<3){return false;}_4d=window.mx.meta.getEntity(_4c.slice(-3)[0]),_4e=_39.slice(-2)[0];return _4d.isObjectReferenceSet(_4e);};var _4f=function(_50,_51){var _52=["//"+_51+"[id="+_50+"]"],_53=_4b([_51].concat(_39));Array.prototype.push.apply(_52,_39);_39=[];window.mx.data.get({xpath:_52.join("/"),callback:function(_54){if(_54.length===0){_3c(null,false);}else{if(_3a&&_54.length==1){_3f=_54[0];_44();}else{if(!_3a){if(_53){_3c(_54,false);}else{_3f=_54[0];_4a();}}else{if(_3d){_3d(new _3(_3a+" is not a reference type"));}}}}},error:_3d});};var _4a=function(){var ref,_55,_56,_57;if(_39.length+_41.length===0){_44();}else{if(_39.length===0&&_41.length>0){ref=_41.shift();_55=_41.shift();if(_3f.isObjectReferenceSet(ref)){_45(ref);}else{_47(ref,_3b.schema);}}else{if(_40){window.mx.data.release(_3f);_40=false;}ref=_39.shift();_55=_39.shift();if(_3f.isObjectReferenceSet(ref)){if(_39.length>0||_41>0){if(_3d){_3d(new _3("reference set should be at end of path"));}}else{_45(ref);}}else{if(_3f.isObjectReference(ref)){_56=_3f.getChild(ref);if(_56){_3f=_56;_4a();}else{_57=_3f.getReference(ref);if(!_57){_3c(null,false);}else{if(_3e._objectCache.has(_57)){_3f=_3e._objectCache.getObject(_57);_3e._objectCache.reference(_57);_40=true;_4a();}else{if(_3b.usexpath&&_39.length>0){_4f(_57,_55);}else{_47(ref);}}}}}else{if(_3d){_3d(new _3("attribute "+ref+" is not a reference type"));}}}}}};_4a();};_7.prototype.action=function(_58,_59,_5a,_5b,_5c,_5d,_5e){var _5f=this;this._backend.action(_58,_59,_5a,_5b,_5c,_60,_5e);function _60(_61,_62){var _63;if(_61 instanceof Array){_63=_4.map(_61,function(obj){return _5f._setMxObject(false,true,true,obj);});}else{if(typeof _61=="object"&&_61.guid){_63=[_5f._setMxObject(false,true,true,_61)];}else{_63=_61;}}if(_63 instanceof Array){_4.forEach(_63,function(_64){delete _5f._objErrorQueue[_64.getGuid()];});}if(_5d){_5d(_63,_62);}};};_7.prototype.create=function(_65,_66,_67,_68){var _69=this;this._backend.create(_65,_66,_6a,_68);function _6a(_6b){var _6c=_69._setMxObject(true,true,true,_6b);if(_67){_67(_6c);}};};_7.prototype.save=function(_6d,_6e,_6f,_70,_71){var _72=this;if(_6d){var _73=this._objErrorQueue[_6d.getGuid()];if(_73){if(_71){_71(_73);}return;}else{if(!_6d.hasChanges()){if(_70){_70();}return;}}}var _74={};var _75;if(!_6e){var _76=false;_75=this._objSaveQueue;this._objSaveQueue={};for(var _77 in _75){var _78=_75[_77];if(_78.hasChanges()){_74[_77]=_78._collectChanges();_76=true;}delete this._objErrorQueue[_77];}if(!_76){if(_70){_70();}return;}}if(_6d&&!_75[_6d.getGuid()]){_74[_6d.getGuid()]=_6d._collectChanges();_75={guid:_6d};delete this._objSaveQueue[_6d.getGuid()];delete this._objErrorQueue[_6d.getGuid()];}this._backend.save(_74,_6f,_79,_7a);function _79(){for(var _7b in _75){_75[_7b]._applyChangeSet();}if(_70){_70();}};function _7a(e){var _7c=e.original||{};var _7d=false;if(ov.hasValidations(_7c)){_4.forEach(ov.getValidations(_7c),function(_7e){var _7f=_7e.getGuid();if(_75[_7f]){_72._objErrorQueue[_7f]=_7e;delete _75[_7f];}_7d=!!_6d&&_7f==_6d.getGuid();});for(var id in _75){_75[id]._applyChangeSet();}}else{_5.mixin(_72._objSaveQueue,_75);_7d=true;}if(_6d&&_7d){if(_71){_71(e);}}else{if(_70){_70();}}};};_7.prototype.commit=function(_80,_81,_82,_83,_84,_85){var _86=this;this._backend.commit(_80,_81,_82,_83,_87,_85);function _87(){delete _86._objErrorQueue[_80];delete _86._objSaveQueue[_80];if(_84){_84();}};};_7.prototype.rollback=function(_88,_89,_8a){var _8b=this;var _8c=_88.getGuid();delete this._objErrorQueue[_8c];delete this._objSaveQueue[_8c];this._backend.rollback(_8c,_8d,_8a);function _8d(_8e){var _8f;if(_8e){_8f=_8b._setMxObject(true,false,false,_8e);}_8b._rollbackCache(_88,_8f);if(_89){_89(_8f);}};};_7.prototype.remove=function(_90,_91,_92){var _93=this;this._backend.remove(_90,_94,_92);function _94(){_4.forEach(_90,_93._clearDataForObject,_93);if(_91){_91();}};};_7.prototype.makeChange=function(_95,_96,_97){var _98=_95.getGuid();this._objSaveQueue[_98]=_95;delete this._objErrorQueue[_98];var _99=this._objectCache.getObject(_98);if(_99){_99.setWithoutEvent(_96,_97);}};_7.prototype.flush=function(_9a){if(_1.itemCount(this._objSaveQueue)===0){if(_9a){_9a();}}else{this.save(null,false,null,_9a);}};_7.prototype.setOrRetrieveMxObject=function(_9b){delete this._objErrorQueue[_9b.guid];return this._setMxObject(false,true,false,_9b);};_7.prototype.cleanup=function(){var _9c=this;var _9d=this._objectCache.filter(function(_9e){return !_9c._objectCache.isBlacklisted(_9e)&&!_9c._objectCache.isReferenced(_9e);});_4.forEach(_9d,this._clearDataForObject,this);};_7.prototype.invalidateCaches=function(_9f){if(this._objectCache.has(_9f)){this._clearDataForObject(_9f);}};_7.prototype._setMxObject=function(_a0,_a1,_a2,_a3){var _a4=this._objectCache.getObject(_a3.guid);if(_a1&&_a4){if(!_a0||!_a4.hasChanges()){this._objectCache.reset(_a3);}if(_a2){this._objectCache.reference(_a3.guid);}return _a4;}else{var obj=new _2({json:_a3,meta:window.mx.meta.getEntity(_a3.objectType)});if(_a1&&!_a4){this._objectCache.add(obj);if(_a2){this._objectCache.reference(_a3.guid);}}else{if(!_a1&&_a4){this._clearDataForObject(_a3.guid);}}return obj;}};_7.prototype._clearDataForObject=function(_a5){if(!this._shouldRemoveObjectImmediately||this._shouldRemoveObjectImmediately(_a5)){delete this._objErrorQueue[_a5];this._objectCache.removeObject(_a5);this._backend.release(_a5);}};_7.prototype.release=function(_a6){if(this._objectCache.has(_a6)&&this._objectCache.isReferenced(_a6)){this._objectCache.unreference(_a6);if(!this._objectCache.isReferenced(_a6)){this._clearDataForObject(_a6);}}};_7.prototype._rollbackCache=function(_a7,_a8){var _a9=_a7.getGuid();var _aa=this._objectCache.getObject(_a9);if(_a8){if(_aa){if(_a7!==_aa){this._objectCache.reset(_a8.jsonData);}}else{this._objectCache.add(_a8);}}else{this._objectCache.blacklist(_a9);}};return _7;});