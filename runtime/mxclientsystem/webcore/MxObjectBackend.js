/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/MxObjectBackend",["mendix/ov","mendix/lang","mendix/lib/MxObject","mendix/lib/Error","dojo/_base/array","dojo/_base/lang","big/big"],function(ov,_1,_2,_3,_4,_5,_6){function _7(_8,_9,_a){this._backend=_8;this._objectCache=_9;this._shouldRemoveObjectImmediately=_a;this._objErrorQueue={};this._objSaveQueue={};};_7.prototype.getByGuid=function(_b,_c,_d,_e,_f){var _10=this;if(_d){var _11=_4.filter(_4.map(_b,this._objectCache.getObject,this._objectCache),function(_12){return _12!=null;});var _13=_4.every(_b,function(_14){return _10._objectCache.has(_14)||_10._objectCache.isBlacklisted(_14);});if(_13){var _15=_11;if(_c.sort){_4.forEach(_c.sort,function(_16){var _17=_16[0],dir=_16[1];_15=_15.sort(dir=="asc"?function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _18=_c.offset;if(_18){var _19=_c.amount;if(_19){_15=_15.slice(_18,_18+_19);}else{_15=_15.slice(_18);}}_4.forEach(_15,this._objectCache.reference,this._objectCache);if(_e){_e(_15,_11.length);}return;}}var _1a=_c.attributes==null;this._backend.getByGuid(_b,_c,function(_1b){var _1c=_4.map(_1b,function(obj){return _10._setMxObject(true,_1a,true,obj);});if(_e){_e(_1c,_1c.length);}},_f);};_7.prototype.getByXPath=function(_1d,_1e,_1f,_20,_21,_22){var _23=this;this._backend.getByXPath(_1d,_1e,_1f,_20,function(_24,_25,_26){var _27=_4.map(_24,function(obj){return _23._setMxObject(true,false,false,obj);});var _28=_4.map(_26,function(agg){return agg===""?agg:new _6(agg);});if(_21){_21(_27,_25,_28);}},_22);};_7.prototype.getByPath=function(_29,_2a,_2b,_2c){var _2d=this;this._backend.getByPath(_29,_2a,_2e,_2c);function _2e(_2f){var _30=_4.map(_2f,function(obj){return _2d._setMxObject(true,true,true,obj);});if(_2b){_2b(_30,_30.length);}};};_7.prototype.getSlice=function(_31,_32,_33){var _34=window.mx.meta.getEntity(_31);return this._backend.getSlice(_31,_32,_33).spread(function(_35,_36){var _37=_35.map(function(_38){return new _2({json:_38,meta:_34});});return [_37,_36];});};_7.prototype.fetch=function(obj,_39,_3a,_3b,_3c,_3d){var _3e=this;var _3f=obj;var _40=false;var _41;if(_3b.schema){_41=_39.splice(-2,_39.length);}else{_41=[];}var _42=function(_43,ref){if(_43.isObjectReference(ref)){return _43.getReference(ref);}else{if(_43.isObjectReferenceSet(ref)){return _43.getReferences(ref);}else{return _43.get2(ref);}}};var _44=function(){if(_3f==null){_3c(null,false);}else{if(!_3a){_3c(_3f,_40);}else{if(_3a){_3c(_42(_3f,_3a),false);}}}};var _45=function(ref){if(_3f.getReferences(ref).length===0){_3c([],false);}else{if(_3f.hasChildren(ref)){_3c(_3f.getChildren(ref),false);}else{window.mx.data.get({guids:_3f.getReferences(ref),filter:{id:_3b.schema},callback:function(_46){_3c(_46,true);},error:_3d});}}};var _47=function(ref,_48){var _49=_3f.getReference(ref);if(_49){window.mx.data.get({guid:_49,filter:{id:_48},callback:function(obj){if(obj){_3f=obj;_40=true;_4a();}else{_3c(null,false);}},error:_3d});}else{_3c(null,false);}};var _4b=function(_4c){var _4d,_4e;if(_4c.length<3){return false;}_4d=window.mx.meta.getEntity(_4c.slice(-3)[0]),_4e=_39.slice(-2)[0];return _4d.isObjectReferenceSet(_4e);};var _4f=function(_50,_51){var _52=["//"+_51+"[id="+_50+"]"],_53=_4b([_51].concat(_39));Array.prototype.push.apply(_52,_39);_39=[];window.mx.data.get({xpath:_52.join("/"),callback:function(_54){if(_54.length===0){_3c(null,false);}else{if(_3a&&_54.length==1){_3f=_54[0];_44();}else{if(!_3a){if(_53){_3c(_54,false);}else{_3f=_54[0];_4a();}}else{if(_3d){_3d(new _3(_3a+" is not a reference type"));}}}}},error:_3d});};var _4a=function(){var ref,_55,_56,_57;if(_39.length+_41.length===0){_44();}else{if(_39.length===0&&_41.length>0){ref=_41.shift();_55=_41.shift();if(_3f.isObjectReferenceSet(ref)){_45(ref);}else{_47(ref,_3b.schema);}}else{if(_40){window.mx.data.release(_3f);_40=false;}ref=_39.shift();_55=_39.shift();if(_3f.isObjectReferenceSet(ref)){if(_39.length>0||_41>0){if(_3d){_3d(new _3("reference set should be at end of path"));}}else{_45(ref);}}else{if(_3f.isObjectReference(ref)){_56=_3f.getChild(ref);if(_56){_3f=_56;_4a();}else{_57=_3f.getReference(ref);if(!_57){_3c(null,false);}else{if(_3e._objectCache.has(_57)){_3f=_3e._objectCache.getObject(_57);_3e._objectCache.reference(_57);_40=true;_4a();}else{if(_3b.usexpath&&_39.length>0){_4f(_57,_55);}else{_47(ref);}}}}}else{if(_3d){_3d(new _3("attribute "+ref+" is not a reference type"));}}}}}};_4a();};_7.prototype.action=function(_58,_59,_5a,_5b,_5c,_5d,_5e){var _5f=this;this._backend.action(_58,_59,_5a,_5b,_5c,_60,_5e);function _60(_61,_62){var _63;if(_61 instanceof Array){_63=_4.map(_61,function(obj){return _5f._setMxObject(false,true,true,obj);});}else{if(typeof _61=="object"&&_61.guid){_63=[_5f._setMxObject(false,true,true,_61)];}else{_63=_61;}}if(_63 instanceof Array){_4.forEach(_63,function(_64){delete _5f._objErrorQueue[_64.getGuid()];});}if(_5d){_5d(_63,_62);}};};_7.prototype.upload=function(_65){return this._backend.upload(_65);};_7.prototype.cleanupDirtyObjects=function(){return this._backend.cleanupDirtyObjects();};_7.prototype.download=function(){return this._backend.download();};_7.prototype.create=function(_66,_67,_68,_69){var _6a=this;this._backend.create(_66,_67,_6b,_69);function _6b(_6c){var _6d=_6a._setMxObject(true,true,true,_6c);if(_68){_68(_6d);}};};_7.prototype.save=function(_6e,_6f,_70,_71,_72){var _73=this;if(_6e){var _74=this._objErrorQueue[_6e.getGuid()];if(_74){if(_72){_72(_74);}return;}else{if(!_6e.hasChanges()){if(_71){_71();}return;}}}var _75={};var _76;if(!_6f){var _77=false;_76=this._objSaveQueue;this._objSaveQueue={};for(var _78 in _76){var _79=_76[_78];if(_79.hasChanges()){_75[_78]=_79._collectChanges();_77=true;}delete this._objErrorQueue[_78];}if(!_77){if(_71){_71();}return;}}if(_6e&&!_76[_6e.getGuid()]){_75[_6e.getGuid()]=_6e._collectChanges();_76={guid:_6e};delete this._objSaveQueue[_6e.getGuid()];delete this._objErrorQueue[_6e.getGuid()];}this._backend.save(_75,_70,_7a,_7b);function _7a(){for(var _7c in _76){_76[_7c]._applyChangeSet();}if(_71){_71();}};function _7b(e){var _7d=e.original||{};var _7e=false;if(ov.hasValidations(_7d)){_4.forEach(ov.getValidations(_7d),function(_7f){var _80=_7f.getGuid();if(_76[_80]){_73._objErrorQueue[_80]=_7f;delete _76[_80];}_7e=!!_6e&&_80==_6e.getGuid();});for(var id in _76){_76[id]._applyChangeSet();}}else{_5.mixin(_73._objSaveQueue,_76);_7e=true;}if(_6e&&_7e){if(_72){_72(e);}}else{if(_71){_71();}}};};_7.prototype.commit=function(_81,_82,_83,_84,_85,_86){var _87=this;this._backend.commit(_81,_82,_83,_84,_88,_86);function _88(){delete _87._objErrorQueue[_81];delete _87._objSaveQueue[_81];if(_85){_85();}};};_7.prototype.rollback=function(_89,_8a,_8b){var _8c=this;var _8d=_89.getGuid();delete this._objErrorQueue[_8d];delete this._objSaveQueue[_8d];this._backend.rollback(_8d,_8e,_8b);function _8e(_8f){var _90;if(_8f){_90=_8c._setMxObject(true,false,false,_8f);}_8c._rollbackCache(_89,_90);if(_8a){_8a(_90);}};};_7.prototype.remove=function(_91,_92,_93){var _94=this;this._backend.remove(_91,_95,_93);function _95(){_4.forEach(_91,_94._clearDataForObject,_94);if(_92){_92();}};};_7.prototype.makeChange=function(_96,_97,_98){var _99=_96.getGuid();this._objSaveQueue[_99]=_96;delete this._objErrorQueue[_99];var _9a=this._objectCache.getObject(_99);if(_9a){_9a.setWithoutEvent(_97,_98);}};_7.prototype.flush=function(_9b){if(_1.itemCount(this._objSaveQueue)===0){if(_9b){_9b();}}else{this.save(null,false,null,_9b);}};_7.prototype.setOrRetrieveMxObject=function(_9c){delete this._objErrorQueue[_9c.guid];return this._setMxObject(false,true,false,_9c);};_7.prototype.cleanup=function(){var _9d=this;var _9e=this._objectCache.filter(function(_9f){return !_9d._objectCache.isBlacklisted(_9f)&&!_9d._objectCache.isReferenced(_9f);});_4.forEach(_9e,this._clearDataForObject,this);};_7.prototype.invalidateCaches=function(_a0){if(this._objectCache.has(_a0)){this._clearDataForObject(_a0);}};_7.prototype._setMxObject=function(_a1,_a2,_a3,_a4){var _a5=this._objectCache.getObject(_a4.guid);if(_a2&&_a5){if(!_a1||!_a5.hasChanges()){this._objectCache.reset(_a4);}if(_a3){this._objectCache.reference(_a4.guid);}return _a5;}else{var obj=new _2({json:_a4,meta:window.mx.meta.getEntity(_a4.objectType)});if(_a2&&!_a5){this._objectCache.add(obj);if(_a3){this._objectCache.reference(_a4.guid);}}else{if(!_a2&&_a5){this._clearDataForObject(_a4.guid);}}return obj;}};_7.prototype._clearDataForObject=function(_a6){if(!this._shouldRemoveObjectImmediately||this._shouldRemoveObjectImmediately(_a6)){delete this._objErrorQueue[_a6];this._objectCache.removeObject(_a6);this._backend.release(_a6);}};_7.prototype.release=function(_a7){if(this._objectCache.has(_a7)&&this._objectCache.isReferenced(_a7)){this._objectCache.unreference(_a7);if(!this._objectCache.isReferenced(_a7)){this._clearDataForObject(_a7);}}};_7.prototype._rollbackCache=function(_a8,_a9){var _aa=_a8.getGuid();var _ab=this._objectCache.getObject(_aa);if(_a9){if(_ab){if(_a8!==_ab){this._objectCache.reset(_a9.jsonData);}}else{this._objectCache.add(_a9);}}else{this._objectCache.blacklist(_aa);}};return _7;});