/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/MxObjectBackend",["mendix/ov","mendix/lang","mendix/lib/MxObject","mendix/lib/Error","dojo/_base/array","dojo/_base/lang","big/big"],function(ov,_1,_2,_3,_4,_5,_6){function _7(_8,_9,_a){this._backend=_8;this._objectCache=_9;this._shouldRemoveObjectImmediately=_a;};_7.prototype.getByGuid=function(_b,_c,_d,_e,_f){_c=_c||{};var _10=this;if(_d){var _11=_4.filter(_4.map(_b,this._objectCache.getObject,this._objectCache),function(_12){return _12!=null;});var _13=_4.every(_b,function(_14){return _10._objectCache.has(_14)||_10._objectCache.isBlacklisted(_14);});if(_13){var _15=_11;if(_c.sort){_4.forEach(_c.sort,function(_16){var _17=_16[0],dir=_16[1];_15=_15.sort(dir=="asc"?function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _18=_c.offset;if(_18){var _19=_c.amount;if(_19){_15=_15.slice(_18,_18+_19);}else{_15=_15.slice(_18);}}_4.forEach(_15,this._objectCache.reference,this._objectCache);if(_e){_e(_15,_11.length);}return;}}var _1a=_c.attributes==null;this._backend.getByGuid(_b,_c,function(_1b){var _1c=_1b.mxobjects||[];var _1d=_4.map(_1c,function(obj){return _10._setMxObject(_1a,true,obj);});if(_e){_e(_1d,_1d.length);}},_f);};_7.prototype.getByXPath=function(_1e,_1f,_20,_21,_22,_23){var _24=this;this._backend.getByXPath(_1e,_1f,_20,_21,function(_25){var _26=_25.mxobjects||[];var _27=_25.count||0;var _28=_25.aggregates||[];var _29=_4.map(_26,function(obj){return _24._setMxObject(false,false,obj);});var _2a=_4.map(_28,function(agg){return agg===""?agg:new _6(agg);});if(_22){_22(_29,_27,_2a);}},_23);};_7.prototype.getByPath=function(_2b,_2c,_2d,_2e,_2f){var _30=this;this._backend.getByPath(_2b,_2c,_2d,_31,_2f);function _31(_32){var _33=_32.mxobjects||[];var _34=_4.map(_33,function(obj){return _30._setMxObject(true,true,obj);});if(_2e){_2e(_34,_34.length);}};};_7.prototype.getSlice=function(_35,_36,_37){var _38=window.mx.meta.getEntity(_35);return this._backend.getSlice(_35,_36,_37).then(function(_39){var _3a=_39.mxobjects||[];var _3b=_39.count||0;var _3c=_3a.map(function(_3d){return new _2({json:_3d,meta:_38});});return [_3c,_3b];});};_7.prototype.fetch=function(obj,_3e,_3f,_40,_41,_42){_40=_40||{};var _43=this;var _44;if(_40.schema){_44=_3e.splice(-2,_3e.length);}else{_44=[];}this._performFetch(obj,_3e,_44,_3f,_40,false,_41,_42);};_7.prototype.action=function(_45,_46,_47,_48,_49,_4a,_4b){this._backend.action(_45,_46,this._objectCache.getAllChanges(),_47,_48,_49,_4c.bind(this),_4b);function _4c(_4d){var _4e=_4d.actionResult;var _4f;if(_4e instanceof Array){_4f=_4.map(_4e,function(obj){this._removeChanges([obj.guid]);return this._setMxObject(true,true,obj);},this);}else{if(typeof _4e=="object"&&_4e.guid){this._removeChanges([_4e.guid]);_4f=[this._setMxObject(true,true,_4e)];}else{_4f=_4e;}}if(_4a){_4a(_4f);}};};_7.prototype.create=function(_50,_51,_52,_53){var _54=this;this._backend.create(_50,_51,_55,_53);function _55(_56){var _57=_56.mxobject||null;var _58=_54._setMxObject(true,true,_57);if(_52){_52(_58);}};};_7.prototype.validate=function(_59,_5a,_5b){this._backend.validate(this._objectCache.getAllChanges(),_5a,_5b);};_7.prototype.commit=function(_5c,_5d,_5e,_5f,_60,_61){var _62=_1.clone(this._objectCache.getAllChanges());var _63=_5c.map(function(_64){return _64.getGuid();});this._backend.commit(_63,_62,_5d,_5e,_5f,_65.bind(this),_61);function _65(){this._removeChanges(_63);_5c.forEach(function(_66){_66._applyChangeSet(_62[_66.getGuid()]);this._setMxObject(true,false,_66.jsonData);},this);if(_60){_60();}};};_7.prototype.rollback=function(_67,_68,_69){var _6a=_67.map(function(_6b){return _6b.getGuid();});this._backend.rollback(_6a,this._objectCache.getAllChanges(),_6c.bind(this),_69);function _6c(_6d){var _6e=_6d.mxobjects||[];this._removeChanges(_6a);var _6f=_6e.map(function(_70){return this._setMxObject(false,false,_70);},this);var _71=_1.objectFromArray(_6f.map(function(_72){return [_72.getGuid(),_72];}));_67.forEach(function(_73){var _74=_71[_73.getGuid()];this._rollbackCache(_73,_74);if(_74){_73.resetFromJSON(_74.jsonData);}},this);if(_68){_68(_6f);}};};_7.prototype.remove=function(_75,_76,_77){this._backend.remove(_75,this._objectCache.getAllChanges(),_78.bind(this),_77);function _78(){this._removeChanges(_75);_4.forEach(_75,this._clearDataForObject,this);if(_76){_76();}};};_7.prototype.saveDocument=function(_79,_7a,_7b,_7c,_7d,_7e){this._backend.saveDocument(_79,this._objectCache.getAllChanges(),_7a,_7b,_7c,_7f.bind(this),_7e);function _7f(){this._removeChanges([_79]);this.getByGuid([_79],{},false,_7d,_7e);};};_7.prototype.makeChange=function(_80,_81,_82){this._objectCache.makeChange(_80,_81,_82);};_7.prototype.setOrRetrieveMxObject=function(_83){this._removeChanges([_83.guid]);return this._setMxObject(true,false,_83);};_7.prototype.cleanup=function(){var _84=this;var _85=this._objectCache.filter(function(_86){return !_84._objectCache.isBlacklisted(_86)&&!_84._objectCache.isReferenced(_86);});_4.forEach(_85,this._clearDataForObject,this);};_7.prototype.invalidateCaches=function(_87){if(this._objectCache.has(_87)){this._clearDataForObject(_87);}};_7.prototype.clearCache=function(){this._objectCache.clear();};_7.prototype.getChanges=function(_88){return this._objectCache.getChanges(_88);};_7.prototype._setMxObject=function(_89,_8a,_8b){var _8c=this._objectCache.getObject(_8b.guid);if(_89&&_8c){this._objectCache.reset(_8b);if(_8a){this._objectCache.reference(_8b.guid);}return _8c;}else{var obj=new _2({json:_8b,meta:window.mx.meta.getEntity(_8b.objectType)});if(_89&&!_8c){this._objectCache.add(obj);if(_8a){this._objectCache.reference(_8b.guid);}}else{if(!_89&&_8c){this._clearDataForObject(_8b.guid);}}return obj;}};_7.prototype._clearDataForObject=function(_8d){if(!this._shouldRemoveObjectImmediately||this._shouldRemoveObjectImmediately(_8d)){this._objectCache.removeObject(_8d);this._backend.release(_8d);}};_7.prototype.release=function(_8e){if(this._objectCache.has(_8e)&&this._objectCache.isReferenced(_8e)){this._objectCache.unreference(_8e);if(!this._objectCache.isReferenced(_8e)){this._clearDataForObject(_8e);}}};_7.prototype._rollbackCache=function(_8f,_90){var _91=_8f.getGuid();var _92=this._objectCache.getObject(_91);if(_90){if(_92){if(_8f!==_92){this._objectCache.reset(_90.jsonData);}}else{this._objectCache.add(_90);}}else{this._removeChanges([_91]);this._objectCache.blacklist(_91);}};_7.prototype._performFetch=function(_93,_94,_95,_96,_97,_98,_99,_9a){var ref,_9b,_9c,_9d;if(_94.length+_95.length===0){if(_93==null){_99(null,false);}else{if(!_96){_99(_93,_98);}else{_99(_9e(_93,_96),false);}}}else{if(_94.length===0&&_95.length>0){ref=_95[0];_9b=_95[1];if(_93.isObjectReferenceSet(ref)){this._fetchReferenceSet(_93,ref,_9b,_99,_9a);}else{this._fetchReference(_93,_94,_95.slice(2),_96,_97,ref,_9b,_97.schema,_99,_9a);}}else{if(_98){this.release(_93.getGuid());_98=false;}ref=_94[0];_9b=_94[1];if(_93.isObjectReferenceSet(ref)){if(_94.length>2||_95.length>2){if(_9a){_9a(new _3("reference set should be at end of path"));}}else{this._fetchReferenceSet(_93,ref,_9b,_99,_9a);}}else{if(_93.isObjectReference(ref)){_9c=_93.getChild(ref);if(_9c){if(_9c.isA(_9b)){this._performFetch(_9c,_94.slice(2),_95,_96,_97,_98,_99,_9a);}else{this.release(_93.getGuid());if(_99){_99(null,false);}}}else{_9d=_93.getReference(ref);if(!_9d){_99(null,false);}else{if(this._objectCache.has(_9d)){var _9f=this._objectCache.getObject(_9d);if(_9f.isA(_9b)){this._objectCache.reference(_9d);this._performFetch(_9f,_94.slice(2),_95,_96,_97,true,_99,_9a);}else{this.release(_9f.getGuid());if(_99){_99(null,false);}}}else{if(_97.usexpath&&_94.length>2){this._fetchXPath(_93,_94.slice(2),_95,_96,_97,_98,_9d,_9b,_99,_9a);}else{this._fetchReference(_93,_94.slice(2),_95,_96,_97,ref,_9b,null,_99,_9a);}}}}}else{if(_9a){_9a(new _3("attribute "+ref+" is not a reference type"));}}}}}};_7.prototype._fetchReference=function(_a0,_a1,_a2,_a3,_a4,ref,_a5,_a6,_a7,_a8){var _a9=this;var _aa=_a0.getReference(ref);if(_aa){this.getByGuid([_aa],{id:_a6},true,function(_ab){var _ac;if(_a6){_ac=_ab.filter(function(_ad){return _ad.getGuid()===_aa;});}else{_ac=_ab;}if(_ac.length===1){resultObj=_ac[0];}else{resultObj=null;}if(resultObj&&resultObj.isA(_a5)){_a9._performFetch(resultObj,_a1,_a2,_a3,_a4,true,_a7,_a8);}else{_a9.release(_a0.getGuid());_a7(null,false);}},_a8);}else{_a7(null,false);}};_7.prototype._fetchReferenceSet=function(_ae,ref,_af,_b0,_b1){var _b2=this;if(_ae.getReferences(ref).length===0){_b0([],false);}else{if(_ae.hasChildren(ref)){_b0(_ae.getChildren(ref).filter(function(_b3){return _b3.isA(_af);}),false);}else{this.getByGuid(_ae.getReferences(ref),null,true,function(_b4){var res=_b4.reduce(function(acc,obj){if(obj.isA(_af)){acc.matching.push(obj);}else{acc.releasing.push(obj);}return acc;},{matching:[],releasing:[]});_b2._releaseMxObjects(res.releasing);_b0(res.matching,res.matching.length>0);},_b1);}}};_7.prototype._fetchXPath=function(_b5,_b6,_b7,_b8,_b9,_ba,_bb,_bc,_bd,_be){var _bf=this;var _c0=["//"+_bc+"[id="+_bb+"]"].concat(_b6).join("/");this.getByXPath(_c0,null,false,false,function(_c1){if(_c1.length===0){_bd(null,false);}else{if(_b8&&_c1.length==1){_bd(_9e(_c1[0],_b8),false);}else{if(!_b8){if(_c2(_bc,_b6)){_bd(_c1,false);}else{_bf._performFetch(_c1[0],[],_b7,_b8,_b9,_ba,_bd,_be);}}else{if(_be){_be(new _3(_b8+" is not a reference type"));}}}}},_be);};_7.prototype._releaseMxObjects=function(_c3){_c3.forEach(function(_c4){this.release(_c4.getGuid());},this);};_7.prototype._removeChanges=function(_c5){this._objectCache.removeChanges(_c5);};return _7;function _9e(_c6,_c7){if(_c6.isObjectReference(_c7)){return _c6.getReference(_c7);}else{if(_c6.isObjectReferenceSet(_c7)){return _c6.getReferences(_c7);}else{return _c6.get2(_c7);}}};function _c2(_c8,_c9){var _ca=[_c8].concat(_c9);var _cb,_cc;if(_c9.length<2){return false;}_cb=window.mx.meta.getEntity(_ca.slice(-3)[0]);_cc=_c9.slice(-2)[0];return _cb.isObjectReferenceSet(_cc);};});