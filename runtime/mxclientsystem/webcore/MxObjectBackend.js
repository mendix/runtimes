/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/MxObjectBackend",["mendix/ov","mendix/lang","mendix/lib/MxObject","mendix/lib/Error","dojo/_base/array","dojo/_base/lang","big/big"],function(ov,_1,_2,_3,_4,_5,_6){function _7(_8,_9,_a){this._backend=_8;this._objectCache=_9;this._shouldRemoveObjectImmediately=_a;this._objErrorQueue={};this._objSaveQueue={};};_7.prototype.getByGuid=function(_b,_c,_d,_e,_f){_c=_c||{};var _10=this;if(_d){var _11=_4.filter(_4.map(_b,this._objectCache.getObject,this._objectCache),function(_12){return _12!=null;});var _13=_4.every(_b,function(_14){return _10._objectCache.has(_14)||_10._objectCache.isBlacklisted(_14);});if(_13){var _15=_11;if(_c.sort){_4.forEach(_c.sort,function(_16){var _17=_16[0],dir=_16[1];_15=_15.sort(dir=="asc"?function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _18=_c.offset;if(_18){var _19=_c.amount;if(_19){_15=_15.slice(_18,_18+_19);}else{_15=_15.slice(_18);}}_4.forEach(_15,this._objectCache.reference,this._objectCache);if(_e){_e(_15,_11.length);}return;}}var _1a=_c.attributes==null;this._backend.getByGuid(_b,_c,function(_1b){var _1c=_4.map(_1b,function(obj){return _10._setMxObject(true,_1a,true,obj);});if(_e){_e(_1c,_1c.length);}},_f);};_7.prototype.getByXPath=function(_1d,_1e,_1f,_20,_21,_22){var _23=this;this._backend.getByXPath(_1d,_1e,_1f,_20,function(_24,_25,_26){var _27=_4.map(_24,function(obj){return _23._setMxObject(true,false,false,obj);});var _28=_4.map(_26,function(agg){return agg===""?agg:new _6(agg);});if(_21){_21(_27,_25,_28);}},_22);};_7.prototype.getByPath=function(_29,_2a,_2b,_2c,_2d){var _2e=this;this._backend.getByPath(_29,_2a,_2b,_2f,_2d);function _2f(_30){var _31=_4.map(_30,function(obj){return _2e._setMxObject(true,true,true,obj);});if(_2c){_2c(_31,_31.length);}};};_7.prototype.getSlice=function(_32,_33,_34){var _35=window.mx.meta.getEntity(_32);return this._backend.getSlice(_32,_33,_34).spread(function(_36,_37){var _38=_36.map(function(_39){return new _2({json:_39,meta:_35});});return [_38,_37];});};_7.prototype.fetch=function(obj,_3a,_3b,_3c,_3d,_3e){_3c=_3c||{};var _3f=this;var _40;if(_3c.schema){_40=_3a.splice(-2,_3a.length);}else{_40=[];}this._performFetch(obj,_3a,_40,_3b,_3c,false,_3d,_3e);};_7.prototype.action=function(_41,_42,_43,_44,_45,_46,_47){var _48=this;this._backend.action(_41,_42,_43,_44,_45,_49,_47);function _49(_4a,_4b){var _4c;if(_4a instanceof Array){_4c=_4.map(_4a,function(obj){return _48._setMxObject(false,true,true,obj);});}else{if(typeof _4a=="object"&&_4a.guid){_4c=[_48._setMxObject(false,true,true,_4a)];}else{_4c=_4a;}}if(_4c instanceof Array){_4.forEach(_4c,function(_4d){delete _48._objErrorQueue[_4d.getGuid()];});}if(_46){_46(_4c,_4b);}};};_7.prototype.create=function(_4e,_4f,_50,_51){var _52=this;this._backend.create(_4e,_4f,_53,_51);function _53(_54){var _55=_52._setMxObject(true,true,true,_54);if(_50){_50(_55);}};};_7.prototype.save=function(_56,_57,_58,_59,_5a){var _5b=this;if(_56){var _5c=this._objErrorQueue[_56.getGuid()];if(_5c){if(_5a){_5a(_5c);}return;}else{if(!_56.hasChanges()){if(_59){_59();}return;}}}var _5d={};var _5e;if(!_57){var _5f=false;_5e=this._objSaveQueue;this._objSaveQueue={};for(var _60 in _5e){var _61=_5e[_60];if(_61.hasChanges()){_5d[_60]=_61._collectChanges();_5f=true;}delete this._objErrorQueue[_60];}if(!_5f){if(_59){_59();}return;}}if(_56&&!_5e[_56.getGuid()]){_5d[_56.getGuid()]=_56._collectChanges();_5e={guid:_56};delete this._objSaveQueue[_56.getGuid()];delete this._objErrorQueue[_56.getGuid()];}this._backend.save(_5d,_58,_62,_63);function _62(){for(var _64 in _5e){_5e[_64]._applyChangeSet();}if(_59){_59();}};function _63(e){var _65=e.original||{};var _66=false;if(ov.hasValidations(_65)){_4.forEach(ov.getValidations(_65),function(_67){var _68=_67.getGuid();if(_5e[_68]){_5b._objErrorQueue[_68]=_67;delete _5e[_68];}_66=!!_56&&_68==_56.getGuid();});for(var id in _5e){_5e[id]._applyChangeSet();}}else{_5.mixin(_5b._objSaveQueue,_5e);_66=true;}if(_56&&_66){if(_5a){_5a(e);}}else{if(_59){_59();}}};};_7.prototype.commit=function(_69,_6a,_6b,_6c,_6d,_6e){var _6f=this;this._backend.commit(_69,_6a,_6b,_6c,_70,_6e);function _70(){delete _6f._objErrorQueue[_69];delete _6f._objSaveQueue[_69];if(_6d){_6d();}};};_7.prototype.rollback=function(_71,_72,_73){var _74=this;var _75=_71.getGuid();delete this._objErrorQueue[_75];delete this._objSaveQueue[_75];this._backend.rollback(_75,_76,_73);function _76(_77){var _78;if(_77){_78=_74._setMxObject(true,false,false,_77);}_74._rollbackCache(_71,_78);if(_72){_72(_78);}};};_7.prototype.remove=function(_79,_7a,_7b){var _7c=this;this._backend.remove(_79,_7d,_7b);function _7d(){_4.forEach(_79,_7c._clearDataForObject,_7c);if(_7a){_7a();}};};_7.prototype.saveDocument=function(_7e,_7f,_80,_81,_82,_83){var _84=this;this.flush(function(){_84._backend.saveDocument(_7e,_7f,_80,_81,function(){_84.getByGuid([_7e],{},false,_82,_83);},_83);});};_7.prototype.makeChange=function(_85,_86,_87){var _88=_85.getGuid();this._objSaveQueue[_88]=_85;delete this._objErrorQueue[_88];var _89=this._objectCache.getObject(_88);if(_89){_89.setWithoutEvent(_86,_87);}};_7.prototype.flush=function(_8a){if(_1.itemCount(this._objSaveQueue)===0){if(_8a){_8a();}}else{this.save(null,false,null,_8a);}};_7.prototype.setOrRetrieveMxObject=function(_8b){delete this._objErrorQueue[_8b.guid];return this._setMxObject(false,true,false,_8b);};_7.prototype.cleanup=function(){var _8c=this;var _8d=this._objectCache.filter(function(_8e){return !_8c._objectCache.isBlacklisted(_8e)&&!_8c._objectCache.isReferenced(_8e);});_4.forEach(_8d,this._clearDataForObject,this);};_7.prototype.invalidateCaches=function(_8f){if(this._objectCache.has(_8f)){this._clearDataForObject(_8f);}};_7.prototype._setMxObject=function(_90,_91,_92,_93){var _94=this._objectCache.getObject(_93.guid);if(_91&&_94){if(!_90||!_94.hasChanges()){this._objectCache.reset(_93);}if(_92){this._objectCache.reference(_93.guid);}return _94;}else{var obj=new _2({json:_93,meta:window.mx.meta.getEntity(_93.objectType)});if(_91&&!_94){this._objectCache.add(obj);if(_92){this._objectCache.reference(_93.guid);}}else{if(!_91&&_94){this._clearDataForObject(_93.guid);}}return obj;}};_7.prototype._clearDataForObject=function(_95){if(!this._shouldRemoveObjectImmediately||this._shouldRemoveObjectImmediately(_95)){delete this._objErrorQueue[_95];this._objectCache.removeObject(_95);this._backend.release(_95);}};_7.prototype.release=function(_96){if(this._objectCache.has(_96)&&this._objectCache.isReferenced(_96)){this._objectCache.unreference(_96);if(!this._objectCache.isReferenced(_96)){this._clearDataForObject(_96);}}};_7.prototype._rollbackCache=function(_97,_98){var _99=_97.getGuid();var _9a=this._objectCache.getObject(_99);if(_98){if(_9a){if(_97!==_9a){this._objectCache.reset(_98.jsonData);}}else{this._objectCache.add(_98);}}else{this._objectCache.blacklist(_99);}};_7.prototype._performFetch=function(_9b,_9c,_9d,_9e,_9f,_a0,_a1,_a2){var ref,_a3,_a4,_a5;if(_9c.length+_9d.length===0){if(_9b==null){_a1(null,false);}else{if(!_9e){_a1(_9b,_a0);}else{_a1(_a6(_9b,_9e),false);}}}else{if(_9c.length===0&&_9d.length>0){ref=_9d[0];_a3=_9d[1];if(_9b.isObjectReferenceSet(ref)){this._fetchReferenceSet(_9b,ref,_a3,_a1,_a2);}else{this._fetchReference(_9b,_9c,_9d.slice(2),_9e,_9f,ref,_a3,_9f.schema,_a1,_a2);}}else{if(_a0){this.release(_9b.getGuid());_a0=false;}ref=_9c[0];_a3=_9c[1];if(_9b.isObjectReferenceSet(ref)){if(_9c.length>2||_9d.length>2){if(_a2){_a2(new _3("reference set should be at end of path"));}}else{this._fetchReferenceSet(_9b,ref,_a3,_a1,_a2);}}else{if(_9b.isObjectReference(ref)){_a4=_9b.getChild(ref);if(_a4){if(_a4.isA(_a3)){this._performFetch(_a4,_9c.slice(2),_9d,_9e,_9f,_a0,_a1,_a2);}else{this.release(_9b.getGuid());if(_a1){_a1(null,false);}}}else{_a5=_9b.getReference(ref);if(!_a5){_a1(null,false);}else{if(this._objectCache.has(_a5)){var _a7=this._objectCache.getObject(_a5);if(_a7.isA(_a3)){this._objectCache.reference(_a5);this._performFetch(_a7,_9c.slice(2),_9d,_9e,_9f,true,_a1,_a2);}else{this.release(_a7.getGuid());if(_a1){_a1(null,false);}}}else{if(_9f.usexpath&&_9c.length>2){this._fetchXPath(_9b,_9c.slice(2),_9d,_9e,_9f,_a0,_a5,_a3,_a1,_a2);}else{this._fetchReference(_9b,_9c.slice(2),_9d,_9e,_9f,ref,_a3,null,_a1,_a2);}}}}}else{if(_a2){_a2(new _3("attribute "+ref+" is not a reference type"));}}}}}};_7.prototype._fetchReference=function(_a8,_a9,_aa,_ab,_ac,ref,_ad,_ae,_af,_b0){var _b1=this;var _b2=_a8.getReference(ref);if(_b2){this.getByGuid([_b2],{id:_ae},true,function(_b3){var _b4;if(_ae){_b4=_b3.filter(function(_b5){return _b5.getGuid()===_b2;});}else{_b4=_b3;}if(_b4.length===1){resultObj=_b4[0];}else{resultObj=null;}if(resultObj&&resultObj.isA(_ad)){_b1._performFetch(resultObj,_a9,_aa,_ab,_ac,true,_af,_b0);}else{_b1.release(_a8.getGuid());_af(null,false);}},_b0);}else{_af(null,false);}};_7.prototype._fetchReferenceSet=function(_b6,ref,_b7,_b8,_b9){var _ba=this;if(_b6.getReferences(ref).length===0){_b8([],false);}else{if(_b6.hasChildren(ref)){_b8(_b6.getChildren(ref).filter(function(_bb){return _bb.isA(_b7);}),false);}else{this.getByGuid(_b6.getReferences(ref),null,true,function(_bc){var res=_bc.reduce(function(acc,obj){if(obj.isA(_b7)){acc.matching.push(obj);}else{acc.releasing.push(obj);}return acc;},{matching:[],releasing:[]});_ba._releaseMxObjects(res.releasing);_b8(res.matching,res.matching.length>0);},_b9);}}};_7.prototype._fetchXPath=function(_bd,_be,_bf,_c0,_c1,_c2,_c3,_c4,_c5,_c6){var _c7=this;var _c8=["//"+_c4+"[id="+_c3+"]"].concat(_be).join("/");this.getByXPath(_c8,null,false,false,function(_c9){if(_c9.length===0){_c5(null,false);}else{if(_c0&&_c9.length==1){_c5(_a6(_c9[0],_c0),false);}else{if(!_c0){if(_ca(_c4,_be)){_c5(_c9,false);}else{_c7._performFetch(_c9[0],[],_bf,_c0,_c1,_c2,_c5,_c6);}}else{if(_c6){_c6(new _3(_c0+" is not a reference type"));}}}}},_c6);};_7.prototype._releaseMxObjects=function(_cb){_cb.forEach(function(_cc){this.release(_cc.getGuid());},this);};return _7;function _a6(_cd,_ce){if(_cd.isObjectReference(_ce)){return _cd.getReference(_ce);}else{if(_cd.isObjectReferenceSet(_ce)){return _cd.getReferences(_ce);}else{return _cd.get2(_ce);}}};function _ca(_cf,_d0){var _d1=[_cf].concat(_d0);var _d2,_d3;if(_d0.length<2){return false;}_d2=window.mx.meta.getEntity(_d1.slice(-3)[0]);_d3=_d0.slice(-2)[0];return _d2.isObjectReferenceSet(_d3);};});