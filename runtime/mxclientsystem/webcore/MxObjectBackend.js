/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/MxObjectBackend",["mendix/ov","mendix/lang","mendix/lib/MxObject","mendix/lib/Error","dojo/_base/array","dojo/_base/lang","big/big"],function(ov,_1,_2,_3,_4,_5,_6){function _7(_8,_9,_a){this._backend=_8;this._objectCache=_9;this._shouldRemoveObjectImmediately=_a;this._objErrorQueue={};this._objSaveQueue={};};_7.prototype.getByGuid=function(_b,_c,_d,_e,_f){var _10=this;if(_d){var _11=_4.filter(_4.map(_b,this._objectCache.getObject,this._objectCache),function(_12){return _12!=null;});var _13=_4.every(_b,function(_14){return _10._objectCache.has(_14)||_10._objectCache.isBlacklisted(_14);});if(_13){var _15=_11;if(_c.sort){_4.forEach(_c.sort,function(_16){var _17=_16[0],dir=_16[1];_15=_15.sort(dir=="asc"?function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return -1;}else{if(a>b){return 1;}}return 0;}:function(a,b){a=a.get2(_17);b=b.get2(_17);if(a<b){return 1;}else{if(a>b){return -1;}}return 0;});});}var _18=_c.offset;if(_18){var _19=_c.amount;if(_19){_15=_15.slice(_18,_18+_19);}else{_15=_15.slice(_18);}}_4.forEach(_15,this._objectCache.reference,this._objectCache);if(_e){_e(_15,_11.length);}return;}}var _1a=_c.attributes==null;this._backend.getByGuid(_b,_c,function(_1b){var _1c=_4.map(_1b,function(obj){return _10._setMxObject(true,_1a,true,obj);});if(_e){_e(_1c,_1c.length);}},_f);};_7.prototype.getByXPath=function(_1d,_1e,_1f,_20,_21,_22){var _23=this;this._backend.getByXPath(_1d,_1e,_1f,_20,function(_24,_25,_26){var _27=_4.map(_24,function(obj){return _23._setMxObject(true,false,false,obj);});var _28=_4.map(_26,function(agg){return agg===""?agg:new _6(agg);});if(_21){_21(_27,_25,_28);}},_22);};_7.prototype.getByPath=function(_29,_2a,_2b,_2c,_2d){var _2e=this;this._backend.getByPath(_29,_2a,_2b,_2f,_2d);function _2f(_30){var _31=_4.map(_30,function(obj){return _2e._setMxObject(true,true,true,obj);});if(_2c){_2c(_31,_31.length);}};};_7.prototype.getSlice=function(_32,_33,_34){var _35=window.mx.meta.getEntity(_32);return this._backend.getSlice(_32,_33,_34).spread(function(_36,_37){var _38=_36.map(function(_39){return new _2({json:_39,meta:_35});});return [_38,_37];});};_7.prototype.fetch=function(obj,_3a,_3b,_3c,_3d,_3e){var _3f=this;var _40=obj;var _41=false;var _42;if(_3c.schema){_42=_3a.splice(-2,_3a.length);}else{_42=[];}var _43=function(_44,ref){if(_44.isObjectReference(ref)){return _44.getReference(ref);}else{if(_44.isObjectReferenceSet(ref)){return _44.getReferences(ref);}else{return _44.get2(ref);}}};var _45=function(){if(_40==null){_3d(null,false);}else{if(!_3b){_3d(_40,_41);}else{if(_3b){_3d(_43(_40,_3b),false);}}}};var _46=function(ref){if(_40.getReferences(ref).length===0){_3d([],false);}else{if(_40.hasChildren(ref)){_3d(_40.getChildren(ref),false);}else{window.mx.data.get({guids:_40.getReferences(ref),filter:{id:_3c.schema},callback:function(_47){_3d(_47,true);},error:_3e});}}};var _48=function(ref,_49){var _4a=_40.getReference(ref);if(_4a){window.mx.data.get({guid:_4a,filter:{id:_49},callback:function(obj){if(obj){_40=obj;_41=true;_4b();}else{_3d(null,false);}},error:_3e});}else{_3d(null,false);}};var _4c=function(_4d){var _4e,_4f;if(_4d.length<3){return false;}_4e=window.mx.meta.getEntity(_4d.slice(-3)[0]),_4f=_3a.slice(-2)[0];return _4e.isObjectReferenceSet(_4f);};var _50=function(_51,_52){var _53=["//"+_52+"[id="+_51+"]"],_54=_4c([_52].concat(_3a));Array.prototype.push.apply(_53,_3a);_3a=[];window.mx.data.get({xpath:_53.join("/"),callback:function(_55){if(_55.length===0){_3d(null,false);}else{if(_3b&&_55.length==1){_40=_55[0];_45();}else{if(!_3b){if(_54){_3d(_55,false);}else{_40=_55[0];_4b();}}else{if(_3e){_3e(new _3(_3b+" is not a reference type"));}}}}},error:_3e});};var _4b=function(){var ref,_56,_57,_58;if(_3a.length+_42.length===0){_45();}else{if(_3a.length===0&&_42.length>0){ref=_42.shift();_56=_42.shift();if(_40.isObjectReferenceSet(ref)){_46(ref);}else{_48(ref,_3c.schema);}}else{if(_41){window.mx.data.release(_40);_41=false;}ref=_3a.shift();_56=_3a.shift();if(_40.isObjectReferenceSet(ref)){if(_3a.length>0||_42>0){if(_3e){_3e(new _3("reference set should be at end of path"));}}else{_46(ref);}}else{if(_40.isObjectReference(ref)){_57=_40.getChild(ref);if(_57){_40=_57;_4b();}else{_58=_40.getReference(ref);if(!_58){_3d(null,false);}else{if(_3f._objectCache.has(_58)){_40=_3f._objectCache.getObject(_58);_3f._objectCache.reference(_58);_41=true;_4b();}else{if(_3c.usexpath&&_3a.length>0){_50(_58,_56);}else{_48(ref);}}}}}else{if(_3e){_3e(new _3("attribute "+ref+" is not a reference type"));}}}}}};_4b();};_7.prototype.action=function(_59,_5a,_5b,_5c,_5d,_5e,_5f){var _60=this;this._backend.action(_59,_5a,_5b,_5c,_5d,_61,_5f);function _61(_62,_63){var _64;if(_62 instanceof Array){_64=_4.map(_62,function(obj){return _60._setMxObject(false,true,true,obj);});}else{if(typeof _62=="object"&&_62.guid){_64=[_60._setMxObject(false,true,true,_62)];}else{_64=_62;}}if(_64 instanceof Array){_4.forEach(_64,function(_65){delete _60._objErrorQueue[_65.getGuid()];});}if(_5e){_5e(_64,_63);}};};_7.prototype.create=function(_66,_67,_68,_69){var _6a=this;this._backend.create(_66,_67,_6b,_69);function _6b(_6c){var _6d=_6a._setMxObject(true,true,true,_6c);if(_68){_68(_6d);}};};_7.prototype.save=function(_6e,_6f,_70,_71,_72){var _73=this;if(_6e){var _74=this._objErrorQueue[_6e.getGuid()];if(_74){if(_72){_72(_74);}return;}else{if(!_6e.hasChanges()){if(_71){_71();}return;}}}var _75={};var _76;if(!_6f){var _77=false;_76=this._objSaveQueue;this._objSaveQueue={};for(var _78 in _76){var _79=_76[_78];if(_79.hasChanges()){_75[_78]=_79._collectChanges();_77=true;}delete this._objErrorQueue[_78];}if(!_77){if(_71){_71();}return;}}if(_6e&&!_76[_6e.getGuid()]){_75[_6e.getGuid()]=_6e._collectChanges();_76={guid:_6e};delete this._objSaveQueue[_6e.getGuid()];delete this._objErrorQueue[_6e.getGuid()];}this._backend.save(_75,_70,_7a,_7b);function _7a(){for(var _7c in _76){_76[_7c]._applyChangeSet();}if(_71){_71();}};function _7b(e){var _7d=e.original||{};var _7e=false;if(ov.hasValidations(_7d)){_4.forEach(ov.getValidations(_7d),function(_7f){var _80=_7f.getGuid();if(_76[_80]){_73._objErrorQueue[_80]=_7f;delete _76[_80];}_7e=!!_6e&&_80==_6e.getGuid();});for(var id in _76){_76[id]._applyChangeSet();}}else{_5.mixin(_73._objSaveQueue,_76);_7e=true;}if(_6e&&_7e){if(_72){_72(e);}}else{if(_71){_71();}}};};_7.prototype.commit=function(_81,_82,_83,_84,_85,_86){var _87=this;this._backend.commit(_81,_82,_83,_84,_88,_86);function _88(){delete _87._objErrorQueue[_81];delete _87._objSaveQueue[_81];if(_85){_85();}};};_7.prototype.rollback=function(_89,_8a,_8b){var _8c=this;var _8d=_89.getGuid();delete this._objErrorQueue[_8d];delete this._objSaveQueue[_8d];this._backend.rollback(_8d,_8e,_8b);function _8e(_8f){var _90;if(_8f){_90=_8c._setMxObject(true,false,false,_8f);}_8c._rollbackCache(_89,_90);if(_8a){_8a(_90);}};};_7.prototype.remove=function(_91,_92,_93){var _94=this;this._backend.remove(_91,_95,_93);function _95(){_4.forEach(_91,_94._clearDataForObject,_94);if(_92){_92();}};};_7.prototype.makeChange=function(_96,_97,_98){var _99=_96.getGuid();this._objSaveQueue[_99]=_96;delete this._objErrorQueue[_99];var _9a=this._objectCache.getObject(_99);if(_9a){_9a.setWithoutEvent(_97,_98);}};_7.prototype.flush=function(_9b){if(_1.itemCount(this._objSaveQueue)===0){if(_9b){_9b();}}else{this.save(null,false,null,_9b);}};_7.prototype.setOrRetrieveMxObject=function(_9c){delete this._objErrorQueue[_9c.guid];return this._setMxObject(false,true,false,_9c);};_7.prototype.cleanup=function(){var _9d=this;var _9e=this._objectCache.filter(function(_9f){return !_9d._objectCache.isBlacklisted(_9f)&&!_9d._objectCache.isReferenced(_9f);});_4.forEach(_9e,this._clearDataForObject,this);};_7.prototype.invalidateCaches=function(_a0){if(this._objectCache.has(_a0)){this._clearDataForObject(_a0);}};_7.prototype._setMxObject=function(_a1,_a2,_a3,_a4){var _a5=this._objectCache.getObject(_a4.guid);if(_a2&&_a5){if(!_a1||!_a5.hasChanges()){this._objectCache.reset(_a4);}if(_a3){this._objectCache.reference(_a4.guid);}return _a5;}else{var obj=new _2({json:_a4,meta:window.mx.meta.getEntity(_a4.objectType)});if(_a2&&!_a5){this._objectCache.add(obj);if(_a3){this._objectCache.reference(_a4.guid);}}else{if(!_a2&&_a5){this._clearDataForObject(_a4.guid);}}return obj;}};_7.prototype._clearDataForObject=function(_a6){if(!this._shouldRemoveObjectImmediately||this._shouldRemoveObjectImmediately(_a6)){delete this._objErrorQueue[_a6];this._objectCache.removeObject(_a6);this._backend.release(_a6);}};_7.prototype.release=function(_a7){if(this._objectCache.has(_a7)&&this._objectCache.isReferenced(_a7)){this._objectCache.unreference(_a7);if(!this._objectCache.isReferenced(_a7)){this._clearDataForObject(_a7);}}};_7.prototype._rollbackCache=function(_a8,_a9){var _aa=_a8.getGuid();var _ab=this._objectCache.getObject(_aa);if(_a9){if(_ab){if(_a8!==_ab){this._objectCache.reset(_a9.jsonData);}}else{this._objectCache.add(_a9);}}else{this._objectCache.blacklist(_aa);}};return _7;});