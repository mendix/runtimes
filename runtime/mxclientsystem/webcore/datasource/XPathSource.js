/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/datasource/XPathSource",["./_XPathSourceBase","mendix/lang","mendix/logger","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5){var _6=_5(_1,{name:"webcore.datasource.XPathSource",_entity:"",_xpath:"",_pathConstraint:"",_useContext:false,constructor:function(_7){var _8=_7.path?_7.path.split("/"):[];this._useContext=_7.useContext;this._entity=_8.length?_8.pop():_7.entity;if(_8.length){this._pathConstraint="["+_8.reverse().join("/")+"=\"[%CurrentObject%]\"]";}},reload:function(_9){this._xpath="";this._runSafeQuery(_9);},refresh:function(_a){this._runSafeQuery(_a);},update:function(_b){var _c=this._xpath;this._actGetXPath(_4.hitch(this,function(){if(_c==this._xpath){_2.nullExec(_b);}else{if(_b){this._runQuery(_b);}}}));},entityUpdate:function(_d){this._runSafeQuery(_d);},generateExport:function(_e){_e.params=_4.mixin({},_e.params,{xpath:this.getCurrentXPath(),sort:this.getSortSettings(),gridid:this._schemaId});window.mx.data.generateExport(_e);},getCurrentXPath:function(){return this._xpathString();},isValid:function(_f){if(this.context.hasBacktrack()){window.mx.data.getBacktrackConstraints(null,this.context,_4.hitch(this,function(_10,_11){_f&&_f(_11);}),function(e){window.mx.onError(e);_f&&_f(false);});}else{_f&&_f(true);}},_actGetXPath:function(_12){var _13=_2.nullExec;if(this._useContext){window.mx.data.createXPathString({entity:this._entity,context:this.context,callback:_4.hitch(this,function(_14){this._xpath=_14;_13(_12);}),error:function(e){window.mx.onError(e);_12&&_12();}});}else{if(this.context&&this.context.hasBacktrack()){window.mx.data.getBacktrackConstraints(null,this.context,_4.hitch(this,function(_15,_16){if(_16){this._xpath="//"+this._entity+_15;}else{this._xpath="";}_13(_12);}),function(e){window.mx.onError(e);_12&&_12();});}else{this._xpath="//"+this._entity;_13(_12);}}},_runSafeQuery:function(_17){var _18=["_runQuery"];if(!this._xpath){_18.unshift("_actGetXPath");}_2.sequence(_18,_17,this);},_runQuery:function(_19){var _1a=this._xpathString();if(_1a){window.mx.data.get({xpath:this.getCurrentXPath(),filter:this.getFilterOptions(),count:true,aggregates:this._aggregates,callback:function(_1b,_1c){this._handleObjects(_1b,_1c.count,_1c.aggregates,_19);},error:function(e){window.mx.onError(e);_19&&_19();}},this);}else{this._handleObjects([],0,null,_19);}},_handleObjects:function(_1d,_1e,_1f,_20){this._setObjects(_1d);this._setSetSize(_1e);this._setAggregates(_1f);_20&&_20();},_xpathString:function(){var _21=[this._pathConstraint,this.getStaticConstraint(),this.getConstraints()].join(""),_22="";if(this._xpath){var _23=this._xpath+_21;if(/\[%CurrentObject%\]/.test(_23)){var _24=this.context.getTrackId();if(_24){_22=window.mx.parser.replaceXPathTokens(_23,this.context);}}else{_22=_23;}}return _22;}});return _6;});