/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/Store",["mendix/lib/MxObject","bluebird/bluebird","./applicative","./file-transfer","./Task","./task-helpers","./TaskReader","./url-helpers"],function(_1,_2,_3,_4,_5,_6,_7,_8){function _9(_a,_b){this._fetchDescriptions=_a;this._downloadFileFn=_b||function(_c,_d,_e,_f){_4.downloadFile(_8.getStaticResourceUrlFromPath(_c),{location:window.TEMPORARY,path:"files/"+_d},_e,_f);};};_9.prototype.getSlice=function(_10,_11,_12){return _13(this._getDatabase().then(this._fetchSlice(_10,_11,_12)));};_9.prototype.getByGuid=function(_14){return _13(this._getDatabase().then(this._fetch(_14)));};_9.prototype.insertOrReplace=function(_15,obj){return _13(this._getDatabase().then(this._insertOrReplace(_15,obj)));};_9.prototype.download=function(){var _16=this;function _17(){return _16._fetchDescriptions.map(function(fd){return _32(fd.xpath).then(function(_18){var _19=_18.map(_2f);var _1a=_18.map(function(obj){return new _1({json:obj,meta:window.mx.meta.getEntity(obj.objectType)});});var _1b=_25(_1a.map(function(_1c){var _1d=[];var _1e=_1c.getGuid();var src="file?guid="+_1e;if(_1c.isA("System.FileDocument")&&_1c.get2("HasContents")){_1d.push(_1f(src,"documents/"+_1e));if(_1c.isA("System.Image")){_1d.push(_1f(src+"&thumb=true","thumbnails/"+_1e));}}return _1d;}));return _16._getDatabase().then(function(db){var _20=_16._fillBulk(fd.store,_19).run(db);var _21=_3.sequence([_20].concat(_1b),_5).map(function(_22){return;});return _6.promiseFromTask(_21);});function _1f(src,dst){return new _5(function(_23,_24){_16._downloadFileFn(src,dst,_24,_23);});};});});};return _13(this._getDatabase().then(this._deleteDatabase()).then(this._initialize()).then(function(){return _2.all(_17());}).then(_25));};_9.prototype.upload=function(_26){return _13(this._getDatabase().then(this._upload(_26)));};_9.prototype.cleanupDirtyObjects=function(){return _13(this._getDatabase().then(this._cleanupDirtyObjects()));};_9.prototype._getDatabase=function(){return _2.reject(new Error("not implemented"));};_9.prototype._initialize=function(){return _2.reject(new Error("not implemented"));};_9.prototype._deleteDatabase=function(){return _2.reject(new Error("not implemented"));};_9.prototype._fetch=function(_27){return function(db){return _2.reject(new Error("not implemented"));};};_9.prototype._fetchSlice=function(_28,_29,_2a){return function(db){return _2.reject(new Error("not implemented"));};};_9.prototype._insertOrReplace=function(_2b,obj){return function(db){return _2.reject(new Error("not implemented"));};};_9.prototype._fillBulk=function(_2c,_2d){return _7.rejected(new Error("not implemented"));};_9.prototype._upload=function(_2e){return function(db){return _2.reject(new Error("not implemented"));};};_9.prototype._cleanupDirtyObjects=function(){return _2.reject(new Error("not implemented"));};return _9;function _2f(_30){var _31={guid:_30.guid};for(var key in _30.attributes){_31[key]=_30.attributes[key].value;}return _31;};function _32(_33){return new _2(function(_34,_35){window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_33,schema:{}}},options:{callback:function(_36,_37){_34(_37.mxobjects||[]);},error:_35}});});};function _13(_38){return new _2(function(_39,_3a){return _38.then(_39,_3a);});};function _25(a){return [].concat.apply([],a);};});