/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/data-backend/OfflineDataBackend",["../applicative","../file-helpers","../file-transfer","../guid","../monad","./_DataBackend","../Task","../task-helpers","../url-helpers","mendix/lang","mendix/lib/MxObject","mendix/logger","bluebird/bluebird"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e={"String":"","Integer":"0","Long":"0","Decimal":"0","Float":"0","Currency":"0","Enum":"","HashString":"","ObjectReference":"","DateTime":null,"Boolean":false,"AutoNumber":"0","Binary":""};var _f={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_10,"Boolean":_11,"AutoNumber":null,"Binary":String};function _12(_13,_14,_15){_15=_15||{};this._store=_13;this._objectCache={};this._getStorageDir=_15.getStorageDirFn||_16;this._getDocumentUrl=_15.getDocumentUrlFn||_17;this._downloadFileFn=_15.downloadFileFn||_18;this._fetchConfig=_14;};_12.prototype=new _6();_12.prototype.getByGuid=function(_19,_1a,_1b,_1c){_d.all(_19.map(this._getByGuid.bind(this))).then(function(_1d){if(_1b){_1b(_1d.map(_1e));}}).caught(_1c);};_12.prototype.getSlice=function(_1f,_20,_21){return this._store.getSlice(_1f,_20,_21).spread(function(_22,_23){return [_22.map(_1e),_23];});};_12.prototype.create=function(_24,_25,_26,_27){var _28=_4.create();var _29=mx.meta.getEntity(_24);this._objectCache[_28]=_2a({guid:_28,$objectType:_24,$readonlyAttrs:[]},_2b(_29));if(_26){_26(_1e(this._objectCache[_28]));}};_12.prototype.save=function(_2c,_2d,_2e,_2f){var _30=this;var _31=Object.keys(_2c).map(function(_32){return _30._getByGuid(_32);});_d.all(_31).then(function(_33){_33.forEach(function(obj){var _34=obj.guid;if(!_30._objectCache[_34]){_30._objectCache[_34]=_2a({},obj);}_2a(_30._objectCache[_34],_2c[_34]);});if(_2e){_2e();}});};_12.prototype.commit=function(_35,_36,_37,_38,_39,_3a){var _3b=this;var obj=this._objectCache[_35];var _3c;if(obj){_3c=this._store.insertOrReplace(obj.$objectType,obj);}else{_3c=_d.resolve();}_3c.then(function(){delete _3b._objectCache[_35];if(_39){_39();}},_3a);};_12.prototype.rollback=function(_3d,_3e,_3f){delete this._objectCache[_3d];this._store.getByGuid(_3d).then(function(obj){if(_3e){_3e(_1e(obj));}},function(e){if(_3e){_3e(null);}});};_12.prototype.release=function(_40){};_12.prototype.saveDocument=function(_41,_42,_43,_44,_45){var _46=this;var _47="files/documents/"+_48(_41);_49(_43,_42.maxFileSize,_47,{create:true}).then(function(){var _4a={};_4a[_41]={"HasContents":true};_46.save(_4a,null,function(){_46.commit(_41,null,null,null,_44,_45);},_45);},_45);function _49(_4b,_4c,_4d,_4e){if(_4b.size/(1024*1024)>_4c){_d.rejected(new Error("File too large"));return;}return new _d(function(_4f,_50){_46._getStorageDir(_4f,_50);}).then(function(_51){var _52=_4d.split("/");var _53=_52.pop();var _54=_2.openDirectory(_51,_52).chain(function(de){return _2.createFileTask(de,_53,_4e).chain(function(fe){return _2.createWriterTask(fe).chain(function(fw){return _2.createWriteTask(fw,_43);});});});return _8.promiseFromTask(_54);});};};_12.prototype.upload=function(_55){var _56=this;var _57=this._store.upload(_55).chain(_58(_55)).chain(function(_59){var _5a=_59[0];var _5b=_59[1];return new _7(function(_5c,_5d){_56._getStorageDir(_5d,_5c);}).chain(_5e(_55,_5a,_5b));});return _8.promiseFromTask(_57);};_12.prototype.download=function(){var _5f=this;var _60=this._fetchConfig.map(function(fc){return _6f(fc.xpath).chain(function(_61){var _62=_61.map(_b2);var _63=_61.map(function(obj){return new _b({json:obj,meta:window.mx.meta.getEntity(obj.objectType)});});var _64=_bd(_63.map(function(_65){var _66=[];var _67=_65.getGuid();var src="file?guid="+_67;if(_65.isA("System.FileDocument")&&_65.get2("HasContents")){_66.push(_68(src,"documents/"+_67));if(_65.isA("System.Image")){_66.push(_68(src+"&thumb=true","thumbnails/"+_67));}}return _66;}));return _1.sequence_([_5f._store.fillBulk(fc.store,_62)].concat(_64),_7);});});return _8.promiseFromTask(_5.sequence_([this._store.resetDatabase()].concat(_60),_7));function _68(src,dst){return new _7(function(_69,_6a){_5f._downloadFileFn(src,dst,_6a,_69);});};};_12.prototype.cleanupDirtyObjects=function(){return this._store.cleanupDirtyObjects();};_12.prototype.getDocumentUrl=function(_6b,_6c,_6d){return this._getDocumentUrl(_48(_6b),_6c,_6d);};_12.prototype._getByGuid=function(_6e){if(this._objectCache[_6e]){return _d.resolve(this._objectCache[_6e]);}else{return this._store.getByGuid(_6e);}};return _12;function _6f(_70){return new _7(function(_71,_72){window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_70,schema:{}}},options:{callback:function(_73,_74){_72(_74.mxobjects||[]);},error:_71}});});};function _58(_75){return function(_76){var _77=_76.map(function(_78){var _79=new _7(function(_7a,_7b){return _75.create(_78.$objectType,false,_7b,_7a);});return _79.map(function(_7c){return [_78.guid,_7c.guid];});});var _7d=_76.filter(function(_7e){var _7f=window.mx.meta.getEntity(_7e.$objectType);return _7f.isA("System.FileDocument")&&_7e.HasContents;}).map(function(_80){return _80.guid;});return _7.parallel(_77).map(_ab).chain(function(_81){var _82=new _7(function(_83,_84){var _85=_9a(_81,_76);_75.save(_85,null,_84,_83);});var _86=_76.map(function(_87){return new _7(function(_88,_89){_75.commit(_81[_87.guid],null,null,null,_89,_88);});});var _8a=_7.parallel(_86);return _7.sequence([_82,_8a]).chain(function(_8b){return _7.of([_81,_7d]);});});};};function _5e(_8c,_8d,_8e){return function(_8f){var _90=_8e.map(function(_91){var _92=_48(_91);return _2.openDirectory(_8f,"files/documents").chain(function(de){return _2.createFileTask(de,_92,{create:false}).chain(function(fe){return _2.createGetFileBlobTask(fe).chain(function(_93){return _2.createReadAsArrayBufferTask(_93).chain(function(ab){return _94(_8d[_91],{},new Blob([ab]));});});});});});function _94(_95,_96,_97){return new _7(function(_98,_99){_8c.saveDocument(_95,_96,_97,_99,_98);});};return _1.sequence(_90,_7);};};function _9a(_9b,_9c){return _9c.reduce(function(_9d,_9e){var _9f=window.mx.meta.getEntity(_9e.$objectType);var _a0=_9f.getAttributes().filter(_a1(_9f));var _a2=_9b[_9e.guid];_9d[_a2]=_a0.reduce(function(_a3,_a4){var _a5=_9f.getAttributeType(_a4);var _a6=_f[_a5];if(!_a6){return _a3;}if(_9f.isReference(_a4)){var _a7=_9e[_a4];var _a8=_9b[_a7];if(_a8){_a3[_a4]=_a6(_a8);}else{_a3[_a4]=_a6(_a7);}}else{_a3[_a4]=_a6(_9e[_a4]);}return _a3;},{});return _9d;},{});function _a1(_a9){return function(_aa){if(/^System\./.test(_aa)){return false;}if(_aa==="changedDate"||_aa==="createdDate"){return false;}if(_a9.isA("System.FileDocument")){return _aa!=="HasContents"&&_aa!=="Contents"&&_aa!=="__UUID__"&&_aa!=="PublicThumbnailPath";}return true;};};};function _ab(arr){var _ac=arr.reduce(function(acc,_ad){acc[_ad[0]]=_ad[1];return acc;},{});return _ac;};function _1e(obj){var _ae=Object.keys(obj).filter(function(_af){return !_b0(_af);}).reduce(function(acc,key){acc[key]={value:obj[key]===null?"":obj[key],readonly:obj.$readonlyAttrs.indexOf(key)!==-1};return acc;},{});return {guid:obj.guid,objectType:obj.$objectType,attributes:_ae};function _b0(_b1){return (_b1==="guid"||_b1==="$objectType"||_b1==="$readonlyAttrs");};};function _b2(_b3){var _b4={guid:_b3.guid};for(var key in _b3.attributes){_b4[key]=_b3.attributes[key].value;}return _b4;};function _2b(_b5){return _b5.getAttributes().reduce(function(acc,_b6){acc[_b6]=_b7(_b5,_b6);return acc;},{});};function _b7(_b8,_b9){var _ba=_b8.getAttributeType(_b9);return _e[_ba];};function _18(src,dst,_bb,_bc){_3.downloadFile(_9.getStaticResourceUrlFromPath(src),{location:window.TEMPORARY,path:"files/"+dst},_bb,_bc);};function _2a(dst,src){for(var key in src){dst[key]=src[key];}return dst;};function _bd(a){return [].concat.apply([],a);};function _16(_be,_bf){_2.getFileSystem(window.TEMPORARY).then(function(fs){if(_be){_be(fs.root);}},_bf);};function _17(_c0,_c1,_c2){var dir=_c2?"thumbnails":"documents";return "filesystem:"+window.mx.appUrl+"temporary/files/"+dir+"/"+_c0+"?"+(+new Date());};function _48(_c3){return _c3.replace(/:/g,"_");};function _10(d){if(d==null){return "";}else{return String(d);}};function _11(b){return String(!!b);};});