/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/data-backend/OfflineDataBackend",["../guid","./_DataBackend","mendix/lib/MxObject","mendix/logger","bluebird/bluebird"],function(_1,_2,_3,_4,_5){var _6={"String":"","Integer":"0","Long":"0","Decimal":"0","Float":"0","Currency":"0","Enum":"","HashString":"","ObjectReference":"","DateTime":null,"Boolean":false,"AutoNumber":"0","Binary":""};function _7(_8){this._store=_8;this._objectCache={};};_7.prototype=new _2();_7.prototype.getByGuid=function(_9,_a,_b,_c){_5.all(_9.map(this._getByGuid.bind(this))).then(function(_d){if(_b){_b(_d.map(_e));}}).caught(_c);};_7.prototype.getSlice=function(_f,_10,_11){return this._store.getSlice(_f,_10,_11).spread(function(_12,_13){return [_12.map(_e),_13];});};_7.prototype.create=function(_14,_15,_16,_17){var _18=_1.create();var _19=mx.meta.getEntity(_14);this._objectCache[_18]=_1a({guid:_18,$objectType:_14,$readonlyAttrs:[]},_1b(_19));if(_16){_16(_e(this._objectCache[_18]));}};_7.prototype.save=function(_1c,_1d,_1e,_1f){var _20=this;var _21=Object.keys(_1c).map(function(_22){return _20._getByGuid(_22);});_5.all(_21).then(function(_23){_23.forEach(function(obj){var _24=obj.guid;if(!_20._objectCache[_24]){_20._objectCache[_24]=_1a({},obj);}_1a(_20._objectCache[_24],_1c[_24]);});if(_1e){_1e();}});};_7.prototype.commit=function(_25,_26,_27,_28,_29,_2a){var _2b=this;var obj=this._objectCache[_25];var _2c;if(obj){_2c=this._store.insertOrReplace(obj.$objectType,obj);}else{_2c=_5.resolve();}_2c.then(function(){delete _2b._objectCache[_25];if(_29){_29();}},_2a);};_7.prototype.rollback=function(_2d,_2e,_2f){delete this._objectCache[_2d];this._store.getByGuid(_2d).then(function(obj){if(_2e){_2e(_e(obj));}},function(e){if(_2e){_2e(null);}});};_7.prototype.release=function(_30){};_7.prototype.upload=function(_31){return this._store.upload(_31);};_7.prototype.download=function(){return this._store.download();};_7.prototype.cleanupDirtyObjects=function(){return this._store.cleanupDirtyObjects();};_7.prototype._getByGuid=function(_32){if(this._objectCache[_32]){return _5.resolve(this._objectCache[_32]);}else{return this._store.getByGuid(_32);}};return _7;function _e(obj){var _33=Object.keys(obj).filter(function(_34){return !_35(_34);}).reduce(function(acc,key){acc[key]={value:obj[key]===null?"":obj[key],readonly:obj.$readonlyAttrs.indexOf(key)!==-1};return acc;},{});return {guid:obj.guid,objectType:obj.$objectType,attributes:_33};function _35(_36){return (_36==="guid"||_36==="$objectType"||_36==="$readonlyAttrs");};};function _1b(_37){return _37.getAttributes().reduce(function(acc,_38){acc[_38]=_39(_37,_38);return acc;},{});};function _39(_3a,_3b){var _3c=_3a.getAttributeType(_3b);return _6[_3c];};function _1a(dst,src){for(var key in src){dst[key]=src[key];}return dst;};});