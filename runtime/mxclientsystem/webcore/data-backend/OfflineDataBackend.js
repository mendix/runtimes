/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/data-backend/OfflineDataBackend",["../applicative","../file-helpers","../file-transfer","../guid","../monad","../string-set","./_DataBackend","../Task","../task-helpers","../url-helpers","mendix/lang","mendix/lib/MxObject","mendix/logger","bluebird/bluebird"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){var _f={"String":"","Integer":"0","Long":"0","Decimal":"0","Float":"0","Currency":"0","Enum":"","HashString":"","ObjectReference":"","DateTime":null,"Boolean":false,"AutoNumber":"0","Binary":""};var _10={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_11,"Boolean":_12,"AutoNumber":null,"Binary":String};function _13(_14,_15,_16){_16=_16||{};this._store=_14;this._objectCache={};this._guidMap={};this._getStorageDir=_16.getStorageDirFn||_17;this._getDocumentUrl=_16.getDocumentUrlFn||_18;this._downloadFileFn=_16.downloadFileFn||_19;this._fetchConfig=_15;};_13.prototype=new _7();_13.prototype.getByGuid=function(_1a,_1b,_1c,_1d){_e.all(_1a.map(this._getByGuid.bind(this))).then(function(_1e){if(_1c){_1c(_1e.map(_1f));}}).caught(_1d);};_13.prototype.getSlice=function(_20,_21,_22){_21=_21||[];var _23=_21.map(_24.bind(this));return this._store.getSlice(_20,_23,_22).spread(function(_25,_26){var _27=_25.map(function(obj){if(this._isStoredLocalGuid(obj.guid)){this._guidMap[obj.guid]=_4.create();}Object.keys(obj).filter(function(_28){return !_ab(_28);}).filter(function(_29){var _2a=window.mx.meta.getEntity(obj.$objectType);return _2a.isReference(_29);}).forEach(function(_2b){if(this._isStoredLocalGuid(obj[_2b])){this._guidMap[obj[_2b]]=_4.create();}},this);return this._makeObjectExternal(obj);},this).map(_1f);return [_27,_26];}.bind(this));function _24(_2c){var _2d=mx.meta.getEntity(_20);if(!_2d.isReference(_2c.attribute)){return _2c;}_2c.value=this._getInternalGuid(_2c.value);return _2c;};};_13.prototype.create=function(_2e,_2f,_30,_31){var _32=_4.create();var _33=mx.meta.getEntity(_2e);this._guidMap[_32]=_32;this._objectCache[_32]=_34({guid:_32,$objectType:_2e,$readonlyAttrs:[]},_35(_33));if(_30){_30(_1f(this._objectCache[_32]));}};_13.prototype.save=function(_36,_37,_38,_39){var _3a=this;var _3b=Object.keys(_36).map(function(_3c){return _3a._getByGuid(_3c);});_e.all(_3b).then(function(_3d){_3d.forEach(function(obj){var _3e=obj.guid;if(!_3a._objectCache[_3e]){_3a._objectCache[_3e]=_34({},obj);}_34(_3a._objectCache[_3e],_36[_3e]);});if(_38){_38();}});};_13.prototype.commit=function(_3f,_40,_41,_42,_43,_44){var _45=this;var _46;if(_3f in this._objectCache){var _47=this._makeObjectInternal(this._objectCache[_3f]);var _48=this._calculateAutoCommitGuids(_3f).map(function(_49){return this._makeObjectInternal(this._objectCache[_49]);},this);_46=this._store.insertOrReplace(_47,_48);}else{_46=_e.resolve();}_46.then(function(){delete _45._objectCache[_3f];if(_43){_43();}},_44);};_13.prototype.rollback=function(_4a,_4b,_4c){var _4d=this;delete this._objectCache[_4a];var _4e=this._getInternalGuid(_4a);this._store.getByGuid(_4e).then(function(_4f){var _50;if(_4f.$autocommitted===1){_50=_4d._store.fetchDirty().chain(function(_51){var _52=_4d._store.deleteObject(_4f.$objectType,_4e);var _53=_51.reduce(function(acc,_54){var _55=window.mx.meta.getEntity(_54.$objectType);var _56=_55.getReferenceAttributes().filter(function(_57){return _54[_57]===_4e;});if(_56.length>0){_56.reduce(function(acc,_58){acc[_58]="";return acc;},_54);acc.push(_4d._store.updateObject(_54.$objectType,_54));}return acc;},[]);return _1.sequence_(_53.concat([_52]),_8);});}else{_50=_8.of();}_9.promiseFromTask(_50).then(function(){var _59=_4d._makeObjectExternal(_4f);if(_4b){_4b(_1f(_59));}});},function(e){if(_4b){_4b(null);}});};_13.prototype.release=function(_5a){};_13.prototype.saveDocument=function(_5b,_5c,_5d,_5e,_5f,_60){var _61=this;var _62="files/documents/"+_63(this._getInternalGuid(_5b));_64(_5e,_5d.maxFileSize,_62,{create:true}).then(function(){var _65={};_65[_5b]={"HasContents":true};_61.save(_65,null,function(){_61.commit(_5b,null,null,null,_5f,_60);},_60);},_60);function _64(_66,_67,_68,_69){if(_66.size/(1024*1024)>_67){_e.rejected(new Error("File too large"));return;}return new _e(function(_6a,_6b){_61._getStorageDir(_6a,_6b);}).then(function(_6c){var _6d=_68.split("/");var _6e=_6d.pop();var _6f=_2.openDirectory(_6c,_6d).chain(function(de){return _2.createFileTask(de,_6e,_69).chain(function(fe){return _2.createWriterTask(fe).chain(function(fw){return _2.createWriteTask(fw,_5e);});});});return _9.promiseFromTask(_6f);});};};_13.prototype.reset=function(){return this._store.resetDatabase();};_13.prototype.upload=function(_70){var _71=this;return this._store.upload(_70).chain(function(_72){return _73(_72).chain(function(_74){return _7c(_72,_74).chain(function(){_84.call(_71,_74);var _75=_89(_72);return _71._createGetStorageDirTask().map(function(_76){return _be(_70,_76,_74,_75);});});});});function _73(_77){var _78=_77.map(function(_79){var _7a=_ca(_70,_79.$objectType);return _7a.map(function(_7b){return [_79.guid,_7b.guid];});});return _1.sequence(_78,_8).map(_c9);};function _7c(_7d,_7e){var _7f=_df(_7e,_7d);var _80=_cf(_70,_7f);var _81=_7d.map(function(_82){return _d4(_70,_7e[_82.guid]);});var _83=_1.sequence_(_81,_8);return _5.sequence_([_80,_83],_8);};function _84(_85){Object.keys(_85).forEach(function(_86){var _87=_85[_86];var _88=this._guidMap[_86];this._guidMap[_87]=_88;delete this._guidMap[_86];delete this._objectCache[_88];},this);};function _89(_8a){return _8a.filter(function(_8b){var _8c=window.mx.meta.getEntity(_8b.$objectType);return _8c.isA("System.FileDocument")&&_8b.HasContents;}).map(function(_8d){return _8d.guid;});};};_13.prototype.download=function(){return this._store.resetDatabase().chain(function(){var _8e=this._fetchConfig.map(_8f.bind(this));return _5.sequence(_8e,_8);}.bind(this)).map(function(_90){var _91=_c9(_fe(_90));return _91;});function _8f(_92){return _b8(_92.xpath).chain(function(_93){var _94=_93.map(_f5);var _95=_94.map(_97.bind(this));var _96=this._store.fillBulk(_92.store,_93.map(_f2));return _96.map(function(){return _95;});}.bind(this));};function _97(_98){var _99=[];var _9a=_98.getGuid();var src="file?guid="+_9a;if(_98.isA("System.FileDocument")&&_98.get2("HasContents")){_99.push(this._createFileTransferTask(src,"documents/"+_9a));if(_98.isA("System.Image")){_99.push(this._createFileTransferTask(src+"&thumb=true","thumbnails/"+_9a));}}return [_9a,_1.sequence_(_99,_8)];};};_13.prototype.cleanupDirtyObjects=function(){return this._store.cleanupDirtyObjects();};_13.prototype.getDocumentUrl=function(_9b,_9c,_9d){return this._getDocumentUrl(_63(this._getInternalGuid(_9b)),_9c,_9d);};_13.prototype._createGetStorageDirTask=function(){return new _8(function(_9e,_9f){this._getStorageDir(_9f,_9e);}.bind(this));};_13.prototype._createFileTransferTask=function(src,dst){return new _8(function(_a0,_a1){this._downloadFileFn(src,dst,_a1,_a0);}.bind(this));};_13.prototype._getByGuid=function(_a2){if(this._objectCache[_a2]){return _e.resolve(this._objectCache[_a2]);}else{return this._store.getByGuid(this._getInternalGuid(_a2)).then(function(obj){return this._makeObjectExternal(obj);}.bind(this));}};_13.prototype._getInternalGuid=function(_a3){for(var ig in this._guidMap){if(this._guidMap[ig]===_a3){return ig;}}return _a3;};_13.prototype._getExternalGuid=function(_a4){return this._guidMap[_a4]||_a4;};_13.prototype._makeObjectInternal=function(_a5){return this._remapGuidsInObject(_a5,this._getInternalGuid.bind(this));};_13.prototype._makeObjectExternal=function(_a6){return this._remapGuidsInObject(_a6,this._getExternalGuid.bind(this));};_13.prototype._remapGuidsInObject=function(obj,_a7){return Object.keys(obj).reduce(function(acc,_a8){var _a9=window.mx.meta.getEntity(obj.$objectType);var _aa=_a8==="guid"||!_ab(_a8)&&_a9.isReference(_a8);acc[_a8]=_aa?_a7(obj[_a8]):obj[_a8];return acc;},{});};_13.prototype._isStoredLocalGuid=function(_ac){return /^GUID:/.test(_ac)&&this._guidMap[_ac]==null;};_13.prototype._getReferenceGuids=function(_ad){var obj=this._objectCache[_ad];var _ae=window.mx.meta.getEntity(obj.$objectType);var _af=_ae.getReferenceAttributes().map(function(_b0){return obj[_b0];}).filter(function(_b1){return _b1!=null&&_b1!==""&&_b1 in this._objectCache;},this);return _6.of(_af);};_13.prototype._calculateAutoCommitGuids=function(_b2){var _b3=this;var _b4=_6.empty();var _b5=this._getReferenceGuids(_b2);while(_b4.length()!==_b5.length()){var _b6=_b5.reduce(function(acc,_b7){return acc.or(_b3._getReferenceGuids(_b7));},_6.empty());_b4=_b5;_b5=_b5.or(_b6);}_b5.remove(_b2);return _b5.values();};return _13;function _b8(_b9){return new _8(function(_ba,_bb){window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_b9,schema:{}}},options:{callback:function(_bc,_bd){_bb(_bd.mxobjects||[]);},error:_ba}});});};function _be(_bf,_c0,_c1,_c2){var _c3=_c2.map(function(_c4){var _c5=_63(_c4);var _c6=_2.openDirectory(_c0,"files/documents").chain(function(de){return _2.createFileTask(de,_c5,{create:false});}).chain(_2.createGetFileBlobTask).chain(_2.createReadAsArrayBufferTask);var _c7=_c6.chain(function(ab){return _c8(_bf,_c1[_c4],{},new Blob([ab]));});return [_c4,_c7];});return _c9(_c3);};function _ca(_cb,_cc){return new _8(function(_cd,_ce){return _cb.create(_cc,false,_ce,_cd);});};function _cf(_d0,_d1){return new _8(function(_d2,_d3){_d0.save(_d1,null,_d3,_d2);});};function _d4(_d5,_d6){return new _8(function(_d7,_d8){_d5.commit(_d6,null,null,null,_d8,_d7);});};function _c8(_d9,_da,_db,_dc){return new _8(function(_dd,_de){_d9.saveDocument(_da,null,_db,_dc,_de,_dd);});};function _df(_e0,_e1){return _e1.reduce(function(_e2,_e3){var _e4=window.mx.meta.getEntity(_e3.$objectType);var _e5=_e4.getAttributes().filter(_e4.isSyncable.bind(_e4));var _e6=_e0[_e3.guid];_e2[_e6]=_e5.reduce(function(_e7,_e8){var _e9=_e4.getAttributeType(_e8);var _ea=_10[_e9];if(!_ea){return _e7;}if(_e4.isReference(_e8)){var _eb=_e3[_e8];var _ec=_e0[_eb];if(_ec){_e7[_e8]=_ea(_ec);}else{_e7[_e8]=_ea(_eb);}}else{_e7[_e8]=_ea(_e3[_e8]);}return _e7;},{});return _e2;},{});};function _c9(arr){var _ed=arr.reduce(function(acc,_ee){acc[_ee[0]]=_ee[1];return acc;},{});return _ed;};function _1f(obj){var _ef=Object.keys(obj).filter(function(_f0){return !_ab(_f0);}).reduce(function(acc,key){acc[key]={value:obj[key]===null?"":obj[key],readonly:obj.$readonlyAttrs.indexOf(key)!==-1};return acc;},{});return {guid:obj.guid,objectType:obj.$objectType,attributes:_ef};};function _ab(_f1){return (_f1==="guid"||_f1==="$objectType"||_f1==="$readonlyAttrs");};function _f2(_f3){var _f4={guid:_f3.guid};for(var key in _f3.attributes){_f4[key]=_f3.attributes[key].value;}return _f4;};function _f5(obj){return new _c({json:obj,meta:window.mx.meta.getEntity(obj.objectType)});};function _35(_f6){return _f6.getAttributes().reduce(function(acc,_f7){acc[_f7]=_f8(_f6,_f7);return acc;},{});};function _f8(_f9,_fa){var _fb=_f9.getAttributeType(_fa);return _f[_fb];};function _19(src,dst,_fc,_fd){_3.downloadFile(_a.getStaticResourceUrlFromPath(src),{location:window.TEMPORARY,path:"files/"+dst},_fc,_fd);};function _34(dst,src){for(var key in src){dst[key]=src[key];}return dst;};function _fe(a){return [].concat.apply([],a);};function _17(_ff,_100){_2.getFileSystem(window.TEMPORARY).then(function(fs){if(_ff){_ff(fs.root);}},_100);};function _18(_101,_102,_103){var dir=_103?"thumbnails":"documents";return "filesystem:"+window.mx.appUrl+"temporary/files/"+dir+"/"+_101+"?"+(+new Date());};function _63(guid){return guid.replace(/:/g,"_");};function _11(d){if(d==null){return "";}else{return String(d);}};function _12(b){return String(!!b);};});