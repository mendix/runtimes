/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/data-backend/OfflineDataBackend",["../applicative","../file-helpers","../file-transfer","../guid","../monad","./_DataBackend","../Task","../task-helpers","../url-helpers","mendix/lang","mendix/lib/MxObject","mendix/logger","bluebird/bluebird"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e={"String":"","Integer":"0","Long":"0","Decimal":"0","Float":"0","Currency":"0","Enum":"","HashString":"","ObjectReference":"","DateTime":null,"Boolean":false,"AutoNumber":"0","Binary":""};var _f={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_10,"Boolean":_11,"AutoNumber":null,"Binary":String};function _12(_13,_14,_15){_15=_15||{};this._store=_13;this._objectCache={};this._getStorageDir=_15.getStorageDirFn||_16;this._getDocumentUrl=_15.getDocumentUrlFn||_17;this._downloadFileFn=_15.downloadFileFn||_18;this._fetchConfig=_14;};_12.prototype=new _6();_12.prototype.getByGuid=function(_19,_1a,_1b,_1c){_d.all(_19.map(this._getByGuid.bind(this))).then(function(_1d){if(_1b){_1b(_1d.map(_1e));}}).caught(_1c);};_12.prototype.getSlice=function(_1f,_20,_21){return this._store.getSlice(_1f,_20,_21).spread(function(_22,_23){return [_22.map(_1e),_23];});};_12.prototype.create=function(_24,_25,_26,_27){var _28=_4.create();var _29=mx.meta.getEntity(_24);this._objectCache[_28]=_2a({guid:_28,$objectType:_24,$readonlyAttrs:[]},_2b(_29));if(_26){_26(_1e(this._objectCache[_28]));}};_12.prototype.save=function(_2c,_2d,_2e,_2f){var _30=this;var _31=Object.keys(_2c).map(function(_32){return _30._getByGuid(_32);});_d.all(_31).then(function(_33){_33.forEach(function(obj){var _34=obj.guid;if(!_30._objectCache[_34]){_30._objectCache[_34]=_2a({},obj);}_2a(_30._objectCache[_34],_2c[_34]);});if(_2e){_2e();}});};_12.prototype.commit=function(_35,_36,_37,_38,_39,_3a){var _3b=this;var obj=this._objectCache[_35];var _3c;if(obj){_3c=this._store.insertOrReplace(obj.$objectType,obj);}else{_3c=_d.resolve();}_3c.then(function(){delete _3b._objectCache[_35];if(_39){_39();}},_3a);};_12.prototype.rollback=function(_3d,_3e,_3f){delete this._objectCache[_3d];this._store.getByGuid(_3d).then(function(obj){if(_3e){_3e(_1e(obj));}},function(e){if(_3e){_3e(null);}});};_12.prototype.release=function(_40){};_12.prototype.saveDocument=function(_41,_42,_43,_44,_45,_46){var _47=this;var _48="files/documents/"+_49(_41);_4a(_44,_43.maxFileSize,_48,{create:true}).then(function(){var _4b={};_4b[_41]={"HasContents":true};_47.save(_4b,null,function(){_47.commit(_41,null,null,null,_45,_46);},_46);},_46);function _4a(_4c,_4d,_4e,_4f){if(_4c.size/(1024*1024)>_4d){_d.rejected(new Error("File too large"));return;}return new _d(function(_50,_51){_47._getStorageDir(_50,_51);}).then(function(_52){var _53=_4e.split("/");var _54=_53.pop();var _55=_2.openDirectory(_52,_53).chain(function(de){return _2.createFileTask(de,_54,_4f).chain(function(fe){return _2.createWriterTask(fe).chain(function(fw){return _2.createWriteTask(fw,_44);});});});return _8.promiseFromTask(_55);});};};_12.prototype.upload=function(_56){var _57=this;var _58=this._store.upload(_56).chain(_59(_56)).chain(function(_5a){var _5b=_5a[0];var _5c=_5a[1];return new _7(function(_5d,_5e){_57._getStorageDir(_5e,_5d);}).chain(_5f(_56,_5b,_5c));});return _8.promiseFromTask(_58);};_12.prototype.download=function(){var _60=this;var _61=this._fetchConfig.map(function(fc){return _70(fc.xpath).chain(function(_62){var _63=_62.map(_b3);var _64=_62.map(function(obj){return new _b({json:obj,meta:window.mx.meta.getEntity(obj.objectType)});});var _65=_be(_64.map(function(_66){var _67=[];var _68=_66.getGuid();var src="file?guid="+_68;if(_66.isA("System.FileDocument")&&_66.get2("HasContents")){_67.push(_69(src,"documents/"+_68));if(_66.isA("System.Image")){_67.push(_69(src+"&thumb=true","thumbnails/"+_68));}}return _67;}));return _1.sequence_([_60._store.fillBulk(fc.store,_63)].concat(_65),_7);});});return _8.promiseFromTask(_5.sequence_([this._store.resetDatabase()].concat(_61),_7));function _69(src,dst){return new _7(function(_6a,_6b){_60._downloadFileFn(src,dst,_6b,_6a);});};};_12.prototype.cleanupDirtyObjects=function(){return this._store.cleanupDirtyObjects();};_12.prototype.getDocumentUrl=function(_6c,_6d,_6e){return this._getDocumentUrl(_49(_6c),_6d,_6e);};_12.prototype._getByGuid=function(_6f){if(this._objectCache[_6f]){return _d.resolve(this._objectCache[_6f]);}else{return this._store.getByGuid(_6f);}};return _12;function _70(_71){return new _7(function(_72,_73){window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_71,schema:{}}},options:{callback:function(_74,_75){_73(_75.mxobjects||[]);},error:_72}});});};function _59(_76){return function(_77){var _78=_77.map(function(_79){var _7a=new _7(function(_7b,_7c){return _76.create(_79.$objectType,false,_7c,_7b);});return _7a.map(function(_7d){return [_79.guid,_7d.guid];});});var _7e=_77.filter(function(_7f){var _80=window.mx.meta.getEntity(_7f.$objectType);return _80.isA("System.FileDocument")&&_7f.HasContents;}).map(function(_81){return _81.guid;});return _7.parallel(_78).map(_ac).chain(function(_82){var _83=new _7(function(_84,_85){var _86=_9b(_82,_77);_76.save(_86,null,_85,_84);});var _87=_77.map(function(_88){return new _7(function(_89,_8a){_76.commit(_82[_88.guid],null,null,null,_8a,_89);});});var _8b=_7.parallel(_87);return _7.sequence([_83,_8b]).chain(function(_8c){return _7.of([_82,_7e]);});});};};function _5f(_8d,_8e,_8f){return function(_90){var _91=_8f.map(function(_92){var _93=_49(_92);return _2.openDirectory(_90,"files/documents").chain(function(de){return _2.createFileTask(de,_93,{create:false}).chain(function(fe){return _2.createGetFileBlobTask(fe).chain(function(_94){return _2.createReadAsArrayBufferTask(_94).chain(function(ab){return _95(_8e[_92],{},new Blob([ab]));});});});});});function _95(_96,_97,_98){return new _7(function(_99,_9a){_8d.saveDocument(_96,null,_97,_98,_9a,_99);});};return _1.sequence(_91,_7);};};function _9b(_9c,_9d){return _9d.reduce(function(_9e,_9f){var _a0=window.mx.meta.getEntity(_9f.$objectType);var _a1=_a0.getAttributes().filter(_a2(_a0));var _a3=_9c[_9f.guid];_9e[_a3]=_a1.reduce(function(_a4,_a5){var _a6=_a0.getAttributeType(_a5);var _a7=_f[_a6];if(!_a7){return _a4;}if(_a0.isReference(_a5)){var _a8=_9f[_a5];var _a9=_9c[_a8];if(_a9){_a4[_a5]=_a7(_a9);}else{_a4[_a5]=_a7(_a8);}}else{_a4[_a5]=_a7(_9f[_a5]);}return _a4;},{});return _9e;},{});function _a2(_aa){return function(_ab){if(/^System\./.test(_ab)){return false;}if(_ab==="changedDate"||_ab==="createdDate"){return false;}if(_aa.isA("System.FileDocument")){return _ab!=="HasContents"&&_ab!=="Contents"&&_ab!=="__UUID__"&&_ab!=="PublicThumbnailPath";}return true;};};};function _ac(arr){var _ad=arr.reduce(function(acc,_ae){acc[_ae[0]]=_ae[1];return acc;},{});return _ad;};function _1e(obj){var _af=Object.keys(obj).filter(function(_b0){return !_b1(_b0);}).reduce(function(acc,key){acc[key]={value:obj[key]===null?"":obj[key],readonly:obj.$readonlyAttrs.indexOf(key)!==-1};return acc;},{});return {guid:obj.guid,objectType:obj.$objectType,attributes:_af};function _b1(_b2){return (_b2==="guid"||_b2==="$objectType"||_b2==="$readonlyAttrs");};};function _b3(_b4){var _b5={guid:_b4.guid};for(var key in _b4.attributes){_b5[key]=_b4.attributes[key].value;}return _b5;};function _2b(_b6){return _b6.getAttributes().reduce(function(acc,_b7){acc[_b7]=_b8(_b6,_b7);return acc;},{});};function _b8(_b9,_ba){var _bb=_b9.getAttributeType(_ba);return _e[_bb];};function _18(src,dst,_bc,_bd){_3.downloadFile(_9.getStaticResourceUrlFromPath(src),{location:window.TEMPORARY,path:"files/"+dst},_bc,_bd);};function _2a(dst,src){for(var key in src){dst[key]=src[key];}return dst;};function _be(a){return [].concat.apply([],a);};function _16(_bf,_c0){_2.getFileSystem(window.TEMPORARY).then(function(fs){if(_bf){_bf(fs.root);}},_c0);};function _17(_c1,_c2,_c3){var dir=_c3?"thumbnails":"documents";return "filesystem:"+window.mx.appUrl+"temporary/files/"+dir+"/"+_c1+"?"+(+new Date());};function _49(_c4){return _c4.replace(/:/g,"_");};function _10(d){if(d==null){return "";}else{return String(d);}};function _11(b){return String(!!b);};});