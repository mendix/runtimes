/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/data-backend/OfflineDataBackend",["../applicative","../file-helpers","../file-transfer","../guid","../monad","../string-set","./_DataBackend","../Task","../task-helpers","../url-helpers","mendix/lang","mendix/lib/MxObject","mendix/logger","bluebird/bluebird"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){var _f={"String":"","Integer":"0","Long":"0","Decimal":"0","Float":"0","Currency":"0","Enum":"","HashString":"","ObjectReference":"","DateTime":null,"Boolean":false,"AutoNumber":"0","Binary":""};var _10={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_11,"Boolean":_12,"AutoNumber":null,"Binary":String};function _13(_14,_15,_16){_16=_16||{};this._store=_14;this._objectCache={};this._guidMap={};this._getStorageDir=_16.getStorageDirFn||_17;this._getDocumentUrl=_16.getDocumentUrlFn||_18;this._downloadFileFn=_16.downloadFileFn||_19;this._fetchConfig=_15;};_13.prototype=new _7();_13.prototype.getByGuid=function(_1a,_1b,_1c,_1d){_e.all(_1a.map(this._getByGuid.bind(this))).then(function(_1e){if(_1c){_1c(_1e.map(_1f));}}).caught(_1d);};_13.prototype.getSlice=function(_20,_21,_22){_21=_21||[];var _23=_21.map(_24.bind(this));return this._store.getSlice(_20,_23,_22).spread(function(_25,_26){var _27=_25.map(function(obj){if(this._isStoredLocalGuid(obj.guid)){this._guidMap[obj.guid]=_4.create();}Object.keys(obj).filter(function(_28){return !_ac(_28);}).filter(function(_29){var _2a=window.mx.meta.getEntity(obj.$objectType);return _2a.isReference(_29);}).forEach(function(_2b){if(this._isStoredLocalGuid(obj[_2b])){this._guidMap[obj[_2b]]=_4.create();}},this);return this._makeObjectExternal(obj);},this).map(_1f);return [_27,_26];}.bind(this));function _24(_2c){var _2d=mx.meta.getEntity(_20);if(!_2d.isReference(_2c.attribute)){return _2c;}_2c.value=this._getInternalGuid(_2c.value);return _2c;};};_13.prototype.create=function(_2e,_2f,_30,_31){var _32=_4.create();var _33=mx.meta.getEntity(_2e);this._guidMap[_32]=_32;this._objectCache[_32]=_34({guid:_32,$objectType:_2e,$readonlyAttrs:[]},_35(_33));if(_30){_30(_1f(this._objectCache[_32]));}};_13.prototype.save=function(_36,_37,_38,_39){var _3a=this;var _3b=Object.keys(_36).map(function(_3c){return _3a._getByGuid(_3c);});_e.all(_3b).then(function(_3d){_3d.forEach(function(obj){var _3e=obj.guid;if(!_3a._objectCache[_3e]){_3a._objectCache[_3e]=_34({},obj);}_34(_3a._objectCache[_3e],_36[_3e]);});if(_38){_38();}});};_13.prototype.commit=function(_3f,_40,_41,_42,_43,_44){var _45=this;var _46;if(_3f in this._objectCache){var _47=this._makeObjectInternal(this._objectCache[_3f]);var _48=this._calculateAutoCommitGuids(_3f).map(function(_49){return this._makeObjectInternal(this._objectCache[_49]);},this);_46=this._store.insertOrReplace(_47,_48);}else{_46=_e.resolve();}_46.then(function(){delete _45._objectCache[_3f];if(_43){_43();}},_44);};_13.prototype.rollback=function(_4a,_4b,_4c){var _4d=this;delete this._objectCache[_4a];var _4e=this._getInternalGuid(_4a);this._store.getByGuid(_4e).then(function(_4f){var _50;if(_4f.$autocommitted===1){_50=_4d._store.fetchDirty().chain(function(_51){var _52=_4d._store.deleteObject(_4f.$objectType,_4e);var _53=_51.reduce(function(acc,_54){var _55=window.mx.meta.getEntity(_54.$objectType);var _56=_55.getReferenceAttributes().filter(function(_57){return _54[_57]===_4e;});if(_56.length>0){_56.reduce(function(acc,_58){acc[_58]="";return acc;},_54);acc.push(_4d._store.updateObject(_54.$objectType,_54));}return acc;},[]);return _1.sequence_(_53.concat([_52]),_8);});}else{_50=_8.of();}_9.promiseFromTask(_50).then(function(){var _59=_4d._makeObjectExternal(_4f);if(_4b){_4b(_1f(_59));}});},function(e){if(_4b){_4b(null);}});};_13.prototype.release=function(_5a){};_13.prototype.saveDocument=function(_5b,_5c,_5d,_5e,_5f,_60){var _61=this;var _62="files/documents/"+_63(this._getInternalGuid(_5b));_64(_5e,_5d.maxFileSize,_62,{create:true}).then(function(){var _65={};_65[_5b]={"HasContents":true};_61.save(_65,null,function(){_61.commit(_5b,null,null,null,_5f,_60);},_60);},_60);function _64(_66,_67,_68,_69){if(_66.size/(1024*1024)>_67){_e.rejected(new Error("File too large"));return;}return new _e(function(_6a,_6b){_61._getStorageDir(_6a,_6b);}).then(function(_6c){var _6d=_68.split("/");var _6e=_6d.pop();var _6f=_2.openDirectory(_6c,_6d).chain(function(de){return _2.createFileTask(de,_6e,_69).chain(function(fe){return _2.createWriterTask(fe).chain(function(fw){return _2.createWriteTask(fw,_5e);});});});return _9.promiseFromTask(_6f);});};};_13.prototype.reset=function(){return this._store.resetDatabase();};_13.prototype.upload=function(_70){var _71=this;return this._store.upload(_70).chain(function(_72){return _73(_72).chain(function(_74){return _7c(_72,_74).chain(function(){_84.call(_71,_74);var _75=_89(_72);return _71._createGetStorageDirTask().map(function(_76){return _bf(_70,_76,_74,_75);});});});});function _73(_77){var _78=_77.map(function(_79){var _7a=_cb(_70,_79.$objectType);return _7a.map(function(_7b){return [_79.guid,_7b.guid];});});return _1.sequence(_78,_8).map(_ca);};function _7c(_7d,_7e){var _7f=_e0(_7e,_7d);var _80=_d0(_70,_7f);var _81=_7d.map(function(_82){return _d5(_70,_7e[_82.guid]);});var _83=_1.sequence_(_81,_8);return _5.sequence_([_80,_83],_8);};function _84(_85){Object.keys(_85).forEach(function(_86){var _87=_85[_86];var _88=this._guidMap[_86];this._guidMap[_87]=_88;delete this._guidMap[_86];delete this._objectCache[_88];},this);};function _89(_8a){return _8a.filter(function(_8b){var _8c=window.mx.meta.getEntity(_8b.$objectType);return _8c.isA("System.FileDocument")&&_8b.HasContents;}).map(function(_8d){return _8d.guid;});};};_13.prototype.download=function(){return this._store.resetDatabase().chain(function(){var _8e=this._fetchConfig.map(_8f.bind(this));return _5.sequence(_8e,_8);}.bind(this)).map(function(_90){var _91=_ca(_ff(_90));return _91;});function _8f(_92){return _b9(_92.xpath).chain(function(_93){var _94=_93.map(_f6);var _95=_94.map(_97.bind(this));var _96=this._store.fillBulk(_92.store,_93.map(_f3));return _96.map(function(){return _95;});}.bind(this));};function _97(_98){var _99=[];var _9a=_98.getGuid();var _9b=_98.get2("changedDate");if(_98.isA("System.FileDocument")&&_98.get2("HasContents")){_99.push(this._createFileTransferTask(_a.getDynamicResourcePath(_9a,_9b),"documents/"+_9a));if(_98.isA("System.Image")){_99.push(this._createFileTransferTask(_a.getDynamicResourcePath(_9a,_9b,true),"thumbnails/"+_9a));}}return [_9a,_1.sequence_(_99,_8)];};};_13.prototype.cleanupDirtyObjects=function(){return this._store.cleanupDirtyObjects();};_13.prototype.getDocumentUrl=function(_9c,_9d,_9e){return this._getDocumentUrl(_63(this._getInternalGuid(_9c)),_9d,_9e);};_13.prototype._createGetStorageDirTask=function(){return new _8(function(_9f,_a0){this._getStorageDir(_a0,_9f);}.bind(this));};_13.prototype._createFileTransferTask=function(src,dst){return new _8(function(_a1,_a2){this._downloadFileFn(src,dst,_a2,_a1);}.bind(this));};_13.prototype._getByGuid=function(_a3){if(this._objectCache[_a3]){return _e.resolve(this._objectCache[_a3]);}else{return this._store.getByGuid(this._getInternalGuid(_a3)).then(function(obj){return this._makeObjectExternal(obj);}.bind(this));}};_13.prototype._getInternalGuid=function(_a4){for(var ig in this._guidMap){if(this._guidMap[ig]===_a4){return ig;}}return _a4;};_13.prototype._getExternalGuid=function(_a5){return this._guidMap[_a5]||_a5;};_13.prototype._makeObjectInternal=function(_a6){return this._remapGuidsInObject(_a6,this._getInternalGuid.bind(this));};_13.prototype._makeObjectExternal=function(_a7){return this._remapGuidsInObject(_a7,this._getExternalGuid.bind(this));};_13.prototype._remapGuidsInObject=function(obj,_a8){return Object.keys(obj).reduce(function(acc,_a9){var _aa=window.mx.meta.getEntity(obj.$objectType);var _ab=_a9==="guid"||!_ac(_a9)&&_aa.isReference(_a9);acc[_a9]=_ab?_a8(obj[_a9]):obj[_a9];return acc;},{});};_13.prototype._isStoredLocalGuid=function(_ad){return /^GUID:/.test(_ad)&&this._guidMap[_ad]==null;};_13.prototype._getReferenceGuids=function(_ae){var obj=this._objectCache[_ae];var _af=window.mx.meta.getEntity(obj.$objectType);var _b0=_af.getReferenceAttributes().map(function(_b1){return obj[_b1];}).filter(function(_b2){return _b2!=null&&_b2!==""&&_b2 in this._objectCache;},this);return _6.of(_b0);};_13.prototype._calculateAutoCommitGuids=function(_b3){var _b4=this;var _b5=_6.empty();var _b6=this._getReferenceGuids(_b3);while(_b5.length()!==_b6.length()){var _b7=_b6.reduce(function(acc,_b8){return acc.or(_b4._getReferenceGuids(_b8));},_6.empty());_b5=_b6;_b6=_b6.or(_b7);}_b6.remove(_b3);return _b6.values();};return _13;function _b9(_ba){return new _8(function(_bb,_bc){window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_ba,schema:{}}},options:{callback:function(_bd,_be){_bc(_be.mxobjects||[]);},error:_bb}});});};function _bf(_c0,_c1,_c2,_c3){var _c4=_c3.map(function(_c5){var _c6=_63(_c5);var _c7=_2.openDirectory(_c1,"files/documents").chain(function(de){return _2.createFileTask(de,_c6,{create:false});}).chain(_2.createGetFileBlobTask).chain(_2.createReadAsArrayBufferTask);var _c8=_c7.chain(function(ab){return _c9(_c0,_c2[_c5],{},new Blob([ab]));});return [_c5,_c8];});return _ca(_c4);};function _cb(_cc,_cd){return new _8(function(_ce,_cf){return _cc.create(_cd,false,_cf,_ce);});};function _d0(_d1,_d2){return new _8(function(_d3,_d4){_d1.save(_d2,null,_d4,_d3);});};function _d5(_d6,_d7){return new _8(function(_d8,_d9){_d6.commit(_d7,null,null,null,_d9,_d8);});};function _c9(_da,_db,_dc,_dd){return new _8(function(_de,_df){_da.saveDocument(_db,null,_dc,_dd,_df,_de);});};function _e0(_e1,_e2){return _e2.reduce(function(_e3,_e4){var _e5=window.mx.meta.getEntity(_e4.$objectType);var _e6=_e5.getAttributes().filter(_e5.isSyncable.bind(_e5));var _e7=_e1[_e4.guid];_e3[_e7]=_e6.reduce(function(_e8,_e9){var _ea=_e5.getAttributeType(_e9);var _eb=_10[_ea];if(!_eb){return _e8;}if(_e5.isReference(_e9)){var _ec=_e4[_e9];var _ed=_e1[_ec];if(_ed){_e8[_e9]=_eb(_ed);}else{_e8[_e9]=_eb(_ec);}}else{_e8[_e9]=_eb(_e4[_e9]);}return _e8;},{});return _e3;},{});};function _ca(arr){var _ee=arr.reduce(function(acc,_ef){acc[_ef[0]]=_ef[1];return acc;},{});return _ee;};function _1f(obj){var _f0=Object.keys(obj).filter(function(_f1){return !_ac(_f1);}).reduce(function(acc,key){acc[key]={value:obj[key]===null?"":obj[key],readonly:obj.$readonlyAttrs.indexOf(key)!==-1};return acc;},{});return {guid:obj.guid,objectType:obj.$objectType,attributes:_f0};};function _ac(_f2){return (_f2==="guid"||_f2==="$objectType"||_f2==="$readonlyAttrs");};function _f3(_f4){var _f5={guid:_f4.guid};for(var key in _f4.attributes){_f5[key]=_f4.attributes[key].value;}return _f5;};function _f6(obj){return new _c({json:obj,meta:window.mx.meta.getEntity(obj.objectType)});};function _35(_f7){return _f7.getAttributes().reduce(function(acc,_f8){acc[_f8]=_f9(_f7,_f8);return acc;},{});};function _f9(_fa,_fb){var _fc=_fa.getAttributeType(_fb);return _f[_fc];};function _19(src,dst,_fd,_fe){_3.downloadFile(_a.getStaticResourceUrlFromPath(src),{location:window.TEMPORARY,path:"files/"+dst},_fd,_fe);};function _34(dst,src){for(var key in src){dst[key]=src[key];}return dst;};function _ff(a){return [].concat.apply([],a);};function _17(_100,_101){_2.getFileSystem(window.TEMPORARY).then(function(fs){if(_100){_100(fs.root);}},_101);};function _18(_102,_103,_104){var dir=_104?"thumbnails":"documents";return "filesystem:"+window.mx.appUrl+"temporary/files/"+dir+"/"+_102+"?"+(+new Date());};function _63(guid){return guid.replace(/:/g,"_");};function _11(d){if(d==null){return "";}else{return String(d);}};function _12(b){return String(!!b);};});