/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/data-backend/OfflineDataBackend",["../applicative","../file-helpers","../file-transfer","../guid","../monad","../string-set","./_DataBackend","../Task","../task-helpers","../url-helpers","mendix/lang","mendix/lib/MxObject","mendix/logger","bluebird/bluebird"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){var _f={"String":"","Integer":"0","Long":"0","Decimal":"0","Float":"0","Currency":"0","Enum":"","HashString":"","ObjectReference":"","DateTime":null,"Boolean":false,"AutoNumber":"0","Binary":""};var _10={"String":String,"Integer":String,"Long":String,"Decimal":String,"Float":String,"Currency":String,"Enum":String,"HashString":String,"ObjectReference":String,"DateTime":_11,"Boolean":_12,"AutoNumber":null,"Binary":String};function _13(_14,_15,_16){_16=_16||{};this._store=_14;this._objectCache={};this._guidMap={};this._getStorageDir=_16.getStorageDirFn||_17;this._getDocumentUrl=_16.getDocumentUrlFn||_18;this._downloadFileFn=_16.downloadFileFn||_19;this._fetchConfig=_15;};_13.prototype=new _7();_13.prototype.getByGuid=function(_1a,_1b,_1c,_1d){_e.all(_1a.map(this._getByGuid.bind(this))).then(function(_1e){if(_1c){_1c(_1e.map(_1f));}}).caught(_1d);};_13.prototype.getSlice=function(_20,_21,_22){_21=_21||[];var _23=_21.map(_24.bind(this));return this._store.getSlice(_20,_23,_22).spread(function(_25,_26){var _27=_25.map(function(obj){if(this._isStoredLocalGuid(obj.guid)){this._guidMap[obj.guid]=_4.create();}Object.keys(obj).filter(function(_28){return !_ae(_28);}).filter(function(_29){var _2a=window.mx.meta.getEntity(obj.$objectType);return _2a.isReference(_29);}).forEach(function(_2b){if(this._isStoredLocalGuid(obj[_2b])){this._guidMap[obj[_2b]]=_4.create();}},this);return this._makeObjectExternal(obj);},this).map(_1f);return [_27,_26];}.bind(this));function _24(_2c){var _2d=mx.meta.getEntity(_20);if(!_2d.isReference(_2c.attribute)){return _2c;}_2c.value=this._getInternalGuid(_2c.value);return _2c;};};_13.prototype.create=function(_2e,_2f,_30,_31){var _32=_4.create();var _33=mx.meta.getEntity(_2e);this._guidMap[_32]=_32;this._objectCache[_32]=_34({guid:_32,$objectType:_2e,$readonlyAttrs:[]},_35(_33));if(_30){_30(_1f(this._objectCache[_32]));}};_13.prototype.save=function(_36,_37,_38,_39){var _3a=this;var _3b=Object.keys(_36).map(function(_3c){return _3a._getByGuid(_3c);});_e.all(_3b).then(function(_3d){_3d.forEach(function(obj){var _3e=obj.guid;if(!_3a._objectCache[_3e]){_3a._objectCache[_3e]=_34({},obj);}_34(_3a._objectCache[_3e],_36[_3e]);});if(_38){_38();}});};_13.prototype.commit=function(_3f,_40,_41,_42,_43,_44){var _45=this;var _46;if(_3f in this._objectCache){var _47=this._makeObjectInternal(this._objectCache[_3f]);var _48=this._calculateAutoCommitGuids(_3f).map(function(_49){return this._makeObjectInternal(this._objectCache[_49]);},this);_46=this._store.insertOrReplace(_47,_48);}else{_46=_e.resolve();}_46.then(function(){delete _45._objectCache[_3f];if(_43){_43();}},_44);};_13.prototype.rollback=function(_4a,_4b,_4c){var _4d=this;delete this._objectCache[_4a];var _4e=this._getInternalGuid(_4a);this._store.getByGuid(_4e).then(function(_4f){var _50;if(_4f.$autocommitted===1){_50=_4d._store.fetchDirty().chain(function(_51){var _52=_4d._store.deleteObject(_4f.$objectType,_4e);var _53=_51.reduce(function(acc,_54){var _55=window.mx.meta.getEntity(_54.$objectType);var _56=_55.getReferenceAttributes().filter(function(_57){return _54[_57]===_4e;});if(_56.length>0){_56.reduce(function(acc,_58){acc[_58]="";return acc;},_54);acc.push(_4d._store.updateObject(_54.$objectType,_54));}return acc;},[]);return _1.sequence_(_53.concat([_52]),_8);});}else{_50=_8.of();}_9.promiseFromTask(_50).then(function(){var _59=_4d._makeObjectExternal(_4f);if(_4b){_4b(_1f(_59));}});},function(e){if(_4b){_4b(null);}});};_13.prototype.release=function(_5a){};_13.prototype.saveDocument=function(_5b,_5c,_5d,_5e,_5f,_60){var _61=this;var _62="files/documents/"+_63(this._getInternalGuid(_5b));_64(_5e,_5d.maxFileSize,_62,{create:true}).then(function(){var _65={};_65[_5b]={"HasContents":true};_61.save(_65,null,function(){_61.commit(_5b,null,null,null,_5f,_60);},_60);},_60);function _64(_66,_67,_68,_69){if(_66.size/(1024*1024)>_67){_e.rejected(new Error("File too large"));return;}return new _e(function(_6a,_6b){_61._getStorageDir(_6a,_6b);}).then(function(_6c){var _6d=_68.split("/");var _6e=_6d.pop();var _6f=_2.openDirectory(_6c,_6d).chain(function(de){return _2.createFileTask(de,_6e,_69).chain(function(fe){return _2.createWriterTask(fe).chain(function(fw){return _2.createWriteTask(fw,_5e);});});});return _9.promiseFromTask(_6f);});};};_13.prototype.reset=function(){return this._store.resetDatabase();};_13.prototype.upload=function(_70){var _71=this;return this._store.upload(_70).chain(function(_72){return _73(_72).chain(function(_74){return _7c(_72,_74).chain(function(){_84.call(_71,_74);var _75=_89(_72);return _71._createGetStorageDirTask().map(function(_76){return _c1(_70,_76,_74,_75);});});});});function _73(_77){var _78=_77.map(function(_79){var _7a=_cd(_70,_79.$objectType);return _7a.map(function(_7b){return [_79.guid,_7b.guid];});});return _1.sequence(_78,_8).map(_cc);};function _7c(_7d,_7e){var _7f=_e2(_7e,_7d);var _80=_d2(_70,_7f);var _81=_7d.map(function(_82){return _d7(_70,_7e[_82.guid]);});var _83=_1.sequence_(_81,_8);return _5.sequence_([_80,_83],_8);};function _84(_85){Object.keys(_85).forEach(function(_86){var _87=_85[_86];var _88=this._guidMap[_86];this._guidMap[_87]=_88;delete this._guidMap[_86];delete this._objectCache[_88];},this);};function _89(_8a){return _8a.filter(function(_8b){var _8c=window.mx.meta.getEntity(_8b.$objectType);return _8c.isA("System.FileDocument")&&_8b.HasContents;}).map(function(_8d){return _8d.guid;});};};_13.prototype.download=function(){var _8e=_1.sequence(this._fetchConfig.map(function(_8f){return _bb(_8f.xpath).map(function(_90){var _91=_90.map(_f8);var _92=_91.map(_93.bind(this));return {fileDownloadTaskPairs:_92,rebuildPairsList:[_8f.store,_90.map(_f5)]};}.bind(this));}.bind(this)),_8);return _8e.chain(function(_94){var _95=_94.map(function(_96){return _96.fileDownloadTaskPairs;});var _97=_94.map(function(_98){return _98.rebuildPairsList;});return this._store.rebuildDatabase(_97).map(function(){var _99=_cc(_101(_95));return _99;});}.bind(this));function _93(_9a){var _9b=[];var _9c=_9a.getGuid();var _9d=_9a.get2("changedDate");if(_9a.isA("System.FileDocument")&&_9a.get2("HasContents")){_9b.push(this._createFileTransferTask(_a.getDynamicResourcePath(_9c,_9d),"documents/"+_9c));if(_9a.isA("System.Image")){_9b.push(this._createFileTransferTask(_a.getDynamicResourcePath(_9c,_9d,true),"thumbnails/"+_9c));}}return [_9c,_1.sequence_(_9b,_8)];};};_13.prototype.cleanupDirtyObjects=function(){return this._store.cleanupDirtyObjects();};_13.prototype.getDocumentUrl=function(_9e,_9f,_a0){return this._getDocumentUrl(_63(this._getInternalGuid(_9e)),_9f,_a0);};_13.prototype._createGetStorageDirTask=function(){return new _8(function(_a1,_a2){this._getStorageDir(_a2,_a1);}.bind(this));};_13.prototype._createFileTransferTask=function(src,dst){return new _8(function(_a3,_a4){this._downloadFileFn(src,dst,_a4,_a3);}.bind(this));};_13.prototype._getByGuid=function(_a5){if(this._objectCache[_a5]){return _e.resolve(this._objectCache[_a5]);}else{return this._store.getByGuid(this._getInternalGuid(_a5)).then(function(obj){return this._makeObjectExternal(obj);}.bind(this));}};_13.prototype._getInternalGuid=function(_a6){for(var ig in this._guidMap){if(this._guidMap[ig]===_a6){return ig;}}return _a6;};_13.prototype._getExternalGuid=function(_a7){return this._guidMap[_a7]||_a7;};_13.prototype._makeObjectInternal=function(_a8){return this._remapGuidsInObject(_a8,this._getInternalGuid.bind(this));};_13.prototype._makeObjectExternal=function(_a9){return this._remapGuidsInObject(_a9,this._getExternalGuid.bind(this));};_13.prototype._remapGuidsInObject=function(obj,_aa){return Object.keys(obj).reduce(function(acc,_ab){var _ac=window.mx.meta.getEntity(obj.$objectType);var _ad=_ab==="guid"||!_ae(_ab)&&_ac.isReference(_ab);acc[_ab]=_ad?_aa(obj[_ab]):obj[_ab];return acc;},{});};_13.prototype._isStoredLocalGuid=function(_af){return /^GUID:/.test(_af)&&this._guidMap[_af]==null;};_13.prototype._getReferenceGuids=function(_b0){var obj=this._objectCache[_b0];var _b1=window.mx.meta.getEntity(obj.$objectType);var _b2=_b1.getReferenceAttributes().map(function(_b3){return obj[_b3];}).filter(function(_b4){return _b4!=null&&_b4!==""&&_b4 in this._objectCache;},this);return _6.of(_b2);};_13.prototype._calculateAutoCommitGuids=function(_b5){var _b6=this;var _b7=_6.empty();var _b8=this._getReferenceGuids(_b5);while(_b7.length()!==_b8.length()){var _b9=_b8.reduce(function(acc,_ba){return acc.or(_b6._getReferenceGuids(_ba));},_6.empty());_b7=_b8;_b8=_b8.or(_b9);}_b8.remove(_b5);return _b8.values();};return _13;function _bb(_bc){return new _8(function(_bd,_be){window.mx.server.request({request:{action:"retrieve_by_xpath",params:{xpath:_bc,schema:{}}},options:{callback:function(_bf,_c0){_be(_c0.mxobjects||[]);},error:_bd}});});};function _c1(_c2,_c3,_c4,_c5){var _c6=_c5.map(function(_c7){var _c8=_63(_c7);var _c9=_2.openDirectory(_c3,"files/documents").chain(function(de){return _2.createFileTask(de,_c8,{create:false});}).chain(_2.createGetFileBlobTask).chain(_2.createReadAsArrayBufferTask);var _ca=_c9.chain(function(ab){return _cb(_c2,_c4[_c7],{},new Blob([ab]));});return [_c7,_ca];});return _cc(_c6);};function _cd(_ce,_cf){return new _8(function(_d0,_d1){return _ce.create(_cf,false,_d1,_d0);});};function _d2(_d3,_d4){return new _8(function(_d5,_d6){_d3.save(_d4,null,_d6,_d5);});};function _d7(_d8,_d9){return new _8(function(_da,_db){_d8.commit(_d9,null,null,null,_db,_da);});};function _cb(_dc,_dd,_de,_df){return new _8(function(_e0,_e1){_dc.saveDocument(_dd,null,_de,_df,_e1,_e0);});};function _e2(_e3,_e4){return _e4.reduce(function(_e5,_e6){var _e7=window.mx.meta.getEntity(_e6.$objectType);var _e8=_e7.getAttributes().filter(_e7.isSyncable.bind(_e7));var _e9=_e3[_e6.guid];_e5[_e9]=_e8.reduce(function(_ea,_eb){var _ec=_e7.getAttributeType(_eb);var _ed=_10[_ec];if(!_ed){return _ea;}if(_e7.isReference(_eb)){var _ee=_e6[_eb];var _ef=_e3[_ee];if(_ef){_ea[_eb]=_ed(_ef);}else{_ea[_eb]=_ed(_ee);}}else{_ea[_eb]=_ed(_e6[_eb]);}return _ea;},{});return _e5;},{});};function _cc(arr){var _f0=arr.reduce(function(acc,_f1){acc[_f1[0]]=_f1[1];return acc;},{});return _f0;};function _1f(obj){var _f2=Object.keys(obj).filter(function(_f3){return !_ae(_f3);}).reduce(function(acc,key){acc[key]={value:obj[key]===null?"":obj[key],readonly:obj.$readonlyAttrs.indexOf(key)!==-1};return acc;},{});return {guid:obj.guid,objectType:obj.$objectType,attributes:_f2};};function _ae(_f4){return (_f4==="guid"||_f4==="$objectType"||_f4==="$readonlyAttrs");};function _f5(_f6){var _f7={guid:_f6.guid};for(var key in _f6.attributes){_f7[key]=_f6.attributes[key].value;}return _f7;};function _f8(obj){return new _c({json:obj,meta:window.mx.meta.getEntity(obj.objectType)});};function _35(_f9){return _f9.getAttributes().reduce(function(acc,_fa){acc[_fa]=_fb(_f9,_fa);return acc;},{});};function _fb(_fc,_fd){var _fe=_fc.getAttributeType(_fd);return _f[_fe];};function _19(src,dst,_ff,_100){_3.downloadFile(_a.getStaticResourceUrlFromPath(src),{location:window.TEMPORARY,path:"files/"+dst},_ff,_100);};function _34(dst,src){for(var key in src){dst[key]=src[key];}return dst;};function _101(a){return [].concat.apply([],a);};function _17(_102,_103){_2.getFileSystem(window.TEMPORARY).then(function(fs){if(_102){_102(fs.root);}},_103);};function _18(_104,_105,_106){var dir=_106?"thumbnails":"documents";return "filesystem:"+window.mx.appUrl+"temporary/files/"+dir+"/"+_104+"?"+(+new Date());};function _63(guid){return guid.replace(/:/g,"_");};function _11(d){if(d==null){return "";}else{return String(d);}};function _12(b){return String(!!b);};});