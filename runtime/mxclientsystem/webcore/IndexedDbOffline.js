/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("webcore/IndexedDbOffline",["mendix/lib/MxObject","./IndexedDatabase","./SynchronousPromise"],function(_1,_2,_3){var _4={name:"MendixDatabase",version:1};var _5=window.shimIndexedDB;var _6=window.shimIndexedDB.modules.IDBKeyRange;return {getDatabase:function(_7){if(!_8){_8=_9(_7);}return _8;},deleteDatabase:function(){return new _3(function(_a,_b){var _c=_5.deleteDatabase(_4.name);_c.onsuccess=function(){_8=null;_a();};_c.onerror=_b;});},fetch:function(_d){return function(db){return db.transaction(["_guidToStore"],function(_e){return _e.store("_guidToStore").key(_d).get(function(_f){return db.transaction([_f.store],function(_10){return _10.store(_f.store).key(_d).get(function(obj){return [obj,_f.store];});});});});};},fetchSlice:function(_11,_12){return function(db){return new _3(function(_13,_14){return db.transaction([_11],function(_15){var _16=_15.store(_11);var _17=_43(_12);var _18;if(_17){_18=_16.index(_17.attr,null,_17.dir);}else{_18=_16.cursor();}return _18.offset(_12.offset||0).limit(_12.limit||0).toArray(function(_19){_16.count().then(function(_1a){_13([_19,_1a]);});}).caught(_14);});});};},fetchSliceReference:function(_1b,_1c,_1d,_1e){return function(db){return new _3(function(_1f,_20){return db.transaction([_1b],function(_21){var _22=_21.store(_1b);var _23=_43(_1e);var _24=_22.index(_1c.replace(".","$"),_6.only(_1d));return _24.toArray(function(_25){if(_23){_25.sort(function(_26,_27){var _28=_23.dir==="desc"?-1:1;return _28*_5.cmp(_26[_23.attr],_27[_23.attr]);});}var _29=_1e.offset||0;var end=_29+(_1e.limit||_25.length);_1f([_25.slice(_29,end),_25.length]);}).caught(_20);});});};},fillBulk:function(_2a,_2b){return function(db){return db.transaction(["_guidToStore",_2a],"readwrite",function(_2c){var _2d=_2c.store("_guidToStore");var _2e=_2c.store(_2a);_2b.forEach(function(obj){_2d.add({guid:obj.guid,store:_2a});_2e.add(obj);});});};},serialize:function(obj){var _2f={};for(var key in obj){_2f[_30(key)]=obj[key];}return _2f;},deserialize:function(obj){var _31={};for(var _32 in obj){_31[_33(_32)]=obj[_32];}return _31;}};function _30(key){return key.replace(".","$");};function _33(_34){return _34.replace("$",".");};var _8=null;function _9(_35){_8=_36(_4.name,_4.version,function(db){db.createObjectStore("_guidToStore",{keyPath:"guid"});for(var e in _35){var _37=_35[e];db.createObjectStore(e,{keyPath:"guid"},function(_38){_37.forEach(function(_39){var _3a=_30(_39);_38.createIndex(_3a,_3a,{unique:false});});});}});return _8;};function _36(_3b,_3c,_3d){return new _3(function(_3e,_3f){var _40=_5.open(_3b,_3c);_40.onerror=_3f;_40.onsuccess=function(_41){var db=_41.target.result;db.onversionchange=function(){db.close();_8=null;};_3e(new _2(db));};_40.onupgradeneeded=function(_42){if(_3d){_3d(new _2(_42.target.result));}};});};function _43(_44){if(_44&&_44.sort&&_44.sort[0]){if(!_44.sort[0][0]){throw new Error("Invalid sorting attribute");}return {attr:_44.sort[0][0],dir:_44.sort[0][1]=="desc"?"prev":"next"};}else{return null;}};});