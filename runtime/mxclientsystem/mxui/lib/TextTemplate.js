/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/lib/TextTemplate",["mendix/lang","mxui/dom","dojo/Deferred","dojo/promise/all","dojo/_base/array","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6){var _7=_6(null,{_template:null,_callback:null,_rootObject:null,_subscriptions:null,_pendingFetch:null,constructor:function(_8,_9){this._template=_8;this._callback=_9;this._subscriptions=[];},update:function(_a,_b){this._rootObject=_a;this._clearSubscriptions();if(!this._template.parameters){this._callback(this._template.text);if(_b){_b();}}else{if(!_a){this._callback("");if(_b){_b();}}else{this._reload(_b);}}},destroy:function(){this._clearSubscriptions();},_reload:function(_c){var _d=this;if(this._pendingFetch){this._pendingFetch.cancel();}this._pendingFetch=this._fetchObjects();this._pendingFetch.then(function(_e){_d._pendingFetch=null;_d._addSubscriptions(_e);var _f=_d._fillTemplate(_e);_d._callback(_2.convertNlToBr(_2.escapeString(_f)));if(_c){_c();}});},_fetchObjects:function(){var _10={};_1.forEach(this._template.parameters,function(_11,key){_10[key]=new _3();var _12=_11.split("/"),_13=_12.pop();this._rootObject.fetch(_12,function(obj){var _14={obj:obj,attr:_13,path:_11};_10[key].resolve(_14);});},this);return _4(_10);},_fillTemplate:function(_15){var _16=this;return this._template.text.replace(/(?:^|[^\{])(?:\{\{)*(\{(\d+)\})/g,function(_17,_18,_19){var arg=_15[_19];return _17.replace(_18,_16._renderAttrValue(arg.obj,arg.attr));}).replace(/\{\{/g,"{");},_renderAttrValue:function(obj,_1a){return obj?window.mx.parser.formatAttribute(obj,_1a):"";},_addSubscriptions:function(_1b){this._addSubscription(this._rootObject);_1.forEach(_1b,function(arg){var _1c=arg.path.split("/");if(_1c.length>2){this._addSubscription(this._rootObject,_1c[1]);}if(arg.obj){this._addSubscription(arg.obj);this._addSubscription(arg.obj,arg.attr);}},this);},_addSubscription:function(obj,_1d){var _1e=_5.some(this._subscriptions,function(sub){return sub.guid===obj.getGuid()&&sub.attr===_1d;});if(_1e){return;}var _1f=this;var _20={attr:_1d,guid:obj.getGuid(),callback:function(){_1f._reload();}};this._subscriptions.push({attr:_1d,guid:obj.getGuid(),handle:window.mx.data.subscribe(_20)});},_clearSubscriptions:function(){while(this._subscriptions.length){window.mx.data.unsubscribe(this._subscriptions.pop().handle);}}});return _7;});