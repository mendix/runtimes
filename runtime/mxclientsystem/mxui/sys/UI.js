
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/sys/UI",["dojo","dijit","dojox","dojo/i18n!dojo/cldr/nls/number","dojo/i18n!dojo/cldr/nls/gregorian","dojo/require!mxui/io/iframe,mxui/cldr/supplemental"],function(_1,_2,_3){_1.provide("mxui.sys.UI");_1.require("mxui.io.iframe");_1.require("mxui.cldr.supplemental");mxui.sys.UI=function(_4){_4=_4||{};var _5=this,_6="mxui.sys.UI",_7=false,_8=false,_9=null,_a=null,_b=null,_c=null,_d=null,_e=null,_f=null,_10={},_11={},_12={},_13=false,_14="en_US",_15=null,_16=null,_17="",_18="desktop",_19="Mendix 5",_1a=[],_1b=false,_1c=new mxui.lib.WindowManager();var _1d={buddhist:/th$/,hebrew:null,islamic:null};var _1e=function(_1f){_1.addOnLoad(function(){_13=document.body.dir.toLowerCase()=="rtl";_9=document.getElementById("content");if(!_9){mx.ui.exception("You are using an outdated index template. Please update your index template.");return;}_1.connect(window,"resize",_1.hitch(_5,"resize"));_1f();});};var _20=function(_21){var _22=mx.server.getCacheBust(),url="widgets/widgets.js";mxui.dom.addCss("widgets/widgets.css?"+_22);_1.registerModulePath("widgets","../../widgets");mx.server.get({url:url,handleAs:"text",failOk:true,load:function(_23){_1["eval"](_23+"\r\n//@ sourceURL="+url);_21();},error:function(){var _24=mx.session.getConfig("uiconfig.widgets");for(var i=0,_25;_25=_24[i];i++){var _26=_25.split(".");_1.registerModulePath(_26[0],mx.modulePath+_26[0]);try{_1["require"](_25);}catch(e){logger.error(_6+".getWidgets: failed loading widget "+_25);}}_21();}});};var _27=function(_28){var _29=mx.session.getConfig("uiconfig.modules");for(var i=0,_2a;_2a=_29[i];i++){try{_1["require"](_2a+"."+_2a);}catch(e){logger.error(_6+".getModules: failed loading module "+_2a);}}_28();};var _2b=function(){_1a=_1.map(mx.session.getUserRoles("Name"),function(_2c){return "role-"+_2c.toLowerCase();});_1.addClass(document.body,_1a);_1.addClass(document.body,"profile-"+_18);document.title=_19;};var _2d=function(){_1.removeClass(document.body,_1a);_1.removeClass(document.body,"profile-"+_18);_1a=[];document.title="";};var _2e=function(_2f){if(_8){_2f();}else{_1.connect(mx,"onError",function(e){var msg;if(e instanceof mendix.lib.DescribedServerError){msg=e.message;}else{if(e instanceof mendix.lib.ConnectionError){msg=_5.translate("mxui.sys.UI","connection_error");}else{if(e instanceof mendix.lib.ServerError){msg=_5.translate("mxui.sys.UI","internal_error");}else{msg=_5.translate("mxui.sys.UI","internal_error");}}}_b&&_b.hide();_b=_5.exception(msg);logger.error(e);});_30();mendix.lang.collect([_20,_27,_1e],_2f);}};var _31=function(){for(var m in _1d){var re=_1d[m];if(re&&re.test(_1.locale.toLowerCase())){return m;}}return "";};var _32=function(){var _33=_31();if(_33){_17="dojox.date."+_33;_1["require"](_17);_1["require"](_17+".locale");_1["requireLocalization"]("dojo.cldr",_33);}};var _34=function(){_1.requireLocalization("dojo.cldr","number");_1.requireLocalization("dojo.cldr","gregorian");_32();};var _30=function(){if(_1.isIE){if(JSON.stringify(document.createElement("input").value)==="\"null\""){var _35=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value").get;Object.defineProperty(HTMLInputElement.prototype,"value",{get:function(){var _36=_35.call(this);return _36===""?"":_36;}});}_1.connect(document,"onclick",function(e){var _37=e.target;if(_37.nodeName=="TEXTAREA"||_37.nodeName=="INPUT"&&(_37.type=="text"||_37.type=="password")){if(document.activeElement!=_37){var sel=mxui.dom.getSelection(_37);try{_37.focus();}catch(e){}mxui.dom.selectTextRange(_37,sel.start,sel.end);}}if(_1.isIE<=8){if(_37.nodeName=="INPUT"&&_37.type=="checkbox"){mxui.html.dispatchEvent(_37,"onchange");}}});}};var _38=function(){var map={"mendix":"mxui","mendix.core.MxServer":"mendix.core.Server","mendix.widget.MxDataView":"mendix.widget.MxFormView","mendix.widget.MxNavigator":"mendix.widget.Navigator","mendix.widget.MxDataGrid":"mendix.widget.DataGrid","mendix.widget.DataGrid.true":"mxui.common.true","mendix.widget.DataGrid.false":"mxui.common.false","mendix.core.MxServer.invalid_session":"mendix.session.session_expired","mobile.widget.Dialog.ok":"mxui.widget.DialogMessage.ok","mxui.widget.Dialog.error":"mxui.widget.DialogMessage.error","mxui.widget.Dialog.information":"mxui.widget.DialogMessage.info","mxui.widget.Dialog.warning":"mxui.widget.DialogMessage.warning","mxui.widget.Dialog.confirmation":"mxui.widget.Confirmation.caption","mobile.widget":"mxui.widget","mobile.sys":"mxui.sys"};for(var _39 in map){var _3a=_39.split("."),_3b=map[_39].split("."),_3c=_3a.pop(),_3d=_3b.pop(),_3e=_15,_3f=_3e,_40;while(_3e&&(_40=_3a.shift())){_3e=_3e[_40];}if(_3e){while(_40=_3b.shift()){_3f=_3f[_40]=_3f[_40]||{};}if(_3f[_3d]){_1.mixin(_3f[_3d],_3e[_3c]);}else{_3f[_3d]=_3e[_3c];}}}};var _41=function(){var _42=_5.decodeUrlHash(_1.hash());_42?_42():mx.remote.execute(mx.session.getConfig());};var _43=function(_44){if(_44.xml){var _45=mxui.dom.create("div"),_46=_44.childNodes;for(var i=0,_47;_47=_46[i];i++){_45.innerHTML+=_47.xml;}_44=_45;}else{_44=document.importNode(_44,true);}var _48=_44.getElementsByTagName("*");for(var l=_48.length-1,_49;_49=_48[l];l--){var _4a=_49.getAttribute("data-mendix-roles");if(!mx.session.hasSomeRole(_4a)){_49.parentNode.removeChild(_49);}else{_49.removeAttribute("data-mendix-roles");}}var _4b=document.createDocumentFragment();while(_44.firstChild){_4b.appendChild(_44.firstChild);}return _4b;};var _4c=function(_4d,xml){var _4e=xml.documentElement,fid=_4e.getAttribute("id"),_4f=_4e.getAttribute("title"),_50=_4e.getAttribute("class"),_51=_4e.getAttribute("style"),_52=_4e.childNodes;for(var i=0,_53;_53=_52[i];i++){if(_53.nodeType!=1){continue;}switch(_53.localName||_53.baseName){case "content":_10[_4d]={id:fid,path:_4d,title:_4f,"class":_50||"",style:_51||"",content:_43(_53)};break;case "templates":var _54=_53.childNodes;for(var j=0,_55;_55=_54[j];j++){if(_55.nodeType!=1){continue;}var wid=_55.getAttribute("widget-id"),_56=_55.getAttribute("name"),_57=_43(_55);if(!_11[wid]){_11[wid]={};}_11[wid][_56]=_57;}}}return _10[_4d];};var _58=function(msg,_59,_5a){return new mxui.widget.DialogMessage({type:_59,content:""+_5.extractMessage(msg),modal:_5a});};var _5b=function(_5c){_12[_5c.id]=_5c;var _5d=_1.connect(_5c,"onAfterHide",function(){_1.disconnect(_5d);delete _12[_5c.id];_5c.destroy();});_5c.show();return _5c;};var _5e=function(){var id;for(id in _12){_12[id].hide();}};var _5f=function(_60,dir,_61){var _62=mxui.currentForm,_63=_62&&_62.domNode,_64=_60.domNode,_65=function(){_60.onAfterShow();_62&&_62.onAfterHide();window.scrollTo(0,_60._scrollPos||1);_1b=false;_61&&_61();};mxui.currentForm=_60;if(_63!=_64){_60.onBeforeShow();if(_63){var _66=window.pageYOffset;_62._scrollPos=_66;window.scrollTo(0,1);setTimeout(function(){_62.onBeforeHide();_1.removeClass(_64,"mx-page-hidden");setTimeout(function(){mxui.dom.orphan(_63);_1.addClass(_63,"mx-page-hidden");},0);_65();},0);}else{_1.removeClass(_64,"mx-page-hidden");_65();}}};var _67=function(_68,_69,_6a){var dir=_69.dir,_6b=_69.params,_6c=_69.error,_6d=_69.instance,_6e=_69.callback;if(_1b){_6e&&_6e();return;}else{_1b=true;}mxui.currentForm&&mxui.currentForm.suspend();var _6f=function(_70){_70.applyContext(_69.context||new mendix.lib.MxContext(),function(){document.title=_19+" - "+_70.getTitle();_5f(_70,dir,function(){if(!_6d){_c.register(_70);}_6e&&_6e.call(_6a,_70);});});};if(_6d){_9.appendChild(_6d.domNode);_6d.resume();_6f(_6d);}else{_5.getForm(_68,{params:_1.mixin(_6b,{place:"content",title:_69.title}),error:function(e){_1b=false;_6c&&_6c.call(_6a,e);},callback:function(_71){_1.addClass(_71.domNode,"mx-page-hidden");_1.connect(_71,"dispose",function(){mx.ui.back();});_9.appendChild(_71.domNode);_71.startup(function(){_6f(_71);});}});}};var _72=function(_73,_74,_75){var _76=_74.params,_77=_74.error,_78=_74.callback;_73=_73.replace(/\.mxf/,"$Popup.mxf");_5.getForm(_73,{params:_1.mixin(_76,{place:"popup",title:_74.title}),error:function(e){_77&&_77.call(_75,e);},callback:function(_79){_1c.show(_79,_74,_1.hitch(_75,_78));}});};var _7a=function(_7b,_7c,_7d){var _7e=_7c.params,_7f=_7c.error,_80=_7c.callback;_7b=_7b.replace(/\.mxf/,"$Popup.mxf");_5.getForm(_7b,{params:_1.mixin(_7e,{place:"custom",title:_7c.title}),error:function(e){_7f&&_7f.call(_7d,e);},callback:function(_81){_7c.domNode.appendChild(_81.domNode);_1.removeClass(_81.domNode,"mx-page mx-page-hidden");_81.startup(function(){_81.applyContext(_7c.context||new mendix.lib.MxContext(),function(){_80&&_80.call(_7d,_81);});});}});};var _82=function(fmt,_83){if(!_83){return fmt;}else{if(!(_83 instanceof Array)){_83=[_83];}}return fmt.replace(/\{(\d+)\}/g,function(_84,n){var _85=_83[n-1];if(_85!=null){return _85;}else{return _84;}});};var _86=function(_87,_88){return function(_89){var _8a=[];var end=function(){for(var i=_8a.length;i--;){_1.disconnect(_8a[i]);}_89&&_89();_1.removeClass(_87,_88);};_8a.push(_1.connect(_87,"webkitAnimationEnd",end),_1.connect(_87,"animationend",end));_1.addClass(_87,_88);};};var _8b=function(_8c,_8d,_8e){_86(_8c,_8d)(_8e);};this.toString=function(){return _6;};this.isLoaded=function(){return _7;};this.startup=function(_8f){var _90=mx.session.getConfig("uiconfig");_14=_90.locale;_1.locale=_1.i18n.normalizeLocale(_14.replace("_","-"));_15=_90.translations;_16=_90.menubars;_2d();_18=_90.profile.name.toLowerCase();_19=_90.profile.title;_2b();_38();_c=new mxui.lib.History();_e=_e||new mxui.widget.Progress();_f=_f||new mxui.widget.Underlay();_2e(function(){_c.startup();_34();_41();_7=true;_8=true;_8f();});};this.shutdown=function(){_1c.hideAll();_5e();mxui.currentForm=null;_10={};_11={};_17="";_c.destroy();_1.disconnect(_d);_2d();_7=false;};this.getProfile=function(){return _18;};this.getMenu=function(_91){return _16[_91]||[];};this.getDatePackage=function(){return _17||"dojo.date";};this.isRtl=function(){return _13;};this.resize=function(e){mxui.currentForm&&mxui.currentForm.resize();};this.execute=function(_92,_93,_94){var cfg={};if(_92.microflow){_1.mixin(cfg,_92.microflow,_93);mx.ui.action(cfg.name,cfg,_94);}else{if(_92.form){_1.mixin(cfg,_92.form,_93);mx.ui.openForm(cfg.path,cfg,_94);}else{logger.error(_6+".execute: unknown action type");}}};this.action=function(_95,_96,_97){_96=_96||{};_1.setObject("params.actionname",_95,_96);var _98=_96.callback,_99=_96.error,_9a=_1.mixin({caller:mxui.currentForm},_96.store),_9b;if("progress" in _96){_9b=this.getProgress(_96.progressMsg,_96.progress=="modal");_9b.start();}mx.data.action({callback:function(_9c){_9b&&_9b.stop();_98&&_98.call(_97,_9c);},error:function(e){_9b&&_9b.stop();if(_99){_99.call(_97,e);}else{if(e&&!(e instanceof mendix.lib.ValidationError)){mx.onError(e);}}},context:_96.context,async:_96.async,params:_96.params,store:_9a});};this.back=function(){_c.back();};this.showProgress=function(msg,_9d){return _e.add(msg||_5.translate("mxui.sys.UI","loading"),_9d);};this.hideProgress=function(id){return _e.remove(id);};this.showUnderlay=function(_9e){_f.show(_9e);};this.hideUnderlay=function(_9f){_f.hide(_9f);};this.getProgress=function(msg,_a0){var id,_a1;return {start:function(){if(_a1){return id;}else{_a1=true;return id=_5.showProgress(msg,_a0);}},stop:function(){if(_a1){_a1=false;_5.hideProgress(id);}}};};this.setupLoginPage=function(){var _a2=mx.session.getConfig("profile");if(_a2){_18=_a2.name.toLowerCase();_1.addClass(document.body,"profile-"+_18);document.title=_a2.title;}};this.showLogin=function(_a3){var _a4=_1.cookie("originURI");if(_a4){_1.cookie("originURI","");window.location=_a4;return;}var _a5=function(_a6){if(_1.cookie.isSupported()){if(_a6&&_a6.http_code==402){_5.exception(window.i18nMap.http402);}else{_a=_a||new mxui.widget.Login();_a.show(_a6);}}else{_5.exception("This application requires cookies to be enabled");}};mx.server.get({url:"js/login_i18n.js",handleAs:"javascript",load:function(){_1.addOnLoad(function(){_a5(_a3);});}});_5.showLogin=_a5;};this.hideLogin=function(){_a&&_a.hide();};this.openForm=function(_a7,_a8,_a9){_a8=_a8||{};var pid=this.showProgress(),cb=_a8.callback,_aa=_a8.error;_a8.callback=function(_ab){_5.hideProgress(pid);cb&&cb.call(this,_ab);};_a8.error=function(e){_5.hideProgress(pid);if(_aa){_aa&&_aa.call(this,e);}else{mx.onError(e);}};if(_a8.domNode){_7a(_a7,_a8,_a9);}else{if(/popup|modal/.test(_a8.location)){_72(_a7,_a8,_a9);}else{_67(_a7,_a8,_a9);}}};this.getForm=function(_ac,_ad,_ae){_ad=_ad||{};var _af=_ad.params,_b0=_ad.error,_b1=_ad.callback;if(_ac in _10){var _b2=_1.clone(_10[_ac]);_b1&&_b1.call(_ae,new mxui.lib.Form(_b2,_af));}else{mx.server.get({url:"pages/"+_14+"/"+_ac,handleAs:"xml",load:function(xml){var _b3=_1.clone(_4c(_ac,xml)),_b4=new mxui.lib.Form(_b3,_af);_b1&&_b1.call(_ae,_b4);},error:function(e){logger.error(_6+".getForm: error occurred while fetching form '"+_ac+"': "+e);_b0&&_b0.call(_ae,e);}});}};this.getTemplate=function(id,_b5){var _b6=_11[id];return _b6&&_1.clone(_b6[_b5]);};this.applyToNode=function(_b7,_b8){var wid=_b8.getAttribute("widgetId"),_b9=wid&&_2.byId(wid);switch(_b7){case "show":if(_b9&&_b9.show){_b9.show();}else{_b8.style.display="";}break;case "hide":if(_b9&&_b9.hide){_b9.hide();}else{_b8.style.display="none";}break;case "disable":if(_b9){_b9.set("disabled",true);}break;case "enable":if(_b9){_b9.set("disabled",false);}break;}};this.makeShareId=function(_ba,_bb){return "context_seed_"+_bb+"_"+_ba.hash;};this.validations=function(_bc){if(_bc.length){var _bd=[];for(var i=0,val;val=_bc[i];i++){var _be=val.getFields();for(var x=0,_bf;_bf=_be[x];x++){_bd.push(_bf.reason);}}this.error(_bd.join("\n"));}};this.translate=function(_c0,str,_c1,_c2){var map=_1.getObject(_c0,false,_15);if(!map||!map[str]){return _c2||"[No translation]";}return _82(map[str],_c1);};this.extractMessage=function(msg){if(typeof msg=="object"){if(msg.description){return msg.description;}else{if(msg.message){return msg.message;}}}return msg;};this.info=function(msg,_c3){return _5b(_58(msg,"info",_c3));};this.warning=function(msg,_c4){return _5b(_58(msg,"warning",_c4));};this.error=function(msg,_c5){return _5b(_58(msg,"error",_c5));};this.exception=function(msg){return this.error(msg,true);};this.confirmation=function(_c6){var _c7=new mxui.widget.Confirmation({content:_c6.content,proceed:_c6.proceed||"OK",cancel:_c6.cancel||"Cancel",handler:_c6.handler});_5b(_c7);return _c7;};this.encodeUrlHash=function(_c8,_c9,_ca){var _cb=_c8.substr(0,_c8.lastIndexOf(".")),_cc=_c9.toQuery();return "!/"+_cb+(_cc?"?"+_cc:"")+";"+_ca;};this.decodeUrlHash=function(_cd){if(_cd.charAt(0)=="!"){var _ce=_cd.lastIndexOf(";");_cd=_cd.slice(2,_ce!=-1?_ce:_cd.length);if(/^\w+(\/\w+(\?\w+\.\w+\=\d+(&\w+\.\w+\=\d+)*)?|\.\w+(\?\d+(&\d+)*)?)$/.test(_cd)){var _cf=_cd.split("?"),_d0=_cf[0],_d1=_cf[1],_d2=new mendix.lib.MxContext();if(_d0.indexOf("/")!=-1){if(_d1){var _d3=_d1.split("&");for(var i=_d3.length,_d4;_d4=_d3[--i];){var _d5=_d4.split("=");_d2.setContext(_d5[0],_d5[1]);}}return function(_d6){mx.ui.openForm(_d0+".mxf",{context:_d2});_d6&&_d6();};}else{if(_d1){var _d3=_d1.split("&");for(var i=0,_d4;_d4=_d3[i++];){_d2.setContext(" ",_d4);}}return function(_d7){mx.data.action({context:_d2,params:{actionname:_d0},callback:_d7,error:function(e){mx.onError(e);_d7&&_d7();}});};}}else{return null;}}else{return null;}};this.downloadFile=function(_d8){var _d9=(mx.ui.getProfile()=="desktop"),_da=_d9?_d8.target:"window",obj=_d8?_d8.mxobject:null,url;if(obj&&obj.get("HasContents")){url="file?guid="+obj.getGuid();}else{if(_d8.url){url=_d8.url;}}if(url){mxui.io.iframe.download({url:url,target:_da,error:function(err){if(_d8.error){_d8.error(err);}else{mx.onError(err);}}});}else{}};this.getFirstDayOfWeek=function(){return mx.session.getConfig("uiconfig.firstDayOfWeek");};};});