
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/sys/UI",["mxui/lib/form/FormFactory","mxui/lib/form/ContentForm","mxui/widget/DialogMessage","mxui/widget/Progress","mxui/widget/Underlay","mxui/widget/LoginDialog","mxui/widget/DemoUserSwitcher","mxui/widget/ConfirmationDialog","mxui/sys/history","mxui/io/iframe","mxui/dom","mendix/lib/ServerError","mendix/lib/ConnectionError","mendix/lib/DescribedServerError","mendix/lib/NavigationError","mendix/lib/ValidationError","mendix/lib/Error","mendix/lib/MxContext","mendix/lang","mendix/logger","dijit/registry","dojo/dom-class","dojo/on","dojo/aspect","dojo/cookie","dojo/has","dojo/ready","dojo/i18n","dojo/_base/array","dojo/_base/kernel","dojo/_base/lang","dojo/_base/config","dojox/date/buddhist","dojox/date/buddhist/locale"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20){function UI(){var _21=this,_22="mxui.sys.UI",_23=false,_24=null,_25=null,_26=null,_27=false,_28="en_US",_29=null,_2a=null,_2b="",_2c="desktop",_2d="Mendix 5",_2e=null,_2f;var _30={buddhist:/th$/,hebrew:null,islamic:null};this.startup=function(_31){var _32=window.mx.session.getConfig().uiconfig;_33(_32);_34(_32);_35(_32);_36(_32);_37();_17(window,"resize",_1f.hitch(_21,"resize"));_38();_39();_3a(_32.modules);_3b();_13.collect([_3c,_1b],function(){_27=document.body.dir.toLowerCase()=="rtl";_3d();_23=true;_31();});};function _33(_3e){_2a=_3e.menubars;_13.forEach(_2a,function(_3f,_40){_41(_3f,_40+"-");});function _41(_42,_43){_1d.forEach(_42,function(_44,_45){_44.id=_43+_45;if(_44.items){_41(_44.items,_44.id+"-");}});};};function _34(_46){_28=_46.locale;_1e.locale=_1c.normalizeLocale(_28.replace("_","-"));_29=_46.translations;_47();_48();};function _35(_49){_2c=_49.profile.name.toLowerCase();_2d=_49.profile.title;document.title=_2d;_16.add(document.body,"profile-"+_2c);};function _36(){var _4a=_1d.map(window.mx.session.getUserRoles("Name"),function(_4b){return "role-"+_4b.toLowerCase();});_16.add(document.body,_4a);};function _37(){_18.before(window.mx,"onError",function(e){var msg;if(e instanceof _e){msg=e.message;}else{if(e instanceof _d){msg=_21.translate("mxui.sys.UI","connection_error");}else{if(e instanceof _c){msg=_21.translate("mxui.sys.UI","internal_error");}else{msg=_21.translate("mxui.sys.UI","internal_error");}}}_24&&_24.hide();_24=_4c(msg,"error");_24.show(true);_14.error(e);});};function _38(){_2f=new _1();_2e=new _2();_18.after(_2e,"onNavigation",function(){document.title=_2d+" - "+_2e.title;});_25=new _4();_26=new _5();var _4d=mx.session.getConfig("demoUsers");if(_4d){_1d.forEach(_4d,function(_4e){_4e.active=(_4e.name==window.mx.session.getUserName());});var _4f=new _7({demoUsers:_4d});document.body.appendChild(_4f.domNode);_4f.startup();}};function _3d(){var _50=document.getElementById("content");if(!_50){_21.exception("You are using an outdated index template. Please update your index template.");return;}_50.appendChild(_2e.domNode);};function _39(){_9.init();_18.after(_2e,"dispose",_9.back);var _51=null;_18.after(_9,"onNavigation",function(_52,_53){if(!_53){return;}var _54=_53.formParams;if(!_51){_51=_21.showProgress();}if(_52){_2e.onPersistViewState(_52.viewState);}if(!_53.viewState){_53.viewState={};}_2e.navigateTo(_54.path,_54.title,_54.context,_54.params,_1f.clone(_53.viewState),function(){_21.hideProgress(_51);_51=null;},function(e){if(e instanceof _f){}else{_21.hideProgress(_51);_51=null;window.mx.onError(e);}});},true);};function _3c(_55){var _56=document.getElementsByTagName("head")[0],_57=_56.querySelector("link[href$='css/theme.css']"),_58=_b.createCssLink("widgets/widgets.css?"+window.mx.server.getCacheBust());if(_57){_56.insertBefore(_58,_57);}else{_56.appendChild(_58);}var _59=[],_5a=window.mx.session.getConfig("uiconfig.widgets");if(_5a.length>0){if(!_20.isDebug){_59.push("widgets/widgets.js");}else{_1d.forEach(_5a,function(_5b){var _5c=_5b.split(".");dojo.registerModulePath(_5c[0],window.mx.modulePath+_5c[0]);});_59=_1d.map(_5a,function(_5d){var _5e=_5d.split(".");return "widgets/"+_5e.join("/")+".js";});}}_b.addScripts(_59,_55);};function _3a(_5f){for(var i=0,_60;_60=_5f[i];i++){try{dojo["require"](_60+"."+_60);}catch(e){_14.error(_22+".getModules: failed loading module "+_60);}}};function _48(){var _61=_21.getCalendarSystem();switch(_61){case "gregorian":_2b="dojo.date";return;case "buddhist":_2b="dojox.date.buddhist";dojo["require"](_2b);dojo["require"](_2b+".locale");return;default:throw new Error("Unsupported date package: "+_61);}};function _3b(){if(_1a("ie")){if(JSON.stringify(document.createElement("input").value)==="\"null\""){var _62=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value").get;Object.defineProperty(HTMLInputElement.prototype,"value",{get:function(){var _63=_62.call(this);return _63===""?"":_63;}});}_17(document,"click",function(e){var _64=e.target;if(_64.nodeName=="TEXTAREA"||_64.nodeName=="INPUT"&&(_64.type=="text"||_64.type=="password")){if(document.activeElement!=_64){var sel=_b.getSelection(_64);try{_64.focus();}catch(ex){}_b.selectTextRange(_64,sel.start,sel.end);}}if(_1a("ie")<=8){if(_64.nodeName=="INPUT"&&_64.type=="checkbox"){_b.dispatchEvent(_64,"onchange");}}});}};function _47(){var map={"mendix":"mxui","mendix.core.MxServer":"mendix.core.Server","mendix.widget.MxDataView":"mendix.widget.MxFormView","mendix.widget.MxNavigator":"mendix.widget.Navigator","mendix.widget.MxDataGrid":"mendix.widget.DataGrid","mendix.widget.DataGrid.true":"mxui.common.true","mendix.widget.DataGrid.false":"mxui.common.false","mendix.core.MxServer.invalid_session":"mendix.session.session_expired","mobile.widget.Dialog.ok":"mxui.widget.DialogMessage.ok","mxui.widget.Dialog.error":"mxui.widget.DialogMessage.error","mxui.widget.Dialog.information":"mxui.widget.DialogMessage.info","mxui.widget.Dialog.warning":"mxui.widget.DialogMessage.warning","mxui.widget.Dialog.confirmation":"mxui.widget.ConfirmationDialog.caption","mobile.widget":"mxui.widget","mobile.sys":"mxui.sys"};for(var _65 in map){var _66=_65.split("."),_67=map[_65].split("."),_68=_66.pop(),_69=_67.pop(),_6a=_29,_6b=_6a,_6c;while(_6a&&(_6c=_66.shift())){_6a=_6a[_6c];}if(_6a){while(_6c=_67.shift()){_6b=_6b[_6c]=_6b[_6c]||{};}if(_6b[_69]){_1f.mixin(_6b[_69],_6a[_68]);}else{_6b[_69]=_6a[_68];}}}};function _4c(msg,_6d){return new _3({type:_6d,content:""+_21.extractMessage(msg)});};this.openFormInContent=function(_6e,_6f,_70,_71){_9.push({formParams:{path:_6e,title:_6f,context:_70||new _12(),params:_71||{}}});};this.openFormInPopup=function(_72,_73,_74,_75,_76,_77){var _78=this,pid=this.showProgress();_2f.openPopupForm(_72,_73,(_74||new _12()),(_75||{}),function(_79){_78.hideProgress(pid);_76&&_76(_79);},function(e){_78.hideProgress(pid);_77?_77(e):window.mx.onError(e);});};this.openFormInNode=function(_7a,_7b,_7c,_7d,_7e,_7f){var _80=this,pid=this.showProgress();_2f.openInlineForm(_7a,_7b,(_7c||new _12()),(_7d||{}),function(_81){_80.hideProgress(pid);_7e&&_7e(_81);},function(e){_80.hideProgress(pid);_7f?_7f(e):window.mx.onError(e);});};function _82(fmt,_83){if(!_83){return fmt;}else{if(!(_83 instanceof Array)){_83=[_83];}}return fmt.replace(/\{(\d+)\}/g,function(_84,n){var _85=_83[n-1];if(_85!=null){return _85;}else{return _84;}});};this.toString=function(){return _22;};this.getCurrentForm=function(){return _2e;};this.getProfile=function(){return _2c;};this.getMenu=function(_86){return _2a[_86]||[];};this.getDatePackage=function(){return _2b;};this.getCalendarSystem=function(){for(var m in _30){var re=_30[m];if(re&&re.test(_1e.locale.toLowerCase())){return m;}}return "gregorian";};this.isRtl=function(){return _27;};this.resize=function(){_2e.resize();};this.execute=function(_87,_88,_89){var cfg={};if(_87.microflow){_1f.mixin(cfg,_87.microflow,_88);window.mx.ui.action(cfg.name,cfg,_89);}else{if(_87.form){_1f.mixin(cfg,_87.form,_88);window.mx.ui.openForm(cfg.path,cfg,_89);}else{_14.error(_22+".execute: unknown action type");}}};this.action=function(_8a,_8b,_8c){_8b=_8b||{};_1f.setObject("params.actionname",_8a,_8b);var _8d=_8b.callback,_8e=_8b.error,_8f=_1f.mixin({caller:_2e},_8b.store),_90;if("progress" in _8b){_90=this.getProgress(_8b.progressMsg,_8b.progress=="modal");_90.start();}window.mx.data.action({callback:function(_91){_8d&&_8d.call(_8c,_91);_90&&_90.stop();},error:function(e){_90&&_90.stop();if(_8e){_8e.call(_8c,e);}else{if(e&&!(e instanceof _10)){window.mx.onError(e);}}},context:_8b.context,async:_8b.async,params:_8b.params,store:_8f});};this.back=function(){_9.back();};this.showProgress=function(msg,_92){return _25.add(msg||"",_92);};this.hideProgress=function(id){return _25.remove(id);};this.showUnderlay=function(_93){_26.show(_93);};this.hideUnderlay=function(_94){_26.hide(_94);};this.getProgress=function(msg,_95){var id,_96;return {start:function(){if(_96){return id;}else{_96=true;return id=_21.showProgress(msg,_95);}},stop:function(){if(_96){_96=false;_21.hideProgress(id);}}};};function _97(_98){if(!_23){var _99=window.mx.session.getConfig("profile");if(_99){_2c=_99.name.toLowerCase();_16.add(document.body,"profile-"+_2c);document.title=_99.title;}}if(!window.i18nMap){window.mx.server.get({url:"js/login_i18n.js",handleAs:"javascript",load:_98});}else{_98();}};this.showLogin=function(_9a){if(_9a=="402"){this.exception(window.i18nMap.http402);return;}var _9b=_19("originURI");if(_9b){_19("originURI",null,{expires:-1});window.mx.redirect(_9b);return;}_97(function(){new _6({messageCode:_9a}).show();});};this.openForm=function(_9c,_9d,_9e){if(_9d.domNode){this.openFormInNode(_9c,_9d.domNode,_9d.context,_9d.params,_9d.callback?_1f.hitch(_9e,_9d.callback):null,_9d.error?_1f.hitch(_9e,_9d.error):null);}else{if(/popup|modal/.test(_9d.location)){_9d.modal=_9d.location=="modal";this.openFormInPopup(_9c,_9d,_9d.context,_9d.params,_9d.callback?_1f.hitch(_9e,_9d.callback):null,_9d.error?_1f.hitch(_9e,_9d.error):null);}else{if(_9d.callback||_9d.error){throw new Error("Success and error callbacks are not supported for openFormInContent");}this.openFormInContent(_9c,_9d.title,_9d.context,_9d.params);}}};this.reload=function(_9f){var _a0=mxui.currentForm;if(!_a0){throw new _11("Trying to refresh the content form but no form is yet available.");}_a0.reload(_9f);};this.getTemplate=function(id,_a1){var _a2=_2e.widgetTemplates[id];return _a2&&_1f.clone(_a2[_a1]);};this.applyToNode=function(_a3,_a4){var _a5=_15.byNode(_a4);switch(_a3){case "show":if(_a5&&_a5.show){_a5.show();}else{_a4.style.display="";}break;case "hide":if(_a5&&_a5.hide){_a5.hide();}else{_a4.style.display="none";}break;case "disable":if(_a5){_a5.set("disabled",true);}break;case "enable":if(_a5){_a5.set("disabled",false);}break;}};this.makeShareId=function(_a6,_a7){return "context_seed_"+_a7+"_"+_a6.hash;};this.validations=function(_a8){if(_a8.length){var _a9=[];for(var i=0,val;val=_a8[i];i++){var _aa=val.getFields();for(var x=0,_ab;_ab=_aa[x];x++){_a9.push(_ab.reason);}}this.error(_a9.join("\n"));}};this.translate=function(_ac,str,_ad,_ae){var map=_1f.getObject(_ac,false,_29);if(!map||!map[str]){return _ae||"[No translation]";}return _82(map[str],_ad);};this.extractMessage=function(msg){if(typeof msg=="object"){if(msg.description){return msg.description;}else{if(msg.message){return msg.message;}}}return msg;};this.info=function(msg,_af){_4c(msg,"info").show(_af);};this.warning=function(msg,_b0){_4c(msg,"warning").show(_b0);};this.error=function(msg,_b1){_4c(msg,"error").show(_b1);};this.exception=function(msg){this.error(msg,true);};this.confirmation=function(_b2){new _8({content:_b2.content,proceed:_b2.proceed||"OK",cancel:_b2.cancel||"Cancel",handler:_b2.handler}).show();};this.encodeUrlHash=function(_b3,_b4,_b5){var _b6=_b3.substr(0,_b3.lastIndexOf(".")),_b7=_b4.toQuery();return "!/"+_b6+(_b7?"?"+_b7:"")+";"+_b5;};this.decodeUrlHash=function(_b8){if(_b8.charAt(0)=="!"){var _b9=_b8.lastIndexOf(";");_b8=_b8.slice(2,_b9!=-1?_b9:_b8.length);if(/^\w+(\/\w+(\?\w+\.\w+\=\d+(&\w+\.\w+\=\d+)*)?|\.\w+(\?\d+(&\d+)*)?)$/.test(_b8)){var _ba=_b8.split("?"),_bb=_ba[0],_bc=_ba[1],_bd=new _12(),_be,_bf;if(_bb.indexOf("/")!=-1){if(_bc){_be=_bc.split("&");for(var i=_be.length;_bf=_be[--i];){var _c0=_bf.split("=");_bd.setContext(_c0[0],_c0[1]);}}return function(_c1){window.mx.ui.openFormInContent(_bb+".page.xml","",_bd);_c1&&_c1();};}else{if(_bc){_be=_bc.split("&");for(var j=0;_bf=_be[j++];){_bd.setContext(" ",_bf);}}return function(_c2){window.mx.data.action({context:_bd,params:{actionname:_bb},callback:_c2,error:function(e){window.mx.onError(e);_c2&&_c2();}});};}}else{return null;}}else{return null;}};this.downloadFile=function(_c3){var _c4=(window.mx.ui.getProfile()=="desktop"),_c5=_c4?_c3.target:"window",obj=_c3?_c3.mxobject:null,url;if(obj&&obj.get("HasContents")){url="file?guid="+obj.getGuid();}else{if(_c3.url){url=_c3.url;}}if(url){_a.download({url:window.mx.appUrl+url,target:_c5,error:function(err){if(_c3.error){_c3.error(err);}else{window.mx.onError(err);}}});}else{}};this.getFirstDayOfWeek=function(){return window.mx.session.getConfig("uiconfig.firstDayOfWeek");};};return UI;});