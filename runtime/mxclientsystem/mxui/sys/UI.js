
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/sys/UI",["dojo","dijit","dojox","dojo/require!mxui/io/iframe,mxui/cldr/supplemental"],function(_1,_2,_3){_1.provide("mxui.sys.UI");_1.require("mxui.io.iframe");_1.require("mxui.cldr.supplemental");mxui.sys.UI=function(_4){_4=_4||{};var _5=this,_6="mxui.sys.UI",_7=false,_8=false,_9=null,_a=null,_b=null,_c=null,_d=null,_e=null,_f=null,_10={},_11={},_12={},_13=false,_14="en_US",_15=null,_16=null,_17="",_18="desktop",_19="Mendix 5",_1a=[],_1b=false,_1c=new mxui.lib.WindowManager();var _1d={buddhist:/th$/,hebrew:null,islamic:null};var _1e=function(_1f){_1.addOnLoad(function(){_13=document.body.dir.toLowerCase()=="rtl";_9=document.getElementById("content");if(!_9){mx.ui.exception("You are using an outdated index template. Please update your index template.");return;}_1.connect(window,"resize",_1.hitch(_5,"resize"));_1f();});};var _20=function(_21){var _22=mx.server.getCacheBust(),url="widgets/widgets.js";mxui.dom.addCss("widgets/widgets.css?"+_22);_1.registerModulePath("widgets","../../widgets");mx.server.get({url:url,handleAs:"text",failOk:true,load:function(_23){_1["eval"](_23+"\r\n//@ sourceURL="+url);_21();},error:function(err){mx.onError(new mendix.lib.Error("Could not retrieve "+url+". Probably a custom widget has a problem. ("+err+")"));var _24=mx.session.getConfig("uiconfig.widgets");for(var i=0,_25;_25=_24[i];i++){var _26=_25.split(".");_1.registerModulePath(_26[0],mx.modulePath+_26[0]);try{_1["require"](_25);}catch(e){logger.error(_6+".getWidgets: failed loading widget "+_25+": "+e);}}_21();}});};var _27=function(_28){var _29=mx.session.getConfig("uiconfig.modules");for(var i=0,_2a;_2a=_29[i];i++){try{_1["require"](_2a+"."+_2a);}catch(e){logger.error(_6+".getModules: failed loading module "+_2a);}}_28();};var _2b=function(){_1a=_1.map(mx.session.getUserRoles("Name"),function(_2c){return "role-"+_2c.toLowerCase();});_1.addClass(document.body,_1a);_1.addClass(document.body,"profile-"+_18);document.title=_19;};var _2d=function(){_1.removeClass(document.body,_1a);_1.removeClass(document.body,"profile-"+_18);_1a=[];document.title="";};var _2e=function(_2f){if(_8){_2f();}else{_1.connect(mx,"onError",function(e){var msg;if(e instanceof mendix.lib.DescribedServerError){msg=e.message;}else{if(e instanceof mendix.lib.ConnectionError){msg=_5.translate("mxui.sys.UI","connection_error");}else{if(e instanceof mendix.lib.ServerError){msg=_5.translate("mxui.sys.UI","internal_error");}else{msg=_5.translate("mxui.sys.UI","internal_error");}}}_b&&_b.hide();_b=_5.exception(msg);logger.error(e);});_30();mendix.lang.collect([_20,_27,_1e],_2f);}};var _31=function(){var _32=_5.getCalendarSystem();if(_32!=="gregorian"){_17="dojox.date."+_32;_1["require"](_17);_1["require"](_17+".locale");}};var _30=function(){if(_1.isIE){if(JSON.stringify(document.createElement("input").value)==="\"null\""){var _33=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value").get;Object.defineProperty(HTMLInputElement.prototype,"value",{get:function(){var _34=_33.call(this);return _34===""?"":_34;}});}_1.connect(document,"onclick",function(e){var _35=e.target;if(_35.nodeName=="TEXTAREA"||_35.nodeName=="INPUT"&&(_35.type=="text"||_35.type=="password")){if(document.activeElement!=_35){var sel=mxui.dom.getSelection(_35);try{_35.focus();}catch(e){}mxui.dom.selectTextRange(_35,sel.start,sel.end);}}if(_1.isIE<=8){if(_35.nodeName=="INPUT"&&_35.type=="checkbox"){mxui.html.dispatchEvent(_35,"onchange");}}});}};var _36=function(){var map={"mendix":"mxui","mendix.core.MxServer":"mendix.core.Server","mendix.widget.MxDataView":"mendix.widget.MxFormView","mendix.widget.MxNavigator":"mendix.widget.Navigator","mendix.widget.MxDataGrid":"mendix.widget.DataGrid","mendix.widget.DataGrid.true":"mxui.common.true","mendix.widget.DataGrid.false":"mxui.common.false","mendix.core.MxServer.invalid_session":"mendix.session.session_expired","mobile.widget.Dialog.ok":"mxui.widget.DialogMessage.ok","mxui.widget.Dialog.error":"mxui.widget.DialogMessage.error","mxui.widget.Dialog.information":"mxui.widget.DialogMessage.info","mxui.widget.Dialog.warning":"mxui.widget.DialogMessage.warning","mxui.widget.Dialog.confirmation":"mxui.widget.Confirmation.caption","mobile.widget":"mxui.widget","mobile.sys":"mxui.sys"};for(var _37 in map){var _38=_37.split("."),_39=map[_37].split("."),_3a=_38.pop(),_3b=_39.pop(),_3c=_15,_3d=_3c,_3e;while(_3c&&(_3e=_38.shift())){_3c=_3c[_3e];}if(_3c){while(_3e=_39.shift()){_3d=_3d[_3e]=_3d[_3e]||{};}if(_3d[_3b]){_1.mixin(_3d[_3b],_3c[_3a]);}else{_3d[_3b]=_3c[_3a];}}}};var _3f=function(){var _40=_5.decodeUrlHash(_1.hash());_40?_40():mx.remote.execute(mx.session.getConfig());};var _41=function(_42){if(_42.xml){var _43=mxui.dom.create("div"),_44=_42.childNodes;for(var i=0,_45;_45=_44[i];i++){_43.innerHTML+=_45.xml;}_42=_43;}else{_42=document.importNode(_42,true);}var _46=_42.getElementsByTagName("*");for(var l=_46.length-1,_47;_47=_46[l];l--){var _48=_47.getAttribute("data-mendix-roles");if(!mx.session.hasSomeRole(_48)){_47.parentNode.removeChild(_47);}else{_47.removeAttribute("data-mendix-roles");}}var _49=document.createDocumentFragment();while(_42.firstChild){_49.appendChild(_42.firstChild);}return _49;};var _4a=function(_4b,xml){var _4c=xml.documentElement,fid=_4c.getAttribute("id"),_4d=_4c.getAttribute("title"),_4e=_4c.getAttribute("class"),_4f=_4c.getAttribute("style"),_50=_4c.childNodes;for(var i=0,_51;_51=_50[i];i++){if(_51.nodeType!=1){continue;}switch(_51.localName||_51.baseName){case "content":_10[_4b]={id:fid,path:_4b,title:_4d,"class":_4e||"",style:_4f||"",content:_41(_51)};break;case "templates":var _52=_51.childNodes;for(var j=0,_53;_53=_52[j];j++){if(_53.nodeType!=1){continue;}var wid=_53.getAttribute("widget-id"),_54=_53.getAttribute("name"),_55=_41(_53);if(!_11[wid]){_11[wid]={};}_11[wid][_54]=_55;}}}return _10[_4b];};var _56=function(msg,_57,_58){return new mxui.widget.DialogMessage({type:_57,content:""+_5.extractMessage(msg),modal:_58});};var _59=function(_5a){_12[_5a.id]=_5a;var _5b=_1.connect(_5a,"onAfterHide",function(){_1.disconnect(_5b);delete _12[_5a.id];_5a.destroy();});_5a.show();return _5a;};var _5c=function(){var id;for(id in _12){_12[id].hide();}};var _5d=function(_5e,dir,_5f){var _60=mxui.currentForm,_61=_60&&_60.domNode,_62=_5e.domNode,_63=function(){_5e.onAfterShow();_60&&_60.onAfterHide();window.scrollTo(0,_5e._scrollPos||1);_1b=false;_5f&&_5f();};mxui.currentForm=_5e;if(_61!=_62){_5e.onBeforeShow();if(_61){var _64=window.pageYOffset;_60._scrollPos=_64;window.scrollTo(0,1);setTimeout(function(){_60.onBeforeHide();_1.removeClass(_62,"mx-page-hidden");setTimeout(function(){mxui.dom.orphan(_61);_1.addClass(_61,"mx-page-hidden");},0);_63();},0);}else{_1.removeClass(_62,"mx-page-hidden");_63();}}};var _65=function(_66,_67,_68){var dir=_67.dir,_69=_67.params,_6a=_67.error,_6b=_67.instance,_6c=_67.callback;if(_1b){_6c&&_6c();return;}else{_1b=true;}mxui.currentForm&&mxui.currentForm.suspend();var _6d=function(_6e){_6e.applyContext(_67.context||new mendix.lib.MxContext(),function(){document.title=_19+" - "+_6e.getTitle();_5d(_6e,dir,function(){if(!_6b){_c.register(_6e);}_6c&&_6c.call(_68,_6e);});});};if(_6b){_9.appendChild(_6b.domNode);_6b.resume();_6d(_6b);}else{_5.getForm(_66,{params:_1.mixin(_69,{place:"content",title:_67.title}),error:function(e){_1b=false;_6a&&_6a.call(_68,e);},callback:function(_6f){_1.addClass(_6f.domNode,"mx-page-hidden");_1.connect(_6f,"dispose",function(){mx.ui.back();});_9.appendChild(_6f.domNode);_6f.startup(function(){_6d(_6f);});}});}};var _70=function(_71,_72,_73){var _74=_72.params,_75=_72.error,_76=_72.callback;_71=_71.replace(/\.mxf/,"$Popup.mxf");_5.getForm(_71,{params:_1.mixin(_74,{place:"popup",title:_72.title}),error:function(e){_75&&_75.call(_73,e);},callback:function(_77){_1c.show(_77,_72,_1.hitch(_73,_76));}});};var _78=function(_79,_7a,_7b){var _7c=_7a.params,_7d=_7a.error,_7e=_7a.callback;_79=_79.replace(/\.mxf/,"$Popup.mxf");_5.getForm(_79,{params:_1.mixin(_7c,{place:"custom",title:_7a.title}),error:function(e){_7d&&_7d.call(_7b,e);},callback:function(_7f){_7a.domNode.appendChild(_7f.domNode);_1.removeClass(_7f.domNode,"mx-page mx-page-hidden");_7f.startup(function(){_7f.applyContext(_7a.context||new mendix.lib.MxContext(),function(){_7e&&_7e.call(_7b,_7f);});});}});};var _80=function(fmt,_81){if(!_81){return fmt;}else{if(!(_81 instanceof Array)){_81=[_81];}}return fmt.replace(/\{(\d+)\}/g,function(_82,n){var _83=_81[n-1];if(_83!=null){return _83;}else{return _82;}});};var _84=function(_85,_86){return function(_87){var _88=[];var end=function(){for(var i=_88.length;i--;){_1.disconnect(_88[i]);}_87&&_87();_1.removeClass(_85,_86);};_88.push(_1.connect(_85,"webkitAnimationEnd",end),_1.connect(_85,"animationend",end));_1.addClass(_85,_86);};};var _89=function(_8a,_8b,_8c){_84(_8a,_8b)(_8c);};this.toString=function(){return _6;};this.isLoaded=function(){return _7;};this.startup=function(_8d){var _8e=mx.session.getConfig("uiconfig");_14=_8e.locale;_1.locale=_1.i18n.normalizeLocale(_14.replace("_","-"));_15=_8e.translations;_16=_8e.menubars;_2d();_18=_8e.profile.name.toLowerCase();_19=_8e.profile.title;_2b();_36();_c=new mxui.lib.History();_e=_e||new mxui.widget.Progress();_f=_f||new mxui.widget.Underlay();_2e(function(){_c.startup();_31();_3f();_7=true;_8=true;_8d();});};this.shutdown=function(){_1c.hideAll();_5c();mxui.currentForm=null;_10={};_11={};_17="";_c.destroy();_1.disconnect(_d);_2d();_7=false;};this.getProfile=function(){return _18;};this.getMenu=function(_8f){return _16[_8f]||[];};this.getDatePackage=function(){return _17||"dojo.date";};this.getCalendarSystem=function(){for(var m in _1d){var re=_1d[m];if(re&&re.test(_1.locale.toLowerCase())){return m;}}return "gregorian";};this.isRtl=function(){return _13;};this.resize=function(e){mxui.currentForm&&mxui.currentForm.resize();};this.execute=function(_90,_91,_92){var cfg={};if(_90.microflow){_1.mixin(cfg,_90.microflow,_91);mx.ui.action(cfg.name,cfg,_92);}else{if(_90.form){_1.mixin(cfg,_90.form,_91);mx.ui.openForm(cfg.path,cfg,_92);}else{logger.error(_6+".execute: unknown action type");}}};this.action=function(_93,_94,_95){_94=_94||{};_1.setObject("params.actionname",_93,_94);var _96=_94.callback,_97=_94.error,_98=_1.mixin({caller:mxui.currentForm},_94.store),_99;if("progress" in _94){_99=this.getProgress(_94.progressMsg,_94.progress=="modal");_99.start();}mx.data.action({callback:function(_9a){_99&&_99.stop();_96&&_96.call(_95,_9a);},error:function(e){_99&&_99.stop();if(_97){_97.call(_95,e);}else{if(e&&!(e instanceof mendix.lib.ValidationError)){mx.onError(e);}}},context:_94.context,async:_94.async,params:_94.params,store:_98});};this.back=function(){_c.back();};this.showProgress=function(msg,_9b){return _e.add(msg||_5.translate("mxui.sys.UI","loading"),_9b);};this.hideProgress=function(id){return _e.remove(id);};this.showUnderlay=function(_9c){_f.show(_9c);};this.hideUnderlay=function(_9d){_f.hide(_9d);};this.getProgress=function(msg,_9e){var id,_9f;return {start:function(){if(_9f){return id;}else{_9f=true;return id=_5.showProgress(msg,_9e);}},stop:function(){if(_9f){_9f=false;_5.hideProgress(id);}}};};this.setupLoginPage=function(){var _a0=mx.session.getConfig("profile");if(_a0){_18=_a0.name.toLowerCase();_1.addClass(document.body,"profile-"+_18);document.title=_a0.title;}};this.showLogin=function(_a1){var _a2=_1.cookie("originURI");if(_a2){_1.cookie("originURI","");window.location=_a2;return;}var _a3=function(_a4){if(_1.cookie.isSupported()){if(_a4&&_a4.http_code==402){_5.exception(window.i18nMap.http402);}else{_a=_a||new mxui.widget.Login();_a.show(_a4);}}else{_5.exception("This application requires cookies to be enabled");}};mx.server.get({url:"js/login_i18n.js",handleAs:"javascript",load:function(){_1.addOnLoad(function(){_a3(_a1);});}});_5.showLogin=_a3;};this.hideLogin=function(){_a&&_a.hide();};this.openForm=function(_a5,_a6,_a7){_a6=_a6||{};var pid=this.showProgress(),cb=_a6.callback,_a8=_a6.error;_a6.callback=function(_a9){_5.hideProgress(pid);cb&&cb.call(this,_a9);};_a6.error=function(e){_5.hideProgress(pid);if(_a8){_a8&&_a8.call(this,e);}else{mx.onError(e);}};if(_a6.domNode){_78(_a5,_a6,_a7);}else{if(/popup|modal/.test(_a6.location)){_70(_a5,_a6,_a7);}else{_65(_a5,_a6,_a7);}}};this.getForm=function(_aa,_ab,_ac){_ab=_ab||{};var _ad=_ab.params,_ae=_ab.error,_af=_ab.callback;if(_aa in _10){var _b0=_1.clone(_10[_aa]);_af&&_af.call(_ac,new mxui.lib.Form(_b0,_ad));}else{mx.server.get({url:"pages/"+_14+"/"+_aa,handleAs:"xml",load:function(xml){var _b1=_1.clone(_4a(_aa,xml)),_b2=new mxui.lib.Form(_b1,_ad);_af&&_af.call(_ac,_b2);},error:function(e){logger.error(_6+".getForm: error occurred while fetching form '"+_aa+"': "+e);_ae&&_ae.call(_ac,e);}});}};this.reload=function(_b3){var _b4=mxui.currentForm;if(!_b4){throw new mendix.lib.Error("Trying to refresh the content form but no form is yet available.");}_b4.reload(_b3);};this.getTemplate=function(id,_b5){var _b6=_11[id];return _b6&&_1.clone(_b6[_b5]);};this.applyToNode=function(_b7,_b8){var wid=_b8.getAttribute("widgetId"),_b9=wid&&_2.byId(wid);switch(_b7){case "show":if(_b9&&_b9.show){_b9.show();}else{_b8.style.display="";}break;case "hide":if(_b9&&_b9.hide){_b9.hide();}else{_b8.style.display="none";}break;case "disable":if(_b9){_b9.set("disabled",true);}break;case "enable":if(_b9){_b9.set("disabled",false);}break;}};this.makeShareId=function(_ba,_bb){return "context_seed_"+_bb+"_"+_ba.hash;};this.validations=function(_bc){if(_bc.length){var _bd=[];for(var i=0,val;val=_bc[i];i++){var _be=val.getFields();for(var x=0,_bf;_bf=_be[x];x++){_bd.push(_bf.reason);}}this.error(_bd.join("\n"));}};this.translate=function(_c0,str,_c1,_c2){var map=_1.getObject(_c0,false,_15);if(!map||!map[str]){return _c2||"[No translation]";}return _80(map[str],_c1);};this.extractMessage=function(msg){if(typeof msg=="object"){if(msg.description){return msg.description;}else{if(msg.message){return msg.message;}}}return msg;};this.info=function(msg,_c3){return _59(_56(msg,"info",_c3));};this.warning=function(msg,_c4){return _59(_56(msg,"warning",_c4));};this.error=function(msg,_c5){return _59(_56(msg,"error",_c5));};this.exception=function(msg){return this.error(msg,true);};this.confirmation=function(_c6){var _c7=new mxui.widget.Confirmation({content:_c6.content,proceed:_c6.proceed||"OK",cancel:_c6.cancel||"Cancel",handler:_c6.handler});_59(_c7);return _c7;};this.encodeUrlHash=function(_c8,_c9,_ca){var _cb=_c8.substr(0,_c8.lastIndexOf(".")),_cc=_c9.toQuery();return "!/"+_cb+(_cc?"?"+_cc:"")+";"+_ca;};this.decodeUrlHash=function(_cd){if(_cd.charAt(0)=="!"){var _ce=_cd.lastIndexOf(";");_cd=_cd.slice(2,_ce!=-1?_ce:_cd.length);if(/^\w+(\/\w+(\?\w+\.\w+\=\d+(&\w+\.\w+\=\d+)*)?|\.\w+(\?\d+(&\d+)*)?)$/.test(_cd)){var _cf=_cd.split("?"),_d0=_cf[0],_d1=_cf[1],_d2=new mendix.lib.MxContext();if(_d0.indexOf("/")!=-1){if(_d1){var _d3=_d1.split("&");for(var i=_d3.length,_d4;_d4=_d3[--i];){var _d5=_d4.split("=");_d2.setContext(_d5[0],_d5[1]);}}return function(_d6){mx.ui.openForm(_d0+".mxf",{context:_d2});_d6&&_d6();};}else{if(_d1){var _d3=_d1.split("&");for(var i=0,_d4;_d4=_d3[i++];){_d2.setContext(" ",_d4);}}return function(_d7){mx.data.action({context:_d2,params:{actionname:_d0},callback:_d7,error:function(e){mx.onError(e);_d7&&_d7();}});};}}else{return null;}}else{return null;}};this.downloadFile=function(_d8){var _d9=(mx.ui.getProfile()=="desktop"),_da=_d9?_d8.target:"window",obj=_d8?_d8.mxobject:null,url;if(obj&&obj.get("HasContents")){url="file?guid="+obj.getGuid();}else{if(_d8.url){url=_d8.url;}}if(url){mxui.io.iframe.download({url:window.mx.appUrl+url,target:_da,error:function(err){if(_d8.error){_d8.error(err);}else{mx.onError(err);}}});}else{}};this.getFirstDayOfWeek=function(){return mx.session.getConfig("uiconfig.firstDayOfWeek");};};});