/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/Client",["mxui/sys/Parser","mxui/sys/UI","mxui/sys/Router","mxui/sys/ReloadHandler","mxui/lib/ReloadListener","mendix/sys/Data","mendix/sys/Meta","mendix/sys/Remote","mendix/sys/Server","mendix/sys/Session","mendix/lang","mendix/logger","webcore/sql/Store","dojo/cookie","dojo/aspect","dojo/_base/array","dojo/_base/lang"],function(_1,UI,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){function _11(_12){var _13=this,_14="mendix.Client",_15=false,_16=[];this.appUrl=_12.appUrl;this.homeUrl=_12.homeUrl;this.remoteUrl=_12.remoteUrl;this.afterLoginAction=_12.afterLoginAction;this.baseUrl=_12.baseUrl;this.modulePath=_12.modulePath;this.server=new _8({timeout:_12.timeout});this.session=new _9(_12.session);this.remote=new _7();this.meta=new _6();this.data=new _5(_12.data);this.router=new _2();this.ui=new UI(_12.ui);this.parser=new _1();this.reloader=new _3();_17();function _18(_19){_13.router.startup({profile:_13.session.getConfig("uiconfig.profile.title")||"Mendix 6",urlPrefix:_12.appPath});if(_13.session.getConfig("listenToReload")&&!_12.disableFastReload){new _4(_13.remoteUrl.replace(/^https?/,"ws")+"reload/").addOnReload(_13.reloader.reloadPage.bind(_13.reloader));}_13.ui.startup(function(){_13.parser.startup(function(){if(!_13.reloader.tryRestorePage()){_13.remote.execute(_13.session.getConfig());}_19();});});};this.toString=function(){return _14;};this.isLoaded=function(){return _15;};this.addOnLoad=function(_1a){_15?_1a():_16.push(_1a);};this.reload=function(){this.redirect(this.homeUrl);};this.redirect=function(_1b){window.location.href=_1b+window.location.search+window.location.hash;};this.startup=function(){if(_15){throw new Error("Client has already been started up!");}this.session.authorized({params:{offline:_12.offline||false,referrer:_12.referrer||null},no:function(_1c){var _1d=_1c&&_a.inArray(_1c.http_code,["402","404","500","503"])?_1c.http_code:0;var _1e=_2f("reloginReason");_13.ui.showLogin(_1e||_1d);},yes:function(_1f){_13.meta.startup();var _20=_13.session.getConfig("sync_config");var _21=_1f&&_20&&_20.fetch;var _22=_12.store||{};if(_20){_13.data.setOfflineStore(new _c(_20.schema,_22.createStoreFn),_20.fetch);}_13.data.startup();_13.session.startup();var _23=[];if(_21){_23.push(function(_24){_13.data.uploadDataWithReset(_24,function(e){_13.onError(e);if(_24){_24();}});});}_23=_23.concat([_18,_25]);if(_21){_23.push(function(_26){var _27=_13.ui.showProgress(null,true);_13.data.synchronizeDataWithFiles(function(){_13.ui.reload(function(){_13.ui.hideProgress(_27);if(_26){_26();}});},function(e){_13.ui.hideProgress(_27);_13.onError(e);if(_26){_26();}});});}_a.sequence(_23);function _25(_28){_15=true;while(_16.length>0){_16.shift()();}if(_28){_28();}};}});};this.login=function(_29,_2a,_2b,_2c){this.session.login({username:_29,password:_2a,success:function(){if(_15){_13.reload();}else{if(_2b){_2b();}if(_13.afterLoginAction){_13.afterLoginAction();}else{_13.startup();}}},error:_2c});};this.logout=function(){this.session.logout(_10.hitch(this,"reload"));};function _17(){_e.before(_13.server,"onUnauthorized",function(_2d){if(_2d=="401"){_2d="419";}_d("reloginReason",_2d,{expires:10/(24*60*60)});_13.reload();});};this.onError=function(_2e){_b.error("Error: "+_2e.message);};function _2f(_30){var _31=_d(_30);_d(_30,null,{expires:-1});return _31;};};return _11;});