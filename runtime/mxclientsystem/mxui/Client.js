/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/Client",["mxui/sys/Parser","mxui/sys/UI","mxui/sys/Router","mendix/sys/Data","mendix/sys/Meta","mendix/sys/Remote","mendix/sys/Server","mendix/sys/Session","mendix/lang","mendix/logger","webcore/sql/Store","dojo/cookie","dojo/aspect","dojo/_base/array","dojo/_base/lang"],function(_1,UI,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){function _f(_10){_10=_10||{};var _11=this,_12="mendix.Client",_13=false,_14=[];this.appUrl=_10.appbase||_15();this.remoteUrl=_10.remotebase||this.appUrl;this.baseUrl=_10.xasbase||(this.remoteUrl+"xas/");this.modulePath=_10.modulePath||"../../widgets/";this.server=new _6(_e.mixin({timeout:_10.timeout},_10.server));this.session=new _7();this.remote=new _5();this.meta=new _4();this.data=new _3(_10.data);this.router=new _2();this.ui=new UI(_10.ui);this.parser=new _1();_16();function _15(){var _17=window.location.href,_18=_17.indexOf("#");if(_18!=-1){_17=_17.slice(0,_18);}return _17.slice(0,_17.lastIndexOf("/")+1);};function _19(_1a){_11.router.startup({profile:_11.session.getConfig("uiconfig.profile.title")||"Mendix 6"});_11.ui.startup(function(){_11.parser.startup(_1a);});};this.toString=function(){return _12;};this.isLoaded=function(){return _13;};this.addOnLoad=function(fnc){_13?fnc():_14.push(fnc);};this.reload=function(){};this.redirect=function(_1b){};this.startup=function(){if(_13){throw new Error("Client has already been started up!");}this.session.authorized({params:{offline:_10.offline||false},no:function(_1c){var _1d=_1c&&_8.inArray(_1c.http_code,["402","404","500","503"])?_1c.http_code:0;var _1e=_2a("reloginReason");_11.ui.showLogin(_1e||_1d);},yes:function(_1f){_11.meta.startup();var _20=mx.session.getConfig("sync_config");var _21=_10.store||{};if(_20){_11.data.setOfflineStore(new _a(_20.schema,_21.createStoreFn),_20.fetch);}_11.data.startup();_11.session.startup();var _22=[];if(_1f&&_20&&_20.fetch){_22.push(function(_23){mx.data.synchronize(_23,function(e){mx.onError(e);if(_23){_23();}});});}_22=_22.concat([_19,_24]);_8.sequence(_22);function _24(){_13=true;while(_14.length>0){_14.shift()();}};}});};this.login=function(_25,_26,_27,_28){this.session.login({username:_25,password:_26,success:function(){if(_13){_11.reload();}else{_27&&_27();_11.startup();}},error:_28});};this.logout=function(){this.session.logout(_e.hitch(this,"reload"));};function _16(){_c.before(_11.server,"onUnauthorized",function(_29){if(_29=="401"){_29="419";}_b("reloginReason",_29,{expires:10/(24*60*60)});_11.reload();});};this.onError=function(err){_9.error("Error: "+err.message);};function _2a(_2b){var _2c=_b(_2b);_b(_2b,null,{expires:-1});return _2c;};};return _f;});