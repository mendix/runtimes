/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/Client",["mxui/sys/Parser","mxui/sys/UI","mxui/sys/Router","mxui/sys/ReloadHandler","mxui/lib/ReloadListener","mendix/sys/Data","mendix/sys/Meta","mendix/sys/Remote","mendix/sys/Server","mendix/sys/Session","mendix/lang","mendix/logger","webcore/sql/Store","dojo/cookie","dojo/aspect","dojo/_base/array","dojo/_base/lang"],function(_1,UI,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){function _11(_12){var _13=this,_14="mendix.Client",_15=false,_16=[];this.version="{{mendix-version}}";this.appUrl=_12.appUrl;this.homeUrl=_12.homeUrl;this.remoteUrl=_12.remoteUrl;this.afterLoginAction=_12.afterLoginAction;this.baseUrl=_12.baseUrl;this.modulePath=_12.modulePath;this.server=new _8({timeout:_12.timeout});this.session=new _9(_12.session);this.remote=new _7();this.meta=new _6();this.data=new _5(_12.data);this.router=new _2();this.ui=new UI(_12.ui);this.parser=new _1();this.reloader=new _3();_17();function _18(_19){if(_12.afterNavigationAction){_e.after(_13.router._contentForm,"onNavigation",_12.afterNavigationAction);}if(_19){_19();}};function _1a(_1b){_13.router.startup({profile:_13.session.getConfig("uiconfig.profile.title")||"Mendix 6",urlPrefix:_12.appPath});if(_13.session.getConfig("listenToReload")&&!_12.disableFastReload){new _4(_13.remoteUrl.replace(/^https?/,"ws")+"reload/").addOnReload(_13.reloader.reloadPage.bind(_13.reloader));}_13.ui.startup(function(){_13.parser.startup(function(){if(!_13.reloader.tryRestorePage()){_13.remote.execute(_13.session.getConfig());}_1b();});});};this.toString=function(){return _14;};this.isLoaded=function(){return _15;};this.addOnLoad=function(_1c){_15?_1c():_16.push(_1c);};this.reload=function(){this.redirect(this.homeUrl);};this.redirect=function(_1d){window.location.href=_1d+window.location.search+window.location.hash;};this.startup=function(){if(_15){throw new Error("Client has already been started up!");}this.session.authorized({params:{offline:_12.offline||false,referrer:_12.referrer||null},no:function(_1e){var _1f=_1e&&_a.inArray(_1e.http_code,["402","404","500","503"])?_1e.http_code:0;var _20=_31("reloginReason");_13.ui.showLogin(_20||_1f);},yes:function(_21){_13.meta.startup();var _22=_13.session.getConfig("sync_config");var _23=_21&&_22&&_22.fetch;var _24=_12.store||{};if(_22){_13.data.setOfflineStore(new _c(_22.schema,_24.createStoreFn),_22.fetch);}_13.data.startup();_13.session.startup();var _25=[];if(_23){_25.push(function(_26){_13.data.uploadDataWithReset(_26,function(e){_13.onError(e);if(_26){_26();}});});}_25=_25.concat([_1a,_18,_27]);if(_23){_25.push(function(_28){var _29=_13.ui.showProgress(null,true);_13.data.synchronizeDataWithFiles(function(){_13.ui.reload(function(){_13.ui.hideProgress(_29);if(_28){_28();}});},function(e){_13.ui.hideProgress(_29);_13.onError(e);if(_28){_28();}});});}_a.sequence(_25);function _27(_2a){_15=true;while(_16.length>0){_16.shift()();}if(_2a){_2a();}};}});};this.login=function(_2b,_2c,_2d,_2e){this.session.login({username:_2b,password:_2c,success:function(){if(_2d){_2d();}if(_13.afterLoginAction){_13.afterLoginAction();}else{_15?_13.reload():_13.startup();}},error:_2e});};this.logout=function(){this.session.logout(_10.hitch(this,"reload"));};function _17(){_e.before(_13.server,"onUnauthorized",function(_2f){if(_2f=="401"){_2f="419";}_d("reloginReason",_2f,{expires:10/(24*60*60)});_13.reload();});};this.onError=function(_30){_b.error("Error: "+_30.message);};function _31(_32){var _33=_d(_32);_d(_32,null,{expires:-1});return _33;};};return _11;});