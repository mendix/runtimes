/* @preserve
    Copyright (c) 2005-2016, Mendix bv. All rights reserved.
    See mxclientsystem/licenses.txt for third party licenses that apply.
*/
webpackJsonp([2],{368:function(t,e,n){function r(t,e,n){n=n||{},this._store=t,this._guidMap={},this._getStorageDir=n.getStorageDirFn||b,this._getDocumentUrl=n.getDocumentUrlFn||_,this._downloadFileFn=n.downloadFileFn||g,this._fetchConfig=e}function i(t,e){var n=t.getByXPath(e).then(function(t){return t.mxobjects});return x.taskFromPromise(n)}function o(t,e,n,r){var i=r.map(function(r){var i=v(r),o=F.openDirectory(e,"files/documents").chain(function(t){return F.createFileTask(t,i,{create:!1})}).chain(F.createGetFileBlobTask).chain(F.createReadAsArrayBufferTask),u=o.chain(function(e){return c(t,n[r],{},new Blob([e]))});return[r,u]});return B.objectFromArray(i)}function u(t,e){var n=t.create(e).then(function(t){return t.mxobject});return x.taskFromPromise(n)}function a(t,e,n,r){return x.taskFromPromise(t.commit(e,n,r))}function c(t,e,n,r){var i=t.saveDocument(e,{},[],null,n,r);return x.taskFromPromise(i)}function s(t,e){var n=window.mx.meta.getEntity(e.$objectType),r=n.getAttributes().filter(n.isSyncable.bind(n));return B.objectFromArray(y(r.map(function(r){var i=n.getAttributeType(r),o=C[i];if(!o)return[];if(n.isReference(r)){var u=e[r],a=t[u];return a?[[r,o(a)]]:[[r,o(u)]]}return[[r,o(e[r])]]})))}function f(t){var e=Object.keys(t).filter(function(t){return!l(t)}).reduce(function(e,n){return e[n]={value:null===t[n]?"":t[n],readonly:t.$readonlyAttrs.indexOf(n)!==-1},e},{});return{guid:t.guid,objectType:t.$objectType,attributes:e}}function l(t){return"guid"===t||"$"===t[0]}function p(t){var e={guid:t.guid,$objectType:t.objectType};for(var n in t.attributes)e[n]=t.attributes[n].value;return e}function m(t){return new q({json:t,meta:window.mx.meta.getEntity(t.objectType)})}function h(t){return t.getAttributes().reduce(function(e,n){return e[n]=d(t,n),e},{})}function d(t,e){var n=t.getAttributeType(e);return P[n]}function g(t,e,n,r){D.downloadFile(I.getStaticResourceUrlFromPath(t),{location:window.TEMPORARY,path:"files/"+e},n,r)}function y(t){return[].concat.apply([],t)}function b(t,e){F.getFileSystem(window.TEMPORARY).then(function(e){t&&t(e.root)},e)}function _(t,e,n){var r=n?"thumbnails":"documents";return"filesystem:"+window.mx.appUrl+"temporary/files/"+r+"/"+t+"?"+ +new Date}function v(t){return t.replace(/:/g,"_")}function T(t){return null==t?"":String(t)}function w(t){return String(!!t)}var j=n(45),E=n(470),S=n(198),F=n(431),D=n(432),k=n(473),O=n(199),R=n(201),A=n(202),N=n(116),x=n(117),I=n(31),B=n(4),q=n(44),P=(n(5),{String:"",Integer:"0",Long:"0",Decimal:"0",Float:"0",Currency:"0",Enum:"",HashString:"",ObjectReference:"",DateTime:null,Boolean:!1,AutoNumber:"0",Binary:""}),C={String:String,Integer:String,Long:String,Decimal:String,Float:String,Currency:String,Enum:String,HashString:String,ObjectReference:String,DateTime:T,Boolean:w,AutoNumber:null,Binary:String};r.prototype=new A,r.prototype.getByGuid=function(t,e){var n=t.map(this._getByGuid.bind(this)),r=S.sequence(n,N).map(function(t){return t.map(f)}).map(function(t){return{mxobjects:t}});return x.promiseFromTask(r)},r.prototype.getSlice=function(t,e,n){function r(e){var n=mx.meta.getEntity(t);return n.isReference(e.attribute)?(e.value=this._getInternalGuid(e.value),e):e}e=e||[];var i=e.map(r.bind(this));return this._store.getSlice(t,i,n).then(function(t){var e=t[0].map(function(t){return this._isStoredLocalGuid(t.guid)&&(this._guidMap[t.guid]=k.create()),Object.keys(t).filter(function(t){return!l(t)}).filter(function(e){var n=window.mx.meta.getEntity(t.$objectType);return n.isReference(e)}).forEach(function(e){this._isStoredLocalGuid(t[e])&&(this._guidMap[t[e]]=k.create())},this),this._makeObjectExternal(t)},this).map(f);return{mxobjects:e,count:t[1]}}.bind(this))},r.prototype.create=function(t,e){var n=k.create(),r=mx.meta.getEntity(t);this._guidMap[n]=n;var i=Object.assign({guid:n,$objectType:t,$readonlyAttrs:[]},h(r)),o=f(i);return j.resolve({objects:[o],mxobject:o})},r.prototype.commit=function(t,e,n,r,i){function o(t){return function(){return!t.apply(this,arguments)}}function u(t){return n.some(function(e){return e.guid==t})}e=e||{},n=n||[];var a=t.filter(function(t){var n=t in e,r=u(t);return n||r},this);if(0===a.length)return j.resolve({objects:n,changes:e});var c=Object.keys(e).filter(o(u)),s=c.map(this._getByGuid.bind(this)),f=S.sequence(s,N),l=f.map(function(t){var r=n.map(p).concat(t),i=r.map(function(t){return[t.guid,Object.assign({},t,e[t.guid])]});return B.objectFromArray(i)}.bind(this)),m=l.chain(function(t){var r=a.map(function(e){var n=t[e];return this._makeObjectInternal(n)},this),i=R.fromArray(a),o=i.chain(function(e){return this._calculateAutoCommitGuids(e,t)}.bind(this)).difference(i),u=o.values().map(function(e){return this._makeObjectInternal(t[e])},this),c=this._store.insertOrReplace(r,u),s=R.fromArray(Object.keys(e)),f=i.intersection(s),l=n.filter(function(t){return!f.contains(t.guid)}),p=s.difference(f).values(),m=p.map(function(t){return[t,e[t]]});return x.taskFromPromise(c).map(function(){return{objects:l,changes:B.objectFromArray(m),commits:f.values()}})}.bind(this));return x.promiseFromTask(m)},r.prototype.rollback=function(t){function e(t,e,n){return E.fromObject({internalObjs:[t],updateTasks:[e||N.of()],deleteTasks:[n||N.of()]})}function n(){return E.fromObject({internalObjs:[],updateTasks:[],deleteTasks:[]})}function r(t,e){return this._store.deleteObject(t,e)}function i(t){return this._store.fetchDirty().chain(function(e){var n=y(e.map(function(e){var n=window.mx.meta.getEntity(e.$objectType),r=n.getReferenceAttributes().filter(function(n){return e[n]===t});return r.length>0?(r.reduce(function(t,e){return t[e]="",t},e),[this._store.updateObject(e.$objectType,e)]):[]},this));return S.sequence_(n,N)}.bind(this))}function o(t,e){return t.concat(e)}var u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],c=t.map(function(t){var o=this._getInternalGuid(t),u=x.taskFromPromise(this._store.getByGuid(o));return u.map(function(t){return 1===t.$autocommitted?e(t,i.call(this,o),r.call(this,t.$objectType,o)):e(t)}.bind(this)).orElse(function(){return N.of(n())})},this),s=S.sequence(c,N).map(function(t){return t.reduce(o,n())}).chain(function(t){var e=t.get(),n=S.sequence_(e.updateTasks,N),r=S.sequence_(e.deleteTasks,N);return O.sequence_([n,r],N).map(function(){return e.internalObjs.map(this._makeObjectExternal,this)}.bind(this))}.bind(this)).map(function(t){var e=R.fromArray(t.map(function(t){return t.guid})),n=a.filter(function(t){return!e.contains(t.guid)}),r=R.fromArray(Object.keys(u)),i=r.difference(e).values(),o=i.map(function(t){return[t,u[t]]});return{objects:n,changes:B.objectFromArray(o),rollbacks:e.values()}});return x.promiseFromTask(s)},r.prototype.saveDocument=function(t,e,n,r,i,o){function u(t,e,n,r){return t.size/1048576>e?void N.rejected(new Error("File too large")):new N(function(t,e){a._getStorageDir(e,t)}).chain(function(t){var e=n.split("/"),i=e.pop();return F.openDirectory(t,e).chain(function(t){return F.createFileTask(t,i,r).chain(function(t){return F.createWriterTask(t).chain(function(t){return F.createWriteTask(t,o)})})})})}var a=this,c="files/documents/"+v(this._getInternalGuid(t)),s=u(o,i.maxFileSize,c,{create:!0}).chain(function(){var r=Object.assign({},e);return r[t]=Object.assign(r[t]||{},{HasContents:!0}),x.taskFromPromise(a.commit([t],r,n))});return x.promiseFromTask(s)},r.prototype.reset=function(){return x.promiseFromTask(this._store.resetDatabase().map(function(){}))},r.prototype.upload=function(t){function e(e){var n=e.map(function(e){var n=u(t,e.$objectType);return n.map(function(t){return[e.guid,t.guid]})});return S.sequence(n,N).map(B.objectFromArray)}function n(e,n){function r(t){return{guid:n[t.guid],objectType:t.$objectType}}var i=e.map(function(t){return n[t.guid]}),o=B.objectFromArray(e.map(function(t){return[n[t.guid],s(n,t)]}));return a(t,i,o,e.map(r))}function r(t){var e=window.mx.meta.getEntity(t.$objectType),n=B.arrayFromObject(t),r=n.filter(B.spread(function(t,n){return l(t)||e.isSyncable(t)}));return B.objectFromArray(r)}function i(t){Object.keys(t).forEach(function(e){var n=t[e],r=this._guidMap[e];this._guidMap[n]=r,delete this._guidMap[e]},this)}function c(t){return t.filter(function(t){var e=window.mx.meta.getEntity(t.$objectType);return e.isA("System.FileDocument")&&t.HasContents}).map(function(t){return t.guid})}var f=this,p=this._store.upload(t).chain(function(u){var a=u.map(r);return e(a).chain(function(e){return n(a,e).chain(function(){i.call(f,e);var n=c(a);return f._createGetStorageDirTask().map(function(r){return o(t,r,e,n)})})})});return x.promiseFromTask(p)},r.prototype.download=function(t){function e(t){var e=[],n=t.getGuid(),r=t.get("changedDate");return t.isA("System.FileDocument")&&t.get("HasContents")&&(e.push(this._createFileTransferTask(I.getDynamicResourcePath(n,r),"documents/"+n)),t.isA("System.Image")&&e.push(this._createFileTransferTask(I.getDynamicResourcePath(n,r,!0),"thumbnails/"+n))),[n,S.sequence_(e,N)]}var n=S.sequence(this._fetchConfig.map(function(n){return i(t,n.xpath).map(function(t){var r=t.map(m),i=r.map(e.bind(this));return{fileDownloadTaskPairs:i,rebuildPairsList:[n.store,t.map(p)]}}.bind(this))}.bind(this)),N),r=n.chain(function(t){var e=t.map(function(t){return t.fileDownloadTaskPairs}),n=t.map(function(t){return t.rebuildPairsList});return this._store.rebuildDatabase(n).map(function(){var t=B.objectFromArray(y(e));return t})}.bind(this));return x.promiseFromTask(r)},r.prototype.cleanupDirtyObjects=function(){return x.promiseFromTask(this._store.cleanupDirtyObjects())},r.prototype.getDocumentUrl=function(t,e,n){return this._getDocumentUrl(v(this._getInternalGuid(t)),e,n)},r.prototype.getImageUri=function(t,e,n){e&&e(t)},r.prototype._createGetStorageDirTask=function(){return new N(function(t,e){this._getStorageDir(e,t)}.bind(this))},r.prototype._createFileTransferTask=function(t,e){return new N(function(n,r){this._downloadFileFn(t,e,r,n)}.bind(this))},r.prototype._getByGuid=function(t){var e=this._store.getByGuid(this._getInternalGuid(t)),n=x.taskFromPromise(e);return n.map(this._makeObjectExternal.bind(this))},r.prototype._getInternalGuid=function(t){for(var e in this._guidMap)if(this._guidMap[e]===t)return e;return t},r.prototype._getExternalGuid=function(t){return this._guidMap[t]||t},r.prototype._makeObjectInternal=function(t){return this._remapGuidsInObject(t,this._getInternalGuid.bind(this))},r.prototype._makeObjectExternal=function(t){return this._remapGuidsInObject(t,this._getExternalGuid.bind(this))},r.prototype._remapGuidsInObject=function(t,e){return Object.keys(t).reduce(function(n,r){var i=window.mx.meta.getEntity(t.$objectType),o="guid"===r||!l(r)&&i.isReference(r);return n[r]=o?e(t[r]):t[r],n},{})},r.prototype._isStoredLocalGuid=function(t){return/^GUID:/.test(t)&&null==this._guidMap[t]},r.prototype._getReferenceGuids=function(t,e){var n=e[t],r=window.mx.meta.getEntity(n.$objectType),i=r.getReferenceAttributes().map(function(t){return n[t]}).filter(function(t){return null!=t&&""!==t&&t in e},this);return R.fromArray(i)},r.prototype._calculateAutoCommitGuids=function(t,e){for(var n=this,r=R.empty(),i=this._getReferenceGuids(t,e);r.length()!==i.length();){var o=i.reduce(function(t,r){return t.union(n._getReferenceGuids(r,e))},R.empty());r=i,i=i.union(o)}return i},t.exports=r},369:function(t,e,n){function r(){return window.openDatabase("MendixDatabase","1","Mendix Database",10485760)}function i(t,e){a.call(this),e=e||r,this._tableNames=t,this._db=e(),this._initialize()(this._db)}var o=(n(39),n(479)),u=n(478),a=n(472),c=n(403),s=n(117);i.prototype=Object.create(a.prototype),i.prototype._getDatabase=function(){return this._databasePromise},i.prototype._initialize=function(){return function(t){var e=o.createCreateTransaction(this._tableNames);return this._databasePromise=s.promiseFromTask(u.runWriteTransaction(t,e)).then(function(){return t}),this._databasePromise}.bind(this)},i.prototype._resetDatabase=function(){return function(t){var e=o.createResetTransaction(this._tableNames);return this._databasePromise=s.promiseFromTask(u.runWriteTransaction(t,e)).then(function(){return t}),this._databasePromise}.bind(this)},i.prototype._fetch=function(t){return function(e){var n=o.createFetchByGuidTransaction(t);return s.promiseFromTask(u.runReadTransaction(e,n))}},i.prototype._fetchSlice=function(t,e,n){return function(r){var i=o.createFetchSliceTransaction(t,e,n.offset,n.limit,n.sort);return s.promiseFromTask(u.runReadTransaction(r,i))}},i.prototype._rebuildDb=function(t){return c.ask().chain(function(e){var n=o.createRebuildTransaction(this._tableNames,t);return new c(function(t){return u.runWriteTransaction(e,n)})}.bind(this))},i.prototype._insertOrReplace=function(t,e){return function(n){var r=o.createInsertOrReplaceTransaction(t,e);return s.promiseFromTask(u.runWriteTransaction(n,r))}},i.prototype._fetchDirty=function(){return c.ask().chain(function(t){var e=o.createFetchDirtyObjectsTransaction();return new c(function(n){return u.runWriteTransaction(t,e)})})},i.prototype._upload=function(){return c.ask().chain(function(t){var e=o.createUploadTransaction();return new c(function(n){return u.runWriteTransaction(t,e)})})},i.prototype._cleanupDirtyObjects=function(){return function(t){var e=o.createDirtyCleanupTransaction();return u.runWriteTransaction(t,e)}},i.prototype._updateObject=function(t,e){return c.ask().chain(function(n){var r=o.createUpdateTransaction(t,e);return new c(function(t){return u.runWriteTransaction(n,r)})})},i.prototype._deleteObject=function(t,e){return c.ask().chain(function(n){var r=o.createDeleteTransaction(t,e);return new c(function(t){return u.runWriteTransaction(n,r)})})},t.exports=i},396:function(t,e){t.exports={LIKE_ESCAPE_CHAR:"~",QUOTE_CHAR:'"'}},403:function(t,e,n){var r=n(471),i=n(116),o=new r(i);o.rejected=function(t){return new o(function(e){return i.rejected(t)})},t.exports=o},431:function(t,e,n){var r=n(116),i=n(45),o={},u=[];o.getFileSystem=function(t){return u[t]||(u[t]=new i(function(e,n){window.webkitRequestFileSystem(t,1048576,e,n)})),u[t]},o.openDirectory=function(t,e){"string"==typeof e&&(e=e.split("/"));var n=e.map(function(t){return function(e){return new r(function(n,r){e.getDirectory(t,{create:!0},function(t){r(t)},n)})}});return n.reduce(function(t,e){return t.chain(function(t){return e(t)})},r.of(t))},o.createFileTask=function(t,e,n){return new r(function(r,i){t.getFile(e,n,i,r)})},o.createGetFileBlobTask=function(t){return new r(function(e,n){t.file(n,e)})},o.createReadAsArrayBufferTask=function(t){return new r(function(e,n){var r=new FileReader;r.onload=function(t){n(t.target.result)},r.onerror=function(t){e(t.target.error)},r.readAsArrayBuffer(t)})},o.createWriterTask=function(t){return new r(function(e,n){t.createWriter(n,e)})},o.createWriteTask=function(t,e){return new r(function(n,r){t.onwrite=r,t.onerror=n,t.write(e)})},o.saveBlob=function(t,e,n,r){return o.createFileTask(e,n,r).chain(function(e){return o.createWriterTask(e).chain(function(e){return o.createWriteTask(e,t)})})},t.exports=o},432:function(t,e,n){function r(t,e,n){return new u(function(r,i){var o=new XMLHttpRequest;o.open("GET",t),Object.keys(n).forEach(function(t){o[t]=n[t]}),Object.keys(e).forEach(function(t){o.setRequestHeader(t,e[t])}),o.onreadystatechange=function(t){var e=t.target;4===e.readyState&&(e.status>=200&&e.status<300?i(e.response):r(e.response))},o.onerror=r,o.send()})}var i=n(198),o=n(431),u=(n(199),n(116)),a={};a.downloadFile=function(t,e,n,a){var c=e.path.split("/"),s=c.pop(),f=r(t,{"X-Csrf-Token":window.mx.session.getCSRFToken()},{responseType:"blob"});o.getFileSystem(e.location).then(function(t){var e=o.openDirectory(t.root,c);i.sequence([f,e],u).chain(function(t){var e=t[0],n=t[1];return o.saveBlob(e,n,s,{create:!0})}).fork(a,n)})},t.exports=a},470:function(t,e){function n(t){this.__values=t}n.fromObject=function(t){return new n(t)},n.empty=n.prototype.empty=function(){return new n({})},n.prototype.concat=function(t){var e={};for(var r in this.__values)r in t.__values?e[r]=this.__values[r].concat(t.__values[r]):e[r]=this.__values[r];for(r in t.__values)r in this.__values||(e[r]=t.__values[r]);return new n(e)},n.prototype.get=function(){return this.__values},n.prototype.toString=function(){return"Multimap"+this.__values},t.exports=n},471:function(t,e){function n(t){function e(t){this.run=t}return e.prototype.chain=function(t){return new e(function(e){return this.run(e).chain(function(n){return t(n).run(e)})}.bind(this))},e.prototype.ap=function(t){return new e(function(e){return this.run(e).ap(t.run(e))}.bind(this))},e.prototype.map=function(t){return this.chain(function(n){return e.of(t(n))})},e.of=function(n){return new e(function(e){return t.of(n)})},e.ask=function(){return new e(t.of)},e}t.exports=n},472:function(t,e,n){function r(){}var i=(n(44),n(45)),o=(n(198),n(432),n(116),n(117)),u=n(403);r.prototype.getSlice=function(t,e,n){return this._getDatabase().then(this._fetchSlice(t,e,n))},r.prototype.getByGuid=function(t){return this._getDatabase().then(this._fetch(t))},r.prototype.insertOrReplace=function(t,e){return this._getDatabase().then(this._insertOrReplace(t,e))},r.prototype.resetDatabase=function(){return o.taskFromPromise(this._getDatabase().then(this._resetDatabase()))},r.prototype.rebuildDatabase=function(t){var e=this;return o.taskFromPromise(this._getDatabase().then(function(n){return o.promiseFromTask(e._rebuildDb(t).run(n))}))},r.prototype.fetchDirty=function(){var t=this,e=this._getDatabase().then(function(e){var n=t._fetchDirty().run(e);return o.promiseFromTask(n)});return o.taskFromPromise(e)},r.prototype.upload=function(){var t=this,e=this._getDatabase().then(function(e){var n=t._upload().run(e);return o.promiseFromTask(n)});return o.taskFromPromise(e)},r.prototype.updateObject=function(t,e){var n=this;return o.taskFromPromise(this._getDatabase().then(function(r){return o.promiseFromTask(n._updateObject(t,e).run(r))}))},r.prototype.deleteObject=function(t,e){var n=this;return o.taskFromPromise(this._getDatabase().then(function(r){return o.promiseFromTask(n._deleteObject(t,e).run(r))}))},r.prototype.cleanupDirtyObjects=function(){return o.taskFromPromise(this._getDatabase()).chain(this._cleanupDirtyObjects())},r.prototype._getDatabase=function(){return i.reject(new Error("not implemented"))},r.prototype._initialize=function(){return i.reject(new Error("not implemented"))},r.prototype._fetch=function(t){return function(t){return i.reject(new Error("not implemented"))}},r.prototype._fetchSlice=function(t,e,n){return function(t){return i.reject(new Error("not implemented"))}},r.prototype._insertOrReplace=function(t,e){return function(t){return i.reject(new Error("not implemented"))}},r.prototype._rebuildDb=function(t){return u.rejected(new Error("not implemented"))},r.prototype._fetchDirty=function(){return u.rejected(new Error("not implemented"))},r.prototype._cleanupDirtyObjects=function(){return u.rejected(new Error("not implemented"))},r.prototype._upload=function(){return u.rejected(new Error("not implemented"))},t.exports=r},473:function(t,e,n){var r=n(4),i="GUID:";t.exports={create:function(){return i+r.getUniqueId()}}},474:function(t,e){function n(t){return this instanceof n?void(t instanceof n?this._column=t._column:this._column=t):new n(t)}n.prototype.apply1=function(t){return new n(t+"("+this._column+")")},n.prototype.toString=function(){return this._column},t.exports=n},475:function(t,e,n){function r(t,e){this._tableName=e&&e.tableName||t&&t._tableName||null,this._columns=e&&e.columns||t&&t._columns||[]}function i(t){var e=o.QUOTE_CHAR;return e+t+e}var o=n(396);r.prototype.table=function(t){return new r(this,{tableName:t})},r.prototype.column=function(t,e){return new r(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!1})})},r.prototype.primaryKeyColumn=function(t,e){return new r(this,{columns:this._columns.concat({columnName:t,columnType:e,isPrimary:!0})})},r.prototype.createIfNotExists=function(){var t="";return t+="CREATE TABLE IF NOT EXISTS "+i(this._tableName),t+=this._buildSql()},r.prototype._buildSql=function(){var t="";return this._columns.length>0&&(t+=" (",t+=this._columns.map(function(t){var e=i(t.columnName);return[e,t.columnType,t.isPrimary?"PRIMARY KEY ":""].join(" ").slice(0,-1)},this).join(", "),t+=")"),t},t.exports=r},476:function(t,e,n){function r(t,e){return this instanceof r?(this._tableName=e&&e.tableName||t&&t._tableName||null,void(this._columnNames=e&&e.columnNames||t&&t._columnNames||[])):new r}function i(t){var e=o.QUOTE_CHAR;return e+t+e}var o=n(396);r.prototype.into=function(t){return new r(this,{tableName:t})},r.prototype.column=function(t){return new r(this,{columnNames:this._columnNames.concat(t)})},r.prototype.insert=function(){var t="";return t+="INSERT INTO "+i(this._tableName),t+=this._buildSql()},r.prototype.insertOrReplace=function(){var t="";return t+="INSERT OR REPLACE INTO "+i(this._tableName),t+=this._buildSql()},r.prototype._buildSql=function(){var t="";return this._columnNames.length>0&&(t+=" (",t+=this._columnNames.map(i).join(", "),t+=")"),t+=" VALUES (",t+="?"+new Array(this._columnNames.length).join(", ?"),t+=")"},t.exports=r},477:function(t,e,n){function r(t,e){this._select=e&&e.select||t&&t._select||null,this._from=e&&e.from||t&&t._from||{},this._constraints=e&&e.constraints||t&&t._constraints||[],this._orderBy=e&&e.orderBy||t&&t._orderBy||[],this._limit=e&&e.limit||t&&t._limit||null,this._offset=e&&e.offset||t&&t._offset||null}function i(t,e){this._column=t,this._negate=!!e}function o(t,e,n){this._column=t,this._operator=e,this._negate=!!n}function u(t){return function(e){return e+" "+t+" ?"}}function a(t){var e="";return e+=t,e+=" LIKE '%' || ? || '%'",e+=" ESCAPE '"+c.LIKE_ESCAPE_CHAR+"'"}var c=n(396),s={equals:u("="),lessThan:u("<"),lessThanOrEquals:u("<="),greaterThan:u(">"),greaterThanOrEquals:u(">="),contains:a};r.prototype.from=function(t,e){return new r(this,{from:{name:t,alias:e}})},r.prototype.where=function(t,e){return this._where(t,!1,e)},r.prototype.whereNot=function(t,e){return this._where(t,!0,e)},r.prototype.whereNull=function(t,e){return this._whereNull(t,!1,e)},r.prototype.whereNotNull=function(t,e){return this._whereNull(t,!0,e)},r.prototype.order=function(t,e){return new r(this,{orderBy:this._orderBy.concat([[t,e]])})},r.prototype.limit=function(t){return new r(this,{limit:t})},r.prototype.offset=function(t){return new r(this,{offset:t})},r.prototype.select=function(t,e){Array.isArray(t)&&(t=t.join(", "));var n="SELECT "+t;return e&&(n+=" AS "+e),n+=this._buildSql()},r.prototype._where=function(t,e,n){return new r(this,{constraints:this._constraints.concat([new o(t,n,e)])})},r.prototype._whereNull=function(t,e){return new r(this,{constraints:this._constraints.concat([new i(t,e)])})},r.prototype._buildSql=function(){var t="";return t+=" FROM "+this._from.name,this._from.alias&&(t+=" AS "+this._from.alias),this._constraints.length>0&&(t+=" WHERE "+this._constraints.map(function(t){return t.toString()}).join(" AND ")),this._orderBy.length>0&&(t+=" ORDER BY "+this._orderBy.map(function(t){return t[0]+" "+t[1]}).join(", ")),this._limit&&(t+=" LIMIT "+this._limit),this._offset&&(t+=" OFFSET "+this._offset),t},i.prototype.toString=function(){return this._column+" IS "+(this._negate?"NOT ":"")+"NULL"},o.prototype.toString=function(){var t=s[this._operator];return(this._negate?"NOT ":"")+t(this._column)},t.exports=r},478:function(t,e,n){function r(t){return function(e,n){return new i(function(r,i){var o,u=2;e[t](function(t){n.run(t).fork(r,function(t){o=t,0===--u&&i(o)})},r,function(){0===--u&&i(o)})})}}var i=n(116);t.exports={runReadTransaction:r("readTransaction"),runWriteTransaction:r("transaction")}},479:function(t,e,n){function r(t){var e=["_guidToTable"].concat(t).map(v).map(function(t){return"DROP TABLE IF EXISTS '"+t+"'"}).map(function(t){return j(t,[])});return A.sequence([O.sequence(e,B),i(t)],B)}function i(t){function e(t){var e=n(t).reduce(function(t,e){return t.column(v(e.attr),e.type)},(new F).table(v(t)).primaryKeyColumn("guid","text"));return j(e.createIfNotExists(),[])}function n(t){var e=mx.meta.getEntity(t);return e.getAttributes().map(function(t){var n=e.getAttributeType(t);return{attr:t,type:q[n]}})}var r=[a()].concat(t.map(e));return O.sequence(r,B)}function o(t,e){var n=e.reduce(function(e,n){var r=l(),i=m(t,n);return e.concat([j(r.insert(),[n.guid,t,0,0]),j(i.builder.insert(),i.values)])},[]);return O.sequence(n,B)}function u(t,e){e+=0;var n=t.$objectType,r=l(),i=m(n,t);return O.sequence_([j(r.insertOrReplace(),[t.guid,n,1,e]),j(i.builder.insertOrReplace(),i.values)],B)}function a(){var t=(new F).table("_guidToTable").primaryKeyColumn("guid","text").column("tableName","text").column("dirty","boolean").column("autocommitted","boolean").createIfNotExists();return j(t,[])}function c(){var t=(new S).from("_guidToTable").where("dirty","equals").select("*");return j(t,[1])}function s(){var t=(new S).from("_guidToTable").where("autocommitted","equals").select("guid");return j(t,[1])}function f(t){var e=(new S).from("_guidToTable").where("guid","equals").select("guid");return j(e,[t])}function l(){return(new k).into("_guidToTable").column("guid").column("tableName").column("dirty").column("autocommitted")}function p(t,e){return e.reduce(function(e,n){var r=t.getAttributeType(n.attribute),i=P[r],o=""===n.value||null==n.value,u=L[r],a=C[r];if(null==i||!a)return e;var c=a(u(n.value));if(o&&i&&"equals"===n.operator){var s=n.negate?e.builder.whereNotNull:e.builder.whereNull;return{constraintString:s.call(e.builder,v(n.attribute)),args:e.args}}if(o&&i&&"contains"===n.operator)return e;var f=n.negate?e.builder.whereNot:e.builder.where,l="contains"===n.operator?_(c):c;return{builder:f.call(e.builder,v(n.attribute),n.operator),args:e.args.concat([l])}},{builder:new S,args:[]})}function m(t,e){var n=mx.meta.getEntity(t),r=n.getAttributes(),i=r.reduce(function(t,r){var i=n.getAttributeType(r),o=C[i];if(!o)return t;var u=o(e[r]);return{attrs:t.attrs.concat([r]),values:t.values.concat([u])}},{attrs:["guid"],values:[e.guid]}),o=i.attrs.reduce(function(t,e){return t.column(v(e))},(new k).into(v(t)));return{builder:o,values:i.values}}function h(t){if(""===t)return"";var e=20,n=new I(t),r=e-Math.max(0,n.e)-1,i=n.s<0?"-":"",o=new Array(r+1).join("0"),u=n.abs().toFixed();return i+o+u}function d(t){return null==t?null:Number(t)}function g(t){return"false"!==t}function y(t){return t}function b(t){for(var e=[],n=0;n<t.length;++n)e.push(t.item(n));return e}function _(t){var e=E.LIKE_ESCAPE_CHAR;return t.replace(new RegExp(e,"g"),e+e).replace(/%/g,e+"%").replace(/_/g,e+"_")}function v(t){return t.replace(".","$")}function T(t){return t.replace("$",".")}function w(t,e,n,r){var i={guid:r.guid,$objectType:t.getEntity(),$autocommitted:e,$readonlyAttrs:[]};for(var o in r){var u=T(o);if("guid"!==u){var a=t.getAttributeType(u),c=G[a];c&&(i[u]=c(r[o]),n&&i.$readonlyAttrs.push(u))}}return i}function j(t,e){return e=e||[],new B(function(n){return new x(function(r,i){n.executeSql(t,e,function(t,e){i(e)},function(t,e){r(e)})})})}var E=n(396),S=n(477),F=n(475),D=n(474),k=n(476),O=n(198),R=n(92),A=n(199),N=n(403),x=n(116),I=n(39),B=N,q={String:"text",Integer:"text",Long:"text",Decimal:"text",Float:"text",Currency:"text",Enum:"text",HashString:"text",ObjectReference:"text",DateTime:"integer",Boolean:"integer",AutoNumber:"integer",Binary:"blob"},P={String:!1,Integer:!1,Long:!1,Decimal:!1,Float:!1,Currency:!1,Enum:!1,HashString:!1,ObjectReference:!1,DateTime:!0,Boolean:!0,AutoNumber:!0,Binary:!1},C={String:String,Integer:h,Long:h,Decimal:h,Float:h,Currency:h,Enum:String,HashString:String,ObjectReference:String,DateTime:d,Boolean:Number,AutoNumber:String,Binary:String},G={String:String,Integer:String,Long:String,Decimal:String,Float:String,Currency:String,Enum:String,HashString:String,ObjectReference:String,DateTime:y,Boolean:Boolean,AutoNumber:String,Binary:String},L={String:y,Integer:y,Long:y,Decimal:y,Float:y,Currency:y,Enum:y,HashString:y,ObjectReference:y,DateTime:Number,Boolean:g,AutoNumber:y,Binary:y},M={String:"UPPER",Enum:"UPPER"},H={createCreateTransaction:i,createResetTransaction:r,createFetchByGuidTransaction:function(t){var e=(new S).from("_guidToTable").where("guid","equals").select("*");return j(e,[t]).chain(function(t){return 0===t.rows.length?B.rejected(new Error("guid not found")):1!==t.rows.length?B.rejected(new Error("db consistency error")):B.of(t.rows.item(0))}).chain(function(e){var n=e.tableName,r=!e.dirty,i=e.autocommitted,o=(new S).from(v(n)).where("guid","equals").select("*");return j(o,[t]).map(function(t){return 0===t.rows.length?x.rejected(new Error("entity not found")):1!==t.rows.length?x.rejected(new Error("db consistency error")):w(window.mx.meta.getEntity(n),i,r,t.rows.item(0))})})},createFetchSliceTransaction:function(t,e,n,r,i){e=e||[],i=i||[];var o=mx.meta.getEntity(t),u=p(o,e),a=u.builder.from(v(t)),c=u.args,s=i.reduce(function(t,e){var n=o.getAttributeType(e[0]),r=new D(e[0]),i=M[n];return i&&(r=r.apply1(i)),t.order(r,e[1])},a.offset(n).limit(r)),f=j(s.select("*"),c).map(function(t){for(var e=[],n=0;n<t.rows.length;++n){var r=!/^GUID:/.test(t.rows.item(n).guid),i=0;e.push(w(o,i,r,t.rows.item(n)))}return e}),l=j(a.select("COUNT(*)","cnt"),c).map(function(t){return t.rows.item(0).cnt});return O.lift2(function(t,e){return[t,e]},f,l)},createInsertOrReplaceTransaction:function(t,e){var n=t.map(function(t){return u(t,!1)}),r=e.map(function(t){return f(t.guid).map(function(t){return t.rows.length>0}).chain(function(e){return e?B.of():u(t,!0)})});return O.sequence_(n.concat(r),B)},createFillBulkTransaction:o,createUpdateTransaction:function(t,e){var n=m(t,e);return j(n.builder.insertOrReplace(),n.values)},createFetchDirtyObjectsTransaction:function(){return c().chain(function(t){var e=b(t.rows).map(function(t){return H.createFetchByGuidTransaction(t.guid)});return O.sequence(e,B)})},createUploadTransaction:function(){var t=this;return s().chain(function(e){if(e.rows.length>0){var n="There are autocommitted objects remaining. Sync has failed.";return B.rejected(new R(n))}return t.createFetchDirtyObjectsTransaction()})},createDeleteTransaction:function(t,e){return O.sequence([j("DELETE FROM "+v(t)+" WHERE guid = ?",[e]),j("DELETE FROM _guidToTable WHERE guid = ?",[e])],B)},createDirtyCleanupTransaction:function(){return j("SELECT DISTINCT tableName FROM _guidToTable WHERE dirty = 1").chain(function(t){var e=b(t.rows).map(function(t){var e=t.tableName;return j("DELETE FROM "+v(e)+" WHERE guid IN (SELECT guid FROM _guidToTable WHERE tableName = ? AND dirty = 1)",[e])});return A.sequence_([O.sequence(e,B),j("DELETE FROM _guidToTable WHERE dirty = 1")],B)})},createRebuildTransaction:function(t,e){var n=r(t),i=e.map(function(t){return o(t[0],t[1])});return A.sequence([n,O.sequence(i,B)],B)}};t.exports=H}});