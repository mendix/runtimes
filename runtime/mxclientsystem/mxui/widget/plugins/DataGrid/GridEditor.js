
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/plugins/DataGrid/GridEditor",["dojo","dijit","dojox","dojo/require!mxui/widget/DataGrid,mxui/widget/MxInlineEditor"],function(_1,_2,_3){_1.provide("mxui.widget.plugins.DataGrid.GridEditor");_1.require("mxui.widget.DataGrid");_1.require("mxui.widget.MxInlineEditor");if(!mxui.widget.plugins){mxui.widget.plugins={};}if(!mxui.widget.plugins.DataGrid){mxui.widget.plugins.DataGrid={};}mxui.widget.plugins.DataGrid.GridEditor=function(_4){var _5="plugins.GridEditor";this._connects=[];var _6=_1.hitch;var _7=mxui.dom.getFirstChild;var _8=mxui.dom.getAncestorNode;var _9=null;var _a=null;var _b=false;var _c,_d=null;var _e={mxobject:null,node:null,row:-1,key:"",attr:"",attrclass:"",valid:true,invalidmsg:"",saving:false,objectSave:function(){if(!this.valid||!_a()){var _f=new _1.Deferred();_f.errback(new Error(_e.invalidmsg));return _f;}else{if(_e.saving){var _f=this._def=new _1.Deferred();return _f;}else{if(_10.hasChanges()||_10.getEditorStatus()=="active"){if(_c()){var _f=this._def=new _1.Deferred();_d();return _f;}if(!this.valid){this._def=null;return new Error("");}}else{return true;}}}},objectRollback:function(){var _11=_12();if(_11){var def=new _1.Deferred();_11.rollback({error:function(){def.callback();},callback:function(){def.errback();}});return def;}return true;}};var _13=_4.parent;var _14=_4.config;var _10=null;_5=_13.id+"."+_5;var _15=null;var _16={};var _17="";var _18="";var _19=false;if(_13&&(_13.declaredClass!="mxui.widget.DataGrid")){logger.error(_5+".initialize : can only register to DataGrid!");}else{}var _1a={},_1b=[];var _1c=function(){_10.stopEditing();_10.endEdit();if(_e.saving){_13.acceptUpdates();}else{if(_b){_13.objectUpdate();}}_b=false;};var _1d=function(_1e){var _1f=_1e.getGuid();var _20=function(){if(_1a[_1f]){mx.data.unsubscribe(_1a[_1f].sub);mx.data.unsubscribe(_1a[_1f].val);delete _1a[_1f];}};var _21=_1a[_1f];if(_21){clearTimeout(_21.timer);}else{_21=_1a[_1f]=new function(){this.objectUpdate=function(_22){if(typeof _22=="object"){return;}var _23=_1e&&_1e.getGuid();if(_22!=_23){clearTimeout(this.timer);_20();mx.data.get({xpath:"//"+_1e.getEntity()+"[id="+_22+"]",filter:{id:_13.getSchemaId()},noCache:true,callback:function(_24){_13.updateMxObject(_24[0]);},error:function(e){mx.onError(e);}});}};this.validationUpdate=function(_25){_e.invalidmsg=_25[0].getErrorReason(_e.key);};};}_21.timer=setTimeout(_20,5000);_21.sub=mx.data.subscribe({guid:_1f,callback:_1.hitch(_21,"objectUpdate")});_21.val=mx.data.subscribe({guid:_1f,val:true,callback:_1.hitch(_21,"validationUpdate")});};var _26={onLoad:"plugineventOnLoad",preRefresh:"plugineventPreRefresh",onRefresh:"plugineventOnRefresh",onSync:"plugineventOnSync",onCellClicked:"plugineventCellClicked",onSelectRow:"plugineventSelectRow"};var _27=function(_28){var _29=null;if(_e.mxobject){_29=_e.mxobject.getGuid();_e.mxobject=null;}if(_28){_e.mxobject=_28;var _2a=_e.mxobject.getGuid();if(_29!=_2a){_e.valid=true;_e.invalidmsg="";}}};var _12=function(){return _e.mxobject;};var _2b=function(_2c){_e.node=_2c;_e.row=_13.domData(_2c,"row");_e.key=_13.domData(_2c,"key");_e.col=_13.domData(_2c,"column");_e.datakey=_e.key;_e.gridsize=_13.getCurrentGridSize();var _2d=_e.key;if(_2d.match("/")!=null){_2d=_2d.split("/")[0];}_e.attrclass=_9.getAttributeType(_2d);_e.attr=_2d;_e.row=parseInt(_e.row,10);if(_e.key.match(/\//)){_e.key=_e.key.replace(/^.*\//,"");}_27(_13.getMxObjectAtRow(_e.row));};var _2e=function(_2f){var _30=_2f.mxObject;var _31=_2f.attribute;var _32=_2f.value;if(typeof (_32)!="string"){_32=_32.toString();}if(_32==""){return true;}switch(_30.getAttributeType(_31)){case "Enum":var map=_30.getEnumMap(_31);for(var i=0;i<map.length;i++){if(map[i].key==_32){return true;}}return false;break;case "Integer":case "Long":case "Float":case "Currency":var _33=_32.replace(/^-/,"").replace(/(\,|\.)/g,"").replace(/\d/g,"");return (_33=="");break;case "Date":case "DateTime":if(_32.match(/^\d+[\/-]\d+[\/-]\d+$/)!=null){var _34=mx.parser.parseDate(_32);return isNaN(_34)?false:true;}else{return false;}break;default:return true;break;}};_a=function(){var obj=_12();if(!obj){return true;}if(_10.getEditorStatus()!="active"){return true;}if(_10.hasChanges()){var _35=_10.getValue();var _36=_35;var ref=_e.attr;if(_9.isReference(ref)){return true;}else{if(_2e({mxObject:obj,attribute:ref,value:_36})){return true;}else{return false;}}}return true;};_c=function(){var _37=_12();if(!_37){return false;}if(_10.hasChanges()){var _38=_10.getValue();var _39=_38;var ref=_e.attr;if(_9.isReference(ref)){_37.set(ref,_39);}else{if(_2e({mxObject:_37,attribute:ref,value:_39})){_e.valid=true;_e.invalidmsg="";switch(_e.attrclass){case "Date":case "DateTime":_39=(_38=="")?"":mx.parser.parseDate(_38);break;case "Enum":_39=_38;break;case "Long":case "Integer":_39=mx.parser.parseNumber(_38,false,0);_39=isNaN(_39)?"":_39;break;case "Currency":case "Float":_39=mx.parser.parseNumber(_38);_39=isNaN(_39)?"":_1.number.round(_39,_15[_e.col].display.precision);break;case "String":case "Text":_39=mxui.html.sanitizeHTMLString(_38);break;default:break;}_37.set(ref,_39);}else{_e.valid=false;_10.undoChanges();var msg=_e.invalidmsg=mx.ui.translate("mendix.lib.Validations","invalid_attribute",[_38,_37.getEntity()+"/"+_e.key]);mx.ui.error(msg);}}}return _37.hasChanges();};var _3a=function(){if(!_19){_13.addToSyncDeferQueue();_19=true;}else{}};var _3b=function(){if(_19){_13.removeFromSyncDeferQueue();_19=false;}else{}};var _3c=function(e){if(_e._def){_e._def.errback(new Error(""));_e._def=null;}_1b=[];_e.valid=false;_e.saving=false;_13.acceptUpdates();_3b();};_d=function(_3d){if(_3d){_1b.push(_3d);}if(!_e.saving){var _3e=_12();if(_3e&&_3e.hasChanges()){_13.preventUpdates();_e.saving=true;_b=true;_1d(_3e);mx.data.save({mxobj:_3e,callback:function(){_3e.commit({callback:function(){_e.valid=true;_e.invalidmsg="";_e.saving=false;if(_e._def){_e._def.callback();_e._def=null;}_13.acceptUpdates();_3b();mendix.lang.collect(_1b);},error:_3c});},error:_3c});}else{mendix.lang.collect(_1b);}}else{}};var _3f=false;var _40=[];var _41=function(_42,_43){var div=_7(_42,"DIV"),td=_8(_42,"TD");if(_10.getEditorStatus()=="active"){if(_c()){_d();}}if(div&&td){_2b(td);if(_e.row>=_e.gridsize){return;}var _44=_e.datakey,_45=_44.split("/"),ref;if(_45.length>1){_44=_45[0];ref=_45[2];}var _46=_12();if(!_15[_e.col].editable){_1c();_27(null);}else{if(_9.isReference(_44)){var _47=function(_48){var _49={selected:_46.getReference(_44),items:{}};_16[_e.datakey].source.each(function(o){var _4a;switch(o.getAttributeType(ref)){case "Boolean":_49.items[o.getGuid()]=mx.ui.translate("mxui.widget.DataGrid",o.get(ref)+"");break;case "DateTime":_49.items[o.getGuid()]=mx.parser.formatDate(o.get(ref));break;case "Enum":_49.items[o.getGuid()]=o.getEnumCaption(ref);break;default:_49.items[o.getGuid()]=o.get(ref);}});_10.editNode(div,"reference",_49);_43&&_10.startEditing();_48&&_48();};if(!_3f){_40.push(_47);}else{_47();}}else{switch(_9.getAttributeType(_44)){case "Boolean":_10.editNode(div,"boolean",{selected:_46.get(_44)+"",items:{"false":mx.ui.translate("mxui.widget.DataGrid","false"),"true":mx.ui.translate("mxui.widget.DataGrid","true")}});_43&&_10.startEditing();break;case "Date":case "DateTime":_10.editNode(div,"date");break;case "Enum":_10.editNode(div,"enum",{selected:_46.get(_44),items:_9.getEnumKVPairs(_44)});_43&&_10.startEditing();break;default:_10.editNode(div,"text");break;}}}}else{}};var _4b=function(){var _4c=false;for(var i=0,_4d;_4d=_15[i];i++){if(_4c){if(_4d.editable){return _4d.tag;}}if(i==_e.col){_4c=true;}}};var _4e=function(){var key="";for(var i=0,_4f;_4f=_15[i];i++){if(i==_e.col){return key;}if(_4f.editable){key=_4f.tag;}}};var _50=function(){if(_13.getCurrentGridSize()==0){return;}var row=0;var _51=_12();if(_51!=null){var row=_13.getRowForMxObject(_51);if(row==null){row=0;}}var _52=_13.getCellNode(row,_e.datakey||_17);if(_52){_41(_52);}};var _53=function(){if(_13.getCurrentGridSize()==0){return;}var _54=_13.getCellNode(0,_e.datakey||_17);if(_54){_41(_54);}};var _55=function(){_c()&&_d();if(_e.row!=0){var _56=_13.getCellNode((_e.row-1),_e.datakey);_41(_56);}};var _57=function(){_c()&&_d();if(_e.row!=(_e.gridsize-1)){var _58=_13.getCellNode((_e.row+1),_e.datakey);if(_58&&(_58!=_e.node)){_41(_58);}}};var _59=function(){if((_e.datakey==_17)&&(_e.row!=0)){_e.datakey=_18;_55();}else{if(_e.datakey!=_17){_c();var _5a=_13.getCellNode(_e.row,_4e());if(_5a){_41(_5a);}}}};var _5b=function(){if(_e.datakey==_18){if(_e.row!=(_e.gridsize-1)){_e.datakey=_17;_57();}else{_c()&&_d();mxui.wm.focus.next();_1c();_27(null);}}else{if(_e.datakey!=_18){_c();var _5c=_13.getCellNode(_e.row,_4b());if(_5c){_41(_5c);}}}};var _5d=function(){_13.domNode.className+=" inlineGrid";};this.plugineventOnLoad=function(e){_5d();};this.plugineventOnSync=function(e){if(_10.hasChanges()){_3a();_10.stopEditing();if(_c()){_d();}else{_3b();}}};this.plugineventOnDestroy=function(e){_1c();if(_10.hasChanges()){_c();}var _5e=_12();if(_5e&&_5e.hasChanges()){_d();}};this.plugineventSelectRow=function(e){var row=e.row;var _5f=_13.getCellNode(row,_e.datakey||_17);if(_5f){_41(_5f);}};this.plugineventOnRefresh=function(e){if(_13.getCurrentGridSize()==0){return;}switch(_10.getEditorStatus()){case "inactive":break;case "active":case "ready":_50();break;}};this.plugineventPreRefresh=function(e){if(_10.hasChanges()){_c();}var _60=_12();if(_60&&_60.hasChanges()){_d();}_1c();};this.plugineventCellClicked=function(e){if(_10.hasChanges()){_c();}_41(e.target,true);if(e.target.nodeName.toLowerCase()=="select"){_1.stopEvent(e);}else{this._editorClicked=true;}};this.editorClickHandler=function(e){if(!this._editorClicked){try{if(_e.valid&&_c()){_d();}}catch(e){logger.error(_5+".editorClickHandler:"+e.message);}_1c();_27(null);}this._editorClicked=false;};this.editorKeyHandler=function(_61){var _62=_61.keyCode;switch(_10.getEditorStatus()){case "inactive":break;case "ready":switch(_62){case 33:_13.goToPreviousPage(_53);break;case 34:_13.goToNextPage(_53);break;case 35:_13.goToLastPage(_53);break;case 36:_13.goToFirstPage(_53);break;case 37:_59();break;case 38:_55();break;case 9:_61.stopPropagation();_61.preventDefault();if(_61.shiftKey===true){_59();break;}case 39:_5b();break;case 40:_57();break;case 13:case 18:case 32:case 27:case 113:_10.startEditing();break;case _1.keys.BACKSPACE:_10.startEditing("");break;default:if((_62>=48)&&(_62<=110)){_10.startEditing();}break;}break;case "active":switch(_62){case 9:_61.stopPropagation();_61.preventDefault();case 13:_10.stopEditing();_5b();break;case 27:_10.undoChanges();_5b();break;default:break;}break;}return false;};var _63=null;this.destroy=function(){try{while(this._connects.length!=0){_1.disconnect(this._connects.pop());}this.plugineventOnDestroy();_10.destroy();for(var i in _16){_16[i].source.destroy();}_16=null;while(_63.length){mx.screen.unsubscribe(_63.pop());}_63=null;}catch(e){}_13=null;};try{_10=new mxui.widget.MxInlineEditor();}catch(e){}_10.eventKeyHandler=this.editorKeyHandler;_9=mx.meta.getEntity(_13.entity);_15=_13.getEntityProperties();var _64=[];var _65=_13.getGridNodeHash();for(var i=0,_66;_66=_15[i];i++){var tag=_66.tag;_64=tag.split(/\//);if(_66.editable){if(_17==""){_17=tag;}_18=tag;}if(_66.editable){try{if(_9.isReference(_64[0])){_16[tag]={key:_64[_64.length],source:new mendix.lib.XPathSource({entity:_64[_64.length-2],page:100})};var ds=_16[tag].source;ds.reload(function(){_3f=true;mendix.lang.sequence(_40);});}}catch(e){}}}for(var i in _26){_13.registerToPluginEvent(i,_6(this,_26[i]));}this._connects.push(_1.connect(document.body,"onclick",this,"editorClickHandler"));_63=[mx.screen.subscribe(_13.getContent(),"saveObject",_1.hitch(_e,"objectSave")),mx.screen.subscribe(_13.getContent(),"rollbackObject",_1.hitch(_e,"objectRollback"))];_13.registerToPluginEvent("invokeMicroflow",function(_67,_68){_d(_68);},true);};});