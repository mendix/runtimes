/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/plugins/DataGrid/GridEditor",["mxui/widget/MxInlineEditor","mxui/wm/focus","mxui/dom","mendix/logger","dojo/Deferred","dojo/keys","dojo/number","dojo/on","dojo/_base/event","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){function _b(_c){var _d="plugins.GridEditor";this._connects=[];var _e=null;var _f=null;var _10,_11=null;var _12={mxobject:null,node:null,row:-1,key:"",attr:"",attrclass:"",valid:true,invalidmsg:"",saving:false};var _13=_c.parent;var _14=null;_d=_13.id+"."+_d;var _15=null;var _16={};var _17="";var _18="";var _19=false;if(_13&&(_13.declaredClass!="mxui.widget.DataGrid")){_4.error(_d+".initialize : can only register to DataGrid!");}else{}var _1a={},_1b=[];var _1c=function(){_14.stopEditing();_14.endEdit();if(_12.saving){_13.acceptUpdates();}};var _1d=function(_1e){var _1f=_1e.getGuid();var _20=function(){if(_1a[_1f]){window.mx.data.unsubscribe(_1a[_1f].sub);window.mx.data.unsubscribe(_1a[_1f].val);delete _1a[_1f];}};var _21=_1a[_1f];if(_21){clearTimeout(_21.timer);}else{_21=_1a[_1f]=new function(){this.objectUpdate=function(_22){if(typeof _22=="object"){return;}var _23=_1e&&_1e.getGuid();if(_22!=_23){clearTimeout(this.timer);_20();window.mx.data.get({xpath:"//"+_1e.getEntity()+"[id="+_22+"]",filter:{id:_13.getSchemaId()},noCache:true,callback:function(_24){_13.updateMxObject(_24[0]);},error:function(e){window.mx.onError(e);}});}};this.validationUpdate=function(_25){_12.invalidmsg=_25[0].getErrorReason(_12.key);};};}_21.timer=setTimeout(_20,5000);_21.sub=window.mx.data.subscribe({guid:_1f,callback:_a.hitch(_21,"objectUpdate")});_21.val=window.mx.data.subscribe({guid:_1f,val:true,callback:_a.hitch(_21,"validationUpdate")});};var _26={onLoad:"plugineventOnLoad",preRefresh:"plugineventPreRefresh",onRefresh:"plugineventOnRefresh",onSync:"plugineventOnSync",onCellClicked:"plugineventCellClicked",onSelectRow:"plugineventSelectRow"};var _27=function(_28){var _29=null;if(_12.mxobject){_29=_12.mxobject.getGuid();_12.mxobject=null;}if(_28){_12.mxobject=_28;var _2a=_12.mxobject.getGuid();if(_29!=_2a){_12.valid=true;_12.invalidmsg="";}}};var _2b=function(){return _12.mxobject;};var _2c=function(_2d){_12.node=_2d;_12.row=_13.domData(_2d,"row");_12.key=_13.domData(_2d,"key");_12.col=_13.domData(_2d,"column");_12.datakey=_12.key;_12.gridsize=_13.getCurrentGridSize();var _2e=_12.key;if(_2e.match("/")!=null){_2e=_2e.split("/")[0];}_12.attrclass=_e.getAttributeType(_2e);_12.attr=_2e;_12.row=parseInt(_12.row,10);if(_12.key.match(/\//)){_12.key=_12.key.replace(/^.*\//,"");}_27(_13.getMxObjectAtRow(_12.row));};var _2f=function(_30){var _31=_30.mxObject;var _32=_30.attribute;var _33=_30.value;if(typeof (_33)!="string"){_33=_33.toString();}if(_33==""){return true;}switch(_31.getAttributeType(_32)){case "Enum":var map=_31.getEnumMap(_32);for(var i=0;i<map.length;i++){if(map[i].key==_33){return true;}}return false;break;case "Integer":case "Long":case "Float":case "Currency":var _34=_33.replace(/^-/,"").replace(/(\,|\.)/g,"").replace(/\d/g,"");return (_34=="");break;case "Date":case "DateTime":if(_33.match(/^\d+[\/-]\d+[\/-]\d+$/)!=null){var _35=window.mx.parser.parseDate(_33);return isNaN(_35)?false:true;}else{return false;}break;default:return true;break;}};_f=function(){var obj=_2b();if(!obj){return true;}if(_14.getEditorStatus()!="active"){return true;}if(_14.hasChanges()){var _36=_14.getValue();var _37=_36;var ref=_12.attr;if(_e.isReference(ref)){return true;}else{if(_2f({mxObject:obj,attribute:ref,value:_37})){return true;}else{return false;}}}return true;};_10=function(){var _38=_2b();if(!_38){return false;}if(_14.hasChanges()){var _39=_14.getValue();var _3a=_39;var ref=_12.attr;if(_e.isReference(ref)){_38.set(ref,_3a);}else{if(_2f({mxObject:_38,attribute:ref,value:_3a})){_12.valid=true;_12.invalidmsg="";switch(_12.attrclass){case "Date":case "DateTime":_3a=(_39=="")?"":window.mx.parser.parseDate(_39);break;case "Enum":_3a=_39;break;case "Long":case "Integer":_3a=window.mx.parser.parseValue2(_39,"integer");_3a=_3a===null?"":_3a;break;case "Currency":case "Decimal":case "Float":_3a=window.mx.parser.parseValue2(_39,"float",{places:_15[_12.col].display.precision});_3a=_3a===null?"":_3a;break;case "String":case "Text":_3a=_3.unescapeString(_39);break;case "Boolean":_3a=(_39==="true");break;default:break;}_38.set(ref,_3a);}else{_12.valid=false;_14.undoChanges();var msg=_12.invalidmsg=window.mx.ui.translate("mendix.lib.Validations","invalid_attribute",[_39,_38.getEntity()+"/"+_12.key]);window.mx.ui.error(msg);}}}return _38.hasChanges();};var _3b=function(){if(!_19){_13.addToSyncDeferQueue();_19=true;}else{}};var _3c=function(){if(_19){_13.removeFromSyncDeferQueue();_19=false;}else{}};var _3d=function(e){if(_12._def){_12._def.reject(new Error(""));_12._def=null;}_1b=[];_12.valid=false;_12.saving=false;_13.acceptUpdates();_13.objectUpdate();_3c();};_11=function(_3e){if(_3e){_1b.push(_3e);}if(!_12.saving){var _3f=_2b();if(_3f&&_3f.hasChanges()){_13.preventUpdates();_12.saving=true;_1d(_3f);window.mx.data.commit({mxobjs:[_3f],callback:function(){_12.valid=true;_12.invalidmsg="";_12.saving=false;if(_12._def){_12._def.resolve();_12._def=null;}_13.acceptUpdates();_3c();mendix.lang.collect(_1b);},error:_3d});}else{mendix.lang.collect(_1b);}}else{}};var _40=false;var _41=[];var _42=function(_43,_44){var div,td=_3.getAncestorNode(_43,"TD");if(_43.nodeName.toLowerCase()==="div"){div=_43;}else{div=_43.querySelector("div:first-child");}if(_14.getEditorStatus()=="active"){if(_10()){_11();}}if(div&&td){_2c(td);if(_12.row>=_12.gridsize){return;}var _45=_12.datakey,_46=_45.split("/"),ref;if(_46.length>1){_45=_46[0];ref=_46[2];}var _47=_2b();if(!_15[_12.col].editable){_1c();_27(null);}else{if(_e.isReference(_45)){var _48=function(_49){var _4a={selected:_47.getReference(_45),items:{}};_16[_12.datakey].source.each(function(o){var _4b;switch(o.getAttributeType(ref)){case "Boolean":_4a.items[o.getGuid()]=window.mx.ui.translate("mxui.widget.DataGrid",o.get2(ref)+"");break;case "DateTime":_4a.items[o.getGuid()]=window.mx.parser.formatDate(o.get2(ref));break;case "Enum":_4a.items[o.getGuid()]=o.getEnumCaption(ref);break;default:_4a.items[o.getGuid()]=o.get2(ref);}});_14.editNode(div,"reference",_4a);_44&&_14.startEditing();_49&&_49();};if(!_40){_41.push(_48);}else{_48();}}else{switch(_e.getAttributeType(_45)){case "Boolean":_14.editNode(div,"boolean",{selected:_47.get2(_45)+"",items:{"false":window.mx.ui.translate("mxui.widget.DataGrid","false"),"true":window.mx.ui.translate("mxui.widget.DataGrid","true")}});_44&&_14.startEditing();break;case "Date":case "DateTime":_14.editNode(div,"date");break;case "Enum":_14.editNode(div,"enum",{selected:_47.get2(_45),items:_e.getEnumKVPairs(_45)});_44&&_14.startEditing();break;case "Currency":case "Decimal":case "Float":_14.editNode(div,"text",{hasDecimalPoint:true});break;default:_14.editNode(div,"text");break;}}}}else{}};var _4c=function(){var _4d=false;for(var i=0,_4e;_4e=_15[i];i++){if(_4d){if(_4e.editable){return _4e.tag;}}if(i==_12.col){_4d=true;}}};var _4f=function(){var key="";for(var i=0,_50;_50=_15[i];i++){if(i==_12.col){return key;}if(_50.editable){key=_50.tag;}}};var _51=function(){if(_13.getCurrentGridSize()==0){return;}var row=0;var _52=_2b();if(_52!=null){var row=_13.getRowForMxObject(_52);if(row==null){row=0;}}var _53=_13.getCellNode(row,_12.datakey||_17);if(_53){_42(_53);}};var _54=function(){if(_13.getCurrentGridSize()==0){return;}var _55=_13.getCellNode(0,_12.datakey||_17);if(_55){_42(_55);}};var _56=function(){_10()&&_11();if(_12.row!=0){var _57=_13.getCellNode((_12.row-1),_12.datakey);_42(_57);}};var _58=function(){_10()&&_11();if(_12.row!=(_12.gridsize-1)){var _59=_13.getCellNode((_12.row+1),_12.datakey);if(_59&&(_59!=_12.node)){_42(_59);}}};var _5a=function(){if((_12.datakey==_17)&&(_12.row!=0)){_12.datakey=_18;_56();}else{if(_12.datakey!=_17){_10();var _5b=_13.getCellNode(_12.row,_4f());if(_5b){_42(_5b);}}}};var _5c=function(){if(_12.datakey==_18){if(_12.row!=(_12.gridsize-1)){_12.datakey=_17;_58();}else{_10()&&_11();_2.next();_1c();_27(null);}}else{if(_12.datakey!=_18){_10();var _5d=_13.getCellNode(_12.row,_4c());if(_5d){_42(_5d);}}}};var _5e=function(){_13.domNode.className+=" inlineGrid";};this.plugineventOnLoad=function(e){_5e();};this.plugineventOnSync=function(e){if(_14.hasChanges()){_3b();_14.stopEditing();if(_10()){_11();}else{_3c();}}};this.plugineventOnDestroy=function(e){_1c();if(_14.hasChanges()){_10();}var _5f=_2b();if(_5f&&_5f.hasChanges()){_11();}};this.plugineventSelectRow=function(e){var row=e.row;var _60=_13.getCellNode(row,_12.datakey||_17);if(_60){_42(_60);}};this.plugineventOnRefresh=function(e){if(_13.getCurrentGridSize()==0){return;}switch(_14.getEditorStatus()){case "inactive":break;case "active":case "ready":_51();break;}};this.plugineventPreRefresh=function(e){if(_14.hasChanges()){_10();}var _61=_2b();if(_61&&_61.hasChanges()){_11();}_1c();};this.plugineventCellClicked=function(e){if(_14.hasChanges()){_10();}_42(e.target,true);if(e.target.nodeName.toLowerCase()=="select"){_9.stop(e);}else{this._editorClicked=true;}};this.editorClickHandler=function(e){if(!this._editorClicked){try{if(_12.valid&&_10()){_11();}}catch(e){_4.error(_d+".editorClickHandler:"+e.message);}_1c();_27(null);}this._editorClicked=false;};this.editorKeyHandler=function(_62){var _63=_62.keyCode;switch(_14.getEditorStatus()){case "inactive":break;case "ready":switch(_63){case 37:_5a();break;case 38:_56();break;case 9:_62.stopPropagation();_62.preventDefault();if(_62.shiftKey===true){_5a();break;}case 39:_5c();break;case 40:_58();break;case 13:case 18:case 32:case 27:case 113:_14.startEditing();break;case _6.BACKSPACE:_14.startEditing("");break;default:if((_63>=48)&&(_63<=110)){_14.startEditing();}break;}break;case "active":switch(_63){case 9:_62.stopPropagation();_62.preventDefault();case 13:_14.stopEditing();_5c();break;case 27:_14.undoChanges();_5c();break;default:break;}break;}return false;};this.destroy=function(){try{while(this._connects.length!=0){this._connects.pop().remove();}this.plugineventOnDestroy();_14.destroy();for(var i in _16){_16[i].source.destroy();}_16=null;}catch(e){}_13=null;};try{_14=new _1();}catch(e){}_14.eventKeyHandler=this.editorKeyHandler;_e=window.mx.meta.getEntity(_13.entity);_15=_13.getEntityProperties();var _64=[];for(var i=0,_65;_65=_15[i];i++){var tag=_65.tag;_64=tag.split(/\//);if(_65.editable){if(_17==""){_17=tag;}_18=tag;}if(_65.editable){try{if(_e.isReference(_64[0])){_16[tag]={key:_64[_64.length],source:new webcore.datasource.XPathSource({entity:_64[_64.length-2],page:100})};var ds=_16[tag].source;ds.reload(function(){_40=true;mendix.lang.sequence(_41);});}}catch(e){}}}for(var i in _26){_13.registerToPluginEvent(i,_a.hitch(this,_26[i]));}this._connects.push(_8(document.body,"click",_a.hitch(this,"editorClickHandler")));_13.registerToPluginEvent("invokeAction",function(_66,_67){_11(_67);},true);};return _b;});