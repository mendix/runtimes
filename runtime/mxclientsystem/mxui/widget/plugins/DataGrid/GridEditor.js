/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/plugins/DataGrid/GridEditor",["mxui/widget/MxInlineEditor","mxui/wm/focus","mxui/dom","mendix/logger","dojo/Deferred","dojo/keys","dojo/number","dojo/on","dojo/_base/event","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){function _b(_c){var _d="plugins.GridEditor";this._connects=[];var _e=null;var _f=null;var _10=false;var _11,_12=null;var _13={mxobject:null,node:null,row:-1,key:"",attr:"",attrclass:"",valid:true,invalidmsg:"",saving:false,objectSave:function(){if(!this.valid||!_f()){var def=new _5();def.reject(new Error(_13.invalidmsg));return def;}else{if(_13.saving){var def=this._def=new _5();return def;}else{if(_14.hasChanges()||_14.getEditorStatus()=="active"){if(_11()){var def=this._def=new _5();_12();return def;}if(!this.valid){this._def=null;return new Error("");}}else{return true;}}}},objectRollback:function(){var _15=_16();if(_15){var def=new _5();_15.rollback({error:function(){def.resolve();},callback:function(){def.reject();}});return def;}return true;}};var _17=_c.parent;var _14=null;_d=_17.id+"."+_d;var _18=null;var _19={};var _1a="";var _1b="";var _1c=false;if(_17&&(_17.declaredClass!="mxui.widget.DataGrid")){_4.error(_d+".initialize : can only register to DataGrid!");}else{}var _1d={},_1e=[];var _1f=function(){_14.stopEditing();_14.endEdit();if(_13.saving){_17.acceptUpdates();}else{if(_10){_17.objectUpdate();}}_10=false;};var _20=function(_21){var _22=_21.getGuid();var _23=function(){if(_1d[_22]){window.mx.data.unsubscribe(_1d[_22].sub);window.mx.data.unsubscribe(_1d[_22].val);delete _1d[_22];}};var _24=_1d[_22];if(_24){clearTimeout(_24.timer);}else{_24=_1d[_22]=new function(){this.objectUpdate=function(_25){if(typeof _25=="object"){return;}var _26=_21&&_21.getGuid();if(_25!=_26){clearTimeout(this.timer);_23();window.mx.data.get({xpath:"//"+_21.getEntity()+"[id="+_25+"]",filter:{id:_17.getSchemaId()},noCache:true,callback:function(_27){_17.updateMxObject(_27[0]);},error:function(e){window.mx.onError(e);}});}};this.validationUpdate=function(_28){_13.invalidmsg=_28[0].getErrorReason(_13.key);};};}_24.timer=setTimeout(_23,5000);_24.sub=window.mx.data.subscribe({guid:_22,callback:_a.hitch(_24,"objectUpdate")});_24.val=window.mx.data.subscribe({guid:_22,val:true,callback:_a.hitch(_24,"validationUpdate")});};var _29={onLoad:"plugineventOnLoad",preRefresh:"plugineventPreRefresh",onRefresh:"plugineventOnRefresh",onSync:"plugineventOnSync",onCellClicked:"plugineventCellClicked",onSelectRow:"plugineventSelectRow"};var _2a=function(_2b){var _2c=null;if(_13.mxobject){_2c=_13.mxobject.getGuid();_13.mxobject=null;}if(_2b){_13.mxobject=_2b;var _2d=_13.mxobject.getGuid();if(_2c!=_2d){_13.valid=true;_13.invalidmsg="";}}};var _16=function(){return _13.mxobject;};var _2e=function(_2f){_13.node=_2f;_13.row=_17.domData(_2f,"row");_13.key=_17.domData(_2f,"key");_13.col=_17.domData(_2f,"column");_13.datakey=_13.key;_13.gridsize=_17.getCurrentGridSize();var _30=_13.key;if(_30.match("/")!=null){_30=_30.split("/")[0];}_13.attrclass=_e.getAttributeType(_30);_13.attr=_30;_13.row=parseInt(_13.row,10);if(_13.key.match(/\//)){_13.key=_13.key.replace(/^.*\//,"");}_2a(_17.getMxObjectAtRow(_13.row));};var _31=function(_32){var _33=_32.mxObject;var _34=_32.attribute;var _35=_32.value;if(typeof (_35)!="string"){_35=_35.toString();}if(_35==""){return true;}switch(_33.getAttributeType(_34)){case "Enum":var map=_33.getEnumMap(_34);for(var i=0;i<map.length;i++){if(map[i].key==_35){return true;}}return false;break;case "Integer":case "Long":case "Float":case "Currency":var _36=_35.replace(/^-/,"").replace(/(\,|\.)/g,"").replace(/\d/g,"");return (_36=="");break;case "Date":case "DateTime":if(_35.match(/^\d+[\/-]\d+[\/-]\d+$/)!=null){var _37=window.mx.parser.parseDate(_35);return isNaN(_37)?false:true;}else{return false;}break;default:return true;break;}};_f=function(){var obj=_16();if(!obj){return true;}if(_14.getEditorStatus()!="active"){return true;}if(_14.hasChanges()){var _38=_14.getValue();var _39=_38;var ref=_13.attr;if(_e.isReference(ref)){return true;}else{if(_31({mxObject:obj,attribute:ref,value:_39})){return true;}else{return false;}}}return true;};_11=function(){var _3a=_16();if(!_3a){return false;}if(_14.hasChanges()){var _3b=_14.getValue();var _3c=_3b;var ref=_13.attr;if(_e.isReference(ref)){_3a.set(ref,_3c);}else{if(_31({mxObject:_3a,attribute:ref,value:_3c})){_13.valid=true;_13.invalidmsg="";switch(_13.attrclass){case "Date":case "DateTime":_3c=(_3b=="")?"":window.mx.parser.parseDate(_3b);break;case "Enum":_3c=_3b;break;case "Long":case "Integer":_3c=window.mx.parser.parseValue2(_3b,"integer");_3c=_3c===null?"":_3c;break;case "Currency":case "Decimal":case "Float":_3c=window.mx.parser.parseValue2(_3b,"float",{places:_18[_13.col].display.precision});_3c=_3c===null?"":_3c;break;case "String":case "Text":_3c=_3.unescapeString(_3b);break;case "Boolean":_3c=(_3b==="true");break;default:break;}_3a.set(ref,_3c);}else{_13.valid=false;_14.undoChanges();var msg=_13.invalidmsg=window.mx.ui.translate("mendix.lib.Validations","invalid_attribute",[_3b,_3a.getEntity()+"/"+_13.key]);window.mx.ui.error(msg);}}}return _3a.hasChanges();};var _3d=function(){if(!_1c){_17.addToSyncDeferQueue();_1c=true;}else{}};var _3e=function(){if(_1c){_17.removeFromSyncDeferQueue();_1c=false;}else{}};var _3f=function(e){if(_13._def){_13._def.reject(new Error(""));_13._def=null;}_1e=[];_13.valid=false;_13.saving=false;_17.acceptUpdates();_3e();};_12=function(_40){if(_40){_1e.push(_40);}if(!_13.saving){var _41=_16();if(_41&&_41.hasChanges()){_17.preventUpdates();_13.saving=true;_10=true;_20(_41);window.mx.data.save({mxobj:_41,callback:function(){_41.commit({callback:function(){_13.valid=true;_13.invalidmsg="";_13.saving=false;if(_13._def){_13._def.resolve();_13._def=null;}_17.acceptUpdates();_3e();mendix.lang.collect(_1e);},error:_3f});},error:_3f});}else{mendix.lang.collect(_1e);}}else{}};var _42=false;var _43=[];var _44=function(_45,_46){var div,td=_3.getAncestorNode(_45,"TD");if(_45.nodeName.toLowerCase()==="div"){div=_45;}else{div=_45.querySelector("div:first-child");}if(_14.getEditorStatus()=="active"){if(_11()){_12();}}if(div&&td){_2e(td);if(_13.row>=_13.gridsize){return;}var _47=_13.datakey,_48=_47.split("/"),ref;if(_48.length>1){_47=_48[0];ref=_48[2];}var _49=_16();if(!_18[_13.col].editable){_1f();_2a(null);}else{if(_e.isReference(_47)){var _4a=function(_4b){var _4c={selected:_49.getReference(_47),items:{}};_19[_13.datakey].source.each(function(o){var _4d;switch(o.getAttributeType(ref)){case "Boolean":_4c.items[o.getGuid()]=window.mx.ui.translate("mxui.widget.DataGrid",o.get2(ref)+"");break;case "DateTime":_4c.items[o.getGuid()]=window.mx.parser.formatDate(o.get2(ref));break;case "Enum":_4c.items[o.getGuid()]=o.getEnumCaption(ref);break;default:_4c.items[o.getGuid()]=o.get2(ref);}});_14.editNode(div,"reference",_4c);_46&&_14.startEditing();_4b&&_4b();};if(!_42){_43.push(_4a);}else{_4a();}}else{switch(_e.getAttributeType(_47)){case "Boolean":_14.editNode(div,"boolean",{selected:_49.get2(_47)+"",items:{"false":window.mx.ui.translate("mxui.widget.DataGrid","false"),"true":window.mx.ui.translate("mxui.widget.DataGrid","true")}});_46&&_14.startEditing();break;case "Date":case "DateTime":_14.editNode(div,"date");break;case "Enum":_14.editNode(div,"enum",{selected:_49.get2(_47),items:_e.getEnumKVPairs(_47)});_46&&_14.startEditing();break;case "Currency":case "Decimal":case "Float":_14.editNode(div,"text",{hasDecimalPoint:true});break;default:_14.editNode(div,"text");break;}}}}else{}};var _4e=function(){var _4f=false;for(var i=0,_50;_50=_18[i];i++){if(_4f){if(_50.editable){return _50.tag;}}if(i==_13.col){_4f=true;}}};var _51=function(){var key="";for(var i=0,_52;_52=_18[i];i++){if(i==_13.col){return key;}if(_52.editable){key=_52.tag;}}};var _53=function(){if(_17.getCurrentGridSize()==0){return;}var row=0;var _54=_16();if(_54!=null){var row=_17.getRowForMxObject(_54);if(row==null){row=0;}}var _55=_17.getCellNode(row,_13.datakey||_1a);if(_55){_44(_55);}};var _56=function(){if(_17.getCurrentGridSize()==0){return;}var _57=_17.getCellNode(0,_13.datakey||_1a);if(_57){_44(_57);}};var _58=function(){_11()&&_12();if(_13.row!=0){var _59=_17.getCellNode((_13.row-1),_13.datakey);_44(_59);}};var _5a=function(){_11()&&_12();if(_13.row!=(_13.gridsize-1)){var _5b=_17.getCellNode((_13.row+1),_13.datakey);if(_5b&&(_5b!=_13.node)){_44(_5b);}}};var _5c=function(){if((_13.datakey==_1a)&&(_13.row!=0)){_13.datakey=_1b;_58();}else{if(_13.datakey!=_1a){_11();var _5d=_17.getCellNode(_13.row,_51());if(_5d){_44(_5d);}}}};var _5e=function(){if(_13.datakey==_1b){if(_13.row!=(_13.gridsize-1)){_13.datakey=_1a;_5a();}else{_11()&&_12();_2.next();_1f();_2a(null);}}else{if(_13.datakey!=_1b){_11();var _5f=_17.getCellNode(_13.row,_4e());if(_5f){_44(_5f);}}}};var _60=function(){_17.domNode.className+=" inlineGrid";};this.plugineventOnLoad=function(e){_60();};this.plugineventOnSync=function(e){if(_14.hasChanges()){_3d();_14.stopEditing();if(_11()){_12();}else{_3e();}}};this.plugineventOnDestroy=function(e){_1f();if(_14.hasChanges()){_11();}var _61=_16();if(_61&&_61.hasChanges()){_12();}};this.plugineventSelectRow=function(e){var row=e.row;var _62=_17.getCellNode(row,_13.datakey||_1a);if(_62){_44(_62);}};this.plugineventOnRefresh=function(e){if(_17.getCurrentGridSize()==0){return;}switch(_14.getEditorStatus()){case "inactive":break;case "active":case "ready":_53();break;}};this.plugineventPreRefresh=function(e){if(_14.hasChanges()){_11();}var _63=_16();if(_63&&_63.hasChanges()){_12();}_1f();};this.plugineventCellClicked=function(e){if(_14.hasChanges()){_11();}_44(e.target,true);if(e.target.nodeName.toLowerCase()=="select"){_9.stop(e);}else{this._editorClicked=true;}};this.editorClickHandler=function(e){if(!this._editorClicked){try{if(_13.valid&&_11()){_12();}}catch(e){_4.error(_d+".editorClickHandler:"+e.message);}_1f();_2a(null);}this._editorClicked=false;};this.editorKeyHandler=function(_64){var _65=_64.keyCode;switch(_14.getEditorStatus()){case "inactive":break;case "ready":switch(_65){case 37:_5c();break;case 38:_58();break;case 9:_64.stopPropagation();_64.preventDefault();if(_64.shiftKey===true){_5c();break;}case 39:_5e();break;case 40:_5a();break;case 13:case 18:case 32:case 27:case 113:_14.startEditing();break;case _6.BACKSPACE:_14.startEditing("");break;default:if((_65>=48)&&(_65<=110)){_14.startEditing();}break;}break;case "active":switch(_65){case 9:_64.stopPropagation();_64.preventDefault();case 13:_14.stopEditing();_5e();break;case 27:_14.undoChanges();_5e();break;default:break;}break;}return false;};var _66=null;this.destroy=function(){try{while(this._connects.length!=0){this._connects.pop().remove();}this.plugineventOnDestroy();_14.destroy();for(var i in _19){_19[i].source.destroy();}_19=null;while(_66.length){window.mx.screen.unsubscribe(_66.pop());}_66=null;}catch(e){}_17=null;};try{_14=new _1();}catch(e){}_14.eventKeyHandler=this.editorKeyHandler;_e=window.mx.meta.getEntity(_17.entity);_18=_17.getEntityProperties();var _67=[];for(var i=0,_68;_68=_18[i];i++){var tag=_68.tag;_67=tag.split(/\//);if(_68.editable){if(_1a==""){_1a=tag;}_1b=tag;}if(_68.editable){try{if(_e.isReference(_67[0])){_19[tag]={key:_67[_67.length],source:new webcore.datasource.XPathSource({entity:_67[_67.length-2],page:100})};var ds=_19[tag].source;ds.reload(function(){_42=true;mendix.lang.sequence(_43);});}}catch(e){}}}for(var i in _29){_17.registerToPluginEvent(i,_a.hitch(this,_29[i]));}this._connects.push(_8(document.body,"click",_a.hitch(this,"editorClickHandler")));_66=[window.mx.screen.subscribe(_17.getContent(),"saveObject",_a.hitch(_13,"objectSave")),window.mx.screen.subscribe(_17.getContent(),"rollbackObject",_a.hitch(_13,"objectRollback"))];_17.registerToPluginEvent("invokeAction",function(_69,_6a){_12(_6a);},true);};return _b;});