/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/plugins/DataGrid/GridEditor",["mxui/widget/MxInlineEditor","mxui/wm/focus","mxui/dom","mendix/logger","dojo/Deferred","dojo/keys","dojo/number","dojo/on","dojo/_base/event","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){function _b(_c){var _d="plugins.GridEditor";this._connects=[];var _e=null;var _f=null;var _10=false;var _11,_12=null;var _13={mxobject:null,node:null,row:-1,key:"",attr:"",attrclass:"",valid:true,invalidmsg:"",saving:false};var _14=_c.parent;var _15=null;_d=_14.id+"."+_d;var _16=null;var _17={};var _18="";var _19="";var _1a=false;if(_14&&(_14.declaredClass!="mxui.widget.DataGrid")){_4.error(_d+".initialize : can only register to DataGrid!");}else{}var _1b={},_1c=[];var _1d=function(){_15.stopEditing();_15.endEdit();if(_13.saving){_14.acceptUpdates();}else{if(_10){_14.objectUpdate();}}_10=false;};var _1e=function(_1f){var _20=_1f.getGuid();var _21=function(){if(_1b[_20]){window.mx.data.unsubscribe(_1b[_20].sub);window.mx.data.unsubscribe(_1b[_20].val);delete _1b[_20];}};var _22=_1b[_20];if(_22){clearTimeout(_22.timer);}else{_22=_1b[_20]=new function(){this.objectUpdate=function(_23){if(typeof _23=="object"){return;}var _24=_1f&&_1f.getGuid();if(_23!=_24){clearTimeout(this.timer);_21();window.mx.data.get({xpath:"//"+_1f.getEntity()+"[id="+_23+"]",filter:{id:_14.getSchemaId()},noCache:true,callback:function(_25){_14.updateMxObject(_25[0]);},error:function(e){window.mx.onError(e);}});}};this.validationUpdate=function(_26){_13.invalidmsg=_26[0].getErrorReason(_13.key);};};}_22.timer=setTimeout(_21,5000);_22.sub=window.mx.data.subscribe({guid:_20,callback:_a.hitch(_22,"objectUpdate")});_22.val=window.mx.data.subscribe({guid:_20,val:true,callback:_a.hitch(_22,"validationUpdate")});};var _27={onLoad:"plugineventOnLoad",preRefresh:"plugineventPreRefresh",onRefresh:"plugineventOnRefresh",onSync:"plugineventOnSync",onCellClicked:"plugineventCellClicked",onSelectRow:"plugineventSelectRow"};var _28=function(_29){var _2a=null;if(_13.mxobject){_2a=_13.mxobject.getGuid();_13.mxobject=null;}if(_29){_13.mxobject=_29;var _2b=_13.mxobject.getGuid();if(_2a!=_2b){_13.valid=true;_13.invalidmsg="";}}};var _2c=function(){return _13.mxobject;};var _2d=function(_2e){_13.node=_2e;_13.row=_14.domData(_2e,"row");_13.key=_14.domData(_2e,"key");_13.col=_14.domData(_2e,"column");_13.datakey=_13.key;_13.gridsize=_14.getCurrentGridSize();var _2f=_13.key;if(_2f.match("/")!=null){_2f=_2f.split("/")[0];}_13.attrclass=_e.getAttributeType(_2f);_13.attr=_2f;_13.row=parseInt(_13.row,10);if(_13.key.match(/\//)){_13.key=_13.key.replace(/^.*\//,"");}_28(_14.getMxObjectAtRow(_13.row));};var _30=function(_31){var _32=_31.mxObject;var _33=_31.attribute;var _34=_31.value;if(typeof (_34)!="string"){_34=_34.toString();}if(_34==""){return true;}switch(_32.getAttributeType(_33)){case "Enum":var map=_32.getEnumMap(_33);for(var i=0;i<map.length;i++){if(map[i].key==_34){return true;}}return false;break;case "Integer":case "Long":case "Float":case "Currency":var _35=_34.replace(/^-/,"").replace(/(\,|\.)/g,"").replace(/\d/g,"");return (_35=="");break;case "Date":case "DateTime":if(_34.match(/^\d+[\/-]\d+[\/-]\d+$/)!=null){var _36=window.mx.parser.parseDate(_34);return isNaN(_36)?false:true;}else{return false;}break;default:return true;break;}};_f=function(){var obj=_2c();if(!obj){return true;}if(_15.getEditorStatus()!="active"){return true;}if(_15.hasChanges()){var _37=_15.getValue();var _38=_37;var ref=_13.attr;if(_e.isReference(ref)){return true;}else{if(_30({mxObject:obj,attribute:ref,value:_38})){return true;}else{return false;}}}return true;};_11=function(){var _39=_2c();if(!_39){return false;}if(_15.hasChanges()){var _3a=_15.getValue();var _3b=_3a;var ref=_13.attr;if(_e.isReference(ref)){_39.set(ref,_3b);}else{if(_30({mxObject:_39,attribute:ref,value:_3b})){_13.valid=true;_13.invalidmsg="";switch(_13.attrclass){case "Date":case "DateTime":_3b=(_3a=="")?"":window.mx.parser.parseDate(_3a);break;case "Enum":_3b=_3a;break;case "Long":case "Integer":_3b=window.mx.parser.parseValue2(_3a,"integer");_3b=_3b===null?"":_3b;break;case "Currency":case "Decimal":case "Float":_3b=window.mx.parser.parseValue2(_3a,"float",{places:_16[_13.col].display.precision});_3b=_3b===null?"":_3b;break;case "String":case "Text":_3b=_3.unescapeString(_3a);break;case "Boolean":_3b=(_3a==="true");break;default:break;}_39.set(ref,_3b);}else{_13.valid=false;_15.undoChanges();var msg=_13.invalidmsg=window.mx.ui.translate("mendix.lib.Validations","invalid_attribute",[_3a,_39.getEntity()+"/"+_13.key]);window.mx.ui.error(msg);}}}return _39.hasChanges();};var _3c=function(){if(!_1a){_14.addToSyncDeferQueue();_1a=true;}else{}};var _3d=function(){if(_1a){_14.removeFromSyncDeferQueue();_1a=false;}else{}};var _3e=function(e){if(_13._def){_13._def.reject(new Error(""));_13._def=null;}_1c=[];_13.valid=false;_13.saving=false;_14.acceptUpdates();_3d();};_12=function(_3f){if(_3f){_1c.push(_3f);}if(!_13.saving){var _40=_2c();if(_40&&_40.hasChanges()){_14.preventUpdates();_13.saving=true;_10=true;_1e(_40);window.mx.data.save({mxobj:_40,callback:function(){window.mx.data.commit({mxobj:_40,callback:function(){_13.valid=true;_13.invalidmsg="";_13.saving=false;if(_13._def){_13._def.resolve();_13._def=null;}_14.acceptUpdates();_3d();mendix.lang.collect(_1c);},error:_3e});},error:_3e});}else{mendix.lang.collect(_1c);}}else{}};var _41=false;var _42=[];var _43=function(_44,_45){var div,td=_3.getAncestorNode(_44,"TD");if(_44.nodeName.toLowerCase()==="div"){div=_44;}else{div=_44.querySelector("div:first-child");}if(_15.getEditorStatus()=="active"){if(_11()){_12();}}if(div&&td){_2d(td);if(_13.row>=_13.gridsize){return;}var _46=_13.datakey,_47=_46.split("/"),ref;if(_47.length>1){_46=_47[0];ref=_47[2];}var _48=_2c();if(!_16[_13.col].editable){_1d();_28(null);}else{if(_e.isReference(_46)){var _49=function(_4a){var _4b={selected:_48.getReference(_46),items:{}};_17[_13.datakey].source.each(function(o){var _4c;switch(o.getAttributeType(ref)){case "Boolean":_4b.items[o.getGuid()]=window.mx.ui.translate("mxui.widget.DataGrid",o.get2(ref)+"");break;case "DateTime":_4b.items[o.getGuid()]=window.mx.parser.formatDate(o.get2(ref));break;case "Enum":_4b.items[o.getGuid()]=o.getEnumCaption(ref);break;default:_4b.items[o.getGuid()]=o.get2(ref);}});_15.editNode(div,"reference",_4b);_45&&_15.startEditing();_4a&&_4a();};if(!_41){_42.push(_49);}else{_49();}}else{switch(_e.getAttributeType(_46)){case "Boolean":_15.editNode(div,"boolean",{selected:_48.get2(_46)+"",items:{"false":window.mx.ui.translate("mxui.widget.DataGrid","false"),"true":window.mx.ui.translate("mxui.widget.DataGrid","true")}});_45&&_15.startEditing();break;case "Date":case "DateTime":_15.editNode(div,"date");break;case "Enum":_15.editNode(div,"enum",{selected:_48.get2(_46),items:_e.getEnumKVPairs(_46)});_45&&_15.startEditing();break;case "Currency":case "Decimal":case "Float":_15.editNode(div,"text",{hasDecimalPoint:true});break;default:_15.editNode(div,"text");break;}}}}else{}};var _4d=function(){var _4e=false;for(var i=0,_4f;_4f=_16[i];i++){if(_4e){if(_4f.editable){return _4f.tag;}}if(i==_13.col){_4e=true;}}};var _50=function(){var key="";for(var i=0,_51;_51=_16[i];i++){if(i==_13.col){return key;}if(_51.editable){key=_51.tag;}}};var _52=function(){if(_14.getCurrentGridSize()==0){return;}var row=0;var _53=_2c();if(_53!=null){var row=_14.getRowForMxObject(_53);if(row==null){row=0;}}var _54=_14.getCellNode(row,_13.datakey||_18);if(_54){_43(_54);}};var _55=function(){if(_14.getCurrentGridSize()==0){return;}var _56=_14.getCellNode(0,_13.datakey||_18);if(_56){_43(_56);}};var _57=function(){_11()&&_12();if(_13.row!=0){var _58=_14.getCellNode((_13.row-1),_13.datakey);_43(_58);}};var _59=function(){_11()&&_12();if(_13.row!=(_13.gridsize-1)){var _5a=_14.getCellNode((_13.row+1),_13.datakey);if(_5a&&(_5a!=_13.node)){_43(_5a);}}};var _5b=function(){if((_13.datakey==_18)&&(_13.row!=0)){_13.datakey=_19;_57();}else{if(_13.datakey!=_18){_11();var _5c=_14.getCellNode(_13.row,_50());if(_5c){_43(_5c);}}}};var _5d=function(){if(_13.datakey==_19){if(_13.row!=(_13.gridsize-1)){_13.datakey=_18;_59();}else{_11()&&_12();_2.next();_1d();_28(null);}}else{if(_13.datakey!=_19){_11();var _5e=_14.getCellNode(_13.row,_4d());if(_5e){_43(_5e);}}}};var _5f=function(){_14.domNode.className+=" inlineGrid";};this.plugineventOnLoad=function(e){_5f();};this.plugineventOnSync=function(e){if(_15.hasChanges()){_3c();_15.stopEditing();if(_11()){_12();}else{_3d();}}};this.plugineventOnDestroy=function(e){_1d();if(_15.hasChanges()){_11();}var _60=_2c();if(_60&&_60.hasChanges()){_12();}};this.plugineventSelectRow=function(e){var row=e.row;var _61=_14.getCellNode(row,_13.datakey||_18);if(_61){_43(_61);}};this.plugineventOnRefresh=function(e){if(_14.getCurrentGridSize()==0){return;}switch(_15.getEditorStatus()){case "inactive":break;case "active":case "ready":_52();break;}};this.plugineventPreRefresh=function(e){if(_15.hasChanges()){_11();}var _62=_2c();if(_62&&_62.hasChanges()){_12();}_1d();};this.plugineventCellClicked=function(e){if(_15.hasChanges()){_11();}_43(e.target,true);if(e.target.nodeName.toLowerCase()=="select"){_9.stop(e);}else{this._editorClicked=true;}};this.editorClickHandler=function(e){if(!this._editorClicked){try{if(_13.valid&&_11()){_12();}}catch(e){_4.error(_d+".editorClickHandler:"+e.message);}_1d();_28(null);}this._editorClicked=false;};this.editorKeyHandler=function(_63){var _64=_63.keyCode;switch(_15.getEditorStatus()){case "inactive":break;case "ready":switch(_64){case 37:_5b();break;case 38:_57();break;case 9:_63.stopPropagation();_63.preventDefault();if(_63.shiftKey===true){_5b();break;}case 39:_5d();break;case 40:_59();break;case 13:case 18:case 32:case 27:case 113:_15.startEditing();break;case _6.BACKSPACE:_15.startEditing("");break;default:if((_64>=48)&&(_64<=110)){_15.startEditing();}break;}break;case "active":switch(_64){case 9:_63.stopPropagation();_63.preventDefault();case 13:_15.stopEditing();_5d();break;case 27:_15.undoChanges();_5d();break;default:break;}break;}return false;};this.destroy=function(){try{while(this._connects.length!=0){this._connects.pop().remove();}this.plugineventOnDestroy();_15.destroy();for(var i in _17){_17[i].source.destroy();}_17=null;}catch(e){}_14=null;};try{_15=new _1();}catch(e){}_15.eventKeyHandler=this.editorKeyHandler;_e=window.mx.meta.getEntity(_14.entity);_16=_14.getEntityProperties();var _65=[];for(var i=0,_66;_66=_16[i];i++){var tag=_66.tag;_65=tag.split(/\//);if(_66.editable){if(_18==""){_18=tag;}_19=tag;}if(_66.editable){try{if(_e.isReference(_65[0])){_17[tag]={key:_65[_65.length],source:new webcore.datasource.XPathSource({entity:_65[_65.length-2],page:100})};var ds=_17[tag].source;ds.reload(function(){_41=true;mendix.lang.sequence(_42);});}}catch(e){}}}for(var i in _27){_14.registerToPluginEvent(i,_a.hitch(this,_27[i]));}this._connects.push(_8(document.body,"click",_a.hitch(this,"editorClickHandler")));_14.registerToPluginEvent("invokeAction",function(_67,_68){_12(_68);},true);};return _b;});