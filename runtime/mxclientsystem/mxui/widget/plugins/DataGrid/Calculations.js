/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/plugins/DataGrid/Calculations",["mxui/dom","mendix/logger","dojo/_base/lang","dojo/_base/array","big/big"],function(_1,_2,_3,_4,_5){var $=_1.create;function _6(_7){var _8="mxui.widget.plugins.DataGrid.Calculations";var _9=[];var _a=_7.parent;var _b=_7.config;if(!_a&&(_a.widgetType!="DataGrid")){throw new Error(_8+".initialize : can only register to DataGrid!");}var _c={onDestroy:"plugineventOnDestroy",onRefresh:"plugineventOnRefresh"};var _d={};var _e=_a.getEntityProperties();var _f=function(){_a.showFootNode();var tr1=$("tr");var tr2=$("tr");_a.gridFootNode.appendChild(tr1);_a.gridFootNode.appendChild(tr2);var th,td=null;for(var i=0,_10;_10=_e[i];i++){var tag=_10.tag;th=$("th");td=$("td");_a.setColumnStyle(th,_10);_a.setColumnStyle(td,_10);if(_b[tag]){th.innerHTML=_b[tag].title||"";var _11=_10.render.toLowerCase();_b[tag].usesPrecision=(_11!=="integer"&&_11!=="long");}td.innerHTML="&nbsp;";_d[i]=td;tr1.appendChild(th);tr2.appendChild(td);}};var _12=function(){for(var i=0,_13;_13=_e[i];i++){_d[i].innerHTML="&nbsp;";}};var _14=function(){if(!_a.constraintsFilled()){_12();return;}window.mx.server.request({request:{action:"retrieve_aggregates",params:{id:_a.schema,xpath:_a.getCurrentXPath()}},options:{callback:function(_15,_16){_17(_4.map(_16.aggregates,function(agg){return agg===""?agg:new _5(agg);}));},useCache:false,preventCache:true}});};var _17=function(_18){if(!_18){return;}var _19=0,_1a=_a.getHiddenAggregates().reverse();for(var h=0;h<_1a.length;h++){_18.splice(_1a[h],1);}for(var i=0,_1b;_1b=_e[i];i++){var tag=_1b.tag;if(_b[tag]){var _1c=_18[_19++],_1d=_e[i].display,_1e=_1d.precision;if(_1c==null){continue;}if(_1c==""){_1c=0;}if(!_b[tag].usesPrecision){_1e=0;}_d[i].innerHTML=window.mx.parser.formatValue(_1c,"decimal",{groups:_1d.formatted,places:_1e});}}};this.plugineventOnDestroy=function(){this.destroy();};this.plugineventOnRefresh=function(){if(_a.constraintsFilled()){_17(_a.getAggregates());}else{_12();}};this.destroy=function(){while(_9.length!=0){window.mx.data.unsubscribe(_9.shift());}_a=null;};this.objectUpdate=function(){if(!_a.acceptingUpdates()){_14();}};_f();for(var i in _c){_a.registerToPluginEvent(i,_3.hitch(this,_c[i]));}var _1f={};_1f[_a.entity]=true;metaEntity=window.mx.meta.getEntity(_a.entity);if(metaEntity.hasSuperEntities()){var _20=metaEntity.getSuperEntities();for(var i=0;i<_20.length;i++){_1f[_20[i]]=true;}}if(metaEntity.hasSubEntities()){var _21=metaEntity.getSubEntities();for(var i=0;i<_21.length;i++){_1f[_21[i]]=true;}}for(var i in _1f){_9.push(window.mx.data.subscribe({entity:i,callback:_3.hitch(this,"objectUpdate")}));}};return _6;});