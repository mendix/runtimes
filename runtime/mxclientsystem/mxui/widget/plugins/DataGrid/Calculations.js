
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/plugins/DataGrid/Calculations",["dojo","dijit","dojox","dojo/require!mxui/widget/DataGrid"],function(_1,_2,_3){_1.provide("mxui.widget.plugins.DataGrid.Calculations");_1.require("mxui.widget.DataGrid");if(!mxui.widget.plugins){mxui.widget.plugins={};}if(!mxui.widget.plugins.DataGrid){mxui.widget.plugins.DataGrid={};}mxui.widget.plugins.DataGrid.Calculations=function(_4){var _5="mxui.widget.plugins.DataGrid.Calculations";var _6=null;var _7=[];var _8=_4.parent;var _9=_4.config;if(!_8&&(_8.widgetType!="DataGrid")){throw new Error(_5+".initialize : can only register to DataGrid!");}var _a={onDestroy:"plugineventOnDestroy",onRefresh:"plugineventOnRefresh"};var _b={};var _c=_8.getEntityProperties();var _d=function(){_8.showFootNode();var _e=mxui.dom.tr();var _f=mxui.dom.tr();_8.gridFootNode.appendChild(_e);_8.gridFootNode.appendChild(_f);var th,td=null;for(var i=0,_10;_10=_c[i];i++){var tag=_10.tag;th=mxui.dom.th();td=mxui.dom.td();_8.setColumnStyle(th,_10);_8.setColumnStyle(td,_10);if(_9[tag]){th.innerHTML=_9[tag].title||"";switch(_10.render.toLowerCase()){case "float":case "currency":_9[tag].resulttype="float";break;default:_9[tag].resulttype="integer";break;}}td.innerHTML="&nbsp;";_b[i]=td;_e.appendChild(th);_f.appendChild(td);}};var _11=function(){for(var i=0,_12;_12=_c[i];i++){_b[i].innerHTML="&nbsp;";}};var _13=function(_14){if(!_8.constraintsFilled()){_11();return;}mx.server.request({request:{action:"retrieve_aggregates",params:{id:_8.schema,xpath:_8.getCurrentXPath()}},options:{callback:function(_15,_16,evt){_17(_16.aggregates);},useCache:false,preventCache:true}});};var _17=function(_18){if(!_18){return;}var _19=0,_1a=_8.getHiddenAggregates().reverse();for(var h=0;h<_1a.length;h++){_18.splice(_1a[h],1);}for(var i=0,_1b;_1b=_c[i];i++){var tag=_1b.tag;if(_9[tag]){var _1c=_9[tag].resulttype,_1d=_18[_19++];if(_1d==null){continue;}if(_1d==""){_1d=0;}var _1e=_c[i].display;switch(_1c.toLowerCase()){case "currency":case "float":var val=parseFloat(_1d).toFixed(parseInt(_1e.precision));_b[i].innerHTML=mx.parser.formatNumber(val,_1e.formatted,_1e.precision);break;default:_b[i].innerHTML=mx.parser.formatNumber(_1d,_1e.formatted,0);break;}}}};this.plugineventOnDestroy=function(e){this.destroy();};this.plugineventOnRefresh=function(e){if(_8.constraintsFilled()){_17(_8.getAggregates());}else{_11();}};this.destroy=function(){while(_7.length!=0){mx.data.unsubscribe(_7.shift());}_8=null;};this.objectUpdate=function(){if(!_8.acceptingUpdates()&&!_8.isSuspended()){_13();}};_d();for(var i in _a){_8.registerToPluginEvent(i,_1.hitch(this,_a[i]));}var _1f={};_1f[_8.entity]=true;_6=mx.meta.getEntity(_8.entity);if(_6.hasSuperEntities()){var _20=_6.getSuperEntities();for(var i=0;i<_20.length;i++){_1f[_20[i]]=true;}}if(_6.hasSubEntities()){var _21=_6.getSubEntities();for(var i=0;i<_21.length;i++){_1f[_21[i]]=true;}}for(var i in _1f){_7.push(mx.data.subscribe({entity:i,callback:_1.hitch(this,"objectUpdate")}));}};});