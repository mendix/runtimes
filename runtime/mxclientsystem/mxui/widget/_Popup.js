
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/_Popup",["mxui/lib/Moveable","mxui/lib/Resizable","mxui/mixin/_Floatable","mxui/widget/Underlay","mxui/widget/_WidgetBase","mxui/dom","mendix/logger","dojo/window","dojo/dom-style","dojo/dom-geometry","dojo/_base/array","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var _e=_d([_5,_3],{modal:false,delay:100,_layers:[{index:100,stack:[]},{index:1000,stack:[]}],_mover:null,_resizer:null,_prevBox:null,_maximized:false,_visible:false,_minWidth:300,_minHeight:200,_margin:10,_underlay:new _4(),postCreate:function(){this.createBackgroundIframe();this._mover=new _1(this.domNode,{handle:this._headerNode,margin:this._margin,delay:5});this.connect(this._mover,"onMoveStart",function(e){if(this._maximized){var _f=this._prevBox;this.resize({l:e.pageX-_f.w/2,w:_f.w,h:_f.h});}});var _10=_6.getNodeExtents(this.domNode);this._minWidth+=_10.w;this._minHeight+=_10.h;if(this.resizable){this._resizer=new _2(this.domNode,{margin:this._margin,resizer:_c.hitch(this,"resize"),minWidth:this._minWidth,minHeight:this._minHeight});this.connect(this._headerNode,"dblclick",function(){this.maximize();});}var _11=function(){this.resize(null,true);};this.connect(this.mxform,"resize",_11);this.connect(window.mx.ui,"resize",_11);this._layers[this._layerId].stack.push(this);},center:function(){var _12=this.domNode,box=_a.getMarginBox(_12),_13=_8.getBox();_9.set(_12,{top:Math.max(0,0.7*(_13.h/2-box.h/2))+"px",left:Math.max(0,_13.w/2-box.w/2)+"px"});},maximize:function(_14){if(this._maximized&&!_14){this._maximized=false;this.resize(this._prevBox);}else{var _15=_8.getBox(),box=_14?this._prevBox:_a.getMarginBox(this.domNode);this.resize({t:0,l:0,w:_15.w,h:_15.h});this._prevBox=box;this._maximized=true;}},resize:function(box,_16){if(!this._visible){return;}if(this._maximized){if(_16){this.maximize(true);return;}else{this._maximized=false;}}box=box||{};var _17=this._margin,_18=_8.getBox(),_19=_18.w-_17*2,_1a=_18.h-_17*2,_1b=_c.delegate(_a.getMarginBox(this.domNode),box);if(_1b.w>_19){box.w=_1b.w=_19;}if(_1b.w<this._minWidth){box.w=this._minWidth;}if(_1b.h>_1a){box.h=_1b.h=_1a;}if(_1b.h<this._minHeight){box.h=this._minHeight;}var _1c=this.domNode.style;if(box.l){_1c.left=box.l+"px";}if(box.t){_1c.top=box.t+"px";}if(box.w){_1c.width=box.w+"px";}if(box.h){_1c.height=box.h+"px";this.layout();}_6.moveIntoView(this.domNode,_17);},onShow:function(){this._visible=true;if(this.modal){this._underlay.show();}},onHide:function(){this._visible=false;if(this.modal){this._underlay.hide();}var _1d=this._layers[this._layerId].stack;_1d.splice(_b.indexOf(_1d,this),1);this.focusPrevious();},stack:function(){var _1e=this._layers[this._layerId].stack,_1f=_8.getBox().w*0.2,_20=50,_21=[],_22=0,gap=20;_b.some(_1e,function(_23){var _24=_1f+(_22*gap)-(0.5*gap),_25=_24+gap,_26=true;_22++;_b.some(_1e,function(_27){var box=_a.getMarginBox(_27.domNode);if(_24<box.l&&box.l<_25){_21.push(box);_26=false;return true;}});return _26;});var _28=gap*_21.length;_9.set(this.domNode,{left:_1f+_28+"px",top:_20+_28+"px"});},focus:function(){var _29=this._layers[this._layerId],_2a=_29.stack,_2b=_29.stack=[],_2c=_29.index;_b.forEach(_2a,function(_2d){if(_2d.id!=this.id){_2b.push(_2d);_2d.deactivate&&_2d.deactivate();}else{_2d.activate&&_2d.activate();}},this);_2b.sort(function(a,b){return a.domNode.style.zIndex-b.domNode.style.zIndex;});_2b.push(this);for(var x=0,_2e;_2e=_2b[x];x++){_2c=_2c+2;_2e.domNode.style.zIndex=_2c;}if(this.modal&&!this._hasHigherModalPopups()){this._underlay.domNode.style.zIndex=_2c-1;}},_hasHigherModalPopups:function(){return _b.some(this._layers.slice(this._layerId+1),function(_2f){return _b.some(_2f.stack,function(_30){return _30.modal;});});},focusPrevious:function(){var id=this._layerId;do{var _31=this._layers[id].stack;for(var i=_31.length-1;i>=0;i--){if(_31[i]._visible){_31[i].focus();return;}}}while(id-->0);},uninitialize:function(){this._mover.destroy();if(this._resizer){this._resizer.destroy();}}});return _e;});