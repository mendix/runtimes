/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/_Grid",["require","mxui/mixin/_Contextable","mxui/mixin/_Scriptable","mxui/mixin/_Stateful","mxui/mixin/_Pluggable","mxui/lib/overflowHelper","mxui/mixin/_ContainingSelection","mxui/mixin/_Templated","mxui/lib/MxGridConfig","mxui/widget/SearchInput","mxui/widget/Button","mxui/widget","mxui/dom","mendix/lib/EntityPathSource","mendix/lib/MicroflowSource","mendix/lib/ValidationError","mendix/lib/XPathSource","mendix/logger","dojo/fx","dojo/sniff","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/_base/array","dojo/_base/lang","dojo/_base/event","dojo/fx/Toggler"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a){var _1b=_c.declare("mxui.widget._Grid",{mixins:[_8,_2,_3,_4,_5,_7],baseClass:"mx-grid",css:_c.createCSSMap("mx-grid",{pagingStatus:"paging-status",searchButton:"search-button",resetButton:"reset-button"}),entity:"",schema:"",reference:"",useContext:false,reqConstraints:"",xpathConstraint:"",customDataSource:null,_previousSearchConstraints:"",pagingBarNode:null,searchNode:null,toolBarNode:null,messageNode:null,searchButton:null,resetButton:null,_dataSource:null,_gridConfig:null,_gridState:null,_metaEntity:null,_toolWidgets:null,_pagingStatusNode:null,fetchMetaObject:function(){this._metaEntity=window.mx.meta.getEntity(this.entity);if(this._metaEntity==null){_12.error(this.id+": This grid has been configured for an entity the current user doesn't have access to.");return false;}return true;},setupGridConfig:function(){this._gridConfig=new _9({config:this.config,nested:this.nested});},setupGridState:function(){var _1c=this._gridConfig,_1d=this._gridState;_1d.updateperiod=_1c.gridSetting("refresh");_1d.searchbar=_1c.gridSetting("searchbar");_1d.controlbar=_1c.gridSetting("controlbar");_1d.pagingbar=_1c.gridSetting("pagingbar");_1d.selectionmode=_1c.gridSetting("selectionmode");_1d.editable=_1c.gridSetting("editable");_1d.showemptyrows=_1c.gridSetting("showemptyrows");_1d.selectfirst=_1c.gridSetting("selectfirst");_1d.selectable=(_1d.selectionmode!=="none");if(this.selectable){_1d.selectable=/^(single|multi)$/.test(this.selectable);if(this.selectable!=="multi"||_1d.selectionmode!=="simplemulti"){_1d.selectionmode=this.selectable;}}},setupDataSource:function(){var _1e=this._gridConfig,_1f=_1e.getDataSource(),_20=this.getState("pageOffset",0),_21=_1e.gridSetting("pageSize"),_22;if(this.customDataSource){_22=this.customDataSource;_22.setPageSize(_21);_22.setOffset(_20);var _23=this.getState("sortOptions",_1e.gridSetting("sortparams"));if(_23){_22.setSortOptions(_23[0][0],_23[0][1]);}}else{if(_1f){var _24={queryid:this instanceof _1("mxui/widget/DataGrid")?this.schema:"",context:this.mxcontext,page:_21,offset:_20};if(_1f.microflow){_22=new _f(_19.mixin({microflow:_1f.microflow.name},_24));}else{if(_1f.entityPath){_22=new _e(_19.mixin({path:_1f.entityPath.path},_24));}else{_22=new _11(_19.mixin({entity:this.entity,constraint:this.constraint,useContext:this.useContext,sortparams:this.getState("sortOptions",_1e.gridSetting("sortparams")),aggregates:"Calculations" in this._gridConfig.getPlugins()},_24));}}}}this._dataSource=_22;},resizeGrid:function(){this.contentNode.scrollTop=0;},setUpdateInterval:function(){var _25=this._gridState.updateperiod;if(_25&&_25.toString()!="0"){this.clearInterval();this._gridState.update=setInterval(_19.hitch(this,"reload"),parseInt(_25*1000,10));}},clearInterval:function(){if(this._gridState.update!=null){clearInterval(this._gridState.update);}},actionSelectPage:function(_26){if(!this._gridState.invertedSelection){for(var i=0,_27=this._dataSource.getObjects(),_28;_28=_27[i];i++){this._addToSelection(_28.getGuid());}}this.refreshGrid();},actionSelectAllPages:function(_29){this.selection=[];this._gridState.invertedSelection=true;this.refreshGrid();},actionClearSelection:function(_2a){if(this._hasSelection()||this._gridState.invertedSelection){this.selection=[];this._gridState.invertedSelection=false;this.refreshGrid();}},actionEditSelection:function(_2b){if(!this._hasSelection()&&!this._gridState.invertedSelection){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{for(var i=0,obj;obj=this.selection[i];i++){var _2c=this._dataSource.getObject(obj),_2d=_2b[_2c.getEntity()];if(_2d){var _2e=this.createContext();_2e.dupFrom(this.mxcontext);_2e.setObject(null,_2c.getEntity(),_2c.getGuid());window.mx.ui.execute(_2d,{context:_2e});}}}},actionInsertNew:function(_2f){var _30=this._getEntity(_2f),_31=_2f[_30];if(_31&&_30){window.mx.data.create({entity:_30,context:this.useContext?this.mxcontext:null,persistent:_31.persistent,callback:function(obj){if(!this.useContext){var _32=this._gridConfig.getDataSource(),_33=_32.entityPath&&_32.entityPath.path||this.reference,_34=_33.split("/"),_35=this.mxcontext.getTrackId();if(_34.length==2&&_35){var _36=_34[1];if(obj.isReference(_36)){obj.set(_36,_35);}}}var _37=this.createContext();_37.setContext(obj);window.mx.ui.execute(_31,{context:_37});},error:function(e){window.mx.onError(e);}},this);}},selectRow:function(row){if(this._gridState.invertedSelection){_15.remove(row,"selected");}else{_15.add(row,"selected");}},deselectRow:function(row){if(!this._gridState.invertedSelection){_15.remove(row,"selected");}else{_15.add(row,"selected");}},postCreate:function(){var req=this.reqConstraints,ref=this.reference;this.reqConstraints=req?req.split(","):[];if(ref){this.reqConstraints.push(ref.substr(0,ref.indexOf("/")));}var box=this.addFocusBox(this.controlNode);box.pressed({RIGHT_ARROW:box.FOCUS_NEXT,LEFT_ARROW:box.FOCUS_PREV});this.offerInterfaces(["close"]);this.initContext();this._previousSearchConstraints=this.getState("searchConstraints","");if(this.fetchMetaObject()){this.setupGridConfig();this.setupGridState();this.buildSearchBar();this.buildControlBar();this.buildToolBar();this.buildPagingBar();this.setupDataSource();}},getSchemaId:function(){return this.schema;},deselectAll:function(){this.selection=[];this.deselectGridRows();},registerSubscriptions:function(){this.removeSubscriptions();var _38=this.mxcontext.getTrackId();if(_38){this.subscribe({guid:this.mxcontext.getTrackId(),callback:_19.hitch(this,"objectUpdate")});}this.subscribe({entity:this.entity,callback:_19.hitch(this,"objectUpdate")});},eventItemClicked:function(e,_39){if(!this._gridState.selectable){return;}var _3a=this._gridState.selectionmode,_3b=this.domData(_39,"mendixguid"),_3c=_18.indexOf(this.selection,_3b),_3d=_3a!="singleandmaintain"||this.selection.length>1;if(_3b){var obj=this._dataSource.getObject(_3b);if(_3a=="simplemulti"||_3a=="multi"&&(_14("mac")&&e.metaKey||e.ctrlKey)){if(_3c==-1){this.selectRow(_39);this._addToSelection(obj.getGuid());}else{if(_3d){this.deselectRow(_39);this._removeFromSelection(obj.getGuid());}}}else{if(_3c==-1){this.deselectAll();this.selectRow(_39);this._addToSelection(obj.getGuid());}else{if(_3d){this.deselectRow(_39);this._removeFromSelection(obj.getGuid());}}}this._shareSelection(this._metaEntity.getEntity());}},eventActionBindingHandler:function(_3e,_3f){var _40=this._gridConfig.gridActionBindings(),_41=this._gridConfig.getActionsByKey(_40["on"+_3f]),_42=_41?this["action"+_41.actionCall]:null,_43=this._getObjectFromNode(_3e);if(this._gridState.invertedSelection){return;}if(_41&&_42&&_3e&&_43){if(this._gridState.selectable){this.deselectAll();_d.clearSelection();this.selectRow(_3e);}this._addToSelection(_43.getGuid());if(_42){_42.call(this,_41.params);}if(!this._gridState.selectable){this.deselectAll();}}else{}},eventControlBarButtonClicked:function(e){var _44=e.currentTarget,_45=_44.getAttribute("data-mendix-id");if(_45){var _46=this._gridConfig.getActionsByKey(_45);if(_46){if(_46.actionCall==="ActionSelected"){_46.actionCall="EditSelection";}else{if(_46.actionCall==="Create"){_46.actionCall="InsertNew";}}var _47="action"+_46.actionCall;if(this[_47]){this[_47](_46.params);}else{_12.error(this.id+".eventControlBarButtonClicked: Called function '"+_47+"' does not exist in this component");}}else{_12.error(this.id+".eventControlBarButtonClicked: Action with action key '"+_45+"' is not defined");}}else{_12.error(this.id+".eventControlBarButtonClicked: No action key defined!");}},actionInvokeMicroflow:function(_48){this.triggerPluginEvent("invokeMicroflow",null,_19.hitch(this,"invokeMicroflow",_48));},invokeMicroflow:function(_49){var _4a=this.entity,_4b=_49[_4a],_4c=_4b.microflow,_4d={gridid:this.schema,applyto:_4b.applyTo};if(_4b&&_4a){var _4e=this._gridState.invertedSelection,_4f=this.selection,_50=this._dataSource,_51;switch(_4b.applyTo){case "selection":if(_4e){_51=[];_50.each(function(obj){var _52=obj.getGuid();if(_18.indexOf(_4f,_52)===-1){_51.push(_52);}});}else{_51=_4f;}if(_51.length===0){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));return;}_4d.guids=_51;break;case "all":_51=_18.map(_50.getObjects(),function(obj){return obj.getGuid();});_19.mixin(_4d,{guids:_51,applyto:"selection"});break;case "selectionset":var _53,_54,_55;if(_4e){_55=_50.getSetSize()-_4f.length;_53=_50.getCurrentXPath();}else{_55=_4f.length;_53="//"+_4a;}if(_55===0){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));return;}var _56=[];for(var i=0,id;id=_4f[i];++i){var obj=_50.getObject(id);_56.push("id"+(_4e?"!=":"=")+"\""+id+"\"");}if(_56.length===0){_54="";}else{_54="["+_56.join(_4e?" and ":" or ")+"]";}_19.mixin(_4d,{xpath:_53,constraints:_54,sort:_50.getSortSettings()});break;case "set":if(_50.getSetSize()===0){_4d.applyto="none";}else{_19.mixin(_4d,{xpath:_50.getCurrentXPath(),sort:_50.getSortSettings()});}break;}var _57=this,_58=_4c.confirmation,_59=[];var _5a=function(cb){window.mx.ui.confirmation({cancel:_58.cancel,proceed:_58.proceed,content:_58.question,handler:cb});};if(this.actTriggerOnSync){_59.push("actTriggerOnSync");}if(this.actDeferSyncAction){_59.push("actDeferSyncAction");}var run=function(_5b){window.mx.ui.execute({microflow:_4c},{params:_4d,context:_57.mxcontext,store:{caller:_57},callback:_5b});};if(_58){_59.push(_5a);}if(_4c&&_4c.validate==="view"){_59.push(_19.hitch(this.mxform,"validate"));}_59.push(run);_59.push(function(_5c){if(!(this._destroyed||_4b.maintainSelection||this._gridState.selectionmode=="singleandmaintain")){this.deselectAll();this._shareSelection(this._metaEntity.getEntity());}_5c();});this.sequence(_59);}},actionReturnSelection:function(_5d){var _5e=this.mxform;_5e.validate(function(){var _5f=function(e){if(!(e instanceof _10)){window.mx.onError(e);}};_5e.save(function(){_5e.commit(function(){_5e.dispose();},_5f);},_5f);});},controlNode:null,_setToolbarAttr:function(_60){for(var i=0,btn;btn=this._toolWidgets[i++];){btn.set("disabled",_60);}},buildControlBar:function(){if(!this._gridState.controlbar&&!this._gridState.pagingbar){this.controlNode.style.display="none";}},buildToolBar:function(){this._toolWidgets=[];if(!this._gridState.controlbar){this.toolBarNode.style.display="none";return;}var _61=this._gridConfig.gridTools(),box=this.getFocusBox(this.controlNode),_62=document.createDocumentFragment();for(var i in _61){var _63=_61[i];var _64={"mxid":_63.mxid,"caption":_63.caption,"title":_63.title,"onClick":_19.hitch(this,"eventControlBarButtonClicked"),"cssClasses":"mx-name-"+_63.name+(_63.cssClass?(" "+_63.cssClass):""),"cssStyle":_63.cssStyle};if(_63.iconClass){_64.iconClass=_63.iconClass;}else{if(_63.iconUrl){_64.iconUrl=_63.iconUrl;}}var _65=new _b(_64),_66=_65.domNode;this._toolWidgets.push(_65);try{if(_61[i].gridFunction){_66.setAttribute("gridFunction",_61[i].gridFunction);_66.setAttribute("param",_61[i].param);if(_61[i].background){_66.setAttribute("background-job",_61[i].background);}if(_61[i].progress){_66.setAttribute("progress",_61[i].progress);}if(_61[i].message){_66.setAttribute("message",_61[i].message);}}if(i>0){_61[i-1]._nextNode=_66;}_61[i]._domNode=_66;_62.appendChild(_66);_62.appendChild(document.createTextNode(" "));box.add(_66);_65.startup();}catch(e){}}this.toolBarNode.appendChild(_62);_d.disableSelection(this.toolBarNode);},buildPagingBar:function(){if(!this._gridState.pagingbar){this.pagingBarNode.style.display="none";return;}var ltr=this.isLeftToRight(),_67=document.createDocumentFragment(),box=this.getFocusBox(this.controlNode),$=_d.create;this.btFirst=new _b({iconClass:ltr?"glyphicon-step-backward":"glyphicon-step-forward","onClick":_19.hitch(this,"eventPagingFirstClicked"),"class":"mx-name-paging-first"});_67.appendChild($("#",this.btFirst.domNode," "));box.add(this.btFirst.domNode);this.btPrevious=new _b({iconClass:ltr?"glyphicon-backward":"glyphicon-forward","onClick":_19.hitch(this,"eventPagingPreviousClicked"),"class":"mx-name-paging-previous"});_67.appendChild($("#",this.btPrevious.domNode," "));box.add(this.btPrevious.domNode);this._pagingStatusNode=$("div",{"class":"dijitInline "+this.css.pagingStatus});_67.appendChild($("#",this._pagingStatusNode," "));this.btNext=new _b({iconClass:ltr?"glyphicon-forward":"glyphicon-backward","onClick":_19.hitch(this,"eventPagingNextClicked"),"class":"mx-name-paging-next"});_67.appendChild($("#",this.btNext.domNode," "));box.add(this.btNext.domNode);this.btLast=new _b({iconClass:ltr?"glyphicon-step-forward":"glyphicon-step-backward","onClick":_19.hitch(this,"eventPagingLastClicked"),"class":"mx-name-paging-last"});_67.appendChild($("#",this.btLast.domNode," "));box.add(this.btLast.domNode);this.pagingBarNode.appendChild(_67);_d.disableSelection(this.pagingBarNode);},updatePagingStatus:function(_68){if(!this._gridState.pagingbar){return;}var _69=this._dataSource.getStatusMessage();_d.text(this._pagingStatusNode,_69);if(this._dataSource.atBeginning()){this.btFirst.set("disabled",true);this.btPrevious.set("disabled",true);}else{this.btFirst.set("disabled",false);this.btPrevious.set("disabled",false);}if(this._dataSource.atEnd()){this.btNext.set("disabled",true);this.btLast.set("disabled",true);}else{this.btNext.set("disabled",false);this.btLast.set("disabled",false);}},eventPagingFirstClicked:function(){if(!this._dataSource.atBeginning()){this._dataSource.first(_19.hitch(this,"refreshGrid"));}},eventPagingPreviousClicked:function(){if(!this._dataSource.atBeginning()){this._dataSource.previous(_19.hitch(this,"refreshGrid"));}},eventPagingNextClicked:function(){if(!this._dataSource.atEnd()){this._dataSource.next(_19.hitch(this,"refreshGrid"));}},eventPagingLastClicked:function(){if(!this._dataSource.atEnd()){this._dataSource.last(_19.hitch(this,"refreshGrid"));}},_searchElements:null,_searchFilled:false,searchArgumentNode:null,searchControlNode:null,_searchGetConstraints:function(){var _6a="";var _6b=[];_18.forEach(this._searchElements,function(_6c){var _6d=_6c.get("query");if(_6d!==""){_6b.push(_6d);}});if(_6b.length){_6a="["+_6b.join(" and ")+"]";}return _6a+this._gridState.xpathConstraint;},buildSearchBlock:function(){var $=_d.create;if(this._gridState.isSearchBuild){return;}this._gridState.isSearchBuild=true;var _6e=this.searchButton=new _b({"caption":window.mx.ui.translate("mxui.widget.DataGrid",["search"]),"onClick":_19.hitch(this,"eventSearchActivated"),"class":"mx-name-search "+this.css.searchButton});this.searchControlNode.appendChild($("#",_6e.domNode," "));var _6f=this.resetButton=new _b({"caption":window.mx.ui.translate("mxui.widget.DataGrid",["reset"]),"onClick":_19.hitch(this,"eventSearchResetClicked"),"class":"mx-name-reset "+this.css.resetButton});this.searchControlNode.appendChild($("#",_6f.domNode," "));var _70=document.createDocumentFragment();this._searchElements=_18.map(this._gridConfig.searchBarItems(),_19.hitch(this,function(_71){var _72=new _a(_19.mixin({entity:this.entity,mxcontext:this.mxcontext},_71));var _73=this.getState("searchInput",{});_72.set("value",_73[_71.path]||_72.get("value"));this.connect(_72,"onKeyUp","eventSearchActivated");_70.appendChild(_72.domNode);_72.startup();return _72;}));this.searchArgumentNode.appendChild(_70);},buildSearchBar:function(){if(!this._gridState.searchbar){this.searchNode.style.display="none";this._searchFilled=true;return;}var _74=this._gridConfig.searchBarConfig();if(_74){this._gridState.searchBarVisible=this.getState("searchBarVisible",!_74.toggledByDefault);this._gridState.searchBarTogglable=!!_74.toggleable;}else{this._gridState.searchBarVisible=true;}if(!this._gridState.searchBarVisible){var _75=false;var _76=this._gridConfig.searchBarItems();for(var i in _76){var _77=_76[i];if(_77.defaults){this.buildSearchBlock();_75=true;break;}}this.searchNode.style.display="none";this._gridState.isSearchBuild=_75;}else{this.buildSearchBlock();this.searchNode.style.display="";}this.checkSearchFields();},eventSearchActivated:function(e){_1a.stop(e);if(!(e.type==="click"||(e.keyCode===13&&!e.shiftKey))){return;}var _78=this,_79=this.searchButton;this.checkSearchFields();if(!this.constraintsFilled()){return;}_79.set("disabled",true);this._dataSource.isValid(function(_7a){if(_7a){_78._dataSource.setConstraints(_78._searchGetConstraints(),function(){_78.selection=[];_78.refreshGrid();if(_78.triggerOnSearchChanged){_78.triggerOnSearchChanged();}_79.set("disabled",false);});}else{_79.set("disabled",false);}});},eventSearchResetClicked:function(){var _7b=this._dataSource;_18.forEach(this._searchElements,function(_7c){_7c.reset();});this.checkSearchFields();_7b.setConstraints(this._searchGetConstraints());var _7d=_19.hitch(this,function(){this.refreshGrid();if(this.triggerOnSearchChanged){this.triggerOnSearchChanged();}});if(this.constraintsFilled()){_7b.isValid(function(_7e){if(_7e){_7b.refresh(_7d);}else{_7b.clean(_7d);}});}},checkSearchFields:function(){var _7f=this._gridConfig.gridSetting("waitforsearch");if(!_7f){this._searchFilled=true;return;}this._searchFilled=_18.some(this._searchElements,_19.hitch(this,function(_80){if(_80.get("query")!==""){this.messageNode.innerHTML="";this.messageNode.style.display="none";return true;}}));if(!this._searchFilled){this.messageNode.innerHTML=window.mx.ui.translate("mxui.widget.DataGrid","waitForSearch");this.messageNode.style.display="block";}},constraintsFilled:function(){if(!this._searchFilled){return false;}for(var i=0,_81;_81=this.reqConstraints[i];i++){if(!this.mxcontext.getContext(_81)){return false;}}return true;},reload:function(_82){if(this.constraintsFilled()){var _83=this;this._dataSource.isValid(function(_84){if(_84){_83._dataSource.refresh(function(){_83.refreshGrid();if(_82){_82();}});}});}},actionToggleSearch:function(_85){var _86=this;if(!this._gridState.searchBarTogglable){return;}this.buildSearchBlock();this._gridState.searchBarVisible=!this._gridState.searchBarVisible;if(!this._gridState.searchBarVisible){this._searchWipeOut=this._searchWipeOut||_13.wipeOut({node:this.searchNode,duration:200,onEnd:function(){setTimeout(function(){_86.resize(_86._resizeBox);},0);_18.forEach(_86._searchElements,function(_87){_87.cleanup();});}});this._searchWipeOut.play();}else{this._searchWipeIn=this._searchWipeIn||_13.wipeIn({node:this.searchNode,duration:200,onEnd:function(){setTimeout(function(){_6.showOverflow(_86.domNode);_86.resize(_86._resizeBox);},0);try{_18.some(_86._searchElements,function(_88){if(!_88.get("hidden")){_88.focus();return true;}});}catch(e){}}});_6.hideOverflow(this.domNode);this._searchWipeIn.play();}},applyContext:function(_89,_8a){if(this._metaEntity==null){if(_8a){_8a();}return;}if(!this._dataSource){_12.error(this.id+".applyContext: Applying context before rendered!!!");if(_8a){_8a();}return;}this.selection=[];this.cloneContext(_89);this.setUpdateInterval();this._gridState.xpathConstraint=this.xpathConstraint;var _8b=this.mxcontext.getParam("xpathConstraint");if(_8b){this._gridState.xpathConstraint+=_8b;}this.removeSubscriptions();this.registerSubscriptions();if(this.reference){var _8c=this.reference.split(/\//),_8d=_8c[0],_8e=_8c[1];var id=this.mxcontext.getContext(_8d);if(id){var _8f="["+_8e+"=\""+id+"\"]";this._gridState.xpathConstraint+=_8f;}else{}}if(!this._gridState.inDenial){var _90=[];if(this.constraintsFilled()){var _91=[];var _92=function(_93){return function(_94){_93.reinit(_94);};};_18.forEach(this._searchElements,function(_95){_91.push(_92(_95));});_90.push(function(_96){this.collect(_91,_96);});_90.push(function(_97){if(this._dataSource.setConstraints){var _98=this._previousSearchConstraints?this._previousSearchConstraints:this._searchGetConstraints();this._previousSearchConstraints="";this._dataSource.setConstraints(_98);}this._dataSource.setOffset(this.getState("pageOffset",0));this._dataSource.reload(_97);});}else{_90.push("actCleanDS");}this.sequence(_90,function(){this.selection=this.getState("selectedGuids",this.selection);this.filterSelected();this.refreshGrid();_8a();});}else{if(_8a){_8a();}}},filterSelected:function(){this.selection=_18.filter(this.selection,function(_99){return this._dataSource.getObject(_99)!=null;},this);},objectUpdateNotification:function(){var _9a=this;if(!this._gridState.inDenial&&this.constraintsFilled()){this._dataSource.isValid(function(_9b){if(_9b){_9a.sequence([_19.hitch(_9a._dataSource,"entityUpdate"),function(_9c){this.filterSelected();this.refreshGrid();if(_9c){_9c();}}]);}});}},refreshGrid:function(){if(this._dataSource.afterEnd()){this._dataSource.first(_19.hitch(this,"refreshGrid"));return;}this.updatePagingStatus();this.fillGrid();this.resizeGrid();},actCleanDS:function(_9d){this.selection=[];this._dataSource.clean(_9d);},actionDeleteSelection:function(_9e){if(this._gridState.invertedSelection){}else{if(!this._hasSelection()){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{var _9f=this;var _a0=function(){var _a1=_9f.selection;_9f.deselectAll();_9f._shareSelection(_9f._metaEntity.getEntity());window.mx.data.remove({guids:_a1,callback:function(){window.mx.data.sendClassUpdate(_9f.entity);},error:function(e){window.mx.onError(e);}});};if(_9e===true){_a0();}else{window.mx.ui.confirmation({content:window.mx.ui.translate("mxui.widget.DataGrid","confirm_delete",this.selection.length),handler:_a0});}}}},resize:function(box){var _a2=false;if(box){var _a3=_17.getMarginBox(this.domNode),_a4=_17.getMarginBox(this.contentNode),_a5=box.h-(_a3.h-_a4.h);if(_a5>_d.minContainerHeight){_16.set(this.contentNode,"height",_a5+"px");_a2=true;if(this.headTable){_16.set(this.headTable,"top","0px");}}}if(!_a2){_16.set(this.contentNode,"height","auto");}this._resizeBox=box;},close:function(){this.disposeContent();},onHide:function(e){_18.forEach(this._searchElements,function(_a6){_a6.cleanup();});},storeState:function(_a7){_a7("searchBarVisible",this._gridState.searchBarVisible);_a7("searchConstraints",this._dataSource.getConstraints&&this._dataSource.getConstraints());_a7("pageOffset",this._dataSource.getOffset());_a7("selectedGuids",this.selection);if(this._dataSource.getSortSettings){_a7("sortOptions",this._dataSource.getSortSettings());}var _a8={};_18.forEach(this._searchElements,function(_a9){_a8[_a9.path]=_a9.get("value");});_a7("searchInput",_a8);},uninitialize:function(){this.clearInterval();this.removeSubscriptions();this._clearSelectionStore();_c.destroyChildren(this.searchControlNode);_c.destroyChildren(this.toolBarNode);_c.destroyChildren(this.pagingBarNode);if(this.itemNode){_c.destroyChildren(this.itemNode);}if(this._dataSource){this._dataSource.destroy();}_18.forEach(this._searchElements,function(_aa){_aa.destroy();});}});return _1b;});