/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/_Grid",["require","mxui/mixin/_Contextable","mxui/mixin/_Scriptable","mxui/mixin/_Stateful","mxui/mixin/_Pluggable","mxui/lib/overflowHelper","mxui/mixin/_ContainingSelection","mxui/mixin/_Templated","mxui/lib/MxGridConfig","mxui/widget/SearchInput","mxui/widget/Button","mxui/widget/_DynamicButton","mxui/widget","mxui/dom","mendix/lib/MxContext","mendix/lib/dataSourceTypes","mendix/lib/ValidationError","mendix/logger","webcore/datasource/OfflineSource","webcore/datasource/OfflineByReferenceSource","webcore/datasource/EntityPathSource","webcore/datasource/MicroflowSource","webcore/datasource/XPathSource","dojo/fx","dojo/sniff","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/_base/array","dojo/_base/lang","dojo/_base/event","dojo/fx/Toggler"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f){var _20=_d.declare("mxui.widget._Grid",{mixins:[_8,_2,_3,_4,_5,_7],baseClass:"mx-grid",css:_d.createCSSMap("mx-grid",{pagingStatus:"paging-status",searchButton:"search-button",resetButton:"reset-button"}),entity:"",schema:"",useContext:false,customDataSource:null,dataSourceMixin:null,_previousSearchConstraints:"",pagingBarNode:null,searchNode:null,toolBarNode:null,messageNode:null,searchButton:null,resetButton:null,_dataSource:null,_gridConfig:null,_gridState:null,_metaEntity:null,_toolWidgets:null,_pagingStatusNode:null,_preserveSelection:false,constructor:function(_21){this._preserveSelection="selection" in _21;},fetchMetaObject:function(){this._metaEntity=window.mx.meta.getEntity(this.entity);if(this._metaEntity==null){_12.error(this.id+": This grid has been configured for an entity the current user doesn't have access to.");return false;}return true;},setupGridConfig:function(){this._gridConfig=new _9({config:this.config,nested:this.nested});},setupGridState:function(){var _22=this._gridConfig,_23=this._gridState;_23.updateperiod=_22.gridSetting("refresh");_23.searchbar=_22.gridSetting("searchbar");_23.controlbar=_22.gridSetting("controlbar");_23.pagingbar=_22.gridSetting("pagingbar");_23.selectionmode=_22.gridSetting("selectionmode");_23.selectable=(_23.selectionmode!=="none");_23.editable=_22.gridSetting("editable");_23.showemptyrows=_22.gridSetting("showemptyrows");_23.selectfirst=_22.gridSetting("selectfirst");},setupDataSource:function(){var _24=this._gridConfig,_25=_24.getDataSource(),_26=this.getState("pageOffset",0),_27=_24.gridSetting("pageSize"),_28;if(this.customDataSource){_28=this.customDataSource;_28.setPageSize(_27);_28.setOffset(_26);var _29=this.getState("sortOptions",_24.gridSetting("sortparams"));if(_29){_28.setSortOptions(_29[0][0],_29[0][1]);}}else{if(_25){var _2a={queryid:this instanceof _1("mxui/widget/DataGrid")?this.schema:"",context:this.mxcontext,page:_27,offset:_26};var _2b=_25.type;if(_2b===_10.microflow){_28=new _16(_1e.mixin(_2a,_25));}else{if(_2b===_10.entityPath){_28=new _15(_1e.mixin(_2a,_25));}else{if(_2b===_10.offline){_28=new _13(_1e.mixin(_2a,{entity:this.entity,sort:this.getState("sortOptions",_24.gridSetting("sortparams"))}));}else{if(_2b===_10.offlineReference){_28=new _14(_1e.mixin(_2a,{entity:this.entity,reference:this.reference.split("/")[1],sort:this.getState("sortOptions",_24.gridSetting("sortparams"))}));}else{_28=new _17(_1e.mixin(_2a,{useContext:this.useContext,sortparams:this.getState("sortOptions",_24.gridSetting("sortparams")),aggregates:"Calculations" in this._gridConfig.getPlugins()},_25,this.dataSourceMixin));}}}}}}this._dataSource=_28;},resizeGrid:function(){this.contentNode.scrollTop=0;},setUpdateInterval:function(){var _2c=this._gridState.updateperiod;if(_2c&&_2c.toString()!="0"){this.clearInterval();this._gridState.update=setInterval(_1e.hitch(this,"reload"),parseInt(_2c*1000,10));}},clearInterval:function(){if(this._gridState.update!=null){clearInterval(this._gridState.update);}},actionSelectPage:function(_2d){if(!this._gridState.invertedSelection){for(var i=0,_2e=this._dataSource.getObjects(),_2f;_2f=_2e[i];i++){this._addToSelection(_2f.getGuid());}}this.refreshGrid();},actionSelectAllPages:function(_30){this.selection=[];this._gridState.invertedSelection=true;this.refreshGrid();},actionClearSelection:function(_31){if(this._hasSelection()||this._gridState.invertedSelection){this.selection=[];this._gridState.invertedSelection=false;this.refreshGrid();}},actionEditSelection:function(_32){if(!this._hasSelection()&&!this._gridState.invertedSelection){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{for(var i=0,obj;obj=this.selection[i];i++){var _33=this._dataSource.getObject(obj),_34=_32[_33.getEntity()];if(_34){var _35=this.createContext();_35.dupFrom(this.mxcontext);_35.setObject(null,_33.getEntity(),_33.getGuid());window.mx.ui.execute(_34,{context:_35});}}}},actionInsertNew:function(_36){var _37=this._getEntity(_36),_38=_36[_37];if(_38&&_37){window.mx.data.create({entity:_37,context:this.useContext?this.mxcontext:null,persistent:_38.persistent,callback:function(obj){if(!this.useContext){var _39=this._gridConfig.getDataSource(),_3a=_39.path||"",_3b=_3a.split("/"),_3c=this.mxcontext.getTrackId();if(_3b.length==2&&_3c){var _3d=_3b[0];if(obj.isReference(_3d)){obj.set(_3d,_3c);}}}var _3e=this.createContext();_3e.setContext(obj);window.mx.ui.execute(_38,{context:_3e});},error:function(e){window.mx.onError(e);}},this);}},selectRow:function(row){if(this._gridState.invertedSelection){_1a.remove(row,"selected");}else{_1a.add(row,"selected");}},deselectRow:function(row){if(!this._gridState.invertedSelection){_1a.remove(row,"selected");}else{_1a.add(row,"selected");}},postCreate:function(){var box=this.addFocusBox(this.controlNode);box.pressed({RIGHT_ARROW:box.FOCUS_NEXT,LEFT_ARROW:box.FOCUS_PREV});this.offerInterfaces(["close"]);this.initContext();this._previousSearchConstraints=this.getState("searchConstraints","");if(this.fetchMetaObject()){this.setupGridConfig();this.setupGridState();this.buildSearchBar();this.buildControlBar();this.buildToolBar();this.buildPagingBar();this.setupDataSource();}},getSchemaId:function(){return this.schema;},deselectAll:function(){this.selection=[];this.deselectGridRows();},registerSubscriptions:function(){this.removeSubscriptions();var _3f=this.mxcontext.getTrackId();if(_3f){this.subscribe({guid:this.mxcontext.getTrackId(),callback:_1e.hitch(this,"objectUpdate")});}this.subscribe({entity:this.entity,callback:_1e.hitch(this,"objectUpdate")});},eventItemClicked:function(e,_40){if(!this._gridState.selectable){return;}var _41=this._gridState.selectionmode,_42=this.domData(_40,"mendixguid"),_43=_1d.indexOf(this.selection,_42),_44=_41!="singleandmaintain"||this.selection.length>1;if(_42){var obj=this._dataSource.getObject(_42);if(_41=="simplemulti"||_41=="multi"&&(_19("mac")&&e.metaKey||e.ctrlKey)){if(_43==-1){this.selectRow(_40);this._addToSelection(obj.getGuid());}else{if(_44){this.deselectRow(_40);this._removeFromSelection(obj.getGuid());}}}else{if(_43==-1){this.deselectAll();this.selectRow(_40);this._addToSelection(obj.getGuid());}else{if(_44){this.deselectRow(_40);this._removeFromSelection(obj.getGuid());}}}this._shareSelection(this._metaEntity.getEntity());}},eventActionBindingHandler:function(_45,_46){var _47=this._gridConfig.gridActionBindings(),_48=this._gridConfig.getActionsByKey(_47["on"+_46]),_49=_48?this["action"+_48.actionCall]:null,_4a=this._getObjectFromNode(_45);if(this._gridState.invertedSelection){return;}if(_48&&_49&&_45&&_4a){if(this._gridState.selectable){this.deselectAll();_e.clearSelection();this.selectRow(_45);}this._addToSelection(_4a.getGuid());if(_49){_49.call(this,_48.params);}if(!this._gridState.selectable){this.deselectAll();}}else{}},eventControlBarButtonClicked:function(e){var _4b=e.currentTarget,_4c=_4b.getAttribute("data-mendix-id");if(_4c){var _4d=this._gridConfig.getActionsByKey(_4c);if(_4d){if(_4d.actionCall==="ActionSelected"){_4d.actionCall="EditSelection";}else{if(_4d.actionCall==="Create"){_4d.actionCall="InsertNew";}}var _4e="action"+_4d.actionCall;if(this[_4e]){this[_4e](_4d.params);}else{_12.error(this.id+".eventControlBarButtonClicked: Called function '"+_4e+"' does not exist in this component");}}else{_12.error(this.id+".eventControlBarButtonClicked: Action with action key '"+_4c+"' is not defined");}}else{_12.error(this.id+".eventControlBarButtonClicked: No action key defined!");}},actionInvokeAction:function(_4f){this.triggerPluginEvent("invokeAction",null,_1e.hitch(this,"invokeAction",_4f));},_getPlainSelection:function(){if(!this._gridState.invertedSelection){return this.selection;}var _50=this,_51=[];this._dataSource.each(function(obj){var _52=obj.getGuid();if(_1d.indexOf(_50.selection,_52)===-1){_51.push(_52);}});return _51;},_getXpathSelection:function(){var _53,_54,_55,_56=this._gridState.invertedSelection;if(_56){_55=this._dataSource.getSetSize()-this.selection.length;_53=this._dataSource.getCurrentXPath();}else{_55=this.selection.length;_53="//"+this.entity;}if(_55===0){return null;}var _57=[];_1d.forEach(this.selection,function(id){_57.push("id"+(_56?"!=":"=")+"\""+id+"\"");});if(_57.length===0){_54="";}else{_54="["+_57.join(_56?" and ":" or ")+"]";}return {xpath:_53,constraints:_54,sort:this._dataSource.getSortSettings()};},_getMicroflowParameters:function(_58){var _59={gridid:this.schema};if(!_58){_59.applyto="none";}else{if(_58=="selection"){if(this._dataSource instanceof _17){var _5a=this._getXpathSelection();if(!_5a){return null;}_59.applyto="selectionset";_1e.mixin(_59,_5a);}else{var _5b=this._getPlainSelection();if(_5b.length===0){return null;}_59.applyto="selection";_59.guids=_5b;}}else{if(_58=="allPages"){if(this._dataSource instanceof _17){if(this._dataSource.getSetSize()===0){_59.applyto="none";}_1e.mixin(_59,{xpath:this._dataSource.getCurrentXPath(),sort:this._dataSource.getSortSettings(),applyto:"set"});}else{var _5c=_1d.map(this._dataSource.getObjects(),function(obj){return obj.getGuid();});_59.applyto="selection";_59.guids=_5c;}}}}return _59;},invokeAction:function(_5d){var _5e=_5d[this.entity],_5f=_5e.action,_60=this,_61=[];if(!_5f){return;}if(this.actDeferSyncAction){_61.push("actDeferSyncAction");}if(_5f.microflow&&_5f.microflow.confirmation){var _62=_5f.microflow.confirmation;_61.push(function(_63){window.mx.ui.confirmation({cancel:_62.cancel,proceed:_62.proceed,content:_62.question,handler:_63});});}if(_5f.form||(_5f.microflow&&_5f.microflow.validate==="view")){_61.push(_1e.hitch(this.mxform,"validate"));}_61.push(function(_64){_60.mxform.save(_64,function(err){if(!(err instanceof mendix.lib.ValidationError)){window.mx.onError(err);}});});function _65(){if(!(_60._destroyed||_5e.maintainSelection||_60._gridState.selectionmode=="singleandmaintain")){_60.deselectAll();_60._shareSelection(_60._metaEntity.getEntity());}};if(_5f.microflow){var _66=this._getMicroflowParameters(_5f.microflow.applyTo);if(!_66){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));return;}_61.push(function(){window.mx.ui.execute(_5f,{params:_66,context:_60.mxcontext,store:{caller:_60},callback:_65});});}else{var _67=new _f();if(_5f.form.passContext){var _68=this._getPlainSelection();if(!_68.length){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));return;}_67.setTrackId(_68[0]);_67.setTrackEntity(this.entity);}_61.push(function(){window.mx.ui.execute(_5f,{context:_67});_65();});}this.sequence(_61);},actionReturnSelection:function(_69){var _6a=this.mxform;_6a.validate(function(){var _6b=function(e){if(!(e instanceof _11)){window.mx.onError(e);}};_6a.save(function(){_6a.commit(function(){_6a.dispose();},_6b);},_6b);});},controlNode:null,_setToolbarAttr:function(_6c){for(var i=0,btn;btn=this._toolWidgets[i++];){btn.set("disabled",_6c);}},buildControlBar:function(){if(!this._gridState.controlbar&&!this._gridState.pagingbar){this.controlNode.style.display="none";}},buildToolBar:function(){this._toolWidgets=[];if(!this._gridState.controlbar){this.toolBarNode.style.display="none";return;}var _6d=this._gridConfig.gridTools(),box=this.getFocusBox(this.controlNode),_6e=document.createDocumentFragment();for(var i in _6d){var _6f=_6d[i];var _70={"mxid":_6f.mxid,"caption":_6f.caption,"title":_6f.title,"onClick":_1e.hitch(this,"eventControlBarButtonClicked"),"cssClasses":"mx-name-"+_6f.name+(_6f.cssClass?(" "+_6f.cssClass):""),"cssStyle":_6f.cssStyle};if(_6f.iconClass){_70.iconClass=_6f.iconClass;}else{if(_6f.iconUrl){_70.iconUrl=_6f.iconUrl;}}var _71=new _c(_70),_72=_71.domNode;_71.applyContext(this.mxcontext);this._toolWidgets.push(_71);try{if(_6d[i].gridFunction){_72.setAttribute("gridFunction",_6d[i].gridFunction);_72.setAttribute("param",_6d[i].param);if(_6d[i].background){_72.setAttribute("background-job",_6d[i].background);}if(_6d[i].progress){_72.setAttribute("progress",_6d[i].progress);}if(_6d[i].message){_72.setAttribute("message",_6d[i].message);}}if(i>0){_6d[i-1]._nextNode=_72;}_6d[i]._domNode=_72;_6e.appendChild(_72);_6e.appendChild(document.createTextNode(" "));box.add(_72);_71.startup();}catch(e){}}this.toolBarNode.appendChild(_6e);_e.disableSelection(this.toolBarNode);},buildPagingBar:function(){if(!this._gridState.pagingbar){this.pagingBarNode.style.display="none";return;}var ltr=this.isLeftToRight(),_73=document.createDocumentFragment(),box=this.getFocusBox(this.controlNode),$=_e.create;this.btFirst=new _b({iconClass:ltr?"glyphicon-step-backward":"glyphicon-step-forward","onClick":_1e.hitch(this,"eventPagingFirstClicked"),"class":"mx-name-paging-first"});_73.appendChild($("#",this.btFirst.domNode," "));box.add(this.btFirst.domNode);this.btPrevious=new _b({iconClass:ltr?"glyphicon-backward":"glyphicon-forward","onClick":_1e.hitch(this,"eventPagingPreviousClicked"),"class":"mx-name-paging-previous"});_73.appendChild($("#",this.btPrevious.domNode," "));box.add(this.btPrevious.domNode);this._pagingStatusNode=$("div",{"class":"dijitInline "+this.css.pagingStatus});_73.appendChild($("#",this._pagingStatusNode," "));this.btNext=new _b({iconClass:ltr?"glyphicon-forward":"glyphicon-backward","onClick":_1e.hitch(this,"eventPagingNextClicked"),"class":"mx-name-paging-next"});_73.appendChild($("#",this.btNext.domNode," "));box.add(this.btNext.domNode);this.btLast=new _b({iconClass:ltr?"glyphicon-step-forward":"glyphicon-step-backward","onClick":_1e.hitch(this,"eventPagingLastClicked"),"class":"mx-name-paging-last"});_73.appendChild($("#",this.btLast.domNode," "));box.add(this.btLast.domNode);this.pagingBarNode.appendChild(_73);_e.disableSelection(this.pagingBarNode);},updatePagingStatus:function(_74){if(!this._gridState.pagingbar){return;}var _75=this._dataSource.getStatusMessage();_e.text(this._pagingStatusNode,_75);if(this._dataSource.atBeginning()){this.btFirst.set("disabled",true);this.btPrevious.set("disabled",true);}else{this.btFirst.set("disabled",false);this.btPrevious.set("disabled",false);}if(this._dataSource.atEnd()){this.btNext.set("disabled",true);this.btLast.set("disabled",true);}else{this.btNext.set("disabled",false);this.btLast.set("disabled",false);}},eventPagingFirstClicked:function(){if(!this._dataSource.atBeginning()){this._dataSource.first(_1e.hitch(this,"refreshGrid"));}},eventPagingPreviousClicked:function(){if(!this._dataSource.atBeginning()){this._dataSource.previous(_1e.hitch(this,"refreshGrid"));}},eventPagingNextClicked:function(){if(!this._dataSource.atEnd()){this._dataSource.next(_1e.hitch(this,"refreshGrid"));}},eventPagingLastClicked:function(){if(!this._dataSource.atEnd()){this._dataSource.last(_1e.hitch(this,"refreshGrid"));}},_searchElements:null,_searchFilled:false,searchArgumentNode:null,searchControlNode:null,_searchGetConstraints:function(){var _76="";var _77=[];_1d.forEach(this._searchElements,function(_78){var _79=_78.get("query");if(_79!==""){_77.push(_79);}});if(_77.length){_76="["+_77.join(" and ")+"]";}return _76+this._gridState.xpathConstraint;},buildSearchBlock:function(){var $=_e.create;if(this._gridState.isSearchBuild){return;}this._gridState.isSearchBuild=true;var _7a=this.searchButton=new _b({"caption":window.mx.ui.translate("mxui.widget.DataGrid",["search"]),"onClick":_1e.hitch(this,"eventSearchActivated"),"class":"btn-default mx-name-search "+this.css.searchButton});this.searchControlNode.appendChild($("#",_7a.domNode," "));var _7b=this.resetButton=new _b({"caption":window.mx.ui.translate("mxui.widget.DataGrid",["reset"]),"onClick":_1e.hitch(this,"eventSearchResetClicked"),"class":"btn-default mx-name-reset "+this.css.resetButton});this.searchControlNode.appendChild($("#",_7b.domNode," "));var _7c=document.createDocumentFragment();this._searchElements=_1d.map(this._gridConfig.searchBarItems(),_1e.hitch(this,function(_7d){var _7e=new _a(_1e.mixin({entity:this.entity,mxcontext:this.mxcontext},_7d));var _7f=this.getState("searchInput",{});_7e.set("value",_7f[_7d.path]||_7e.get("value"));this.connect(_7e,"onKeyUp","eventSearchActivated");_7c.appendChild(_7e.domNode);_7e.startup();return _7e;}));this.searchArgumentNode.appendChild(_7c);},buildSearchBar:function(){if(!this._gridState.searchbar){this.searchNode.style.display="none";this._searchFilled=true;return;}var _80=this._gridConfig.searchBarConfig();if(_80){this._gridState.searchBarVisible=this.getState("searchBarVisible",!_80.toggledByDefault);this._gridState.searchBarTogglable=!!_80.toggleable;}else{this._gridState.searchBarVisible=true;}if(!this._gridState.searchBarVisible){var _81=false;var _82=this._gridConfig.searchBarItems();for(var i in _82){var _83=_82[i];if(_83.defaults){this.buildSearchBlock();_81=true;break;}}this.searchNode.style.display="none";this._gridState.isSearchBuild=_81;}else{this.buildSearchBlock();this.searchNode.style.display="";}this.checkSearchFields();},eventSearchActivated:function(e){_1f.stop(e);if(!(e.type==="click"||(e.keyCode===13&&!e.shiftKey))){return;}var _84=this,_85=this.searchButton;this.checkSearchFields();if(!this.constraintsFilled()){return;}_85.set("disabled",true);this._dataSource.isValid(function(_86){if(_86){_84._dataSource.setConstraints(_84._searchGetConstraints(),function(){if(!_84._preserveSelection){_84.selection=[];}_84.refreshGrid();if(_84.triggerOnSearchChanged){_84.triggerOnSearchChanged();}_85.set("disabled",false);});}else{_85.set("disabled",false);}});},eventSearchResetClicked:function(){var _87=this._dataSource;_1d.forEach(this._searchElements,function(_88){_88.reset();});this.checkSearchFields();_87.setConstraints(this._searchGetConstraints());var _89=_1e.hitch(this,function(){this.refreshGrid();if(this.triggerOnSearchChanged){this.triggerOnSearchChanged();}});if(this.constraintsFilled()){_87.isValid(function(_8a){if(_8a){_87.refresh(_89);}else{_87.clean(_89);}});}},checkSearchFields:function(){var _8b=this._gridConfig.gridSetting("waitforsearch");if(!_8b){this._searchFilled=true;return;}this._searchFilled=_1d.some(this._searchElements,_1e.hitch(this,function(_8c){if(_8c.get("query")!==""){this.messageNode.innerHTML="";this.messageNode.style.display="none";return true;}}));if(!this._searchFilled){this.messageNode.innerHTML=window.mx.ui.translate("mxui.widget.DataGrid","waitForSearch");this.messageNode.style.display="block";}},constraintsFilled:function(){return this._searchFilled;},reload:function(_8d){if(this.constraintsFilled()){var _8e=this;this._dataSource.isValid(function(_8f){if(_8f){_8e._dataSource.refresh(function(){_8e.refreshGrid();if(_8d){_8d();}});}});}},actionToggleSearch:function(_90){var _91=this;if(!this._gridState.searchBarTogglable){return;}this.buildSearchBlock();this._gridState.searchBarVisible=!this._gridState.searchBarVisible;if(!this._gridState.searchBarVisible){this._searchWipeOut=this._searchWipeOut||_18.wipeOut({node:this.searchNode,duration:200,onEnd:function(){setTimeout(function(){_91.resize(_91._resizeBox);},0);_1d.forEach(_91._searchElements,function(_92){_92.cleanup();});}});this._searchWipeOut.play();}else{this._searchWipeIn=this._searchWipeIn||_18.wipeIn({node:this.searchNode,duration:200,onEnd:function(){setTimeout(function(){_6.showOverflow(_91.domNode);_91.resize(_91._resizeBox);},0);try{_1d.some(_91._searchElements,function(_93){if(!_93.get("hidden")){_93.focus();return true;}});}catch(e){}}});_6.hideOverflow(this.domNode);this._searchWipeIn.play();}},applyContext:function(_94,_95){if(this._metaEntity==null){if(_95){_95();}return;}if(!this._dataSource){_12.error(this.id+".applyContext: Applying context before rendered!!!");if(_95){_95();}return;}this.cloneContext(_94);this.setUpdateInterval();_1d.forEach(this._toolWidgets,function(_96){_96.applyContext(this.mxcontext);},this);this._gridState.xpathConstraint="";var _97=this.mxcontext.getParam("xpathConstraint");if(_97){this._gridState.xpathConstraint+=_97;}this.removeSubscriptions();this.registerSubscriptions();if(!this._gridState.inDenial){var _98=[];if(this.constraintsFilled()){var _99=[];var _9a=function(_9b){return function(_9c){_9b.reinit(_9c);};};_1d.forEach(this._searchElements,function(_9d){_99.push(_9a(_9d));});_98.push(function(_9e){this.collect(_99,_9e);});_98.push(function(_9f){if(this._dataSource.setConstraints){var _a0=this._previousSearchConstraints?this._previousSearchConstraints:this._searchGetConstraints();this._previousSearchConstraints="";this._dataSource.setConstraints(_a0);}this._dataSource.setOffset(this.getState("pageOffset",0));this._dataSource.reload(_9f);});}else{_98.push("actCleanDS");}this.sequence(_98,function(){if(!this._preserveSelection){this.selection=this.getState("selectedGuids",[]);this.filterSelected();}this.refreshGrid();_95();});}else{if(_95){_95();}}},filterSelected:function(){this.selection=_1d.filter(this.selection,function(_a1){return this._dataSource.getObject(_a1)!=null;},this);},objectUpdateNotification:function(){var _a2=this;if(!this._gridState.inDenial&&this.constraintsFilled()){this._dataSource.isValid(function(_a3){if(_a3){_a2.sequence([_1e.hitch(_a2._dataSource,"entityUpdate"),function(_a4){this.filterSelected();this.refreshGrid();if(_a4){_a4();}}]);}});}},refreshGrid:function(){if(this._dataSource.afterEnd()){this._dataSource.first(_1e.hitch(this,"refreshGrid"));return;}this.updatePagingStatus();this.fillGrid();this.resizeGrid();},actCleanDS:function(_a5){this.selection=[];this._dataSource.clean(_a5);},actionDeleteSelection:function(_a6){if(this._gridState.invertedSelection){}else{if(!this._hasSelection()){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{var _a7=this;var _a8=function(){var _a9=_a7.selection;_a7.deselectAll();_a7._shareSelection(_a7._metaEntity.getEntity());window.mx.data.remove({guids:_a9,callback:function(){window.mx.data.sendClassUpdate(_a7.entity);},error:function(e){window.mx.onError(e);}});};if(_a6===true){_a8();}else{window.mx.ui.confirmation({content:window.mx.ui.translate("mxui.widget.DataGrid","confirm_delete",this.selection.length),handler:_a8});}}}},resize:function(box){var _aa=false;if(box){var _ab=_1c.getMarginBox(this.domNode),_ac=_1c.getMarginBox(this.contentNode),_ad=box.h-(_ab.h-_ac.h);if(_ad>_e.minContainerHeight){_1b.set(this.contentNode,"height",_ad+"px");_aa=true;if(this.headTable){_1b.set(this.headTable,"top","0px");}}}this.contentNode.style.overflow=_aa?"auto":"";if(!_aa){_1b.set(this.contentNode,"height","auto");}this._resizeBox=box;},close:function(){this.disposeContent();},onHide:function(e){_1d.forEach(this._searchElements,function(_ae){_ae.cleanup();});},storeState:function(_af){_af("searchBarVisible",this._gridState.searchBarVisible);_af("searchConstraints",this._dataSource.getConstraints&&this._dataSource.getConstraints());_af("pageOffset",this._dataSource.getOffset());_af("selectedGuids",this.selection);if(this._dataSource.getSortSettings){_af("sortOptions",this._dataSource.getSortSettings());}var _b0={};_1d.forEach(this._searchElements,function(_b1){_b0[_b1.path]=_b1.get("value");});_af("searchInput",_b0);},uninitialize:function(){this.clearInterval();this.removeSubscriptions();this._clearSelectionStore();_d.destroyWidgetsIn(this.searchControlNode);_d.destroyWidgetsIn(this.toolBarNode);_d.destroyWidgetsIn(this.pagingBarNode);if(this.itemNode){_d.destroyWidgetsIn(this.itemNode);}if(this._dataSource){this._dataSource.destroy();}_1d.forEach(this._searchElements,function(_b2){_b2.destroy();});}});return _20;});