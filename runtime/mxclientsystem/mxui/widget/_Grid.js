/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/_Grid",["require","mxui/mixin/_Contextable","mxui/mixin/_Scriptable","mxui/mixin/_Stateful","mxui/mixin/_Pluggable","mxui/lib/overflowHelper","mxui/mixin/_ContainingSelection","mxui/mixin/_Templated","mxui/lib/MxGridConfig","mxui/widget/SearchInput","mxui/widget/Button","mxui/widget","mxui/dom","mendix/lib/MxContext","mendix/lib/EntityPathSource","mendix/lib/MicroflowSource","mendix/lib/ValidationError","mendix/lib/XPathSource","mendix/logger","dojo/fx","dojo/sniff","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/_base/array","dojo/_base/lang","dojo/_base/event","dojo/fx/Toggler"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b){var _1c=_c.declare("mxui.widget._Grid",{mixins:[_8,_2,_3,_4,_5,_7],baseClass:"mx-grid",css:_c.createCSSMap("mx-grid",{pagingStatus:"paging-status",searchButton:"search-button",resetButton:"reset-button"}),entity:"",schema:"",reference:"",useContext:false,reqConstraints:"",xpathConstraint:"",customDataSource:null,_previousSearchConstraints:"",pagingBarNode:null,searchNode:null,toolBarNode:null,messageNode:null,searchButton:null,resetButton:null,_dataSource:null,_gridConfig:null,_gridState:null,_metaEntity:null,_toolWidgets:null,_pagingStatusNode:null,fetchMetaObject:function(){this._metaEntity=window.mx.meta.getEntity(this.entity);if(this._metaEntity==null){_13.error(this.id+": This grid has been configured for an entity the current user doesn't have access to.");return false;}return true;},setupGridConfig:function(){this._gridConfig=new _9({config:this.config,nested:this.nested});},setupGridState:function(){var _1d=this._gridConfig,_1e=this._gridState;_1e.updateperiod=_1d.gridSetting("refresh");_1e.searchbar=_1d.gridSetting("searchbar");_1e.controlbar=_1d.gridSetting("controlbar");_1e.pagingbar=_1d.gridSetting("pagingbar");_1e.selectionmode=_1d.gridSetting("selectionmode");_1e.editable=_1d.gridSetting("editable");_1e.showemptyrows=_1d.gridSetting("showemptyrows");_1e.selectfirst=_1d.gridSetting("selectfirst");_1e.selectable=(_1e.selectionmode!=="none");if(this.selectable){_1e.selectable=/^(single|multi)$/.test(this.selectable);if(this.selectable!=="multi"||_1e.selectionmode!=="simplemulti"){_1e.selectionmode=this.selectable;}}},setupDataSource:function(){var _1f=this._gridConfig,_20=_1f.getDataSource(),_21=this.getState("pageOffset",0),_22=_1f.gridSetting("pageSize"),_23;if(this.customDataSource){_23=this.customDataSource;_23.setPageSize(_22);_23.setOffset(_21);var _24=this.getState("sortOptions",_1f.gridSetting("sortparams"));if(_24){_23.setSortOptions(_24[0][0],_24[0][1]);}}else{if(_20){var _25={queryid:this instanceof _1("mxui/widget/DataGrid")?this.schema:"",context:this.mxcontext,page:_22,offset:_21};if(_20.microflow){_23=new _10(_1a.mixin({microflow:_20.microflow.name},_25));}else{if(_20.entityPath){_23=new _f(_1a.mixin({path:_20.entityPath.path},_25));}else{_23=new _12(_1a.mixin({entity:this.entity,constraint:this.constraint,useContext:this.useContext,sortparams:this.getState("sortOptions",_1f.gridSetting("sortparams")),aggregates:"Calculations" in this._gridConfig.getPlugins()},_25));}}}}this._dataSource=_23;},resizeGrid:function(){this.contentNode.scrollTop=0;},setUpdateInterval:function(){var _26=this._gridState.updateperiod;if(_26&&_26.toString()!="0"){this.clearInterval();this._gridState.update=setInterval(_1a.hitch(this,"reload"),parseInt(_26*1000,10));}},clearInterval:function(){if(this._gridState.update!=null){clearInterval(this._gridState.update);}},actionSelectPage:function(_27){if(!this._gridState.invertedSelection){for(var i=0,_28=this._dataSource.getObjects(),_29;_29=_28[i];i++){this._addToSelection(_29.getGuid());}}this.refreshGrid();},actionSelectAllPages:function(_2a){this.selection=[];this._gridState.invertedSelection=true;this.refreshGrid();},actionClearSelection:function(_2b){if(this._hasSelection()||this._gridState.invertedSelection){this.selection=[];this._gridState.invertedSelection=false;this.refreshGrid();}},actionEditSelection:function(_2c){if(!this._hasSelection()&&!this._gridState.invertedSelection){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{for(var i=0,obj;obj=this.selection[i];i++){var _2d=this._dataSource.getObject(obj),_2e=_2c[_2d.getEntity()];if(_2e){var _2f=this.createContext();_2f.dupFrom(this.mxcontext);_2f.setObject(null,_2d.getEntity(),_2d.getGuid());window.mx.ui.execute(_2e,{context:_2f});}}}},actionInsertNew:function(_30){var _31=this._getEntity(_30),_32=_30[_31];if(_32&&_31){window.mx.data.create({entity:_31,context:this.useContext?this.mxcontext:null,persistent:_32.persistent,callback:function(obj){if(!this.useContext){var _33=this._gridConfig.getDataSource(),_34=_33.entityPath&&_33.entityPath.path||this.reference,_35=_34.split("/"),_36=this.mxcontext.getTrackId();if(_35.length==2&&_36){var _37=_35[1];if(obj.isReference(_37)){obj.set(_37,_36);}}}var _38=this.createContext();_38.setContext(obj);window.mx.ui.execute(_32,{context:_38});},error:function(e){window.mx.onError(e);}},this);}},selectRow:function(row){if(this._gridState.invertedSelection){_16.remove(row,"selected");}else{_16.add(row,"selected");}},deselectRow:function(row){if(!this._gridState.invertedSelection){_16.remove(row,"selected");}else{_16.add(row,"selected");}},postCreate:function(){var req=this.reqConstraints,ref=this.reference;this.reqConstraints=req?req.split(","):[];if(ref){this.reqConstraints.push(ref.substr(0,ref.indexOf("/")));}var box=this.addFocusBox(this.controlNode);box.pressed({RIGHT_ARROW:box.FOCUS_NEXT,LEFT_ARROW:box.FOCUS_PREV});this.offerInterfaces(["close"]);this.initContext();this._previousSearchConstraints=this.getState("searchConstraints","");if(this.fetchMetaObject()){this.setupGridConfig();this.setupGridState();this.buildSearchBar();this.buildControlBar();this.buildToolBar();this.buildPagingBar();this.setupDataSource();}},getSchemaId:function(){return this.schema;},deselectAll:function(){this.selection=[];this.deselectGridRows();},registerSubscriptions:function(){this.removeSubscriptions();var _39=this.mxcontext.getTrackId();if(_39){this.subscribe({guid:this.mxcontext.getTrackId(),callback:_1a.hitch(this,"objectUpdate")});}this.subscribe({entity:this.entity,callback:_1a.hitch(this,"objectUpdate")});},eventItemClicked:function(e,_3a){if(!this._gridState.selectable){return;}var _3b=this._gridState.selectionmode,_3c=this.domData(_3a,"mendixguid"),_3d=_19.indexOf(this.selection,_3c),_3e=_3b!="singleandmaintain"||this.selection.length>1;if(_3c){var obj=this._dataSource.getObject(_3c);if(_3b=="simplemulti"||_3b=="multi"&&(_15("mac")&&e.metaKey||e.ctrlKey)){if(_3d==-1){this.selectRow(_3a);this._addToSelection(obj.getGuid());}else{if(_3e){this.deselectRow(_3a);this._removeFromSelection(obj.getGuid());}}}else{if(_3d==-1){this.deselectAll();this.selectRow(_3a);this._addToSelection(obj.getGuid());}else{if(_3e){this.deselectRow(_3a);this._removeFromSelection(obj.getGuid());}}}this._shareSelection(this._metaEntity.getEntity());}},eventActionBindingHandler:function(_3f,_40){var _41=this._gridConfig.gridActionBindings(),_42=this._gridConfig.getActionsByKey(_41["on"+_40]),_43=_42?this["action"+_42.actionCall]:null,_44=this._getObjectFromNode(_3f);if(this._gridState.invertedSelection){return;}if(_42&&_43&&_3f&&_44){if(this._gridState.selectable){this.deselectAll();_d.clearSelection();this.selectRow(_3f);}this._addToSelection(_44.getGuid());if(_43){_43.call(this,_42.params);}if(!this._gridState.selectable){this.deselectAll();}}else{}},eventControlBarButtonClicked:function(e){var _45=e.currentTarget,_46=_45.getAttribute("data-mendix-id");if(_46){var _47=this._gridConfig.getActionsByKey(_46);if(_47){if(_47.actionCall==="ActionSelected"){_47.actionCall="EditSelection";}else{if(_47.actionCall==="Create"){_47.actionCall="InsertNew";}}var _48="action"+_47.actionCall;if(this[_48]){this[_48](_47.params);}else{_13.error(this.id+".eventControlBarButtonClicked: Called function '"+_48+"' does not exist in this component");}}else{_13.error(this.id+".eventControlBarButtonClicked: Action with action key '"+_46+"' is not defined");}}else{_13.error(this.id+".eventControlBarButtonClicked: No action key defined!");}},actionInvokeAction:function(_49){this.triggerPluginEvent("invokeAction",null,_1a.hitch(this,"invokeAction",_49));},_getPlainSelection:function(){if(!this._gridState.invertedSelection){return this.selection;}var _4a=this,_4b=[];this._dataSource.each(function(obj){var _4c=obj.getGuid();if(_19.indexOf(_4a.selection,_4c)===-1){_4b.push(_4c);}});return _4b;},_getXpathSelection:function(){var _4d,_4e,_4f,_50=this._gridState.invertedSelection;if(_50){_4f=this._dataSource.getSetSize()-this.selection.length;_4d=this._dataSource.getCurrentXPath();}else{_4f=this.selection.length;_4d="//"+this.entity;}if(_4f===0){return null;}var _51=[];_19.forEach(this.selection,function(id){_51.push("id"+(_50?"!=":"=")+"\""+id+"\"");});if(_51.length===0){_4e="";}else{_4e="["+_51.join(_50?" and ":" or ")+"]";}return {xpath:_4d,constraints:_4e,sort:this._dataSource.getSortSettings()};},_getMicroflowParameters:function(_52){var _53={gridid:this.schema};if(!_52){_53.applyto="none";}else{if(_52=="selection"){if(this._dataSource instanceof _12){var _54=this._getXpathSelection();if(!_54){return null;}_53.applyto="selectionset";_1a.mixin(_53,_54);}else{var _55=this._getPlainSelection();if(_55.length===0){return null;}_53.applyto="selection";_53.guids=_55;}}else{if(_52=="allPages"){if(this._dataSource instanceof _12){if(this._dataSource.getSetSize()===0){_53.applyto="none";}_1a.mixin(_53,{xpath:this._dataSource.getCurrentXPath(),sort:this._dataSource.getSortSettings(),applyto:"set"});}else{var _56=_19.map(this._dataSource.getObjects(),function(obj){return obj.getGuid();});_53.applyto="selection";_53.guids=_56;}}}}return _53;},invokeAction:function(_57){var _58=_57[this.entity],_59=_58.action,_5a=this,_5b=[];if(!_59){return;}if(this.actDeferSyncAction){_5b.push("actDeferSyncAction");}if(_59.microflow&&_59.microflow.confirmation){var _5c=_59.microflow.confirmation;_5b.push(function(_5d){window.mx.ui.confirmation({cancel:_5c.cancel,proceed:_5c.proceed,content:_5c.question,handler:_5d});});}if(_59.form||(_59.microflow&&_59.microflow.validate==="view")){_5b.push(_1a.hitch(this.mxform,"validate"));}function _5e(){if(!(_5a._destroyed||_58.maintainSelection||_5a._gridState.selectionmode=="singleandmaintain")){_5a.deselectAll();_5a._shareSelection(_5a._metaEntity.getEntity());}};if(_59.microflow){var _5f=this._getMicroflowParameters(_59.microflow.applyTo);if(!_5f){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));return;}_5b.push(function(){window.mx.ui.execute(_59,{params:_5f,context:_5a.mxcontext,store:{caller:_5a},callback:_5e});});}else{var _60=new _e();if(_59.form.passContext){var _61=this._getPlainSelection();if(!_61.length){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));return;}_60.setTrackId(_61[0]);_60.setTrackEntity(this.entity);}_5b.push(function(){window.mx.ui.execute(_59,{context:_60});_5e();});}this.sequence(_5b);},actionReturnSelection:function(_62){var _63=this.mxform;_63.validate(function(){var _64=function(e){if(!(e instanceof _11)){window.mx.onError(e);}};_63.save(function(){_63.commit(function(){_63.dispose();},_64);},_64);});},controlNode:null,_setToolbarAttr:function(_65){for(var i=0,btn;btn=this._toolWidgets[i++];){btn.set("disabled",_65);}},buildControlBar:function(){if(!this._gridState.controlbar&&!this._gridState.pagingbar){this.controlNode.style.display="none";}},buildToolBar:function(){this._toolWidgets=[];if(!this._gridState.controlbar){this.toolBarNode.style.display="none";return;}var _66=this._gridConfig.gridTools(),box=this.getFocusBox(this.controlNode),_67=document.createDocumentFragment();for(var i in _66){var _68=_66[i];var _69={"mxid":_68.mxid,"caption":_68.caption,"title":_68.title,"onClick":_1a.hitch(this,"eventControlBarButtonClicked"),"cssClasses":"mx-name-"+_68.name+(_68.cssClass?(" "+_68.cssClass):""),"cssStyle":_68.cssStyle};if(_68.iconClass){_69.iconClass=_68.iconClass;}else{if(_68.iconUrl){_69.iconUrl=_68.iconUrl;}}var _6a=new _b(_69),_6b=_6a.domNode;this._toolWidgets.push(_6a);try{if(_66[i].gridFunction){_6b.setAttribute("gridFunction",_66[i].gridFunction);_6b.setAttribute("param",_66[i].param);if(_66[i].background){_6b.setAttribute("background-job",_66[i].background);}if(_66[i].progress){_6b.setAttribute("progress",_66[i].progress);}if(_66[i].message){_6b.setAttribute("message",_66[i].message);}}if(i>0){_66[i-1]._nextNode=_6b;}_66[i]._domNode=_6b;_67.appendChild(_6b);_67.appendChild(document.createTextNode(" "));box.add(_6b);_6a.startup();}catch(e){}}this.toolBarNode.appendChild(_67);_d.disableSelection(this.toolBarNode);},buildPagingBar:function(){if(!this._gridState.pagingbar){this.pagingBarNode.style.display="none";return;}var ltr=this.isLeftToRight(),_6c=document.createDocumentFragment(),box=this.getFocusBox(this.controlNode),$=_d.create;this.btFirst=new _b({iconClass:ltr?"glyphicon-step-backward":"glyphicon-step-forward","onClick":_1a.hitch(this,"eventPagingFirstClicked"),"class":"mx-name-paging-first"});_6c.appendChild($("#",this.btFirst.domNode," "));box.add(this.btFirst.domNode);this.btPrevious=new _b({iconClass:ltr?"glyphicon-backward":"glyphicon-forward","onClick":_1a.hitch(this,"eventPagingPreviousClicked"),"class":"mx-name-paging-previous"});_6c.appendChild($("#",this.btPrevious.domNode," "));box.add(this.btPrevious.domNode);this._pagingStatusNode=$("div",{"class":"dijitInline "+this.css.pagingStatus});_6c.appendChild($("#",this._pagingStatusNode," "));this.btNext=new _b({iconClass:ltr?"glyphicon-forward":"glyphicon-backward","onClick":_1a.hitch(this,"eventPagingNextClicked"),"class":"mx-name-paging-next"});_6c.appendChild($("#",this.btNext.domNode," "));box.add(this.btNext.domNode);this.btLast=new _b({iconClass:ltr?"glyphicon-step-forward":"glyphicon-step-backward","onClick":_1a.hitch(this,"eventPagingLastClicked"),"class":"mx-name-paging-last"});_6c.appendChild($("#",this.btLast.domNode," "));box.add(this.btLast.domNode);this.pagingBarNode.appendChild(_6c);_d.disableSelection(this.pagingBarNode);},updatePagingStatus:function(_6d){if(!this._gridState.pagingbar){return;}var _6e=this._dataSource.getStatusMessage();_d.text(this._pagingStatusNode,_6e);if(this._dataSource.atBeginning()){this.btFirst.set("disabled",true);this.btPrevious.set("disabled",true);}else{this.btFirst.set("disabled",false);this.btPrevious.set("disabled",false);}if(this._dataSource.atEnd()){this.btNext.set("disabled",true);this.btLast.set("disabled",true);}else{this.btNext.set("disabled",false);this.btLast.set("disabled",false);}},eventPagingFirstClicked:function(){if(!this._dataSource.atBeginning()){this._dataSource.first(_1a.hitch(this,"refreshGrid"));}},eventPagingPreviousClicked:function(){if(!this._dataSource.atBeginning()){this._dataSource.previous(_1a.hitch(this,"refreshGrid"));}},eventPagingNextClicked:function(){if(!this._dataSource.atEnd()){this._dataSource.next(_1a.hitch(this,"refreshGrid"));}},eventPagingLastClicked:function(){if(!this._dataSource.atEnd()){this._dataSource.last(_1a.hitch(this,"refreshGrid"));}},_searchElements:null,_searchFilled:false,searchArgumentNode:null,searchControlNode:null,_searchGetConstraints:function(){var _6f="";var _70=[];_19.forEach(this._searchElements,function(_71){var _72=_71.get("query");if(_72!==""){_70.push(_72);}});if(_70.length){_6f="["+_70.join(" and ")+"]";}return _6f+this._gridState.xpathConstraint;},buildSearchBlock:function(){var $=_d.create;if(this._gridState.isSearchBuild){return;}this._gridState.isSearchBuild=true;var _73=this.searchButton=new _b({"caption":window.mx.ui.translate("mxui.widget.DataGrid",["search"]),"onClick":_1a.hitch(this,"eventSearchActivated"),"class":"mx-name-search "+this.css.searchButton});this.searchControlNode.appendChild($("#",_73.domNode," "));var _74=this.resetButton=new _b({"caption":window.mx.ui.translate("mxui.widget.DataGrid",["reset"]),"onClick":_1a.hitch(this,"eventSearchResetClicked"),"class":"mx-name-reset "+this.css.resetButton});this.searchControlNode.appendChild($("#",_74.domNode," "));var _75=document.createDocumentFragment();this._searchElements=_19.map(this._gridConfig.searchBarItems(),_1a.hitch(this,function(_76){var _77=new _a(_1a.mixin({entity:this.entity,mxcontext:this.mxcontext},_76));var _78=this.getState("searchInput",{});_77.set("value",_78[_76.path]||_77.get("value"));this.connect(_77,"onKeyUp","eventSearchActivated");_75.appendChild(_77.domNode);_77.startup();return _77;}));this.searchArgumentNode.appendChild(_75);},buildSearchBar:function(){if(!this._gridState.searchbar){this.searchNode.style.display="none";this._searchFilled=true;return;}var _79=this._gridConfig.searchBarConfig();if(_79){this._gridState.searchBarVisible=this.getState("searchBarVisible",!_79.toggledByDefault);this._gridState.searchBarTogglable=!!_79.toggleable;}else{this._gridState.searchBarVisible=true;}if(!this._gridState.searchBarVisible){var _7a=false;var _7b=this._gridConfig.searchBarItems();for(var i in _7b){var _7c=_7b[i];if(_7c.defaults){this.buildSearchBlock();_7a=true;break;}}this.searchNode.style.display="none";this._gridState.isSearchBuild=_7a;}else{this.buildSearchBlock();this.searchNode.style.display="";}this.checkSearchFields();},eventSearchActivated:function(e){_1b.stop(e);if(!(e.type==="click"||(e.keyCode===13&&!e.shiftKey))){return;}var _7d=this,_7e=this.searchButton;this.checkSearchFields();if(!this.constraintsFilled()){return;}_7e.set("disabled",true);this._dataSource.isValid(function(_7f){if(_7f){_7d._dataSource.setConstraints(_7d._searchGetConstraints(),function(){_7d.selection=[];_7d.refreshGrid();if(_7d.triggerOnSearchChanged){_7d.triggerOnSearchChanged();}_7e.set("disabled",false);});}else{_7e.set("disabled",false);}});},eventSearchResetClicked:function(){var _80=this._dataSource;_19.forEach(this._searchElements,function(_81){_81.reset();});this.checkSearchFields();_80.setConstraints(this._searchGetConstraints());var _82=_1a.hitch(this,function(){this.refreshGrid();if(this.triggerOnSearchChanged){this.triggerOnSearchChanged();}});if(this.constraintsFilled()){_80.isValid(function(_83){if(_83){_80.refresh(_82);}else{_80.clean(_82);}});}},checkSearchFields:function(){var _84=this._gridConfig.gridSetting("waitforsearch");if(!_84){this._searchFilled=true;return;}this._searchFilled=_19.some(this._searchElements,_1a.hitch(this,function(_85){if(_85.get("query")!==""){this.messageNode.innerHTML="";this.messageNode.style.display="none";return true;}}));if(!this._searchFilled){this.messageNode.innerHTML=window.mx.ui.translate("mxui.widget.DataGrid","waitForSearch");this.messageNode.style.display="block";}},constraintsFilled:function(){if(!this._searchFilled){return false;}for(var i=0,_86;_86=this.reqConstraints[i];i++){if(!this.mxcontext.getContext(_86)){return false;}}return true;},reload:function(_87){if(this.constraintsFilled()){var _88=this;this._dataSource.isValid(function(_89){if(_89){_88._dataSource.refresh(function(){_88.refreshGrid();if(_87){_87();}});}});}},actionToggleSearch:function(_8a){var _8b=this;if(!this._gridState.searchBarTogglable){return;}this.buildSearchBlock();this._gridState.searchBarVisible=!this._gridState.searchBarVisible;if(!this._gridState.searchBarVisible){this._searchWipeOut=this._searchWipeOut||_14.wipeOut({node:this.searchNode,duration:200,onEnd:function(){setTimeout(function(){_8b.resize(_8b._resizeBox);},0);_19.forEach(_8b._searchElements,function(_8c){_8c.cleanup();});}});this._searchWipeOut.play();}else{this._searchWipeIn=this._searchWipeIn||_14.wipeIn({node:this.searchNode,duration:200,onEnd:function(){setTimeout(function(){_6.showOverflow(_8b.domNode);_8b.resize(_8b._resizeBox);},0);try{_19.some(_8b._searchElements,function(_8d){if(!_8d.get("hidden")){_8d.focus();return true;}});}catch(e){}}});_6.hideOverflow(this.domNode);this._searchWipeIn.play();}},applyContext:function(_8e,_8f){if(this._metaEntity==null){if(_8f){_8f();}return;}if(!this._dataSource){_13.error(this.id+".applyContext: Applying context before rendered!!!");if(_8f){_8f();}return;}this.selection=[];this.cloneContext(_8e);this.setUpdateInterval();this._gridState.xpathConstraint=this.xpathConstraint;var _90=this.mxcontext.getParam("xpathConstraint");if(_90){this._gridState.xpathConstraint+=_90;}this.removeSubscriptions();this.registerSubscriptions();if(this.reference){var _91=this.reference.split(/\//),_92=_91[0],_93=_91[1];var id=this.mxcontext.getContext(_92);if(id){var _94="["+_93+"=\""+id+"\"]";this._gridState.xpathConstraint+=_94;}else{}}if(!this._gridState.inDenial){var _95=[];if(this.constraintsFilled()){var _96=[];var _97=function(_98){return function(_99){_98.reinit(_99);};};_19.forEach(this._searchElements,function(_9a){_96.push(_97(_9a));});_95.push(function(_9b){this.collect(_96,_9b);});_95.push(function(_9c){if(this._dataSource.setConstraints){var _9d=this._previousSearchConstraints?this._previousSearchConstraints:this._searchGetConstraints();this._previousSearchConstraints="";this._dataSource.setConstraints(_9d);}this._dataSource.setOffset(this.getState("pageOffset",0));this._dataSource.reload(_9c);});}else{_95.push("actCleanDS");}this.sequence(_95,function(){this.selection=this.getState("selectedGuids",this.selection);this.filterSelected();this.refreshGrid();_8f();});}else{if(_8f){_8f();}}},filterSelected:function(){this.selection=_19.filter(this.selection,function(_9e){return this._dataSource.getObject(_9e)!=null;},this);},objectUpdateNotification:function(){var _9f=this;if(!this._gridState.inDenial&&this.constraintsFilled()){this._dataSource.isValid(function(_a0){if(_a0){_9f.sequence([_1a.hitch(_9f._dataSource,"entityUpdate"),function(_a1){this.filterSelected();this.refreshGrid();if(_a1){_a1();}}]);}});}},refreshGrid:function(){if(this._dataSource.afterEnd()){this._dataSource.first(_1a.hitch(this,"refreshGrid"));return;}this.updatePagingStatus();this.fillGrid();this.resizeGrid();},actCleanDS:function(_a2){this.selection=[];this._dataSource.clean(_a2);},actionDeleteSelection:function(_a3){if(this._gridState.invertedSelection){}else{if(!this._hasSelection()){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{var _a4=this;var _a5=function(){var _a6=_a4.selection;_a4.deselectAll();_a4._shareSelection(_a4._metaEntity.getEntity());window.mx.data.remove({guids:_a6,callback:function(){window.mx.data.sendClassUpdate(_a4.entity);},error:function(e){window.mx.onError(e);}});};if(_a3===true){_a5();}else{window.mx.ui.confirmation({content:window.mx.ui.translate("mxui.widget.DataGrid","confirm_delete",this.selection.length),handler:_a5});}}}},resize:function(box){var _a7=false;if(box){var _a8=_18.getMarginBox(this.domNode),_a9=_18.getMarginBox(this.contentNode),_aa=box.h-(_a8.h-_a9.h);if(_aa>_d.minContainerHeight){_17.set(this.contentNode,"height",_aa+"px");_a7=true;if(this.headTable){_17.set(this.headTable,"top","0px");}}}if(!_a7){_17.set(this.contentNode,"height","auto");}this._resizeBox=box;},close:function(){this.disposeContent();},onHide:function(e){_19.forEach(this._searchElements,function(_ab){_ab.cleanup();});},storeState:function(_ac){_ac("searchBarVisible",this._gridState.searchBarVisible);_ac("searchConstraints",this._dataSource.getConstraints&&this._dataSource.getConstraints());_ac("pageOffset",this._dataSource.getOffset());_ac("selectedGuids",this.selection);if(this._dataSource.getSortSettings){_ac("sortOptions",this._dataSource.getSortSettings());}var _ad={};_19.forEach(this._searchElements,function(_ae){_ad[_ae.path]=_ae.get("value");});_ac("searchInput",_ad);},uninitialize:function(){this.clearInterval();this.removeSubscriptions();this._clearSelectionStore();_c.destroyChildren(this.searchControlNode);_c.destroyChildren(this.toolBarNode);_c.destroyChildren(this.pagingBarNode);if(this.itemNode){_c.destroyChildren(this.itemNode);}if(this._dataSource){this._dataSource.destroy();}_19.forEach(this._searchElements,function(_af){_af.destroy();});}});return _1c;});