/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/_Grid",["require","mxui/mixin/_Contextable","mxui/mixin/_Scriptable","mxui/mixin/_Stateful","mxui/mixin/_Pluggable","mxui/lib/overflowHelper","mxui/mixin/_ContainingSelection","mxui/mixin/_Templated","mxui/lib/MxGridConfig","mxui/widget/SearchInput","mxui/widget/Button","mxui/widget/_DynamicButton","mxui/widget","mxui/dom","mendix/lib/MxContext","mendix/lib/EntityPathSource","mendix/lib/MicroflowSource","mendix/lib/ValidationError","mendix/lib/XPathSource","mendix/logger","dojo/fx","dojo/sniff","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/_base/array","dojo/_base/lang","dojo/_base/event","dojo/fx/Toggler"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c){var _1d=_d.declare("mxui.widget._Grid",{mixins:[_8,_2,_3,_4,_5,_7],baseClass:"mx-grid",css:_d.createCSSMap("mx-grid",{pagingStatus:"paging-status",searchButton:"search-button",resetButton:"reset-button"}),entity:"",schema:"",reference:"",useContext:false,reqConstraints:"",xpathConstraint:"",customDataSource:null,_previousSearchConstraints:"",pagingBarNode:null,searchNode:null,toolBarNode:null,messageNode:null,searchButton:null,resetButton:null,_dataSource:null,_gridConfig:null,_gridState:null,_metaEntity:null,_toolWidgets:null,_pagingStatusNode:null,_preserveSelection:false,constructor:function(_1e){this._preserveSelection="selection" in _1e;},fetchMetaObject:function(){this._metaEntity=window.mx.meta.getEntity(this.entity);if(this._metaEntity==null){_14.error(this.id+": This grid has been configured for an entity the current user doesn't have access to.");return false;}return true;},setupGridConfig:function(){this._gridConfig=new _9({config:this.config,nested:this.nested});},setupGridState:function(){var _1f=this._gridConfig,_20=this._gridState;_20.updateperiod=_1f.gridSetting("refresh");_20.searchbar=_1f.gridSetting("searchbar");_20.controlbar=_1f.gridSetting("controlbar");_20.pagingbar=_1f.gridSetting("pagingbar");_20.selectionmode=_1f.gridSetting("selectionmode");_20.selectable=(_20.selectionmode!=="none");_20.editable=_1f.gridSetting("editable");_20.showemptyrows=_1f.gridSetting("showemptyrows");_20.selectfirst=_1f.gridSetting("selectfirst");},setupDataSource:function(){var _21=this._gridConfig,_22=_21.getDataSource(),_23=this.getState("pageOffset",0),_24=_21.gridSetting("pageSize"),_25;if(this.customDataSource){_25=this.customDataSource;_25.setPageSize(_24);_25.setOffset(_23);var _26=this.getState("sortOptions",_21.gridSetting("sortparams"));if(_26){_25.setSortOptions(_26[0][0],_26[0][1]);}}else{if(_22){var _27={queryid:this instanceof _1("mxui/widget/DataGrid")?this.schema:"",context:this.mxcontext,page:_24,offset:_23};if(_22.microflow){_25=new _11(_1b.mixin({microflow:_22.microflow.name},_27));}else{if(_22.entityPath){_25=new _10(_1b.mixin({path:_22.entityPath.path},_27));}else{_25=new _13(_1b.mixin({entity:this.entity,constraint:this.constraint,useContext:this.useContext,sortparams:this.getState("sortOptions",_21.gridSetting("sortparams")),aggregates:"Calculations" in this._gridConfig.getPlugins()},_27));}}}}this._dataSource=_25;},resizeGrid:function(){this.contentNode.scrollTop=0;},setUpdateInterval:function(){var _28=this._gridState.updateperiod;if(_28&&_28.toString()!="0"){this.clearInterval();this._gridState.update=setInterval(_1b.hitch(this,"reload"),parseInt(_28*1000,10));}},clearInterval:function(){if(this._gridState.update!=null){clearInterval(this._gridState.update);}},actionSelectPage:function(_29){if(!this._gridState.invertedSelection){for(var i=0,_2a=this._dataSource.getObjects(),_2b;_2b=_2a[i];i++){this._addToSelection(_2b.getGuid());}}this.refreshGrid();},actionSelectAllPages:function(_2c){this.selection=[];this._gridState.invertedSelection=true;this.refreshGrid();},actionClearSelection:function(_2d){if(this._hasSelection()||this._gridState.invertedSelection){this.selection=[];this._gridState.invertedSelection=false;this.refreshGrid();}},actionEditSelection:function(_2e){if(!this._hasSelection()&&!this._gridState.invertedSelection){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{for(var i=0,obj;obj=this.selection[i];i++){var _2f=this._dataSource.getObject(obj),_30=_2e[_2f.getEntity()];if(_30){var _31=this.createContext();_31.dupFrom(this.mxcontext);_31.setObject(null,_2f.getEntity(),_2f.getGuid());window.mx.ui.execute(_30,{context:_31});}}}},actionInsertNew:function(_32){var _33=this._getEntity(_32),_34=_32[_33];if(_34&&_33){window.mx.data.create({entity:_33,context:this.useContext?this.mxcontext:null,persistent:_34.persistent,callback:function(obj){if(!this.useContext){var _35=this._gridConfig.getDataSource(),_36=_35.entityPath&&_35.entityPath.path||this.reference,_37=_36.split("/"),_38=this.mxcontext.getTrackId();if(_37.length==2&&_38){var _39=_37[1];if(obj.isReference(_39)){obj.set(_39,_38);}}}var _3a=this.createContext();_3a.setContext(obj);window.mx.ui.execute(_34,{context:_3a});},error:function(e){window.mx.onError(e);}},this);}},selectRow:function(row){if(this._gridState.invertedSelection){_17.remove(row,"selected");}else{_17.add(row,"selected");}},deselectRow:function(row){if(!this._gridState.invertedSelection){_17.remove(row,"selected");}else{_17.add(row,"selected");}},postCreate:function(){var req=this.reqConstraints,ref=this.reference;this.reqConstraints=req?req.split(","):[];if(ref){this.reqConstraints.push(ref.substr(0,ref.indexOf("/")));}var box=this.addFocusBox(this.controlNode);box.pressed({RIGHT_ARROW:box.FOCUS_NEXT,LEFT_ARROW:box.FOCUS_PREV});this.offerInterfaces(["close"]);this.initContext();this._previousSearchConstraints=this.getState("searchConstraints","");if(this.fetchMetaObject()){this.setupGridConfig();this.setupGridState();this.buildSearchBar();this.buildControlBar();this.buildToolBar();this.buildPagingBar();this.setupDataSource();}},getSchemaId:function(){return this.schema;},deselectAll:function(){this.selection=[];this.deselectGridRows();},registerSubscriptions:function(){this.removeSubscriptions();var _3b=this.mxcontext.getTrackId();if(_3b){this.subscribe({guid:this.mxcontext.getTrackId(),callback:_1b.hitch(this,"objectUpdate")});}this.subscribe({entity:this.entity,callback:_1b.hitch(this,"objectUpdate")});},eventItemClicked:function(e,_3c){if(!this._gridState.selectable){return;}var _3d=this._gridState.selectionmode,_3e=this.domData(_3c,"mendixguid"),_3f=_1a.indexOf(this.selection,_3e),_40=_3d!="singleandmaintain"||this.selection.length>1;if(_3e){var obj=this._dataSource.getObject(_3e);if(_3d=="simplemulti"||_3d=="multi"&&(_16("mac")&&e.metaKey||e.ctrlKey)){if(_3f==-1){this.selectRow(_3c);this._addToSelection(obj.getGuid());}else{if(_40){this.deselectRow(_3c);this._removeFromSelection(obj.getGuid());}}}else{if(_3f==-1){this.deselectAll();this.selectRow(_3c);this._addToSelection(obj.getGuid());}else{if(_40){this.deselectRow(_3c);this._removeFromSelection(obj.getGuid());}}}this._shareSelection(this._metaEntity.getEntity());}},eventActionBindingHandler:function(_41,_42){var _43=this._gridConfig.gridActionBindings(),_44=this._gridConfig.getActionsByKey(_43["on"+_42]),_45=_44?this["action"+_44.actionCall]:null,_46=this._getObjectFromNode(_41);if(this._gridState.invertedSelection){return;}if(_44&&_45&&_41&&_46){if(this._gridState.selectable){this.deselectAll();_e.clearSelection();this.selectRow(_41);}this._addToSelection(_46.getGuid());if(_45){_45.call(this,_44.params);}if(!this._gridState.selectable){this.deselectAll();}}else{}},eventControlBarButtonClicked:function(e){var _47=e.currentTarget,_48=_47.getAttribute("data-mendix-id");if(_48){var _49=this._gridConfig.getActionsByKey(_48);if(_49){if(_49.actionCall==="ActionSelected"){_49.actionCall="EditSelection";}else{if(_49.actionCall==="Create"){_49.actionCall="InsertNew";}}var _4a="action"+_49.actionCall;if(this[_4a]){this[_4a](_49.params);}else{_14.error(this.id+".eventControlBarButtonClicked: Called function '"+_4a+"' does not exist in this component");}}else{_14.error(this.id+".eventControlBarButtonClicked: Action with action key '"+_48+"' is not defined");}}else{_14.error(this.id+".eventControlBarButtonClicked: No action key defined!");}},actionInvokeAction:function(_4b){this.triggerPluginEvent("invokeAction",null,_1b.hitch(this,"invokeAction",_4b));},_getPlainSelection:function(){if(!this._gridState.invertedSelection){return this.selection;}var _4c=this,_4d=[];this._dataSource.each(function(obj){var _4e=obj.getGuid();if(_1a.indexOf(_4c.selection,_4e)===-1){_4d.push(_4e);}});return _4d;},_getXpathSelection:function(){var _4f,_50,_51,_52=this._gridState.invertedSelection;if(_52){_51=this._dataSource.getSetSize()-this.selection.length;_4f=this._dataSource.getCurrentXPath();}else{_51=this.selection.length;_4f="//"+this.entity;}if(_51===0){return null;}var _53=[];_1a.forEach(this.selection,function(id){_53.push("id"+(_52?"!=":"=")+"\""+id+"\"");});if(_53.length===0){_50="";}else{_50="["+_53.join(_52?" and ":" or ")+"]";}return {xpath:_4f,constraints:_50,sort:this._dataSource.getSortSettings()};},_getMicroflowParameters:function(_54){var _55={gridid:this.schema};if(!_54){_55.applyto="none";}else{if(_54=="selection"){if(this._dataSource instanceof _13){var _56=this._getXpathSelection();if(!_56){return null;}_55.applyto="selectionset";_1b.mixin(_55,_56);}else{var _57=this._getPlainSelection();if(_57.length===0){return null;}_55.applyto="selection";_55.guids=_57;}}else{if(_54=="allPages"){if(this._dataSource instanceof _13){if(this._dataSource.getSetSize()===0){_55.applyto="none";}_1b.mixin(_55,{xpath:this._dataSource.getCurrentXPath(),sort:this._dataSource.getSortSettings(),applyto:"set"});}else{var _58=_1a.map(this._dataSource.getObjects(),function(obj){return obj.getGuid();});_55.applyto="selection";_55.guids=_58;}}}}return _55;},invokeAction:function(_59){var _5a=_59[this.entity],_5b=_5a.action,_5c=this,_5d=[];if(!_5b){return;}if(this.actDeferSyncAction){_5d.push("actDeferSyncAction");}if(_5b.microflow&&_5b.microflow.confirmation){var _5e=_5b.microflow.confirmation;_5d.push(function(_5f){window.mx.ui.confirmation({cancel:_5e.cancel,proceed:_5e.proceed,content:_5e.question,handler:_5f});});}if(_5b.form||(_5b.microflow&&_5b.microflow.validate==="view")){_5d.push(_1b.hitch(this.mxform,"validate"));}_5d.push(function(_60){_5c.mxform.save(_60,function(err){if(!(err instanceof mendix.lib.ValidationError)){window.mx.onError(err);}});});function _61(){if(!(_5c._destroyed||_5a.maintainSelection||_5c._gridState.selectionmode=="singleandmaintain")){_5c.deselectAll();_5c._shareSelection(_5c._metaEntity.getEntity());}};if(_5b.microflow){var _62=this._getMicroflowParameters(_5b.microflow.applyTo);if(!_62){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));return;}_5d.push(function(){window.mx.ui.execute(_5b,{params:_62,context:_5c.mxcontext,store:{caller:_5c},callback:_61});});}else{var _63=new _f();if(_5b.form.passContext){var _64=this._getPlainSelection();if(!_64.length){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));return;}_63.setTrackId(_64[0]);_63.setTrackEntity(this.entity);}_5d.push(function(){window.mx.ui.execute(_5b,{context:_63});_61();});}this.sequence(_5d);},actionReturnSelection:function(_65){var _66=this.mxform;_66.validate(function(){var _67=function(e){if(!(e instanceof _12)){window.mx.onError(e);}};_66.save(function(){_66.commit(function(){_66.dispose();},_67);},_67);});},controlNode:null,_setToolbarAttr:function(_68){for(var i=0,btn;btn=this._toolWidgets[i++];){btn.set("disabled",_68);}},buildControlBar:function(){if(!this._gridState.controlbar&&!this._gridState.pagingbar){this.controlNode.style.display="none";}},buildToolBar:function(){this._toolWidgets=[];if(!this._gridState.controlbar){this.toolBarNode.style.display="none";return;}var _69=this._gridConfig.gridTools(),box=this.getFocusBox(this.controlNode),_6a=document.createDocumentFragment();for(var i in _69){var _6b=_69[i];var _6c={"mxid":_6b.mxid,"caption":_6b.caption,"title":_6b.title,"onClick":_1b.hitch(this,"eventControlBarButtonClicked"),"cssClasses":"mx-name-"+_6b.name+(_6b.cssClass?(" "+_6b.cssClass):""),"cssStyle":_6b.cssStyle};if(_6b.iconClass){_6c.iconClass=_6b.iconClass;}else{if(_6b.iconUrl){_6c.iconUrl=_6b.iconUrl;}}var _6d=new _c(_6c),_6e=_6d.domNode;_6d.applyContext(this.mxcontext);this._toolWidgets.push(_6d);try{if(_69[i].gridFunction){_6e.setAttribute("gridFunction",_69[i].gridFunction);_6e.setAttribute("param",_69[i].param);if(_69[i].background){_6e.setAttribute("background-job",_69[i].background);}if(_69[i].progress){_6e.setAttribute("progress",_69[i].progress);}if(_69[i].message){_6e.setAttribute("message",_69[i].message);}}if(i>0){_69[i-1]._nextNode=_6e;}_69[i]._domNode=_6e;_6a.appendChild(_6e);_6a.appendChild(document.createTextNode(" "));box.add(_6e);_6d.startup();}catch(e){}}this.toolBarNode.appendChild(_6a);_e.disableSelection(this.toolBarNode);},buildPagingBar:function(){if(!this._gridState.pagingbar){this.pagingBarNode.style.display="none";return;}var ltr=this.isLeftToRight(),_6f=document.createDocumentFragment(),box=this.getFocusBox(this.controlNode),$=_e.create;this.btFirst=new _b({iconClass:ltr?"glyphicon-step-backward":"glyphicon-step-forward","onClick":_1b.hitch(this,"eventPagingFirstClicked"),"class":"mx-name-paging-first"});_6f.appendChild($("#",this.btFirst.domNode," "));box.add(this.btFirst.domNode);this.btPrevious=new _b({iconClass:ltr?"glyphicon-backward":"glyphicon-forward","onClick":_1b.hitch(this,"eventPagingPreviousClicked"),"class":"mx-name-paging-previous"});_6f.appendChild($("#",this.btPrevious.domNode," "));box.add(this.btPrevious.domNode);this._pagingStatusNode=$("div",{"class":"dijitInline "+this.css.pagingStatus});_6f.appendChild($("#",this._pagingStatusNode," "));this.btNext=new _b({iconClass:ltr?"glyphicon-forward":"glyphicon-backward","onClick":_1b.hitch(this,"eventPagingNextClicked"),"class":"mx-name-paging-next"});_6f.appendChild($("#",this.btNext.domNode," "));box.add(this.btNext.domNode);this.btLast=new _b({iconClass:ltr?"glyphicon-step-forward":"glyphicon-step-backward","onClick":_1b.hitch(this,"eventPagingLastClicked"),"class":"mx-name-paging-last"});_6f.appendChild($("#",this.btLast.domNode," "));box.add(this.btLast.domNode);this.pagingBarNode.appendChild(_6f);_e.disableSelection(this.pagingBarNode);},updatePagingStatus:function(_70){if(!this._gridState.pagingbar){return;}var _71=this._dataSource.getStatusMessage();_e.text(this._pagingStatusNode,_71);if(this._dataSource.atBeginning()){this.btFirst.set("disabled",true);this.btPrevious.set("disabled",true);}else{this.btFirst.set("disabled",false);this.btPrevious.set("disabled",false);}if(this._dataSource.atEnd()){this.btNext.set("disabled",true);this.btLast.set("disabled",true);}else{this.btNext.set("disabled",false);this.btLast.set("disabled",false);}},eventPagingFirstClicked:function(){if(!this._dataSource.atBeginning()){this._dataSource.first(_1b.hitch(this,"refreshGrid"));}},eventPagingPreviousClicked:function(){if(!this._dataSource.atBeginning()){this._dataSource.previous(_1b.hitch(this,"refreshGrid"));}},eventPagingNextClicked:function(){if(!this._dataSource.atEnd()){this._dataSource.next(_1b.hitch(this,"refreshGrid"));}},eventPagingLastClicked:function(){if(!this._dataSource.atEnd()){this._dataSource.last(_1b.hitch(this,"refreshGrid"));}},_searchElements:null,_searchFilled:false,searchArgumentNode:null,searchControlNode:null,_searchGetConstraints:function(){var _72="";var _73=[];_1a.forEach(this._searchElements,function(_74){var _75=_74.get("query");if(_75!==""){_73.push(_75);}});if(_73.length){_72="["+_73.join(" and ")+"]";}return _72+this._gridState.xpathConstraint;},buildSearchBlock:function(){var $=_e.create;if(this._gridState.isSearchBuild){return;}this._gridState.isSearchBuild=true;var _76=this.searchButton=new _b({"caption":window.mx.ui.translate("mxui.widget.DataGrid",["search"]),"onClick":_1b.hitch(this,"eventSearchActivated"),"class":"btn-default mx-name-search "+this.css.searchButton});this.searchControlNode.appendChild($("#",_76.domNode," "));var _77=this.resetButton=new _b({"caption":window.mx.ui.translate("mxui.widget.DataGrid",["reset"]),"onClick":_1b.hitch(this,"eventSearchResetClicked"),"class":"btn-default mx-name-reset "+this.css.resetButton});this.searchControlNode.appendChild($("#",_77.domNode," "));var _78=document.createDocumentFragment();this._searchElements=_1a.map(this._gridConfig.searchBarItems(),_1b.hitch(this,function(_79){var _7a=new _a(_1b.mixin({entity:this.entity,mxcontext:this.mxcontext},_79));var _7b=this.getState("searchInput",{});_7a.set("value",_7b[_79.path]||_7a.get("value"));this.connect(_7a,"onKeyUp","eventSearchActivated");_78.appendChild(_7a.domNode);_7a.startup();return _7a;}));this.searchArgumentNode.appendChild(_78);},buildSearchBar:function(){if(!this._gridState.searchbar){this.searchNode.style.display="none";this._searchFilled=true;return;}var _7c=this._gridConfig.searchBarConfig();if(_7c){this._gridState.searchBarVisible=this.getState("searchBarVisible",!_7c.toggledByDefault);this._gridState.searchBarTogglable=!!_7c.toggleable;}else{this._gridState.searchBarVisible=true;}if(!this._gridState.searchBarVisible){var _7d=false;var _7e=this._gridConfig.searchBarItems();for(var i in _7e){var _7f=_7e[i];if(_7f.defaults){this.buildSearchBlock();_7d=true;break;}}this.searchNode.style.display="none";this._gridState.isSearchBuild=_7d;}else{this.buildSearchBlock();this.searchNode.style.display="";}this.checkSearchFields();},eventSearchActivated:function(e){_1c.stop(e);if(!(e.type==="click"||(e.keyCode===13&&!e.shiftKey))){return;}var _80=this,_81=this.searchButton;this.checkSearchFields();if(!this.constraintsFilled()){return;}_81.set("disabled",true);this._dataSource.isValid(function(_82){if(_82){_80._dataSource.setConstraints(_80._searchGetConstraints(),function(){if(!_80._preserveSelection){_80.selection=[];}_80.refreshGrid();if(_80.triggerOnSearchChanged){_80.triggerOnSearchChanged();}_81.set("disabled",false);});}else{_81.set("disabled",false);}});},eventSearchResetClicked:function(){var _83=this._dataSource;_1a.forEach(this._searchElements,function(_84){_84.reset();});this.checkSearchFields();_83.setConstraints(this._searchGetConstraints());var _85=_1b.hitch(this,function(){this.refreshGrid();if(this.triggerOnSearchChanged){this.triggerOnSearchChanged();}});if(this.constraintsFilled()){_83.isValid(function(_86){if(_86){_83.refresh(_85);}else{_83.clean(_85);}});}},checkSearchFields:function(){var _87=this._gridConfig.gridSetting("waitforsearch");if(!_87){this._searchFilled=true;return;}this._searchFilled=_1a.some(this._searchElements,_1b.hitch(this,function(_88){if(_88.get("query")!==""){this.messageNode.innerHTML="";this.messageNode.style.display="none";return true;}}));if(!this._searchFilled){this.messageNode.innerHTML=window.mx.ui.translate("mxui.widget.DataGrid","waitForSearch");this.messageNode.style.display="block";}},constraintsFilled:function(){if(!this._searchFilled){return false;}for(var i=0,_89;_89=this.reqConstraints[i];i++){if(!this.mxcontext.getContext(_89)){return false;}}return true;},reload:function(_8a){if(this.constraintsFilled()){var _8b=this;this._dataSource.isValid(function(_8c){if(_8c){_8b._dataSource.refresh(function(){_8b.refreshGrid();if(_8a){_8a();}});}});}},actionToggleSearch:function(_8d){var _8e=this;if(!this._gridState.searchBarTogglable){return;}this.buildSearchBlock();this._gridState.searchBarVisible=!this._gridState.searchBarVisible;if(!this._gridState.searchBarVisible){this._searchWipeOut=this._searchWipeOut||_15.wipeOut({node:this.searchNode,duration:200,onEnd:function(){setTimeout(function(){_8e.resize(_8e._resizeBox);},0);_1a.forEach(_8e._searchElements,function(_8f){_8f.cleanup();});}});this._searchWipeOut.play();}else{this._searchWipeIn=this._searchWipeIn||_15.wipeIn({node:this.searchNode,duration:200,onEnd:function(){setTimeout(function(){_6.showOverflow(_8e.domNode);_8e.resize(_8e._resizeBox);},0);try{_1a.some(_8e._searchElements,function(_90){if(!_90.get("hidden")){_90.focus();return true;}});}catch(e){}}});_6.hideOverflow(this.domNode);this._searchWipeIn.play();}},applyContext:function(_91,_92){if(this._metaEntity==null){if(_92){_92();}return;}if(!this._dataSource){_14.error(this.id+".applyContext: Applying context before rendered!!!");if(_92){_92();}return;}this.cloneContext(_91);this.setUpdateInterval();_1a.forEach(this._toolWidgets,function(_93){_93.applyContext(this.mxcontext);},this);this._gridState.xpathConstraint=this.xpathConstraint;var _94=this.mxcontext.getParam("xpathConstraint");if(_94){this._gridState.xpathConstraint+=_94;}this.removeSubscriptions();this.registerSubscriptions();if(this.reference){var _95=this.reference.split(/\//),_96=_95[0],_97=_95[1];var id=this.mxcontext.getContext(_96);if(id){var _98="["+_97+"=\""+id+"\"]";this._gridState.xpathConstraint+=_98;}else{}}if(!this._gridState.inDenial){var _99=[];if(this.constraintsFilled()){var _9a=[];var _9b=function(_9c){return function(_9d){_9c.reinit(_9d);};};_1a.forEach(this._searchElements,function(_9e){_9a.push(_9b(_9e));});_99.push(function(_9f){this.collect(_9a,_9f);});_99.push(function(_a0){if(this._dataSource.setConstraints){var _a1=this._previousSearchConstraints?this._previousSearchConstraints:this._searchGetConstraints();this._previousSearchConstraints="";this._dataSource.setConstraints(_a1);}this._dataSource.setOffset(this.getState("pageOffset",0));this._dataSource.reload(_a0);});}else{_99.push("actCleanDS");}this.sequence(_99,function(){if(!this._preserveSelection){this.selection=this.getState("selectedGuids",[]);this.filterSelected();}this.refreshGrid();_92();});}else{if(_92){_92();}}},filterSelected:function(){this.selection=_1a.filter(this.selection,function(_a2){return this._dataSource.getObject(_a2)!=null;},this);},objectUpdateNotification:function(){var _a3=this;if(!this._gridState.inDenial&&this.constraintsFilled()){this._dataSource.isValid(function(_a4){if(_a4){_a3.sequence([_1b.hitch(_a3._dataSource,"entityUpdate"),function(_a5){this.filterSelected();this.refreshGrid();if(_a5){_a5();}}]);}});}},refreshGrid:function(){if(this._dataSource.afterEnd()){this._dataSource.first(_1b.hitch(this,"refreshGrid"));return;}this.updatePagingStatus();this.fillGrid();this.resizeGrid();},actCleanDS:function(_a6){this.selection=[];this._dataSource.clean(_a6);},actionDeleteSelection:function(_a7){if(this._gridState.invertedSelection){}else{if(!this._hasSelection()){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{var _a8=this;var _a9=function(){var _aa=_a8.selection;_a8.deselectAll();_a8._shareSelection(_a8._metaEntity.getEntity());window.mx.data.remove({guids:_aa,callback:function(){window.mx.data.sendClassUpdate(_a8.entity);},error:function(e){window.mx.onError(e);}});};if(_a7===true){_a9();}else{window.mx.ui.confirmation({content:window.mx.ui.translate("mxui.widget.DataGrid","confirm_delete",this.selection.length),handler:_a9});}}}},resize:function(box){var _ab=false;if(box){var _ac=_19.getMarginBox(this.domNode),_ad=_19.getMarginBox(this.contentNode),_ae=box.h-(_ac.h-_ad.h);if(_ae>_e.minContainerHeight){_18.set(this.contentNode,"height",_ae+"px");_ab=true;if(this.headTable){_18.set(this.headTable,"top","0px");}}}this.contentNode.style.overflow=_ab?"auto":"";if(!_ab){_18.set(this.contentNode,"height","auto");}this._resizeBox=box;},close:function(){this.disposeContent();},onHide:function(e){_1a.forEach(this._searchElements,function(_af){_af.cleanup();});},storeState:function(_b0){_b0("searchBarVisible",this._gridState.searchBarVisible);_b0("searchConstraints",this._dataSource.getConstraints&&this._dataSource.getConstraints());_b0("pageOffset",this._dataSource.getOffset());_b0("selectedGuids",this.selection);if(this._dataSource.getSortSettings){_b0("sortOptions",this._dataSource.getSortSettings());}var _b1={};_1a.forEach(this._searchElements,function(_b2){_b1[_b2.path]=_b2.get("value");});_b0("searchInput",_b1);},uninitialize:function(){this.clearInterval();this.removeSubscriptions();this._clearSelectionStore();_d.destroyWidgetsIn(this.searchControlNode);_d.destroyWidgetsIn(this.toolBarNode);_d.destroyWidgetsIn(this.pagingBarNode);if(this.itemNode){_d.destroyWidgetsIn(this.itemNode);}if(this._dataSource){this._dataSource.destroy();}_1a.forEach(this._searchElements,function(_b3){_b3.destroy();});}});return _1d;});