
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/_FormWidget",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget._FormWidget");_1.declare("mxui.widget._FormWidget",[mxui.widget._WidgetBase,mxui.mixin._ValidationHelper],{attributePath:"",events:null,editNode:null,readNode:null,_mxObject:null,_rootSubs:null,_objsub:null,_attrsub:null,_path:null,_attribute:"",_entity:"",postMixInProperties:function(){var _4=this._path=this.attributePath.split("/");this._attribute=_4.pop();this._entity=_4.slice(-1)[0]||this.entity;_4.shift();var _5=mx.meta.getEntity(this._entity);if(!_5||!_5.has(this._attribute)){throw new mendix.lib.Error("No permission to read or write attribute "+this._attribute+" of entity "+this._entity+", check security.");}this._rootSubs=[];},buildRendering:function(){if(this.readNode&&!this.domNode){this.domNode=mxui.dom.create("div",this.editNode);}if(this.mask){var _6=new mxui.lib.MxInputMask(this.editNode,this.mask);this.addOnDestroy(_1.hitch(_6,"destroy"));}},startup:function(){this.set("disabled",this.readOnly);this.setupValidation(this._attribute);this.connectEvents();},update:function(_7,_8){while(this._rootSubs.length>0){this.unsubscribe(this._rootSubs.shift());}var _9=this,_a=function(){mx.data.fetch(_7,_9._path,{usexpath:true},function(_b){_9.updateObject(_b,_8);},function(e){mx.onError(e);_9.updateObject(null,_8);});};if(_7){if(this._path.length>0){this._rootSubs.push(this.subscribe({guid:_7.getGuid(),callback:function(_c){_a();}}));this._rootSubs.push(this.subscribe({guid:_7.getGuid(),attr:this._path[0],callback:function(_d,_e,_f){_a();}}));}_a();}else{this.updateObject(null,_8);}},updateObject:function(obj,_10){if(obj!=this._mxObject){this._mxObject=obj;this.setValidationObject(obj);}this.removeError();this.updateDisabled();if(this._objsub){this.unsubscribe(this._objsub);this._objsub=null;}if(this._attrsub){this.unsubscribe(this._attrsub);this._attrsub=null;}if(obj){var _11=_1.hitch(this,function(val){this.removeError();if(this.get("value")!=val){this.set("value",val);}});this._objsub=this.subscribe({guid:obj.getGuid(),callback:function(){_11(this._mxObject.get(this._attribute));}});this._attrsub=this.subscribe({guid:obj.getGuid(),attr:this._attribute,callback:function(_12,_13,val){_11(val);}});this.set("value",obj.get(this._attribute));}else{this.set("value","");}_10&&_10();},connectEvents:function(){var _14=this.editNode||this.domNode;this.connect(_14,"change","onChange");for(var evt in this.events){if(evt!="change"){this.connect(_14,evt,_1.hitch(this,"handleEvent",evt));}}},handleEvent:function(evt){var ev=this.events&&this.events[evt];ev&&this.validatedMicroflow(ev);},onChange:function(e){var ev=this.events&&this.events.change,_15=this.get("value");if(this.isValid()){this._mxObject.set(this._attribute,_15);this.set("value",_15);}ev&&this.validatedMicroflow(ev);},enable:function(){if(this.editNode&&this.readNode){this.domNode.replaceChild(this.editNode,this.readNode);}else{this.domNode.removeAttribute("disabled");}},disable:function(){if(this.editNode&&this.readNode){var _16=this.get("value");if(_16!=null){this.set("value",_16);}this.domNode.replaceChild(this.readNode,this.editNode);}else{this.domNode.setAttribute("disabled","disabled");}},checkDisabled:function(){return (this.inherited(arguments)||!this._mxObject||this._mxObject.isReadonlyAttr(this._attribute));},getType:function(){return mx.meta.getEntity(this._entity).getAttributeType(this._attribute);}});});