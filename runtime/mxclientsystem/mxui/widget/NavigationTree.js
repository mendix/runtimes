/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/NavigationTree",["mxui/widget/_WidgetBase","mxui/mixin/_Stateful","mxui/dom","mendix/lang","dojo/_base/event","dojo/on","dojo/dom-class","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var $=_3.create;function _a(_b){var _c={};_d(_b);return _c;function _d(_e){_4.forEach(_e,function(_f){_c[_f.id]=_f;_d(_f.items);});};};var _10=_9([_1,_2],{declaredClass:"mxui.widget.NavigationTree",menuID:"",_view:null,_itemMap:{},_expandedItems:{},_currentActive:null,_initialActive:null,buildRendering:function(){var _11=window.mx.ui.getMenu(this.menuID);this._itemMap=_a(_11);this._view=new _12(this,_11);this.domNode=this._view.domNode;this._view.subscribeToClick(_8.hitch(this,"_onClick"));this._expandedItems=this.getState("expandedItems",{});_4.forEach(this._expandedItems,function(_13,_14){this._view.expand(_14);},this);this._restoreSelection();this.connect(this.mxform,"onNavigation",this._restoreSelection);},_onClick:function(_15){var _16=this._itemMap[_15];if(_16.action){this._view.deactivateAll();this._view.activate(_15);this._currentActive=_15;if(typeof _16.action==="function"){_16.action();}else{window.mx.ui.execute(_16.action,{context:this.mxcontext});}}else{if(_15 in this._expandedItems){this._view.collapse(_15);delete this._expandedItems[_15];}else{this._view.expand(_15);this._expandedItems[_15]=true;}}},_restoreSelection:function(){this._currentActive=this.getState("activeItem",this._currentActive);this._initialActive=this._currentActive;this._view.deactivateAll();if(this._currentActive){this._view.activate(this._currentActive);}},storeState:function(_17){_17("expandedItems",this._expandedItems);_17("activeItem",this._initialActive);}});var _12=_9(null,{_handlerScope:null,domNode:null,constructor:function(_18,_19){this._handlerScope=_18;this._render(_19);},_render:function(_1a){this.domNode=$("div",{"class":"mx-navigationtree",tabindex:-1},$("div",{"class":"navbar-inner"},this._buildMenu(_1a)));},_buildMenu:function(_1b){var _1c=$("ul");_4.forEach(_1b,function(_1d){var _1e=$("a",{href:"#","class":"dropdown mx-name-"+_1d.id,"data-item-id":_1d.id});if(_1d.icon){_1e.appendChild($("img",{src:window.mx.appUrl+_1d.icon}));}_1e.appendChild(document.createTextNode(" "+_1d.caption+" "));var _1f=$("li",_1e);_1c.appendChild(_1f);if(_1d.items){_7.add(_1f,"mx-navigationtree-has-items mx-navigationtree-collapsed");_1f.appendChild(this._buildMenu(_1d.items));_1e.appendChild($("span",{"class":"caret"}));}},this);return _1c;},subscribeToClick:function(_20){this._handlerScope.own(_6(this.domNode,"a:click",function(e){_5.stop(e);_20(this.getAttribute("data-item-id"));}));},expand:function(_21){_7.remove(this._getItemById(_21).parentNode,"mx-navigationtree-collapsed");},collapse:function(_22){_7.add(this._getItemById(_22).parentNode,"mx-navigationtree-collapsed");},deactivateAll:function(){_4.forEach(this.domNode.querySelectorAll(".active"),function(_23){_7.remove(_23,"active");});},activate:function(_24){_7.add(this._getItemById(_24),"active");},_getItemById:function(_25){return this.domNode.querySelector("[data-item-id='"+_25+"']");}});return _10;});