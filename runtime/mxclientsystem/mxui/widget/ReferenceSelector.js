/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/ReferenceSelector",["mxui/widget/_LabeledWidget","mxui/mixin/_ValidationHelper","mxui/widget/Button","webcore/datasource/MicroflowSource","webcore/datasource/XPathSource","mendix/lib/MxContext","mxui/dom","mendix/lang","mendix/logger","dojo/sniff","dojo/dom-construct","dojo/_base/event","dojo/keys","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){var $=_7.create;var _10=_f([_1,_2],{declaredClass:"mxui.widget.ReferenceSelector",attributePath:"",sort:null,constraint:"",constrainedBy:null,dataSourceMicroflow:"",selectForm:null,gotoForm:null,events:null,useContext:false,contextAction:"",preserveTrackObject:true,precision:-1,formatted:false,_mxObject:null,_readNode:null,_editNode:null,_inputPane:null,_gotoButton:null,_assoc:"",_entity:"",_attr:"",_constraint:"",_datasource:null,_objsubs:null,_opts:null,postMixInProperties:function(){_e.mixin(this,this.selectForm?_11:_12);},postCreate:function(){var _13=this.attributePath.split("/");this.constrainedBy=this.constrainedBy||[];this._assoc=_13[1];this._entity=_13[2];this._attr=_13[3];this.mxcontext.setConstraints(this.constrainedBy);if(this.dataSourceMicroflow){this._datasource=new _4({microflow:this.dataSourceMicroflow,context:this.mxcontext});}else{this._datasource=new _5({entity:this._entity,context:this.mxcontext,useContext:this.useContext,sortparams:this.sort,attributes:[this._attr]});}this._objsubs=[];if(this.precision!==-1){this._opts={groups:this.formatted,places:this.precision};}},startup:function(){this.inherited(arguments);this.setupValidation(this._assoc);},onChange:function(){var ev=this.events&&this.events.change;if(ev){this.validatedMicroflow(ev);}},update:function(obj,_14){this._mxObject=obj;this.setValidationObject(obj);this._removeObjectSubscriptions();if(obj){this._constraint=this.constraint.replace("[%CurrentObject%]",obj.getGuid());this._addObjectSubscriptions();}this.updateDisabled();this.updateObject(obj,_14);},checkDisabled:function(){return (this.inherited(arguments)||!this._mxObject||this._mxObject.isReadonlyAttr(this._assoc));},renderObject:function(_15){var _16=this._mxObject,ref=_16&&_16.get2(this._assoc),_17=this;if(ref){var _18=this._datasource.getObject(ref);if(_18){_19(_18);}else{window.mx.data.fetch(_16,[this._assoc,this._entity],{usexpath:true},_19,function(e){window.mx.onError(e);if(_15){_15();}});}}else{_19(null);}function _19(obj){if(_17._mxObject==_16&&(!_17._mxObject||_17._mxObject.get2(_17._assoc)==ref)){_17.setValue(obj);}if(_15){_15();}};},setTextValue:function(obj){var _1a=obj?window.mx.parser.formatAttribute(obj,this._attr,this._opts):"";if(_1a){_7.text(this._readNode,_1a);}else{this._readNode.innerHTML="&nbsp;";}if(this._gotoButton){this._gotoButton.set("disabled",!obj);}},openGotoForm:function(){var obj=this._mxObject,ref=obj&&obj.get2(this._assoc);if(ref){var _1b=new _6();_1b.mixin(this.mxcontext);_1b.setContext(this._entity,ref);_1b.setTrackObject(null);window.mx.ui.execute({form:this.gotoForm},{context:_1b});}},_getValueAttr:function(){return this._editNode.value;},_createGoToButton:function(){var _1c=this._gotoButton=new _3({"class":"mx-referenceselector-goto-button",iconClass:"glyphicon-eye-open"});this.connect(_1c,"onClick","openGotoForm");return _1c.domNode;},_addObjectSubscriptions:function(){var obj=this._mxObject,ref;var _1d=function(){this.removeError();this.updateObject(obj);};this._objsubs.push(this.subscribe({guid:obj.getGuid(),callback:_1d}));this._objsubs.push(this.subscribe({guid:obj.getGuid(),attr:this._assoc,callback:this.selectForm?_1d:function(){this.removeError();var _1e=obj.get2(this._assoc),_1f=!_1e||this._datasource.getObject(_1e);if(_1f||this.get("disabled")){this.renderObject();}else{this.renderSet();}}}));ref=obj.getReference(this._assoc);if(ref){this._objsubs.push(this.subscribe({guid:ref,attr:this._attr,callback:_1d}));}},_removeObjectSubscriptions:function(){var _20=this._objsubs;while(_20.length>0){this.unsubscribe(_20.shift());}},_createReadNode:function(){var _21=this.insideFormGroup?$("p",{"class":"form-control-static"}):$("label");_21.innerHTML="&nbsp;";return _21;}});var _12={_subs:null,buildRendering:function(){this._readNode=this._createReadNode();this._editNode=$("select",{"class":"form-control"});this.connect(this._editNode,"change",function(){var _22=this.get("value");if(this.isValid()&&this._mxObject.get2(this._assoc)!=_22){this._mxObject.set(this._assoc,_22);if(this._gotoButton){this._gotoButton.set("disabled",!_22);}this.onChange();}});var _23;this.domNode=$("div",{"class":"mx-referenceselector"},_23=$("div",{"class":"mx-referenceselector-input-wrapper"},this._editNode));if(this.gotoForm){_b.place(this._createGoToButton(),_23,"before");}this._inputPane=_23;},enable:function(){var _24=this;this.renderSet(function(){_24._inputPane.replaceChild(_24._editNode,_24._readNode);});},disable:function(){var _25=this;this.renderObject(function(){_25._inputPane.replaceChild(_25._readNode,_25._editNode);});},setValue:function(obj){this._editNode.value=obj?obj.getGuid():"";this.setTextValue(obj);},updateObject:function(obj,_26){this._removeSubscriptions();this._subscribeToConstraints();if(this.get("disabled")){this.renderObject(_26);}else{this._subscribeToEntity();this.renderSet(_26);}},renderSet:function(_27){var _28=this,obj=this._mxObject,_29=this._datasource,_2a=obj&&obj.get2(_28._assoc),_2b=false;var _2c=function(_2d){_28._renderOptions(_2d);if(_27){_27();}};if(obj){if(_29.setConstraints){_29.setConstraints(this._constraint);}_29.reload(function(){_2c(_29.getObjects());if(_2a){var _2e=_29.getObjects();for(var i=0,obj;obj=_2e[i];i++){if(_2a===obj.getGuid()){_28.setValue(obj);_2b=true;break;}}if(!_2b){_28._mxObject.set(_28._assoc,"");_28.onChange();}}});}else{_2c();}if(this._gotoButton){this._gotoButton.set("disabled",!_2b);}},_renderOptions:function(_2f){var _30=this._editNode;_2f=_2f||[];_7.empty(_30);_30.appendChild($("option",{value:""},""));for(var i=0,obj;obj=_2f[i];i++){_30.appendChild($("option",{value:obj.getGuid()},window.mx.parser.formatAttribute(obj,this._attr,this._opts)||""));}},_subscribeToConstraints:function(){var _31=this.constrainedBy;if(!_31||!_31.length){return;}if(this._mxObject){for(var i=0,len=_31.length;i<len;++i){var _32=_31[i].split("/");if(_32[1]){this._subs.push(this.subscribe({guid:this._mxObject.getGuid(),attr:_32[1],callback:function(){this.updateObject(this._mxObject);}}));}}}},_subscribeToEntity:function(){var _33=this._mxObject.metaData.getSelectorEntity(this._assoc);this._subs.push(this.subscribe({entity:_33,callback:function(){this.updateObject(this._mxObject);}}));},_removeSubscriptions:function(){if(this._subs){while(this._subs.length){this.unsubscribe(this._subs.shift());}}this._subs=[];}};var _11={_selectButton:null,buildRendering:function(){this._readNode=this._createReadNode();this._editNode=$("input",{type:"text",readonly:"readonly","class":"form-control"});var _34=this._selectButton=new _3({"class":"mx-referenceselector-select-button",iconClass:"glyphicon-share-alt"});this.connect(_34,"onClick","openSelectForm");if(_a("mobile")){this.connect(this._editNode,"click","openSelectForm");}else{this.connect(this._editNode,"keypress","_onKeyPress");}this.connect(_34.domNode,"keypress","_onKeyPress");this.domNode=$("div",{"class":"mx-referenceselector"},_34.domNode,this._inputPane=$("div",{"class":"mx-referenceselector-input-wrapper"},this._editNode));if(this.gotoForm){_b.place(this._createGoToButton(),_34.domNode,"before");}},enable:function(){_b.place(this._selectButton.domNode,this.domNode,"first");this._readNode.parentNode.replaceChild(this._editNode,this._readNode);},disable:function(){this.domNode.removeChild(this._selectButton.domNode);this._editNode.parentNode.replaceChild(this._readNode,this._editNode);},setValue:function(obj){this._editNode.value=obj?window.mx.parser.formatAttribute(obj,this._attr,this._opts):"";this.setTextValue(obj);},updateObject:function(obj,_35){this.renderObject(_35);},openSelectForm:function(){var ref=this._mxObject.get2(this._assoc),_36=this;window.mx.ui.execute({form:this.selectForm},{context:new _6({mxcontext:this.mxcontext}),params:{selection:ref?[ref]:[],listViewSelectionMode:"single",dataSourceMixin:{constraint:this.constraint}},callback:function(_37){_37.listen("save",function(_38){var _39=_8.find(_37.getChildren(true),function(_3a){return "getSelected" in _3a;}),_3b=_39.getSelected()[0]||"";if(_36._mxObject.getReference(_36._assoc)!=_3b){_36._mxObject.set(_36._assoc,_3b);_36.renderObject();_36.onChange();}_38();});}});},_onKeyPress:function(e){if(e.keyCode==_d.DELETE){if(this.get("disabled")||(e.ctrlKey&&e.shiftKey)){return;}_c.stop(e);if(!this.get("value")){return;}var _3c=this;window.mx.ui.confirmation({content:this.translate("clean_confirmation"),handler:function(){_3c._mxObject.set(_3c._assoc,"");}});}}};return _10;});