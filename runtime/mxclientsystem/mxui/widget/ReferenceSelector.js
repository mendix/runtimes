
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/ReferenceSelector",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget.ReferenceSelector");_1.declare("mxui.widget.ReferenceSelector",[mxui.widget._WidgetBase,mxui.mixin._ValidationHelper],{attributePath:"",sort:null,constraint:"",constrainedBy:null,dataSourceMicroflow:"",selectForm:null,gotoForm:null,events:null,useContext:false,contextAction:"",preserveTrackObject:true,_mxObject:null,_readNode:null,_editNode:null,_inputPane:null,_gotoButton:null,_assoc:"",_entity:"",_attr:"",_constraint:"",_datasource:null,_objsubs:null,postMixInProperties:function(){_1.mixin(this,this.selectForm?mxui.widget._ReferenceInput:mxui.widget._ReferenceSelect);},postCreate:function(){var _4=this.attributePath.split("/");this.constrainedBy=this.constrainedBy||[];this._assoc=_4[1];this._entity=_4[2];this._attr=_4[3];this.mxcontext.setConstraints(this.constrainedBy);if(this.dataSourceMicroflow){this._datasource=new mendix.lib.MicroflowSource({microflow:this.dataSourceMicroflow,context:this.mxcontext,page:1000});}else{this._datasource=new mendix.lib.XPathSource({entity:this._entity,context:this.mxcontext,useContext:this.useContext,sortparams:this.sort,attributes:[this._attr],page:1000});}this._objsubs=[];},onChange:function(){var ev=this.events&&this.events.change;ev&&this.validatedMicroflow(ev);},update:function(_5,_6){this._mxObject=_5;this.setValidationObject(_5);this._removeObjectSubscriptions();if(_5){this._constraint=this.constraint.replace("[%CurrentObject%]",_5.getGuid());this._addObjectSubscriptions();}this.updateDisabled();this.updateObject(_5,_6);},checkDisabled:function(){return (this.inherited(arguments)||!this._mxObject||this._mxObject.isReadonlyAttr(this._assoc));},renderObject:function(_7){var _8=this._mxObject,_9=_8&&_8.get(this._assoc);if(_9){mx.data.fetch(_8,[this._assoc,this._entity],{usexpath:true},_1.hitch(this,function(_a){if(_a&&this._mxObject&&this._mxObject.getReference(this._assoc)==_a.getGuid()){this.setValue(_a);}_7&&_7();}),function(e){mx.onError(e);_7&&_7();});}else{this.setValue(null);_7&&_7();}},setTextValue:function(_b){var _c=_b?mx.parser.formatAttribute(_b,this._attr):"";if(_c){mxui.dom.text(this._readNode,_c);}else{this._readNode.innerHTML="&nbsp;";}if(this._gotoButton){this._gotoButton.set("disabled",!_b);}},openGotoForm:function(){var _d=this._mxObject,_e=_d&&_d.get(this._assoc);if(_e){var _f=new mendix.lib.MxContext();_f.mixin(this.mxcontext);_f.setContext(this._entity,_e);_f.setTrackObject(null);mx.ui.execute({form:this.gotoForm},{context:_f});}},_getValueAttr:function(){return this._editNode.value;},_createGoToButton:function(){var _10=this._gotoButton=new mxui.widget.Button({"class":"mx-referenceselector-goto-button",iconClass:"glyphicon glyphicon-eye-open"});this.connect(_10,"onClick","openGotoForm");return _10.domNode;},_addObjectSubscriptions:function(){var obj=this._mxObject,ref;var _11=function(){this.removeError();this.updateObject(obj);};this._objsubs.push(this.subscribe({guid:obj.getGuid(),callback:_11}));this._objsubs.push(this.subscribe({guid:obj.getGuid(),attr:this._assoc,callback:this.selectForm?_11:function(){this.removeError();if(this.get("suspended")){return;}var _12=obj.get(this._assoc),_13=!_12||this._datasource.getObject(_12);if(_13){this.renderObject();}else{this.renderSet();}}}));ref=obj.getReference(this._assoc);if(ref){this._objsubs.push(this.subscribe({guid:ref,attr:this._attr,callback:_11}));}},_removeObjectSubscriptions:function(){var _14=this._objsubs;while(_14.length>0){this.unsubscribe(_14.shift());}}});mxui.widget._ReferenceSelect={_subs:null,buildRendering:function(){var $=mxui.dom.create,_15=this._editNode=$("select",{"class":"form-control"}),_16=this._readNode=$("label");this.connect(_15,"change",function(){var _17=this.get("value");if(this.isValid()&&this._mxObject.get(this._assoc)!=_17){this._mxObject.set(this._assoc,_17);if(this._gotoButton){this._gotoButton.set("disabled",!_17);}this.onChange();}});var _18;this.domNode=$("div",{"class":"mx-referenceselector"},_18=$("div",{"class":"mx-referenceselector-input-wrapper"},_15));if(this.gotoForm){_1.place(this._createGoToButton(),_18,"before");}this._inputPane=_18;},startup:function(){this.setupValidation(this._assoc);},enable:function(){var _19=this;this.renderSet(function(){_19._inputPane.replaceChild(_19._editNode,_19._readNode);});},disable:function(){var _1a=this;this.renderObject(function(){_1a._inputPane.replaceChild(_1a._readNode,_1a._editNode);});},setValue:function(obj){this._editNode.value=obj?obj.getGuid():"";this.setTextValue(obj);},updateObject:function(obj,_1b){if(!this.get("suspended")){this.subscribeConstraints();if(this.get("disabled")){this.renderObject(_1b);}else{this.renderSet(_1b);}}else{_1b&&_1b();}},renderSet:function(_1c){var _1d=this,obj=this._mxObject,_1e=this._datasource,_1f=obj&&obj.get(_1d._assoc),_20=false;var _21=function(_22){_1d.renderOptions(_22);_1c&&_1c();};if(obj){if(_1e.setConstraints){_1e.setConstraints(this._constraint);}_1e.reload(function(){_21(_1e.getObjects());if(_1f){var _23=_1e.getObjects();for(var i=0,obj;obj=_23[i];i++){if(_1f===obj.getGuid()){_1d._editNode.value=_1f;_20=true;break;}}if(!_20){_1d._mxObject.set(_1d._assoc,"");_1d.onChange();}}});}else{_21();}if(this._gotoButton){this._gotoButton.set("disabled",!_20);}},renderOptions:function(_24){var $=mxui.dom.create,_25=this._editNode;_24=_24||[];mxui.dom.empty(_25);_25.appendChild($("option",{value:""},""));for(var i=0,obj;obj=_24[i];i++){_25.appendChild($("option",{value:obj.getGuid()},mx.parser.formatAttribute(obj,this._attr)||""));}},subscribeConstraints:function(){var _26=this.constrainedBy;if(!_26){return;}if(this._subs){while(this._subs.length){this.unsubscribe(this._subs.shift());}this._subs=null;}if(this._mxObject){for(var i=0,len=_26.length;i<len;++i){var _27=_26[i].split("/");if(_27[1]){this.subscribe({guid:this._mxObject.getGuid(),attr:_27[1],callback:function(){this.updateObject(this._mxObject);}});}}}}};mxui.widget._ReferenceInput={_selectButton:null,buildRendering:function(){var $=mxui.dom.create;var _28=this._readNode=$("label"),_29=this._editNode=$("input",{type:"text",readonly:"readonly","class":"form-control"});var _2a=this._selectButton=new mxui.widget.Button({"class":"mx-referenceselector-select-button",iconClass:"glyphicon glyphicon-share-alt"});this.connect(_2a,"onClick","openSelectForm");if(mx.ui.getProfile()=="desktop"){this.connect(_29,"keypress","_onKeyPress");}else{this.connect(_29,"click","openSelectForm");}this.connect(_2a.domNode,"keypress","_onKeyPress");this.domNode=$("div",{"class":"mx-referenceselector"},_2a.domNode,this._inputPane=$("div",{"class":"mx-referenceselector-input-wrapper"},_29));if(this.gotoForm){_1.place(this._createGoToButton(),_2a.domNode,"before");}},startup:function(){this.setupValidation(this._assoc);},enable:function(){_1.place(this._selectButton.domNode,this.domNode,"first");this._readNode.parentNode.replaceChild(this._editNode,this._readNode);},disable:function(){this.domNode.removeChild(this._selectButton.domNode);this._editNode.parentNode.replaceChild(this._readNode,this._editNode);},setValue:function(obj){this._editNode.value=obj?mx.parser.formatAttribute(obj,this._attr):"";this.setTextValue(obj);},updateObject:function(obj,_2b){this.renderObject(_2b);},openSelectForm:function(){var ref=this._mxObject.get(this._assoc);mx.ui.execute({form:this.selectForm},{context:new mendix.lib.MxContext({mxcontext:this.mxcontext}),params:{selection:ref?[ref]:[],selectable:"single",constraint:this._constraint},callback:function(_2c){_2c.listen("save",_1.hitch(this,function(_2d){var sel=_2c.getReturnValue("selection"),ref;if(sel){ref=sel.length===0?"":sel[0];if(this._mxObject.getReference(this._assoc)!=ref){this._mxObject.set(this._assoc,ref);this.renderObject();this.onChange();}}else{logger.error(this.id+" form return value 'selection' does not exist");}_2d();}));}},this);},_onKeyPress:function(e){if(e.keyCode==_1.keys.DELETE){if(this.get("disabled")||(e.ctrlKey&&e.shiftKey)){return;}_1.stopEvent(e);if(!this.get("value")){return;}var _2e=this;mx.ui.confirmation({content:this.translate("clean_confirmation"),handler:function(){_2e._mxObject.set(_2e._assoc,"");}});}}};});