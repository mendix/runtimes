/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/ReferenceSelector",["mxui/widget/_LabeledWidget","mxui/mixin/_ValidationHelper","mxui/widget/Button","webcore/dataSourceFactory","mendix/lib/MxContext","mxui/dom","mendix/lang","mendix/logger","dojo/sniff","dojo/dom-construct","dojo/_base/event","dojo/keys","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){var $=_6.create;var _f=_e([_1,_2],{declaredClass:"mxui.widget.ReferenceSelector",attributePath:"",readOnlyStyle:"",datasource:null,selectPageSettings:null,gotoPageSettings:null,events:null,useContext:false,contextAction:"",preserveTrackObject:true,precision:-1,formatted:false,_mxObject:null,_readNode:null,_editNode:null,_inputPane:null,_gotoButton:null,_assoc:"",_entity:"",_attr:"",_datasource:null,_objsubs:null,_opts:null,postMixInProperties:function(){_d.mixin(this,this.selectPageSettings?_10:_11);},postCreate:function(){var _12=this.attributePath.split("/");this._assoc=_12[1];this._entity=_12[2];this._attr=_12[3];if(this.datasource.constrainedBy){this.mxcontext.setConstraints(this.datasource.constrainedBy);}this._datasource=_4.create(_d.mixin({context:this.mxcontext,useContext:this.useContext,attributes:[this._attr]},this.datasource));this._objsubs=[];if(this.precision!==-1){this._opts={groups:this.formatted,places:this.precision};}},startup:function(){this.inherited(arguments);this.setupValidation(this._assoc);},onChange:function(){var ev=this.events&&this.events.change;if(ev){this.validatedMicroflow(ev);}},update:function(obj,_13){this._mxObject=obj;this.setValidationObject(obj);this._removeObjectSubscriptions();if(obj){this._addObjectSubscriptions();}this.updateDisabled();this.updateObject(obj,_13);},checkDisabled:function(){return (this.inherited(arguments)||!this._mxObject||this._mxObject.isReadonlyAttr(this._assoc));},renderObject:function(_14){var _15=this._mxObject,ref=_15&&_15.get2(this._assoc),_16=this;if(ref){var _17=this._datasource.getObject(ref);if(_17){_18(_17);}else{window.mx.data.fetch(_15,[this._assoc,this._entity],{usexpath:true},_18,function(e){window.mx.onError(e);if(_14){_14();}});}}else{_18(null);}function _18(obj){if(_16._mxObject==_15&&(!_16._mxObject||_16._mxObject.get2(_16._assoc)==ref)){_16.setValue(obj);}if(_14){_14();}};},setTextValue:function(obj){var _19=obj?window.mx.parser.formatAttribute(obj,this._attr,this._opts):"";if(_19){_6.text(this._readNode,_19);}else{this._readNode.innerHTML="&nbsp;";}if(this._gotoButton){this._gotoButton.set("disabled",!obj);}},openGotoForm:function(){var obj=this._mxObject,ref=obj&&obj.get2(this._assoc);if(ref){var _1a=new _5();_1a.mixin(this.mxcontext);_1a.setContext(this._entity,ref);_1a.setTrackObject(null);window.mx.ui.execute({type:"openPage",params:this.gotoPageSettings},{origin:this.mxform,context:_1a});}},_getValueAttr:function(){return this._editNode.value;},_createGoToButton:function(){var _1b=this._gotoButton=new _3({"class":"mx-referenceselector-goto-button",iconClass:"glyphicon-eye-open"});this.connect(_1b,"onClick","openGotoForm");return _1b.domNode;},_addObjectSubscriptions:function(){var obj=this._mxObject,ref;var _1c=function(){this.removeError();this.updateObject(obj);};this._objsubs.push(this.subscribe({guid:obj.getGuid(),callback:_1c}));this._objsubs.push(this.subscribe({guid:obj.getGuid(),attr:this._assoc,callback:this.selectPageSettings?_1c:function(){this.removeError();var _1d=obj.get2(this._assoc),_1e=!_1d||this._datasource.getObject(_1d);if(_1e||this.get("disabled")){this.renderObject();}else{this.renderSet();}}}));ref=obj.getReference(this._assoc);if(ref){this._objsubs.push(this.subscribe({guid:ref,attr:this._attr,callback:_1c}));}},_removeObjectSubscriptions:function(){var _1f=this._objsubs;while(_1f.length>0){this.unsubscribe(_1f.shift());}},_createReadNode:function(){var _20=this.insideFormGroup?$("p",{"class":"form-control-static"}):$("label");_20.innerHTML="&nbsp;";return _20;}});var _11={_subs:null,_currentValue:"",buildRendering:function(){this._readNode=this._createReadNode();this._editNode=$("select",{"class":"form-control"});this.connect(this._editNode,"change",function(){var _21=this.get("value");if(_21===this._currentValue){return;}this._currentValue=_21;if(this.isValid()&&this._mxObject.get2(this._assoc)!=_21){this._mxObject.set(this._assoc,_21);if(this._gotoButton){this._gotoButton.set("disabled",!_21);}this.onChange();}});var _22;this.domNode=$("div",{"class":"mx-referenceselector"},_22=$("div",{"class":"mx-referenceselector-input-wrapper"},this._editNode));if(this.gotoPageSettings){_a.place(this._createGoToButton(),_22,"before");}this._inputPane=_22;},enable:function(){var _23=this;this.renderSet(function(){if(_23.readOnlyStyle==="text"){_23._inputPane.replaceChild(_23._editNode,_23._readNode);}else{_23._editNode.disabled=false;}});},disable:function(){var _24=this;if(this.readOnlyStyle==="text"){this.renderObject(function(){_24._inputPane.replaceChild(_24._readNode,_24._editNode);});}else{this.renderSet(function(){_24._editNode.disabled=true;});}},setValue:function(obj){this._currentValue=this._editNode.value=obj?obj.getGuid():"";this.setTextValue(obj);},updateObject:function(obj,_25){this._removeSubscriptions();this._subscribeToConstraints();var _26=!this.selectPageSettings&&this.readOnlyStyle==="control";if(this.get("disabled")&&!_26){this.renderObject(_25);}else{this._subscribeToEntity();this.renderSet(_25);}},renderSet:function(_27){var _28=this,_29=this._mxObject,_2a=this._datasource,_2b=_29&&_29.get2(_28._assoc);function _2c(_2d,_2e){_28._renderOptions(_2d);if(_28._gotoButton){_28._gotoButton.set("disabled",!_2e);}_28.setValue(_2e);if(_27){_27();}};if(!_29){_2c([],null);return;}_2a.reload(function(){var _2f=_2a.getObjects();var _30=_2f.filter(function(obj){return obj.getGuid()===_2b;})[0];if(!_30&&_2b){_29.set(_28._assoc,"");_28.onChange();}_2c(_2f,_30);});},_renderOptions:function(_31){var _32=this._editNode;_31=_31||[];_6.empty(_32);_32.appendChild($("option",{value:""},""));for(var i=0,obj;obj=_31[i];i++){_32.appendChild($("option",{value:obj.getGuid()},window.mx.parser.formatAttribute(obj,this._attr,this._opts)||""));}},_subscribeToConstraints:function(){var _33=this.datasource.constrainedBy||[];if(!_33.length){return;}if(this._mxObject){for(var i=0,len=_33.length;i<len;++i){var _34=_33[i].split("/");if(_34[1]){this._subs.push(this.subscribe({guid:this._mxObject.getGuid(),attr:_34[1],callback:function(){this.updateObject(this._mxObject);}}));}}}},_subscribeToEntity:function(){if(!this._mxObject){return;}var _35=this._mxObject.metaData.getSelectorEntity(this._assoc);this._subs.push(this.subscribe({entity:_35,callback:function(){this.updateObject(this._mxObject);}}));},_removeSubscriptions:function(){if(this._subs){while(this._subs.length){this.unsubscribe(this._subs.shift());}}this._subs=[];}};var _10={_selectButton:null,buildRendering:function(){this._readNode=this._createReadNode();this._editNode=$("input",{type:"text",readonly:"readonly","class":"form-control"});var _36=this._selectButton=new _3({"class":"mx-referenceselector-select-button",iconClass:"glyphicon-share-alt"});this.connect(_36,"onClick","openSelectForm");if(_9("mobile")){this.connect(this._editNode,"click","openSelectForm");}else{this.connect(this._editNode,"keypress","_onKeyPress");}this.connect(_36.domNode,"keypress","_onKeyPress");this.domNode=$("div",{"class":"mx-referenceselector"},_36.domNode,this._inputPane=$("div",{"class":"mx-referenceselector-input-wrapper"},this._editNode));if(this.gotoPageSettings){_a.place(this._createGoToButton(),_36.domNode,"before");}},enable:function(){_a.place(this._selectButton.domNode,this.domNode,"first");if(this.readOnlyStyle==="text"){this._readNode.parentNode.replaceChild(this._editNode,this._readNode);}else{this._editNode.disabled=false;}},disable:function(){this.domNode.removeChild(this._selectButton.domNode);if(this.readOnlyStyle==="text"){this._editNode.parentNode.replaceChild(this._readNode,this._editNode);}else{this._editNode.disabled=true;}},setValue:function(obj){this._editNode.value=obj?window.mx.parser.formatAttribute(obj,this._attr,this._opts):"";this.setTextValue(obj);},updateObject:function(obj,_37){this.renderObject(_37);},openSelectForm:function(){var ref=this._mxObject.get2(this._assoc),_38=this,_39=(this.datasource.constraint||"").replace("[%CurrentObject%]",this._mxObject.getGuid());window.mx.ui.execute({type:"openPage",params:this.selectPageSettings},{origin:this.mxform,context:new _5({mxcontext:this.mxcontext}),targetParams:{selection:ref?[ref]:[],listViewSelectionMode:"single",dataSourceMixin:{constraint:_39,xpathConstraints:this.datasource.xpathConstraints||"",offlineConstraints:this.datasource.offlineConstraints||[]}},callback:function(_3a){_3a.listen("commit",function(_3b){var _3c=_7.find(_3a.getChildren(true),function(_3d){return "getSelected" in _3d;}),_3e=_3c.getSelected()[0]||"";if(_38._mxObject.getReference(_38._assoc)!=_3e){_38._mxObject.set(_38._assoc,_3e);_38.renderObject();_38.onChange();}_3b();});}});},_onKeyPress:function(e){if(e.keyCode==_c.DELETE){if(this.get("disabled")||(e.ctrlKey&&e.shiftKey)){return;}_b.stop(e);if(!this.get("value")){return;}var _3f=this;window.mx.ui.confirmation({content:this.translate("clean_confirmation"),handler:function(){_3f._mxObject.set(_3f._assoc,"");}});}}};return _f;});