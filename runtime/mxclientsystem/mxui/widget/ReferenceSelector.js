
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/ReferenceSelector",["mxui/widget/_WidgetBase","mxui/mixin/_ValidationHelper","mxui/widget/Button","mendix/lib/MicroflowSource","mendix/lib/XPathSource","mendix/lib/MxContext","mxui/dom","mendix/logger","dojo/dom-construct","dojo/_base/event","dojo/keys","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var $=_7.create;var _e=_d([_1,_2],{declaredClass:"mxui.widget.ReferenceSelector",attributePath:"",sort:null,constraint:"",constrainedBy:null,dataSourceMicroflow:"",selectForm:null,gotoForm:null,events:null,useContext:false,contextAction:"",preserveTrackObject:true,_mxObject:null,_readNode:null,_editNode:null,_inputPane:null,_gotoButton:null,_assoc:"",_entity:"",_attr:"",_constraint:"",_datasource:null,_objsubs:null,postMixInProperties:function(){_c.mixin(this,this.selectForm?_f:_10);},postCreate:function(){var _11=this.attributePath.split("/");this.constrainedBy=this.constrainedBy||[];this._assoc=_11[1];this._entity=_11[2];this._attr=_11[3];this.mxcontext.setConstraints(this.constrainedBy);if(this.dataSourceMicroflow){this._datasource=new _4({microflow:this.dataSourceMicroflow,context:this.mxcontext,page:1000});}else{this._datasource=new _5({entity:this._entity,context:this.mxcontext,useContext:this.useContext,sortparams:this.sort,attributes:[this._attr],page:1000});}this._objsubs=[];},onChange:function(){var ev=this.events&&this.events.change;ev&&this.validatedMicroflow(ev);},update:function(obj,_12){this._mxObject=obj;this.setValidationObject(obj);this._removeObjectSubscriptions();if(obj){this._constraint=this.constraint.replace("[%CurrentObject%]",obj.getGuid());this._addObjectSubscriptions();}this.updateDisabled();this.updateObject(obj,_12);},checkDisabled:function(){return (this.inherited(arguments)||!this._mxObject||this._mxObject.isReadonlyAttr(this._assoc));},renderObject:function(_13){var obj=this._mxObject,ref=obj&&obj.get(this._assoc);if(ref){window.mx.data.fetch(obj,[this._assoc,this._entity],{usexpath:true},_c.hitch(this,function(obj){if(obj&&this._mxObject&&this._mxObject.getReference(this._assoc)==obj.getGuid()){this.setValue(obj);}_13&&_13();}),function(e){window.mx.onError(e);_13&&_13();});}else{this.setValue(null);_13&&_13();}},setTextValue:function(obj){var _14=obj?window.mx.parser.formatAttribute(obj,this._attr):"";if(_14){_7.text(this._readNode,_14);}else{this._readNode.innerHTML="&nbsp;";}if(this._gotoButton){this._gotoButton.set("disabled",!obj);}},openGotoForm:function(){var obj=this._mxObject,ref=obj&&obj.get(this._assoc);if(ref){var _15=new _6();_15.mixin(this.mxcontext);_15.setContext(this._entity,ref);_15.setTrackObject(null);window.mx.ui.execute({form:this.gotoForm},{context:_15});}},_getValueAttr:function(){return this._editNode.value;},_createGoToButton:function(){var _16=this._gotoButton=new _3({"class":"mx-referenceselector-goto-button",iconClass:"glyphicon glyphicon-eye-open"});this.connect(_16,"onClick","openGotoForm");return _16.domNode;},_addObjectSubscriptions:function(){var obj=this._mxObject,ref;var _17=function(){this.removeError();this.updateObject(obj);};this._objsubs.push(this.subscribe({guid:obj.getGuid(),callback:_17}));this._objsubs.push(this.subscribe({guid:obj.getGuid(),attr:this._assoc,callback:this.selectForm?_17:function(){this.removeError();if(this.get("suspended")){return;}var _18=obj.get(this._assoc),_19=!_18||this._datasource.getObject(_18);if(_19){this.renderObject();}else{this.renderSet();}}}));ref=obj.getReference(this._assoc);if(ref){this._objsubs.push(this.subscribe({guid:ref,attr:this._attr,callback:_17}));}},_removeObjectSubscriptions:function(){var _1a=this._objsubs;while(_1a.length>0){this.unsubscribe(_1a.shift());}}});var _10={_subs:null,buildRendering:function(){this._editNode=$("select",{"class":"form-control"});this._readNode=$("label");this.connect(this._editNode,"change",function(){var _1b=this.get("value");if(this.isValid()&&this._mxObject.get(this._assoc)!=_1b){this._mxObject.set(this._assoc,_1b);if(this._gotoButton){this._gotoButton.set("disabled",!_1b);}this.onChange();}});var _1c;this.domNode=$("div",{"class":"mx-referenceselector"},_1c=$("div",{"class":"mx-referenceselector-input-wrapper"},this._editNode));if(this.gotoForm){_9.place(this._createGoToButton(),_1c,"before");}this._inputPane=_1c;},startup:function(){this.setupValidation(this._assoc);},enable:function(){var _1d=this;this.renderSet(function(){_1d._inputPane.replaceChild(_1d._editNode,_1d._readNode);});},disable:function(){var _1e=this;this.renderObject(function(){_1e._inputPane.replaceChild(_1e._readNode,_1e._editNode);});},setValue:function(obj){this._editNode.value=obj?obj.getGuid():"";this.setTextValue(obj);},updateObject:function(obj,_1f){if(!this.get("suspended")){this.subscribeConstraints();if(this.get("disabled")){this.renderObject(_1f);}else{this.renderSet(_1f);}}else{_1f&&_1f();}},renderSet:function(_20){var _21=this,obj=this._mxObject,_22=this._datasource,_23=obj&&obj.get(_21._assoc),_24=false;var _25=function(_26){_21.renderOptions(_26);_20&&_20();};if(obj){if(_22.setConstraints){_22.setConstraints(this._constraint);}_22.reload(function(){_25(_22.getObjects());if(_23){var _27=_22.getObjects();for(var i=0,obj;obj=_27[i];i++){if(_23===obj.getGuid()){_21.setValue(obj);_24=true;break;}}if(!_24){_21._mxObject.set(_21._assoc,"");_21.onChange();}}});}else{_25();}if(this._gotoButton){this._gotoButton.set("disabled",!_24);}},renderOptions:function(_28){var _29=this._editNode;_28=_28||[];_7.empty(_29);_29.appendChild($("option",{value:""},""));for(var i=0,obj;obj=_28[i];i++){_29.appendChild($("option",{value:obj.getGuid()},window.mx.parser.formatAttribute(obj,this._attr)||""));}},subscribeConstraints:function(){var _2a=this.constrainedBy;if(!_2a){return;}if(this._subs){while(this._subs.length){this.unsubscribe(this._subs.shift());}this._subs=null;}if(this._mxObject){for(var i=0,len=_2a.length;i<len;++i){var _2b=_2a[i].split("/");if(_2b[1]){this.subscribe({guid:this._mxObject.getGuid(),attr:_2b[1],callback:function(){this.updateObject(this._mxObject);}});}}}}};var _f={_selectButton:null,buildRendering:function(){this._readNode=$("label");this._editNode=$("input",{type:"text",readonly:"readonly","class":"form-control"});var _2c=this._selectButton=new _3({"class":"mx-referenceselector-select-button",iconClass:"glyphicon glyphicon-share-alt"});this.connect(_2c,"onClick","openSelectForm");if(window.mx.ui.getProfile()=="desktop"){this.connect(this._editNode,"keypress","_onKeyPress");}else{this.connect(this._editNode,"click","openSelectForm");}this.connect(_2c.domNode,"keypress","_onKeyPress");this.domNode=$("div",{"class":"mx-referenceselector"},_2c.domNode,this._inputPane=$("div",{"class":"mx-referenceselector-input-wrapper"},this._editNode));if(this.gotoForm){_9.place(this._createGoToButton(),_2c.domNode,"before");}},startup:function(){this.setupValidation(this._assoc);},enable:function(){_9.place(this._selectButton.domNode,this.domNode,"first");this._readNode.parentNode.replaceChild(this._editNode,this._readNode);},disable:function(){this.domNode.removeChild(this._selectButton.domNode);this._editNode.parentNode.replaceChild(this._readNode,this._editNode);},setValue:function(obj){this._editNode.value=obj?window.mx.parser.formatAttribute(obj,this._attr):"";this.setTextValue(obj);},updateObject:function(obj,_2d){this.renderObject(_2d);},openSelectForm:function(){var ref=this._mxObject.get(this._assoc);window.mx.ui.execute({form:this.selectForm},{context:new _6({mxcontext:this.mxcontext}),params:{selection:ref?[ref]:[],selectable:"single",constraint:this._constraint},callback:function(_2e){_2e.listen("save",_c.hitch(this,function(_2f){var sel=_2e.getReturnValue("selection"),ref;if(sel){ref=sel.length===0?"":sel[0];if(this._mxObject.getReference(this._assoc)!=ref){this._mxObject.set(this._assoc,ref);this.renderObject();this.onChange();}}else{_8.error(this.id+" form return value 'selection' does not exist");}_2f();}));}},this);},_onKeyPress:function(e){if(e.keyCode==_b.DELETE){if(this.get("disabled")||(e.ctrlKey&&e.shiftKey)){return;}_a.stop(e);if(!this.get("value")){return;}var _30=this;window.mx.ui.confirmation({content:this.translate("clean_confirmation"),handler:function(){_30._mxObject.set(_30._assoc,"");}});}}};return _e;});