
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/TemplateGrid",["dojo","dijit","dojox","dojo/require!mxui/widget/_Grid,mxui/widget/TemplateGridItem"],function(_1,_2,_3){_1.provide("mxui.widget.TemplateGrid");_1.require("mxui.widget._Grid");_1.require("mxui.widget.TemplateGridItem");_1.declare("mxui.widget.TemplateGrid",mxui.widget._Grid,{templateString:_1.cache("mxui.widget","templates/TemplateGrid.html","<div class=\"${baseClass} mx-templategrid\">\n    <div class=\"${baseClass}-searchbar clearfix\" dojoAttachPoint=\"searchNode\" focusIndex=\"0\">\n        <div class=\"${baseClass}-search-controls\" focusIndex=\"1\" dojoAttachPoint=\"searchControlNode\"></div>\n        <div class=\"${baseClass}-search-inputs\" focusIndex=\"0\" dojoAttachPoint=\"searchArgumentNode\"></div>\n        <div class=\"${baseClass}-search-message\" dojoAttachPoint=\"messageNode\"></div>\n    </div>\n    \n    <div class=\"${baseClass}-controlbar clearfix\" dojoAttachPoint=\"controlNode\" focusIndex=\"1\">\n        <div class=\"${baseClass}-pagingbar\" dojoAttachPoint=\"pagingBarNode\"></div>\n        <div class=\"${baseClass}-toolbar\" dojoAttachPoint=\"toolBarNode\"></div>\n    </div>\n\t\n    <div class=\"${baseClass}-content\" dojoAttachPoint=\"contentNode\" focusIndex=\"2\">\n        <div class=\"${subClass}-content-wrapper\" dojoAttachPoint=\"itemNode\"></div>\n    </div>\n</div>\n"),subClass:"mx-templategrid",cssmap:mxui.widget.createCSSMap("mx-templategrid",{row:"row",item:"item",empty:"empty"}),itemNode:null,_mxObjects:[],_itemCache:[],_selectedGuids:{},constructor:function(){this._mxObjects=[];this._itemCache=[];this._selectedGuids={};this._gridState={selectable:true,selectionmode:"single",searchbar:true,controlbar:true,pagingbar:true,inDenial:false,searchBarVisible:false,searchBarTogglable:true,xpathConstraint:"",dynamicconstraint:"",loading:false,invertedSelection:false};},postCreate:function(){this.inherited(arguments);if(this._metaEntity){this.connectEvents();}this.loaded();},setupGridState:function(){this.inherited(arguments);this._gridState.columns=this._gridConfig.gridSetting("columns");this._gridState.rows=this._gridConfig.gridSetting("rows");this._gridState.cellwidth=String(_1.isIE?(100/this._gridState.columns-0.05):(100/this._gridState.columns))+"%";},connectEvents:function(_4){var _5=this;this.own(_1.on(this.itemNode,"."+this.cssmap.item+":click",function(e){_5.eventItemClicked(e,this);}));var _6=function(e){_5.eventActionBindingHandler(this,e.type);};for(var _7 in this._gridConfig.gridActionBindings()){this.own(_1.on(this.itemNode,"."+this.cssmap.item+":"+_7.replace(/^on/,""),_6));}},fillGrid:function(){this._mxObjects=this._dataSource.getObjects();if(this._gridState.selectfirst&&!this._gridState.invertedSelection&&this._mxObjects.length>0&&mendix.lang.itemCount(this._selectedGuids)===0){this._selectedGuids[this._mxObjects[0].getGuid()]=this._mxObjects[0];setTimeout(_1.hitch(this,function(){this.shareSelected();}),1000);}var $=mxui.dom.create,_8=$("#"),_9=this._itemCache.length,_a=0,_b=false,_c=[],_d;for(var _e=0;_e<this._gridState.rows;++_e){var _f=$("div",{"class":this.cssmap.row});_8.appendChild(_f);for(var col=0;col<this._gridState.columns;++col){if(_a<this._mxObjects.length){if(_a>=this._itemCache.length){this._itemCache[_a]=new mxui.widget.TemplateGridItem({mxform:this.mxform,template:mx.ui.getTemplate(this.mxid,"content"),cssClass:this.cssmap.item});_b=true;}_d=this._itemCache[_a].domNode;_d.style.width=this._gridState.cellwidth;this.domData(_d,{gridrow:_a,mendixguid:this._mxObjects[_a].getGuid()});this.addFocusBox(_d);_f.appendChild(_d);if(this._selectedGuids[this._mxObjects[_a].getGuid()]){this.selectRow(_d);}else{this.deselectRow(_d);}}else{var _10=$("div",{"class":this.cssmap.empty},$("br"));_f.appendChild(_10);}++_a;}if(_a>=this._mxObjects.length&&!this._gridState.showemptyrows){break;}}mxui.dom.empty(this.itemNode);this.itemNode.appendChild(_8);for(_a=0;_a<this._mxObjects.length;++_a){var _11=new mendix.lib.MxContext({mxcontext:this.mxcontext});_11.setObject(this._mxObjects[_a]);if(_a>=_9){this._itemCache[_a].startup();}this._itemCache[_a].set("disabled",false);_c.push(_1.hitch(this._itemCache[_a],"applyContext",_11));}for(_a=this._mxObjects.length;_a<this._itemCache.length;_a++){this._itemCache[_a].set("disabled",true);}mendix.lang.collect(_c,function(){if(_b){this.mxform.resize();}},this);},filterSelected:function(){var _12={};for(var _13 in this._selectedGuids){var obj=this._dataSource.getObject(_13);if(obj){_12[_13]=obj;}}this._selectedGuids=_12;},deselectGridRows:function(){for(var i=0,l=this._itemCache.length;i<l;++i){this.deselectRow(this._itemCache[i].domNode);}},_clearSelection:function(){this._selectedGuids={};},_getEntity:function(_14){return mendix.lang.firstKey(_14);},_getSelectedGuids:function(){return mendix.lang.objectToArray(this._selectedGuids);},_getCurrentGuid:function(){return mendix.lang.firstKey(this._selectedGuids);},_addObjectToSelection:function(obj){var _15=obj.getGuid();this._selectedGuids[_15]=obj;},_removeObjectFromSelection:function(obj){delete this._selectedGuids[obj.getGuid()];},_getObjectFromNode:function(_16){return this._mxObjects[this.domData(_16,"gridrow")];}});});