
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/TemplateGrid",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget.TemplateGrid");mxui.widget.declare("mxui.widget.TemplateGrid",{mixins:[_2._TemplatedMixin,_2._Container,_2._Contained,mxui.mixin._Grid,mxui.mixin._Internationalized,mxui.mixin._Contextable,mxui.mixin._Scriptable,mxui.mixin._Pluggable],inputargs:{entity:"",schema:"",contenturl:"",startdormant:false,templateurl:"",templateclass:"Style1",autoconfig:false,nested:false,xpathConstraint:"",reqConstraints:"",selected:null,reference:"",useContext:false},cssmap:mxui.widget.createCSSMap("mx-templategrid",{row:"row",item:"item",empty:"empty"}),constructor:function(){this.subClass=this.cssmap.baseClass;this.templateString=_1.cache("mxui.widget","templates/TemplateGrid.html","<div class=\"${baseClass} mx-templategrid\">\n    <div class=\"${baseClass}-searchbar clearfix\" dojoAttachPoint=\"searchNode\" focusIndex=\"0\">\n        <div class=\"${baseClass}-search-controls\" focusIndex=\"1\" dojoAttachPoint=\"searchControlNode\"></div>\n        <div class=\"${baseClass}-search-inputs\" focusIndex=\"0\" dojoAttachPoint=\"searchArgumentNode\"></div>\n        <div class=\"${baseClass}-search-message\" dojoAttachPoint=\"messageNode\"></div>\n    </div>\n    \n    <div class=\"${baseClass}-controlbar clearfix\" dojoAttachPoint=\"controlNode\" focusIndex=\"1\">\n        <div class=\"${baseClass}-pagingbar\" dojoAttachPoint=\"pagingBarNode\"></div>\n        <div class=\"${baseClass}-toolbar\" dojoAttachPoint=\"toolBarNode\"></div>\n    </div>\n\t\n    <div class=\"${baseClass}-content\" dojoAttachPoint=\"contentNode\" focusIndex=\"2\">\n        <div class=\"${subClass}-content-wrapper\" dojoAttachPoint=\"itemNode\"></div>\n    </div>\n</div>\n");this.contentUrl="";this.templateurl="";this.entity="";this.templateclass="Style1";this.autoconfig=false;this.xpathConstraint="";this.startdormant=false;this.nested=false;this.selected=null;this.domNode=null;this.pagingBarNode=null;this.searchNode=null;this.toolBarNode=null;this.itemNode=null;this.searchButton=null;this.resetButton=null;this.returnValue=null;this.gridfooterNode=null;var _4=_1.hitch;var _5=_1.removeClass;var _6=_1.addClass;var _7=null;var _8=null;var _9=[];var _a={};var _b=[];var _c=[];var _d=[];var _e=[];var _f={selectable:true,selectionmode:"single",searchbar:true,controlbar:true,pagingbar:true,inDenial:false,searchBarVisible:false,searchBarTogglable:true,xpathConstraint:"",dynamicconstraint:"",loading:false,invertedSelection:false};this.postCreateSpecific=function(){if(this.fetchMetaObject()){this.setupGridConfig();this.setupGridState();this.buildSearchBar();this.buildControlBar();this.buildToolBar();this.buildPagingBar();this.connectEvents();this.setupDevMode();this.setupDataSource();this.loaded();}};var _10=function(tr){tr.style.display="";var _11=tr.getElementsByTagName("div");for(var i=0;i<_11.length;i++){_11[i].innerHTML="&nbsp";}};this.setupGridStateSpecific=function(){_f.columns=_8.gridSetting("columns");_f.rows=_8.gridSetting("rows");_f.cellwidth=String(_1.isIE?(100/_f.columns-0.05):(100/_f.columns))+"%";};this.connectEvents=function(_12){var _13=this;this.own(_1.on(this.itemNode,"."+this.cssmap.item+":click",function(e){_13._eventGridItemClicked(e,this);}));var _14=function(e){_13.eventActionBindingHandler(this,e.type);};for(var _15 in _8.gridActionBindings()){this.own(_1.on(this.itemNode,"."+this.cssmap.item+":"+_15.replace(/^on/,""),_14));}};this.selectRow=function(row){_f.invertedSelection?_5(row,"selected"):_6(row,"selected");};this.deselectRow=function(row){!_f.invertedSelection?_5(row,"selected"):_6(row,"selected");};this.fillGrid=function(){_b=_7.getObjects();if(_f.selectfirst&&!_f.invertedSelection&&_b.length>0&&mendix.lang.itemCount(_a)===0){_a[_b[0].getGuid()]=_b[0];setTimeout(_1.hitch(this,function(){this.shareSelected();}),1000);}var $=mxui.dom.create,_16=$("#"),_17=_c.length,_18=0,_19=false,_1a=[],_1b;for(var row=0;row<_f.rows;++row){var _1c=$("div",{"class":this.cssmap.row});_16.appendChild(_1c);for(var col=0;col<_f.columns;++col){if(_18<_b.length){if(_18>=_c.length){_c[_18]=new mxui.widget.TemplateGridItem({mxform:this.mxform,template:mx.ui.getTemplate(this.mxid,"content"),cssClass:this.cssmap.item});_19=true;}_1b=_c[_18].domNode;_1b.style.width=_f.cellwidth;this.domData(_1b,{gridrow:_18,mendixguid:_b[_18].getGuid()});this.addFocusBox(_1b);_1c.appendChild(_1b);if(_a[_b[_18].getGuid()]){this.selectRow(_1b);}else{this.deselectRow(_1b);}}else{var _1d=$("div",{"class":this.cssmap.empty},$("br"));_1c.appendChild(_1d);}++_18;}if(_18>=_b.length&&!_f.showemptyrows){break;}}mxui.dom.empty(this.itemNode);this.itemNode.appendChild(_16);for(_18=0;_18<_b.length;++_18){var _1e=new mendix.lib.MxContext({mxcontext:this.mxcontext});_1e.setObject(_b[_18]);if(_18>=_17){_c[_18].startup();}_c[_18].set("disabled",false);_1a.push(_1.hitch(_c[_18],"applyContext",_1e));}for(_18=_b.length;_18<_c.length;_18++){_c[_18].set("disabled",true);}mendix.lang.collect(_1a,function(){if(_19){this.mxform.resize();}},this);};this.actReloadGrid=function(_1f){var _20=this;_7.refresh(function(){_20.refreshGrid();_1f&&_1f();});};this.refreshGrid=function(){this.updatePagingStatus();this.fillGrid();this.resizeGrid();};this._eventGridItemClicked=function(e,_21){if(!_f.selectable){return;}var _22=this.domData(_21,"mendixguid");if(_22){if(_f.selectionmode=="simplemulti"){if(_a[_22]){delete _a[_22];this.deselectRow(_21);}else{_a[_22]=_7.getObject(_22);this.selectRow(_21);}}else{if(_f.selectionmode=="multi"&&(_1.isMac&&e.metaKey||e.ctrlKey)){if(_a[_22]){delete _a[_22];this.deselectRow(_21);}else{_a[_22]=_7.getObject(_22);this.selectRow(_21);}}else{var _23=(_a[_22]==null);this.deselectAll();if(_23){_a[_22]=_7.getObject(_22);this.selectRow(_21);}}}this.shareSelected();}else{logger.error(this.id+"._eventGridItemClicked : Can't find matching guid for item");}};this.filterSelected=function(){var _24={};for(var _25 in _a){var obj=_7.getObject(_25);if(obj){_24[_25]=obj;}}_a=_24;};this.contextUpdate=function(){if(!_f.inDenial){_7.update(_4(this,"actReloadGrid"));}};this.actCleanDS=function(_26){this._clearSelection();_7.clean(_26);};this.resumed=function(){this.setUpdateInterval();};this.suspended=function(){this.clearInterval();};this.deselectGridRows=function(){for(var i=0,l=_c.length;i<l;++i){this.deselectRow(_c[i].domNode);}};this._clearSelection=function(){_a={};};this._getEntity=function(_27){return mendix.lang.firstKey(_27);};this._getGridConfig=function(){return _8;};this._setGridConfig=function(v){_8=v;};this._getGridState=function(){return _f;};this._getSelectedGuids=function(){return mendix.lang.objectToArray(_a);};this._getCurrentGuid=function(){return mendix.lang.firstKey(_a);};this._setDataSource=function(_28){_7=_28;};this._addObjectToSelection=function(obj){var _29=obj.getGuid();_a[_29]=obj;};this._getDataSource=function(){return _7;};this._setDataSource=function(v){_7=v;};this._getObjectFromNode=function(_2a){return _b[this.domData(_2a,"gridrow")];};this.clearInterval=function(){if(_f.update!=null){clearInterval(_f.update);}};}});_1.declare("mxui.widget.TemplateGridItem",mxui.widget._WidgetBase,{cssClass:"",template:null,root:null,buildRendering:function(){this.domNode=mxui.dom.div({"class":this.cssClass});if(this.template){this.domNode.appendChild(this.template);}},startup:function(){var _2b=this.parseContent(this.domNode,{schema:"",ignoreUpdates:true});this.root=_2b[0]||null;},_setDisabledAttr:function(_2c){this.root&&this.root.set("disabled",_2c);}});});