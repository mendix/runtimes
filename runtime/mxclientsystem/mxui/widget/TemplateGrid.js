
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/TemplateGrid",["dojo","dijit","dojox","dojo/require!mxui/widget/_Grid,mxui/widget/TemplateGridItem"],function(_1,_2,_3){_1.provide("mxui.widget.TemplateGrid");_1.require("mxui.widget._Grid");_1.require("mxui.widget.TemplateGridItem");_1.declare("mxui.widget.TemplateGrid",mxui.widget._Grid,{templateString:_1.cache("mxui.widget","templates/TemplateGrid.html","<div class=\"${baseClass} mx-templategrid\">\n    <div class=\"${baseClass}-searchbar clearfix\" dojoAttachPoint=\"searchNode\" focusIndex=\"0\">\n        <div class=\"${baseClass}-search-controls\" focusIndex=\"1\" dojoAttachPoint=\"searchControlNode\"></div>\n        <div class=\"${baseClass}-search-inputs\" focusIndex=\"0\" dojoAttachPoint=\"searchArgumentNode\"></div>\n        <div class=\"${baseClass}-search-message\" dojoAttachPoint=\"messageNode\"></div>\n    </div>\n    \n    <div class=\"${baseClass}-controlbar clearfix\" dojoAttachPoint=\"controlNode\" focusIndex=\"1\">\n        <div class=\"${baseClass}-pagingbar\" dojoAttachPoint=\"pagingBarNode\"></div>\n        <div class=\"${baseClass}-toolbar\" dojoAttachPoint=\"toolBarNode\"></div>\n    </div>\n\t\n    <div class=\"${baseClass}-content\" dojoAttachPoint=\"contentNode\" focusIndex=\"2\">\n        <div class=\"${subClass}-content-wrapper\" dojoAttachPoint=\"itemNode\"></div>\n    </div>\n</div>\n"),subClass:"mx-templategrid",cssmap:mxui.widget.createCSSMap("mx-templategrid",{row:"row",item:"item",empty:"empty"}),itemNode:null,_mxObjects:[],_itemCache:[],_selectedGuids:{},constructor:function(){this._mxObjects=[];this._itemCache=[];this._selectedGuids={};this._gridState={selectable:true,selectionmode:"single",searchbar:true,controlbar:true,pagingbar:true,inDenial:false,searchBarVisible:false,searchBarTogglable:true,xpathConstraint:"",dynamicconstraint:"",loading:false,invertedSelection:false};},postCreate:function(){this.inherited(arguments);if(this.fetchMetaObject()){this.setupGridConfig();this.setupGridState();this.buildSearchBar();this.buildControlBar();this.buildToolBar();this.buildPagingBar();this.connectEvents();this.setupDevMode();this.setupDataSource();this.loaded();}},setupGridState:function(){this.inherited(arguments);this._gridState.columns=this._gridConfig.gridSetting("columns");this._gridState.rows=this._gridConfig.gridSetting("rows");this._gridState.cellwidth=String(_1.isIE?(100/this._gridState.columns-0.05):(100/this._gridState.columns))+"%";},connectEvents:function(_4){var _5=this;this.own(_1.on(this.itemNode,"."+this.cssmap.item+":click",function(e){_5._eventGridItemClicked(e,this);}));var _6=function(e){_5.eventActionBindingHandler(this,e.type);};for(var _7 in this._gridConfig.gridActionBindings()){this.own(_1.on(this.itemNode,"."+this.cssmap.item+":"+_7.replace(/^on/,""),_6));}},selectRow:function(_8){this._gridState.invertedSelection?_1.removeClass(_8,"selected"):_1.addClass(_8,"selected");},deselectRow:function(_9){!this._gridState.invertedSelection?_1.removeClass(_9,"selected"):_1.addClass(_9,"selected");},fillGrid:function(){this._mxObjects=this._dataSource.getObjects();if(this._gridState.selectfirst&&!this._gridState.invertedSelection&&this._mxObjects.length>0&&mendix.lang.itemCount(this._selectedGuids)===0){this._selectedGuids[this._mxObjects[0].getGuid()]=this._mxObjects[0];setTimeout(_1.hitch(this,function(){this.shareSelected();}),1000);}var $=mxui.dom.create,_a=$("#"),_b=this._itemCache.length,_c=0,_d=false,_e=[],_f;for(var row=0;row<this._gridState.rows;++row){var _10=$("div",{"class":this.cssmap.row});_a.appendChild(_10);for(var col=0;col<this._gridState.columns;++col){if(_c<this._mxObjects.length){if(_c>=this._itemCache.length){this._itemCache[_c]=new mxui.widget.TemplateGridItem({mxform:this.mxform,template:mx.ui.getTemplate(this.mxid,"content"),cssClass:this.cssmap.item});_d=true;}_f=this._itemCache[_c].domNode;_f.style.width=this._gridState.cellwidth;this.domData(_f,{gridrow:_c,mendixguid:this._mxObjects[_c].getGuid()});this.addFocusBox(_f);_10.appendChild(_f);if(this._selectedGuids[this._mxObjects[_c].getGuid()]){this.selectRow(_f);}else{this.deselectRow(_f);}}else{var _11=$("div",{"class":this.cssmap.empty},$("br"));_10.appendChild(_11);}++_c;}if(_c>=this._mxObjects.length&&!this._gridState.showemptyrows){break;}}mxui.dom.empty(this.itemNode);this.itemNode.appendChild(_a);for(_c=0;_c<this._mxObjects.length;++_c){var _12=new mendix.lib.MxContext({mxcontext:this.mxcontext});_12.setObject(this._mxObjects[_c]);if(_c>=_b){this._itemCache[_c].startup();}this._itemCache[_c].set("disabled",false);_e.push(_1.hitch(this._itemCache[_c],"applyContext",_12));}for(_c=this._mxObjects.length;_c<this._itemCache.length;_c++){this._itemCache[_c].set("disabled",true);}mendix.lang.collect(_e,function(){if(_d){this.mxform.resize();}},this);},actReloadGrid:function(_13){var _14=this;this._dataSource.refresh(function(){_14.refreshGrid();_13&&_13();});},refreshGrid:function(){this.updatePagingStatus();this.fillGrid();this.resizeGrid();},filterSelected:function(){var _15={};for(var _16 in this._selectedGuids){var obj=this._dataSource.getObject(_16);if(obj){_15[_16]=obj;}}this._selectedGuids=_15;},contextUpdate:function(){if(!this._gridState.inDenial){this._dataSource.update(_1.hitch(this,"actReloadGrid"));}},actCleanDS:function(_17){this._clearSelection();this._dataSource.clean(_17);},resumed:function(){this.setUpdateInterval();},suspended:function(){this.clearInterval();},deselectGridRows:function(){for(var i=0,l=this._itemCache.length;i<l;++i){this.deselectRow(this._itemCache[i].domNode);}},clearInterval:function(){if(this._gridState.update!=null){clearInterval(this._gridState.update);}},_eventGridItemClicked:function(e,_18){if(!this._gridState.selectable){return;}var _19=this.domData(_18,"mendixguid");if(_19){if(this._gridState.selectionmode=="simplemulti"){if(this._selectedGuids[_19]){delete this._selectedGuids[_19];this.deselectRow(_18);}else{this._selectedGuids[_19]=this._dataSource.getObject(_19);this.selectRow(_18);}}else{if(this._gridState.selectionmode=="multi"&&(_1.isMac&&e.metaKey||e.ctrlKey)){if(this._selectedGuids[_19]){delete this._selectedGuids[_19];this.deselectRow(_18);}else{this._selectedGuids[_19]=this._dataSource.getObject(_19);this.selectRow(_18);}}else{var _1a=(this._selectedGuids[_19]==null);this.deselectAll();if(_1a){this._selectedGuids[_19]=this._dataSource.getObject(_19);this.selectRow(_18);}}}this.shareSelected();}else{logger.error(this.id+"._eventGridItemClicked : Can't find matching guid for item");}},_clearSelection:function(){this._selectedGuids={};},_getEntity:function(_1b){return mendix.lang.firstKey(_1b);},_getSelectedGuids:function(){return mendix.lang.objectToArray(this._selectedGuids);},_getCurrentGuid:function(){return mendix.lang.firstKey(this._selectedGuids);},_addObjectToSelection:function(obj){var _1c=obj.getGuid();this._selectedGuids[_1c]=obj;},_getObjectFromNode:function(_1d){return this._mxObjects[this.domData(_1d,"gridrow")];}});});