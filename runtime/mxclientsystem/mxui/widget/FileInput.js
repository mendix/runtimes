
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/FileInput",["mxui/widget/Button","mxui/widget/_WidgetBase","mxui/dom","mendix/lang","mendix/lib/ConnectionError","mendix/lib/Upload","mendix/logger","dijit/focus","dojo/dom-class","dojo/keys","dojo/_base/array","dojo/_base/declare","dojo/_base/event","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){var _f=_c(_2,{declaredClass:"mxui.widget.FileInput",input:null,maxFileSize:0,restrictions:"",accept:"",uploadable:false,downloadable:false,target:"internal",_allowedExts:null,_labelNode:null,_uploadButton:null,_formNode:null,_rowNode:null,_errNode:null,_hasError:false,_selectState:"none",_emptyLabel:"...",buildRendering:function(){var $=_3.create,_10=window.mx.ui.getProfile()==="desktop";if(_10){this._sendFile=this._sendFileReal;}this.domNode=$("div",{"class":"mx-fileinput"});if(this.uploadable){if(_10){var _11=this._uploadButton=new _1({caption:window.mx.ui.translate("mxui.widget.MxFormView","upload"),cssClasses:["mx-fileinput-upload-button"]});this.domNode.appendChild($("#",this._labelNode=$("input",{"class":"form-control mx-wrapped-label",type:"text",readonly:"readonly",value:this._emptyLabel})," ",this._formNode=$("form",{"class":"mx-wrapped-form",enctype:"multipart/form-data",method:"POST"},this.input=$("input",{"class":"mx-wrapped-input",type:"file",name:"mxdocument",accept:this.accept,tabindex:-1}),_11.domNode)));this.connect(this._uploadButton.domNode,"focus",function(){_9.add(this._labelNode,"mx-focus");});this.connect(this._uploadButton.domNode,"blur",function(){_9.remove(this._labelNode,"mx-focus");});this.connect(this._labelNode,"click",function(){_8.focus(this._uploadButton.domNode);});this.connect(this._formNode,"keyup",function(e){if(e.keyCode==_a.DELETE||e.keycode==_a.BACKSPACE){this._reset();_d.stop(e);}});}else{this.domNode.appendChild(this._formNode=$("form",{"class":"mx-normal-form",enctype:"multipart/form-data",method:"POST"},this.input=$("input",{type:"file",name:"mxdocument",accept:this.accept})));}this.connect(this._formNode,"submit",function(){return false;});this.connect(this.input,"click",function(){this._selectState="selecting";});this.connect(this.input,"change","_handleFileSelected");}if(this.downloadable){var _12=this._downloadButton=new _1({caption:window.mx.ui.translate("mxui.widget.MxFormView","download"),onClick:_e.hitch(this,"_handleDownloadClick"),cssClasses:["mx-fileinput-download-button"],disabled:true});this.domNode.appendChild($("#"," ",_12.domNode));}},postCreate:function(){this._allowedExts=this.restrictions.toLowerCase().split(";");this.listen("save",this._sendFile);},startup:function(){var _13=this.domNode.parentNode;if(_13.nodeName=="TD"){this._rowNode=_13.parentNode;}},update:function(obj,_14){this._mxObject=obj;this._reset();this.set("disabled",!obj);_14&&_14();},updateDisabled:function(){this.inherited(arguments);var _15=this.checkDisabled();if(this.uploadable){if(this._uploadButton){this._uploadButton.set("disabled",_15);}if(_15){this.input.setAttribute("disabled","disabled");}else{this.input.removeAttribute("disabled");}}if(this._downloadButton){var obj=this._mxObject;this._downloadButton.set("disabled",!obj||!obj.get("HasContents"));}},addError:function(msg){this.removeError();if(msg){this._errNode=_3.create("div",{"class":"alert alert-danger"},msg);this.domNode.parentNode.appendChild(this._errNode);this.mxform.resize();}if(this._rowNode){_9.add(this._rowNode,"error");}if(this.validator){this.validator.addNotification();}},removeError:function(){var _16=this._errNode;if(_16){_16.parentNode.removeChild(_16);this._errNode=null;}if(this._rowNode){_9.remove(this._rowNode,"error");}if(this.validator&&this._hasError){this.validator.removeNotification();this._hasError=false;}},checkDisabled:function(){return this.inherited(arguments)||!this._mxObject;},isValidFile:function(){return this.input.value&&this.isValidSize()&&this.isValidExtension();},isValidSize:function(){return !this.input.files||!this.maxFileSize||this.getFileSize()<=this.maxFileSize;},getFileSize:function(){return this.input.files[0].size/1048576;},isValidExtension:function(){if(this.restrictions===""){return true;}var _17=this.input.value;var _18=_17.lastIndexOf(".");var _19=_17.substring(_18+1).toLowerCase();return _18>=0&&_b.indexOf(this._allowedExts,_19)>=0;},uninitialize:function(){this._uploadButton&&this._uploadButton.destroy();this._downloadButton&&this._downloadButton.destroy();},_handleDownloadClick:function(e){this._downloadFile();_d.stop(e);},_handleFileSelected:function(e){this._selectState="selected";if(!this.input.value){this.removeError();if(this._labelNode){this._labelNode.value=this._emptyLabel;}}else{if(!this.isValidExtension()){this.addError(window.mx.ui.translate("mendix.widget.MxFileinput","incorrect_extension",this.restrictions.replace(/;/g,", ")));}else{if(!this.isValidSize()){this.addError(window.mx.ui.translate("mendix.widget.MxFileinput","file_too_large",[this.getFileSize().toFixed(2),this.maxFileSize.toString()]));}else{this.removeError();if(this._labelNode){this._labelNode.value=this.input.value.replace(/^.*\//,"");}}}}},_reset:function(){this.removeError();if(this._formNode){this._formNode.reset();}if(this._labelNode){this._labelNode.value=this._emptyLabel;}},_sendFile:function(_1a){var _1b=this,_1c=function(){return _1b._selectState!=="selecting";};var pid=window.mx.ui.showProgress();_4.waitUntilPredicateHolds(_1c,function(){window.mx.ui.hideProgress(pid);_1b._sendFileReal(_1a);},[100,200,500,500,500,500]);},_sendFileReal:function(_1d){if(this._selectState==="none"||this.input.value===""||!this.isValidFile()){_1d();return;}var _1e=this,pid;var _1f=new _6({form:this._formNode,width:this.thumbnailWidth,height:this.thumbnailHeight,objectGuid:this._mxObject.getGuid(),maxFileSize:this.maxFileSize,callback:function(){_1e._selectState="none";_1e._getObject(_1d,function(e){_7.error(this.id+"._sendFileReal: "+e.message);window.mx.onError(e);});},error:function(e){_1e._selectState="selected";if(e){_7.error(_1e.id+"._sendFileReal: "+e.message);window.mx.onError(e);}else{_7.error(_1e.id+"._sendFileReal: upload error");window.mx.onError(new _5("Connection error"));}},startUpload:function(){pid=window.mx.ui.showProgress();},showProgress:function(_20){},finishUpload:function(){window.mx.ui.hideProgress(pid);}});_1f.upload();},_getObject:function(_21,_22){window.mx.data.get({guid:this._mxObject.getGuid(),noCache:true,callback:_21,error:_22});},_downloadFile:function(){if(this._mxObject){window.mx.ui.downloadFile({mxobject:this._mxObject,target:this.target});}}});return _f;});