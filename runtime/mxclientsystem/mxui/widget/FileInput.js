
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/FileInput",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget.FileInput");_1.declare("mxui.widget.FileInput",mxui.widget._WidgetBase,{input:null,maxFileSize:0,restrictions:"",accept:"",uploadable:false,downloadable:false,target:"internal",_allowedExts:null,_labelNode:null,_uploadButton:null,_formNode:null,_rowNode:null,_errNode:null,_hasError:false,_selectState:"none",_emptyLabel:"...",buildRendering:function(){var $=mxui.dom.create,_4=mx.ui.getProfile()==="desktop";if(_4){this._sendFile=this._sendFileReal;}this.domNode=$("div",{"class":"mx-fileinput"});if(this.uploadable){if(_4){var _5=this._uploadButton=new mxui.widget.Button({caption:mx.ui.translate("mxui.widget.MxFormView","upload"),cssClasses:["mx-fileinput-upload-button"]});this.domNode.appendChild($("#",this._labelNode=$("input",{"class":"form-control mx-wrapped-label",type:"text",readonly:"readonly",value:this._emptyLabel})," ",this._formNode=$("form",{"class":"mx-wrapped-form",enctype:"multipart/form-data",method:"POST"},this.input=$("input",{"class":"mx-wrapped-input",type:"file",name:"mxdocument",accept:this.accept,tabindex:-1}),_5.domNode)));this.connect(this._uploadButton.domNode,"focus",function(){_1.addClass(this._labelNode,"mx-focus");});this.connect(this._uploadButton.domNode,"blur",function(){_1.removeClass(this._labelNode,"mx-focus");});this.connect(this._labelNode,"click",function(){_2.focus(this._uploadButton.domNode);});this.connect(this._formNode,"keyup",function(e){if(e.keyCode==_1.keys.DELETE||e.keycode==_1.keys.BACKSPACE){this._reset();_1.stopEvent(e);}});}else{this.domNode.appendChild(this._formNode=$("form",{"class":"mx-normal-form",enctype:"multipart/form-data",method:"POST"},this.input=$("input",{type:"file",name:"mxdocument",accept:this.accept})));}this.connect(this._formNode,"submit",function(){return false;});this.connect(this.input,"click",function(){this._selectState="selecting";});this.connect(this.input,"change","_handleFileSelected");}if(this.downloadable){var _6=this._downloadButton=new mxui.widget.Button({caption:mx.ui.translate("mxui.widget.MxFormView","download"),onClick:_1.hitch(this,"_handleDownloadClick"),cssClasses:["mx-fileinput-download-button"],disabled:true});this.domNode.appendChild($("#"," ",_6.domNode));}},postCreate:function(){this._allowedExts=this.restrictions.toLowerCase().split(";");this.listen("save",this._sendFile);},startup:function(){var _7=this.domNode.parentNode;if(_7.nodeName=="TD"){this._rowNode=_7.parentNode;}},update:function(_8,_9){this._mxObject=_8;this._reset();this.set("disabled",!_8);_9&&_9();},updateDisabled:function(){this.inherited(arguments);var _a=this.checkDisabled();if(this.uploadable){if(this._uploadButton){this._uploadButton.set("disabled",_a);}if(_a){this.input.setAttribute("disabled","disabled");}else{this.input.removeAttribute("disabled");}}if(this._downloadButton){var _b=this._mxObject;this._downloadButton.set("disabled",!_b||!_b.get("HasContents"));}},addError:function(_c){this.removeError();if(_c){this._errNode=mxui.dom.create("div",{"class":"alert alert-danger"},_c);this.domNode.parentNode.appendChild(this._errNode);this.mxform.resize();}if(this._rowNode){_1.addClass(this._rowNode,"error");}if(this.validator){this.validator.addNotification();}},removeError:function(){var _d=this._errNode;if(_d){_d.parentNode.removeChild(_d);this._errNode=null;}if(this._rowNode){_1.removeClass(this._rowNode,"error");}if(this.validator&&this._hasError){this.validator.removeNotification();this._hasError=false;}},checkDisabled:function(){return this.inherited(arguments)||!this._mxObject;},isValidFile:function(){return this.input.value&&this.isValidSize()&&this.isValidExtension();},isValidSize:function(){return !this.input.files||!this.maxFileSize||this.getFileSize()<=this.maxFileSize;},getFileSize:function(){return this.input.files[0].size/1048576;},isValidExtension:function(){if(this.restrictions===""){return true;}var _e=this.input.value;var _f=_e.lastIndexOf(".");var _10=_e.substring(_f+1).toLowerCase();return _f>=0&&_1.indexOf(this._allowedExts,_10)>=0;},uninitialize:function(){this._uploadButton&&this._uploadButton.destroy();this._downloadButton&&this._downloadButton.destroy();},_handleDownloadClick:function(e){this._downloadFile();_1.stopEvent(e);},_handleFileSelected:function(e){this._selectState="selected";if(!this.input.value){this.removeError();if(this._labelNode){this._labelNode.value=this._emptyLabel;}}else{if(!this.isValidExtension()){this.addError(mx.ui.translate("mendix.widget.MxFileinput","incorrect_extension",this.restrictions.replace(/;/g,", ")));}else{if(!this.isValidSize()){this.addError(mx.ui.translate("mendix.widget.MxFileinput","file_too_large",[this.getFileSize().toFixed(2),this.maxFileSize.toString()]));}else{this.removeError();if(this._labelNode){this._labelNode.value=this.input.value.replace(/^.*\//,"");}}}}},_reset:function(){this.removeError();if(this._formNode){this._formNode.reset();}if(this._labelNode){this._labelNode.value=this._emptyLabel;}},_sendFile:function(_11){var _12=this,_13=function(){return _12._selectState!=="selecting";};var pid=mx.ui.showProgress();mendix.lang.waitUntilPredicateHolds(_13,function(){mx.ui.hideProgress(pid);_12._sendFileReal(_11);},[100,200,500,500,500,500]);},_sendFileReal:function(_14){if(this._selectState==="none"||this.input.value===""||!this.isValidFile()){_14();return;}var _15=this,pid;var _16=new mendix.lib.Upload({form:this._formNode,width:this.thumbnailWidth,height:this.thumbnailHeight,objectGuid:this._mxObject.getGuid(),maxFileSize:this.maxFileSize,callback:function(){_15._selectState="none";_15._getObject(_14,function(e){logger.error(this.id+"._sendFileReal: "+e.message);mx.onError(e);});},error:function(e){_15._selectState="selected";if(e){logger.error(_15.id+"._sendFileReal: "+e.message);mx.onError(e);}else{logger.error(_15.id+"._sendFileReal: upload error");mx.onError(new mendix.lib.ConnectionError("Connection error"));}},startUpload:function(){pid=mx.ui.showProgress();},showProgress:function(_17){},finishUpload:function(){mx.ui.hideProgress(pid);}});_16.upload();},_getObject:function(_18,_19){mx.data.get({guid:this._mxObject.getGuid(),noCache:true,callback:_18,error:_19});},_downloadFile:function(){if(this._mxObject){mx.ui.downloadFile({mxobject:this._mxObject,target:this.target});}}});});