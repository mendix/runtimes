/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
require({cache:{"url:mxui/widget/templates/DataGrid.html":"<div class=\"${baseClass} mx-datagrid\">\n    <div class=\"${baseClass}-searchbar clearfix\" dojoAttachPoint=\"searchNode\" focusIndex=\"0\">\n        <div class=\"${baseClass}-search-controls\" focusIndex=\"1\" dojoAttachPoint=\"searchControlNode\"></div>\n        <div class=\"${baseClass}-search-inputs\" focusIndex=\"0\" dojoAttachPoint=\"searchArgumentNode\"></div>\n        <div class=\"${baseClass}-search-message\" dojoAttachPoint=\"messageNode\"></div>\n    </div>\n    \n    <div class=\"${baseClass}-controlbar clearfix\" dojoAttachPoint=\"controlNode\" focusIndex=\"1\">\n        <div class=\"${baseClass}-pagingbar\" dojoAttachPoint=\"pagingBarNode\"></div>\n        <div class=\"${baseClass}-toolbar\" dojoAttachPoint=\"toolBarNode\"></div>\n    </div>\n        \n    <div class=\"${baseClass}-content\" dojoAttachPoint=\"contentNode\" focusIndex=\"2\">\n        <div class=\"${subClass}-content-wrapper\" dojoAttachPoint=\"tableWrapper\">\n            <table class=\"table table-bordered ${subClass}-head-table\" dojoAttachPoint=\"headTable\">\n                <colgroup dojoAttachPoint=\"headTableGroupNode\"></colgroup>\n                <thead class=\"${subClass}-head\" dojoAttachPoint=\"gridHeadNode\"></thead>\n            </table>\n            <table class=\"table table-striped table-bordered ${subClass}-body-table\" dojoAttachPoint=\"gridTable\">\n                <colgroup dojoAttachPoint=\"bodyTableGroupNode\"></colgroup>\n                <tbody class=\"${subClass}-body\" dojoAttachPoint=\"gridBodyNode\"></tbody>\n                <tfoot class=\"${subClass}-foot\" dojoAttachPoint=\"gridFootNode\"></tfoot>\n            </table>\n        </div>\n    </div>\n</div>\n"}});define("mxui/widget/DataGrid",["mxui/widget/_Grid","mxui/widget","mxui/wm/focus","mxui/dom","mxui/lib/ColumnResizer","mendix/lang","mendix/logger","webcore/url-helpers","dojo/query","dojo/on","dojo/dom-class","dojo/_base/array","dojo/_base/lang","dojo/_base/declare","dojo/text!mxui/widget/templates/DataGrid.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){var _10=_e(_1,{declaredClass:"mxui.widget.DataGrid",templateString:_f,subClass:"mx-datagrid",cssmap:_2.createCSSMap("mx-datagrid",{sortText:"sort-text",sortIcon:"sort-icon",headCaption:"head-caption",headWrapper:"head-wrapper",columnResizer:"column-resizer",dataWrapper:"data-wrapper"}),readOnly:false,gridBodyNode:null,gridFootNode:null,_deferSyncQueue:0,_deferSyncCallback:null,_mxObjects:null,_gridColumnNodes:null,_gridRowNodes:null,_gridMatrix:null,_visibleColumns:null,_hiddenAggregates:null,constructor:function(){this._mxObjects=[];this._gridColumnNodes=[];this._gridRowNodes=[];this._gridMatrix=[];this._visibleColumns=[];this._hiddenAggregates=[];this._gridState={sortable:true,selectable:true,selectionmode:"single",searchbar:true,controlbar:true,pagingbar:true,inDenial:false,searchBarVisible:false,searchBarTogglable:true,xpathConstraint:"",loading:false,invertedSelection:false};},postCreate:function(){this.inherited(arguments);if(this._metaEntity){this._addFocusBoxForTable();this.setupScroll();this.buildGridBody();this.loadPlugins();this.doGridAttributes();this.triggerOnLoad();}this.loaded();},setColumnStyle:function(_11,_12){var _13=_12.display,_14=_13.align||"left";if(window.mx.ui.isRtl()){_14=(_14==="right"?"left":"right");}if(_13.cssStyle){_11.setAttribute("style",_13.cssStyle);}else{_11.removeAttribute("style");}_b.add(_11,[_12.name?"mx-name-"+_12.name:"","mx-"+_14+"-aligned"]);_b.add(_11,_13.cssClass);},buildGridRow:function(_15,_16){var $=_4.create,tr=$("tr",{"class":"mx-name-index-"+_16}),row;this.domData(tr,"gridrow",_16);row=_c.map(_15,function(_17,i){var td=$("td");this.domData(td,{row:_16,column:i,key:_17.tag});this.setColumnStyle(td,_17);td.appendChild($("div",{"class":this.cssmap.dataWrapper}));tr.appendChild(td);return td;},this);this._gridMatrix.push(row);return tr;},setNodeTitle:function(_18,_19){if(!_18){return;}var _1a=_4.text(_19||_18);_18.setAttribute("title",_d.trim(_1a));},gridbodyFillCell:function(_1b,_1c,_1d){var _1e;if(!_1c.has(_1d)){return "&nbsp;";}switch(_1b.render.toLowerCase()){case "icon":case "enumicon":var src=_1b.display.mapping[_1c.get2(_1d)];_1e=src?"<img src='"+_8.getStaticResourceUrlFromPath(src)+"'>":"";break;case "weblink":_1e=_1c.get2(_1d);break;default:var _1f=_1b.display,_20=_1f.dateFormat||"date";_1e=window.mx.parser.formatAttribute(_1c,_1d,{selector:_20.toLowerCase().replace("custom","date"),datePattern:_1f.format,groups:_1f.formatted,places:_1f.precision});_1e=_4.escapeString(_1e.replace(/\n/g," "));}return _1e||"&nbsp;";},disableRow:function(tr){tr.style.display="";this.domData(tr,"mendixguid",null);_c.forEach(tr.getElementsByTagName("td"),function(td){td.firstChild.innerHTML="&nbsp";td.setAttribute("title","");});},setupGridState:function(){this.inherited(arguments);this._gridState.sortable=this._gridConfig.gridSetting("sortable");},loadPlugins:function(){this.hideFootNode();if(this._gridState.editable){this.loadPlugin("GridEditor");_3.removeBox(this.contentNode);}var _21=this._gridConfig.getPlugins();for(var _22 in _21){this.loadPlugin(_22,_21[_22]);}},setupScroll:function(){var _23=this.headTable,_24=this.contentNode;this.connect(_24,"scroll",function(){_23.style.top=_24.scrollTop+"px";});},resize:function(box){this.inherited(arguments);this._resizer.recalculate();},buildGridBody:function(){var _25=this,$=_4.create,_26=this._gridConfig.gridAttributes(),_27=[],_28=[],row=$("tr",{"class":"mx-name-head-row"}),_29=$("div",{"class":this.cssmap.headCaption}),_2a=$("div",{"class":this.cssmap.headWrapper}),_2b={},_2c=this._gridConfig.getPlugins()["Calculations"]||{};_4.disableSelection(row);_c.forEach(this.getState("sortOptions",this._gridConfig.gridSetting("sortparams")),function(_2d){_2b[_2d[0]]=_2d;});_c.forEach(_26,function(_2e,i){var _2f=_2e.display.width,_30=_2e.tag in _2c,_31=_2f!=null&&(_2f=="0px"||_2f=="0%");if(_30){_28.push(_31);}if(!_31){this._visibleColumns.push(_2e);}},this);_c.forEach(_28,function(_32,i){if(_32){this._hiddenAggregates.push(i);}},this);_c.forEach(this._visibleColumns,function(_33,i){var _34=$("th");this.domData(_34,{datakey:_33.tag,index:i});this.setColumnStyle(_34,_33);var _35=$("span",{"class":this.cssmap.sortText});var _36=$("div",{"class":this.cssmap.sortIcon,style:"display: none"},_35);var _37=_2b[_33.tag];if(_37){var _38=_37[1];this.domData(_34,"sortorder",_38);_35.innerHTML=_38==="asc"?"&#9650;":"&#9660;";_36.style.display="";}var _39=_29.cloneNode(true);_39.innerHTML=_33.display.string||"&nbsp;";var _3a=_2a.cloneNode(true);_3a.appendChild(_36);_3a.appendChild(_39);_34.appendChild(_3a);this.setNodeTitle(_34,_39);var _3b=$("col",{style:"width:"+_33.display.width}),_3c=_3b.cloneNode(true);this.headTableGroupNode.appendChild(_3b);this.bodyTableGroupNode.appendChild(_3c);_27.push([_3b,_3c]);this._gridColumnNodes.push(_34);row.appendChild(_34);},this);this.gridHeadNode.appendChild(row);if(this._gridState.sortable){this.own(_a(this.gridHeadNode,"th:click",function(e){var key=_25.domData(this,"index");if(_26[key].sortable!==false){_25.eventColumnClicked(e,this);}}));}this._resizer=new _5({thNodes:_4.toArray(row.children),colNodes:_27,colUnits:_26[0].display.width.indexOf("%")>0?"%":"px",rtl:!this.isLeftToRight(),tableNode:this.headTable,gridNode:this.gridTable});if(this._gridState.showemptyrows){var _3d=this._gridConfig.gridSetting("rows");for(var i=0;i<_3d;i++){this.addNewRow();}}this.own(_a(this.gridBodyNode,"tr:click",function(e){_25.eventItemClicked(e,this);}));this.liveConnect(this.gridBodyNode,"onclick",{td:"eventCellClicked"});this.liveConnect(this.gridBodyNode,"onmouseover",{tr:"eventRowMouseOver"});this.liveConnect(this.gridBodyNode,"onmouseout",{tr:"eventRowMouseOut"});var _3e=function(e){_25.eventActionBindingHandler(this,e.type);};var _3f=this._gridConfig.gridActionBindings();for(var _40 in _3f){this.own(_a(this.gridBodyNode,"tr:"+_40.replace(/^on/,""),_3e));}},addNewRow:function(){var _41=this._visibleColumns,_42=this._gridConfig.gridSetting("rows"),_43=this._gridRowNodes.length;if(_43>_42){return null;}var tr=this.buildGridRow(_41,_43);this._gridRowNodes.push(tr);this.gridBodyNode.appendChild(tr);var box=this.getFocusBox(this.contentNode);box.add&&box.add(tr);return tr;},doGridAttributes:function(){var _44=this._visibleColumns;_c.forEach(_44,function(_45){var _46=_45.tag.split("/");if(_46.length==2||_46.length==4){_46.shift();}_45.attrs=_46;},this);},fillGrid:function(){this._mxObjects=this._dataSource.getObjects()||[];var _47=this._visibleColumns,_48=false,_49=(this._gridState.selectfirst&&!this._gridState.invertedSelection&&this._mxObjects.length>0&&!this._hasSelection());if(_49){this._addToSelection(this._mxObjects[0].getGuid());}this._shareSelection(this._metaEntity.getEntity());var _4a=this._mxObjects.length-this._gridRowNodes.length;if(_4a>0){while(_4a--){this.addNewRow();}_48=true;}else{if(_4a<0){_c.forEach(this._gridRowNodes.slice(this._mxObjects.length),function(_4b){_b.remove(_4b,"selected");if(this._gridState.showemptyrows){this.disableRow(_4b);}else{_4b.style.display="none";}},this);}}_c.forEach(this._mxObjects,function(_4c,i){var _4d=_4c.getGuid(),_4e=this._gridRowNodes[i];this.domData(_4e,"mendixguid",_4d);this._gridbodyFillRow(_4c,this._gridMatrix[i],_47);if(!this._isSelected(_4d)){this.deselectRow(_4e);}else{this.selectRow(_4e);}_4e.style.display="";},this);if(_48){this.mxform.resize();}},refreshGrid:function(){this.triggerPreRefresh();this.inherited(arguments);this.triggerOnRefresh();},triggerOnLoad:function(){this.triggerPluginEvent("onLoad");},triggerOnSync:function(){this.triggerPluginEvent("onSync");},triggerOnRefresh:function(){this.triggerPluginEvent("onRefresh");},triggerPreRefresh:function(){this.triggerPluginEvent("preRefresh");},triggerOnSearchChanged:function(){this.triggerPluginEvent("onSearchChanged");},actDeferSyncAction:function(_4f){if(this._deferSyncQueue===0){_4f&&_4f();}else{if(this._deferSyncCallback==null){this._deferSyncCallback=_4f;}else{}}},eventCellClicked:function(e){this.triggerPluginEvent("onCellClicked",e);},eventRowMouseOver:function(e){this.triggerPluginEvent("onRowMouseOver",e);},eventRowMouseOut:function(e){this.triggerPluginEvent("onRowMouseOut",e);},eventCellMouseOut:function(e){this.triggerPluginEvent("onCellMouseOut",e);},eventCellMouseOver:function(e){this.triggerPluginEvent("onCellMouseOver",e);},eventSelectRow:function(e){this.triggerPluginEvent("onSelectRow",e);},eventColumnClicked:function(e,_50){var _51=e.shiftKey;if(!_51){_c.forEach(this._gridColumnNodes,function(_52){_52.querySelector("."+this.cssmap.sortIcon).style.display="none";},this);}else{_4.clearSelection();}var _53=this.domData(_50,"datakey"),_54="asc";if(this.domData(_50,"sortorder")){_54=this.domData(_50,"sortorder");_54=(_54==="asc")?"desc":"asc";}this.domData(_50,"sortorder",_54);var _55=_50.querySelector("."+this.cssmap.sortText);_55.innerHTML=(_54==="asc"?"&#9650;":"&#9660;");_55.parentNode.style.display="";this._dataSource.setSortOptions(_53,_54,_51);if(this.constraintsFilled()){this._dataSource.refresh(_d.hitch(this,"refreshGrid"));}},deselectGridRows:function(){_c.forEach(this._gridRowNodes,function(_56){this.deselectRow(_56);},this);},getAggregates:function(){return this._dataSource.getAggregates();},actionExport:function(_57){if(this.constraintsFilled()){var _58=window.mx.ui.getProgress("",true);_58.start();this._dataSource.generateExport({params:_57,callback:function(){_58.stop();},error:function(e){_58.stop();window.mx.onError(e);}});}},actionInsertNewAtTop:function(_59){var _5a=this._getEntity(_59);if(_5a){this._insertNewFirstOrLast(_5a,_59[_5a],false);}},actionInsertNewAtBottom:function(_5b){var _5c=this._getEntity(_5b);if(_5c){this._insertNewFirstOrLast(_5c,_5b[_5c],true);}},getCellNode:function(_5d,key){var row=this._gridMatrix[_5d];if(row){for(var i=0;i<row.length;i++){if(this.domData(row[i],"key")===key){return row[i];}}}return null;},getMxObjectAtRow:function(_5e){return (this._mxObjects.length>=_5e)?this._mxObjects[_5e]:false;},getRowForMxObject:function(_5f){var _60=this._mxObjects;for(var i=0;i<_60.length;++i){if(_60[i].getGuid()===_5f.getGuid()){return i;}}},getEntityProperties:function(){return this._visibleColumns;},getHiddenAggregates:function(){return this._hiddenAggregates.slice();},getActionProperties:function(_61,_62){var _63=this._gridConfig.dataEntityConfigs(),act=null;if(_63[_61]){act=_63[_61][_62];}return act;},getCurrentGridSize:function(){return this._mxObjects.length;},getGridNodeHash:function(){return this._gridMatrix;},getCurrentXPath:function(){var _64=this._dataSource?this._dataSource.getCurrentXPath()||"":"";return _64+this._gridState.xpathConstraint;},preventUpdates:function(){this._gridState.inDenial=true;},acceptUpdates:function(){this._gridState.inDenial=false;},acceptingUpdates:function(){return !this._gridState.inDenial;},updateMxObject:function(_65,_66){var row=this.getRowForMxObject(_65);if(!row){this._gridbodyFillRow(_65,this._gridMatrix[row],this._visibleColumns);}_66&&_66();},showFootNode:function(){this.gridFootNode.style.display="";},hideFootNode:function(){this.gridFootNode.style.display="none";},addToSyncDeferQueue:function(){this._deferSyncQueue++;},removeFromSyncDeferQueue:function(){this._deferSyncQueue--;if(this._deferSyncQueue===0){if(this._deferSyncCallback!=null){this._deferSyncCallback();this._deferSyncCallback=null;}else{}}},uninitialize:function(){this._resizer.destroy();this.triggerPluginEvent("onDestroy");this.inherited(arguments);},_setSelectableAttr:function(_67){this._gridState.selectable=!!_67;},_setDisabledAttr:function(_68){},_setReadOnlyAttr:function(_69){var _6a=this;function _6b(_6c,_6d){_c.forEach(_6c,function(_6e){if(_6e.mxid){var _6f=this._gridConfig.getActionsByKey(_6e.mxid);if(_6f&&/AddRef|DeleteRef|CreateRef/.test(_6f.actionCall)){_6d&&_6d(_6e);}}},_6a);};if(this._gridState.controlbar&&_69!=this.readOnly){var _70=this._gridConfig.gridTools();if(_69){_6b(_70,function(_71){_6a.toolBarNode.removeChild(_71._domNode);});}else{_6b(_70,function(_72){if(_72._nextNode){_6a.toolBarNode.insertBefore(_72._domNode,_72._nextNode);}else{_6a.toolBarNode.appendChild(_72._domNode);}});}this.readOnly=!!_69;}},_renderObjectsToCell:function(_73,td,_74){var _75=_74.attrs.slice(-1)[0],_76=td.firstChild,_77=[],_78=[];td.firstChild.innerHTML="";_c.forEach(_73,function(obj){var _79=this.gridbodyFillCell(_74,obj,_75);if(_79!=null){_77.push(_79);}else{_7.error(this.id+".gridBodyFillRow: received no content");}if(/^(enum)?icon$/i.test(_74.render)){_78.push(obj.getEnumCaption(_75));}},this);_76.innerHTML=_77.join(", ");if(_76.childNodes.length===0){_76.innerHTML="&nbsp;";}if(_78.length!==0){td.setAttribute("title",_78.join(";"));}else{this.setNodeTitle(td);}},_gridbodyFillRow:function(_7a,_7b,_7c){_c.forEach(_7b,function(td,i){var _7d=[],_7e=_7c[i],_7f=false,_80=_7e.attrs;if(_80.length===1){_7d.push(_7a);}else{var _81=_7a,_82;for(var j=0;j<_80.length-1;j+=2){var _83=_80[j],_84=_80[j+1];_82=_81.getChildren(_83);if(_82.length>0){if(j>0&&!_82[0].isA(_84)){_7.error(this.id+".gridBodyFillRow: entity and reference do not match");_82=[];break;}_81=_82[0];}else{if(_80.length===3){_7f=!!_7a.get2(_83);break;}else{break;}}}[].push.apply(_7d,_82);}if(!_7f){this._renderObjectsToCell(_7d,td,_7e);}else{if(_7a.isReference(_80[0])){var _85=this;window.mx.data.get({guids:_7a.getReferences(_80[0]),callback:function(_86){_85._renderObjectsToCell(_86,td,_7e);},error:window.mx.onError},this);}else{_7.error(this.id+".gridBodyFillRow: attribute '"+_80[0]+"' is not a reference(set)");}}},this);},_insertNewFirstOrLast:function(_87,_88,_89){var _8a=function(_8b){window.mx.data.create({entity:_87,context:this.mxcontext,persistent:_88.persistent,callback:function(obj){if(!_89){this._dataSource.insertMxObjectAtStart(obj);}else{this._dataSource.insertMxObjectAtEnd(obj);}_8b();},error:window.mx.onError},this);};this.triggerOnSync();this.sequence([_8a,"actDeferSyncAction",function(){this.refreshGrid();var row=_89?this._dataSource.getObjects().length-1:0;this.eventSelectRow({row:row});}]);},_getEntity:function(_8c){return _6.firstKey(_8c);},_getCurrentGuid:function(){return this.selection[this.selection.length-1];},_getNodeFromEvent:function(e){return _4.getAncestorNode(e.target,"TR");},_getActionFromEvent:function(e){var _8d=this._gridConfig.gridActionBindings(),_8e=_8d["on"+e.type];return this._gridConfig.getActionsByKey(_8e);},_getObjectFromNode:function(_8f){return this._mxObjects[this.domData(_8f,"gridrow")];},_addFocusBoxForTable:function(){var box=this.addFocusBox(this.contentNode);box.pressed({DOWN_ARROW:box.FOCUS_NEXT,UP_ARROW:box.FOCUS_PREV,SPACE:function(e){this.eventItemClicked(e,e.target);},ENTER:function(e,_90){if(_90){this.eventActionBindingHandler(_90,"dblclick");}},LEFT_ARROW:function(){if(!this._dataSource.atBeginning()){this._dataSource.previous(_d.hitch(this,function(){this.refreshGrid();_3.restore();}));}},RIGHT_ARROW:function(){if(!this._dataSource.atEnd()){this._dataSource.next(_d.hitch(this,function(){this.refreshGrid();_3.restore();}));}}},this);}});return _10;});