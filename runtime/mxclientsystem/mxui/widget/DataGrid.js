
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
require({cache:{"url:mxui/widget/templates/DataGrid.html":"<div class=\"${baseClass} mx-datagrid\">\n    <div class=\"${baseClass}-searchbar clearfix\" dojoAttachPoint=\"searchNode\" focusIndex=\"0\">\n        <div class=\"${baseClass}-search-controls\" focusIndex=\"1\" dojoAttachPoint=\"searchControlNode\"></div>\n        <div class=\"${baseClass}-search-inputs\" focusIndex=\"0\" dojoAttachPoint=\"searchArgumentNode\"></div>\n        <div class=\"${baseClass}-search-message\" dojoAttachPoint=\"messageNode\"></div>\n    </div>\n    \n    <div class=\"${baseClass}-controlbar clearfix\" dojoAttachPoint=\"controlNode\" focusIndex=\"1\">\n        <div class=\"${baseClass}-pagingbar\" dojoAttachPoint=\"pagingBarNode\"></div>\n        <div class=\"${baseClass}-toolbar\" dojoAttachPoint=\"toolBarNode\"></div>\n    </div>\n        \n    <div class=\"${baseClass}-content\" dojoAttachPoint=\"contentNode\" focusIndex=\"2\">\n        <div class=\"${subClass}-content-wrapper\" dojoAttachPoint=\"tableWrapper\">\n            <table class=\"table table-bordered ${subClass}-head-table\" dojoAttachPoint=\"headTable\">\n                <colgroup dojoAttachPoint=\"headTableGroupNode\"></colgroup>\n                <thead class=\"${subClass}-head\" dojoAttachPoint=\"gridHeadNode\"></thead>\n            </table>\n            <table class=\"table table-striped table-bordered ${subClass}-body-table\" dojoAttachPoint=\"gridTable\">\n                <colgroup dojoAttachPoint=\"bodyTableGroupNode\"></colgroup>\n                <tbody class=\"${subClass}-body\" dojoAttachPoint=\"gridBodyNode\"></tbody>\n                <tfoot class=\"${subClass}-foot\" dojoAttachPoint=\"gridFootNode\"></tfoot>\n            </table>\n        </div>\n    </div>\n</div>\n"}});define("mxui/widget/DataGrid",["mxui/widget/_Grid","mxui/widget","mxui/wm/focus","mxui/dom","mxui/lib/ColumnResizer","mendix/lang","mendix/logger","dojo/query","dojo/on","dojo/dom-class","dojo/_base/array","dojo/_base/lang","dojo/_base/declare","dojo/text!mxui/widget/templates/DataGrid.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){var _f=_d(_1,{declaredClass:"mxui.widget.DataGrid",templateString:_e,subClass:"mx-datagrid",cssmap:_2.createCSSMap("mx-datagrid",{sortText:"sort-text",sortIcon:"sort-icon",headCaption:"head-caption",headWrapper:"head-wrapper",columnResizer:"column-resizer",dataWrapper:"data-wrapper"}),readOnly:false,gridBodyNode:null,gridFootNode:null,_deferSyncQueue:0,_deferSyncCallback:null,_selectedGuids:null,_mxObjects:null,_gridColumnNodes:null,_gridRowNodes:null,_gridMatrix:null,_visibleColumns:null,_hiddenAggregates:null,constructor:function(){this._selectedGuids=[];this._mxObjects=[];this._gridColumnNodes=[];this._gridRowNodes=[];this._gridMatrix=[];this._visibleColumns=[];this._hiddenAggregates=[];this._gridState={sortable:true,selectable:true,selectionmode:"single",searchbar:true,controlbar:true,pagingbar:true,inDenial:false,searchBarVisible:false,searchBarTogglable:true,xpathConstraint:"",loading:false,invertedSelection:false};},postCreate:function(){this.inherited(arguments);if(this._metaEntity){this._addFocusBoxForTable();this.setupScroll();this.buildGridBody();this.loadPlugins();this.doGridAttributes();this.triggerOnLoad();}this.loaded();},setColumnStyle:function(_10,_11){var _12=_11.display,_13=_12.align||"left";if(window.mx.ui.isRtl()){_13=(_13==="right"?"left":"right");}if(_12.cssStyle){_10.setAttribute("style",_12.cssStyle);}else{_10.removeAttribute("style");}_a.add(_10,[_11.name?"mx-name-"+_11.name:"","mx-"+_13+"-aligned"]);_a.add(_10,_12.cssClass);},buildGridRow:function(_14,_15){var $=_4.create,tr=$("tr",{"class":"mx-name-index-"+_15}),row;this.domData(tr,"gridrow",_15);row=_b.map(_14,function(_16,i){var td=$("td");this.domData(td,{row:_15,column:i,key:_16.tag});this.setColumnStyle(td,_16);td.appendChild($("div",{"class":this.cssmap.dataWrapper}));tr.appendChild(td);return td;},this);this._gridMatrix.push(row);return tr;},setNodeTitle:function(_17,_18){if(!_17){return;}var _19=_4.text(_18||_17);_17.setAttribute("title",_c.trim(_19));},gridbodyFillCell:function(_1a,_1b,_1c){var _1d;if(!_1b.has(_1c)){return "&nbsp;";}_1d=_1b.get(_1c);switch(_1a.render.toLowerCase()){case "icon":case "enumicon":var src=_1a.display.mapping[_1d];_1d=src?"<img src='"+src+"'>":"";break;case "weblink":break;default:var _1e=_1a.display,_1f=_1e.dateFormat||"date";_1d=this.renderValue(_1b,_1c,{format:_1f.toLowerCase().replace("custom","date"),datepattern:_1e.format,formatted:_1e.formatted,precision:_1e.precision});_1d=_4.escapeString(_1d.replace(/\n/g," "));}return _1d||"&nbsp;";},renderValue:function(_20,_21,_22){_22=_22||{};var _23=_22.render||_20.getAttributeType(_21)||"",_24=_20.get(_21),_25="";switch(_23.toLowerCase()){case "string":_25=_24||"";break;case "date":case "datetime":if(_24!==""){_25=window.mx.parser.formatDate(_24,{selector:_22.format,datePattern:_22.datepattern});}else{_25="";}break;case "enum":_25=_20.getEnumCaption(_21);break;case "number":case "int":case "integer":case "long":_25=window.mx.parser.formatNumber(_24,_22.formatted,0);break;case "float":case "currency":_25=window.mx.parser.formatNumber(_24,_22.formatted,_22.precision);break;case "bool":case "boolean":_25=window.mx.ui.translate("mxui.widget.DataGrid",_24);break;default:_25=_24;break;}return _25;},disableRow:function(tr){tr.style.display="";this.domData(tr,"mendixguid",null);_b.forEach(tr.getElementsByTagName("td"),function(td){td.firstChild.innerHTML="&nbsp";td.setAttribute("title","");});},setupGridState:function(){this.inherited(arguments);this._gridState.sortable=this._gridConfig.gridSetting("sortable");},loadPlugins:function(){this.hideFootNode();if(this._gridState.editable){this.loadPlugin("GridEditor");_3.removeBox(this.contentNode);}var _26=this._gridConfig.getPlugins();for(var _27 in _26){this.loadPlugin(_27,_26[_27]);}},setupScroll:function(){var _28=this.headTable,_29=this.contentNode;this.connect(_29,"scroll",function(){_28.style.top=_29.scrollTop+"px";});},resize:function(box){this.inherited(arguments);this._resizer.recalculate();},buildGridBody:function(){var _2a=this,$=_4.create,_2b=this._gridConfig.gridAttributes(),_2c=[],_2d=[],row=$("tr",{"class":"mx-name-head-row"}),_2e=$("div",{"class":this.cssmap.headCaption}),_2f=$("div",{"class":this.cssmap.headWrapper}),_30={},_31=this._gridConfig.getPlugins()["Calculations"]||{};_4.disableSelection(row);_b.forEach(this._gridConfig.gridSetting("sortparams"),function(_32){_30[_32[0]]=_32;});_b.forEach(_2b,function(_33,i){var _34=_33.display.width,_35=_33.tag in _31,_36=_34!=null&&(_34=="0px"||_34=="0%");if(_35){_2d.push(_36);}if(!_36){this._visibleColumns.push(_33);}},this);_b.forEach(_2d,function(_37,i){if(_37){this._hiddenAggregates.push(i);}},this);_b.forEach(this._visibleColumns,function(_38,i){var _39=$("th");this.domData(_39,{datakey:_38.tag,index:i});this.setColumnStyle(_39,_38);var _3a=$("span",{"class":this.cssmap.sortText});var _3b=$("div",{"class":this.cssmap.sortIcon,style:"display: none"},_3a);var _3c=_30[_38.tag];if(_3c){var _3d=_3c[1];this.domData(_39,"sortorder",_3d);_3a.innerHTML=_3d==="asc"?"&#9650;":"&#9660;";_3b.style.display="";}var _3e=_2e.cloneNode(true);_3e.innerHTML=_38.display.string||"&nbsp;";var _3f=_2f.cloneNode(true);_3f.appendChild(_3b);_3f.appendChild(_3e);_39.appendChild(_3f);this.setNodeTitle(_39,_3e);var _40=$("col",{style:"width:"+_38.display.width}),_41=_40.cloneNode(true);this.headTableGroupNode.appendChild(_40);this.bodyTableGroupNode.appendChild(_41);_2c.push([_40,_41]);this._gridColumnNodes.push(_39);row.appendChild(_39);},this);this.gridHeadNode.appendChild(row);if(this._gridState.sortable){this.own(_9(this.gridHeadNode,"th:click",function(e){var key=_2a.domData(this,"index");if(_2b[key].sortable!==false){_2a.eventColumnClicked(e,this);}}));}this._resizer=new _5({thNodes:_4.toArray(row.children),colNodes:_2c,colUnits:_2b[0].display.width.indexOf("%")>0?"%":"px",rtl:!this.isLeftToRight(),tableNode:this.headTable,gridNode:this.gridTable});if(this._gridState.showemptyrows){var _42=this._gridConfig.gridSetting("rows");for(var i=0;i<_42;i++){this.addNewRow();}}this.own(_9(this.gridBodyNode,"tr:click",function(e){_2a.eventItemClicked(e,this);}));this.liveConnect(this.gridBodyNode,"onclick",{td:"eventCellClicked"});this.liveConnect(this.gridBodyNode,"onmouseover",{tr:"eventRowMouseOver"});this.liveConnect(this.gridBodyNode,"onmouseout",{tr:"eventRowMouseOut"});var _43=function(e){_2a.eventActionBindingHandler(this,e.type);};var _44=this._gridConfig.gridActionBindings();for(var _45 in _44){this.own(_9(this.gridBodyNode,"tr:"+_45.replace(/^on/,""),_43));}},addNewRow:function(){var _46=this._visibleColumns,_47=this._gridConfig.gridSetting("rows"),_48=this._gridRowNodes.length;if(_48>_47){return null;}var tr=this.buildGridRow(_46,_48);this._gridRowNodes.push(tr);this.gridBodyNode.appendChild(tr);var box=this.getFocusBox(this.contentNode);box.add&&box.add(tr);return tr;},doGridAttributes:function(){var _49=this._visibleColumns;_b.forEach(_49,function(_4a){var _4b=_4a.tag.split("/");if(_4b.length==2||_4b.length==4){_4b.shift();}_4a.attrs=_4b;},this);},fillGrid:function(){this._mxObjects=this._dataSource.getObjects()||[];var _4c=this._visibleColumns,_4d=(this._gridState.selectfirst&&!this._gridState.invertedSelection&&this._mxObjects.length>0&&this._selectedGuids.length===0);if(_4d){this._selectedGuids.push(this._mxObjects[0].getGuid());setTimeout(_c.hitch(this,function(){this.shareSelected();}),1000);}var _4e=this._mxObjects.length-this._gridRowNodes.length;if(_4e>0){while(_4e--){this.addNewRow();}this.mxform.resize();}else{if(_4e<0){_b.forEach(this._gridRowNodes.slice(this._mxObjects.length),function(_4f){_a.remove(_4f,"selected");if(this._gridState.showemptyrows){this.disableRow(_4f);}else{_4f.style.display="none";}},this);}}var _50={};_b.forEach(this._selectedGuids,function(_51){_50[_51]=true;});_b.forEach(this._mxObjects,function(_52,i){var _53=_52.getGuid(),_54=this._gridRowNodes[i];this.domData(_54,"mendixguid",_53);this._gridbodyFillRow(_52,this._gridMatrix[i],_4c);if(!_50[_53]){this.deselectRow(_54);}else{this.selectRow(_54);}_54.style.display="";},this);},refreshGrid:function(){this.triggerPreRefresh();this.inherited(arguments);this.triggerOnRefresh();},triggerOnLoad:function(){this.triggerPluginEvent("onLoad");},triggerOnSync:function(){this.triggerPluginEvent("onSync");},triggerOnRefresh:function(){this.triggerPluginEvent("onRefresh");},triggerPreRefresh:function(){this.triggerPluginEvent("preRefresh");},triggerOnSearchChanged:function(){this.triggerPluginEvent("onSearchChanged");},actDeferSyncAction:function(_55){if(this._deferSyncQueue===0){_55&&_55();}else{if(this._deferSyncCallback==null){this._deferSyncCallback=_55;}else{}}},eventCellClicked:function(e){this.triggerPluginEvent("onCellClicked",e);},eventRowMouseOver:function(e){this.triggerPluginEvent("onRowMouseOver",e);},eventRowMouseOut:function(e){this.triggerPluginEvent("onRowMouseOut",e);},eventCellMouseOut:function(e){this.triggerPluginEvent("onCellMouseOut",e);},eventCellMouseOver:function(e){this.triggerPluginEvent("onCellMouseOver",e);},eventSelectRow:function(e){this.triggerPluginEvent("onSelectRow",e);},eventColumnClicked:function(e,_56){var _57=e.shiftKey;if(!_57){_b.forEach(this._gridColumnNodes,function(_58){_58.querySelector("."+this.cssmap.sortIcon).style.display="none";},this);}else{_4.clearSelection();}var _59=this.domData(_56,"datakey"),_5a="asc";if(this.domData(_56,"sortorder")){_5a=this.domData(_56,"sortorder");_5a=(_5a==="asc")?"desc":"asc";}this.domData(_56,"sortorder",_5a);var _5b=_56.querySelector("."+this.cssmap.sortText);_5b.innerHTML=(_5a==="asc"?"&#9650;":"&#9660;");_5b.parentNode.style.display="";this._dataSource.setSortOptions(_59,_5a,_57);if(this.constraintsFilled()){this._dataSource.refresh(_c.hitch(this,"refreshGrid"));}},filterSelected:function(){var _5c=[];_b.forEach(this._selectedGuids,function(_5d){if(this._dataSource.getObject(_5d)!=null){_5c.push(_5d);}},this);this._selectedGuids=_5c;},deselectGridRows:function(){_b.forEach(this._gridRowNodes,function(_5e){this.deselectRow(_5e);},this);},getAggregates:function(){return this._dataSource.getAggregates();},actionExport:function(_5f){if(this.constraintsFilled()){var _60=window.mx.ui.getProgressIndicator("popup");_60.start();this._dataSource.generateExport({params:_5f,callback:function(){_60.stop();},error:function(e){_60.stop();window.mx.onError(e);}});}},actionInsertNewAtTop:function(_61){var _62=this._getEntity(_61);if(_62){this._insertNewFirstOrLast(_62,_61[_62],false);}},actionInsertNewAtBottom:function(_63){var _64=this._getEntity(_63);if(_64){this._insertNewFirstOrLast(_64,_63[_64],true);}},getCellNode:function(_65,key){var row=this._gridMatrix[_65];if(row){for(var i=0;i<row.length;i++){if(this.domData(row[i],"key")===key){return row[i];}}}return null;},getMxObjectAtRow:function(_66){return (this._mxObjects.length>=_66)?this._mxObjects[_66]:false;},getRowForMxObject:function(_67){var _68=this._mxObjects;for(var i=0;i<_68.length;++i){if(_68[i].getGuid()===_67.getGuid()){return i;}}},getEntityProperties:function(){return this._visibleColumns;},getHiddenAggregates:function(){return this._hiddenAggregates.slice();},getActionProperties:function(_69,_6a){var _6b=this._gridConfig.dataEntityConfigs(),act=null;if(_6b[_69]){act=_6b[_69][_6a];}return act;},getCurrentGridSize:function(){return this._mxObjects.length;},getGridNodeHash:function(){return this._gridMatrix;},getCurrentXPath:function(){var _6c=this._dataSource?this._dataSource.getCurrentXPath()||"":"";return _6c+this._gridState.xpathConstraint;},preventUpdates:function(){this._gridState.inDenial=true;},acceptUpdates:function(){this._gridState.inDenial=false;},acceptingUpdates:function(){return !this._gridState.inDenial;},updateMxObject:function(_6d,_6e){var row=this.getRowForMxObject(_6d);if(!row){this._gridbodyFillRow(_6d,this._gridMatrix[row],this._visibleColumns);}_6e&&_6e();},showFootNode:function(){this.gridFootNode.style.display="";},hideFootNode:function(){this.gridFootNode.style.display="none";},addToSyncDeferQueue:function(){this._deferSyncQueue++;},removeFromSyncDeferQueue:function(){this._deferSyncQueue--;if(this._deferSyncQueue===0){if(this._deferSyncCallback!=null){this._deferSyncCallback();this._deferSyncCallback=null;}else{}}},uninitialize:function(){this._resizer.destroy();this.triggerPluginEvent("onDestroy");this.inherited(arguments);},_setSelectableAttr:function(_6f){this._gridState.selectable=!!_6f;},_setDisabledAttr:function(_70){},_setReadOnlyAttr:function(_71){var _72=this;function _73(_74,_75){_b.forEach(_74,function(_76){if(_76.mxid){var _77=this._gridConfig.getActionsByKey(_76.mxid);if(_77&&/AddRef|DeleteRef|CreateRef/.test(_77.actionCall)){_75&&_75(_76);}}},_72);};if(this._gridState.controlbar&&_71!=this.readOnly){var _78=this._gridConfig.gridTools();if(_71){_73(_78,function(_79){_72.toolBarNode.removeChild(_79._domNode);});}else{_73(_78,function(_7a){if(_7a._nextNode){_72.toolBarNode.insertBefore(_7a._domNode,_7a._nextNode);}else{_72.toolBarNode.appendChild(_7a._domNode);}});}this.readOnly=!!_71;}},_renderObjectsToCell:function(_7b,td,_7c,_7d){var _7e=_7c.attrs.slice(-1)[0],_7f=td.firstChild,_80=[],_81=[];td.firstChild.innerHTML="";_b.forEach(_7b,function(obj){var _82=this.gridbodyFillCell(_7c,obj,_7e);if(_82!=null){_80.push(_82);}else{_7.error(this.id+".gridBodyFillRow: received no content");}if(/^(enum)?icon$/i.test(_7c.render)){_81.push(obj.getEnumCaption(_7e));}},this);_7f.innerHTML=_80.join(_7d);if(_7f.childNodes.length===0){_7f.innerHTML="&nbsp;";}if(_81.length!==0){td.setAttribute("title",_81.join(";"));}else{this.setNodeTitle(td);}},_gridbodyFillRow:function(_83,_84,_85){_b.forEach(_84,function(td,i){var _86=[],_87=_85[i],_88=false,_89=_87.attrs;if(_89.length===1){_86.push(_83);}else{var _8a=_83,_8b;for(var j=0;j<_89.length-1;j+=2){var _8c=_89[j],_8d=_89[j+1];_8b=_8a.getChildren(_8c);if(_8b.length>0){if(j>0&&!_8b[0].isA(_8d)){_7.error(this.id+".gridBodyFillRow: entity and reference do not match");_8b=[];break;}_8a=_8b[0];}else{if(_89.length===3){_88=!!_83.get(_8c);break;}else{break;}}}[].push.apply(_86,_8b);}if(!_88){this._renderObjectsToCell(_86,td,_87,", ");}else{if(_83.isReference(_89[0])){var _8e=this;window.mx.data.get({guids:_83.getReferences(_89[0]),callback:function(_8f){_8e._renderObjectsToCell(_8f,td,_87,_89.length===3?_89[2]:_89[3],";");},error:window.mx.onError},this);}else{_7.error(this.id+".gridBodyFillRow: attribute '"+_89[0]+"' is not a reference(set)");}}},this);},_insertNewFirstOrLast:function(_90,_91,_92){var _93=function(_94){window.mx.data.create({entity:_90,context:this.mxcontext,persistent:_91.persistent,callback:function(obj){if(!_92){this._dataSource.insertMxObjectAtStart(obj);}else{this._dataSource.insertMxObjectAtEnd(obj);}_94();},error:window.mx.onError},this);};this.triggerOnSync();this.sequence([_93,"actDeferSyncAction",function(){this.refreshGrid();var row=_92?this._dataSource.getObjects().length-1:0;this.eventSelectRow({row:row});}]);},_clearSelection:function(){this._selectedGuids=[];},_getEntity:function(_95){return _6.firstKey(_95);},_getSelectedGuids:function(){return this._selectedGuids;},_getCurrentGuid:function(){return this._selectedGuids[this._selectedGuids.length-1];},_addObjectToSelection:function(obj){var _96=obj.getGuid();if(_b.indexOf(this._selectedGuids,_96)==-1){this._selectedGuids.push(_96);}},_removeObjectFromSelection:function(obj){var _97=obj.getGuid(),_98=_b.indexOf(this._selectedGuids,_97);if(_98!=-1){this._selectedGuids.splice(_98,1);}},_getNodeFromEvent:function(e){return _4.getAncestorNode(e.target,"TR");},_getActionFromEvent:function(e){var _99=this._gridConfig.gridActionBindings(),_9a=_99["on"+e.type];return this._gridConfig.getActionsByKey(_9a);},_getObjectFromNode:function(_9b){return this._mxObjects[this.domData(_9b,"gridrow")];},_addFocusBoxForTable:function(){var box=this.addFocusBox(this.contentNode);box.pressed({DOWN_ARROW:box.FOCUS_NEXT,UP_ARROW:box.FOCUS_PREV,SPACE:function(e){this.eventItemClicked(e,e.target);},ENTER:function(e,_9c){if(_9c){this.eventActionBindingHandler(_9c,"dblclick");}},LEFT_ARROW:function(){if(!this._dataSource.atBeginning()){this._dataSource.previous(_c.hitch(this,function(){this.refreshGrid();_3.restore();}));}},RIGHT_ARROW:function(){if(!this._dataSource.atEnd()){this._dataSource.next(_c.hitch(this,function(){this.refreshGrid();_3.restore();}));}}},this);}});return _f;});