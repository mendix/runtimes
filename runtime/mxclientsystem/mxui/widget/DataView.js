/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/DataView",["mxui/widget/_WidgetBase","mxui/widget","mxui/dom","mxui/html/parser","mendix/lib/DirectObjectSource","mendix/lib/MicroflowObjectSource","mendix/lib/SchemaObjectSource","mendix/logger","mxui/store/asyncValueStore","dijit/registry","dojo/dom-geometry","dojo/topic","dojo/aspect","dojo/_base/array","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){var _11=_10(_1,{declaredClass:"mxui.widget.DataView",entity:"",schema:"",autoLoad:false,datasource:null,conditions:null,contextsource:"",closeButton:"",hideControls:false,useSchema:false,noEntityMessage:"",_mxObject:null,_tempSubs:null,_mxidMap:null,_delayMap:null,_source:null,_contentNode:null,_controlsNode:null,_messageNode:null,_doUpdate:false,constructor:function(){this._tempSubs=[];},postMixInProperties:function(){this.doParse=true;},buildRendering:function(){var $=_3.create,_12=this.getTemplate("content"),_13=this.getTemplate("buttons");this.domNode=$("div",{"class":"mx-dataview"},$("div",{"class":"mx-dataview-content"},_12));this._contentNode=this.domNode.firstChild;if(this.noEntityMessage){this._messageNode=$("div",{"class":"mx-dataview-message","style":"display: none"},$("div",$("p",this.noEntityMessage)));this.domNode.appendChild(this._messageNode);}if(_13){var _14=this._controlsNode=$("div",{"class":"mx-dataview-controls"},_13);if(this.hideControls){_14.style.display="none";}this.domNode.appendChild(_14);}},postCreate:function(){var map=this._mxidMap={},_15=this._delayMap={};for(var _16 in this.conditions){var _17=this.conditions[_16];for(var _18 in _17){var _19=_18===""?"_empty_":_18,_1a=_17[_18];_e.forEach(_1a,function(_1b){if(_1b.action==="show"||_1b.action==="hide"){_15[_1b.mxid]=1;}_f.setObject([_1b.mxid,_16,_19,_1b.action].join("."),1,map);});}}if(!this.readOnly){this.listen("validate",this.validate);this.listen("save",this.save);this.listen("commit",this.commit);this.listen("rollback",this.rollback);_d.after(this.mxform,"onResume",_f.hitch(this,"resume"));}this.listen("close",this.close);this.createSource();},createSource:function(){var _1c=this.datasource;if(_1c){switch(_1c.type){case "listen":case "direct":if(this.useSchema==="true"){_1c.type="schema";this._source=new _7({schema:this.schema,context:this.mxcontext});}else{this._source=new _5({schema:this.schema,context:this.mxcontext,path:_1c.path||this.entity});}break;case "microflow":this._source=new _6({context:this.mxcontext,microflow:_1c.microflow});break;default:throw new Error(this.id+".createSource : unknown datasource type: "+_1c);}}if(_1c.type==="listen"){var _1d=window.mx.ui.makeShareId(this.mxform,this.datasource.contextsource),_1e=_f.hitch(this,function(_1f){this.applyContext(_1f,function(){});});this.own(_c.subscribe(_1d,_1e));this.addOnLoad(function(){_9.retrieve(_1d,_1e);});}},parseNode:function(_20){var _21=[],_22=true;var _23=function(_24){var _25=_22,_26=_24.getAttribute("data-mendix-id");_22=false;if(_26){if(!_25&&_26 in this._delayMap){_24.setAttribute("data-mendix-not-parsed",true);window.mx.ui.applyToNode("hide",_24);}else{var _27=_24.getAttribute("data-mendix-type");if(_27){var _28={doParse:false};if(this.schema===""&&_27===this.declaredClass){_28.schema="";}var _29=this.parseContent(_24,_28,true)[0];if(_29){this._patchWidget(_29);_21.push(_29);_24=_29.domNode;}}if(this._shouldBeVisited(_24)){_e.forEach(_24.children,_23,this);}}}else{_e.forEach(_24.children,_23,this);}};_23.call(this,_20);return _21;},startup:function(){var _2a=this.parseNode(this.domNode);_2.ready(_2a,_f.hitch(this,"actLoaded"));},applyContext:function(_2b,_2c){this.mxcontext.mixin(_2b);this.update(this.mxcontext.getTrackId(),_2c);},update:function(_2d,_2e){var _2f=this;this._sourceGuid=_2d;var _30=function(obj,_31){_2f.mxcontext.setObject(obj);_2f.updateObject(obj,_31);};this._source.fetch(function(obj){_30(obj,_2e);},function(e){window.mx.onError(e);_30(null,_2e);});},updateObject:function(obj,_32){if(obj!=this._mxObject){this._mxObject=obj;}this.setSubscriptions();this.refresh(_32);},setSubscriptions:function(){var obj=this._mxObject,_33=this._tempSubs,_34=this._sourceGuid,sub;var _35=function(){this.mxcontext.setTrackId(_34);this.update(_34);};var _36=_f.hitch(this,"applyConditions");while((sub=_33.pop())){this.unsubscribe(sub);}if(obj){var _37=obj.getGuid();_33.push(this.subscribe({guid:_37,callback:_36}));for(var _38 in this.conditions){_33.push(this.subscribe({guid:_37,attr:_38,callback:_36}));}}if(this._source.hasRoot()&&_34){_33.push(this.subscribe({guid:_34,callback:_35}));_33.push(this.subscribe({guid:_34,attr:this._source.getRoot(),callback:_35}));}},refresh:function(_39){this.set("disabled",!this._mxObject);var _3a=this;if(this.mxform.isSuspended()){this._doUpdate=true;if(_39){_39();}return;}else{this._doUpdate=false;}if(this._messageNode){if(!this._mxObject){this._messageNode.style.display="block";}else{this._messageNode.style.display="none";}}this.passContext(_a.findWidgets(this.domNode),function(){_3a.applyConditions();if(_39){_39();}});},validate:function(_3b,_3c){var _3d=this._mxObject;if(!_3d||this.get("disabled")){if(_3b){_3b();}}else{var _3e=this.getChildren(true),_3f=true;for(var i=0,_40;_40=_3e[i];i++){if(_40.isValid&&!_40.isValid()){_3f=false;}}if(_3f){if(_3b){_3b();}}else{if(_3c){_3c();}else{if(window.mx.ui.getProfile()==="phone"){window.mx.ui.error(this.translate("validation_error"));}}}}},save:function(_41,_42){var _43=this._mxObject;if(!_43||this.get("disabled")){if(_41){_41();}}else{window.mx.data.save({mxobj:this._mxObject,callback:_41,error:_42},this);}},commit:function(_44,_45){var _46=this._mxObject;if(!_46||this.get("disabled")){_44();}else{window.mx.data.commit({mxobj:_46,callback:_44,error:_45});}},resume:function(){if(this._doUpdate){this.refresh();this._doUpdate=false;}},rollback:function(_47,_48){var obj=this._mxObject;if(!obj||this.get("disabled")){_47();}else{if(obj.getGuid()!==0){window.mx.data.rollback({mxobj:obj,callback:_47,error:_48});}else{if(_47){_47();}}}},close:function(_49){var _4a=this.closeButton&&this.domNode.querySelector("[data-mendix-id='"+this.closeButton+"']"),_4b=_4a&&_a.byNode(_4a);if(_4b){_4b.onClick();}else{if(_49){_49();}}},getCFActions:function(_4c){var _4d=_4c.getAttribute("data-mendix-id")||_4c.getAttribute("mxid"),_4e=[];if(_4d){if(this._mxObject){var _4f=this._mxidMap[_4d];for(var _50 in _4f){var _51=this._mxObject.get2(_50),_52=_4f[_50][_51===""?"_empty_":_51];for(var _53 in _52){if(_53==="show"){_4e.unshift("show");}else{_4e.push(_53);}}}}else{if(_4d in this._delayMap){_4e.push("hide");}}}return _4e;},applyConditions:function(){var _54=[],_55=false;var _56=function(_57){var _58=!_57.getAttribute("data-mendix-not-parsed"),_59=this.getCFActions(_57);dojo.forEach(_59,function(_5a){if(_5a=="show"){_55=true;if(!_58){var _5b=this.parseNode(_57);_54.push.apply(_54,_5b);if(_3.isOrphan(_57)){_57=_5b[0].domNode;}_57.removeAttribute("data-mendix-not-parsed");_58=true;}}window.mx.ui.applyToNode(_5a,_57);},this);if(_58&&this._shouldBeVisited(_57)){_e.forEach(_57.children,_56,this);}};_56.call(this,this.domNode);_2.ready(_54,function(){this.passContext(_54);if(_54.length||_55){this.mxform.resize();}},this);},resize:function(box){if(box){var _5c=box.h-_3.getNodeExtents(this.domNode).h;if(this._controlsNode){_5c-=_b.getMarginBox(this._controlsNode).h;}_b.setContentSize(this._contentNode,{h:_5c});}else{this._contentNode.style.height="auto";}this._contentNode.style.overflow=box?"auto":"";this.resizeChildren(this._contentNode,!box);},uninitialize:function(){this._source.destroy();},getChildren:function(_5d){if(_5d){var _5e=[];_3.walkNode(this.domNode,function(_5f){var _60=_5f.nodeType===_3.nodeTypes.ELEMENT_NODE&&_a.byNode(_5f);if(!_60||_60==this){return true;}_5e.push(_60);return !(_60 instanceof this.constructor);});return _5e;}else{this.inherited(arguments);}},_patchWidget:function(_61){var _62=_61.name;if(!(_61 instanceof _1)&&(typeof _61.onChange=="function")&&_62){this.connect(_61,"onChange",function(){var _63=_61.get("value");this._mxObject.set(_62,_63);});}},_shouldBeVisited:function(_64){return _64==this.domNode||!(_a.byNode(_64) instanceof this.constructor);}});return _11;});