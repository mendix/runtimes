
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/DataView",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget.DataView");_1.declare("mxui.widget.DataView",mxui.widget._WidgetBase,{entity:"",schema:"",autoLoad:false,datasource:null,conditions:null,contextsource:"",closeButton:"",hideControls:false,useSchema:false,_doUpdate:false,_mxObject:null,_children:null,_tempSubs:null,_mxidMap:null,_delayMap:null,_source:null,_contentNode:null,_controlsNode:null,constructor:function(){this._tempSubs=[];},buildRendering:function(){var $=mxui.dom.create,_4=this.getTemplate("content"),_5=this.getTemplate("buttons");this.domNode=$("div",{"class":"mx-dataview"},$("div",{"class":"mx-dataview-content"},_4));this._contentNode=this.domNode.firstChild;if(_5){var _6=this._controlsNode=$("div",{"class":"mx-dataview-controls"},_5);if(this.hideControls){_6.style.display="none";}this.domNode.appendChild(_6);}},postCreate:function(){var _7=this.conditions,_8=this._mxidMap={},_9=this._delayMap={};for(var _a in _7){var _b=_7[_a];for(var _c in _b){var _d=_b[_c];for(var _e in _d){var _f=_d[_e];for(var i=0,_10;_10=_f[i];i++){if(_e=="show"||_e=="hide"){_9[_10]=1;}var key=_c===""?"_empty_":_c;_1.setObject([_10,_a,key,_e].join("."),1,_8);}}}}if(!this.readOnly){this.listen("validate",this.validate);this.listen("save",this.save);this.listen("commit",this.commit);this.listen("rollback",this.rollback);}this.listen("close",this.close);this.createSource();this._children=[];},createSource:function(){var _11=this.datasource;if(_11){switch(_11.type){case "listen":var _12=mx.ui.makeShareId(this.mxform,this.datasource.contextsource),_13=_1.subscribe(_12,_1.hitch(this,"applyContext"));this.addOnDestroy(function(){_1.unsubscribe(_13);});case "direct":if(this.useSchema==="true"){_11.type="schema";this._source=new mendix.lib.SchemaObjectSource({schema:this.schema,context:this.mxcontext});}else{this._source=new mendix.lib.DirectObjectSource({schema:this.schema,context:this.mxcontext,path:_11.path||this.entity});}break;case "microflow":this._source=new mendix.lib.MicroflowObjectSource({context:this.mxcontext,microflow:_11.microflow});break;default:throw new Error(this.id+".createSource : unknown datasource type: "+_11);}}},parseNode:function(_14){var _15=[],_16=true;var _17=function(_18){var _19=_16,_1a=_18.getAttribute("data-mendix-id");_16=false;if(_1a){if(!_19&&_1a in this._delayMap){_18.setAttribute("data-mendix-not-parsed",true);mx.ui.applyToNode("hide",_18);}else{var _1b=_18.getAttribute("data-mendix-type");if(_1b){var _1c={doParse:false};if(this.schema===""&&_1b===this.declaredClass){_1c.schema="";}var _1d=this.parseContent(_18,_1c,true)[0];if(_1d){this._patchWidget(_1d);_15.push(_1d);this._children.push(_1d);_18=_1d.domNode;}}if(_1b!=this.declaredClass){_1.forEach(_18.children,_17,this);}}}else{_1.forEach(_18.children,_17,this);}};_17.call(this,_14);return _15;},startup:function(){var _1e=this.parseNode(this.domNode);mxui.widget.ready(_1e,_1.hitch(this,"actLoaded"));},resume:function(){if(this._doUpdate){this.refresh();this._doUpdate=false;}},applyContext:function(_1f,_20){this.mxcontext.mixin(_1f);this.update(_1f.getTrackId(),_20);},update:function(_21,_22){var _23=this;this._sourceGuid=_21;var _24=function(obj,_25){_23.mxcontext.setObject(obj);_23.updateObject(obj,_25);};this._source.fetch(function(obj){_24(obj,_22);},function(e){mx.onError(e);_24(null,_22);});},updateObject:function(obj,_26){if(obj!=this._mxObject){this._mxObject=obj;}this.setSubscriptions();this.refresh(_26);},setSubscriptions:function(){var obj=this._mxObject,_27=this._tempSubs,_28=this._sourceGuid,sub;var _29=function(){this.mxcontext.setTrackId(_28);this.update(_28);};var _2a=_1.hitch(this,"applyConditions");while((sub=_27.pop())){this.unsubscribe(sub);}if(obj){var _2b=obj.getGuid();_27.push(this.subscribe({guid:_2b,callback:_2a}));for(var _2c in this.conditions){_27.push(this.subscribe({guid:_2b,attr:_2c,callback:_2a}));}}if(this._source.hasRoot()&&_28){_27.push(this.subscribe({guid:_28,callback:_29}));_27.push(this.subscribe({guid:_28,attr:this._source.getRoot(),callback:_29}));}},refresh:function(_2d){if(this.get("suspended")){this._doUpdate=true;_2d&&_2d();}else{this.set("disabled",!this._mxObject);var _2e=this;this.passContext(_2.findWidgets(this.domNode),function(){_2e.applyConditions();_2d&&_2d();});}},validate:function(_2f,_30){var _31=this._mxObject;if(!_31||this.get("disabled")){_2f&&_2f();}else{var _32=this._children,_33=true;for(var i=0,_34;_34=_32[i];i++){if(_34.isValid&&!_34.isValid()){_33=false;}}if(_33){_2f&&_2f();}else{if(_30){_30();}else{if(mx.ui.getProfile()==="phone"){mx.ui.error(this.translate("validation_error"));}}}}},save:function(_35,_36){var _37=this._mxObject;if(!_37||this.get("disabled")){_35&&_35();}else{mx.data.save({mxobj:this._mxObject,callback:_35,error:_36},this);}},commit:function(_38,_39){var _3a=this._mxObject;if(!_3a||this.get("disabled")){_38();}else{mx.data.commit({mxobj:_3a,callback:_38,error:_39});}},rollback:function(_3b,_3c){var obj=this._mxObject;if(!obj||this.get("disabled")){_3b();}else{if(obj.getGuid()!==0){mx.data.rollback({mxobj:obj,callback:_3b,error:_3c});}else{_3b&&_3b();}}},close:function(_3d){if(this.closeButton){var _3e=_1.query("[data-mendix-id="+this.closeButton+"]",this.domNode)[0];if(_3e){_2.byNode(_3e).onClick();}else{logger.error(this.id+".close: No close button found");}}else{_3d&&_3d();}},getCFAction:function(_3f){var _40=_3f.getAttribute("data-mendix-id");if(_40){if(this._mxObject){var _41=this._mxidMap[_40];for(var _42 in _41){var _43=this._mxObject.get(_42),_44=_41[_42][_43===""?"_empty_":_43];for(var _45 in _44){return _45;}}}else{if(_40 in this._delayMap){return "hide";}}}},applyConditions:function(){var _46=[],_47=true,_48=false;var _49=function(_4a){var _4b=_47,_4c=!_4a.getAttribute("data-mendix-not-parsed"),_4d=this.getCFAction(_4a);_47=false;if(_4d=="show"){_48=true;if(!_4c){var _4e=this.parseNode(_4a);_46.push.apply(_46,_4e);_1.forEach(_4e,function(_4f){_49.call(this,_4f.domNode);},this);_4a.removeAttribute("data-mendix-not-parsed");_4c=true;}}if(_4d){mx.ui.applyToNode(_4d,_4a);}if(_4b||_4c&&!(_2.byNode(_4a) instanceof this.constructor)){_1.forEach(_4a.children,_49,this);}};_49.call(this,this.domNode);mxui.widget.ready(_46,function(){this.passContext(_46);if(_46.length||_48){this.mxform.resize();}},this);},resize:function(box){if(this._controlsNode){if(box){var _50=box.h-_1.marginBox(this._controlsNode).h;_1.contentBox(this._contentNode,{h:_50});}else{this._contentNode.style.height="auto";}this.resizeChildren(this._contentNode,!box);}},uninitialize:function(){this._source.destroy();},_patchWidget:function(_51){var _52=_51.name;if(!(_51 instanceof mxui.widget._WidgetBase)&&(typeof _51.onChange=="function")&&_52){this.connect(_51,"onChange",function(){var _53=_51.get("value");this._mxObject.set(_52,_53);});}}});});