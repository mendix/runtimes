/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/DataView",["mxui/widget/_WidgetBase","mxui/widget","mxui/dom","mxui/html/parser","webcore/objectsource/DirectObjectSource","webcore/objectsource/MicroflowObjectSource","webcore/objectsource/SchemaObjectSource","mendix/logger","webcore/objectsource/OfflineObjectSource","mxui/store/asyncValueStore","dijit/registry","dojo/dom-geometry","dojo/topic","dojo/aspect","dojo/_base/array","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){var _12=_11(_1,{declaredClass:"mxui.widget.DataView",entity:"",schema:"",autoLoad:false,datasource:null,conditions:null,contextsource:"",closeButton:"",hideControls:false,useSchema:false,noEntityMessage:"",_mxObject:null,_tempSubs:null,_mxidMap:null,_delayMap:null,_source:null,_contentNode:null,_controlsNode:null,_messageNode:null,_doUpdate:false,constructor:function(){this._tempSubs=[];},postMixInProperties:function(){this.doParse=true;},buildRendering:function(){var $=_3.create,_13=this.getTemplate("content"),_14=this.getTemplate("buttons");this.domNode=$("div",{"class":"mx-dataview"},$("div",{"class":"mx-dataview-content"},_13));this._contentNode=this.domNode.firstChild;if(this.noEntityMessage){this._messageNode=$("div",{"class":"mx-dataview-message","style":"display: none"},$("div",$("p",this.noEntityMessage)));this.domNode.appendChild(this._messageNode);}if(_14){var _15=this._controlsNode=$("div",{"class":"mx-dataview-controls"},_14);if(this.hideControls){_15.style.display="none";}this.domNode.appendChild(_15);}},postCreate:function(){var map=this._mxidMap={},_16=this._delayMap={};for(var _17 in this.conditions){var _18=this.conditions[_17];for(var _19 in _18){var _1a=_19===""?"_empty_":_19,_1b=_18[_19];_f.forEach(_1b,function(_1c){if(_1c.action==="show"||_1c.action==="hide"){_16[_1c.mxid]=1;}_10.setObject([_1c.mxid,_17,_1a,_1c.action].join("."),1,map);});}}if(!this.readOnly){this.listen("validate",this.validate);this.listen("save",this.save);this.listen("commit",this.commit);this.listen("rollback",this.rollback);_e.after(this.mxform,"onResume",_10.hitch(this,"resume"));}this.listen("close",this.close);this.createSource();},createSource:function(){var _1d=this.datasource;if(_1d){switch(_1d.type){case "listen":case "direct":if(this.useSchema==="true"){_1d.type="schema";this._source=new _7({schema:this.schema,context:this.mxcontext});}else{this._source=new _5({schema:this.schema,context:this.mxcontext,path:_1d.path||this.entity});}break;case "microflow":this._source=new _6({context:this.mxcontext,microflow:_1d.microflow});break;case "offline":this._source=new _9({context:this.mxcontext,path:_1d.path||this.entity});break;default:throw new Error(this.id+".createSource : unknown datasource type: "+_1d);}}if(_1d.type==="listen"){var _1e=window.mx.ui.makeShareId(this.mxform,this.datasource.contextsource),_1f=_10.hitch(this,function(_20){this.applyContext(_20,function(){});});this.own(_d.subscribe(_1e,_1f));this.addOnLoad(function(){_a.retrieve(_1e,_1f);});}},parseNode:function(_21){var _22=[],_23=true;var _24=function(_25){var _26=_23,_27=_25.getAttribute("data-mendix-id");_23=false;if(_27){if(!_26&&_27 in this._delayMap){_25.setAttribute("data-mendix-not-parsed",true);window.mx.ui.applyToNode("hide",_25);}else{var _28=_25.getAttribute("data-mendix-type");if(_28){var _29={doParse:false};if(this.schema===""&&_28===this.declaredClass){_29.schema="";}var _2a=this.parseContent(_25,_29,true)[0];if(_2a){this._patchWidget(_2a);_22.push(_2a);_25=_2a.domNode;}}if(this._shouldBeVisited(_25)){_f.forEach(_25.children,_24,this);}}}else{_f.forEach(_25.children,_24,this);}};_24.call(this,_21);return _22;},startup:function(){var _2b=this.parseNode(this.domNode);_2.ready(_2b,_10.hitch(this,"actLoaded"));},applyContext:function(_2c,_2d){this.mxcontext.mixin(_2c);this.update(this.mxcontext.getTrackId(),_2d);},update:function(_2e,_2f){var _30=this;this._sourceGuid=_2e;var _31=function(obj,_32){_30.mxcontext.setObject(obj);_30.updateObject(obj,_32);};this._source.fetch(function(obj){_31(obj,_2f);},function(e){window.mx.onError(e);_31(null,_2f);});},updateObject:function(obj,_33){if(obj!=this._mxObject){this._mxObject=obj;}this.setSubscriptions();this.refresh(_33);},setSubscriptions:function(){var obj=this._mxObject,_34=this._tempSubs,_35=this._sourceGuid,sub;var _36=function(){this.mxcontext.setTrackId(_35);this.update(_35);};var _37=_10.hitch(this,"applyConditions");while((sub=_34.pop())){this.unsubscribe(sub);}if(obj){var _38=obj.getGuid();_34.push(this.subscribe({guid:_38,callback:_37}));for(var _39 in this.conditions){_34.push(this.subscribe({guid:_38,attr:_39,callback:_37}));}}if(this._source.hasRoot()&&_35){_34.push(this.subscribe({guid:_35,callback:_36}));_34.push(this.subscribe({guid:_35,attr:this._source.getRoot(),callback:_36}));}},refresh:function(_3a){this.set("disabled",!this._mxObject);var _3b=this;if(this.mxform.isSuspended()){this._doUpdate=true;if(_3a){_3a();}return;}else{this._doUpdate=false;}if(this._messageNode){if(!this._mxObject){this._messageNode.style.display="block";}else{this._messageNode.style.display="none";}}this.passContext(_b.findWidgets(this.domNode),function(){_3b.applyConditions();if(_3a){_3a();}});},validate:function(_3c,_3d){var _3e=this._mxObject;if(!_3e||this.get("disabled")){if(_3c){_3c();}}else{var _3f=this.getChildren(true),_40=true;for(var i=0,_41;_41=_3f[i];i++){if(_41.isValid&&!_41.isValid()){_40=false;}}if(_40){if(_3c){_3c();}}else{if(_3d){_3d();}else{if(window.mx.ui.getProfile()==="phone"){window.mx.ui.error(this.translate("validation_error"));}}}}},save:function(_42,_43){var _44=this._mxObject;if(!_44||this.get("disabled")){if(_42){_42();}}else{window.mx.data.save({mxobj:this._mxObject,callback:_42,error:_43},this);}},commit:function(_45,_46){var _47=this._mxObject;if(!_47||this.get("disabled")){_45();}else{window.mx.data.commit({mxobj:_47,callback:_45,error:_46});}},resume:function(){if(this._doUpdate){this.refresh();this._doUpdate=false;}},rollback:function(_48,_49){var obj=this._mxObject;if(!obj||this.get("disabled")){_48();}else{if(obj.getGuid()!==0){window.mx.data.rollback({mxobj:obj,callback:_48,error:_49});}else{if(_48){_48();}}}},close:function(_4a){var _4b=this.closeButton&&this.domNode.querySelector("[data-mendix-id='"+this.closeButton+"']"),_4c=_4b&&_b.byNode(_4b);if(_4c){_4c.onClick();}else{if(_4a){_4a();}}},getCFActions:function(_4d){var _4e=_4d.getAttribute("data-mendix-id")||_4d.getAttribute("mxid"),_4f=[];if(_4e){if(this._mxObject){var _50=this._mxidMap[_4e];for(var _51 in _50){var _52=this._mxObject.get2(_51),_53=_50[_51][_52===""?"_empty_":_52];for(var _54 in _53){if(_54==="show"){_4f.unshift("show");}else{_4f.push(_54);}}}}else{if(_4e in this._delayMap){_4f.push("hide");}}}return _4f;},applyConditions:function(){var _55=[],_56=false;var _57=function(_58){var _59=!_58.getAttribute("data-mendix-not-parsed"),_5a=this.getCFActions(_58);dojo.forEach(_5a,function(_5b){if(_5b=="show"){_56=true;if(!_59){var _5c=this.parseNode(_58);_55.push.apply(_55,_5c);if(_3.isOrphan(_58)){_58=_5c[0].domNode;}_58.removeAttribute("data-mendix-not-parsed");_59=true;}}window.mx.ui.applyToNode(_5b,_58);},this);if(_59&&this._shouldBeVisited(_58)){_f.forEach(_58.children,_57,this);}};_57.call(this,this.domNode);_2.ready(_55,function(){this.passContext(_55);if(_55.length||_56){this.mxform.resize();}},this);},resize:function(box){if(box){var _5d=box.h-_3.getNodeExtents(this.domNode).h;if(this._controlsNode){_5d-=_c.getMarginBox(this._controlsNode).h;}_c.setContentSize(this._contentNode,{h:_5d});}else{this._contentNode.style.height="auto";}this._contentNode.style.overflow=box?"auto":"";this.resizeChildren(this._contentNode,!box);},uninitialize:function(){this._source.destroy();},getChildren:function(_5e){if(_5e){var _5f=[];_3.walkNode(this.domNode,function(_60){var _61=_60.nodeType===_3.nodeTypes.ELEMENT_NODE&&_b.byNode(_60);if(!_61||_61==this){return true;}_5f.push(_61);return !(_61 instanceof this.constructor);});return _5f;}else{this.inherited(arguments);}},_patchWidget:function(_62){var _63=_62.name;if(!(_62 instanceof _1)&&(typeof _62.onChange=="function")&&_63){this.connect(_62,"onChange",function(){var _64=_62.get("value");this._mxObject.set(_63,_64);});}},_shouldBeVisited:function(_65){return _65==this.domNode||!(_b.byNode(_65) instanceof this.constructor);}});return _12;});