/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/DataView",["mxui/widget/_WidgetBase","mxui/widget","mxui/dom","mxui/html/parser","webcore/objectsource/DirectObjectSource","webcore/objectsource/MicroflowObjectSource","webcore/objectsource/SchemaObjectSource","mendix/lib/MxContext","mendix/lib/ValidationError","mxui/store/asyncValueStore","dijit/registry","dojo/dom-geometry","dojo/topic","dojo/aspect","dojo/_base/array","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){var _12=_11(_1,{declaredClass:"mxui.widget.DataView",entity:"",schema:"",autoLoad:false,datasource:null,conditions:null,hideFooter:false,useSchema:false,noEntityMessage:"",_mxObject:undefined,_mxidMap:null,_delayMap:null,_source:null,_parentContext:null,_contentNode:null,_controlsNode:null,_messageNode:null,_doUpdate:false,constructor:function(){this._parentContext=new _8();},postMixInProperties:function(){this.doParse=true;},buildRendering:function(){var $=_3.create,_13=this.getTemplate("content"),_14=this.getTemplate("footer");this.domNode=$("div",{"class":"mx-dataview"},$("div",{"class":"mx-dataview-content"},_13));this._contentNode=this.domNode.firstChild;if(this.noEntityMessage){this._messageNode=$("div",{"class":"mx-dataview-message","style":"display: none"},$("div",$("p",this.noEntityMessage)));this.domNode.appendChild(this._messageNode);}if(_14){var _15=this._controlsNode=$("div",{"class":"mx-dataview-controls"},_14);if(this.hideFooter){_15.style.display="none";}this.domNode.appendChild(_15);}},postCreate:function(){var map=this._mxidMap={},_16=this._delayMap={};for(var _17 in this.conditions){var _18=this.conditions[_17];for(var _19 in _18){var _1a=_19===""?"_empty_":_19,_1b=_18[_19];_f.forEach(_1b,function(_1c){if(_1c.action==="show"||_1c.action==="hide"){_16[_1c.mxid]=1;}_10.setObject([_1c.mxid,_17,_1a,_1c.action].join("."),1,map);});}}if(!this.readOnly){this.listen("validate",this.validate);this.own(this.mxform.addSubmitProvider(this.id,this._getSubmitObjects.bind(this)));this.own(_e.after(this.mxform,"onResume",_10.hitch(this,"resume")));}this.createSource();},createSource:function(){var _1d=this.datasource;if(_1d){switch(_1d.type){case "listen":case "direct":if(this.useSchema){_1d.type="schema";this._source=new _7({schema:this.schema,context:this._parentContext});}else{this._source=new _5({schema:this.schema,context:this._parentContext,path:_1d.path||this.entity});}break;case "microflow":this._source=new _6({context:this._parentContext,microflow:_1d.microflow,parameters:_1d.parameters});break;default:throw new Error(this.id+".createSource : unknown datasource type: "+_1d);}}if(_1d.type==="listen"){var _1e=window.mx.ui.makeShareId(this.mxform,this.datasource.contextsource),_1f=_10.hitch(this,function(_20){this.applyContext(_20,function(){});});this.own(_d.subscribe(_1e,_1f));this.addOnLoad(function(){_a.retrieve(_1e,_1f);});}},parseNode:function(_21){var _22=[],_23=true;var _24=function(_25){var _26=_23,_27=_25.getAttribute("data-mendix-id");_23=false;if(_27){if(!_26&&_27 in this._delayMap){_25.setAttribute("data-mendix-not-parsed",true);window.mx.ui.applyToNode("hide",_25);}else{var _28=_25.getAttribute("data-mendix-type");if(_28){var _29={doParse:false};if(this.schema===""&&_28===this.declaredClass){_29.schema="";}var _2a=this.parseContent(_25,_29,true)[0];if(_2a){this._patchWidget(_2a);_22.push(_2a);_25=_2a.domNode;}}if(this._shouldBeVisited(_25)){_f.forEach(_25.children,_24,this);}}}else{_f.forEach(_25.children,_24,this);}};_24.call(this,_21);return _22;},startup:function(){var _2b=this.parseNode(this.domNode);_2.ready(_2b,_10.hitch(this,"actLoaded"));},applyContext:function(_2c,_2d){this.mxcontext.mixin(_2c);this._parentContext.mixin(_2c);this._update(_2d);},_update:function(_2e){var _2f=this;this._source.fetch(function(obj){_30(obj);},function(e){window.mx.onError(e);_30(null);});function _30(obj){_2f._mxObject=obj;_2f.mxcontext.setObject(obj);_2f._setSubscriptions();_2f.refresh(_2e);};},_setSubscriptions:function(){this.unsubscribeAll();if(this._mxObject){var _31=this._mxObject.getGuid();this.subscribe({guid:_31,callback:this.applyConditions.bind(this,null)});for(var _32 in this.conditions){this.subscribe({guid:_31,attr:_32,callback:this.applyConditions.bind(this,null)});}}this._source.getDependencies().forEach(function(_33){_33.callback=this._update.bind(this,null);this.subscribe(_33);},this);},refresh:function(_34){this.set("disabled",!this._mxObject);if(this.mxform.isSuspended()){this._doUpdate=true;if(_34){_34();}return;}else{this._doUpdate=false;}if(this._messageNode){if(!this._mxObject){this._messageNode.style.display="block";}else{this._messageNode.style.display="none";}}this.passContext(_b.findWidgets(this.domNode),_10.hitch(this,"applyConditions",_34));},validate:function(_35,_36){var _37=this._mxObject;if(!_37||this.get("disabled")){if(_35){_35();}}else{var _38=this.getChildren(true),_39=true;for(var i=0,_3a;_3a=_38[i];i++){if(_3a.isValid&&!_3a.isValid()){_39=false;}}if(_39){if(_35){_35();}}else{var _3b=this.translate("validation_error");if(_36){_36(new _9(_3b));}else{if(window.mx.ui.getProfile()==="phone"){window.mx.ui.error(_3b);}}}}},resume:function(){if(this._doUpdate){this.refresh();this._doUpdate=false;}},getCFActions:function(_3c){var _3d=_3c.getAttribute("data-mendix-id")||_3c.getAttribute("mxid"),_3e=[];if(_3d){if(this._mxObject){var _3f=this._mxidMap[_3d];for(var _40 in _3f){var _41=this._mxObject.get2(_40),_42=_3f[_40][_41===""?"_empty_":_41];for(var _43 in _42){if(_43==="show"){_3e.unshift("show");}else{_3e.push(_43);}}}}else{if(_3d in this._delayMap){_3e.push("hide");}}}return _3e;},applyConditions:function(_44){var _45=[],_46=false;var _47=function(_48){var _49=!_48.getAttribute("data-mendix-not-parsed"),_4a=this.getCFActions(_48);_4a.forEach(function(_4b){if(_4b=="show"){_46=true;if(!_49){var _4c=this.parseNode(_48);_45.push.apply(_45,_4c);if(_3.isOrphan(_48)){_48=_4c[0].domNode;}_48.removeAttribute("data-mendix-not-parsed");_49=true;}}window.mx.ui.applyToNode(_4b,_48);},this);if(_49&&this._shouldBeVisited(_48)){_f.forEach(_48.children,_47,this);}};_47.call(this,this.domNode);_2.ready(_45,function(){this.passContext(_45,function(){if(_45.length||_46){this.mxform.resize();}if(_44){_44();}});},this);},resize:function(box){if(box){var _4d=box.h-_3.getNodeExtents(this.domNode).h;if(this._controlsNode){_4d-=_c.getMarginBox(this._controlsNode).h;}_c.setContentSize(this._contentNode,{h:_4d});}else{this._contentNode.style.height="auto";}this._contentNode.style.overflow=box?"auto":"";this.resizeChildren(this._contentNode,!box);},uninitialize:function(){this._source.destroy();},getChildren:function(_4e){if(_4e){var _4f=[];_3.walkNode(this.domNode,function(_50){var _51=_50.nodeType===_3.nodeTypes.ELEMENT_NODE&&_b.byNode(_50);if(!_51||_51==this){return true;}_4f.push(_51);return !(_51 instanceof this.constructor);});return _4f;}else{this.inherited(arguments);}},_patchWidget:function(_52){var _53=_52.name;if(!(_52 instanceof _1)&&(typeof _52.onChange=="function")&&_53){this.connect(_52,"onChange",function(){var _54=_52.get("value");this._mxObject.set(_53,_54);});}},_shouldBeVisited:function(_55){return _55==this.domNode||!(_b.byNode(_55) instanceof this.constructor);},_getSubmitObjects:function(){var _56=this._mxObject&&this._mxObject.getGuid()!=="0"&&!this.get("disabled");var _57=_56?[this._mxObject]:[];return _57;}});return _12;});