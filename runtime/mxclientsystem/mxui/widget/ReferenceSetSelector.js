/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/ReferenceSetSelector",["mxui/widget/DataGrid","webcore/datasource/ReferenceSetSource","mxui/widget/_WidgetBase","mxui/mixin/_Contextable","mxui/dom","mendix/lang","mendix/logger","dojo/dom-class","dojo/_base/lang","dojo/_base/declare","dijit/_Container","dijit/_Contained"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){var _d=_a([_3,_b,_c,_4],{declaredClass:"mxui.widget.ReferenceSetSelector",entity:"",xpathConstraint:"",config:null,_datasource:null,_datagrid:null,_sourceObject:null,_mendixGuid:null,_oldXPath:null,_gridBacktrack:null,_errorNode:null,_oldActionDeleteSelection:null,_hasError:false,postCreate:function(){this._gridBacktrack=this.backtrackconstraints;delete this.backtrackconstraints;this.initContext();var _e=this.config.datasource.path.split("/");this.entity=_e.pop();this.sourceReference=_e.pop();this.createGrid();},createGrid:function(){this._datasource=new _2(_9.mixin({queryid:this.schema},this.config.datasource));this._datagrid=new _1({mxid:this.mxid,uniqueid:this.uniqueid+"_grid",mxform:this.mxform,contextname:this.contextname,entity:this.entity,schema:this.schema,customDataSource:this._datasource,config:this.config});this._datagrid.addOnLoad(_9.hitch(this,"actLoaded"));this._oldActionDeleteSelection=this._datagrid.actionDeleteSelection;_9.mixin(this._datagrid,{actionAddRef:_9.hitch(this,"handlerAdd"),actionCreateRef:_9.hitch(this,"handlerCreate"),actionDeleteRef:this.makeRemoveHandler(false),actionDeleteSelection:this.makeRemoveHandler(true),registerSubscriptions:_9.hitch(this,"registerSubscriptions")});this.domNode.appendChild(this._datagrid.domNode);},handlerAdd:function(_f){if(this._sourceObject){this._openAddForm(_f[this.entity].pageSettings);}},handlerCreate:function(_10){if(!this._sourceObject){return;}var _11=this._getEntity(_10);window.mx.data.create({entity:_11,callback:function(obj){var _12=this.createContext();_12.setTrackEntity(_11);_12.setTrackId(obj.getGuid());window.mx.ui.execute({type:"openPage",params:_10[_11].pageSettings},{origin:this.mxform,context:_12,callback:function(_13){_13.listen("commit",_9.hitch(this,function(_14){this._sourceObject.addReferences(this.sourceReference,[obj.getGuid()]);this.onChange();_14();}));}},this);},error:function(e){window.mx.onError(e);}},this);},makeRemoveHandler:function(_15){var _16=this;return function(){var _17=_16._datagrid.getSelected();if(_17.length===0){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{window.mx.ui.confirmation({content:window.mx.ui.translate("mxui.widget.DataGrid","confirm_delete",[_17.length]),handler:function(){if(_15){_16._oldActionDeleteSelection.call(_16._datagrid,true);}_16._sourceObject.removeReferences(_16.sourceReference,_17);_16.onChange();if(!_15){_16._datagrid.deselectAll();_16._datagrid.reload();}}});}};},registerSubscriptions:function(){this.unsubscribeAll();this.subscribe({guid:this._mendixguid,attr:this.sourceReference,callback:function(_18){this.objectUpdate(_18);}});this.subscribe({entity:this.entity,callback:_9.hitch(this,function(){this.objectUpdate.apply(this,arguments);})});this.subscribe({guid:this._mendixguid,callback:_9.hitch(this,"objectUpdate")});this.subscribe({guid:this._mendixguid,val:true,callback:_9.hitch(this,"onValidation")});},applyContext:function(_19,_1a){if(_19!=null&&_19.hasTrackId()){this.cloneContext(_19);var _1b=(this._mendixguid==null||this._mendixguid!=_19.getTrackId());this._mendixguid=_19.getTrackId();this.mxcontext.setConstraints(this.constrainedBy);this.registerSubscriptions();this.updateSequence(_1b,_1a);}else{this.unsubscribeAll();this.removeContext(_1a);}this.removeError();},removeContext:function(_1c){if(this._datagrid.removeContext){this._datagrid.removeContext(_1c);}else{if(_1c){_1c();}}},updateSequence:function(_1d,_1e){var _1f=[];if(_1d){_1f.push("actFetchSourceObject");}_1f.push("actUpdateGrid");if(!_1d){_1f.push("actCompareSet");}this.sequence(_1f,_1e);},actFetchSourceObject:function(_20){var _21=this;if(this._mendixguid){window.mx.data.get({guid:this._mendixguid,callback:function(obj){_21._sourceObject=obj;_21._datasource.setObject(obj);_21._datagrid.set("readOnly",_21._sourceObject.isReadonlyAttr(_21.sourceReference));_20();},error:function(e){window.mx.onError(e);if(_20){_20();}}});}else{if(_20){_20();}}},actUpdateGrid:function(_22){this._oldXPath=this._datagrid.getCurrentXPath();this._datagrid.applyContext(this.mxcontext,_22);},actCompareSet:function(_23){var _24=this._datagrid.getCurrentXPath();if(!this._oldXPath.match("[1=0]")&&this._oldXPath!=_24){this._sourceObject.set(this.sourceReference,"");this.onChange();}else{if(_23){_23();}}},objectUpdate:function(_25,_26){this.updateSequence();if(_26){_26();}},_setDisabledAttr:function(_27){var _28=this._datagrid,_29=_27===true;_28.set("disabled",_27);_28.set("selectable",!_29);_28.set("toolbar",_29);},_getDisabledAttr:function(){return this._datagrid.get("disabled");},onChange:function(){this.removeError();if(this.events&&this.events.change){window.mx.ui.execute({type:"callMicroflow",params:this.events.change},{origin:this.mxform,context:this.mxcontext,abortOnClientValidations:true});}},onValidation:function(_2a){var val=_2a[0],_2b=this.sourceReference,msg=val.getReasonByAttribute(_2b);if(msg){this.addError(msg);val.removeAttribute(_2b);}},addError:function(msg){this.removeError();this._hasError=true;if(msg){this._errorNode=_5.create("div",{"class":"alert alert-danger"},msg);this.domNode.parentNode.appendChild(this._errorNode);this.mxform.resize();}_8.add(this.domNode,"has-error");if(this.validator){this.validator.addNotification();}},removeError:function(){if(this._errorNode){_5.orphan(this._errorNode);this._errorNode=null;}_8.remove(this.domNode,"has-error");if(this.validator&&this._hasError){this.validator.removeNotification();}this._hasError=false;},_openAddForm:function(_2c){var _2d=this;var _2e=this.createContext();_2e.dupFrom(this.mxcontext);_2e.unsetContext(this.entity);_2e.setConstraints(this._gridBacktrack);window.mx.ui.execute({type:"openPage",params:_2c},{origin:this.mxform,context:_2e,targetParams:{selection:[],listViewSelectionMode:"multi",dataSourceMixin:{constraint:this.xpathConstraint}},callback:function(_2f){_2f.listen("commit",function(_30){var _31=_6.find(_2f.getChildren(true),function(_32){return "getSelected" in _32;}),_33=_31.getSelected();if(_33.length>0){_2d._sourceObject.addReferences(_2d.sourceReference,_33);_2d.onChange();}_30();});}});},_getEntity:function(_34){for(var i in _34){return i;}}});return _d;});