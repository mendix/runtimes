/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/ReferenceSetSelector",["mxui/widget/DataGrid","webcore/datasource/ReferenceSetSource","mxui/widget/_WidgetBase","mxui/mixin/_Contextable","mxui/dom","mendix/lang","mendix/logger","dojo/dom-class","dojo/_base/lang","dojo/_base/declare","dijit/_Container","dijit/_Contained"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){var _d=_a([_3,_b,_c,_4],{declaredClass:"mxui.widget.ReferenceSetSelector",entity:"",xpathConstraint:"",config:null,_datasource:null,_datagrid:null,_sourceObject:null,_mendixGuid:null,_oldXPath:null,_gridBacktrack:null,_errorNode:null,_oldActionDeleteSelection:null,_hasError:false,postCreate:function(){this._gridBacktrack=this.backtrackconstraints;delete this.backtrackconstraints;this.initContext();var _e=this.config.datasource.path.split("/");this.entity=_e.pop();this.sourceReference=_e.pop();this.createGrid();},createGrid:function(){this._datasource=new _2(_9.mixin({queryid:this.schema},this.config.datasource));this._datagrid=new _1({mxid:this.mxid,uniqueid:this.uniqueid+"_grid",mxform:this.mxform,contextname:this.contextname,entity:this.entity,schema:this.schema,customDataSource:this._datasource,config:this.config});this._datagrid.addOnLoad(_9.hitch(this,"actLoaded"));this._oldActionDeleteSelection=this._datagrid.actionDeleteSelection;_9.mixin(this._datagrid,{actionAddRef:_9.hitch(this,"handlerAdd"),actionCreateRef:_9.hitch(this,"handlerCreate"),actionDeleteRef:this.makeRemoveHandler(false),actionDeleteSelection:this.makeRemoveHandler(true),registerSubscriptions:_9.hitch(this,"registerSubscriptions")});this.domNode.appendChild(this._datagrid.domNode);},handlerAdd:function(_f){this._sourceObject&&this._openAddForm(_f[this.entity]);},handlerCreate:function(_10){var _11=this._getEntity(_10),_12=_10[_11];if(_12==null){return;}if(!this._sourceObject){return;}var _13=this.createContext();window.mx.data.create({entity:_11,persistent:_12.persistent,callback:function(_14){var ent,_15;ent=_14.getEntity();_15=_14.getGuid();_13.setTrackEntity(ent);_13.setTrackId(_15);this.onChange();window.mx.ui.execute(_12,{context:_13,callback:function(_16){_16.listen("save",_9.hitch(this,function(_17){this._sourceObject.addReferences(this.sourceReference,[_15]);_17();}));}},this);},error:function(e){window.mx.onError(e);}},this);},makeRemoveHandler:function(_18){var _19=this;return function(){var _1a=_19._datagrid.getSelected();if(_1a.length===0){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{window.mx.ui.confirmation({content:window.mx.ui.translate("mxui.widget.DataGrid","confirm_delete",[_1a.length]),handler:function(){if(_18){_19._oldActionDeleteSelection.call(_19._datagrid,true);}_19._sourceObject.removeReferences(_19.sourceReference,_1a);_19.onChange();if(!_18){_19._datagrid.deselectAll();_19._datagrid.reload();}}});}};},registerSubscriptions:function(){this.unsubscribeAll();this.subscribe({guid:this._mendixguid,attr:this.sourceReference,callback:function(_1b){this.objectUpdate(_1b);}});this.subscribe({entity:this.entity,callback:_9.hitch(this,function(){this.objectUpdate.apply(this,arguments);})});this.subscribe({guid:this._mendixguid,callback:_9.hitch(this,"objectUpdate")});this.subscribe({guid:this._mendixguid,val:true,callback:_9.hitch(this,"onValidation")});},applyContext:function(_1c,_1d){if(_1c!=null&&_1c.hasTrackId()){this.cloneContext(_1c);var _1e=(this._mendixguid==null||this._mendixguid!=_1c.getTrackId());this._mendixguid=_1c.getTrackId();this.mxcontext.setConstraints(this.constrainedBy);this.registerSubscriptions();this.updateSequence(_1e,_1d);}else{this.unsubscribeAll();this.removeContext(_1d);}},removeContext:function(_1f){if(this._datagrid.removeContext){this._datagrid.removeContext(_1f);}else{_1f&&_1f();}},updateSequence:function(_20,_21){var _22=[];if(_20){_22.push("actFetchSourceObject");}_22.push("actUpdateGrid");if(!_20){_22.push("actCompareSet");}_21&&_22.push(_21);this.sequence(_22);},actFetchSourceObject:function(_23){var _24=this;if(this._mendixguid){window.mx.data.get({guid:this._mendixguid,callback:function(obj){_24._sourceObject=obj;_24._datasource.setObject(obj);_24._datagrid.set("readOnly",_24._sourceObject.isReadonlyAttr(_24.sourceReference));_23();},error:function(e){window.mx.onError(e);_23&&_23();}});}else{_23&&_23();}},actUpdateGrid:function(_25){this._oldXPath=this._datagrid.getCurrentXPath();this._datagrid.applyContext(this.mxcontext,_25);},actCompareSet:function(_26){var _27=this._datagrid.getCurrentXPath();if(!this._oldXPath.match("[1=0]")&&this._oldXPath!=_27){this._sourceObject.set(this.sourceReference,"");this.onChange();}else{_26&&_26();}},objectUpdate:function(_28,_29){this.updateSequence();_29&&_29();},_setDisabledAttr:function(_2a){var _2b=this._datagrid,_2c=_2a===true;_2b.set("disabled",_2a);_2b.set("selectable",!_2c);_2b.set("toolbar",_2c);},_getDisabledAttr:function(){return this._datagrid.get("disabled");},onChange:function(){var ev=this.events&&this.events.change;this.validateForMicroflow(ev,_9.hitch(this,"callMicroflow",ev));},validateForMicroflow:function(_2d,_2e){if(_2d&&_2d.validate=="view"){this.mxform.save(_2e);}else{_2e&&_2e();}},onValidation:function(_2f){var val=_2f[0],_30=this.sourceReference,msg=val.getReasonByAttribute(_30);if(msg){this.addError(msg);val.removeAttribute(_30);}},callMicroflow:function(_31){if(_31){window.mx.ui.execute({microflow:_31},{context:this.mxcontext});}},addError:function(msg){this.removeError();this._hasError=true;if(msg){this._errorNode=_5.create("div",{"class":"alert alert-danger"},msg);this.domNode.parentNode.appendChild(this._errorNode);this.mxform.resize();}_8.add(this.domNode,"has-error");if(this.validator){this.validator.addNotification();}},removeError:function(){if(this._errorNode){_5.orphan(this._errorNode);this._errorNode=null;}_8.remove(this.domNode,"has-error");if(this.validator&&this._hasError){this.validator.removeNotification();}this._hasError=false;},_openAddForm:function(_32){var _33=this;var _34=this.createContext();_34.dupFrom(this.mxcontext);_34.unsetContext(this.entity);_34.setConstraints(this._gridBacktrack);window.mx.ui.execute(_32,{context:_34,params:{selection:[],listViewSelectionMode:"multi",dataSourceMixin:{constraint:this.xpathConstraint}},callback:function(_35){_35.listen("save",function(_36){var _37=_6.find(_35.getChildren(true),function(_38){return "getSelected" in _38;}),_39=_37.getSelected();_33._sourceObject.addReferences(_33.sourceReference,_39);_33.onChange();_36();});}});},_getEntity:function(_3a){for(var i in _3a){return i;}}});return _d;});