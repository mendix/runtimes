/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/ReferenceSetSelector",["mxui/widget/DataGrid","mendix/lib/ReferenceSetSource","mxui/widget/_WidgetBase","mxui/mixin/_Contextable","mxui/dom","mendix/lang","mendix/logger","dojo/dom-class","dojo/_base/lang","dojo/_base/declare","dijit/_Container","dijit/_Contained"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){var _d=_a([_3,_b,_c,_4],{declaredClass:"mxui.widget.ReferenceSetSelector",entity:"",reference:"",xpathConstraint:"",_datasource:null,_datagrid:null,_sourceObject:null,_mendixGuid:null,_oldXPath:null,_gridBacktrack:null,_errorNode:null,_oldActionDeleteSelection:null,_hasError:false,postCreate:function(){this._gridBacktrack=this.backtrackconstraints;delete this.backtrackconstraints;this.initContext();var _e=this.reference.split("/");this.sourceReference=_e.pop();this.sourceEntity=_e.pop();if(this.entity&&this.sourceEntity&&this.sourceReference){this.createGrid();}else{throw new Error(this.id+".postCreate : Not all params are filled.");}},createGrid:function(){this._datasource=new _2({entity:this.entity,reference:this.sourceReference,queryid:this.schema});this._datagrid=new _1({mxid:this.mxid,mxform:this.mxform,app_flow_id:this.app_flow_id,contextname:this.contextname,entity:this.entity,schema:this.schema,config:this.config,template:this.template,dropcontext:this.dropcontext,customDataSource:this._datasource});this._datagrid.addOnLoad(_9.hitch(this,"actLoaded"));this._oldActionDeleteSelection=this._datagrid.actionDeleteSelection;_9.mixin(this._datagrid,{actionAddRef:_9.hitch(this,"handlerAdd"),actionSelectRef:_9.hitch(this,"handlerSelect"),actionCreateRef:_9.hitch(this,"handlerCreate"),actionDeleteRef:this.makeRemoveHandler(false),actionDeleteSelection:this.makeRemoveHandler(true),registerSubscriptions:_9.hitch(this,"registerSubscriptions")});this.domNode.appendChild(this._datagrid.domNode);},handlerAdd:function(_f){this._sourceObject&&this._openAddForm(_f[this.entity]);},handlerSelect:function(_10){this._sourceObject&&this._openAddForm(_10[this.entity],true);},handlerCreate:function(_11){var _12=this._getEntity(_11),_13=_11[_12];if(_13==null){return;}if(!this._sourceObject){return;}var _14=this.createContext();window.mx.data.create({entity:_12,persistent:_13.persistent,callback:function(_15){var ent,_16;ent=_15.getEntity();_16=_15.getGuid();_14.setTrackEntity(ent);_14.setTrackId(_16);this.onChange();window.mx.ui.execute(_13,{context:_14,callback:function(_17){_17.listen("save",_9.hitch(this,function(_18){this._sourceObject.addReferences(this.sourceReference,[_16]);_18();}));}},this);},error:function(e){window.mx.onError(e);}},this);},makeRemoveHandler:function(_19){var _1a=this;return function(){var _1b=_1a._datagrid.getSelected();if(_1b.length===0){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{window.mx.ui.confirmation({content:window.mx.ui.translate("mxui.widget.DataGrid","confirm_delete",[_1b.length]),handler:function(){if(_19){_1a._oldActionDeleteSelection.call(_1a._datagrid,true);}_1a._sourceObject.removeReferences(_1a.sourceReference,_1b);_1a.onChange();if(!_19){_1a._datagrid.deselectAll();_1a._datagrid.reload();}}});}};},registerSubscriptions:function(){this.unsubscribeAll();this.subscribe({guid:this._mendixguid,attr:this.sourceReference,callback:function(_1c){this.objectUpdate(_1c);}});this.subscribe({entity:this.entity,callback:_9.hitch(this,function(){this.objectUpdate.apply(this,arguments);})});this.subscribe({guid:this._mendixguid,callback:_9.hitch(this,"objectUpdate")});this.subscribe({guid:this._mendixguid,val:true,callback:_9.hitch(this,"onValidation")});},applyContext:function(_1d,_1e){if(_1d!=null&&_1d.hasTrackId()){this.cloneContext(_1d);var _1f=(this._mendixguid==null||this._mendixguid!=_1d.getTrackId());this._mendixguid=_1d.getTrackId();this.mxcontext.setConstraints(this.constrainedBy);this.registerSubscriptions();this.updateSequence(_1f,_1e);}else{this.unsubscribeAll();this.removeContext(_1e);}},removeContext:function(_20){if(this._datagrid.removeContext){this._datagrid.removeContext(_20);}else{_20&&_20();}},updateSequence:function(_21,_22){var _23=[];if(_21){_23.push("actFetchSourceObject");}_23.push("actUpdateGrid");if(!_21){_23.push("actCompareSet");}_22&&_23.push(_22);this.sequence(_23);},actFetchSourceObject:function(_24){var _25=this;if(this._mendixguid){window.mx.data.get({guid:this._mendixguid,callback:function(obj){_25._sourceObject=obj;_25._datasource.setObject(obj);_25._datagrid.set("readOnly",_25._sourceObject.isReadonlyAttr(_25.sourceReference));_24();},error:function(e){window.mx.onError(e);_24&&_24();}});}else{_24&&_24();}},actUpdateGrid:function(_26){this._oldXPath=this._datagrid.getCurrentXPath();this._datagrid.applyContext(this.mxcontext,_26);},actCompareSet:function(_27){var _28=this._datagrid.getCurrentXPath();if(!this._oldXPath.match("[1=0]")&&this._oldXPath!=_28){this._sourceObject.set(this.sourceReference,"");this.onChange();}else{_27&&_27();}},objectUpdate:function(_29,_2a){this.updateSequence();_2a&&_2a();},_setDisabledAttr:function(_2b){var _2c=this._datagrid,_2d=_2b===true;_2c.set("disabled",_2b);_2c.set("selectable",!_2d);_2c.set("toolbar",_2d);},_getDisabledAttr:function(){return this._datagrid.get("disabled");},onChange:function(){var ev=this.events&&this.events.change;this.validateForMicroflow(ev,_9.hitch(this,"callMicroflow",ev));},validateForMicroflow:function(_2e,_2f){if(_2e&&_2e.validate=="view"){this.mxform.save(_2f);}else{_2f&&_2f();}},onValidation:function(_30){var val=_30[0],_31=this.sourceReference,msg=val.getReasonByAttribute(_31);if(msg){this.addError(msg);val.removeAttribute(_31);}},callMicroflow:function(_32){if(_32){window.mx.ui.execute({microflow:_32},{context:this.mxcontext});}},addError:function(msg){this.removeError();this._hasError=true;if(msg){this._errorNode=_5.create("div",{"class":"alert alert-danger"},msg);this.domNode.parentNode.appendChild(this._errorNode);this.mxform.resize();}_8.add(this.domNode,"has-error");if(this.validator){this.validator.addNotification();}},removeError:function(){if(this._errorNode){_5.orphan(this._errorNode);this._errorNode=null;}_8.remove(this.domNode,"has-error");if(this.validator&&this._hasError){this.validator.removeNotification();}this._hasError=false;},_openAddForm:function(_33,_34){var _35=this;var _36=this.createContext();_36.dupFrom(this.mxcontext);_36.unsetContext(this.entity);_36.setConstraints(this._gridBacktrack);window.mx.ui.execute(_33,{context:_36,params:{selection:_34?this._sourceObject.getReferences(this.sourceReference):[],selectable:"multi",constraint:this.xpathConstraint},callback:function(_37){_37.listen("save",function(_38){var _39=_6.find(_37.getChildren(true),function(_3a){return "getSelected" in _3a;}),_3b=_39.getSelected();if(_34){_35._sourceObject.set(_35.sourceReference,_3b);}else{_35._sourceObject.addReferences(_35.sourceReference,_3b);}_35.onChange();_38();});}});},_getEntity:function(_3c){for(var i in _3c){return i;}}});return _d;});