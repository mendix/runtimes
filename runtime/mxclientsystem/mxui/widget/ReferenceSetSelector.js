/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/ReferenceSetSelector",["mxui/widget/DataGrid","mendix/lib/ReferenceSetSource","mxui/widget/_WidgetBase","mxui/mixin/_Contextable","mxui/dom","mendix/lang","mendix/logger","dojo/dom-class","dojo/_base/lang","dojo/_base/declare","dijit/_Container","dijit/_Contained"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){var _d=_a([_3,_b,_c,_4],{declaredClass:"mxui.widget.ReferenceSetSelector",entity:"",reference:"",xpathConstraint:"",_datasource:null,_datagrid:null,_sourceObject:null,_mendixGuid:null,_oldXPath:null,_gridBacktrack:null,_cellNode:null,_errorNode:null,_oldActionDeleteSelection:null,_hasError:false,postCreate:function(){this._gridBacktrack=this.backtrackconstraints;delete this.backtrackconstraints;this.initContext();var _e=this.reference.split("/");this.sourceReference=_e.pop();this.sourceEntity=_e.pop();var _f=this.domNode.parentNode;if(_f.nodeName=="TD"){this._cellNode=_f;}if(this.entity&&this.sourceEntity&&this.sourceReference){this.createGrid();}else{throw new Error(this.id+".postCreate : Not all params are filled.");}},createGrid:function(){this._datasource=new _2({entity:this.entity,reference:this.sourceReference,queryid:this.schema});this._datagrid=new _1({mxid:this.mxid,mxform:this.mxform,app_flow_id:this.app_flow_id,contextname:this.contextname,entity:this.entity,schema:this.schema,config:this.config,template:this.template,dropcontext:this.dropcontext,customDataSource:this._datasource});this._datagrid.addOnLoad(_9.hitch(this,"actLoaded"));this._oldActionDeleteSelection=this._datagrid.actionDeleteSelection;_9.mixin(this._datagrid,{actionAddRef:_9.hitch(this,"handlerAdd"),actionSelectRef:_9.hitch(this,"handlerSelect"),actionCreateRef:_9.hitch(this,"handlerCreate"),actionDeleteRef:this.makeRemoveHandler(false),actionDeleteSelection:this.makeRemoveHandler(true),registerSubscriptions:_9.hitch(this,"registerSubscriptions")});this.domNode.appendChild(this._datagrid.domNode);},handlerAdd:function(_10){this._sourceObject&&this._openAddForm(_10[this.entity]);},handlerSelect:function(_11){this._sourceObject&&this._openAddForm(_11[this.entity],true);},handlerCreate:function(_12){var _13=this._getEntity(_12),_14=_12[_13];if(_14==null){return;}if(!this._sourceObject){return;}var _15=this.createContext();window.mx.data.create({entity:_13,persistent:_14.persistent,callback:function(_16){var ent,_17;ent=_16.getEntity();_17=_16.getGuid();_15.setTrackEntity(ent);_15.setTrackId(_17);this.onChange();window.mx.ui.execute(_14,{context:_15,callback:function(_18){_18.listen("save",_9.hitch(this,function(_19){this._sourceObject.addReferences(this.sourceReference,[_17]);_19();}));}},this);},error:function(e){window.mx.onError(e);}},this);},makeRemoveHandler:function(_1a){var _1b=this;return function(){var _1c=_1b._datagrid.getSelected();if(_1c.length===0){window.mx.ui.info(window.mx.ui.translate("mxui.widget.DataGrid","no_selection"));}else{window.mx.ui.confirmation({content:window.mx.ui.translate("mxui.widget.DataGrid","confirm_delete",[_1c.length]),handler:function(){if(_1a){_1b._oldActionDeleteSelection.call(_1b._datagrid,true);}_1b._sourceObject.removeReferences(_1b.sourceReference,_1c);_1b.onChange();if(!_1a){_1b._datagrid.deselectAll();_1b._datagrid.reload();}}});}};},registerSubscriptions:function(){this.unsubscribeAll();this.subscribe({guid:this._mendixguid,attr:this.sourceReference,callback:function(_1d){this.objectUpdate(_1d);}});this.subscribe({entity:this.entity,callback:_9.hitch(this,function(){this.objectUpdate.apply(this,arguments);})});this.subscribe({guid:this._mendixguid,callback:_9.hitch(this,"objectUpdate")});this.subscribe({guid:this._mendixguid,val:true,callback:_9.hitch(this,"onValidation")});},applyContext:function(_1e,_1f){if(_1e!=null&&_1e.hasTrackId()){this.cloneContext(_1e);var _20=(this._mendixguid==null||this._mendixguid!=_1e.getTrackId());this._mendixguid=_1e.getTrackId();this.mxcontext.setConstraints(this.constrainedBy);this.registerSubscriptions();this.updateSequence(_20,_1f);}else{this.unsubscribeAll();this.removeContext(_1f);}},removeContext:function(_21){if(this._datagrid.removeContext){this._datagrid.removeContext(_21);}else{_21&&_21();}},updateSequence:function(_22,_23){var _24=[];if(_22){_24.push("actFetchSourceObject");}_24.push("actUpdateGrid");if(!_22){_24.push("actCompareSet");}_23&&_24.push(_23);this.sequence(_24);},actFetchSourceObject:function(_25){var _26=this;if(this._mendixguid){window.mx.data.get({guid:this._mendixguid,callback:function(obj){_26._sourceObject=obj;_26._datasource.setObject(obj);_26._datagrid.set("readOnly",_26._sourceObject.isReadonlyAttr(_26.sourceReference));_25();},error:function(e){window.mx.onError(e);_25&&_25();}});}else{_25&&_25();}},actUpdateGrid:function(_27){this._oldXPath=this._datagrid.getCurrentXPath();this._datagrid.applyContext(this.mxcontext,_27);},actCompareSet:function(_28){var _29=this._datagrid.getCurrentXPath();if(!this._oldXPath.match("[1=0]")&&this._oldXPath!=_29){this._sourceObject.set(this.sourceReference,"");this.onChange();}else{_28&&_28();}},objectUpdate:function(_2a,_2b){this.updateSequence();_2b&&_2b();},_setDisabledAttr:function(_2c){var _2d=this._datagrid,_2e=_2c===true;_2d.set("disabled",_2c);_2d.set("selectable",!_2e);_2d.set("toolbar",_2e);},_getDisabledAttr:function(){return this._datagrid.get("disabled");},onChange:function(){var ev=this.events&&this.events.change;this.validateForMicroflow(ev,_9.hitch(this,"callMicroflow",ev));},validateForMicroflow:function(_2f,_30){if(_2f&&_2f.validate=="view"){this.mxform.save(_30);}else{_30&&_30();}},onValidation:function(_31){var val=_31[0],_32=this.sourceReference,msg=val.getReasonByAttribute(_32);if(msg){this.addError(msg);val.removeAttribute(_32);}},callMicroflow:function(_33){if(_33){window.mx.ui.execute({microflow:_33},{context:this.mxcontext});}},addError:function(msg){this.removeError();this._hasError=true;if(msg){this._errorNode=_5.create("div",{"class":"alert alert-danger"},msg);this.domNode.parentNode.appendChild(this._errorNode);this.mxform.resize();}if(this._cellNode){_8.add(this._cellNode,"has-error");}if(this.validator){this.validator.addNotification();}},removeError:function(){if(this._errorNode){_5.orphan(this._errorNode);this._errorNode=null;}if(this._cellNode){_8.remove(this._cellNode,"has-error");}if(this.validator&&this._hasError){this.validator.removeNotification();}this._hasError=false;},_openAddForm:function(_34,_35){var _36=this;var _37=this.createContext();_37.dupFrom(this.mxcontext);_37.unsetContext(this.entity);_37.setConstraints(this._gridBacktrack);window.mx.ui.execute(_34,{context:_37,params:{selection:_35?this._sourceObject.getReferences(this.sourceReference):[],selectable:"multi",constraint:this.xpathConstraint},callback:function(_38){_38.listen("save",function(_39){var _3a=_6.find(_38.getChildren(true),function(_3b){return "getSelected" in _3b;}),_3c=_3a.getSelected();if(_35){_36._sourceObject.set(_36.sourceReference,_3c);}else{_36._sourceObject.addReferences(_36.sourceReference,_3c);}_36.onChange();_39();});}});},_getEntity:function(_3d){for(var i in _3d){return i;}}});return _d;});