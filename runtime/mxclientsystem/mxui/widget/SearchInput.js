/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/SearchInput",["mxui/widget/_WidgetBase","mxui/widget/_MasterTooltip","mxui/wm/focus","mxui/dom","big/big","dojo/dom-class","dojo/_base/array","dojo/_base/lang","dojo/_base/json","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var $=_4.create;var _b=_a(_1,{declaredClass:"mxui.widget.SearchInput",path:"",operator:"",caption:"",entity:"",defaults:"",hidden:false,disabled:false,defaultsParser:"",queryBuilder:"",retriever:"",datasource:"",widget:"",mxcontext:null,_MS_IN_DAY:24*60*60*1000,_attribute:"",_metaObject:null,_input:null,_widget:null,_tooltip:null,_datasource:null,_defaultsValue:null,_doDefaultsParser:null,_doQueryBuilder:null,_doRetriever:null,postMixInProperties:function(){var _c=this.path.split("/");if(_c.length>1){this.entity=_c[_c.length-2];}this._attribute=_c[_c.length-1];this._metaObject=window.mx.meta.getEntity(this.entity);this._doRetriever=this.retriever?_8.hitch(this,"_retrieve"+this.retriever+"Options"):null;this._doQueryBuilder=this["_build"+((this.queryBuilder&&this.queryBuilder.name)||"Simple")+"Query"];this._initDataSource();this._initDefaultsValue();},buildRendering:function(){var _d,_e;if(this.widget){_d=_8.getObject(this.widget.type);this._widget=new _d(this.widget.params);_e=this._widget.domNode;this.connect(this._widget,"onKeyUp","onKeyUp");this.connect(this._widget,"onChange","onChange");}else{if(this.retriever||this.datasource){this._input=$("select",{"class":"form-control"});}else{this._input=$("input",{type:"text","class":"form-control"});}_e=this._input;this.connect(this._input,"keyup","onKeyUp");this.connect(this._input,"blur","onChange");}if(this.retriever){this._fillInput(this._doRetriever());}if(!this._datasource){this.reset();}this.domNode=$("div",{"class":"mx-grid-search-item"},$("div",{"class":"mx-grid-search-label"},$("label",this.caption||"")),$("div",{"class":"mx-grid-search-input mx-name-"+this.searchInputName},_e));if(this.get("hidden")){this.domNode.style.display="none";}},startup:function(){this.inherited(arguments);this.reinit();this.set("disabled",this.disabled);},reset:function(){this._hideTooltip();if(this._widget){this._widget.set("value",this._defaultsValue);}else{if(this.retriever){_4.selectOptionByValue(this._input,this._defaultsValue);}else{this._input.value=this._defaultsValue;}}},reinit:function(_f){var _10=this;if(this._datasource){this._datasource.reload(function(){var _11={};_7.forEach(_10._datasource.getObjects(),function(obj){var _12=obj.get2(_10._attribute);_11[_12]=_12;});_10._fillInput(_11);_10.reset();_f&&_f();});}else{_f&&_f();}},focus:function(){if(this._widget){if(this._widget.focus){this._widget.focus();}else{_3.put(this._widget.domNode);}}else{_3.put(this._input);}},onChange:function(){if(!this.get("valid")){this._showTooltip();}else{this._hideTooltip();}},onKeyUp:function(){},cleanup:function(){this._hideTooltip();},uninitialize:function(){if(this._tooltip){this._tooltip.destroyRecursive();}if(this._widget){this._widget.destroy();}},_retrieveBoolOptions:function(){return {"true":window.mx.ui.translate("mxui.widget.DataGrid","true"),"false":window.mx.ui.translate("mxui.widget.DataGrid","false")};},_retrieveEnumOptions:function(){return this._metaObject.getEnumKVPairs(this._attribute);},_defaultSimpleValue:function(_13){return _13||"";},_defaultJsonValue:function(_14){return _9.fromJson(_14||"''");},_defaultDateValue:function(_15){var _16="";if(_15){if(_15==="[%CurrentDateTime%]"){_16=+new Date();}else{if(_15==="[%BeginOfCurrentDay%]"){_16=+new Date().setHours(0,0,0,0);}else{_16=window.mx.parser.localizeEpoch(+_15);}}}return _16;},_buildRangeQuery:function(_17){return [this._xpWithEmptyString(this._xpString(_17.path,_17.operator,_17.value),_17.path),this._xpWithEmptyString(this._xpString(_17.toPath,_17.toOperator,_17.value),_17.toPath)].join(" and ");},_buildSimpleQuery:function(_18){return this._xpString(_18.path,_18.operator,_18.value);},_buildDateQuery:function(_19){var _1a=_19.operator,_1b=0;if(_19.operator=="="){return "("+["("+this._xpString(_19.path,">=",_19.value)+")","("+this._xpString(_19.path,"<",_19.value+this._MS_IN_DAY)+")"].join(" and ")+")";}else{switch(_19.operator){case ">":_1a=">=";_1b=this._MS_IN_DAY;break;case "<=":_1a="<";_1b=this._MS_IN_DAY;break;}return this._xpString(_19.path,_1a,(_19.value+_1b)+"");}},_buildDateRangeQuery:function(_1c){return "("+[this._xpWithEmptyString(this._xpString(_1c.path,_1c.operator,_1c.value+this._MS_IN_DAY),_1c.path),this._xpWithEmptyString(this._xpString(_1c.toPath,_1c.toOperator,_1c.value),_1c.toPath)].join(" and ")+")";},_initDefaultsValue:function(){var _1d=this["_default"+(this.defaultsParser||"Simple")+"Value"];this._defaultsValue=_1d.call(this,this.defaults);},_initDataSource:function(){var _1e={xpath:"mendix.lib.XPathSource"},_1f;if(this.datasource){_1f=_8.getObject(_1e[this.datasource.type]);if(_1f){this._datasource=new _1f(_8.mixin({},{entity:this.entity,attributes:[this._attribute],useContext:false,context:this.mxcontext,page:1000,aggregates:false,distinct:true},this.datasource.params));}}},_showTooltip:function(){var _20,_21;if(!this._tooltip){this._tooltip=new _2();}if(this._metaObject.isDate(this._attribute)){_20="invalid_date";}else{_20="invalid_number";}if(this._widget){_21=this._widget.domNode;}else{_21=this._input;}this._tooltip.show(window.mx.ui.translate("mendix.lib.Validations",_20),_21);},_hideTooltip:function(){var _22;if(this._widget){_22=this._widget.domNode;}else{_22=this._input;}this._tooltip&&this._tooltip.hide(_22);},_fillInput:function(_23){var _24,key;if(this._widget){_24=[];for(key in _23){_24.push({value:key,caption:_23[key]});}this._widget.set("items",_24);}else{_24={};for(key in _23){_24[key]=_23[key] instanceof _5?_23[key].toFixed():_23[key];}_4.setSelectOptions(this._input,_24);}},_stringForOperator:function(key,_25,_26){return key+_25+_26;},_stringForContains:function(key,_27,_28){return _27+"("+key+","+_28+")";},_xpString:function(key,_29,_2a){return (/contains|starts-with/.test(_29))?this._stringForContains(key,_29,_2a):this._stringForOperator(key,_29,_2a);},_xpWithEmptyString:function(_2b,key){return "("+_2b+" or "+key+"=empty)";},_setValueAttr:function(_2c){if(this._widget){this._widget.set("value",_2c);}else{if(this.retriever){_4.selectOptionByValue(this._input,_2c);}else{this._input.value=_2c;}}},_getValueAttr:function(){if(!this.get("valid")){return "";}if(this._widget){return this._widget.get("value");}if(this.retriever||this.datasource){return _4.getSelectedValue(this._input);}return this._input.value;},_getQueryAttr:function(){var _2d=this.get("value"),_2e;if(_8.isArray(_2d)){_2e=_2d;}else{if(_2d===""||_2d===null){_2e=[];}else{_2e=[_2d];}}if(_2e.length===0){return "";}return "("+_7.map(_2e,_8.hitch(this,function(_2f){var _30=this._metaObject;if(_30.isDate(this._attribute)){_2f=+_2f;if(!_30.isLocalizedDate(this._attribute)){_2f=window.mx.parser.delocalizeEpoch(_2f);}}else{if(!(_30.isNumber(this._attribute)||_30.isCurrency(this._attribute))){_2f="'"+_4.escapeHTMLQuotes(_2f)+"'";}}return this._doQueryBuilder(_8.mixin({},this.queryBuilder.params,{path:this.path,operator:this.operator,value:_2f}));})).join(" or ")+")";},_getValidAttr:function(){var _31;if(this._widget){_31=this._widget.get("value");if(_31==null){return false;}}else{_31=this._input.value;}if(this._metaObject.isNumber(this._attribute)||this._metaObject.isCurrency(this._attribute)){if(/integer/i.test(this._metaObject.getAttributeType(this._attribute))&&_31>2147483647){return false;}return (/^[-+]?\d*(\.\d+)?$/).test(_31);}return true;},_getHiddenAttr:function(){return this.hidden;},_setHiddenAttr:function(_32){this.hidden=_32;},_setDisabledAttr:function(_33){var _34;this.disabled=_33;if(this._widget){_34=this._widget.domNode;this._widget.set("disabled",_33);}else{_34=this._input;if(_33){_34.setAttribute("readonly","readonly");_4.disableNode(_34);}else{_34.removeAttribute("readonly","readonly");_4.enableNode(_34);}}if(_33){_6.add(_34,"MxClient_formDisabled");}else{_6.remove(_34,"MxClient_formDisabled");}},_getDisabledAttr:function(){return this.disabled;}});return _b;});