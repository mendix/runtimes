
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/SearchInput",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget.SearchInput");_1.declare("mxui.widget.SearchInput",mxui.widget._WidgetBase,{path:"",operator:"",caption:"",entity:"",defaults:"",hidden:false,disabled:false,defaultsParser:"",queryBuilder:"",retriever:"",datasource:"",widget:"",mxcontext:null,_MS_IN_DAY:24*60*60*1000,_attribute:"",_metaObject:null,_input:null,_widget:null,_tooltip:null,_datasource:null,_defaultsValue:null,_doDefaultsParser:null,_doQueryBuilder:null,_doRetriever:null,postMixInProperties:function(){var _4=this.path.split("/");if(_4.length>1){this.entity=_4[_4.length-2];}this._attribute=_4[_4.length-1];this._metaObject=mx.meta.getEntity(this.entity);this._doRetriever=this.retriever?_1.hitch(this,"_retrieve"+this.retriever+"Options"):null;this._doQueryBuilder=this["_build"+((this.queryBuilder&&this.queryBuilder.name)||"Simple")+"Query"];this._initDataSource();this._initDefaultsValue();},buildRendering:function(){var $=mxui.dom.create,_5,_6,_7;if(this.widget){_5=_1.getObject(this.widget.type);this._widget=new _5(this.widget.params);_6=this._widget.domNode;this.connect(this._widget,"onKeyUp","onKeyUp");this.connect(this._widget,"onChange","onChange");}else{if(this.retriever||this.datasource){this._input=$("select",{"class":"form-control"});}else{this._input=$("input",{type:"text","class":"form-control"});}_6=this._input;this.connect(this._input,"keyup","onKeyUp");this.connect(this._input,"blur","onChange");}if(this.retriever){this._fillInput(this._doRetriever());}if(!this._datasource){this.reset();}this.domNode=mxui.dom.div({"class":"mx-grid-search-item"},$("div",{"class":"mx-grid-search-label"},$("label",this.caption||"")),$("div",{"class":"mx-grid-search-input"},_6));if(this.get("hidden")){this.domNode.style.display="none";}},startup:function(){this.inherited(arguments);this.reinit();this.set("disabled",this.disabled);},reset:function(){this._hideTooltip();if(this._widget){this._widget.set("value",this._defaultsValue);}else{if(this.retriever){mxui.dom.selectOptionByValue(this._input,this._defaultsValue);}else{this._input.value=this._defaultsValue;}}},reinit:function(_8){var _9=this;if(this._datasource){this._datasource.reload(function(){var _a={};_1.forEach(_9._datasource.getObjects(),function(_b){var _c=_b.get(_9._attribute);_a[_c]=_c;});_9._fillInput(_a);_9.reset();_8&&_8();});}else{_8&&_8();}},focus:function(){if(this._widget){if(this._widget.focus){this._widget.focus();}else{mxui.wm.focus.put(this._widget.domNode);}}else{mxui.wm.focus.put(this._input);}},onChange:function(){if(!this.get("valid")){this._showTooltip();}else{this._hideTooltip();}},onKeyUp:function(){},cleanup:function(){this._hideTooltip();},uninitialize:function(){if(this._tooltip){this._tooltip.destroyRecursive();}if(this._widget){this._widget.destroy();}},_retrieveBoolOptions:function(){return {"true":mx.ui.translate("mxui.widget.DataGrid","true"),"false":mx.ui.translate("mxui.widget.DataGrid","false")};},_retrieveEnumOptions:function(){return this._metaObject.getEnumKVPairs(this._attribute);},_defaultSimpleValue:function(_d){return _d||"";},_defaultJsonValue:function(_e){return _1.fromJson(_e||"''");},_defaultDateValue:function(_f){var _10="";if(_f){if(_f==="[%CurrentDateTime%]"){_10=+new Date();}else{if(_f==="[%BeginOfCurrentDay%]"){_10=+new Date().setHours(0,0,0,0);}else{_10=mx.parser.localizeEpoch(+_f);}}}return _10;},_buildRangeQuery:function(_11){return [this._xpWithEmptyString(this._xpString(_11.path,_11.operator,_11.value),_11.path),this._xpWithEmptyString(this._xpString(_11.toPath,_11.toOperator,_11.value),_11.toPath)].join(" and ");},_buildSimpleQuery:function(_12){return this._xpString(_12.path,_12.operator,_12.value);},_buildDateQuery:function(_13){var _14=_13.operator,_15=0;if(_13.operator=="="){return "("+["("+this._xpString(_13.path,">=",_13.value)+")","("+this._xpString(_13.path,"<",_13.value+this._MS_IN_DAY)+")"].join(" and ")+")";}else{switch(_13.operator){case ">":_14=">=";_15=this._MS_IN_DAY;break;case "<=":_14="<";_15=this._MS_IN_DAY;break;}return this._xpString(_13.path,_14,(_13.value+_15)+"");}},_buildDateRangeQuery:function(_16){return "("+[this._xpWithEmptyString(this._xpString(_16.path,_16.operator,_16.value+this._MS_IN_DAY),_16.path),this._xpWithEmptyString(this._xpString(_16.toPath,_16.toOperator,_16.value),_16.toPath)].join(" and ")+")";},_initDefaultsValue:function(){var _17=this["_default"+(this.defaultsParser||"Simple")+"Value"];this._defaultsValue=_17.call(this,this.defaults);},_initDataSource:function(){var _18={xpath:"mendix.lib.XPathSource"},_19;if(this.datasource){_19=_1.getObject(_18[this.datasource.type]);if(_19){this._datasource=new _19(_1.mixin({},{entity:this.entity,attributes:[this._attribute],useContext:false,context:this.mxcontext,page:1000,aggregates:false,distinct:true},this.datasource.params));}}},_showTooltip:function(){var _1a,_1b;if(!this._tooltip){this._tooltip=new mxui.widget._MasterTooltip();}if(this._metaObject.isDate(this._attribute)){_1a="invalid_date";}else{_1a="invalid_number";}if(this._widget){_1b=this._widget.domNode;}else{_1b=this._input;}this._tooltip.show(mx.ui.translate("mendix.lib.Validations",_1a),_1b);},_hideTooltip:function(){var _1c;if(this._widget){_1c=this._widget.domNode;}else{_1c=this._input;}this._tooltip&&this._tooltip.hide(_1c);},_fillInput:function(_1d){var _1e,key;if(this._widget){_1e=[];for(key in _1d){_1e.push({value:key,caption:_1d[key]});}this._widget.set("items",_1e);}else{mxui.dom.setSelectOptions(this._input,_1d);}},_stringForOperator:function(key,_1f,_20){return key+_1f+_20;},_stringForContains:function(key,_21,_22){return _21+"("+key+","+_22+")";},_xpString:function(key,_23,_24){return (/contains|starts-with/.test(_23))?this._stringForContains(key,_23,_24):this._stringForOperator(key,_23,_24);},_xpWithEmptyString:function(_25,key){return "("+_25+" or "+key+"=empty)";},_getValueAttr:function(){var _26,_27;if(!this.get("valid")){return "";}if(this._widget){_26=this._widget.get("value");}else{if(this.retriever||this.datasource){_26=mxui.dom.getSelectedValue(this._input);}else{_26=this._input.value;}}if(_1.isArray(_26)){_27=_26;}else{if(_26===""){_27=[];}else{_27=[_26];}}if(_27.length===0){return "";}return "("+_1.map(_27,_1.hitch(this,function(_28){var _29=this._metaObject;if(_29.isDate(this._attribute)){_28=+_28;if(!_29.isLocalizedDate(this._attribute)){_28=mx.parser.delocalizeEpoch(_28);}}else{if(!(_29.isNumber(this._attribute)||_29.isCurrency(this._attribute))){_28="'"+mxui.dom.escapeHTMLQuotes(_28)+"'";}}return this._doQueryBuilder(_1.mixin({},this.queryBuilder.params,{path:this.path,operator:this.operator,value:_28}));})).join(" or ")+")";},_getValidAttr:function(){var _2a;if(this._widget){_2a=this._widget.get("value");if(_2a==null){return false;}}else{_2a=this._input.value;}if(this._metaObject.isNumber(this._attribute)||this._metaObject.isCurrency(this._attribute)){return (/^\d*(\.\d+)?$/).test(_2a);}if(/integer/i.test(this._metaObject.getAttributeType(this._attribute))&&_2a>2147483647){return false;}return true;},_getAttrHidden:function(){return this.hidden;},_setAttrHidden:function(_2b){this.hidden=_2b;},_setDisabledAttr:function(_2c){var _2d;this.disabled=_2c;if(this._widget){_2d=this._widget.domNode;this._widget.set("disabled",_2c);}else{_2d=this._input;if(_2c){_2d.setAttribute("readonly","readonly");mxui.dom.disableNode(_2d);}else{_2d.removeAttribute("readonly","readonly");mxui.dom.enableNode(_2d);}}if(_2c){_1.addClass(_2d,"MxClient_formDisabled");}else{_1.removeClass(_2d,"MxClient_formDisabled");}},_getDisabledAttr:function(){return this.disabled;}});});