/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/SearchInput",["mxui/widget/_WidgetBase","mxui/wm/focus","mxui/dom","mxui/lib/errorMessage","big/big","dojo/dom-class","dojo/_base/array","dojo/_base/lang","dojo/_base/json","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var $=_3.create;var _b=_a(_1,{declaredClass:"mxui.widget.SearchInput",path:"",operator:"",caption:"",entity:"",defaults:"",hidden:false,disabled:false,defaultsParser:"",queryBuilder:"",retriever:"",datasource:"",widget:"",mxcontext:null,_MS_IN_DAY:24*60*60*1000,_attribute:"",_metaObject:null,_input:null,_widget:null,_datasource:null,_defaultsValue:null,_doDefaultsParser:null,_doQueryBuilder:null,_doRetriever:null,_isLoaded:false,postMixInProperties:function(){var _c=this.path.split("/");if(_c.length>1){this.entity=_c[_c.length-2];}this._attribute=_c[_c.length-1];this._metaObject=window.mx.meta.getEntity(this.entity);this._doRetriever=this.retriever?_8.hitch(this,"_retrieve"+this.retriever+"Options"):null;this._doQueryBuilder=this["_build"+((this.queryBuilder&&this.queryBuilder.name)||"Simple")+"Query"];this._initDataSource();this._initDefaultsValue();},buildRendering:function(){var _d,_e;if(this.widget){_d=_8.getObject(this.widget.type);this._widget=new _d(this.widget.params);_e=this._widget.domNode;this.connect(this._widget,"onKeyUp","onKeyUp");this.connect(this._widget,"onChange","onChange");}else{if(this.retriever||this.datasource){this._input=$("select",{"class":"form-control"});}else{this._input=$("input",{type:"text","class":"form-control"});}_e=this._input;this.connect(this._input,"keyup","onKeyUp");this.connect(this._input,"blur","onChange");}if(this.retriever){this._fillInput(this._doRetriever(),"");}this.domNode=$("div",{"class":"mx-grid-search-item"},$("div",{"class":"mx-grid-search-label"},$("label",this.caption||"")),$("div",{"class":"mx-grid-search-input mx-name-"+this.searchInputName},_e));if(this.get("hidden")){this.domNode.style.display="none";}},startup:function(){this.inherited(arguments);this.set("disabled",this.disabled);},reset:function(){this._hideValidationMessage();this.set("value",this._defaultsValue);},reinit:function(_f){var _10=this._isLoaded?this.get("value"):this._defaultsValue;if(this._datasource){var _11=this;this._datasource.reload(function(){var _12={};_7.forEach(_11._datasource.getObjects(),function(obj){var _13=obj.get2(_11._attribute);_12[_13]=window.mx.parser.formatAttribute(obj,_11._attribute);});_11._fillInput(_12,_10);_11._isLoaded=true;if(_f){_f();}});}else{this.set("value",_10);this._isLoaded=true;if(_f){_f();}}},focus:function(){if(this._widget){if(this._widget.focus){this._widget.focus();}else{_2.put(this._widget.domNode);}}else{_2.put(this._input);}},onChange:function(){if(this._isValid(this.get("value"))){this._hideValidationMessage();}else{this._showValidationMessage();}},onKeyUp:function(){},cleanup:function(){this._hideValidationMessage();},uninitialize:function(){if(this._widget){this._widget.destroy();}},_retrieveBoolOptions:function(){return {"true":window.mx.ui.translate("mxui.widget.DataGrid","true"),"false":window.mx.ui.translate("mxui.widget.DataGrid","false")};},_retrieveEnumOptions:function(){return this._metaObject.getEnumKVPairs(this._attribute);},_defaultSimpleValue:function(_14){return _14||"";},_defaultJsonValue:function(_15){return _9.fromJson(_15||"''");},_defaultDateValue:function(_16){var _17="";if(_16){if(_16==="[%CurrentDateTime%]"){_17=+new Date();}else{if(_16==="[%BeginOfCurrentDay%]"){_17=+new Date().setHours(0,0,0,0);}else{_17=window.mx.parser.localizeEpoch(+_16);}}}return _17;},_buildRangeQuery:function(_18){return [this._xpWithEmptyString(this._xpString(_18.path,_18.operator,_18.value),_18.path),this._xpWithEmptyString(this._xpString(_18.toPath,_18.toOperator,_18.value),_18.toPath)].join(" and ");},_buildSimpleQuery:function(_19){return this._xpString(_19.path,_19.operator,_19.value);},_buildDateQuery:function(_1a){var _1b=_1a.operator,_1c=0;if(_1a.operator=="="){return "("+["("+this._xpString(_1a.path,">=",_1a.value)+")","("+this._xpString(_1a.path,"<",_1a.value+this._MS_IN_DAY)+")"].join(" and ")+")";}else{switch(_1a.operator){case ">":_1b=">=";_1c=this._MS_IN_DAY;break;case "<=":_1b="<";_1c=this._MS_IN_DAY;break;}return this._xpString(_1a.path,_1b,(_1a.value+_1c)+"");}},_buildDateRangeQuery:function(_1d){return "("+[this._xpWithEmptyString(this._xpString(_1d.path,_1d.operator,_1d.value+this._MS_IN_DAY),_1d.path),this._xpWithEmptyString(this._xpString(_1d.toPath,_1d.toOperator,_1d.value),_1d.toPath)].join(" and ")+")";},_initDefaultsValue:function(){var _1e=this["_default"+(this.defaultsParser||"Simple")+"Value"];this._defaultsValue=_1e.call(this,this.defaults);},_initDataSource:function(){var _1f={xpath:"webcore.datasource.XPathSource"},_20;if(this.datasource){_20=_8.getObject(_1f[this.datasource.type]);if(_20){this._datasource=new _20(_8.mixin({},{entity:this.entity,attributes:[this._attribute],useContext:false,context:this.mxcontext,page:1000,aggregates:false,distinct:true},this.datasource.params));}}},_showValidationMessage:function(){var _21=this._metaObject.isDate(this._attribute)?"invalid_date":"invalid_number";_4.show(this.domNode,window.mx.ui.translate("mendix.lib.Validations",_21));},_hideValidationMessage:function(){_4.hide(this.domNode);},_fillInput:function(_22,_23){var _24,key;if(this._widget){_24=[];for(key in _22){_24.push({value:key,caption:_22[key]});}this._widget.set("items",_24);this._widget.set("value",_23);}else{_24={};for(key in _22){_24[key]=_22[key] instanceof _5?_22[key].toFixed():_22[key];}_3.setSelectOptions(this._input,_24,_23);}},_stringForOperator:function(key,_25,_26){return key+_25+_26;},_stringForContains:function(key,_27,_28){return _27+"("+key+","+_28+")";},_xpString:function(key,_29,_2a){return (/contains|starts-with/.test(_29))?this._stringForContains(key,_29,_2a):this._stringForOperator(key,_29,_2a);},_xpWithEmptyString:function(_2b,key){return "("+_2b+" or "+key+"=empty)";},_isValid:function(_2c){if(_2c==null){return false;}if(this._metaObject.isNumeric(this._attribute)||this._metaObject.getAttributeType(this._attribute).toLowerCase()==="autonumber"){if(this._metaObject.getAttributeType(this._attribute).toLowerCase()==="integer"&&_2c>2147483647){return false;}return (/^[-+]?\d*(\.\d+)?$/).test(_2c);}return true;},_setValueAttr:function(_2d){if(this._widget){this._widget.set("value",_2d);}else{this._input.value=_2d;}},_getValueAttr:function(){var _2e;if(this._widget){_2e=this._widget.get("value");}else{_2e=this._input.value;}return this._isValid(_2e)?_2e:"";},_getQueryAttr:function(){var _2f=this.get("value"),_30;if(_8.isArray(_2f)){_30=_2f;}else{if(_2f===""||_2f===null){_30=[];}else{_30=[_2f];}}if(_30.length===0){return "";}return "("+_7.map(_30,_8.hitch(this,function(_31){var _32=this._metaObject;if(_32.isDate(this._attribute)){_31=+_31;if(!_32.isLocalizedDate(this._attribute)){_31=window.mx.parser.delocalizeEpoch(_31);}}else{if(!(_32.isNumeric(this._attribute)||_32.getAttributeType(this._attribute).toLowerCase()==="autonumber")){_31="'"+_3.escapeHTMLQuotes(_31)+"'";}}return this._doQueryBuilder(_8.mixin({},this.queryBuilder.params,{path:this.path,operator:this.operator,value:_31}));})).join(" or ")+")";},_getHiddenAttr:function(){return this.hidden;},_setHiddenAttr:function(_33){this.hidden=_33;},_setDisabledAttr:function(_34){var _35;this.disabled=_34;if(this._widget){_35=this._widget.domNode;this._widget.set("disabled",_34);}else{_35=this._input;if(_34){_35.setAttribute("readonly","readonly");_3.disableNode(_35);}else{_35.removeAttribute("readonly","readonly");_3.enableNode(_35);}}if(_34){_6.add(_35,"MxClient_formDisabled");}else{_6.remove(_35,"MxClient_formDisabled");}},_getDisabledAttr:function(){return this.disabled;}});return _b;});