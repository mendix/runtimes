
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/SearchInput",["mxui/widget/_WidgetBase","mxui/widget/_MasterTooltip","mxui/wm/focus","mxui/dom","dojo/dom-class","dojo/_base/array","dojo/_base/lang","dojo/_base/json","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var $=_4.create;var _a=_9(_1,{declaredClass:"mxui.widget.SearchInput",path:"",operator:"",caption:"",entity:"",defaults:"",hidden:false,disabled:false,defaultsParser:"",queryBuilder:"",retriever:"",datasource:"",widget:"",mxcontext:null,_MS_IN_DAY:24*60*60*1000,_attribute:"",_metaObject:null,_input:null,_widget:null,_tooltip:null,_datasource:null,_defaultsValue:null,_doDefaultsParser:null,_doQueryBuilder:null,_doRetriever:null,postMixInProperties:function(){var _b=this.path.split("/");if(_b.length>1){this.entity=_b[_b.length-2];}this._attribute=_b[_b.length-1];this._metaObject=window.mx.meta.getEntity(this.entity);this._doRetriever=this.retriever?_7.hitch(this,"_retrieve"+this.retriever+"Options"):null;this._doQueryBuilder=this["_build"+((this.queryBuilder&&this.queryBuilder.name)||"Simple")+"Query"];this._initDataSource();this._initDefaultsValue();},buildRendering:function(){var _c,_d;if(this.widget){_c=_7.getObject(this.widget.type);this._widget=new _c(this.widget.params);_d=this._widget.domNode;this.connect(this._widget,"onKeyUp","onKeyUp");this.connect(this._widget,"onChange","onChange");}else{if(this.retriever||this.datasource){this._input=$("select",{"class":"form-control"});}else{this._input=$("input",{type:"text","class":"form-control"});}_d=this._input;this.connect(this._input,"keyup","onKeyUp");this.connect(this._input,"blur","onChange");}if(this.retriever){this._fillInput(this._doRetriever());}if(!this._datasource){this.reset();}this.domNode=$("div",{"class":"mx-grid-search-item"},$("div",{"class":"mx-grid-search-label"},$("label",this.caption||"")),$("div",{"class":"mx-grid-search-input"},_d));_5.add(_d,"mx-name-"+this.searchInputName);if(this.get("hidden")){this.domNode.style.display="none";}},startup:function(){this.inherited(arguments);this.reinit();this.set("disabled",this.disabled);},reset:function(){this._hideTooltip();if(this._widget){this._widget.set("value",this._defaultsValue);}else{if(this.retriever){_4.selectOptionByValue(this._input,this._defaultsValue);}else{this._input.value=this._defaultsValue;}}},reinit:function(_e){var _f=this;if(this._datasource){this._datasource.reload(function(){var _10={};_6.forEach(_f._datasource.getObjects(),function(obj){var _11=obj.get(_f._attribute);_10[_11]=_11;});_f._fillInput(_10);_f.reset();_e&&_e();});}else{_e&&_e();}},focus:function(){if(this._widget){if(this._widget.focus){this._widget.focus();}else{_3.put(this._widget.domNode);}}else{_3.put(this._input);}},onChange:function(){if(!this.get("valid")){this._showTooltip();}else{this._hideTooltip();}},onKeyUp:function(){},cleanup:function(){this._hideTooltip();},uninitialize:function(){if(this._tooltip){this._tooltip.destroyRecursive();}if(this._widget){this._widget.destroy();}},_retrieveBoolOptions:function(){return {"true":window.mx.ui.translate("mxui.widget.DataGrid","true"),"false":window.mx.ui.translate("mxui.widget.DataGrid","false")};},_retrieveEnumOptions:function(){return this._metaObject.getEnumKVPairs(this._attribute);},_defaultSimpleValue:function(_12){return _12||"";},_defaultJsonValue:function(_13){return _8.fromJson(_13||"''");},_defaultDateValue:function(_14){var _15="";if(_14){if(_14==="[%CurrentDateTime%]"){_15=+new Date();}else{if(_14==="[%BeginOfCurrentDay%]"){_15=+new Date().setHours(0,0,0,0);}else{_15=window.mx.parser.localizeEpoch(+_14);}}}return _15;},_buildRangeQuery:function(_16){return [this._xpWithEmptyString(this._xpString(_16.path,_16.operator,_16.value),_16.path),this._xpWithEmptyString(this._xpString(_16.toPath,_16.toOperator,_16.value),_16.toPath)].join(" and ");},_buildSimpleQuery:function(_17){return this._xpString(_17.path,_17.operator,_17.value);},_buildDateQuery:function(_18){var _19=_18.operator,_1a=0;if(_18.operator=="="){return "("+["("+this._xpString(_18.path,">=",_18.value)+")","("+this._xpString(_18.path,"<",_18.value+this._MS_IN_DAY)+")"].join(" and ")+")";}else{switch(_18.operator){case ">":_19=">=";_1a=this._MS_IN_DAY;break;case "<=":_19="<";_1a=this._MS_IN_DAY;break;}return this._xpString(_18.path,_19,(_18.value+_1a)+"");}},_buildDateRangeQuery:function(_1b){return "("+[this._xpWithEmptyString(this._xpString(_1b.path,_1b.operator,_1b.value+this._MS_IN_DAY),_1b.path),this._xpWithEmptyString(this._xpString(_1b.toPath,_1b.toOperator,_1b.value),_1b.toPath)].join(" and ")+")";},_initDefaultsValue:function(){var _1c=this["_default"+(this.defaultsParser||"Simple")+"Value"];this._defaultsValue=_1c.call(this,this.defaults);},_initDataSource:function(){var _1d={xpath:"mendix.lib.XPathSource"},_1e;if(this.datasource){_1e=_7.getObject(_1d[this.datasource.type]);if(_1e){this._datasource=new _1e(_7.mixin({},{entity:this.entity,attributes:[this._attribute],useContext:false,context:this.mxcontext,page:1000,aggregates:false,distinct:true},this.datasource.params));}}},_showTooltip:function(){var _1f,_20;if(!this._tooltip){this._tooltip=new _2();}if(this._metaObject.isDate(this._attribute)){_1f="invalid_date";}else{_1f="invalid_number";}if(this._widget){_20=this._widget.domNode;}else{_20=this._input;}this._tooltip.show(window.mx.ui.translate("mendix.lib.Validations",_1f),_20);},_hideTooltip:function(){var _21;if(this._widget){_21=this._widget.domNode;}else{_21=this._input;}this._tooltip&&this._tooltip.hide(_21);},_fillInput:function(_22){var _23,key;if(this._widget){_23=[];for(key in _22){_23.push({value:key,caption:_22[key]});}this._widget.set("items",_23);}else{_4.setSelectOptions(this._input,_22);}},_stringForOperator:function(key,_24,_25){return key+_24+_25;},_stringForContains:function(key,_26,_27){return _26+"("+key+","+_27+")";},_xpString:function(key,_28,_29){return (/contains|starts-with/.test(_28))?this._stringForContains(key,_28,_29):this._stringForOperator(key,_28,_29);},_xpWithEmptyString:function(_2a,key){return "("+_2a+" or "+key+"=empty)";},_getValueAttr:function(){var _2b,_2c;if(!this.get("valid")){return "";}if(this._widget){_2b=this._widget.get("value");}else{if(this.retriever||this.datasource){_2b=_4.getSelectedValue(this._input);}else{_2b=this._input.value;}}if(_7.isArray(_2b)){_2c=_2b;}else{if(_2b===""||_2b===null){_2c=[];}else{_2c=[_2b];}}if(_2c.length===0){return "";}return "("+_6.map(_2c,_7.hitch(this,function(_2d){var _2e=this._metaObject;if(_2e.isDate(this._attribute)){_2d=+_2d;if(!_2e.isLocalizedDate(this._attribute)){_2d=window.mx.parser.delocalizeEpoch(_2d);}}else{if(!(_2e.isNumber(this._attribute)||_2e.isCurrency(this._attribute))){_2d="'"+_4.escapeHTMLQuotes(_2d)+"'";}}return this._doQueryBuilder(_7.mixin({},this.queryBuilder.params,{path:this.path,operator:this.operator,value:_2d}));})).join(" or ")+")";},_getValidAttr:function(){var _2f;if(this._widget){_2f=this._widget.get("value");if(_2f==null){return false;}}else{_2f=this._input.value;}if(this._metaObject.isNumber(this._attribute)||this._metaObject.isCurrency(this._attribute)){if(/integer/i.test(this._metaObject.getAttributeType(this._attribute))&&_2f>2147483647){return false;}return (/^[-+]?\d*(\.\d+)?$/).test(_2f);}return true;},_getHiddenAttr:function(){return this.hidden;},_setHiddenAttr:function(_30){this.hidden=_30;},_setDisabledAttr:function(_31){var _32;this.disabled=_31;if(this._widget){_32=this._widget.domNode;this._widget.set("disabled",_31);}else{_32=this._input;if(_31){_32.setAttribute("readonly","readonly");_4.disableNode(_32);}else{_32.removeAttribute("readonly","readonly");_4.enableNode(_32);}}if(_31){_5.add(_32,"MxClient_formDisabled");}else{_5.remove(_32,"MxClient_formDisabled");}},_getDisabledAttr:function(){return this.disabled;}});return _a;});