/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/SearchInput",["mxui/widget/_WidgetBase","mxui/wm/focus","mxui/dom","mxui/lib/errorMessage","big/big","dojo/dom-class","dojo/_base/array","dojo/_base/lang","dojo/_base/json","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var $=_3.create;var _b=_a(_1,{declaredClass:"mxui.widget.SearchInput",path:"",operator:"",caption:"",entity:"",defaults:"",hidden:false,disabled:false,defaultsParser:"",queryBuilder:"",retriever:"",datasource:"",widget:"",mxcontext:null,_MS_IN_DAY:24*60*60*1000,_attribute:"",_metaObject:null,_input:null,_widget:null,_datasource:null,_defaultsValue:null,_doDefaultsParser:null,_doQueryBuilder:null,_doRetriever:null,postMixInProperties:function(){var _c=this.path.split("/");if(_c.length>1){this.entity=_c[_c.length-2];}this._attribute=_c[_c.length-1];this._metaObject=window.mx.meta.getEntity(this.entity);this._doRetriever=this.retriever?_8.hitch(this,"_retrieve"+this.retriever+"Options"):null;this._doQueryBuilder=this["_build"+((this.queryBuilder&&this.queryBuilder.name)||"Simple")+"Query"];this._initDataSource();this._initDefaultsValue();},buildRendering:function(){var _d,_e;if(this.widget){_d=_8.getObject(this.widget.type);this._widget=new _d(this.widget.params);_e=this._widget.domNode;this.connect(this._widget,"onKeyUp","onKeyUp");this.connect(this._widget,"onChange","onChange");}else{if(this.retriever||this.datasource){this._input=$("select",{"class":"form-control"});}else{this._input=$("input",{type:"text","class":"form-control"});}_e=this._input;this.connect(this._input,"keyup","onKeyUp");this.connect(this._input,"blur","onChange");}if(this.retriever){this._fillInput(this._doRetriever());}this.domNode=$("div",{"class":"mx-grid-search-item"},$("div",{"class":"mx-grid-search-label"},$("label",this.caption||"")),$("div",{"class":"mx-grid-search-input mx-name-"+this.searchInputName},_e));if(!this._datasource){this.reset();}if(this.get("hidden")){this.domNode.style.display="none";}},startup:function(){this.inherited(arguments);this.reinit();this.set("disabled",this.disabled);},reset:function(){this._hideValidationMessage();if(this._widget){this._widget.set("value",this._defaultsValue);}else{if(this.retriever){_3.selectOptionByValue(this._input,this._defaultsValue);}else{this._input.value=this._defaultsValue;}}},reinit:function(_f){var _10=this;if(this._datasource){this._datasource.reload(function(){var _11={};_7.forEach(_10._datasource.getObjects(),function(obj){var _12=obj.get2(_10._attribute);_11[_12]=window.mx.parser.formatAttribute(obj,_10._attribute);});_10._fillInput(_11);_10.reset();_f&&_f();});}else{_f&&_f();}},focus:function(){if(this._widget){if(this._widget.focus){this._widget.focus();}else{_2.put(this._widget.domNode);}}else{_2.put(this._input);}},onChange:function(){if(!this.get("valid")){this._showValidationMessage();}else{this._hideValidationMessage();}},onKeyUp:function(){},cleanup:function(){this._hideValidationMessage();},uninitialize:function(){if(this._widget){this._widget.destroy();}},_retrieveBoolOptions:function(){return {"true":window.mx.ui.translate("mxui.widget.DataGrid","true"),"false":window.mx.ui.translate("mxui.widget.DataGrid","false")};},_retrieveEnumOptions:function(){return this._metaObject.getEnumKVPairs(this._attribute);},_defaultSimpleValue:function(_13){return _13||"";},_defaultJsonValue:function(_14){return _9.fromJson(_14||"''");},_defaultDateValue:function(_15){var _16="";if(_15){if(_15==="[%CurrentDateTime%]"){_16=+new Date();}else{if(_15==="[%BeginOfCurrentDay%]"){_16=+new Date().setHours(0,0,0,0);}else{_16=window.mx.parser.localizeEpoch(+_15);}}}return _16;},_buildRangeQuery:function(_17){return [this._xpWithEmptyString(this._xpString(_17.path,_17.operator,_17.value),_17.path),this._xpWithEmptyString(this._xpString(_17.toPath,_17.toOperator,_17.value),_17.toPath)].join(" and ");},_buildSimpleQuery:function(_18){return this._xpString(_18.path,_18.operator,_18.value);},_buildDateQuery:function(_19){var _1a=_19.operator,_1b=0;if(_19.operator=="="){return "("+["("+this._xpString(_19.path,">=",_19.value)+")","("+this._xpString(_19.path,"<",_19.value+this._MS_IN_DAY)+")"].join(" and ")+")";}else{switch(_19.operator){case ">":_1a=">=";_1b=this._MS_IN_DAY;break;case "<=":_1a="<";_1b=this._MS_IN_DAY;break;}return this._xpString(_19.path,_1a,(_19.value+_1b)+"");}},_buildDateRangeQuery:function(_1c){return "("+[this._xpWithEmptyString(this._xpString(_1c.path,_1c.operator,_1c.value+this._MS_IN_DAY),_1c.path),this._xpWithEmptyString(this._xpString(_1c.toPath,_1c.toOperator,_1c.value),_1c.toPath)].join(" and ")+")";},_initDefaultsValue:function(){var _1d=this["_default"+(this.defaultsParser||"Simple")+"Value"];this._defaultsValue=_1d.call(this,this.defaults);},_initDataSource:function(){var _1e={xpath:"webcore.datasource.XPathSource"},_1f;if(this.datasource){_1f=_8.getObject(_1e[this.datasource.type]);if(_1f){this._datasource=new _1f(_8.mixin({},{entity:this.entity,attributes:[this._attribute],useContext:false,context:this.mxcontext,page:1000,aggregates:false,distinct:true},this.datasource.params));}}},_showValidationMessage:function(){var _20=this._metaObject.isDate(this._attribute)?"invalid_date":"invalid_number";_4.show(this.domNode,window.mx.ui.translate("mendix.lib.Validations",_20));},_hideValidationMessage:function(){_4.hide(this.domNode);},_fillInput:function(_21){var _22,key;if(this._widget){_22=[];for(key in _21){_22.push({value:key,caption:_21[key]});}this._widget.set("items",_22);}else{_22={};for(key in _21){_22[key]=_21[key] instanceof _5?_21[key].toFixed():_21[key];}_3.setSelectOptions(this._input,_22);}},_stringForOperator:function(key,_23,_24){return key+_23+_24;},_stringForContains:function(key,_25,_26){return _25+"("+key+","+_26+")";},_xpString:function(key,_27,_28){return (/contains|starts-with/.test(_27))?this._stringForContains(key,_27,_28):this._stringForOperator(key,_27,_28);},_xpWithEmptyString:function(_29,key){return "("+_29+" or "+key+"=empty)";},_setValueAttr:function(_2a){if(this._widget){this._widget.set("value",_2a);}else{if(this.retriever){_3.selectOptionByValue(this._input,_2a);}else{this._input.value=_2a;}}},_getValueAttr:function(){if(!this.get("valid")){return "";}if(this._widget){return this._widget.get("value");}if(this.retriever||this.datasource){return _3.getSelectedValue(this._input);}return this._input.value;},_getQueryAttr:function(){var _2b=this.get("value"),_2c;if(_8.isArray(_2b)){_2c=_2b;}else{if(_2b===""||_2b===null){_2c=[];}else{_2c=[_2b];}}if(_2c.length===0){return "";}return "("+_7.map(_2c,_8.hitch(this,function(_2d){var _2e=this._metaObject;if(_2e.isDate(this._attribute)){_2d=+_2d;if(!_2e.isLocalizedDate(this._attribute)){_2d=window.mx.parser.delocalizeEpoch(_2d);}}else{if(!(_2e.isNumeric(this._attribute)||_2e.getAttributeType(this._attribute).toLowerCase()==="autonumber")){_2d="'"+_3.escapeHTMLQuotes(_2d)+"'";}}return this._doQueryBuilder(_8.mixin({},this.queryBuilder.params,{path:this.path,operator:this.operator,value:_2d}));})).join(" or ")+")";},_getValidAttr:function(){var _2f;if(this._widget){_2f=this._widget.get("value");if(_2f==null){return false;}}else{_2f=this._input.value;}if(this._metaObject.isNumeric(this._attribute)||this._metaObject.getAttributeType(this._attribute).toLowerCase()==="autonumber"){if(this._metaObject.getAttributeType(this._attribute).toLowerCase()==="integer"&&_2f>2147483647){return false;}return (/^[-+]?\d*(\.\d+)?$/).test(_2f);}return true;},_getHiddenAttr:function(){return this.hidden;},_setHiddenAttr:function(_30){this.hidden=_30;},_setDisabledAttr:function(_31){var _32;this.disabled=_31;if(this._widget){_32=this._widget.domNode;this._widget.set("disabled",_31);}else{_32=this._input;if(_31){_32.setAttribute("readonly","readonly");_3.disableNode(_32);}else{_32.removeAttribute("readonly","readonly");_3.enableNode(_32);}}if(_31){_6.add(_32,"MxClient_formDisabled");}else{_6.remove(_32,"MxClient_formDisabled");}},_getDisabledAttr:function(){return this.disabled;}});return _b;});