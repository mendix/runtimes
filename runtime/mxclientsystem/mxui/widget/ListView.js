
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/ListView",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget.ListView");_1.declare("mxui.widget.ListView",mxui.widget._WidgetBase,{constraint:"",datasource:null,page:5,search:null,action:null,sort:null,selection:null,selectable:"",_entity:"",_doUpdate:false,_itemList:null,_selected:null,_loadButton:null,_clearButton:null,_searchNode:null,_listNode:null,_emptyNode:null,_loadNode:null,_datasource:null,_searchTimeout:null,buildRendering:function(){var $=mxui.dom.create;this._loadButton=new mxui.widget.Button({caption:this.translate("load_more"),iconClass:"glyphicon glyphicon-repeat",onClick:_1.hitch(this,"loadMore")});this.domNode=$("div",{"class":"mx-listview"},this._listNode=$("ul",{"class":"mx-list mx-list-striped mx-listview-list"}),this._loadButton.domNode);this._emptyNode=$("li",{"class":"mx-listview-empty"},$("label",this.translate("no_items")));this._loadNode=$("li",{"class":"mx-listview-loading"},$("img",{src:require.toUrl("mxui/ui/widget/images/loading.gif")}));if(this.search){this._clearButton=new mxui.widget.Button({iconClass:"glyphicon glyphicon-refresh",onClick:_1.hitch(this,"clearSearchNode"),"class":"mx-listview-clear-button"});_1.place($("div",{"class":"mx-listview-searchbar clearfix"},this._clearButton.domNode,$("div",{"class":"mx-listview-search-input"},this._searchNode=$("input",{type:"text",placeholder:this.translate("search"),"class":"form-control"}))),this.domNode,"first");this.connect(this._searchNode,"keyup","searchKeyDown");}},postCreate:function(){if(this.constraint){this.datasource.constraint=this.constraint;}this.createSource();this._itemList=[];if(this.selectable){var _4=this.selection,_5=this._selected={};for(var i=0,_6;_6=_4[i];i++){_5[_6]=1;}this.mxform.setReturnValue("selection",_4);}},resume:function(){if(this._doUpdate){this.update();this._doUpdate=false;}},update:function(_7,_8){if(this.get("suspended")){this._doUpdate=true;_8&&_8();}else{mxui.dom.orphan(this._emptyNode);this.loadData(_8);}},createSource:function(){var _9=this.datasource,_a;switch(_9.type){case "xpath":_a=_9.path.split("/");this._entity=_a.pop();_a.shift();this._datasource=new mendix.lib.SimpleXPathSource({context:this.mxcontext,page:this.page,sortparams:this.sort,entity:this._entity,path:_a,constraint:_9.constraint});break;case "entityPath":_a=_9.path.split("/");this._entity=_a.pop();this._datasource=new mendix.lib.EntityPathSource({context:this.mxcontext,page:this.page,path:_9.path});break;case "microflow":this._entity=_9.entity;this._datasource=new mendix.lib.MicroflowSource({context:this.mxcontext,page:this.page,microflow:_9.microflow});break;default:throw new Error(this.id+".createSource : could not create datasource");}this.subscribe({entity:this._entity,callback:function(){this.update();}});},loadData:function(_b){this._datasource.first();this.sequence(["sourceReload","renderData","addLoadButton"],_b);},loadMore:function(){mxui.dom.orphan(this._loadButton.domNode);this._listNode.appendChild(this._loadNode);this.sequence(["sourceNext","renderData","addLoadButton"]);},clearData:function(_c){_c=_c||0;var _d=this._itemList;for(var i=_c,_e;_e=_d[i];i++){_e.set("suspended",true);mxui.dom.orphan(_e.domNode);}},sourceReload:function(_f){this._datasource.reload(_f);},sourceNext:function(_10){this._datasource.next(_10);},renderData:function(_11){var _12=this._datasource,_13=_12.getOffset(),_14=_12.getObjects(),_15=_12.getSetSize(),_16=[],_17=this._listNode,_18=this._itemList,_19=this._selected,_1a=this._loadNode;mxui.dom.orphan(_1a);if(_15===0){this.clearData();_17.appendChild(this._emptyNode);}else{this.clearData(_13+_14.length);for(var i=0,obj;obj=_14[i];i++,_13++){var _1b=_18[_13];if(!_1b){_1b=_18[_13]=new mxui.widget.ListViewItem({listview:this,mxform:this.mxform,template:this.getTemplate("content"),action:this.action,selectable:this.selectable});_17.appendChild(_1b.domNode);_1b.startup();}else{_1b.set("suspended",false);_17.appendChild(_1b.domNode);}if(_19){var _1c=obj.getGuid() in _19;_1b[_1c?"select":"deselect"]();if(_1c&&this.selectable=="single"){this._selectedItem=_1b;}}var _1d=new mendix.lib.MxContext({mxcontext:this.mxcontext});_1d.setObject(obj);_16.push(_1.partial(function(_1e,_1f,cb){_1e.applyContext(_1f,function(){_1e.set("suspended",false);cb();});},_1b,_1d));}}this.collect(_16,_11);},addLoadButton:function(_20){if(!this._datasource.atEnd()){this.domNode.appendChild(this._loadButton.domNode);}else{mxui.dom.orphan(this._loadButton.domNode);}mendix.lang.nullExec(_20);},searchKeyDown:function(){var _21=this,_22=this._datasource;this._clearButton.set("iconClass","glyphicon "+(this._searchNode.value?"glyphicon-remove":"glyphicon-refresh"));clearTimeout(this._searchTimeout);this._searchTimeout=setTimeout(function(){_22.setConstraints(_21._getSearchConstraint());_21.update();},500);},_getSearchConstraint:function(){if(this.search){var _23=this._searchNode.value,_24=[],_25=this.search.attributes,_26=this.search.method;if(_23){for(var i=0,_27;_27=_25[i];++i){_24.push(_26+"("+_27+",'"+_23+"')");}return "["+_24.join(" or ")+"]";}}return "";},clearSearchNode:function(){clearTimeout(this._searchTimeout);this._clearButton.set("iconClass","glyphicon glyphicon-refresh");this._searchNode.value="";this._datasource.setConstraints("");this.update();},saveSelection:function(){this.mxform.setReturnValue("selection",mendix.lang.objectToArray(this._selected));},selectItem:function(_28){var _29=_28.getGuid();_28.select();if(this.selectable=="single"){var _2a=this._selectedItem;_2a&&_2a.deselect();this._selectedItem=_28;this.mxform.setReturnValue("selection",[_29]);}else{this._selected[_29]=1;this.saveSelection();}},deselectItem:function(_2b){var _2c=_2b.getGuid();_2b.deselect();if(this.selectable=="single"){this.mxform.setReturnValue("selection",[]);}else{delete this._selected[_2c];this.saveSelection();}},shareSelected:function(_2d){var _2e=new mendix.lib.MxContext(),_2f=_2d.getGuid();_2e.setTrackEntity(this._entity);_2e.setContext(this._entity,_2f||null);_1.publish(mx.ui.makeShareId(this.mxform,this.mxid),[_2e]);},uninitialize:function(){var _30=this._itemList;while(_30.length){var _31=_30.pop();_31.domNode&&_31.destroy();}this._datasource.destroy();}});_1.declare("mxui.widget.ListViewItem",mxui.widget._WidgetBase,{listview:null,template:null,action:null,selectable:"",_selected:false,_checknode:null,buildRendering:function(){var $=mxui.dom.create,_32=this.domNode=$("li",{"class":"mx-listview-item"}),_33=this.selectable;if(_33){_32.appendChild($("#",$("div",{"class":"mx-listview-selection"},this._checknode=_33=="multi"?$("input",{type:"checkbox"}):$("input",{type:"radio"})),$("div",{"class":"mx-listview-content"},this.template||"")));}else{if(this.template){_32.appendChild(this.template);}}this.connect(this.domNode,"click","onClick");},startup:function(){this.parseContent(this.domNode,{schema:""});},select:function(){_1.addClass(this.domNode,"selected");this._checknode.checked=true;this._selected=true;},deselect:function(){_1.removeClass(this.domNode,"selected");this._checknode.checked=false;this._selected=false;},getGuid:function(){return this.mxcontext.getTrackId();},onClick:function(){if(this.selectable){this.listview[this._selected?"deselectItem":"selectItem"](this);}else{if(this.action){var _34=this,obj=this.mxcontext.getObject(),_35=this.action,_36=new mendix.lib.MxContext();var run=function(){mx.ui.execute(_35,{context:_36},_34);_34.listview.shareSelected(_34);};_36.mixin(this.mxcontext);_36.setTrackObject(null);if(_35.microflow&&_35.microflow.validate){this.mxform.validate(run);}else{run();}}}this.listview.shareSelected(this);}});});