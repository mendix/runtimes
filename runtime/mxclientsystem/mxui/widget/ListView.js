
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/ListView",["mxui/widget/Button","mxui/widget/_WidgetBase","mxui/dom","mendix/lang","mendix/lib/EntityPathSource","mendix/lib/MicroflowSource","mendix/lib/MxContext","mendix/lib/SimpleXPathSource","mendix/logger","dojo/dom-class","dojo/dom-construct","dojo/topic","dojo/_base/array","dojo/_base/declare","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){var _10=_e(_2,{declaredClass:"mxui.widget.ListViewItem",listview:null,template:null,action:null,selectable:"",name:"",_selected:false,_checknode:null,buildRendering:function(){var $=_3.create,_11=this.domNode=$("li",{"class":this.name+" mx-listview-item"}),_12=this.selectable;if(_12){_11.appendChild($("#",$("div",{"class":"mx-listview-selection"},this._checknode=_12=="multi"?$("input",{type:"checkbox"}):$("input",{type:"radio"})),$("div",{"class":"mx-listview-content"},this.template||"")));}else{if(this.template){_11.appendChild(this.template);}}this.connect(this.domNode,"click","onClick");},startup:function(){this.parseContent(this.domNode,{schema:""});},select:function(){_a.add(this.domNode,"selected");this._checknode.checked=true;this._selected=true;},deselect:function(){_a.remove(this.domNode,"selected");this._checknode.checked=false;this._selected=false;},getGuid:function(){return this.mxcontext.getTrackId();},onClick:function(){if(this.selectable){this.listview[this._selected?"deselectItem":"selectItem"](this);}else{if(this.action){var _13=this,obj=this.mxcontext.getObject(),_14=this.action,_15=new _7();var run=function(){window.mx.ui.execute(_14,{context:_15},_13);_13.listview.shareSelected(_13);};_15.mixin(this.mxcontext);_15.setTrackObject(null);if(_14.microflow&&_14.microflow.validate){this.mxform.validate(run);}else{run();}}}this.listview.shareSelected(this);}});var _16=_e(_2,{declaredClass:"mxui.widget.ListView",constraint:"",datasource:null,page:5,search:null,action:null,sort:null,selection:null,selectable:"",templateMap:null,_entity:"",_doUpdate:false,_itemList:null,_selected:null,_loadButton:null,_clearButton:null,_searchNode:null,_listNode:null,_emptyNode:null,_loadNode:null,_datasource:null,_searchTimeout:null,buildRendering:function(){var $=_3.create;this._loadButton=new _1({caption:this.translate("load_more"),iconClass:"glyphicon glyphicon-repeat",onClick:_f.hitch(this,"loadMore")});this.domNode=$("div",{"class":"mx-listview"},this._listNode=$("ul",{"class":"mx-list mx-list-striped mx-listview-list"}),this._loadButton.domNode);if(this.action){_a.add(this.domNode,"mx-listview-clickable");}this._emptyNode=$("li",{"class":"mx-listview-empty"},$("label",this.translate("no_items")));this._loadNode=$("li",{"class":"mx-listview-loading"},$("img",{src:require.toUrl("mxui/ui/widget/images/loading.gif")}));if(this.search){this._clearButton=new _1({iconClass:"glyphicon glyphicon-refresh",onClick:_f.hitch(this,"clearSearchNode"),"class":"mx-listview-clear-button"});_b.place($("div",{"class":"mx-listview-searchbar clearfix"},this._clearButton.domNode,$("div",{"class":"mx-listview-search-input"},this._searchNode=$("input",{type:"text",placeholder:this.translate("search"),"class":"form-control"}))),this.domNode,"first");this.connect(this._searchNode,"keyup","searchKeyDown");}},postCreate:function(){if(this.constraint){this.datasource.constraint=this.constraint;}this.createSource();this._itemList=[];this.templateMap=this.templateMap||[];if(this.selectable){var _17=this.selection,_18=this._selected={};for(var i=0,_19;_19=_17[i];i++){_18[_19]=1;}this.mxform.setReturnValue("selection",_17);}},resume:function(){if(this._doUpdate){this.update();this._doUpdate=false;}},update:function(obj,_1a){if(this.get("suspended")){this._doUpdate=true;_1a&&_1a();}else{_3.orphan(this._emptyNode);this.loadData(_1a);}},createSource:function(){var _1b=this.datasource,_1c,_1d;switch(_1b.type){case "xpath":_1c=_1b.path.split("/");this._entity=_1c.pop();_1c.shift();this._datasource=new _8({context:this.mxcontext,page:this.page,sortparams:this.sort,entity:this._entity,path:_1c,constraint:_1b.constraint});break;case "entityPath":_1c=_1b.path.split("/");this._entity=_1c.pop();this._datasource=new _5({context:this.mxcontext,page:this.page,path:_1b.path});break;case "microflow":this._entity=_1b.entity;this._datasource=new _6({context:this.mxcontext,page:this.page,microflow:_1b.microflow});break;default:throw new Error(this.id+".createSource : could not create datasource");}this.subscribe({entity:this._entity,callback:function(){this.update();}});},loadData:function(_1e){this._datasource.first();this.sequence(["sourceReload","renderData","addLoadButton"],_1e);},loadMore:function(){_3.orphan(this._loadButton.domNode);this._listNode.appendChild(this._loadNode);this.sequence(["sourceNext","renderData","addLoadButton"]);},clearData:function(){var _1f=this._itemList;while(_1f.length){var _20=_1f.pop();if(_20.domNode){_20.destroy();}}},sourceReload:function(_21){this._datasource.reload(_21);},sourceNext:function(_22){this._datasource.next(_22);},renderData:function(_23){var _24=this._datasource,_25=_24.getObjects(),_26=[],_27=document.createDocumentFragment(),_28;_3.orphan(this._loadNode);if(_24.getOffset()===0){this.clearData();}if(_24.getSetSize()===0){this._listNode.appendChild(this._emptyNode);_23&&_23();return;}_d.forEach(_25,function(obj,_29){var _2a=this.templateMap[obj.getEntity()];if(!_2a){_d.some(obj.getSuperEntities(),function(_2b){return _2a=this.templateMap[_2b];},this);}var _2c=new _10({listview:this,name:"mx-name-index-"+_29,mxform:this.mxform,template:this.getTemplate(_2a),action:this.action,selectable:this.selectable});_26.push(_2c);if(this._selected){var _2d=obj.getGuid() in this._selected;_2c[_2d?"select":"deselect"]();if(_2d&&this.selectable=="single"){this._selectedItem=_2c;}}_27.appendChild(_2c.domNode);},this);if(_24.getOffset()===0){this.clearData();this._itemList=_26;}else{this._itemList=this._itemList.concat(_26);}this._listNode.appendChild(_27);_d.forEach(_26,function(_2e){_2e.startup();});_28=_d.map(_26,function(_2f,i){var _30=this.mxcontext;return function(cb){var _31=new _7({mxcontext:_30});_31.setObject(_25[i]);_2f.applyContext(_31,function(){_2f.set("suspended",false);cb();});};},this);this.collect(_28,_23);},addLoadButton:function(_32){if(!this._datasource.atEnd()){this.domNode.appendChild(this._loadButton.domNode);}else{_3.orphan(this._loadButton.domNode);}_4.nullExec(_32);},searchKeyDown:function(){var _33=this,_34=this._datasource;this._clearButton.set("iconClass","glyphicon "+(this._searchNode.value?"glyphicon-remove":"glyphicon-refresh"));clearTimeout(this._searchTimeout);this._searchTimeout=setTimeout(function(){_34.setConstraints(_33._getSearchConstraint());_33.update();},500);},clearSearchNode:function(){clearTimeout(this._searchTimeout);this._clearButton.set("iconClass","glyphicon glyphicon-refresh");this._searchNode.value="";this._datasource.setConstraints("");this.update();},saveSelection:function(){this.mxform.setReturnValue("selection",_4.objectToArray(this._selected));},selectItem:function(_35){var _36=_35.getGuid();_35.select();if(this.selectable=="single"){var _37=this._selectedItem;_37&&_37.deselect();this._selectedItem=_35;this.mxform.setReturnValue("selection",[_36]);}else{this._selected[_36]=1;this.saveSelection();}},deselectItem:function(_38){var _39=_38.getGuid();_38.deselect();if(this.selectable=="single"){this.mxform.setReturnValue("selection",[]);}else{delete this._selected[_39];this.saveSelection();}},shareSelected:function(_3a){var _3b=new _7(),_3c=_3a.getGuid();_3b.setTrackEntity(this._entity);_3b.setContext(this._entity,_3c||null);_c.publish(window.mx.ui.makeShareId(this.mxform,this.mxid),_3b);},uninitialize:function(){this.clearData();this._datasource.destroy();},_getSearchConstraint:function(){if(this.search){var _3d=this._searchNode.value,_3e=[],_3f=this.search.attributes,_40=this.search.method;if(_3d){for(var i=0,_41;_41=_3f[i];++i){_3e.push(_40+"("+_41+",'"+_3d+"')");}return "["+_3e.join(" or ")+"]";}}return "";}});return _16;});