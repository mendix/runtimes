
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/ListView",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget.ListView");_1.declare("mxui.widget.ListView",mxui.widget._WidgetBase,{constraint:"",datasource:null,page:5,search:null,action:null,sort:null,selection:null,selectable:"",templateMap:null,_entity:"",_doUpdate:false,_itemList:null,_selected:null,_loadButton:null,_clearButton:null,_searchNode:null,_listNode:null,_emptyNode:null,_loadNode:null,_datasource:null,_searchTimeout:null,buildRendering:function(){var $=mxui.dom.create;this._loadButton=new mxui.widget.Button({caption:this.translate("load_more"),iconClass:"glyphicon glyphicon-repeat",onClick:_1.hitch(this,"loadMore")});this.domNode=$("div",{"class":"mx-listview"},this._listNode=$("ul",{"class":"mx-list mx-list-striped mx-listview-list"}),this._loadButton.domNode);if(this.action){_1.addClass(this.domNode,"mx-listview-clickable");}this._emptyNode=$("li",{"class":"mx-listview-empty"},$("label",this.translate("no_items")));this._loadNode=$("li",{"class":"mx-listview-loading"},$("img",{src:require.toUrl("mxui/ui/widget/images/loading.gif")}));if(this.search){this._clearButton=new mxui.widget.Button({iconClass:"glyphicon glyphicon-refresh",onClick:_1.hitch(this,"clearSearchNode"),"class":"mx-listview-clear-button"});_1.place($("div",{"class":"mx-listview-searchbar clearfix"},this._clearButton.domNode,$("div",{"class":"mx-listview-search-input"},this._searchNode=$("input",{type:"text",placeholder:this.translate("search"),"class":"form-control"}))),this.domNode,"first");this.connect(this._searchNode,"keyup","searchKeyDown");}},postCreate:function(){if(this.constraint){this.datasource.constraint=this.constraint;}this.createSource();this._itemList=[];this.templateMap=this.templateMap||[];if(this.selectable){var _4=this.selection,_5=this._selected={};for(var i=0,_6;_6=_4[i];i++){_5[_6]=1;}this.mxform.setReturnValue("selection",_4);}},resume:function(){if(this._doUpdate){this.update();this._doUpdate=false;}},update:function(_7,_8){if(this.get("suspended")){this._doUpdate=true;_8&&_8();}else{mxui.dom.orphan(this._emptyNode);this.loadData(_8);}},createSource:function(){var _9=this.datasource,_a,_b;switch(_9.type){case "xpath":_a=_9.path.split("/");this._entity=_a.pop();_a.shift();this._datasource=new mendix.lib.SimpleXPathSource({context:this.mxcontext,page:this.page,sortparams:this.sort,entity:this._entity,path:_a,constraint:_9.constraint});break;case "entityPath":_a=_9.path.split("/");this._entity=_a.pop();this._datasource=new mendix.lib.EntityPathSource({context:this.mxcontext,page:this.page,path:_9.path});break;case "microflow":this._entity=_9.entity;this._datasource=new mendix.lib.MicroflowSource({context:this.mxcontext,page:this.page,microflow:_9.microflow});break;default:throw new Error(this.id+".createSource : could not create datasource");}this.subscribe({entity:this._entity,callback:function(){this.update();}});},loadData:function(_c){this._datasource.first();this.sequence(["sourceReload","renderData","addLoadButton"],_c);},loadMore:function(){mxui.dom.orphan(this._loadButton.domNode);this._listNode.appendChild(this._loadNode);this.sequence(["sourceNext","renderData","addLoadButton"]);},clearData:function(){var _d=this._itemList;while(_d.length){var _e=_d.pop();if(_e.domNode){_e.destroy();}}},sourceReload:function(_f){this._datasource.reload(_f);},sourceNext:function(_10){this._datasource.next(_10);},renderData:function(_11){var _12=this._datasource,_13=_12.getObjects(),_14=[],_15=document.createDocumentFragment(),_16;mxui.dom.orphan(this._loadNode);if(_12.getOffset()===0){this.clearData();}if(_12.getSetSize()===0){this._listNode.appendChild(this._emptyNode);_11&&_11();return;}_1.forEach(_13,function(obj){var _17=this.templateMap[obj.getEntity()];if(!_17){_1.some(obj.getSuperEntities(),function(_18){return _17=this.templateMap[_18];},this);}var _19=new mxui.widget.ListViewItem({listview:this,mxform:this.mxform,template:this.getTemplate(_17),action:this.action,selectable:this.selectable});_14.push(_19);if(this._selected){var _1a=obj.getGuid() in this._selected;_19[_1a?"select":"deselect"]();if(_1a&&this.selectable=="single"){this._selectedItem=_19;}}_15.appendChild(_19.domNode);},this);if(_12.getOffset()===0){this.clearData();this._itemList=_14;}else{this._itemList=this._itemList.concat(_14);}this._listNode.appendChild(_15);_1.forEach(_14,function(_1b){_1b.startup();});_16=_1.map(_14,function(_1c,i){var _1d=this.mxcontext;return function(cb){var _1e=new mendix.lib.MxContext({mxcontext:_1d});_1e.setObject(_13[i]);_1c.applyContext(_1e,function(){_1c.set("suspended",false);cb();});};},this);this.collect(_16,_11);},addLoadButton:function(_1f){if(!this._datasource.atEnd()){this.domNode.appendChild(this._loadButton.domNode);}else{mxui.dom.orphan(this._loadButton.domNode);}mendix.lang.nullExec(_1f);},searchKeyDown:function(){var _20=this,_21=this._datasource;this._clearButton.set("iconClass","glyphicon "+(this._searchNode.value?"glyphicon-remove":"glyphicon-refresh"));clearTimeout(this._searchTimeout);this._searchTimeout=setTimeout(function(){_21.setConstraints(_20._getSearchConstraint());_20.update();},500);},clearSearchNode:function(){clearTimeout(this._searchTimeout);this._clearButton.set("iconClass","glyphicon glyphicon-refresh");this._searchNode.value="";this._datasource.setConstraints("");this.update();},saveSelection:function(){this.mxform.setReturnValue("selection",mendix.lang.objectToArray(this._selected));},selectItem:function(_22){var _23=_22.getGuid();_22.select();if(this.selectable=="single"){var _24=this._selectedItem;_24&&_24.deselect();this._selectedItem=_22;this.mxform.setReturnValue("selection",[_23]);}else{this._selected[_23]=1;this.saveSelection();}},deselectItem:function(_25){var _26=_25.getGuid();_25.deselect();if(this.selectable=="single"){this.mxform.setReturnValue("selection",[]);}else{delete this._selected[_26];this.saveSelection();}},shareSelected:function(_27){var _28=new mendix.lib.MxContext(),_29=_27.getGuid();_28.setTrackEntity(this._entity);_28.setContext(this._entity,_29||null);_1.publish(mx.ui.makeShareId(this.mxform,this.mxid),[_28]);},uninitialize:function(){this.clearData();this._datasource.destroy();},_getSearchConstraint:function(){if(this.search){var _2a=this._searchNode.value,_2b=[],_2c=this.search.attributes,_2d=this.search.method;if(_2a){for(var i=0,_2e;_2e=_2c[i];++i){_2b.push(_2d+"("+_2e+",'"+_2a+"')");}return "["+_2b.join(" or ")+"]";}}return "";}});_1.declare("mxui.widget.ListViewItem",mxui.widget._WidgetBase,{listview:null,template:null,action:null,selectable:"",_selected:false,_checknode:null,buildRendering:function(){var $=mxui.dom.create,_2f=this.domNode=$("li",{"class":"mx-listview-item"}),_30=this.selectable;if(_30){_2f.appendChild($("#",$("div",{"class":"mx-listview-selection"},this._checknode=_30=="multi"?$("input",{type:"checkbox"}):$("input",{type:"radio"})),$("div",{"class":"mx-listview-content"},this.template||"")));}else{if(this.template){_2f.appendChild(this.template);}}this.connect(this.domNode,"click","onClick");},startup:function(){this.parseContent(this.domNode,{schema:""});},select:function(){_1.addClass(this.domNode,"selected");this._checknode.checked=true;this._selected=true;},deselect:function(){_1.removeClass(this.domNode,"selected");this._checknode.checked=false;this._selected=false;},getGuid:function(){return this.mxcontext.getTrackId();},onClick:function(){if(this.selectable){this.listview[this._selected?"deselectItem":"selectItem"](this);}else{if(this.action){var _31=this,obj=this.mxcontext.getObject(),_32=this.action,_33=new mendix.lib.MxContext();var run=function(){mx.ui.execute(_32,{context:_33},_31);_31.listview.shareSelected(_31);};_33.mixin(this.mxcontext);_33.setTrackObject(null);if(_32.microflow&&_32.microflow.validate){this.mxform.validate(run);}else{run();}}}this.listview.shareSelected(this);}});});