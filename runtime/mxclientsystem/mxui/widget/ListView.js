/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/ListView",["mxui/widget/Button","mxui/widget/_WidgetBase","mxui/mixin/_Stateful","mxui/mixin/_ContainingSelection","mxui/dom","mendix/lib/MxContext","mendix/lang","webcore/datasource/OfflineSource","webcore/datasource/EntityPathSource","webcore/datasource/MicroflowSource","webcore/datasource/XPathSource","dojo/dom-class","dojo/dom-construct","dojo/aspect","dojo/_base/array","dojo/_base/declare","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){var $=_5.create;var _12=_10(_2,{declaredClass:"mxui.widget.ListViewItem",listview:null,template:null,action:null,selectable:"",name:"",_selected:false,_checknode:null,buildRendering:function(){var _13=this.domNode=$("li",{"class":this.name+" mx-listview-item"}),_14=this.selectable;if(_14){var _15=$("#");if(_14!="singleandmaintain"){_15.appendChild($("div",{"class":"mx-listview-selection"},this._checknode=_14=="multi"?$("input",{type:"checkbox"}):$("input",{type:"radio"})));}_15.appendChild($("div",{"class":"mx-listview-content"},this.template||""));_13.appendChild(_15);}else{if(this.template){_13.appendChild(this.template);}}this.connect(this.domNode,"click","onClick");},startup:function(){this.parseContent(this.domNode,{schema:""});},select:function(){_c.add(this.domNode,"selected");if(this._checknode){this._checknode.checked=true;}this._selected=true;},deselect:function(){_c.remove(this.domNode,"selected");if(this._checknode){this._checknode.checked=false;}this._selected=false;},getGuid:function(){return this.mxcontext.getTrackId();},onClick:function(){if(this.selectable){if(this._selected){this.listview._deselectItem(this);}else{this.listview._selectItem(this);}}else{if(this.action){var _16=this,_17=this.action,_18=new _6();var run=function(){window.mx.ui.execute(_17,{context:_18});_16.listview._shareSelection(_16.listview._entity);};_18.mixin(this.mxcontext);_18.setTrackObject(null);if(_17.microflow&&_17.microflow.validate){this.mxform.validate(run);}else{run();}}}}});var _19=_10([_2,_3,_4],{declaredClass:"mxui.widget.ListView",datasource:null,dataSourceMixin:null,page:5,search:null,action:null,sort:null,selectable:"",templateMap:null,_entity:"",_itemIndex:0,_itemList:null,_loadButton:null,_clearButton:null,_searchNode:null,_listNode:null,_emptyNode:null,_loadNode:null,_datasource:null,_lastRenderId:0,_preserveSelection:false,constructor:function(_1a){if(_1a.selection){this._preserveSelection=true;}},postMixInProperties:function(){if(this.listViewSelectionMode){this.selectable=this.listViewSelectionMode;}},buildRendering:function(){this._loadButton=new _1({caption:this.translate("load_more"),iconClass:"glyphicon-repeat",onClick:_11.hitch(this,"_loadMore"),"class":"mx-listview-loadMore"});this.domNode=$("div",{"class":"mx-listview"},this._listNode=$("ul",{"class":"mx-list mx-list-striped mx-listview-list"}),this._loadButton.domNode);if(this.selectable!="singleandmaintain"){_c.add(this.domNode,"mx-listview-selectable");}if(this.action){_c.add(this.domNode,"mx-listview-clickable");}this._emptyNode=$("li",{"class":"mx-listview-empty"},$("label",this.translate("no_items")));this._loadNode=$("li",{"class":"mx-listview-loading"},$("img",{src:require.toUrl("mxui/ui/widget/images/loading.gif")}));if(this.search){this._clearButton=new _1({iconClass:"glyphicon-refresh",onClick:_11.hitch(this,"_clearSearchNode"),"class":"mx-listview-clear-button"});_d.place($("div",{"class":"mx-listview-searchbar clearfix"},this._clearButton.domNode,$("div",{"class":"mx-listview-search-input"},this._searchNode=$("input",{type:"text",placeholder:this.translate("search"),"class":"form-control",value:this.getState("searchValue","")}))),this.domNode,"first");this.connect(this._searchNode,"keyup","_searchKeyDown");}},postCreate:function(){this._createSource();this._itemList=[];this.templateMap=this.templateMap||[];this.selection=this.getState("selection",this.selection);},_onLoad:function(_1b){if(this.selectable){if(!this._preserveSelection){var _1c=_f.map(this._datasource.getObjects(),function(obj){return obj.getGuid();});this.selection=_f.filter(this.selection,function(_1d){return _f.indexOf(_1c,_1d)!=-1;});}this._ensureSelection();this._shareSelection(this._entity);}if(_1b){_1b();}},update:function(obj,_1e){this._registerSubscriptions();_5.orphan(this._emptyNode);this._loadData(_1e);},_registerSubscriptions:function(){this.unsubscribeAll();this.subscribe({entity:this._entity,callback:function(){this.update();}});var _1f=this.mxcontext.getTrackId();if(_1f){this.subscribe({guid:_1f,callback:function(){this.update();}});}},storeState:function(_20){if(this._searchNode){_20("searchValue",this._searchNode.value);}_20("datasourceOffset",this._datasource.getOffset());_20("selection",this.selection);},uninitialize:function(){this._clearData();this._datasource.destroy();},_createSource:function(){var _21=this.datasource,_22={context:this.mxcontext,page:this.page},_23;var _24=_21.type;switch(_24){case "xpath":_23=_21.path.split("/");this._entity=_23.pop();this._datasource=new _b(_11.mixin(_22,{sortparams:this.sort,},_21,this.dataSourceMixin));this._datasource.setConstraints(this._getSearchConstraint());break;case "entityPath":_23=_21.path.split("/");this._entity=_23.pop();this._datasource=new _9(_11.mixin(_22,_21));break;case "microflow":this._entity=_21.entity;this._datasource=new _a(_11.mixin(_22,_21));break;case "offline":this._entity=_21.entity;this._datasource=new _8(_11.mixin(_22,{entity:_21.entity,sort:this.sort}));break;default:throw new Error(this.id+"._createSource : could not create datasource");}var _25=this.getState("datasourceOffset",0);if(_25){this._datasource.setPageSize(_25+this.page);this._datasource.setOffset(0);var _26=this,_27=_e.after(this,"_onLoad",function(){_26._datasource.setPageSize(_26.page);_26._datasource.setOffset(_25);_27.remove();});}},_clearData:function(){while(this._itemList.length){var _28=this._itemList.pop();if(_28.domNode){_28.destroy();}}},_showLoadingIcon:function(){this._listNode.appendChild(this._loadNode);},_hideLoadingIcon:function(){_5.orphan(this._loadNode);},_showLoadMoreButton:function(){this.domNode.appendChild(this._loadButton.domNode);},_hideLoadMoreButton:function(){_5.orphan(this._loadButton.domNode);},_updateLoadMoreButton:function(){if(!this._datasource.atEnd()){this._showLoadMoreButton();}else{this._hideLoadMoreButton();}},_searchKeyDown:function(){var _29=this,_2a=this._datasource;this._clearButton.set("iconClass",this._searchNode.value?"glyphicon-remove":"glyphicon-refresh");clearTimeout(this._searchTimeout);this._searchTimeout=setTimeout(function(){_29._clearData();_29._showLoadingIcon();_29._hideLoadMoreButton();_2a.setConstraints(_29._getSearchConstraint());_29.update();},500);},_clearSearchNode:function(){clearTimeout(this._searchTimeout);this._clearButton.set("iconClass","glyphicon-refresh");this._searchNode.value="";this._datasource.setConstraints("");this.update();},_selectItem:function(_2b){var _2c=_2b.getGuid();if(/^(single|singleandmaintain)$/.test(this.selectable)){var _2d=this.selection[0],_2e=_7.find(this._itemList,function(_2f){return _2f.getGuid()==_2d;});if(_2e){_2e.deselect();}this.selection=[_2c];}else{this._addToSelection(_2c);}this._shareSelection(this._entity);_2b.select();},_deselectItem:function(_30){if(this.selectable!=="singleandmaintain"){this._removeFromSelection(_30.getGuid());this._shareSelection(this._entity);_30.deselect();}},_getSearchConstraint:function(){if(this.search){var _31=this._searchNode.value,_32=[],_33=this.search.attributes,_34=this.search.method;if(_31){for(var i=0,_35;_35=_33[i];++i){_32.push(_34+"("+_35+",'"+_31+"')");}return "["+_32.join(" or ")+"]";}}return "";},_loadData:function(_36){this._datasource.first();this.sequence(["_sourceReload","_onLoad","_renderData"],function(){this._updateLoadMoreButton();if(_36){_36();}});},_loadMore:function(){this._showLoadingIcon();this._hideLoadMoreButton();this.sequence(["_sourceNext","_renderData"],function(){this._updateLoadMoreButton();});},_sourceReload:function(_37){this._datasource.reload(_37);},_sourceNext:function(_38){this._datasource.next(_38);},_renderData:function(_39){var _3a=this._datasource.getObjects(),_3b=this._datasource.getOffset()===0?0:this._itemIndex,_3c=this._createListItems(_3a,_3b),_3d=$("div",{"class":"mx-offscreen"}),_3e=this._lastRenderId=_7.getUniqueId();this.domNode.appendChild(_3d);_f.forEach(_3c,function(_3f){_3d.appendChild(_3f.domNode);_3f.startup();});this._loadListItems(_3c,_3a,_11.hitch(this,function(){_5.orphan(_3d);if(_3e!=this._lastRenderId){_f.forEach(_3c,function(_40){_40.destroy();});if(_39){_39();}return;}this._hideLoadingIcon();if(this._datasource.getOffset()===0){this._clearData();}this._itemList=this._itemList.concat(_3c);this._itemIndex=this._itemList.length;_f.forEach(_3c,function(_41){this._listNode.appendChild(_41.domNode);},this);if(this._itemList.length===0){this._listNode.appendChild(this._emptyNode);}if(_39){_39();}}));},_createListItems:function(_42,_43){return _f.map(_42,function(obj){var _44=this.templateMap[obj.getEntity()];if(!_44){_f.some(obj.getSuperEntities(),function(_45){return _44=this.templateMap[_45];},this);}var _46=new _12({uniqueid:this.uniqueid+"_obj"+obj.getGuid(),listview:this,name:"mx-name-index-"+_43++,mxform:this.mxform,template:this.getTemplate(_44),action:this.action,selectable:this.selectable});if(this.selectable&&this._isSelected(obj.getGuid())){_46.select();}return _46;},this);},_loadListItems:function(_47,_48,_49){this.collect(_f.map(_47,function(_4a,i){return function(cb){var _4b=new _6({mxcontext:this.mxcontext});_4b.setObject(_48[i]);_4a.applyContext(_4b,cb);};}),_49);},_ensureSelection:function(){var _4c=this._datasource.getObjects();if(this.selectable==="singleandmaintain"&&!this._hasSelection()&&_4c.length>0){this._addToSelection(_4c[0].getGuid());}}});return _19;});