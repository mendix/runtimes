
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/ListView",["mxui/widget/Button","mxui/widget/_WidgetBase","mxui/mixin/_Stateful","mxui/mixin/_ContainingSelection","mxui/dom","mendix/lib/EntityPathSource","mendix/lib/MicroflowSource","mendix/lib/MxContext","mendix/lib/XPathSource","mendix/lang","dojo/dom-class","dojo/dom-construct","dojo/aspect","dojo/_base/array","dojo/_base/declare","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){var $=_5.create;var _11=_f(_2,{declaredClass:"mxui.widget.ListViewItem",listview:null,template:null,action:null,selectable:"",name:"",_selected:false,_checknode:null,buildRendering:function(){var _12=this.domNode=$("li",{"class":this.name+" mx-listview-item"}),_13=this.selectable;if(_13){var _14=$("#");if(_13!="singleandmaintain"){_14.appendChild($("div",{"class":"mx-listview-selection"},this._checknode=_13=="multi"?$("input",{type:"checkbox"}):$("input",{type:"radio"})));}_14.appendChild($("div",{"class":"mx-listview-content"},this.template||""));_12.appendChild(_14);}else{if(this.template){_12.appendChild(this.template);}}this.connect(this.domNode,"click","onClick");},startup:function(){this.parseContent(this.domNode,{schema:""});},select:function(){_b.add(this.domNode,"selected");if(this._checknode){this._checknode.checked=true;}this._selected=true;},deselect:function(){_b.remove(this.domNode,"selected");if(this._checknode){this._checknode.checked=false;}this._selected=false;},getGuid:function(){return this.mxcontext.getTrackId();},onClick:function(){if(this.selectable){if(this._selected){this.listview._deselectItem(this);}else{this.listview._selectItem(this);}}else{if(this.action){var _15=this,_16=this.action,_17=new _8();var run=function(){window.mx.ui.execute(_16,{context:_17});_15.listview._shareSelection(_15.listview._entity);};_17.mixin(this.mxcontext);_17.setTrackObject(null);if(_16.microflow&&_16.microflow.validate){this.mxform.validate(run);}else{run();}}}}});var _18=_f([_2,_3,_4],{declaredClass:"mxui.widget.ListView",constraint:"",datasource:null,page:5,search:null,action:null,sort:null,selectable:"",templateMap:null,_entity:"",_itemList:null,_itemIndex:0,_loadButton:null,_clearButton:null,_searchNode:null,_listNode:null,_emptyNode:null,_loadNode:null,_datasource:null,_filterSelection:true,buildRendering:function(){this._loadButton=new _1({caption:this.translate("load_more"),iconClass:"glyphicon glyphicon-repeat",onClick:_10.hitch(this,"_loadMore"),"class":"mx-listview-loadMore"});this.domNode=$("div",{"class":"mx-listview"},this._listNode=$("ul",{"class":"mx-list mx-list-striped mx-listview-list"}),this._loadButton.domNode);if(this.action){_b.add(this.domNode,"mx-listview-clickable");}this._emptyNode=$("li",{"class":"mx-listview-empty"},$("label",this.translate("no_items")));this._loadNode=$("li",{"class":"mx-listview-loading"},$("img",{src:require.toUrl("mxui/ui/widget/images/loading.gif")}));if(this.search){this._clearButton=new _1({iconClass:"glyphicon glyphicon-refresh",onClick:_10.hitch(this,"_clearSearchNode"),"class":"mx-listview-clear-button"});_c.place($("div",{"class":"mx-listview-searchbar clearfix"},this._clearButton.domNode,$("div",{"class":"mx-listview-search-input"},this._searchNode=$("input",{type:"text",placeholder:this.translate("search"),"class":"form-control",value:this.getState("searchValue","")}))),this.domNode,"first");this.connect(this._searchNode,"keyup","_searchKeyDown");}},postCreate:function(){this._createSource();this._itemList=[];this.templateMap=this.templateMap||[];if(this.selection&&this.selection.length){this._filterSelection=false;}this.selection=this.getState("selection",this.selection);},_onLoad:function(_19){if(this.selectable){if(this._filterSelection){var _1a=_e.map(this._datasource.getObjects(),function(obj){return obj.getGuid();});this.selection=_e.filter(this.selection,function(_1b){return _e.indexOf(_1a,_1b)!=-1;});}this._ensureSelection();this._shareSelection(this._entity);}_19&&_19();},update:function(obj,_1c){this._registerSubscriptions();_5.orphan(this._emptyNode);this._loadData(_1c);},_registerSubscriptions:function(){this.unsubscribeAll();this.subscribe({entity:this._entity,callback:function(){this.update();}});var _1d=this.mxcontext.getTrackId();if(_1d){this.subscribe({guid:_1d,callback:function(){this.update();}});}},storeState:function(_1e){if(this._searchNode){_1e("searchValue",this._searchNode.value);}_1e("datasourceOffset",this._datasource.getOffset());_1e("selection",this.selection);},uninitialize:function(){this._clearData();this._datasource.destroy();},_createSource:function(){var _1f=this.datasource,_20={context:this.mxcontext,page:this.page},_21;switch(_1f.type){case "xpath":_21=_1f.path.split("/");this._entity=_21.pop();_21.shift();this._datasource=new _9(_10.mixin(_20,{sortparams:this.sort,entity:this._entity,path:_21,constraint:this.constraint||_1f.constraint}));this._datasource.setConstraints(this._getSearchConstraint());break;case "entityPath":_21=_1f.path.split("/");this._entity=_21.pop();this._datasource=new _6(_10.mixin(_20,{path:_1f.path}));break;case "microflow":this._entity=_1f.entity;this._datasource=new _7(_10.mixin(_20,{microflow:_1f.microflow}));break;default:throw new Error(this.id+"._createSource : could not create datasource");}var _22=this.getState("datasourceOffset",0);if(_22){this._datasource.setPageSize(_22+this.page);this._datasource.setOffset(0);var _23=this,_24=_d.after(this,"_onLoad",function(){_23._datasource.setPageSize(_23.page);_23._datasource.setOffset(_22);_24.remove();});}},_clearData:function(){this._itemIndex=0;while(this._itemList.length){var _25=this._itemList.pop();if(_25.domNode){_25.destroy();}}},_addLoadButton:function(){if(!this._datasource.atEnd()){this.domNode.appendChild(this._loadButton.domNode);}else{_5.orphan(this._loadButton.domNode);}},_searchKeyDown:function(){var _26=this,_27=this._datasource;this._clearButton.set("iconClass","glyphicon "+(this._searchNode.value?"glyphicon-remove":"glyphicon-refresh"));clearTimeout(this._searchTimeout);this._searchTimeout=setTimeout(function(){_27.setConstraints(_26._getSearchConstraint());_26.update();},500);},_clearSearchNode:function(){clearTimeout(this._searchTimeout);this._clearButton.set("iconClass","glyphicon glyphicon-refresh");this._searchNode.value="";this._datasource.setConstraints("");this.update();},_selectItem:function(_28){var _29=_28.getGuid();if(/^(single|singleandmaintain)$/.test(this.selectable)){var _2a=this.selection[0],_2b=_a.find(this._itemList,function(_2c){return _2c.getGuid()==_2a;});_2b&&_2b.deselect();this.selection=[_29];}else{this._addToSelection(_29);}this._shareSelection(this._entity);_28.select();},_deselectItem:function(_2d){if(this.selectable!=="singleandmaintain"){this._removeFromSelection(_2d.getGuid());this._shareSelection(this._entity);_2d.deselect();}},_getSearchConstraint:function(){if(this.search){var _2e=this._searchNode.value,_2f=[],_30=this.search.attributes,_31=this.search.method;if(_2e){for(var i=0,_32;_32=_30[i];++i){_2f.push(_31+"("+_32+",'"+_2e+"')");}return "["+_2f.join(" or ")+"]";}}return "";},_loadData:function(_33){this._datasource.first();this.sequence(["_sourceReload","_onLoad","_renderData"],function(){this._addLoadButton();_33&&_33();});},_loadMore:function(){_5.orphan(this._loadButton.domNode);this._listNode.appendChild(this._loadNode);this.sequence(["_sourceNext","_renderData"],function(){this._addLoadButton();});},_sourceReload:function(_34){this._datasource.reload(_34);},_sourceNext:function(_35){this._datasource.next(_35);},_renderData:function(_36){var _37=this._datasource,_38=_37.getObjects(),_39=[],_3a=document.createDocumentFragment(),_3b;_5.orphan(this._loadNode);if(_37.getOffset()===0){this._clearData();}if(_37.getSetSize()===0){this._listNode.appendChild(this._emptyNode);_36&&_36();return;}_e.forEach(_38,function(obj){var _3c=this.templateMap[obj.getEntity()];if(!_3c){_e.some(obj.getSuperEntities(),function(_3d){return _3c=this.templateMap[_3d];},this);}var _3e=new _11({uniqueid:this.uniqueid+"_obj"+obj.getGuid(),listview:this,name:"mx-name-index-"+this._itemIndex++,mxform:this.mxform,template:this.getTemplate(_3c),action:this.action,selectable:this.selectable});_39.push(_3e);if(this.selectable){_3e[this._isSelected(obj.getGuid())?"select":"deselect"]();}_3a.appendChild(_3e.domNode);},this);if(_37.getOffset()===0){this._itemList=_39;}else{this._itemList=this._itemList.concat(_39);}this._listNode.appendChild(_3a);_e.forEach(_39,function(_3f){_3f.startup();});_3b=_e.map(_39,function(_40,i){var _41=this.mxcontext;return function(cb){var _42=new _8({mxcontext:_41});_42.setObject(_38[i]);_40.applyContext(_42,cb);};},this);this.collect(_3b,_36);},_ensureSelection:function(){var _43=this._datasource.getObjects();if(this.selectable==="singleandmaintain"&&!this._hasSelection()&&_43.length>0){this._addToSelection(_43[0].getGuid());}}});return _18;});