
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/InputReferenceSetSelector",["mxui/widget/Button","mxui/widget/_WidgetBase","mxui/mixin/_ValidationHelper","mxui/dom","mendix/logger","dojo/dom-construct","dojo/_base/declare","dojo/_base/lang"],function(_1,_2,_3,_4,_5,_6,_7,_8){var _9=_7([_2,_3],{declaredClass:"mxui.widget.InputReferenceSetSelector",attributePath:"",constraint:"",constrainedBy:null,selectForm:"",events:null,_mxObject:null,_readNode:null,_editNode:null,_selectButton:null,_subscription:null,_assoc:"",_entity:"",_attr:"",_constraint:"",postCreate:function(){var _a=this.attributePath.split("/");this.constrainedBy=this.constrainedBy||[];this._assoc=_a[1];this._entity=_a[2];this._attr=_a[3];},buildRendering:function(){var $=_4.create;var _b=this._readNode=$("label"),_c=this._editNode=$("input",{type:"text",readonly:"readonly","class":"form-control"});var _d=this._selectButton=new _1({"class":"mx-referencesetselector-select-button",iconClass:"glyphicon glyphicon-share-alt"});this.connect(_d,"onClick","openSelectForm");this.connect(_c,"click","openSelectForm");this.domNode=$("div",{"class":"mx-referencesetselector"},_d.domNode,$("div",{"class":"mx-referencesetselector-input-wrapper"},this._editNode));},startup:function(){this.setupValidation(this._assoc);},onChange:function(){var ev=this.events&&this.events.change;ev&&this.validatedMicroflow(ev);},enable:function(){_6.place(this._selectButton.domNode,this.domNode,"first");this._readNode.parentNode.replaceChild(this._editNode,this._readNode);},disable:function(){this.domNode.removeChild(this._selectButton.domNode);this._editNode.parentNode.replaceChild(this._readNode,this._editNode);},checkDisabled:function(){return (this.inherited(arguments)||!this._mxObject||this._mxObject.isReadonlyAttr(this._assoc));},update:function(_e,_f){this._mxObject=_e;this.setValidationObject(_e);var _10=function(_11){this.updateDisabled();this.renderObject(_11);};if(this._subscription){this.unsubscribe(this._subscription);}if(_e){this._constraint=this.constraint.replace("[%CurrentObject%]",_e.getGuid());this._subscription=this.subscribe({guid:_e.getGuid(),attr:this._assoc,callback:_8.hitch(this,_10,null)});}_10.call(this,_f);},renderObject:function(_12){var _13=this,obj=this._mxObject,_14=obj&&obj.get(this._assoc);var _15=function(val){_13.setValue(val||"");_12&&_12();};if(_14&&_14.length){window.mx.data.get({guids:_14,callback:function(_16){var _17=[];for(var i=0,obj;obj=_16[i];i++){_17.push(window.mx.parser.formatAttribute(obj,this._attr));}_15(_17.join(", "));},error:function(e){window.mx.onError(e);_12&&_12();}},this);}else{_15();}},openSelectForm:function(){window.mx.data.getBacktrack(this._mxObject.getGuid(),this.constrainedBy,function(_18,_19){window.mx.ui.execute({form:this.selectForm},{params:{selection:this._mxObject.getReferences(this._assoc),selectable:"multi",constraint:_19?_18+this._constraint:"[0=1]"},callback:function(_1a){_1a.listen("save",_8.hitch(this,function(_1b){var _1c=_1a.getReturnValue("selection");if(_1c){this._mxObject.set(this._assoc,_1c);this.renderObject();this.onChange();}else{_5.error(this.id+" form return value 'selection' does not exist");}_1b();}));}},this);},function(e){window.mx.onError(e);},this);},setValue:function(_1d){this._editNode.value=_1d;if(_1d){_4.text(this._readNode,_1d);}else{this._readNode.innerHTML="&nbsp;";}}});return _9;});