/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/InputReferenceSetSelector",["mxui/widget/Button","mxui/widget/_WidgetBase","mxui/mixin/_ValidationHelper","mxui/dom","mendix/lang","mendix/logger","dojo/dom-construct","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var _a=_9([_2,_3],{declaredClass:"mxui.widget.InputReferenceSetSelector",attributePath:"",constraint:"",constrainedBy:null,selectForm:"",events:null,_mxObject:null,_readNode:null,_editNode:null,_selectButton:null,_assoc:"",_entity:"",_attr:"",_constraint:"",postCreate:function(){var _b=this.attributePath.split("/");this.constrainedBy=this.constrainedBy||[];this._assoc=_b[1];this._entity=_b[2];this._attr=_b[3];},buildRendering:function(){var $=_4.create;this._readNode=this.insideFormGroup?$("p",{"class":"form-control-static"}):$("label");this._readNode.innerHTML="&nbsp;";this._editNode=$("input",{type:"text",readonly:"readonly","class":"form-control"});var _c=this._selectButton=new _1({"class":"mx-referencesetselector-select-button",iconClass:"glyphicon-share-alt"});this.connect(_c,"onClick","openSelectForm");this.connect(this._editNode,"click","openSelectForm");this.domNode=$("div",{"class":"mx-referencesetselector"},_c.domNode,$("div",{"class":"mx-referencesetselector-input-wrapper"},this._editNode));},startup:function(){this.setupValidation(this._assoc);},onChange:function(){var ev=this.events&&this.events.change;ev&&this.validatedMicroflow(ev);},enable:function(){_7.place(this._selectButton.domNode,this.domNode,"first");this._readNode.parentNode.replaceChild(this._editNode,this._readNode);},disable:function(){this.domNode.removeChild(this._selectButton.domNode);this._editNode.parentNode.replaceChild(this._readNode,this._editNode);},checkDisabled:function(){return (this.inherited(arguments)||!this._mxObject||this._mxObject.isReadonlyAttr(this._assoc));},update:function(_d,_e){this._mxObject=_d;this.unsubscribeAll();this.setValidationObject(_d);var _f=function(_10){this.updateDisabled();this.renderObject(_10);};if(_d){this._constraint=this.constraint.replace("[%CurrentObject%]",_d.getGuid());this.subscribe({guid:_d.getGuid(),callback:_8.partial(_f,null)});this.subscribe({guid:_d.getGuid(),attr:this._assoc,callback:_8.partial(_f,null)});}_f.call(this,_e);},renderObject:function(_11){var _12=this,obj=this._mxObject,_13=obj&&obj.get2(this._assoc);var _14=function(val){_12.setValue(val||"");_11&&_11();};if(_13&&_13.length){window.mx.data.get({guids:_13,callback:function(_15){var _16=[];for(var i=0,obj;obj=_15[i];i++){_16.push(window.mx.parser.formatAttribute(obj,this._attr));}_14(_16.join(", "));},error:function(e){window.mx.onError(e);_11&&_11();}},this);}else{_14();}},openSelectForm:function(){var _17=this;window.mx.data.getBacktrack(this._mxObject.getGuid(),this.constrainedBy,function(_18,_19){window.mx.ui.execute({form:_17.selectForm},{params:{selection:_17._mxObject.getReferences(_17._assoc),listViewSelectionMode:"multi",constraint:_19?_18+_17._constraint:"[0=1]"},callback:function(_1a){_1a.listen("save",function(_1b){var _1c=_5.find(_1a.getChildren(true),function(_1d){return "getSelected" in _1d;}),_1e=_1c.getSelected();_17._mxObject.set(_17._assoc,_1e);_17.renderObject();_17.onChange();_1b();});}});});},setValue:function(_1f){this._editNode.value=_1f;if(_1f){_4.text(this._readNode,_1f);}else{this._readNode.innerHTML="&nbsp;";}}});return _a;});