
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/InputReferenceSetSelector",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget.InputReferenceSetSelector");_1.declare("mxui.widget.InputReferenceSetSelector",[mxui.widget._WidgetBase,mxui.mixin._ValidationHelper],{attributePath:"",constraint:"",constrainedBy:null,selectForm:"",events:null,_mxObject:null,_readNode:null,_editNode:null,_selectButton:null,_subscription:null,_assoc:"",_entity:"",_attr:"",_constraint:"",postCreate:function(){var _4=this.attributePath.split("/");this.constrainedBy=this.constrainedBy||[];this._assoc=_4[1];this._entity=_4[2];this._attr=_4[3];},buildRendering:function(){var $=mxui.dom.create;var _5=this._readNode=$("label"),_6=this._editNode=$("input",{type:"text",readonly:"readonly","class":"form-control"});var _7=this._selectButton=new mxui.widget.Button({"class":"mx-referencesetselector-select-button",iconClass:"glyphicon glyphicon-share-alt"});this.connect(_7,"onClick","openSelectForm");this.connect(_6,"click","openSelectForm");this.domNode=$("div",{"class":"mx-referencesetselector"},_7.domNode,$("div",{"class":"mx-referencesetselector-input-wrapper"},this._editNode));},startup:function(){this.setupValidation(this._assoc);},onChange:function(){var ev=this.events&&this.events.change;ev&&this.validatedMicroflow(ev);},enable:function(){_1.place(this._selectButton.domNode,this.domNode,"first");this._readNode.parentNode.replaceChild(this._editNode,this._readNode);},disable:function(){this.domNode.removeChild(this._selectButton.domNode);this._editNode.parentNode.replaceChild(this._readNode,this._editNode);},checkDisabled:function(){return (this.inherited(arguments)||!this._mxObject||this._mxObject.isReadonlyAttr(this._assoc));},update:function(_8,_9){this._mxObject=_8;this.setValidationObject(_8);var _a=function(_b){this.updateDisabled();this.renderObject(_b);};if(this._subscription){this.unsubscribe(this._subscription);}if(_8){this._constraint=this.constraint.replace("[%CurrentObject%]",_8.getGuid());this._subscription=this.subscribe({guid:_8.getGuid(),attr:this._assoc,callback:_1.hitch(this,_a,null)});}_a.call(this,_9);},renderObject:function(_c){var _d=this,_e=this._mxObject,_f=_e&&_e.get(this._assoc);var _10=function(val){_d.setValue(val||"");_c&&_c();};if(_f&&_f.length){mx.data.get({guids:_f,callback:function(_11){var _12=[];for(var i=0,_e;_e=_11[i];i++){_12.push(mx.parser.formatAttribute(_e,this._attr));}_10(_12.join(", "));},error:function(e){mx.onError(e);_c&&_c();}},this);}else{_10();}},openSelectForm:function(){mx.data.getBacktrack(this._mxObject.getGuid(),this.constrainedBy,function(_13,_14){mx.ui.execute({form:this.selectForm},{params:{selection:this._mxObject.get(this._assoc),selectable:"multi",constraint:_14?_13+this._constraint:"[0=1]"},callback:function(_15){_15.listen("save",_1.hitch(this,function(_16){var _17=_15.getReturnValue("selection");if(_17){this._mxObject.set(this._assoc,_17);this.renderObject();this.onChange();}else{logger.error(this.id+" form return value 'selection' does not exist");}_16();}));}},this);},function(e){mx.onError(e);},this);},setValue:function(_18){this._editNode.value=_18;if(_18){mxui.dom.text(this._readNode,_18);}else{this._readNode.innerHTML="&nbsp;";}}});});