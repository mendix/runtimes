
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/InputReferenceSetSelector",["mxui/widget/Button","mxui/widget/_WidgetBase","mxui/mixin/_ValidationHelper","mxui/dom","mendix/lang","mendix/logger","dojo/dom-construct","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var _a=_9([_2,_3],{declaredClass:"mxui.widget.InputReferenceSetSelector",attributePath:"",constraint:"",constrainedBy:null,selectForm:"",events:null,_mxObject:null,_readNode:null,_editNode:null,_selectButton:null,_subscription:null,_assoc:"",_entity:"",_attr:"",_constraint:"",postCreate:function(){var _b=this.attributePath.split("/");this.constrainedBy=this.constrainedBy||[];this._assoc=_b[1];this._entity=_b[2];this._attr=_b[3];},buildRendering:function(){var $=_4.create;var _c=this._readNode=$("label"),_d=this._editNode=$("input",{type:"text",readonly:"readonly","class":"form-control"});var _e=this._selectButton=new _1({"class":"mx-referencesetselector-select-button",iconClass:"glyphicon glyphicon-share-alt"});this.connect(_e,"onClick","openSelectForm");this.connect(_d,"click","openSelectForm");this.domNode=$("div",{"class":"mx-referencesetselector"},_e.domNode,$("div",{"class":"mx-referencesetselector-input-wrapper"},this._editNode));},startup:function(){this.setupValidation(this._assoc);},onChange:function(){var ev=this.events&&this.events.change;ev&&this.validatedMicroflow(ev);},enable:function(){_7.place(this._selectButton.domNode,this.domNode,"first");this._readNode.parentNode.replaceChild(this._editNode,this._readNode);},disable:function(){this.domNode.removeChild(this._selectButton.domNode);this._editNode.parentNode.replaceChild(this._readNode,this._editNode);},checkDisabled:function(){return (this.inherited(arguments)||!this._mxObject||this._mxObject.isReadonlyAttr(this._assoc));},update:function(_f,_10){this._mxObject=_f;this.setValidationObject(_f);var _11=function(_12){this.updateDisabled();this.renderObject(_12);};if(this._subscription){this.unsubscribe(this._subscription);}if(_f){this._constraint=this.constraint.replace("[%CurrentObject%]",_f.getGuid());this._subscription=this.subscribe({guid:_f.getGuid(),attr:this._assoc,callback:_8.hitch(this,_11,null)});}_11.call(this,_10);},renderObject:function(_13){var _14=this,obj=this._mxObject,_15=obj&&obj.get(this._assoc);var _16=function(val){_14.setValue(val||"");_13&&_13();};if(_15&&_15.length){window.mx.data.get({guids:_15,callback:function(_17){var _18=[];for(var i=0,obj;obj=_17[i];i++){_18.push(window.mx.parser.formatAttribute(obj,this._attr));}_16(_18.join(", "));},error:function(e){window.mx.onError(e);_13&&_13();}},this);}else{_16();}},openSelectForm:function(){var _19=this;window.mx.data.getBacktrack(this._mxObject.getGuid(),this.constrainedBy,function(_1a,_1b){window.mx.ui.execute({form:_19.selectForm},{params:{selection:_19._mxObject.getReferences(_19._assoc),selectable:"multi",constraint:_1b?_1a+_19._constraint:"[0=1]"},callback:function(_1c){_1c.listen("save",function(_1d){var _1e=_5.find(_1c.getChildren(true),function(_1f){return "getSelected" in _1f;}),_20=_1e.getSelected();_19._mxObject.set(_19._assoc,_20);_19.renderObject();_19.onChange();_1d();});}});});},setValue:function(_21){this._editNode.value=_21;if(_21){_4.text(this._readNode,_21);}else{this._readNode.innerHTML="&nbsp;";}}});return _a;});