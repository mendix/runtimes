/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/SelectBox",["mxui/widget/_Button","mxui/wm/focus","mxui/dom","dojo/dom-construct","dojo/dom-geometry","dojo/dom-class","dojo/dom-style","dojo/on","dojo/window","dojo/keys","dojo/_base/array","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var $=_3.create;var _e=_d(_1,{declaredClass:"mxui.widget.SelectBox",caption:"Select item",items:null,_dropDown:null,_isVisible:false,_docMouseDown:null,_focusBox:null,buildRendering:function(){this.inherited(arguments);_4.place($("div",{"class":"mx-selectbox-caret-wrapper"},$("span",{"class":"caret"})),this.domNode,"first");this.domNode.setAttribute("class","form-control mx-selectbox");this.connect(this.domNode,"keydown","_buttonKeyDown");this.connect(this.domNode,"mouseup","_toggleDropDown");this.connect(this.mxform,"onBeforeHide","_hideDropDown");this._createDropDown();},_buttonKeyDown:function(e){if(e.keyCode===_a.DOWN_ARROW){this._showDropDown();e.preventDefault();}},_toggleDropDown:function(){if(this._isVisible){this._hideDropDown();}else{this._showDropDown();}},_showDropDown:function(){if(this._isVisible){return;}this._isVisible=true;var _f=_5.position(this.domNode),_10={top:_f.y+_f.h+"px"};if(window.mx.ui.isRtl()){_10.right=_9.getBox().w-_f.x-_f.w+"px";}else{_10.left=_f.x+"px";}_7.set(this._dropDown,_10);document.body.appendChild(this._dropDown);this._docMouseDown=this.connect(document,"mousedown",function(e){if(e.target!=this.domNode){this._hideDropDown();}});_2.put(this._dropDown.firstChild);},_hideDropDown:function(){if(!this._isVisible){return;}this._isVisible=false;this._docMouseDown.remove();_3.orphan(this._dropDown);},_createDropDown:function(){var _11=$("ul",{"class":"mx-dropdown dropdown-menu"}),_12=this;this.own(_8(_11,_8.selector("li","click"),function(e){_12._selectItem(this);}));this.connect(_11,"mousedown",function(e){e.stopPropagation();});this._dropDown=_11;_11.style.display="block";},_selectItem:function(_13){var _14=this.items[_3.data(_13,"index")];_14.checkbox.checked=_14.selected=!_14.selected;_6.toggle(_13,"selected");_2.put(_13);this.set("caption",this._getCaption());},_getCaption:function(){var _15=[];_b.forEach(this.items,function(_16){if(_16.checkbox.checked){_15.push(_16.caption);}});if(_15.length===0){return "";}else{if(_15.length==1){return _15[0];}else{return this.translate("itemsSelected",[_15.length]);}}},_setItemsAttr:function(_17){this.items=_17;_4.empty(this._dropDown);if(this._focusBox){this._focusBox.destroy();}this._focusBox=_2.addBox(this._dropDown);this._focusBox.pressed({DOWN_ARROW:this._focusBox.FOCUS_NEXT,UP_ARROW:this._focusBox.FOCUS_PREV,ESCAPE:_c.hitch(this,function(e){this._hideDropDown();_2.put(this.domNode);}),SPACE:_c.hitch(this,function(e){if(e.target.nodeName!="INPUT"){this._selectItem(e.target);}}),ENTER:_c.hitch(this,function(e){this._hideDropDown();_2.put(this.domNode);})});_b.forEach(this.items,function(_18,_19){var _1a=_18.checkbox=$("input",{type:"checkbox"}),_1b=$("li",{tabIndex:-1},_1a," ",$("label",_18.caption));if(_18.selected){_1a.checked=true;_6.add(_1b,"selected");}_3.data(_1b,"index",_19);this._focusBox.add(_1b);this._dropDown.appendChild(_1b);},this);this.set("caption",this._getCaption());},_getValueAttr:function(){var _1c=[];_b.forEach(this.items,function(_1d){if(_1d.checkbox.checked){_1c.push(_1d.value);}});return _1c;},_setValueAttr:function(_1e){if(typeof _1e=="string"){_1e=[_1e];}_b.forEach(this.items,function(_1f){_1f.checkbox.checked=_b.indexOf(_1e,_1f.value)>=0;});this.set("caption",this._getCaption());},uninitialize:function(){this._hideDropDown();_b.forEach(this._dropDown.children,function(_20){_3.data(_20,null);});if(this._focusBox){this._focusBox.destroy();}}});return _e;});