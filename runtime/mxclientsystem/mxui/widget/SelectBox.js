/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/widget/SelectBox",["mxui/widget/_WidgetBase","mxui/wm/focus","mxui/dom","dojo/dom-construct","dojo/dom-geometry","dojo/dom-class","dojo/dom-style","dojo/on","dojo/window","dojo/keys","dojo/_base/array","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){var $=_3.create;var _e=_d(_1,{declaredClass:"mxui.widget.SelectBox",items:null,_dropDown:null,_isVisible:false,_docMouseDown:null,_focusBox:null,_textNode:null,buildRendering:function(){this._textNode=document.createTextNode("");this.domNode=$("button",{"type":"button","class":"form-control mx-selectbox"},$("div",{"class":"mx-selectbox-caret-wrapper"},$("span",{"class":"caret"})),this._textNode);this.connect(this.domNode,"keydown","_buttonKeyDown");this.connect(this.domNode,"mouseup","_toggleDropDown");this.connect(this.mxform,"onBeforeHide","_hideDropDown");this._createDropDown();},_buttonKeyDown:function(e){if(e.keyCode===_a.DOWN_ARROW){this._showDropDown();e.preventDefault();}},_toggleDropDown:function(){if(this._isVisible){this._hideDropDown();}else{this._showDropDown();}},_showDropDown:function(){if(this._isVisible){return;}this._isVisible=true;var _f=_5.position(this.domNode),_10={top:_f.y+_f.h+"px"};if(window.mx.ui.isRtl()){_10.right=_9.getBox().w-_f.x-_f.w+"px";}else{_10.left=_f.x+"px";}_7.set(this._dropDown,_10);document.body.appendChild(this._dropDown);this._docMouseDown=this.connect(document,"mousedown",function(e){if(e.target!=this.domNode){this._hideDropDown();}});_2.put(this._dropDown.firstChild);},_hideDropDown:function(){if(!this._isVisible){return;}this._isVisible=false;this._docMouseDown.remove();_3.orphan(this._dropDown);},_createDropDown:function(){var _11=$("ul",{"class":"mx-dropdown dropdown-menu"}),_12=this;this.own(_8(_11,_8.selector("li","click"),function(e){_12._selectItem(this);}));this.connect(_11,"mousedown",function(e){e.stopPropagation();});this._dropDown=_11;_11.style.display="block";},_selectItem:function(_13){var _14=this.items[_3.data(_13,"index")];_14.checkbox.checked=_14.selected=!_14.selected;_6.toggle(_13,"selected");_2.put(_13);this._updateCaption();},_setItemsAttr:function(_15){this.items=_15;_4.empty(this._dropDown);if(this._focusBox){this._focusBox.destroy();}this._focusBox=_2.addBox(this._dropDown);this._focusBox.pressed({DOWN_ARROW:this._focusBox.FOCUS_NEXT,UP_ARROW:this._focusBox.FOCUS_PREV,ESCAPE:_c.hitch(this,function(e){this._hideDropDown();_2.put(this.domNode);}),SPACE:_c.hitch(this,function(e){if(e.target.nodeName!="INPUT"){this._selectItem(e.target);}}),ENTER:_c.hitch(this,function(e){this._hideDropDown();_2.put(this.domNode);})});_b.forEach(this.items,function(_16,_17){var _18=_16.checkbox=$("input",{type:"checkbox"}),_19=$("li",{tabIndex:-1},_18," ",$("label",_16.caption));if(_16.selected){_18.checked=true;_6.add(_19,"selected");}_3.data(_19,"index",_17);this._focusBox.add(_19);this._dropDown.appendChild(_19);},this);this._updateCaption();},_getValueAttr:function(){var _1a=[];_b.forEach(this.items,function(_1b){if(_1b.checkbox.checked){_1a.push(_1b.value);}});return _1a;},_setValueAttr:function(_1c){if(typeof _1c=="string"){_1c=[_1c];}_b.forEach(this.items,function(_1d){_1d.checkbox.checked=_b.indexOf(_1c,_1d.value)>=0;});this._updateCaption();},_updateCaption:function(){var _1e=[],_1f;_b.forEach(this.items,function(_20){if(_20.checkbox.checked){_1e.push(_20.caption);}});if(_1e.length===0){_1f="";}else{if(_1e.length===1){_1f=_1e[0];}else{_1f=this.translate("itemsSelected",[_1e.length]);}}this._textNode.nodeValue=_1f;},uninitialize:function(){this._hideDropDown();_b.forEach(this._dropDown.children,function(_21){_3.data(_21,null);});if(this._focusBox){this._focusBox.destroy();}}});return _e;});