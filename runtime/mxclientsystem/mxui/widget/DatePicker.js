
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/DatePicker",["dojo","dijit","dojox"],function(_1,_2,_3){_1.provide("mxui.widget.DatePicker");_1.declare("mxui.widget.DatePicker",mxui.widget._WidgetBase,{placeholder:"",selector:"date",format:"",_value:"",_native:false,_params:null,_calendar:null,_rescon:null,_leavecon:null,_blurcon:null,_foccon:null,_capture:null,_chgcon:null,_inputPos:null,_inputNode:null,_inputPane:null,_calButton:null,_calUpdateOn:true,buildRendering:function(){var $=mxui.dom.create,_4=":)",_5=this.selector=="datetime"?"datetime-local":this.selector,_6=mx.ui.getProfile()==="desktop",_7;var _8=this._inputPane=$("div",{"class":"mx-dateinput-input-wrapper"},_7=this._inputNode=$("input",{"class":"form-control mx-dateinput-input",type:_5,value:_4,placeholder:this._getPlaceholder()}));this.domNode=$("div",{"class":"mx-dateinput"},_8);this._native=!_6&&_7.type===_5&&_7.value!==_4;_7.value="";this._params={selector:this.selector=="custom"?"date":this.selector,datePattern:this.format};if(this._native){this._params=this._getNativeParseOpts();}else{_7.type="text";if(this._formatContainsDate()){this._calButton=new mxui.widget.Button({"class":"mx-dateinput-select-button",iconClass:"glyphicon glyphicon-calendar"});_1.setAttr(this._calButton.domNode,"tabindex","-1");_1.place(this._calButton.domNode,_8,"before");}}},startup:function(){this.inherited(arguments);var _9=this._inputNode;this._connectChangeEvent();this._blurcon=this.connect(_9,"blur","onBlur");this._foccon=this.connect(_9,"focus","onFocus");this.connect(_9,"keyup","onKeyUp");if(this._calButton){this.connect(this._calButton,"onClick","_handleButtonClicked");this.connect(_9,"keyup","_handleInputKey");}},enable:function(){if(this._calButton){this._calButton.set("disabled",false);}_1.removeAttr(this._inputNode,"disabled");},disable:function(){if(this._calButton){this._calButton.set("disabled",true);}_1.setAttr(this._inputNode,"disabled","disabled");},focus:function(){_2.focus(this._inputNode);},onChange:function(){},onKeyUp:function(e){},onFocus:function(e){},onBlur:function(e){},uninitialize:function(){if(this._calendar){this._calendar.destroy();}if(this._capture){this._capture.remove();}},_formatContainsDate:function(){return (this.selector=="date"||this.selector=="datetime"||(this.selector=="custom"&&this.format.indexOf("d")!=-1&&this.format.indexOf("M")!=-1&&this.format.indexOf("y")!=-1));},_connectChangeEvent:function(){if(this._native){this._chgcon=this.connect(this._inputNode,"blur",function(){if(this._inputNode.value!=this._value){this.onChange();}});}else{this._chgcon=this.connect(this._inputNode,"change","onChange");}},_disconnectEvents:function(_a){for(var i=0,_b;_b=_a[i];++i){if(this[_b]){this.disconnect(this[_b]);this[_b]=null;}}},_showCalendar:function(){var _c=this._calendar;if(!this._isCalendarVisible()){if(!_c){_c=this._calendar=new _2.Calendar(_1.mixin({datePackage:mx.ui.getDatePackage(),onChange:_1.hitch(this,"_handleCalendarChange"),onKeyDown:_1.hitch(this,"_handleCalendarKey")},this._calendarPatch));_c.domNode.style.position="absolute";_1.body().appendChild(_c.domNode);}var _d=this.get("value");if(_d===""){_d=new Date();}this._setCalendarValue(_d);_c.domNode.style.display="block";this._rescon=this.connect(this.mxform,"resize","_handleResizeWindow");this._capture=mxui.dom.capture(_1.body(),"mousedown",_1.hitch(this,"_handleBodyClicked"));}this._handleResizeWindow();this._disconnectEvents(["_chgcon","_leavecon","_blurcon"]);_c.focus();setTimeout(_1.hitch(this,function(){this._connectChangeEvent();this._leavecon=this.connect(this._inputNode,"blur","_handleInputBlur");this._blurcon=this.connect(this._inputNode,"blur","onBlur");}),0);},_hideCalendar:function(){if(this._isCalendarVisible()){var _e=this._calendar.domNode;this._calendar.domNode.style.display="none";this._inputPos=null;this._disconnectEvents(["_rescon","_leavecon"]);this._capture.remove();this._capture=null;}this._disconnectEvents(["_foccon"]);this.focus();setTimeout(_1.hitch(this,function(){this._foccon=this.connect(this._inputNode,"focus","onFocus");}),0);},_handleCalendarChange:function(_f){if(!this._calUpdateOn){return;}if(_f.toGregorian){_f=_f.toGregorian();}this.set("value",this._mergeDates(_f));this._hideCalendar();this.onChange();},_handleInputKey:function(e){if(e.keyCode===_1.keys.DOWN_ARROW){this._showCalendar();}else{if(e.keyCode==_1.keys.ENTER){this._hideCalendar();}else{var _10=this.get("value");if(_10&&this._isCalendarVisible()){this._setCalendarValue(_10);}}}},_handleInputBlur:function(e){this._hideCalendar();},_handleBodyClicked:function(e){var _11=function(e,_12){var pos=_1.position(_12.domNode);return (e.clientX>=pos.x&&e.clientX<pos.x+pos.w&&e.clientY>=pos.y&&e.clientY<pos.y+pos.h);};var _13=[this,this._calendar,this._calendar.monthWidget,this._calendar.monthWidget.dropDown];if(e){for(var i=0,w;w=_13[i];++i){if(_11(e,w)){return;}}}this._hideCalendar();this.onBlur();},_handleButtonClicked:function(e){if(this._isCalendarVisible()){this._hideCalendar();}else{this._showCalendar();}},_handleCalendarKey:function(e){if(e.keyCode==_1.keys.ESCAPE||e.keyCode==_1.keys.TAB){this._hideCalendar();}},_handleResizeWindow:function(){var box=_1.position(this._inputNode,true),pos={x:box.x,y:box.y},_14=this._inputPos;if(!this.isLeftToRight()){pos.x+=box.w;}if(_14==null||pos.x!=_14.x||pos.y!=_14.y){var _15={left:pos.x+"px",top:pos.y+box.h+"px",zIndex:1000};if(!this.isLeftToRight()){var _16=_1.position(this._calendar.domNode,true);_15.left=pos.x-_16.w+"px";}_1.style(this._calendar.domNode,_15);this._inputPos=pos;}},_isCalendarVisible:function(){return this._calendar&&this._calendar.domNode.style.display!="none";},_setCalendarValue:function(_17){this._calUpdateOn=false;this._calendar.set("value",_17);this._calUpdateOn=true;},_getNativeParseOpts:function(){var _18;switch(this.selector){case "date":_18="yyyy-MM-dd";break;case "time":_18="HH:mm";break;case "datetime":_18="yyyy-MM-dd HH:mm";}return {selector:"date",datePattern:_18};},_getPlaceholder:function(){if(this.placeholder){return this.placeholder;}else{var _19=_1.i18n.getLocalization("dojo.cldr","gregorian",_1.locale),_1a;switch(this.selector){case "date":_1a=_19["dateFormat-short"];break;case "time":_1a=_19["timeFormat-short"];break;case "datetime":_1a=_19["dateFormat-short"]+" "+_19["timeFormat-short"];break;case "custom":_1a=this.format;}_1a=_1a.toLowerCase();return _1a.replace(/(\w)+/g,function(_1b,_1c){switch(_1c){case "y":return new Array(5).join(_1c);case "a":return _19["field-dayperiod"];default:return new Array(3).join(_1c);}});}},_mergeDates:function(_1d){var _1e=new Date(this._value===""?mx.parser.localizeEpoch(0):this._value);return mx.parser.mergeDates(_1e,_1d,this.selector);},_getValueAttr:function(){var _1f=this._inputNode.value;if(_1f===""){return "";}if(this._native){_1f=_1f.slice(0,16).replace("T"," ");}var _20=mx.parser.parseValue(_1f,"datetime",this._params);return _20?this._mergeDates(_20):null;},_setValueAttr:function(_21){var _22=mx.parser.formatValue(_21,"datetime",this._params);this._inputNode.value=this._native?_22.replace(" ","T"):_22;this._value=_21;},_calendarPatch:{_onDayMouseDown:function(e){var _23=e.target.parentNode;if(_23&&_23.dijitDateValue!=null&&!_1.hasClass(_23,"dijitCalendarDisabledDate")){this._currentNode=_23;}},_onDayClick:function(e){_1.stopEvent(e);for(var _24=e.target;_24&&(_24.dijitDateValue==null);_24=_24.parentNode){}if(_24&&!_1.hasClass(_24,"dijitCalendarDisabledDate")){this.set("value",_24.dijitDateValue);}},_patchDate:function(_25){if(_25!=null){_25=new this.dateClassObj(_25);_25.setHours(1,0,0,0);}return _25;}}});});