
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("mxui/widget/FormDatePicker",["dojo","dijit","dojox","dojo/require!mxui/widget/Tooltip,mxui/widget/Calendar,mxui/dom/builder"],function(_1,_2,_3){_1.provide("mxui.widget.FormDatePicker");_1.require("mxui.widget.Tooltip");_1.require("mxui.widget.Calendar");_1.require("mxui.dom.builder");mxui.widget.declare("mxui.widget.FormDatePicker",{mixins:[_2._TemplatedMixin,_2._Contained],inputargs:["name","dateFormat","format"],onvaluechange:"",onmouseclick:"",onfocusleave:"",obligatory:false,obligatorycause:"",domNode:null,inputNode:null,baseClass:"mendixFormDatePicker",templateString:_1.cache("mxui.widget","templates/FormDatePicker.html","<div class=\"${baseClass}\">\n\t<div class=\"${baseClass}_buttonPick\" dojoAttachPoint=\"iconNode\">\n        <span class=\"${baseClass}_buttonTextIcon\">&#9658;</span>\n    </div>\n    <div class=\"${baseClass}_inputPane\" dojoAttachPoint=\"dateNode\">\n\t\t<input type=\"text\" class=\"${baseClass}_dateInput form-control\" dojoAttachPoint=\"inputNode\" />\n\t</div>\n</div>\n"),noValidation:false,trigger:"",readOnly:false,datePicker:null,dropDown:null,hoverState:false,viewState:false,justPicked:false,keyEvents:null,blurEvent:null,isRtl:null,hasDate:false,dateParams:null,postCreate:function(){this.keyEvents=[];this.domNode.name=this.name;if(!this.dateFormat){this.dateFormat="date";}else{this.dateFormat=this.dateFormat.toLowerCase();}this.dateParams={selector:this.dateFormat=="custom"?"date":this.dateFormat,datePattern:this.format};this.hasDate=(/date/.test(this.dateFormat)||this.dateFormat=="custom"&&/[dMy]/.test(this.format));if(this.hasDate){this.connect(this.iconNode,"onclick","onIconClick");}else{this.iconNode.parentNode.removeChild(this.iconNode);}this.isRtl=!this.isLeftToRight();this.connect(this.inputNode,"onfocus","onInputFocus");this.connect(this.inputNode,"onblur","onInputBlur");this.set("disabled",this.isInactive);this.loaded();},onInputClick:function(e){if(!this.isInactive&&!this.viewState){this.showDatePicker();}},onIconClick:function(e){this.showDatePicker();},onInputFocus:function(e){this.inputNode.focused=true;this.justClicked=false;},onInputBlur:function(e){if(!this.hoverState){if(!this.isInactive&&this.viewState){this.hideDatePicker();}this.justClicked=false;}else{this.justClicked=true;setTimeout(_1.hitch(this,function(){this.inputNode.focus();}),0);}},onBodyMouseDown:function(e){if(this.isMouseOut(e)){this.hoverState=false;this.onInputBlur();}},isMouseOut:function(e){var _4=_1.position(this.inputNode);var _5=_1.position(this.dropDown);return (e.clientX<_4.x||e.clientX>_4.x+_4.w||e.clientY<_4.y||e.clientY>_4.y+_4.h)&&(e.clientX<_5.x||e.clientX>_5.x+_5.w||e.clientY<_5.y||e.clientY>_5.y+_5.h);},onInputKeyDown:function(e){if(e.keyCode==9&&this.viewState&&!this.isInactive){this.hideDatePicker();}},onInputKeyUp:function(e){switch(e.keyCode){case 27:if(this.viewState){this.hideDatePicker();}break;case 40:if(!this.viewState){this.showDatePicker();}break;default:var _6=this.get("value");if(this.datePicker&&_6){this.datePicker.set("value",_6);}}},showDatePicker:function(){if(!this.datePicker){var _7=null;var _8=this.domNode.parentNode;while(!_7&&_8&&_8!=document){_7=parseInt(_1.style(_8,"zIndex"),10);_8=_8.parentNode;}this.dropDown=mxui.dom.div({"style":"position: absolute; display: none","id":this.id+"_lolipop"});this.bgIframe=new _2.BackgroundIframe(this.dropDown);if(_7){_1.style(this.dropDown,"zIndex",_7);}this.datePicker=new mxui.widget.Calendar({lang:_1.locale.toLowerCase(),onValueSelected:_1.hitch(this,this.handlerDatePicked),constraints:{selector:"date"},datePackage:/th$/i.test(_1.locale)?"dojox.date.buddhist":"dojo.date"});this.dropDown.appendChild(this.datePicker.domNode);document.body.appendChild(this.dropDown);this.dropDown.onmouseover=_1.hitch(this,function(e){this.hoverState=true;});this.dropDown.onmouseout=_1.hitch(this,function(e){this.hoverState=false;});}var _9=this.get("value");_9=(_9==null||_9==="")?+new Date():_9;this.datePicker.set("value",_9);var _a=_1.position(this.inputNode,true);this.dropDown.style.display="";var _b={l:this.isRtl?_a.x+_a.w-_1.marginBox(this.dropDown).w:_a.x,t:_a.y+_a.h};_1.marginBox(this.dropDown,_b);this.viewState=true;this.blurEvent=this.connect(document.body,"onmousedown","onBodyMouseDown");},hideDatePicker:function(){this.dropDown.style.display="none";this.hoverState=false;this.viewState=false;this.blurEvent=this.disconnect(this.blurEvent);},_setDisabledAttr:function(_c){this.isInactive=(/true/.test(_c));var _d=this.iconNode.parentNode;if(this.isInactive){_1.addClass(this.domNode,this.baseClass+"Disabled");this.inputNode.setAttribute("readonly","readonly");var _e;while(_e=this.keyEvents.pop()){this.disconnect(_e);}if(this.hasDate){_d&&_d.removeChild(this.iconNode);}}else{_1.removeClass(this.domNode,this.baseClass+"Disabled");this.inputNode.removeAttribute("readonly");var _f=this.keyEvents,_10=this.inputNode;if(!_f.length){_f.push(this.connect(_10,"onkeydown","onInputKeyDown"));_f.push(this.connect(_10,"onkeyup","onInputKeyUp"));_f.push(this.connect(_10,"onchange","onChange"));}if(this.hasDate){this.domNode.insertBefore(this.iconNode,this.dateNode);}}},setDatePart:function(_11,_12){_11.setFullYear(_12.getFullYear());_11.setMonth(_12.getMonth());_11.setDate(_12.getDate());},setTimePart:function(_13,_14){_13.setHours(_14.getHours());_13.setMinutes(_14.getMinutes());_13.setSeconds(_14.getSeconds());_13.setMilliseconds(_14.getMilliseconds());},mergeDates:function(_15,_16){switch(this.dateFormat){case "date":this.setDatePart(_15,_16);break;case "time":this.setTimePart(_15,_16);break;case "datetime":case "custom":_15=_16;}return +_15;},_setValueAttr:function(_17){if(_17===null||_17===""){this.inputNode.value="";}else{if(_17 instanceof Date){var _18=mx.parser.formatDate(_17.getTime(),this.dateParams);this.inputNode.value=_18;}else{var nr=Number(_17);if(!isNaN(nr)){this.set("value",new Date(nr));}}}this._value=_17||_17===0?_17:undefined;},_getValueAttr:function(){var _19=this.inputNode.value;if(_19===""){return "";}var _1a=new Date(this._value!==undefined?this._value:mx.parser.localizeEpoch(0)),_1b=mx.parser.parseDate(_19,this.dateParams);if(_1b!=null){return this.mergeDates(_1a,new Date(_1b));}else{return null;}},validate:function(e){var _1c=this.inputNode.value;if(!_1c){mxui.widget.hideTooltip(this._table);return;}if(_1c.match(/^\d+[\/\-]\d+[\/\-]\d+$/)!=null){var _1d=mx.parser.parseDate(_1c,this.dateParams);if(isNaN(_1d)){this.showValidationMsg();}else{this.inputNode.value=mx.parser.formatDate(_1d,this.dateParams);mxui.widget.hideTooltip(this._table);}}else{this.showValidationMsg();}},showValidationMsg:function(){mxui.widget.showTooltip(mx.ui.translate("mendix.lib.Validations","invalid_date"),this._table);setTimeout(_1.hitch(this,function(){this.inputNode.focus();}),1);},onChange:function(){},handlerDatePicked:function(_1e){if(_1e!=null){var _1f=new Date(this._value!==undefined?this._value:mx.parser.localizeEpoch(0));this.set("value",this.mergeDates(_1f,new Date(_1e)));this.onChange();}try{if(this.trigger!=""){this.trigger(_1e);}}catch(e){}this.hideDatePicker();this.justClicked=true;this.inputNode.focus();},uninitialize:function(){if(this.dropDown){document.body.removeChild(this.dropDown);this.dropDown=null;}if(this.datePicker){this.datePicker.destroyRecursive();this.datePicker=null;}try{mxui.widget.hideTooltip(this._table);}catch(e){}this.bgIframe&&this.bgIframe.destroy();},getInvalidCause:function(){return mx.ui.translate("mendix.lib.Validations","invalid_date");}});});