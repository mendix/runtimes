/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/wm/_FocusBox",["mxui/dom","mxui/wm/_FocusStack","mxui/wm/focus","mendix/lang","dojo/keys","dojo/_base/connect","dojo/_base/event","dojo/_base/lang","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var _a={getFocusStack:function(){var _b=_2.create();_b.box=this;var _c=null;var _d=null;var _e=false;var _f=this.nodes;for(var i=0,l=_f.length;i<l;i++){var _10=_f[i].node;var tab=_3.getFocusIndex(_10);var vi=_3.focusable(_10);if(tab){if(vi){_c=_10;break;}else{_e=true;_10.tabIndex=-1;}}else{if(vi){if(_e){_c=_10;_c.tabIndex=1;break;}_d=_10;}}}if(!_c){_c=_d;_c&&(_c.tabIndex=1);}if(_c){_b.push(_c);_b.last=_b.first=_b._curr={prev:null,next:null,node:_c,stack:_b};}return _b;},_onmousedown:function(e){var _11=e.target;if(_11.nodeName.toLowerCase()=="option"){_11=_11.parentNode;}var _12=_11;var s=null;var _13=this.domNode;do{s=_1.data(_12,"box-node");if(s&&s.box==this){break;}}while((_12!=null)&&(_12!=_13)&&(_12=_12.parentNode)!=null);if(s){var _14=_1.getTabIndex(_11);this._focus(s.node,_14!=null);}},_focus:function(_15,_16){var _17=this.getFocusStack();var _18=_17._curr;if(_18){_18.node.tabIndex=-1;}_15.tabIndex=1;_15=_3._tryNode({node:_15,stack:_17},"next");if(!_16){_3.put(_15);}},next:function(_19,dir){var _1a=_1.data(_19,"box-node");if(_1a){var _1b=this._getNextNode(_1a,dir);if(_1b){var _1c=_1b.node;_1c.tabIndex=0;_19.tabIndex=-1;return _1c;}}else{}return null;},_getNextNode:function(_1d,dir){if(!_1d){return null;}var _1e=_1d;while((_1e=_1e[dir])!=null){var _1f=_1e.node;if(_3.focusable(_1f)){return _1e;}}return null;}};var _20=_9(null,{declaredClass:"mxui.wm.focus.Box",id:null,domNode:null,nested:false,FOCUS_NEXT:"FOCUS_NEXT",FOCUS_PREV:"FOCUS_PREV",constructor:function(_21){this.id=_4.getUniqueId();this.domNode=_21;this.nodes=[];this.keys={};this.handlers={};_21.setAttribute("focus-id",this.id);},add:function(_22){var s=_1.data(_22,"box-node",{box:this,next:null,prev:null,node:_22});var _23=this.nodes.length;if(_23!=0){var _24=this.nodes[_23-1];s.prev=_24;_24.next=s;_22.tabIndex=-1;}else{_22.tabIndex=0;}if(!this.converted){this.converted=true;_8.mixin(this,_a);this._boxhandler=_6.connect(this.domNode,"onmousedown",_8.hitch(this,"_onmousedown"));}this.nodes.push(s);},pressed:function(_25,_26){var _27=this.keys;var hs=this.handlers;for(var key in _25){var _28=_5[key]||key;var fnc=_25[key];if(fnc==this.FOCUS_NEXT){_27[_28]="next";}else{if(fnc==this.FOCUS_PREV){_27[_28]="prev";}else{if(typeof fnc=="string"){fnc=_26[fnc];}if(typeof fnc!="function"){logger.error(this.id+".pressed: Passed stuff is not a function: "+key);}else{if(hs[_28]){}hs[_28]=[_26,fnc];}}}}},destroy:function(){if(!this._destroyed){var _29=this.nodes;for(var i=0,l=_29.length;i<l;i++){var _2a=_29[i].node;_1.data(_2a,"box-node",null);}this.nodes=null;this.keys=null;this.handlers=null;this._boxhandler&&this._boxhandler.remove();this._destroyed=true;}},getHandler:function(e){var _2b=typeof (e.charOrCode)!="undefined"?e.charOrCode:e.keyCode;return this.handlers[(_2b==" ")?_5.SPACE:_2b];},getFocusDirection:function(e){var nav=this.domNode.getAttribute("focuskeys");if(nav){var up,lr;if(nav=="up-down"){if(e.keyCode==_5.UP_ARROW){up="prev";}else{if(e.keyCode==_5.DOWN_ARROW){up="next";}}}if(nav=="left-right"){if(e.keyCode==_5.LEFT_ARROW){lr="prev";}else{if(e.keyCode==_5.RIGHT_ARROW){lr="next";}}}return up||lr;}else{var _2c=typeof (e.charOrCode)!="undefined"?e.charOrCode:e.keyCode;_2c=(_2c==" ")?_5.SPACE:_2c;var key=this.keys[_2c];if(key){return key;}}return null;},onFocusPress:function(e,_2d){var dir=this.getFocusDirection(e);if(e.altKey||e.shiftKey||e.ctrlKey){return true;}if(dir){var _2e=_1.data(_2d,"box-node");if(_2e){var _2f=this.next(_2d,dir);if(_2f){_3.put(_2f);return false;}_7.stop(e);}else{}}else{var h=this.getHandler(e);if(h){try{return h[1].call(h[0],e,_2d);}catch(error){logger.error(this.id+".onFocusPress: Error when executing handler: "+error.message);return true;}}}return true;},next:function(_30,dir){var _31=_3._getStack(_30,this);var _32=_3._doNext(_31.find(_30),dir);return _32;}});return _20;});