/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/wm/focus",["mxui/wm/_FocusBox","mxui/wm/_FocusStack","mxui/dom","dojo/keys","dojo/_base/connect","dojo/has","dojo/aspect","dojo/ready","dojo/dom-class","dojo/_base/event","dojo/_base/lang","dojo/_base/declare","dijit/focus","dijit/_base/focus","dijit/registry","exports"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){_10.getFocusIndex=function(_11){var _12=_3.getTabIndex(_11);return _12>=0?_12:null;};_10.name="mxui.wm.focus";_10.state={};_10.registry={};_10.start=function(){if(this._started){return;}this._started=true;_5.connect(window.document,"onkeypress",_b.hitch(this,"onkeypress"));_5.connect(window.document,"onkeydown",_b.hitch(this,"keydownpatch"));_7.after(_d,"_onFocusNode",_b.hitch(this,"onfocus"),true);_7.after(_d,"_onBlurNode",_b.hitch(this,"_onBlurNode"),true);_5.connect(document,"onmousedown",_b.hitch(this,"_onBlur"));var _13=this.state;this.timer_clear=function(){_13._timer=null;_13._shift=false;};};_10.get=function(){var f=_e.getFocus();return f.node&&!_3.isOrphan(f.node)?f.node:null;};_10.put=function(_14){if(!_14||_14.nodeType!=1){return false;}if(_6("ie")){try{document.selection.empty();}catch(e){}}setTimeout(function(){try{_14.focus();}catch(e){}var _15=_14.nodeName.toLowerCase();if((_15=="input"&&_14.type=="text")||_15=="textarea"){if(_14.select){_14.select();}}},0);};_10.restore=function(){var _16=_e.getFocus();if(_16.node){var _17=_16.node;var _18=this._getStack(_17);var _19=_18._curr;_17=_19?this._tryNode(_19,"next"):null;if(_17){this.put(_17);}}};_10.first=function(_1a){this.put(this._getFirst(_1a,"next"));};_10.next=function(_1b){this.put(this._getNextNode(_1b,false));};_10.blur=function(){var _1c=this.get();if(_1c){_1c.blur();}};_10._onBlur=function(e){this.state_clear();this._clickedNode=e.target;};_10._ontab=function(){this.timer_clear();var box=null;if(box){}else{this.state_clear();}};_10.onfocus=function(_1d){if(_6("ie")){if(!_3.getTabIndex(_1d)){return;}}if(_1d.nodeType!=1){return;}var _1e=this.state;_1e.active=_1d;if(_1e._timer){this._ontab(_1d);}else{_9.add(_1d,"mx-focus");}};_10._onBlurNode=function(_1f){_9.remove(_1f,"mx-focus");};_10.state_clear=function(){var _20=this.state;_20.node=null;_20.box=null;};_10.timer_clear=function(){};_10.next=function(){var _21=this.state;if(_21.active&&_21.active.nodeType==1){var _22=_21.active;var _23=this.byNode(_22);if(_23){var _24=this._getNextNode(_22);if(_24){this.put(_24);}else{}}}};_10.keydownpatch=function(e){if(e.keyCode==_4.UP_ARROW||e.keyCode==_4.DOWN_ARROW){var _25=this.state;this.onkeypress(e);_25._patch_inWork=true;setTimeout(function(){_25._patch_inWork=null;},10);}};_10.onkeypress=function(e){var _26=this.state;if(_26._patch_inWork){return;}var _27=e.shiftKey;var _28=e.target;if(e.keyCode===_4.TAB){if(_28.nodeName.toLowerCase()=="html"){if(this._clickedNode){_28=this._clickedNode;}else{return;}}var _29=this._getNextNode(_28,_27);if(_29){this.put(_29);}_a.stop(e);}else{var box=this.byNode(_28);if(box){var _2a=_28,nn=null;do{if(box.onFocusPress&&!box.onFocusPress(e,_2a)){_a.stop(e);break;}var _2b=box.domNode;_2a=_2b;nn=_2b.parentNode;}while(nn&&(box=this.byNode(nn))!=null);}}};_10._getStack=function(_2c,box){box=(box||this.byNode(_2c));if(box.getFocusStack){try{return box.getFocusStack(_2c);}catch(e){var _2d=_2.create();_2d.box=box;return _2d;}}return _2.buildStack(_2c,box);};_10._getFirst=function(_2e,dir,_2f){if(this.isBox(_2e)){var _30=_2f||this._getStack(_2e);if(_30.length===0){if(_10.getFocusIndex(_2e)){return _2e;}return null;}var _31=_30[dir=="next"?"first":"last"];return _31?this._tryNode(_31,dir):null;}return _2e;};_10._tryNode=function(_32,dir){var _33=_32.node;if(this.isBox(_33)){var _34=this._getFirst(_33,dir);if(_34){return _34;}else{return this._doNext(_32,dir);}}return _33;};_10._doNext=function(_35,dir){if(!_35){return null;}var _36=_35[dir];if(!_36){return null;}return this._tryNode(_36,dir);};_10._getNextNode=function(_37,_38){var box=null,_39=null,dir=!_38?"next":"prev";if(this.isBox(_37)){box=this.byNode(_37.parentNode);}else{box=this.byNode(_37);}if(!box){return null;}var _3a=this._getStack(_37,box),_3b=this._doNext(_3a.find(_37),dir);if(!_3b){_39=_3a.box.domNode;if(this.cyclic(_39)){return this._getFirst(_39,dir,_3a);}else{_3b=this._getNextNode(box.domNode,_38);if(!_3b){}}}return _3b;};_10.skip=function(_3c,_3d){if(_3c&&_3c.setAttribute){if(arguments.length==2){_3d=!!_3d;_3c.setAttribute("focusNoSkip",_3d);return _3d;}var _3e=/true/.test(_3c.getAttribute("focusNoSkip"));return _3e?!_3e:_3c.readOnly;}return true;};_10.focusable=function(_3f){if(!_3f||_3f.nodeType!=1||_3f.disabled||_10.skip(_3f)){return false;}var _40=_3f.style;if(_40.display=="none"||_40.visibility=="hidden"){return false;}if(_3f.offsetWidth===0&&_3f.offsetHeight===0){return 0;}return true;};_10.cyclic=function(_41,_42){if(_41&&_41.setAttribute){if(arguments.length==2){var s=/true/.test(_42);_41.setAttribute("focusCycle",s);return s;}return /true/.test(_41.getAttribute("focusCycle"));}return false;};_10.focusIndex=function(_43,_44){if(_43&&_43.getAttribute){if(arguments.length==2){_43.setAttribute("focusIndex",_44);return _44;}return _43.getAttribute("focusIndex");}return null;};_10.addBox=function(_45){var box=new _1(_45);this.register(box);return box;};_10.removeBox=function(_46){var box=this.byNode(_46);if(box){this.unregister(box);return true;}return false;};_10.isBox=function(_47){if(_47&&_47.getAttribute){var fi=this.focusIndex(_47);if(_f.byNode(_47)){return fi!=-2?true:false;}else{if(fi){return true;}}return !!(_47.getAttribute("focus-id"));}return false;};_10.byNode=function(_48){var fi,id,w;do{if(_48&&_48.getAttribute){fi=this.focusIndex(_48);if(fi==-2){continue;}w=_f.byNode(_48);if(w){return w;}id=_48.getAttribute("focus-id");if(id){return this.byId(id);}if(fi){return {domNode:_48};}}}while(_48&&(_48=_48.parentNode));return null;};_10.byId=function(_49){return this.registry[_49];};_10.register=function(box){var id=box.id;if(this.registry[id]){return false;}else{this.registry[id]=box;return true;}};_10.unregister=function(box){if(this.registry[box.id]){box.domNode.removeAttribute("focus-id");delete this.registry[box.id];box.destroy();}};_8(function(){_10.start();});});