/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/wm/focus",["mxui/wm/_FocusBox","mxui/wm/_FocusStack","mxui/dom","dojo/keys","dojo/_base/connect","dojo/has","dojo/aspect","dojo/ready","dojo/dom-class","dojo/_base/event","dojo/_base/lang","dojo/_base/declare","dijit/focus","dijit/_base/focus","dijit/registry","exports"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){_10.getFocusIndex=function(_11){var _12=_3.getTabIndex(_11);return _12>=0?_12:null;};_10.name="mxui.wm.focus";_10.state={};_10.registry={};_10.start=function(){if(this._started){return;}this._started=true;_5.connect(window.document,"onkeypress",_b.hitch(this,"onkeypress"));_5.connect(window.document,"onkeydown",_b.hitch(this,"keydownpatch"));_7.after(_d,"_onFocusNode",_b.hitch(this,"onfocus"),true);_7.after(_d,"_onBlurNode",_b.hitch(this,"_onBlurNode"),true);_5.connect(document,"onmousedown",_b.hitch(this,"_onBlur"));var _13=this.state;this.timer_clear=function(){_13._timer=null;_13._shift=false;};};_10.get=function(){var f=_e.getFocus();return f.node&&!_3.isOrphan(f.node)?f.node:null;};_10.put=function(_14){if(!_14||_14.nodeType!=1){return false;}if(_6("ie")){try{document.selection.empty();}catch(e){}}setTimeout(function(){try{_14.focus();}catch(e){}var _15=_14.nodeName.toLowerCase();if((_15=="input"&&_14.type=="text")||_15=="textarea"){if(_14.select){_14.select();}}},0);};_10.restore=function(){var _16=_e.getFocus();if(_16.node){var _17=_16.node;var _18=this._getStack(_17);var _19=_18._curr;_17=_19?this._tryNode(_19,"next"):null;if(_17){this.put(_17);}}};_10.first=function(_1a){this.put(this._getFirst(_1a,"next"));};_10.next=function(_1b){this.put(this._getNextNode(_1b,false));};_10.blur=function(){var _1c=this.get();if(_1c){_1c.blur();}};_10.getFirst=function(_1d){return this._getFirst(_1d,"next");};_10._onBlur=function(e){this.state_clear();this._clickedNode=e.target;};_10._ontab=function(){this.timer_clear();var box=null;if(box){}else{this.state_clear();}};_10.onfocus=function(_1e){if(_6("ie")){if(!_3.getTabIndex(_1e)){return;}}if(_1e.nodeType!=1){return;}var _1f=this.state;_1f.active=_1e;if(_1f._timer){this._ontab(_1e);}else{_9.add(_1e,"mx-focus");}};_10._onBlurNode=function(_20){_9.remove(_20,"mx-focus");};_10.state_clear=function(){var _21=this.state;_21.node=null;_21.box=null;};_10.timer_clear=function(){};_10.next=function(){var _22=this.state;if(_22.active&&_22.active.nodeType==1){var _23=_22.active;var _24=this.byNode(_23);if(_24){var _25=this._getNextNode(_23);if(_25){this.put(_25);}else{}}}};_10.keydownpatch=function(e){if(e.keyCode==_4.UP_ARROW||e.keyCode==_4.DOWN_ARROW){var _26=this.state;this.onkeypress(e);_26._patch_inWork=true;setTimeout(function(){_26._patch_inWork=null;},10);}};_10.onkeypress=function(e){var _27=this.state;if(_27._patch_inWork){return;}var _28=e.shiftKey;var _29=e.target;if(e.keyCode===_4.TAB){if(_29.nodeName.toLowerCase()=="html"){if(this._clickedNode){_29=this._clickedNode;}else{return;}}var _2a=this._getNextNode(_29,_28);if(_2a){this.put(_2a);}_a.stop(e);}else{var box=this.byNode(_29);if(box){var _2b=_29,nn=null;do{if(box.onFocusPress&&!box.onFocusPress(e,_2b)){_a.stop(e);break;}var _2c=box.domNode;_2b=_2c;nn=_2c.parentNode;}while(nn&&(box=this.byNode(nn))!=null);}}};_10._getStack=function(_2d,box){box=(box||this.byNode(_2d));if(box.getFocusStack){try{return box.getFocusStack(_2d);}catch(e){var _2e=_2.create();_2e.box=box;return _2e;}}return _2.buildStack(_2d,box);};_10._getFirst=function(_2f,dir,_30){if(this.isBox(_2f)){var _31=_30||this._getStack(_2f);if(_31.length===0){if(_10.getFocusIndex(_2f)){return _2f;}return null;}var _32=_31[dir=="next"?"first":"last"];return _32?this._tryNode(_32,dir):null;}return _2f;};_10._tryNode=function(_33,dir){var _34=_33.node;if(this.isBox(_34)){var _35=this._getFirst(_34,dir);if(_35){return _35;}else{return this._doNext(_33,dir);}}return _34;};_10._doNext=function(_36,dir){if(!_36){return null;}var _37=_36[dir];if(!_37){return null;}return this._tryNode(_37,dir);};_10._getNextNode=function(_38,_39){var box=null,_3a=null,dir=!_39?"next":"prev";if(this.isBox(_38)){box=this.byNode(_38.parentNode);}else{box=this.byNode(_38);}if(!box){return null;}var _3b=this._getStack(_38,box),_3c=this._doNext(_3b.find(_38),dir);if(!_3c){_3a=_3b.box.domNode;if(this.cyclic(_3a)){return this._getFirst(_3a,dir,_3b);}else{_3c=this._getNextNode(box.domNode,_39);if(!_3c){}}}return _3c;};_10.skip=function(_3d,_3e){if(_3d&&_3d.setAttribute){if(arguments.length==2){_3e=!!_3e;_3d.setAttribute("focusNoSkip",_3e);return _3e;}var _3f=/true/.test(_3d.getAttribute("focusNoSkip"));return _3f?!_3f:_3d.readOnly;}return true;};_10.focusable=function(_40){if(!_40||_40.nodeType!=1||_40.disabled||_10.skip(_40)){return false;}var _41=_40.style;if(_41.display=="none"||_41.visibility=="hidden"){return false;}if(_40.offsetWidth===0&&_40.offsetHeight===0){return 0;}return true;};_10.cyclic=function(_42,_43){if(_42&&_42.setAttribute){if(arguments.length==2){var s=/true/.test(_43);_42.setAttribute("focusCycle",s);return s;}return /true/.test(_42.getAttribute("focusCycle"));}return false;};_10.focusIndex=function(_44,_45){if(_44&&_44.getAttribute){if(arguments.length==2){_44.setAttribute("focusIndex",_45);return _45;}return _44.getAttribute("focusIndex");}return null;};_10.addBox=function(_46){var box=new _1(_46);this.register(box);return box;};_10.removeBox=function(_47){var box=this.byNode(_47);if(box){this.unregister(box);return true;}return false;};_10.isBox=function(_48){if(_48&&_48.getAttribute){var fi=this.focusIndex(_48);if(_f.byNode(_48)){return fi!=-2;}else{if(fi){return true;}}return !!(_48.getAttribute("focus-id"));}return false;};_10.byNode=function(_49){var fi,id,w;do{if(_49&&_49.getAttribute){fi=this.focusIndex(_49);if(fi==-2){continue;}w=_f.byNode(_49);if(w){return w;}id=_49.getAttribute("focus-id");if(id){return this.byId(id);}if(fi){return {domNode:_49};}}}while(_49&&(_49=_49.parentNode));return null;};_10.byId=function(_4a){return this.registry[_4a];};_10.register=function(box){var id=box.id;if(this.registry[id]){return false;}else{this.registry[id]=box;return true;}};_10.unregister=function(box){if(this.registry[box.id]){box.domNode.removeAttribute("focus-id");delete this.registry[box.id];box.destroy();}};_8(function(){_10.start();});});