/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/wm/focus",["mxui/wm/_FocusBox","mxui/wm/_FocusStack","mxui/dom","dojo/keys","dojo/_base/connect","dojo/has","dojo/aspect","dojo/ready","dojo/dom-class","dojo/_base/event","dojo/_base/lang","dojo/_base/declare","dijit/focus","dijit/_base/focus","dijit/registry","exports"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){_10.getFocusIndex=function(_11){var _12=_3.getTabIndex(_11);return _12>=0?_12:null;};_10.name="mxui.wm.focus";_10.state={};_10.registry={};_10.boxCounter={};_10.start=function(){if(this._started){return;}this._started=true;_5.connect(window.document,"onkeypress",_b.hitch(this,"onkeypress"));_5.connect(window.document,"onkeydown",_b.hitch(this,"keydownpatch"));_7.after(_d,"_onFocusNode",_b.hitch(this,"onfocus"),true);_7.after(_d,"_onBlurNode",_b.hitch(this,"_onBlurNode"),true);_5.connect(document,"onmousedown",_b.hitch(this,"_onBlur"));var _13=this.state;this.timer_clear=function(){_13._timer=null;_13._shift=false;};};_10.get=function(){var f=_e.getFocus();return f.node&&!_3.isOrphan(f.node)?f.node:null;};_10.put=function(_14){if(!_14||_14.nodeType!=1){return false;}if(_6("ie")){try{document.selection.empty();}catch(e){}}setTimeout(function(){try{_14.focus();}catch(e){}var _15=_14.nodeName.toLowerCase();if((_15=="input"&&_14.type=="text")||_15=="textarea"){_14.select&&_14.select();}},0);};_10.restore=function(){var _16=_e.getFocus();if(_16.node){var _17=_16.node;var _18=this._getStack(_17);var _19=_18._curr;_17=_19?this._tryNode(_19,"next"):null;if(_17){this.put(_17);}}};_10.first=function(_1a){this.put(this._getFirst(_1a,"next"));};_10.next=function(_1b){this.put(this._getNextNode(_1b,false));};_10.blur=function(){var _1c=this.get();if(_1c){_1c.blur();}};_10._onBlur=function(e){this.state_clear();this._clickedNode=e.target;};_10._ontab=function(){this.timer_clear();var box=null;if(box){}else{this.state_clear();}};_10.onfocus=function(_1d){if(_6("ie")){if(!_3.getTabIndex(_1d)){return;}}if(_1d.nodeType!=1){return;}var _1e=this.state;_1e.active=_1d;if(_1e._timer){this._ontab(_1d);}else{_9.add(_1d,"mx-focus");}};_10._onBlurNode=function(_1f){_9.remove(_1f,"mx-focus");};_10.state_clear=function(){var _20=this.state;_20.node=null;_20.box=null;};_10.timer_clear=function(){};_10.next=function(){var _21=this.state;if(_21.active&&_21.active.nodeType==1){var _22=_21.active;var _23=this.byNode(_22);if(_23){var _24=this._getNextNode(_22);if(_24){this.put(_24);}else{}return;}}};_10.keydownpatch=function(e){if(e.keyCode==_4.UP_ARROW||e.keyCode==_4.DOWN_ARROW){var _25=this.state;this.onkeypress(e);_25._patch_inWork=true;setTimeout(function(){_25._patch_inWork=null;},10);}};_10.onkeypress=function(e){var _26=this.state;if(_26._patch_inWork){return;}var _27=e.shiftKey;var tab=e.keyCode===_4.TAB;var _28=e.target;if(tab){if(_28.nodeName.toLowerCase()=="html"){if(this._clickedNode){_28=this._clickedNode;}else{return;}}var _29=this._getNextNode(_28,_27);if(_29){this.put(_29);}_a.stop(e);}else{var _2a=_28;var box=this.byNode(_28);if(box){do{var _2b=box.domNode;if(box.onFocusPress){if(!box.onFocusPress(e,_2a)){_a.stop(e);break;}}_2a=_2b;var nn=_2b.parentNode;}while(nn&&(box=this.byNode(nn))!=null);}}};_10._getStack=function(_2c,box){box=(box||this.byNode(_2c));if(box.getFocusStack){try{return box.getFocusStack(_2c);}catch(e){var _2d=_2.create();_2d.box=box;return _2d;}}return _2.buildStack(_2c,box);};_10._getFirst=function(_2e,dir,_2f){if(this.isBox(_2e)){var _2f=_2f||this._getStack(_2e);if(_2f.length==0){if(_10.getFocusIndex(_2e)){return _2e;}return null;}var _30=_2f[dir=="next"?"first":"last"];return _30?this._tryNode(_30,dir):null;}return _2e;};_10._tryNode=function(_31,dir){var _32=_31.node;if(this.isBox(_32)){var _33=this._getFirst(_32,dir);if(_33){return _33;}else{return this._doNext(_31,dir);}}else{return _32;}return null;};_10._doNext=function(_34,dir){if(!_34){return null;}var _35=_34[dir];if(!_35){return null;}return this._tryNode(_35,dir);};_10._getNextNode=function(_36,_37){var box=null;var _38=null;var dir=!_37?"next":"prev";if(this.isBox(_36)){box=this.byNode(_36.parentNode);}else{box=this.byNode(_36);}if(!box){return null;}var _39=this._getStack(_36,box);var _3a=this._doNext(_39.find(_36),dir);if(!_3a){_38=_39.box.domNode;if(this.cyclic(_38)){return this._getFirst(_38,dir,_39);}else{_3a=this._getNextNode(box.domNode,_37);if(!_3a){}}}return _3a;};_10.skip=function(_3b,_3c){if(_3b&&_3b.setAttribute){if(arguments.length==2){_3c=!!_3c;_3b.setAttribute("focusNoSkip",_3c);return _3c;}var _3d=/true/.test(_3b.getAttribute("focusNoSkip"));return _3d?!_3d:_3b.readOnly;}return true;};_10.focusable=function(_3e){if(!_3e||_3e.nodeType!=1){return false;}if(_3e.disabled){return false;}if(_10.skip(_3e)){return false;}var _3f=_3e.style;if(_3f.display=="none"||_3f.visibility=="hidden"){return false;}if(_3e.offsetWidth==0&&_3e.offsetHeight==0){return 0;}return true;};_10.cyclic=function(_40,_41){if(_40&&_40.setAttribute){if(arguments.length==2){var s=/true/.test(_41);_40.setAttribute("focusCycle",s);return s;}return /true/.test(_40.getAttribute("focusCycle"));}return false;};_10.focusIndex=function(_42,_43){if(_42&&_42.getAttribute){if(arguments.length==2){_42.setAttribute("focusIndex",_43);return _43;}return _42.getAttribute("focusIndex");}return null;};_10.addBox=function(_44){var box=new _1(_44);this.register(box);return box;};_10.removeBox=function(_45){var box=this.byNode(_45);if(box){this.unregister(box);return true;}return false;};_10.isBox=function(_46){if(_46&&_46.getAttribute){var fi=this.focusIndex(_46);if(_f.byNode(_46)){return fi!=-2?true:false;}else{if(fi){return true;}}return !!(_46.getAttribute("focus-id"));}return false;};_10.byNode=function(_47){var fi,id,w;do{if(_47&&_47.getAttribute){fi=this.focusIndex(_47);if(fi==-2){continue;}w=_f.byNode(_47);if(w){return w;}id=_47.getAttribute("focus-id");if(id){return this.byId(id);}if(fi){return {domNode:_47};}}}while(_47&&(_47=_47.parentNode));return null;};_10.byId=function(_48){return this.registry[_48];};_10.getUniqueId=function(_49){var _4a=_49.declaredClass.replace(/\./g,"_");var id;var _4b=this.boxCounter;do{id=_4a+"_"+(_4a in _4b?++_4b[_4a]:_4b[_4a]=0);}while(this.byId(id));return id;};_10.register=function(box){var id=box.id;if(this.registry[id]){return false;}else{this.registry[id]=box;return true;}};_10.unregister=function(box){var id=box.id;var _4c=this.boxCounter;if(this.registry[id]){var _4d=box.declaredClass.replace(/\./g,"_");box.domNode.removeAttribute("focus-id");delete this.registry[id];if(_4c[_4d]){_4c[_4d]--;}box.destroy();}};_8(function(){_10.start();});});