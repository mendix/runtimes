/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("mxui/wm/focus",["mxui/dom","dojo/keys","dojo/_base/connect","dojo/has","dojo/aspect","dojo/ready","dojo/dom-class","dojo/_base/event","dojo/_base/lang","dojo/_base/declare","dijit/focus","dijit/_base/focus","dijit/registry","exports"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){function _f(_10){var _11=_1.getTabIndex(_10);return _11>=0?_11:null;};var _12={create:function(){var _13=[];_13.find=this.find;_13.each=this.each;_13.dump=this.dump;_13.box=null;_13.last=null;_13.first=null;_13.f_first=null;_13.f_last=null;return _13;},buildStack:function(_14,box){var _15=null;var _16=null;var _17=null;var _18=null;var _19=null;var _1a=this.create();_1a.box=box=(box||_e.byNode(_14));var _1b=_14==box.domNode;var ni=_1b?"0":_1.getTabIndex(_14);var _1c=box.domNode;var _1d=null;var _1e=null;var _1f=null;var _20=null;if(!_1b&&!_e.focusable(_14)){_1d=_14;while((_1d=_1d.parentNode)!=null){var vi=_e.focusable(_1d);if(vi||_1d==_1c){_1e=_1f;break;}_1f=_1d;}}_1.walkNode(_1c,function(_21,_22){if(_21==_1c){return true;}var one=(_21==_14);if(!one){var vi=_e.focusable(_21);if(!vi){if(_1e){if(_20){if(_1.nextNode(_20,_22)){_20=false;}else{return true;}}else{if(_21==_1e){_20=_22;return true;}}}return vi===0;}}var _23=this.isBox(_21);var ci=_f(_21);if(!ci&&_23){if(_1.getTabIndex(_21)<0){return false;}ci=_21.getAttribute("focusIndex")||"0";}if(one||ci){var _24={node:_21,stack:_1a,next:null,prev:null};if(ni==-1){if(_17){if(_18==null||(_18>ci)){_18=ci;_19=_24;}}else{if(one){_17=true;}}}if(ci){if(!_15){_15=_24;}_16=_24;var _25=_1a[ci];if(!_25){_25=_1a[ci]=[];}_25.push(_24);}else{_1a._curr=_24;}return false;}},_e);if(ni==-1){var _26=_1a._curr;if(_26){_26.prev=_26.next=_19;}}_1a.each(function(_27,_28){if(!this.first){this.first=_28;}var _29=_28.prev=this.last;if(_29){_29.next=_28;}this.last=_28;if(_14==_27){this._curr=_28;}},null,_1a);_1a.f_first=_15;_1a.f_last=_16;return _1a;},each:function(fnc,_2a,_2b){if(_2a=="prev"){var i=this.length;while(0<=--i){var _2c=this[i];var l=_2c&&_2c.length;if(l){for(var c=l-1;0<=c;c--){var _2d=fnc.call(_2b,_2c[c].node,_2c[c],i);if(_2d!=null){return _2d;}}}}}else{var i=-1;while(++i<this.length){var _2c=this[i];var l=_2c&&_2c.length;if(l){for(var c=0;c<l;c++){var _2d=fnc.call(_2b,_2c[c].node,_2c[c],i);if(_2d!=null){return _2d;}}}}}return null;},find:function(_2e){if(this._curr&&this._curr.node==_2e){return this._curr;}var ni=_1.getTabIndex(_2e)||"0";if(ni!=-1){var i=ni;do{var _2f=this[i];if(_2f){for(var c=0,l=_2f.length;c<l;c++){var n=_2f[c];if(n.node==_2e){return n;}}}}while(++i<this.length);}var _30=null;var _31=this.box.domNode;var _32=_2e;while((_32=_32.parentNode)!=null&&_32!=_31){if(!_e.focusable(_32)){continue;}if(_f(_32)){_30=_32;}}return _30?this.find(_30):null;},dump:function(str){this.each(function(_33,_34){});}};var _35={getFocusStack:function(){var _36=_12.create();_36.box=this;var _37=null;var _38=null;var _39=false;var _3a=this.nodes;for(var i=0,l=_3a.length;i<l;i++){var _3b=_3a[i].node;var tab=_f(_3b);var vi=_e.focusable(_3b);if(tab){if(vi){_37=_3b;break;}else{_39=true;_3b.tabIndex=-1;}}else{if(vi){if(_39){_37=_3b;_37.tabIndex=1;break;}_38=_3b;}}}if(!_37){_37=_38;_37&&(_37.tabIndex=1);}if(_37){_36.push(_37);_36.last=_36.first=_36._curr={prev:null,next:null,node:_37,stack:_36};}return _36;},_onmousedown:function(e){var _3c=e.target;if(_3c.nodeName.toLowerCase()=="option"){_3c=_3c.parentNode;}var _3d=_3c;var s=null;var _3e=this.domNode;do{s=_1.data(_3d,"box-node");if(s&&s.box==this){break;}}while((_3d!=null)&&(_3d!=_3e)&&(_3d=_3d.parentNode)!=null);if(s){var _3f=_1.getTabIndex(_3c);this._focus(s.node,_3f!=null);}},_focus:function(_40,_41){var _42=this.getFocusStack();var _43=_42._curr;if(_43){_43.node.tabIndex=-1;}_40.tabIndex=1;_40=_e._tryNode({node:_40,stack:_42},"next");if(!_41){_e.put(_40);}},next:function(_44,dir){var _45=_1.data(_44,"box-node");if(_45){var _46=this._getNextNode(_45,dir);if(_46){var _47=_46.node;_47.tabIndex=0;_44.tabIndex=-1;return _47;}}else{}return null;},_getNextNode:function(_48,dir){if(!_48){return null;}var _49=_48;while((_49=_49[dir])!=null){var _4a=_49.node;if(_e.focusable(_4a)){return _49;}}return null;}};var Box=_a(null,{declaredClass:"mxui.wm.focus.Box",id:null,domNode:null,nested:false,FOCUS_NEXT:"FOCUS_NEXT",FOCUS_PREV:"FOCUS_PREV",constructor:function(_4b){this.id=_e.getUniqueId(this);this.domNode=_4b;this.nodes=[];this.keys={};this.handlers={};_4b.setAttribute("focus-id",this.id);},add:function(_4c){var s=_1.data(_4c,"box-node",{box:this,next:null,prev:null,node:_4c});var _4d=this.nodes.length;if(_4d!=0){var _4e=this.nodes[_4d-1];s.prev=_4e;_4e.next=s;_4c.tabIndex=-1;}else{_4c.tabIndex=0;}if(!this.converted){this.converted=true;_9.mixin(this,_35);this._boxhandler=_3.connect(this.domNode,"onmousedown",_9.hitch(this,"_onmousedown"));}this.nodes.push(s);},pressed:function(_4f,_50){var _51=this.keys;var hs=this.handlers;for(var key in _4f){var _52=_2[key]||key;var fnc=_4f[key];if(fnc==this.FOCUS_NEXT){_51[_52]="next";}else{if(fnc==this.FOCUS_PREV){_51[_52]="prev";}else{if(typeof fnc=="string"){fnc=_50[fnc];}if(typeof fnc!="function"){logger.error(this.id+".pressed: Passed stuff is not a function: "+key);}else{if(hs[_52]){}hs[_52]=[_50,fnc];}}}}},destroy:function(){if(!this._destroyed){var _53=this.nodes;for(var i=0,l=_53.length;i<l;i++){var _54=_53[i].node;_1.data(_54,"box-node",null);}this.nodes=null;this.keys=null;this.handlers=null;this._boxhandler&&this._boxhandler.remove();this._destroyed=true;}},getHandler:function(e){var _55=typeof (e.charOrCode)!="undefined"?e.charOrCode:e.keyCode;return this.handlers[(_55==" ")?_2.SPACE:_55];},getFocusDirection:function(e){var nav=this.domNode.getAttribute("focuskeys");if(nav){var up,lr;if(nav=="up-down"){if(e.keyCode==_2.UP_ARROW){up="prev";}else{if(e.keyCode==_2.DOWN_ARROW){up="next";}}}if(nav=="left-right"){if(e.keyCode==_2.LEFT_ARROW){lr="prev";}else{if(e.keyCode==_2.RIGHT_ARROW){lr="next";}}}return up||lr;}else{var _56=typeof (e.charOrCode)!="undefined"?e.charOrCode:e.keyCode;_56=(_56==" ")?_2.SPACE:_56;var key=this.keys[_56];if(key){return key;}}return null;},onFocusPress:function(e,_57){var dir=this.getFocusDirection(e);if(e.altKey||e.shiftKey||e.ctrlKey){return true;}if(dir){var _58=_1.data(_57,"box-node");if(_58){var _59=this.next(_57,dir);if(_59){_e.put(_59);return false;}_8.stop(e);}else{}}else{var h=this.getHandler(e);if(h){try{return h[1].call(h[0],e,_57);}catch(error){logger.error(this.id+".onFocusPress: Error when executing handler: "+error.message);return true;}}}return true;},next:function(_5a,dir){var _5b=_e._getStack(_5a,this);var _5c=_e._doNext(_5b.find(_5a),dir);return _5c;}});_e.name="mxui.wm.focus";_e.state={skipCyclic:false,skipReadonly:true};_e.registry={};_e.boxCounter={};_e.start=function(){if(this._started){return;}this._started=true;_3.connect(window.document,"onkeypress",_9.hitch(this,"onkeypress"));_3.connect(window.document,"onkeydown",_9.hitch(this,"keydownpatch"));_5.after(_b,"_onFocusNode",_9.hitch(this,"onfocus"),true);_5.after(_b,"_onBlurNode",_9.hitch(this,"_onBlurNode"),true);_3.connect(document,"onmousedown",_9.hitch(this,"_onBlur"));var _5d=this.state;this.timer_clear=function(){_5d._timer=null;_5d._shift=false;};};_e.skipCyclic=function(_5e){var _5f=this.state;_5f.skipCyclic=!!_5e;};_e.skipReadonly=function(_60){var _61=this.state;_61.skipReadonly=!!_60;};_e.get=function(){var f=_c.getFocus();return f.node;};_e.watch=function(_62){var _63=function(evt){};var _64=function(evt){};var _65=function(){if(_4("ie")){_62.detachEvent("onactivate",_63);_62.detachEvent("ondeactivate",_64);}else{_62.removeEventListener("focus",_63,true);_62.removeEventListener("blur",_64,true);}};if(_4("ie")){_62.attachEvent("onactivate",_63);_62.attachEvent("ondeactivate",_64);}else{_62.addEventListener("focus",_63,true);_62.addEventListener("blur",_64,true);}return _65;};_e.put=function(_66){if(!_66||_66.nodeType!=1){return false;}if(_4("ie")){try{document.selection.empty();}catch(e){}}setTimeout(function(){try{_66.focus();}catch(e){}var _67=_66.nodeName.toLowerCase();if((_67=="input"&&_66.type=="text")||_67=="textarea"){_66.select&&_66.select();}},0);};_e.restore=function(){var _68=_c.getFocus();if(_68.node){var _69=_68.node;var _6a=this._getStack(_69);var _6b=_6a._curr;_69=_6b?this._tryNode(_6b,"next"):null;if(_69){this.put(_69);}}};_e.first=function(_6c){this.put(this.getFirst(_6c,"next"));};_e.last=function(_6d){this.put(this.getFirst(_6d,"prev"));};_e.next=function(_6e){this.put(this._getNextNode(_6e,false));};_e.prev=function(_6f){this.put(this._getNextNode(_6f,true));};_e.blur=function(){var _70=this.get();if(_70){_70.blur();}};_e._onBlur=function(e){this.state_clear();this._clickedNode=e.target;};_e._ontab=function(_71){var _72=this.state;var _73=_72._shift;this.timer_clear();var box=null;if(box){}else{this.state_clear();}};_e.onfocus=function(_74){if(_4("ie")){if(!_1.getTabIndex(_74)){return;}}if(_74.nodeType!=1){return;}var _75=this.state;_75.active=_74;if(_75._timer){this._ontab(_74);}else{_7.add(_74,"mx-focus");}};_e._onBlurNode=function(_76){_7.remove(_76,"mx-focus");};_e.state_clear=function(){var _77=this.state;_77.node=null;_77.box=null;};_e.timer_clear=function(){};_e.next=function(){var _78=this.state;if(_78.active&&_78.active.nodeType==1){var _79=_78.active;var _7a=this.byNode(_79);if(_7a){var _7b=this._getNextNode(_79);if(_7b){this.put(_7b);}else{}return;}}};_e.keydownpatch=function(e){if(e.keyCode==_2.UP_ARROW||e.keyCode==_2.DOWN_ARROW){var _7c=this.state;this.onkeypress(e);_7c._patch_inWork=true;setTimeout(function(){_7c._patch_inWork=null;},10);}};_e.onkeypress=function(e){var _7d=this.state;if(_7d._patch_inWork){return;}var _7e=e.shiftKey;var tab=e.keyCode===_2.TAB;var _7f=e.target;if(tab){if(_7f.nodeName.toLowerCase()=="html"){if(this._clickedNode){_7f=this._clickedNode;}else{return;}}var _80=this._getNextNode(_7f,_7e);if(_80){this.put(_80);}_8.stop(e);}else{var _81=_7f;var box=this.byNode(_7f);if(box){do{var _82=box.domNode;if(box.onFocusPress){if(!box.onFocusPress(e,_81)){_8.stop(e);break;}}_81=_82;var nn=_82.parentNode;}while(nn&&(box=this.byNode(nn))!=null);}}};_e._getStack=function(_83,box){box=(box||this.byNode(_83));if(box.getFocusStack){try{return box.getFocusStack(_83);}catch(e){var _84=_12.create();_84.box=box;return _84;}}return _12.buildStack(_83,box);};_e.getFirst=function(_85,dir,_86){if(this.isBox(_85)){var _86=_86||this._getStack(_85);if(_86.length==0){if(_f(_85)){return _85;}return null;}var _87=_86[dir=="next"?"first":"last"];return _87?this._tryNode(_87,dir):null;}return _85;};_e._tryNode=function(_88,dir){var _89=_88.node;if(this.isBox(_89)){var _8a=this.getFirst(_89,dir);if(_8a){return _8a;}else{return this._doNext(_88,dir);}}else{return _89;}return null;};_e._doNext=function(_8b,dir){if(!_8b){return null;}var _8c=_8b[dir];if(!_8c){return null;}return this._tryNode(_8c,dir);};_e._getNextNode=function(_8d,_8e){var box=null;var _8f=null;var dir=!_8e?"next":"prev";if(this.isBox(_8d)){box=this.byNode(_8d.parentNode);}else{box=this.byNode(_8d);}if(!box){return null;}var _90=this._getStack(_8d,box);var _91=this._doNext(_90.find(_8d),dir);if(!_91){_8f=_90.box.domNode;if(this.cyclic(_8f)){return this.getFirst(_8f,dir,_90);}else{_91=this._getNextNode(box.domNode,_8e);if(!_91){}}}return _91;};_e.skip=function(_92,_93){if(_92&&_92.setAttribute){if(arguments.length==2){_93=!!_93;_92.setAttribute("focusNoSkip",_93);return _93;}var _94=/true/.test(_92.getAttribute("focusNoSkip"));return _94?!_94:_92.readOnly;}return true;};_e.focusable=function(_95){if(!_95||_95.nodeType!=1){return false;}if(_95.disabled){return false;}if(_e.skip(_95)&&_e.state.skipReadonly){return false;}var _96=_95.style;if(_96.display=="none"||_96.visibility=="hidden"){return false;}if(_95.offsetWidth==0&&_95.offsetHeight==0){return 0;}return true;};_e.cyclic=function(_97,_98){if(_97&&_97.setAttribute){if(arguments.length==2){var s=/true/.test(_98);_97.setAttribute("focusCycle",s);return s;}return /true/.test(_97.getAttribute("focusCycle"));}return false;};_e.focusIndex=function(_99,_9a){if(_99&&_99.getAttribute){if(arguments.length==2){_99.setAttribute("focusIndex",_9a);return _9a;}return _99.getAttribute("focusIndex");}return null;};_e.addBox=function(_9b){var box=new Box(_9b);this.register(box);return box;};_e.removeBox=function(_9c){var box=this.byNode(_9c);if(box){this.unregister(box);return true;}return false;};_e.isBox=function(_9d){if(_9d&&_9d.getAttribute){var fi=this.focusIndex(_9d);if(_d.byNode(_9d)){return fi!=-2?true:false;}else{if(fi){return true;}}return !!(_9d.getAttribute("focus-id"));}return false;};_e.byNode=function(_9e){var fi,id,w;do{if(_9e&&_9e.getAttribute){fi=this.focusIndex(_9e);if(fi==-2){continue;}w=_d.byNode(_9e);if(w){return w;}id=_9e.getAttribute("focus-id");if(id){return this.byId(id);}if(fi){return {domNode:_9e};}}}while(_9e&&(_9e=_9e.parentNode));return null;};_e.byId=function(_9f){return this.registry[_9f];};_e.getUniqueId=function(_a0){var _a1=_a0.declaredClass.replace(/\./g,"_");var id;var _a2=this.boxCounter;do{id=_a1+"_"+(_a1 in _a2?++_a2[_a1]:_a2[_a1]=0);}while(this.byId(id));return id;};_e.register=function(box){var id=box.id;if(this.registry[id]){return false;}else{this.registry[id]=box;return true;}};_e.unregister=function(box){var id=box.id;var _a3=this.boxCounter;if(this.registry[id]){var _a4=box.declaredClass.replace(/\./g,"_");box.domNode.removeAttribute("focus-id");delete this.registry[id];if(_a3[_a4]){_a3[_a4]--;}box.destroy();}};_6(function(){_e.start();});});