
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("reporting/widget/ReportMatrix",["dojo","dijit","dojox","dojo/require!reporting/lib/OQLSource,reporting/lib/MetaResult,reporting/store/ParameterStore,reporting/mixin/_Reportable,mxui/mixin/_Stateful"],function(_1,_2,_3){_1.provide("reporting.widget.ReportMatrix");_1.require("reporting.lib.OQLSource");_1.require("reporting.lib.MetaResult");_1.require("reporting.store.ParameterStore");_1.require("reporting.mixin._Reportable");_1.require("mxui.mixin._Stateful");mxui.widget.declare("reporting.widget.ReportMatrix",{mixins:[_2._TemplatedMixin,_2._Container,_2._Contained,mxui.mixin._Contextable,reporting.mixin._Reportable,mxui.mixin._Stateful],inputargs:{testing:false,nested:false,flip:false,startdormant:false,showexportbutton:false,highlights:"",reportid:"",intervalvalues:"",target:"",pagesize:10,usepaging:false,columns:null},constructor:function(){this.templateString=_1.cache("reporting.widget","templates/ReportMatrix.html","<div class=\"mx-grid mx-reportmatrix\" style=\"display:none;\">\n\t<div class=\"mx-grid-controlbar clearfix\" focusIndex=\"0\">\n        <div class=\"mx-grid-pagingbar\" dojoAttachPoint=\"pagingNode\"></div>\n        <div class=\"mx-grid-toolbar\" dojoAttachPoint=\"toolBarNode\"></div>\n\t</div>\n\t<div class=\"mx-grid-content\" focusIndex=\"1\">\n        <table class=\"table table-bordered table-striped mx-reportmatrix-table\">\n            <thead dojoAttachPoint=\"theadNode\"></thead>\n            <tbody dojoAttachPoint=\"tbodyNode\"></tbody>\n            <tfoot dojoAttachPoint=\"tfootNode\"></tfoot>\n        </table>\n    </div>\n</div>\n");this.reportid="";this.startdormant=false;this.flip=false;this.highlights="";this.testing=false;this.intervalvalues="";this.target="";this.showexportbutton=false;this.alignment="";this.weights="";this.pagesize=10;this.usepaging=false;this.domNode=null;this.theadNode=null;this.tfootNode=null;this.tbodyNode=null;this.toolBarNode=null;this.btFirst=null;this.btPrevious=null;this.btNext=null;this.btLast=null;this.pagingNode=null;this.pagingStatusNode=null;this.returnValue=null;this.isGenerated=false;var _4=_1.hitch;var _5=mxui.dom.setOpacity;var _6=mxui.dom;var _7=null;var _8={};var _9=[];var _a={};var _b=[];var _c=[];var _d=[];var _e=[];var _f=null;var _10=function(_11){_11&&_11();};var _12=" ";this.applyContext=function(_13,_14){this.startdormant=this.getState("dormant",this.startdormant);if(!this.startdormant){this.contextNotification(_13);this.sequence(["actRefreshMatrix","actUpdatePagingStatus"],_14);}else{this.startdormant=false;_14&&_14();}};function _15(arr){var obj={};for(var i=0;i<arr.length;i++){obj[arr[i]]=arr[i];}return obj;};var _16=function(_17){mxui.dom.show(this.domNode);_c=_7.getSeriesData();_d=_7.getSeriesDescriptives();_e=_7.getIntervalDescriptives();_a=_15(_7.getAggregateRows());var _18=_7.getSeriesTypes();_f=new reporting.lib.MetaResult(_18);var _19=99/(_d.length+1);_19=_19.toString()+"%";var i,tr;var _1a="";var _1b=_6.th();_1b.innerHTML="&nbsp;";_1b.setAttribute("width","1%");tr=_6.tr(_1b);this.theadNode.appendChild(tr);var _1c={};var _1d;for(i=0;i<_d.length;i++){_1d=this.columns[i];_1a=_d[i].toString();_1a=(_1a==="")?" ":_1a;_1b=_6.th(_1a);_1b.setAttribute("width",_1d.weight+"%");if(!_1d.weight){_1c[i]=true;}else{tr.appendChild(_1b);}mxui.dom.setClass(_1b,this._getAlignmentClass(_1d.alignment));}for(i=0;i<_e.length;i++){_1a=_e[i].toString();_1a=(/^\s*$/.test(_1a))?"&nbsp;":_1a;var _1e=_6.th();_1e.innerHTML=_1a;tr=_6.tr(_1e);tr.setAttribute("offset",i);if(_a[i]!=null){mxui.dom.setClass(tr,"mx-reportmatrix-aggregate-row");}for(var j=0;j<_d.length;j++){if(!_1c[j]){_1a=(_c[j][i]!=null)?_c[j][i]:_12;if((typeof (_1a)!="boolean")&&(typeof (_1a)!="number")){_1a=(_1a==="")?" ":_f.getRenderValue(j,_1a);}else{_1a=_f.getRenderValue(j,_1a);}_1a=(_1a==="")?" ":_1a;_1b=_6.td(_1a);tr.appendChild(_1b);mxui.dom.setClass(_1b,this._getAlignmentClass(this.columns[j].alignment));}}this.tbodyNode.appendChild(tr);}_17&&_17();};this.actInitialize=function(_1f){if(this.reportid===""){logger.error(this.id+".actInitialize : No report parameter passed. Aborting!");throw ("No report parameter passed to Report Matrix : aborting!");}if(!this.usepaging){mxui.dom.hide(this.pagingNode);}this.registerContent();try{mxui.dom.empty(this.theadNode);mxui.dom.empty(this.tbodyNode);mxui.dom.empty(this.tfootNode);}catch(e){logger.warn(this.id+".actInitialize : can't clear body : "+e.message);}this.actFillMatrix=_1.hitch(this,_16);if(this.highlights!==""){this.highlights=this.highlights.split(/;/);for(var i=0;i<this.highlights.length;i++){highlights[this.highlights[i]]=true;}}_1f();};this.actSetupOQLSource=function(_20){_7=new reporting.lib.OQLSource({reportid:this.reportid,page:(this.usepaging)?this.pagesize:null,startdormant:true,load:_20});};this.actRunReport=function(_21){this.isGenerated=true;_7.execQuery(_21);};this.actFillMatrix=function(_22){_22();};this.actRefreshMatrix=function(_23){this.sequence(["actRunReport","actRefreshView",_23?_23:_10]);};this.actRefreshView=function(_24){this.sequence(["actResetMatrix","actUpdatePagingStatus","actFillMatrix",_24?_24:_10]);};this.actSetupEvents=function(_25){_9.push(_1.subscribe("report_"+this.mxform.hash,this,"topicUpdate"));this.connect(this.tbodyNode,"ondblclick","eventMatrixClicked");if(this.showexportbutton){var _26=new mxui.widget.Button({"caption":mx.ui.translate(this.declaredClass,"excel_btn_caption"),"onClick":_4(this,"eventExcelExportClicked"),"cssClasses":["reportingReportMatrix_exportButton"],"iconUrl":"mxclientsystem/reporting/ui/widget/images/ReportMatrix/icnExcel.gif"});this.toolBarNode.appendChild(_26.domNode);}else{mxui.dom.hide(this.toolBarNode);}if(this.usepaging){var ltr=this.isLeftToRight(),_27=document.createDocumentFragment(),$=mxui.dom.create;this.btFirst=new mxui.widget.Button({iconClass:"glyphicon "+(ltr?"glyphicon-step-backward":"glyphicon-step-forward"),"onClick":_1.hitch(this,"eventPagingButtonClicked","first")});_27.appendChild($("#",this.btFirst.domNode," "));this.btPrevious=new mxui.widget.Button({iconClass:"glyphicon "+(ltr?"glyphicon-backward":"glyphicon-forward"),"onClick":_1.hitch(this,"eventPagingButtonClicked","previous")});_27.appendChild($("#",this.btPrevious.domNode," "));this._pagingStatusNode=mxui.dom.div({"class":"dijitInline mx-grid-paging-status"});_27.appendChild($("#",this._pagingStatusNode," "));this.btNext=new mxui.widget.Button({iconClass:"glyphicon "+(ltr?"glyphicon-forward":"glyphicon-backward"),"onClick":_1.hitch(this,"eventPagingButtonClicked","next")});_27.appendChild($("#",this.btNext.domNode," "));this.btLast=new mxui.widget.Button({iconClass:"glyphicon "+(ltr?"glyphicon-step-forward":"glyphicon-step-backward"),"onClick":_1.hitch(this,"eventPagingButtonClicked","last")});_27.appendChild($("#",this.btLast.domNode," "));this.pagingNode.appendChild(_27);mxui.dom.disableSelection(this.pagingNode);}_25&&_25();};this.actResetMatrix=function(_28){try{mxui.dom.empty(this.theadNode);mxui.dom.empty(this.tbodyNode);mxui.dom.empty(this.tfootNode);}catch(e){logger.warn(this.id+".actResetMatrix : can't clear body : "+e.message);}_28&&_28();};this.actUpdatePagingStatus=function(_29){if(!this.usepaging){_29&&_29();return;}mxui.html.setContent(this._pagingStatusNode,_7.getStatusMessage());if(_7.atBeginning()){this.btFirst.set("disabled",true);this.btPrevious.set("disabled",true);}else{this.btFirst.set("disabled",false);this.btPrevious.set("disabled",false);}if(_7.atEnd()){this.btNext.set("disabled",true);this.btLast.set("disabled",true);}else{this.btNext.set("disabled",false);this.btLast.set("disabled",false);}_29&&_29();};this.topicUpdate=function(arr){_7.first(0);this.actRefreshMatrix();};this.contextNotification=function(_2a){var _2b=_2a.getParams();for(var p in _2b){_8[p]=_2b[p];}_7.first(0);_7.setParams(_8);};this.contextUpdate=function(){};this.eventMatrixClicked=function(e){var _2c=e.target;var tr=_2c.parentNode;var _2d=parseInt(tr.getAttribute("offset"));var _2e=this.createContext();_2e.dupFrom(this.mxcontext);var _2f=this.intervalvalues;if(_2f!==""){try{for(var i=0;i<_2f.length;i++){var key=_2f[i];if(key!==""&&!_2e.hasParam(key)){var _30=_c[i][_2d];_2e.setParam(key,_30);}}}catch(err){}}if(this.target!==""){mx.ui.openFormInContent(this.target,"",_2e);}else{}};this.eventExcelExportClicked=function(e){mx.server.request({request:{action:"report_export_excel",params:{reportid:this.reportid,params:_7.getQueryParameters()}},options:{callback:mx.data.mxObjectsCallback(function(_31){mx.ui.downloadFile({mxobject:_31[0]});}),useCache:false}});};this.eventPagingButtonClicked=function(_32,e){switch(_32.toString().toLowerCase()){case "first":if(!_7.atBeginning()){_7.first(_4(this,"actRefreshView"));}break;case "last":if(!_7.atEnd()){_7.last(_4(this,"actRefreshView"));}break;case "next":if(!_7.atEnd()){_7.next(_4(this,"actRefreshView"));}break;case "previous":if(!_7.atBeginning()){_7.previous(_4(this,"actRefreshView"));}break;default:_1.debug(this.id+".eventPagingButtonClicked : no action matched. This shouldn't happen!");break;}};this.uninitialize=function(_33){try{_7.uninitialize();for(var i=0;i<_9.length;i++){_1.unsubscribe(_9[i]);}mxui.widget.destroyChildren(this.toolBarNode);}catch(e){}delete _7;};this.storeState=function(_34){_34("dormant",!this.isGenerated);};this._getAlignmentClass=function(_35){if(mx.ui.isRtl()){_35=_35=="right"?"left":"right";}return {left:"mx-left-aligned",right:"mx-right-aligned",center:"mx-center-aligned"}[_35];};},postCreate:function(){this.initContext();var _36="context_seed_"+this.mxform.hash,_37=_1.subscribe(_36,_1.hitch(this,"contextNotification"));this.addOnDestroy(function(){_1.unsubscribe(_37);});this.sequence(["actInitialize","actSetupOQLSource","actSetupEvents","actLoaded"]);}});});