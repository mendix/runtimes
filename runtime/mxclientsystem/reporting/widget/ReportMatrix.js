/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
require({cache:{"url:reporting/widget/templates/ReportMatrix.html":"<div class=\"mx-grid mx-reportmatrix\" style=\"display:none;\">\n\t<div class=\"mx-grid-controlbar clearfix\" focusIndex=\"0\">\n        <div class=\"mx-grid-pagingbar\" dojoAttachPoint=\"pagingNode\"></div>\n        <div class=\"mx-grid-toolbar\" dojoAttachPoint=\"toolBarNode\"></div>\n\t</div>\n\t<div class=\"mx-grid-content\" focusIndex=\"1\">\n        <table class=\"table table-bordered table-striped mx-reportmatrix-table\">\n            <thead dojoAttachPoint=\"theadNode\"></thead>\n            <tbody dojoAttachPoint=\"tbodyNode\"></tbody>\n            <tfoot dojoAttachPoint=\"tfootNode\"></tfoot>\n        </table>\n    </div>\n</div>\n"}});define("reporting/widget/ReportMatrix",["reporting/lib/MetaResult","reporting/lib/OQLSource","mxui/widget/Button","mxui/mixin/_Templated","mxui/mixin/_Contextable","mxui/mixin/_Stateful","mxui/widget","mxui/dom","mendix/lib/MxObject","dojo/_base/connect","dojo/_base/lang","dojo/_base/declare","dijit/_Container","dijit/_Contained","dojo/text!reporting/widget/templates/ReportMatrix.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){return _7.declare("reporting.widget.ReportMatrix",{mixins:[_4,_d,_e,_5,_6],startdormant:false,showexportbutton:false,reportid:"",intervalvalues:"",target:"",pagesize:10,usepaging:false,columns:null,constructor:function(){this.templateString=_f;this.domNode=null;this.theadNode=null;this.tfootNode=null;this.tbodyNode=null;this.toolBarNode=null;this.btFirst=null;this.btPrevious=null;this.btNext=null;this.btLast=null;this.pagingNode=null;var _10=null,_11=false,_12={},_13=[],_14={},_15=[],_16=[],_17=[],_18=null,_19=this;var _1a=" ";this.applyContext=function(_1b,_1c){this.startdormant=this.getState("dormant",this.startdormant);if(!this.startdormant){this.contextNotification(_1b);this.actRefreshMatrix(function(){_19._updatePagingStatus();_1c&&_1c();});}else{this.startdormant=false;_1c&&_1c();}};function _1d(arr){var obj={};for(var i=0;i<arr.length;i++){obj[arr[i]]=arr[i];}return obj;};var _1e=function(){this.domNode.style.display="";_15=_10.getSeriesData();_16=_10.getSeriesDescriptives();_17=_10.getIntervalDescriptives();_14=_1d(_10.getAggregateRows());var _1f=_10.getSeriesTypes();_18=new _1(_1f);var _20=99/(_16.length+1);_20=_20.toString()+"%";var i,tr;var _21="";var _22=_8.create("th");_22.innerHTML="&nbsp;";_22.setAttribute("width","1%");tr=_8.create("tr",{},_22);this.theadNode.appendChild(tr);var _23={};var _24;for(i=0;i<_16.length;i++){_24=this.columns[i];_21=_16[i].toString();_21=(_21==="")?" ":_21;_22=_8.create("th",{"class":this._getAlignmentClass(_24.alignment)},_21);_22.setAttribute("width",_24.weight+"%");if(!_24.weight){_23[i]=true;}else{tr.appendChild(_22);}}for(i=0;i<_17.length;i++){_21=_17[i].toString();_21=(/^\s*$/.test(_21))?"&nbsp;":_21;var _25=_8.create("th");_25.innerHTML=_21;tr=_8.create("tr",{},_25);tr.setAttribute("offset",i);if(_14[i]!=null){tr.className="mx-reportmatrix-aggregate-row";}for(var j=0;j<_16.length;j++){if(!_23[j]){_21=_15[j][i]!=null?_15[j][i]:_1a;if((typeof _21!="boolean")&&(typeof _21!="number")){_21=(_21==="")?" ":_18.getRenderValue(j,_21);}else{_21=_18.getRenderValue(j,_21);}_21=(_21==="")?" ":_21;_22=_8.create("td",{"class":this._getAlignmentClass(this.columns[j].alignment)},_21);tr.appendChild(_22);}}this.tbodyNode.appendChild(tr);}};this.actInitialize=function(_26){if(this.reportid===""){logger.error(this.id+".actInitialize : No report parameter passed. Aborting!");throw ("No report parameter passed to Report Matrix : aborting!");}if(!this.usepaging){this.pagingNode.style.display="none";}try{_8.empty(this.theadNode);_8.empty(this.tbodyNode);_8.empty(this.tfootNode);}catch(e){}this._fillMatrix=_b.hitch(this,_1e);_26();};this.actSetupOQLSource=function(_27){_10=new _2({reportid:this.reportid,page:(this.usepaging)?this.pagesize:null,startdormant:true,load:_27});};this.actRunReport=function(_28){_11=true;_10.execQuery(_28);};this._fillMatrix=function(){};this.actRefreshMatrix=function(_29){this.actRunReport(function(){_19._refreshView();_29&&_29();});};this._refreshView=function(){this._resetMatrix();this._updatePagingStatus();this._fillMatrix();};this.actSetupEvents=function(_2a){_13.push(_a.subscribe("report_"+this.mxform.hash,this,"topicUpdate"));this.connect(this.tbodyNode,"ondblclick","eventMatrixClicked");if(this.showexportbutton){var _2b=new _3({"caption":window.mx.ui.translate(this.declaredClass,"excel_btn_caption"),"onClick":_b.hitch(this,"eventExcelExportClicked"),"cssClasses":["reportingReportMatrix_exportButton"],"iconUrl":"mxclientsystem/reporting/ui/widget/images/ReportMatrix/icnExcel.gif"});this.toolBarNode.appendChild(_2b.domNode);}else{this.toolBarNode.style.display="none";}if(this.usepaging){var ltr=this.isLeftToRight(),_2c=document.createDocumentFragment(),$=_8.create;this.btFirst=new _3({iconClass:ltr?"glyphicon-step-backward":"glyphicon-step-forward","onClick":_b.hitch(this,"eventPagingButtonClicked","first")});_2c.appendChild($("#",this.btFirst.domNode," "));this.btPrevious=new _3({iconClass:ltr?"glyphicon-backward":"glyphicon-forward","onClick":_b.hitch(this,"eventPagingButtonClicked","previous")});_2c.appendChild($("#",this.btPrevious.domNode," "));this._pagingStatusNode=$("div",{"class":"dijitInline mx-grid-paging-status"});_2c.appendChild($("#",this._pagingStatusNode," "));this.btNext=new _3({iconClass:ltr?"glyphicon-forward":"glyphicon-backward","onClick":_b.hitch(this,"eventPagingButtonClicked","next")});_2c.appendChild($("#",this.btNext.domNode," "));this.btLast=new _3({iconClass:ltr?"glyphicon-step-forward":"glyphicon-step-backward","onClick":_b.hitch(this,"eventPagingButtonClicked","last")});_2c.appendChild($("#",this.btLast.domNode," "));this.pagingNode.appendChild(_2c);_8.disableSelection(this.pagingNode);}_2a&&_2a();};this._resetMatrix=function(){try{_8.empty(this.theadNode);_8.empty(this.tbodyNode);_8.empty(this.tfootNode);}catch(e){}};this._updatePagingStatus=function(){if(!this.usepaging){return;}_8.text(this._pagingStatusNode,_10.getStatusMessage());if(_10.atBeginning()){this.btFirst.set("disabled",true);this.btPrevious.set("disabled",true);}else{this.btFirst.set("disabled",false);this.btPrevious.set("disabled",false);}if(_10.atEnd()){this.btNext.set("disabled",true);this.btLast.set("disabled",true);}else{this.btNext.set("disabled",false);this.btLast.set("disabled",false);}};this.topicUpdate=function(){_10.first();this.actRefreshMatrix();};this.contextNotification=function(_2d){var _2e=_2d.getParams();for(var p in _2e){_12[p]=_2e[p];}_10.first();_10.setParams(_12);};this.contextUpdate=function(){};this.eventMatrixClicked=function(e){var _2f=e.target,tr=_2f.parentNode,_30=parseInt(tr.getAttribute("offset")),_31=this.createContext();_31.dupFrom(this.mxcontext);var _32=this.intervalvalues;if(_32!==""){try{for(var i=0;i<_32.length;i++){var key=_32[i];if(key!==""&&!_31.hasParam(key)){var _33=_15[i][_30];_31.setParam(key,_33);}}}catch(err){}}if(this.target!==""){window.mx.router.openFormInContent(this.target,"",_31);}else{}};this.eventExcelExportClicked=function(){window.mx.server.request({request:{action:"report_export_excel",params:{reportid:this.reportid,params:_10.getQueryParameters()}},options:{callback:function(_34,_35){var _36=new _9({json:_35.mxobject,meta:window.mx.meta.getEntity(_35.mxobject.objectType)});window.mx.data.invalidateCaches(_36.getGuid());window.mx.ui.downloadFile({mxobject:_36});},useCache:false}});};this.eventPagingButtonClicked=function(_37){switch(_37.toLowerCase()){case "first":if(!_10.atBeginning()){_10.first(_b.hitch(this,"_refreshView"));}break;case "last":if(!_10.atEnd()){_10.last(_b.hitch(this,"_refreshView"));}break;case "next":if(!_10.atEnd()){_10.next(_b.hitch(this,"_refreshView"));}break;case "previous":if(!_10.atBeginning()){_10.previous(_b.hitch(this,"_refreshView"));}break;default:break;}};this.uninitialize=function(){try{for(var i=0;i<_13.length;i++){_13[i].remove();}_7.destroyWidgetsIn(this.toolBarNode);}catch(e){}};this.storeState=function(_38){_38("dormant",!_11);};this._getAlignmentClass=function(_39){if(window.mx.ui.isRtl()){_39=_39=="right"?"left":"right";}return {left:"mx-left-aligned",right:"mx-right-aligned",center:"mx-center-aligned"}[_39];};},postCreate:function(){this.initContext();var _3a="context_seed_"+this.mxform.hash,_3b=_a.subscribe(_3a,_b.hitch(this,"contextNotification"));this.addOnDestroy(function(){_3b.remove();});this.sequence(["actInitialize","actSetupOQLSource","actSetupEvents","actLoaded"]);}});});