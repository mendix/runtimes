
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("reporting/widget/DateRange",["reporting/store/ParameterStore","reporting/lib/DateHelpers","mxui/mixin/_Stateful","mxui/widget/_WidgetBase","mxui/dom","mxui/widget/DatePicker","dojo/date/locale","dojo/topic","dojo/_base/array","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){var _b=_a(_4,{_items:null,postCreate:function(){this.connect(this.domNode,"change","onChange");_5.setSelectOptions(this.domNode,{},"");},setItems:function(_c){if(_c){this._items=_c;var _d={};_9.forEach(this._items,function(_e,_f){_d[_f]=_e.display;});_5.setSelectOptions(this.domNode,_d,"");}},getDateInterval:function(){var _10=_5.getSelectedValue(this.domNode);return _10!==""?this._items[_10]:{from:"",to:""};},_getValueAttr:function(){return _5.getSelectedText(this.domNode);},_setValueAttr:function(_11){_5.selectOptionByText(this.domNode,_11);},onChange:function(){}});var _12={set:function(){},get:function(){return "";},onChange:function(){},setItems:function(){}};function _13(_14,_15){var _16=[];for(var _17=_14;_17<=_15;_17++){_16.push({display:_17.toString(),from:new Date(_17,0,1),to:new Date(_17+1,0,0)});}return _16;};var _18={period:function(_19){var _1a=_2.getFirstWeekOfYear(_19);var end=_1a;var _1b=[];var _1c=_19;var _1d=1;var _1e=_2.getFirstWeekOfYear(_19+1);while(_19==_1c&&_1e>end){var _1f=_1a;end=_1a+=(4*_2.weekMs);if(_1d==14){end=_1e;}end-=_2.dayMs;_1b.push({from:new Date(_1f),to:new Date(end),display:String(_1d++)});_19=new Date(_1a).getUTCFullYear();}return _1b;},quarter:function(_20){return _9.map([0,1,2,3],function(_21){return {display:(_21+1).toString(),from:new Date(_20,_21*3,1),to:new Date(_20,_21*3+3,0)};});},month:function(_22){return _9.map(_7.getNames("months","wide"),function(_23,_24){return {display:_23,from:new Date(_22,_24,1),to:new Date(_22,_24+1,0)};});},week:function(_25){var _26=new Date(_2.getFirstWeekOfYear(_25)),_27=[],i=1;do{var _28=new Date(_26.getTime()+_2.weekMs-1);_27.push({display:"Week "+(i++).toString(),from:_26,to:_28});_26=new Date(_28.getTime()+1);}while(_26.getFullYear()==_25);return _27;}};var _29=["period","quarter","month","week"],_2a=_29.concat(["year"]);var _2b=_a([_4,_3],{reportid:"",parameter:"",startYear:null,endYear:null,hasDates:true,_periodSelectorsParameterName:"",_periodSelectors:null,_dateInputs:null,_value:null,postCreate:function(){this._periodSelectorsParameterName=this.parameter.toString()+"_config_hash";this._periodSelectors={};this._dateInputs={};this._value={from:"",to:""};this._buildPeriodSelectors();this._periodSelectors.year.setItems(_13(this.startYear,this.endYear));this._subscribeToYearChange();this._subscribeToPeriodChange();if(this.hasDates){this._buildDateInputs();this._subscribeToDateChange();}},_buildPeriodSelectors:function(){var _2c=this;_9.forEach(_2a,function(_2d){var _2e=_2c.domNode.querySelector("select[name='"+_2d+"']");_2c._periodSelectors[_2d]=_2e?new _b({},_2e):_12;});},_buildDateInputs:function(){var _2f=this;_9.forEach(["from","to"],function(_30,_31){var _32=_2f.domNode.querySelector("input[name='"+_30+"']"),_33=new _6({selector:"date"});_32.parentNode.replaceChild(_33.domNode,_32);_2f._dateInputs[_30]=_33;});},_subscribeToYearChange:function(){var _34=this;this.connect(this._periodSelectors.year,"onChange",function(){var _35=this._periodSelectors.year.get("value");if(_35==""){_9.forEach(_29,function(_36){_34._periodSelectors[_36].setItems([]);});}else{this._setValue(this._periodSelectors.year.getDateInterval());_9.forEach(_29,function(_37){var _38=_34._periodSelectors[_37].get("value");_34._periodSelectors[_37].setItems(_18[_37](_35));if(_38!=""){_34._periodSelectors[_37].set("value",_38);_34._periodSelectors[_37].onChange();}});this._onChange();}});},_subscribeToPeriodChange:function(){var _39=this;_9.forEach(_29,function(_3a){var _3b=_39._periodSelectors[_3a];_39.connect(_3b,"onChange",function(){if(_3b.get("value")===""){return;}_39._setValue(_3b.getDateInterval());_9.forEach(_29,function(_3c){if(_3c!=_3a){_39._periodSelectors[_3c].set("value","");}});_39._onChange();});});},_subscribeToDateChange:function(){var _3d=this;_9.forEach(["from","to"],function(_3e){_3d.connect(_3d._dateInputs[_3e],"onChange",function(){var _3f=_3d._dateInputs[_3e].get("value");_3d._value[_3e]=_3f;if(_3f!==""){_9.forEach(_29,function(_40){_3d._periodSelectors[_40].set("value","");});if(_3f.getFullYear()!=_3d._periodSelectors.year.get("value")){_3d._periodSelectors.year.set("value","");}}_3d._onChange();});});},startup:function(){this.domNode.parentNode.style.padding="0px";this.inherited(arguments);},update:function(_41,_42){var _43=this.getState("value",this.mxcontext.hasParam(this.parameter)?this.mxcontext.getParam(this.parameter):""),_44=this.getState("config",this.mxcontext.hasParam(this._periodSelectorsParameterName)?this.mxcontext.getParam(this._periodSelectorsParameterName):""),_45=this;if(_44){this._periodSelectors.year.set("value",_44["year"]);this._periodSelectors.year.onChange();_9.forEach(_29,function(_46){_45._periodSelectors[_46].set("value",_44[_46]);});}if(_43){var _47="",_48="";if(_43.length){_47=new Date(_43[0]);_48=new Date(_43[1]);}else{if(_43!=""){_47=_48=new Date(_43);}}if(this.hasDates){this._dateInputs.from.set("value",_47);this._dateInputs.to.set("value",_48);}this._value={from:_47,to:_48};}this._onChange();_42&&_42();},_setValue:function(_49){if(this.hasDates){this._dateInputs.from.set("value",_49.from);this._dateInputs.to.set("value",_49.to);}this._value=_49;},_getValue:function(){return this._value.from!=""&&this._value.to!=""?[this._value.from.getTime(),this._value.to.getTime()]:"";},_getSelectorConfig:function(){var _4a=this,_4b={};_9.forEach(_2a,function(_4c){_4b[_4c]=_4a._periodSelectors[_4c].get("value");});return _4b;},_onChange:function(){this.mxcontext.setParam(this.parameter,this._getValue());this.mxcontext.setParam(this._periodSelectorsParameterName,this._getSelectorConfig());_8.publish("context_seed_"+this.mxform.hash,this.mxcontext);},storeState:function(_4d){_4d("value",this._getValue());_4d("config",this._getSelectorConfig());}});return _2b;});