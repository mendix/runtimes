
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("reporting/widget/DateRange",["dojo","dijit","dojox","dojo/require!reporting/lib/OQLSource,reporting/lib/DateHelpers,reporting/mixin/_Reportable"],function(_1,_2,_3){_1.provide("reporting.widget.DateRange");_1.require("reporting.lib.OQLSource");_1.require("reporting.lib.DateHelpers");_1.require("reporting.mixin._Reportable");mxui.widget.declare("reporting.widget.DateRange",{mixins:[_2._TemplatedMixin,_2._Contained,mxui.mixin._Contextable,reporting.mixin._Reportable],inputargs:{reportid:"",nested:false,paramtype:"",parameter:"",query:"",config:""},constructor:function(){this.templatePath=null;this.templateString="<div class='reportingDateRange'><div dojoAttachPoint='containerNode'></div></div>";this.isContainer=true;this.parameter="param";this.paramtype="";this.config="";this.query="";this.domNode=null;this.returnValue=null;var _4=_1.hitch;var _5=this;var _6=mxui.dom.hide;var _7=mxui.dom.show;var _8=_1.addClass;var _9=_1.removeClass;var _a=_1.addClass;var _b=mxui.dom.setClass;var _c=mxui.dom.getClass;var _d=mxui.dom.setOpacity;var _e=mxui.dom;var _f={};var _10=[];var _11={};var _12="";var _13=0;var _14=6;var _15=(1000*3600*24);var _16=(_15*7);var _17=_1.hitch(mx.parser,"formatDate");var _18=function(_19){_19&&_19();};var _1a=null;this.postCreate=function(){this.initContext();_1a=this.id;this.sequence(["actSetup","actContentHook","actParseContent","actRetrieveParameters","actLoaded"]);};this.applyContext=function(_1b,_1c){this.cloneContext(_1b);this.sequence(["actSetDate"],_1c);};var _1d={0:"Januari",1:"Februari",2:"Maart",3:"April",4:"Mei",5:"Juni",6:"Juli",7:"Augustus",8:"September",9:"Oktober",10:"November",11:"December"};var _1e={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};var _1f={LAST_WEEK:"Vorige week",THIS_WEEK:"Deze week",NEXT_WEEK:"Volgende week",LAST_MONTH:"Vorige maand",THIS_MONTH:"Deze maand",NEXT_MONTH:"Next month",LAST_QUARTER:"Vorig kwartaal",THIS_QUARTER:"Dit kwartaal",NEXT_QUARTER:"Volgend kwartaal"};var _20={LAST_WEEK:"Last week",THIS_WEEK:"This week",NEXT_WEEK:"Next week",LAST_MONTH:"Last month",THIS_MONTH:"This month",NEXT_MONTH:"Next month",LAST_QUARTER:"Last quarter",THIS_QUARTER:"This quarter",NEXT_QUARTER:"Next quarter"};var _21=function(_22){var _23={};for(var i=0;i<53;i++){_23[i]="Week "+(i+1).toString();}mxui.dom.setSelectOptions(_22,_23,"");};var _24=function(_25){var _26=mx.ui.getLocale();var _27=(_26.match(/nl/i))?_1d:_1e;mxui.dom.setSelectOptions(_25,_27,"");};var _28=function(_29){mxui.dom.setSelectOptions(_29,{0:"1",1:"2",2:"3",3:"4"},"");};var _2a=function(_2b){if(_2b.options.length==0){mxui.dom.setSelectOptions(_2b,{2006:"2006",2007:"2007",2008:"2008",2009:"2009",2010:"2009",2011:"2011",2012:"2012",2013:"2013",2014:"2014",2015:"2015",2016:"2016",2017:"2017",2018:"2018",2019:"2019",2020:"2020"},"");}};var _2c=function(i){var _2d=_f[i];if(_2d){var _2e=_2d.getAttribute("ref_id");return _2.byId(_2e);}return null;};var _2f=function(_30){var _31=new mxui.widget.FormDatePicker({},_30);_1.connect(_31,"onChange",_1.hitch(_5,"syncDateRangeWithContext"));_30.setAttribute("ref_id",_31.id);_10.push(_31);};var _32=function(_33){mxui.dom.setSelectOptions(_33,{},"");};var _34=function(_35){mxui.dom.hide(_35);};var _36=function(){var _37=_2c("from");var to=_2c("to");return (_37&&(_37.get("value")!="")&&to&&(to.get("value")!=""));};var _38=function(){return (mxui.dom.getSelectedValue(_f.year)!="");};var _39=function(){return parseInt(mxui.dom.getSelectedValue(_f.year));};var _3a=function(){return parseInt(mxui.dom.getSelectedValue(_f.quarter))+1;};var _3b=function(){return parseInt(mxui.dom.getSelectedValue(_f.month));};var _3c=function(){return parseInt(mxui.dom.getSelectedValue(_f.week));};var _3d=function(){return mxui.dom.getSelectedValue(_f.range);};var _3e=function(){return mxui.dom.getSelectedValue(_f.period);};var _3f=function(){var _40=["month","quarter","week","period","year"];for(var i=0;i<_40.length;i++){if(_f[_40[i]]){if(mxui.dom.getSelectedValue(_f[_40[i]])!=""){return _40[i];}}}return false;};var _41=function(){switch(_3f()){case "year":case "period":return true;break;case "range":return false;break;default:return _38();break;}};var _42=function(_43){var _44=_3f();if(_44!="year"){if(_44=="week"&&_43){return _45(_46(),_3c()).getFullYear();}else{if(_44=="period"){return _47(_3e())[0].getFullYear();}else{if(_f.year&&(_39()!="")){return _39();}else{return (new Date()).getUTCFullYear();}}}}else{if(_44=="year"){return _39();}}};var _48=function(){return _42();};var _49=function(){switch(_3f()){case "week":return _45(_46(),_3c()+1).getFullYear();break;case "period":return _47(_3e())[1].getFullYear();break;default:return _42();}};var _4a=function(){var _4b={};for(var i in _f){_4b[i]=_f[i].value;}return _4b;};var _4c=function(_4d){for(var i in _4d){if(_f[i]){mxui.dom.selectOption(_f[i],_4d[i]);}}};var _4e=function(n){return new Date(_42(),n,0);};var _4f=function(){return _4e(0);};var _50=function(d){var _51=new Date(d);var _52=_51.getMonth();if(_52>=2){_51.setMonth(3);}else{if(_52>=5){_51.setMonth(6);}else{if(_52>=8){_51.setMonth(9);}else{_51.setMonth(12);}}}_51.setDate(1);return _51;};var _53=function(d){var _54=new Date(d);var _55=_54.getMonth();if(_55>=2){_54.setMonth(0);}else{if(_55>=5){_54.setMonth(3);}else{if(_55>=8){_54.setMonth(6);}else{_54.setMonth(9);}}}_54.setDate(1);return _54;};var _56=function(d){var _57=new Date(d);_57.setMonth(_57.getMonth()+1);_57.setDate(0);return _57;};var _58=function(d){var _59=new Date(d);_59.setDate(1);return _59;};var _5a=function(d){var _5b=new Date(d);while(_5b.getDay()!=_13){_5b.setDate(_5b.getDate()-1);}return _5b;};var _5c=function(d){var _5d=new Date(d);while(_5d.getDay()!=_14){_5d.setDate(_5d.getDate()+1);}return _5d;};var _46=function(){return new Date(reporting.lib.DateHelpers.getFirstWeekOfYear(_42()));};var _45=function(_5e,n){return (new Date(_5e.valueOf()+(n*_16)));};var _5f=function(d,n){var _60=new Date(d);_60.setMonth(_60.getMonth()+n);return _60;};var _61=function(d,_62,_63){var _64=new Date(d);switch(_62){case "last":switch(_63){case "week":return _45(_64,-1);break;case "month":return _5f(_64,-1);break;default:break;}break;case "next":switch(_63){case "week":return _45(_64,1);break;case "month":return _5f(_64,1);break;default:break;}break;default:break;}return _64;};var _47=function(_65){_65=_65.toLowerCase().split(/_/);var _66=_65[0];var _67=_65[1];var _68=_61(new Date(),_66,_67);switch(_67){case "week":return [_5a(_68),_5c(_68)];break;case "month":return [_58(_68),_56(_68)];break;case "quarter":return [_53(_68),_50(_68)];break;case "period":var _69=_66.split("-");return [new Date(Number(_69[0])),new Date(Number(_69[1]))];break;default:break;}};var _6a=function(){switch(_3f()){case "month":return _3b()+1;break;case "week":return (_45(_46(),(_3c())).getMonth()+1);break;case "quarter":switch(_3a()){case 1:return 1;break;case 2:return 4;break;case 3:return 7;break;case 4:return 10;break;}break;case "period":return _47(_3e())[0].getMonth()+1;break;default:return 1;break;}};var _6b=function(){switch(_3f()){case "month":return _3b()+1;break;case "week":return (_45(_46(),_3c()).getMonth()+1);break;case "quarter":switch(_3a()){case 1:return 3;break;case 2:return 6;break;case 3:return 9;break;case 4:return 12;break;}break;case "period":return _47(_3e())[1].getMonth()+1;break;default:return 12;break;}};var _6c=function(){switch(_3f()){case "month":return 1;break;case "week":return _45(_46(),(_3c())).getDate();break;case "quarter":return 1;break;case "period":return _47(_3e())[0].getDate();break;default:return 1;break;}};var _6d=function(){switch(_3f()){case "month":var _6e=_4e(_3b()+2);_6e.setDate(0);return _6e.getDate();break;case "week":return _45(_46(),_3c()+1).getDate()-1;break;case "quarter":switch(_3a()){case 1:case 4:return 31;break;case 2:case 3:return 30;break;}break;case "period":return _47(_3e())[1].getDate();break;default:return 31;break;}};var _6f=function(_70){if(_f[_70]){mxui.dom.selectOption(_f[_70],"");}};var _71=function(_72){mendix.lang.map(_72.split(/,/),_6f);};var _73={yearChanged:function(){_71("period,range");},quarterChanged:function(){_71("week,month,period,range");},monthChanged:function(){_71("week,quarter,period,range");},weekChanged:function(){_71("month,quarter,period,range");},toChanged:function(){_71("month,quarter,period,range");},fromChanged:function(){_71("month,quarter,period,range");},rangeChanged:function(){_71("year,month,quarter,week,period");},periodChanged:function(){_71("month,quarter,range");}};var _74=function(){var _75=_2c("from");if(_75){var _76=new Date(_42(),_6a()-1,_6c());_75.set("value",+_76);}var to=_2c("to");if(to){var _76=new Date(_49(),_6b()-1,_6d());_76.setDate(_76.getDate()+1);to.set("value",+_76);}};var _77=function(){var _78=_2c("from");if(_78){_78.set("value","");}var to=_2c("to");if(to){to.set("value","");}};var _79=function(){if(_36()){var _7a=_2c("from");var to=_2c("to");return [_7a.get("value"),to.get("value")];}else{return "";}};this.actSetup=function(_7b){if(this.parameter==""){logger.error(this.id+".actSetup : no valid parameter passed.");}_12=this.parameter.toString()+"_config_hash";this.domNode.parentNode.style.padding="0px";this.containerNode.appendChild(mx.ui.getTemplate(this.mxid,"content"));_7b();};this.actParseContent=function(_7c){var _7d={};mxui.dom.walkTree(this.containerNode,function(_7e){if(_7e.nodeName.toLowerCase()=="select"||_7e.nodeName.toLowerCase()=="input"){_7d[_7e.getAttribute("name")]=_7e;}});!_7d.from&&(_7d.from=mxui.dom.input());!_7d.to&&(_7d.to=mxui.dom.input());for(var i in _7d){if((i!="from")&&(i!="to")){this.connect(_7d[i],"onchange","eventControlChanged");}else{}switch(i){case "quarter":_28(_7d[i]);break;case "week":_21(_7d[i]);break;case "month":_24(_7d[i]);break;case "year":_2a(_7d[i]);break;case "period":_32(_7d[i]);break;case "range":_34(_7d[i]);break;case "from":case "to":_2f(_7d[i]);break;default:break;}}_f=_7d;_7c();};this.actRetrieveParameters=function(_7f){var _80=reporting.store.ParameterStore.retrieveLead(this.mxform.hash);if(_80.length==0){_7f&&_7f();}else{for(var i=0;i<_80.length;i++){_11[_80[i]]={callbacked:false,params:{}};}for(var i=0;i<_80.length;i++){(function(_81){reporting.store.ParameterStore.retrieveParams(_81,function(p){_11[_81]={callbacked:true,params:p};var _82=true;for(var x in _11){if(!_11[x].callbacked){_82=false;}}if(_82){_7f&&_7f();}});})(_80[i]);}}};this.actSetDate=function(_83){if(this.mxcontext.hasParam(this.parameter)){var _84=this.mxcontext.getParam(this.parameter);var _85;var _86;if(_84.length){_86=_84[0];_85=_84[1];}else{_86=_85=_84;}if(_86){var _87=_2c("from");if(_87){_87.set("value",_86);}}if(_85){var _87=_2c("to");if(_87){_87.set("value",_85);}}if(this.mxcontext.hasParam(_12)){_4c(this.mxcontext.getParam(_12));}}_83&&_83();};var _88=function(){var _89=reporting.lib.DateHelpers;switch(_3f()){case "year":var _8a=_42();var _8b=_89.getFirstWeekOfYear(_8a);var end=_8b;var _8c={};var _8d=_8a;var _8e=1;var _8f=_89.getFirstWeekOfYear(_8a+1);while(_8a==_8d&&_8f>end){var _90=_8b;end=_8b+=(4*_89.weekMs);if(_8e==14){end=_8f;}end-=_89.dayMs;_8c[_90+"-"+end+"_period"]=(_8e++);_8a=new Date(_8b).getUTCFullYear();}var _91=_f.period;if(_91){mxui.dom.setSelectOptions(_91,_8c,"");}break;default:}};this.eventControlChanged=function(e){if(e){e.preventDefault();e.stopPropagation();}_73[e.target.getAttribute("name")+"Changed"]();if(_41()){_74();}else{_77();}_88();this.syncDateRangeWithContext();};this.eventInputChanged=function(e){this.syncDateRangeWithContext();};this.eventOnKeyUp=function(e){if(e.keyCode==13){this.eventControlChanged(e);_1.publish("report_"+this.content_id.toString(),["runreport"]);}else{}};this.syncDateRangeWithContext=function(){var _92=this.createContext();if(!_36()){_92.setParam(this.parameter,"");_92.setParam(_12,"");}else{_92.setParam(this.parameter,_79());_92.setParam(_12,_4a());}_1.publish("context_seed_"+this.mxform.hash,[_92]);};this.refresh=function(_93){};this.objectUpdate=function(){};this.contextUpdate=function(){};this.parentUpdate=function(_94){};this.uninitialize=function(_95){delete _f;};}});});