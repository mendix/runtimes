/*
    Copyright (c) 2005-2015, Mendix bv. All rights reserved.
    See licenses.txt for third party licenses that apply.
*/

//>>built
define("reporting/widget/DateRange",["reporting/lib/DateHelpers","mxui/mixin/_Stateful","mxui/widget/_WidgetBase","mxui/dom","mxui/widget/DatePicker","dojo/date/locale","dojo/topic","dojo/_base/array","dojo/_base/declare"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var _a=_9(_3,{_items:null,postCreate:function(){this.connect(this.domNode,"change","onChange");_4.setSelectOptions(this.domNode,{},"");},setItems:function(_b){if(_b){this._items=_b;var _c={};_8.forEach(this._items,function(_d,_e){_c[_e]=_d.display;});_4.setSelectOptions(this.domNode,_c,"");}},getDateInterval:function(){var _f=_4.getSelectedValue(this.domNode);return _f!==""?this._items[_f]:{from:"",to:""};},_getValueAttr:function(){return _4.getSelectedText(this.domNode);},_setValueAttr:function(_10){_4.selectOptionByText(this.domNode,_10);},onChange:function(){}});var _11={set:function(){},get:function(){return "";},onChange:function(){},setItems:function(){}};function _12(_13,_14){var _15=[];for(var _16=_13;_16<=_14;_16++){_15.push({display:_16.toString(),from:new Date(_16,0,1),to:new Date(_16+1,0,0)});}return _15;};var _17={period:function(_18){var _19=_1.getFirstWeekOfYear(_18);var end=_19;var _1a=[];var _1b=_18;var _1c=1;var _1d=_1.getFirstWeekOfYear(_18+1);while(_18==_1b&&_1d>end){var _1e=_19;end=_19+=(4*_1.weekMs);if(_1c==14){end=_1d;}end-=_1.dayMs;_1a.push({from:new Date(_1e),to:new Date(end),display:String(_1c++)});_18=new Date(_19).getUTCFullYear();}return _1a;},quarter:function(_1f){return _8.map([0,1,2,3],function(_20){return {display:(_20+1).toString(),from:new Date(_1f,_20*3,1),to:new Date(_1f,_20*3+3,0)};});},month:function(_21){return _8.map(_6.getNames("months","wide"),function(_22,_23){return {display:_22,from:new Date(_21,_23,1),to:new Date(_21,_23+1,0)};});},week:function(_24){var _25=new Date(_1.getFirstWeekOfYear(_24)),_26=[],i=1;do{var _27=new Date(_25.getTime()+_1.weekMs-1);_26.push({display:"Week "+(i++).toString(),from:_25,to:_27});_25=new Date(_27.getTime()+1);}while(_25.getFullYear()==_24);return _26;}};var _28=["period","quarter","month","week"],_29=_28.concat(["year"]);var _2a=_9([_3,_2],{reportid:"",parameter:"",startYear:null,endYear:null,hasDates:true,_periodSelectorsParameterName:"",_periodSelectors:null,_dateInputs:null,_value:null,postCreate:function(){this._periodSelectorsParameterName=this.parameter.toString()+"_config_hash";this._periodSelectors={};this._dateInputs={};this._value={from:"",to:""};this._buildPeriodSelectors();this._periodSelectors.year.setItems(_12(this.startYear,this.endYear));this._subscribeToYearChange();this._subscribeToPeriodChange();if(this.hasDates){this._buildDateInputs();this._subscribeToDateChange();}},_buildPeriodSelectors:function(){var _2b=this;_8.forEach(_29,function(_2c){var _2d=_2b.domNode.querySelector("select[name='"+_2c+"']");_2b._periodSelectors[_2c]=_2d?new _a({},_2d):_11;});},_buildDateInputs:function(){var _2e=this;_8.forEach(["from","to"],function(_2f,_30){var _31=_2e.domNode.querySelector("input[name='"+_2f+"']"),_32=new _5({selector:"date"});_31.parentNode.replaceChild(_32.domNode,_31);_2e._dateInputs[_2f]=_32;});},_subscribeToYearChange:function(){var _33=this;this.connect(this._periodSelectors.year,"onChange",function(){var _34=this._periodSelectors.year.get("value");if(_34==""){_8.forEach(_28,function(_35){_33._periodSelectors[_35].setItems([]);});}else{this._setValue(this._periodSelectors.year.getDateInterval());_8.forEach(_28,function(_36){var _37=_33._periodSelectors[_36].get("value");_33._periodSelectors[_36].setItems(_17[_36](_34));if(_37!=""){_33._periodSelectors[_36].set("value",_37);_33._periodSelectors[_36].onChange();}});this._onChange();}});},_subscribeToPeriodChange:function(){var _38=this;_8.forEach(_28,function(_39){var _3a=_38._periodSelectors[_39];_38.connect(_3a,"onChange",function(){if(_3a.get("value")===""){return;}_38._setValue(_3a.getDateInterval());_8.forEach(_28,function(_3b){if(_3b!=_39){_38._periodSelectors[_3b].set("value","");}});_38._onChange();});});},_subscribeToDateChange:function(){var _3c=this;_8.forEach(["from","to"],function(_3d){_3c.connect(_3c._dateInputs[_3d],"onChange",function(){var _3e=_3c._dateInputs[_3d].get("value");_3c._value[_3d]=_3e;if(_3e!==""){_8.forEach(_28,function(_3f){_3c._periodSelectors[_3f].set("value","");});if(_3e.getFullYear()!=_3c._periodSelectors.year.get("value")){_3c._periodSelectors.year.set("value","");}}_3c._onChange();});});},startup:function(){this.domNode.parentNode.style.padding="0px";this.inherited(arguments);},update:function(_40,_41){var _42=this.getState("value",this.mxcontext.hasParam(this.parameter)?this.mxcontext.getParam(this.parameter):""),_43=this.getState("config",this.mxcontext.hasParam(this._periodSelectorsParameterName)?this.mxcontext.getParam(this._periodSelectorsParameterName):""),_44=this;if(_43){this._periodSelectors.year.set("value",_43["year"]);this._periodSelectors.year.onChange();_8.forEach(_28,function(_45){_44._periodSelectors[_45].set("value",_43[_45]);});}if(_42){var _46="",_47="";if(_42.length){_46=new Date(_42[0]);_47=new Date(_42[1]);}else{if(_42!=""){_46=_47=new Date(_42);}}if(this.hasDates){this._dateInputs.from.set("value",_46);this._dateInputs.to.set("value",_47);}this._value={from:_46,to:_47};}this._onChange();_41&&_41();},_setValue:function(_48){if(this.hasDates){this._dateInputs.from.set("value",_48.from);this._dateInputs.to.set("value",_48.to);}this._value=_48;},_getValue:function(){return this._value.from!=""&&this._value.to!=""?[this._value.from.getTime(),this._value.to.getTime()]:"";},_getSelectorConfig:function(){var _49=this,_4a={};_8.forEach(_29,function(_4b){_4a[_4b]=_49._periodSelectors[_4b].get("value");});return _4a;},_onChange:function(){this.mxcontext.setParam(this.parameter,this._getValue());this.mxcontext.setParam(this._periodSelectorsParameterName,this._getSelectorConfig());_7.publish("context_seed_"+this.mxform.hash,this.mxcontext);},storeState:function(_4c){_4c("value",this._getValue());_4c("config",this._getSelectorConfig());}});return _2a;});