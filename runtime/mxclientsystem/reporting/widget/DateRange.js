
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("reporting/widget/DateRange",["dojo","dijit","dojox","dojo/require!reporting/lib/OQLSource,reporting/lib/DateHelpers,reporting/mixin/_Reportable"],function(_1,_2,_3){_1.provide("reporting.widget.DateRange");_1.require("reporting.lib.OQLSource");_1.require("reporting.lib.DateHelpers");_1.require("reporting.mixin._Reportable");mxui.widget.declare("reporting.widget.DateRange",{mixins:[_2._TemplatedMixin,_2._Contained,mxui.mixin._Contextable,reporting.mixin._Reportable],inputargs:{reportid:"",nested:false,paramtype:"",parameter:"",query:"",config:""},constructor:function(){this.templatePath=null;this.templateString="<div class='reportingDateRange'><div dojoAttachPoint='containerNode'></div></div>";this.isContainer=true;this.parameter="param";this.paramtype="";this.config="";this.query="";this.domNode=null;this.returnValue=null;var _4=this;var _5={};var _6=[];var _7={};var _8="";var _9=0;var _a=6;var _b=(1000*3600*24);var _c=(_b*7);var _d=null;this.postCreate=function(){this.initContext();_d=this.id;this.sequence(["actSetup","actContentHook","actParseContent","actRetrieveParameters","actLoaded"]);};this.applyContext=function(_e,_f){this.cloneContext(_e);this.sequence(["actSetDate"],_f);};var _10={0:"Januari",1:"Februari",2:"Maart",3:"April",4:"Mei",5:"Juni",6:"Juli",7:"Augustus",8:"September",9:"Oktober",10:"November",11:"December"};var _11={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};var _12=function(_13){var _14={};for(var i=0;i<53;i++){_14[i]="Week "+(i+1).toString();}mxui.dom.setSelectOptions(_13,_14,"");};var _15=function(_16){var _17=(_1.locale.match(/nl/i))?_10:_11;mxui.dom.setSelectOptions(_16,_17,"");};var _18=function(_19){mxui.dom.setSelectOptions(_19,{0:"1",1:"2",2:"3",3:"4"},"");};var _1a=function(_1b){if(_1b.options.length==0){mxui.dom.setSelectOptions(_1b,{2006:"2006",2007:"2007",2008:"2008",2009:"2009",2010:"2009",2011:"2011",2012:"2012",2013:"2013",2014:"2014",2015:"2015",2016:"2016",2017:"2017",2018:"2018",2019:"2019",2020:"2020"},"");}};var _1c=function(i){var _1d=_5[i];if(_1d){var _1e=_1d.getAttribute("ref_id");return _2.byId(_1e);}return null;};var _1f=function(_20){var _21=new mxui.widget.DatePicker({selector:"date"});if(_20.parentNode){_20.parentNode.replaceChild(_21.domNode,_20);_21.startup();_1.connect(_21,"onChange",_1.hitch(_4,"syncDateRangeWithContext"));}_20.setAttribute("ref_id",_21.id);_6.push(_21);};var _22=function(_23){mxui.dom.setSelectOptions(_23,{},"");};var _24=function(_25){mxui.dom.hide(_25);};var _26=function(){var _27=_1c("from");var to=_1c("to");return (_27&&(_27.get("value")!="")&&to&&(to.get("value")!=""));};var _28=function(){return (mxui.dom.getSelectedValue(_5.year)!="");};var _29=function(){return parseInt(mxui.dom.getSelectedValue(_5.year));};var _2a=function(){return parseInt(mxui.dom.getSelectedValue(_5.quarter))+1;};var _2b=function(){return parseInt(mxui.dom.getSelectedValue(_5.month));};var _2c=function(){return parseInt(mxui.dom.getSelectedValue(_5.week));};var _2d=function(){return mxui.dom.getSelectedValue(_5.period);};var _2e=function(){var _2f=["month","quarter","week","period","year"];for(var i=0;i<_2f.length;i++){if(_5[_2f[i]]){if(mxui.dom.getSelectedValue(_5[_2f[i]])!=""){return _2f[i];}}}return false;};var _30=function(){switch(_2e()){case "year":case "period":return true;break;case "range":return false;break;default:return _28();break;}};var _31=function(_32){var _33=_2e();if(_33!="year"){if(_33=="week"&&_32){return _34(_35(),_2c()).getFullYear();}else{if(_33=="period"){return _36(_2d())[0].getFullYear();}else{if(_5.year&&(_29()!="")){return _29();}else{return (new Date()).getUTCFullYear();}}}}else{if(_33=="year"){return _29();}}};var _37=function(){switch(_2e()){case "week":return _34(_35(),_2c()+1).getFullYear();break;case "period":return _36(_2d())[1].getFullYear();break;default:return _31();}};var _38=function(){var _39={};for(var i in _5){_39[i]=_5[i].value;}return _39;};var _3a=function(_3b){for(var i in _3b){if(_5[i]){mxui.dom.selectOption(_5[i],_3b[i]);}}};var _3c=function(n){return new Date(_31(),n,0);};var _3d=function(d){var _3e=new Date(d);var _3f=_3e.getMonth();if(_3f>=2){_3e.setMonth(3);}else{if(_3f>=5){_3e.setMonth(6);}else{if(_3f>=8){_3e.setMonth(9);}else{_3e.setMonth(12);}}}_3e.setDate(1);return _3e;};var _40=function(d){var _41=new Date(d);var _42=_41.getMonth();if(_42>=2){_41.setMonth(0);}else{if(_42>=5){_41.setMonth(3);}else{if(_42>=8){_41.setMonth(6);}else{_41.setMonth(9);}}}_41.setDate(1);return _41;};var _43=function(d){var _44=new Date(d);_44.setMonth(_44.getMonth()+1);_44.setDate(0);return _44;};var _45=function(d){var _46=new Date(d);_46.setDate(1);return _46;};var _47=function(d){var _48=new Date(d);while(_48.getDay()!=_9){_48.setDate(_48.getDate()-1);}return _48;};var _49=function(d){var _4a=new Date(d);while(_4a.getDay()!=_a){_4a.setDate(_4a.getDate()+1);}return _4a;};var _35=function(){return new Date(reporting.lib.DateHelpers.getFirstWeekOfYear(_31()));};var _34=function(_4b,n){return (new Date(_4b.valueOf()+(n*_c)));};var _4c=function(d,n){var _4d=new Date(d);_4d.setMonth(_4d.getMonth()+n);return _4d;};var _4e=function(d,_4f,_50){var _51=new Date(d);switch(_4f){case "last":switch(_50){case "week":return _34(_51,-1);break;case "month":return _4c(_51,-1);break;default:break;}break;case "next":switch(_50){case "week":return _34(_51,1);break;case "month":return _4c(_51,1);break;default:break;}break;default:break;}return _51;};var _36=function(_52){_52=_52.toLowerCase().split(/_/);var _53=_52[0];var _54=_52[1];var _55=_4e(new Date(),_53,_54);switch(_54){case "week":return [_47(_55),_49(_55)];break;case "month":return [_45(_55),_43(_55)];break;case "quarter":return [_40(_55),_3d(_55)];break;case "period":var _56=_53.split("-");return [new Date(Number(_56[0])),new Date(Number(_56[1]))];break;default:break;}};var _57=function(){switch(_2e()){case "month":return _2b()+1;break;case "week":return (_34(_35(),(_2c())).getMonth()+1);break;case "quarter":switch(_2a()){case 1:return 1;break;case 2:return 4;break;case 3:return 7;break;case 4:return 10;break;}break;case "period":return _36(_2d())[0].getMonth()+1;break;default:return 1;break;}};var _58=function(){switch(_2e()){case "month":return _2b()+1;break;case "week":return (_34(_35(),_2c()).getMonth()+1);break;case "quarter":switch(_2a()){case 1:return 3;break;case 2:return 6;break;case 3:return 9;break;case 4:return 12;break;}break;case "period":return _36(_2d())[1].getMonth()+1;break;default:return 12;break;}};var _59=function(){switch(_2e()){case "month":return 1;break;case "week":return _34(_35(),(_2c())).getDate();break;case "quarter":return 1;break;case "period":return _36(_2d())[0].getDate();break;default:return 1;break;}};var _5a=function(){switch(_2e()){case "month":var _5b=_3c(_2b()+2);_5b.setDate(0);return _5b.getDate();break;case "week":return _34(_35(),_2c()+1).getDate()-1;break;case "quarter":switch(_2a()){case 1:case 4:return 31;break;case 2:case 3:return 30;break;}break;case "period":return _36(_2d())[1].getDate();break;default:return 31;break;}};var _5c=function(_5d){if(_5[_5d]){mxui.dom.selectOption(_5[_5d],"");}};var _5e=function(_5f){mendix.lang.map(_5f.split(/,/),_5c);};var _60={yearChanged:function(){_5e("period,range");},quarterChanged:function(){_5e("week,month,period,range");},monthChanged:function(){_5e("week,quarter,period,range");},weekChanged:function(){_5e("month,quarter,period,range");},toChanged:function(){_5e("month,quarter,period,range");},fromChanged:function(){_5e("month,quarter,period,range");},rangeChanged:function(){_5e("year,month,quarter,week,period");},periodChanged:function(){_5e("month,quarter,range");}};var _61=function(){var _62=_1c("from");if(_62){_62.set("value",+new Date(_31(),_57()-1,_59()));}var to=_1c("to");if(to){var _63=new Date(_37(),_58()-1,_5a());_63.setDate(_63.getDate()+1);to.set("value",+_63);}};var _64=function(){var _65=_1c("from");if(_65){_65.set("value","");}var to=_1c("to");if(to){to.set("value","");}};var _66=function(){if(_26()){var _67=_1c("from");var to=_1c("to");return [_67.get("value").getTime(),to.get("value").getTime()];}else{return "";}};this.actSetup=function(_68){if(this.parameter==""){logger.error(this.id+".actSetup : no valid parameter passed.");}_8=this.parameter.toString()+"_config_hash";this.domNode.parentNode.style.padding="0px";this.containerNode.appendChild(mx.ui.getTemplate(this.mxid,"content"));_68();};this.actParseContent=function(_69){var _6a={};mxui.dom.walkTree(this.containerNode,function(_6b){if(_6b.nodeName.toLowerCase()=="select"||_6b.nodeName.toLowerCase()=="input"){_6a[_6b.getAttribute("name")]=_6b;}});!_6a.from&&(_6a.from=mxui.dom.input());!_6a.to&&(_6a.to=mxui.dom.input());for(var i in _6a){if((i!="from")&&(i!="to")){this.connect(_6a[i],"onchange","eventControlChanged");}else{}switch(i){case "quarter":_18(_6a[i]);break;case "week":_12(_6a[i]);break;case "month":_15(_6a[i]);break;case "year":_1a(_6a[i]);break;case "period":_22(_6a[i]);break;case "range":_24(_6a[i]);break;case "from":case "to":_1f(_6a[i]);break;default:break;}}_5=_6a;_69();};this.actRetrieveParameters=function(_6c){var _6d=reporting.store.ParameterStore.retrieveLead(this.mxform.hash);if(_6d.length==0){_6c&&_6c();}else{for(var i=0;i<_6d.length;i++){_7[_6d[i]]={callbacked:false,params:{}};}for(var i=0;i<_6d.length;i++){(function(_6e){reporting.store.ParameterStore.retrieveParams(_6e,function(p){_7[_6e]={callbacked:true,params:p};var _6f=true;for(var x in _7){if(!_7[x].callbacked){_6f=false;}}if(_6f){_6c&&_6c();}});})(_6d[i]);}}};this.actSetDate=function(_70){if(this.mxcontext.hasParam(this.parameter)){var _71=this.mxcontext.getParam(this.parameter);var _72;var _73;if(_71.length){_73=_71[0];_72=_71[1];}else{_73=_72=_71;}if(_73){var _74=_1c("from");if(_74){_74.set("value",_73);}}if(_72){var _74=_1c("to");if(_74){_74.set("value",_72);}}if(this.mxcontext.hasParam(_8)){_3a(this.mxcontext.getParam(_8));}}_70&&_70();};var _75=function(){var _76=reporting.lib.DateHelpers;switch(_2e()){case "year":var _77=_31();var _78=_76.getFirstWeekOfYear(_77);var end=_78;var _79={};var _7a=_77;var _7b=1;var _7c=_76.getFirstWeekOfYear(_77+1);while(_77==_7a&&_7c>end){var _7d=_78;end=_78+=(4*_76.weekMs);if(_7b==14){end=_7c;}end-=_76.dayMs;_79[_7d+"-"+end+"_period"]=String(_7b++);_77=new Date(_78).getUTCFullYear();}var _7e=_5.period;if(_7e){mxui.dom.setSelectOptions(_7e,_79,"");}break;default:}};this.eventControlChanged=function(e){if(e){e.preventDefault();e.stopPropagation();}_60[e.target.getAttribute("name")+"Changed"]();if(_30()){_61();}else{_64();}_75();this.syncDateRangeWithContext();};this.eventInputChanged=function(){this.syncDateRangeWithContext();};this.eventOnKeyUp=function(e){if(e.keyCode==13){this.eventControlChanged(e);_1.publish("report_"+this.content_id.toString(),["runreport"]);}else{}};this.syncDateRangeWithContext=function(){var _7f=this.createContext();if(!_26()){_7f.setParam(this.parameter,"");_7f.setParam(_8,"");}else{_7f.setParam(this.parameter,_66());_7f.setParam(_8,_38());}_1.publish("context_seed_"+this.mxform.hash,[_7f]);};this.refresh=function(_80){};this.objectUpdate=function(){};this.contextUpdate=function(){};this.parentUpdate=function(_81){};this.uninitialize=function(_82){_5=null;mendix.lang.collect(_1.map(_6,function(_83){return _1.hitch(_83,"uninitialize");}),_82);};}});});