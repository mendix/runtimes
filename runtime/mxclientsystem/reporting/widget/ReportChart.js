
/* Copyright (c) 2005-2012, Mendix bv. All rights reserved. */

//>>built
define("reporting/widget/ReportChart",["dojo","dijit","dojox","dojo/require!reporting/lib/OQLSource,reporting/lib/ChartBuilder,reporting/mixin/_Reportable,reporting/FusionChartsFree/FusionChartsFree,mxui/mixin/_Stateful"],function(_1,_2,_3){_1.provide("reporting.widget.ReportChart");_1.require("reporting.lib.OQLSource");_1.require("reporting.lib.ChartBuilder");_1.require("reporting.mixin._Reportable");_1.require("reporting.FusionChartsFree.FusionChartsFree");_1.require("mxui.mixin._Stateful");mxui.widget.declare("reporting.widget.ReportChart",{startdormant:false,charttype:"",chartTypes:{MSBar2D:"",MSLine:"",MSArea2D:"",MSColumn2D:"",MSColumn3D:"",StackedArea2D:"",StackedBar2D:"",StackedColumn2D:"",StackedColumn3D:""},mixins:[_2._TemplatedMixin,_2._Container,_2._Contained,mxui.mixin._Contextable,reporting.mixin._Reportable,mxui.mixin._Stateful],inputargs:{aspect:"",reportid:"",yaxisminimum:"",yaxismaximum:"",yaxisprecision:0,yaxiscaption:"",xaxiscaption:"",charttype:"",nested:false,startdormant:false,width:550,height:350},constructor:function(){this.templateString=_1.cache("reporting.widget","templates/ReportChart.html","<div class=\"ReportCharts\" style=\"z-index:-1;display:none;\">\n\t<div style=\"clear:both\"/>\n\t<div style=\"text-align:center; padding:10px 0px 10px;\">\n\t\t<div dojoAttachPoint=\"chartNode\">\n\t\t</div>\n\t</div>\n</div>\n");this.reportid="XXX";this.domNode=null;this.chartNode=null;this.width=550;this.height=350;this.aspect="";this.xaxiscaption="";this.yaxiscaption="";this.yaxisminimum=null;this.yaxismaximum=null;this.yaxisprecision=0;this.isGenerated=false;this._chartTarget="MSColumn3D";var _4=null;var _5="";var _6={};var _7=[];var _8="mxclientsystem/reporting/FusionChartsFree/charts/";this.returnValue=null;var _9=_1.hitch;var _a=mxui.dom.hide;var _b=mxui.dom.show;var _c=_1.addClass;var _d=_1.removeClass;var _e=_1.addClass;var _f=mxui.dom.setClass;var _10=mxui.dom.getClass;var _11=mxui.dom.setOpacity;var _12=mxui.dom;var _13=null;var _14={};var _15=function(_16){_16&&_16();};this.applyContext=function(_17,_18){this.startdormant=this.getState("dormant",this.startdormant);if(!this.startdormant){this.contextNotification(_17);mendix.lang.runBindActions(this,["refresh"],_18);}else{this.startdormant=false;_18&&_18();}};this.actSetupOQLSource=function(_19){_13=new reporting.lib.OQLSource({reportid:this.reportid,startdormant:this.startdormant,load:_19});};this.actSetupChart=function(_1a){var swf="FCF_"+this._chartTarget+".swf",_1b=this.id+"_flashNode",_1c=this.getChartSize();_6={rendered:false,node:this.chartNode,flash:new FusionChartsFree(_8+swf,_1b,_1c.width,_1c.height,"0","1"),_id:_1b};_6.node.id=this.id+"_parentNode";this.loaded();_1a();};this.actRunReport=function(_1d){this.isGenerated=true;_13.execQuery(_1d);};this.getChartSize=function(){var asp=null;if(this.aspect){try{var _1e=this.aspect.split(/:/);asp=(parseInt(_1e[1],10)/parseInt(_1e[0],10));}catch(e){}}if(!asp){asp=0.5;}var _1f=_1._getContentBox(this.domNode.parentNode);return {width:_1f.w||this.width,height:(this.width*asp)*0.7};};this.actFillChart=function(_20){mxui.dom.show(this.domNode);_5=reporting.lib.ChartBuilder({oqlsource:_13,ymin:this.yaxisminimum,ymax:this.yaxismaximum,precision:this.yaxisprecision,xcaption:this.xaxiscaption,xcaption:this.xaxiscaption,ycaption:this.yaxiscaption});try{if(_6.rendered){window.infosoftglobal.FusionChartsFreeUtil.updateChartXML(_6._id,_5);}else{_6.flash.setDataXML(_5);_6.rendered=true;_6.flash.render(_6.node.id);}}catch(e){logger.error(this.id+".actFillChart : Problem rendering chart : "+e.message);}_20&&_20();};this.actReloadChart=function(_21){this.sequence([_9(_13,"refresh"),"actRefreshChart",_21?_21:_15]);};this.actRegisterUIEvents=function(_22){_7.push(_1.subscribe("report_"+this.mxform.hash,this,"topicUpdate"));_22();};this.refresh=function(_23){this.sequence(["actRunReport","actFillChart",_23||_15]);};this.contextUpdate=function(){};this.topicUpdate=function(){this.refresh();};this.contextNotification=function(_24){var _25=_24.getParams();for(var p in _25){_14[p]=_25[p];}_13.setParams(_14);};this.uninitialize=function(_26){try{_13.uninitialize();for(var i=0;i<_7.length;i++){_1.unsubscribe(_7[i]);}}catch(e){}delete _13;};this.storeState=function(_27){_27("dormant",!this.isGenerated);};},postCreate:function(){this.initContext();this.registerContent();if(this.charttype==""){}else{if(this.charttype in this.chartTypes){this._chartTarget=this.charttype;}else{}}if(this.yaxisminimum!=""){this.yaxisminimum=parseFloat(this.yaxisminimum);}if(this.yaxismaximum!=""){this.yaxismaximum=parseFloat(this.yaxismaximum);}var _28=["actSetupOQLSource","actSetupChart","actRegisterUIEvents"];if(!this.startdormant){_28.push("actRunReport","actFillChart");}this.sequence(_28);}});});